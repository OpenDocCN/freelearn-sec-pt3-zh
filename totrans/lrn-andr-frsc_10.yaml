- en: Android Malware Analysis
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will perform dynamic and static analysis of the malicious
    Android application we identified in the previous chapter. We will cover the following
    topics:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Dynamic analysis of malicious Android applications using an online sandbox
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Static analysis of malicious Android applications:'
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Unpacking Android applications
  id: totrans-4
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Manifest file decoding and analysis
  id: totrans-5
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Android application decompilation
  id: totrans-6
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Viewing and analyzing decompiled code
  id: totrans-7
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Dynamic analysis of malicious Android applications
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The easiest way to perform a malicious Android application analysis is to run
    it in a controlled environment. You already know how to run an emulator and install
    applications via ADB, so you may install a suspicious application in a clean virtual
    system and see what artefacts are left after you run it. For example, you can
    find SQLite databases with data collected by a malicious application or its configuration
    files.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
- en: Dynamic analysis using an online sandbox
  id: totrans-10
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: An easier and more efficient approach is to use pre-built sandboxes for malware
    analysis. One of these sandboxes is **Joe Sandbox**. It supports automated dynamic
    analysis of different types of applications, including Windows, macOS, Linux,
    iOS, and of course Android. You can register for a free account and enable 10
    free analyses per month. The sandbox for Android applications can be accessed
    here: [https://www.joesandbox.com/#android](https://www.joesandbox.com/#android).
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: 'Only a few simple steps are required to run an application in the sandbox:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: First, choose the file you want to analyze using the **Choose file...** button.
  id: totrans-13
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Adjust the run time; you can run the application in the sandbox from 30 to 500
    seconds
  id: totrans-14
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Accept the terms and conditions, and click the **Analyze** button.
  id: totrans-15
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the analysis is complete, you will receive an email with a link to the
    analysis results. In our case, it was [https://www.joesandbox.com/analysis/67297](https://www.joesandbox.com/analysis/67297).
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: Let's walk through the HTML report and discuss its most important parts.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: 'Joe Sandbox has its own detection mechanism based on automated analysis results.
    In our case, the sample got 72 points out of 100 and is classified as **malicious**:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/dbf2309a-e01f-4775-9546-831da8f9e609.png)'
  id: totrans-19
  prefs: []
  type: TYPE_IMG
- en: 'It also uses antivirus engines and VirusTotal to scan the uploaded sample.
    According to the report, our sample is detected as **ANDROID/Spy.Banker.YD.G****en**
    by Avira, and is also detected by 51% of antivirus engines on VirusTotal, as shown
    in the following screenshot:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/34cca771-b32a-416e-bb88-529e0c8195f1.png)'
  id: totrans-21
  prefs: []
  type: TYPE_IMG
- en: 'According to the next section, our sample attempted to escalate its privileges,
    requesting root rights via running a `su` command, and then tried to add a new
    device administrator:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/aa67ca66-b0b9-48be-928b-3900dc65b2ff.png)'
  id: totrans-23
  prefs: []
  type: TYPE_IMG
- en: 'Let''s look at the Networking section. It seems our sample attempted to download
    a new APK file, `new.apk`, from `www.poog.co.kr`, but failed to do so as the file
    was unavailable:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/c2839e5a-fa85-46c4-9bcc-417152493612.png)'
  id: totrans-25
  prefs: []
  type: TYPE_IMG
- en: 'Another interesting section is E-Banking Fraud. Our sample contains package
    name strings related to banking; they may be used for the detection of banking
    applications installed on the device. Also, it is able to add an overlay to other
    applications, and has permission to list currently running applications:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/d22aa7a5-13c5-4320-b096-6d66a389381c.png)'
  id: totrans-27
  prefs: []
  type: TYPE_IMG
- en: 'The next section shows that the analyzed application requested permissions
    to perform phone calls in the background, send SMS, and write to SMS storage.
    Also, it''s able to send SMS using SmsManager and end incoming calls; this is
    typical for banking Trojans:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/091aec59-9b21-40a3-8df4-df0f5cc8e5ca.png)'
  id: totrans-29
  prefs: []
  type: TYPE_IMG
- en: 'The **System Summary** section shows us a list of potentially dangerous permissions
    our sample requested:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/90f68fdd-9266-4eda-8450-b340718b2096.png)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
- en: 'Let''s look at each of them closely:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
- en: '`CALL_PHONE`: Allows an application to initiate phone calls'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`GET_TASKS`: Allows an application to collect information about currently running
    applications'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`INTERNET`: Allows an application to open network sockets'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`READ_CONTACTS`: Allows an application to read contacts data'
  id: totrans-36
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`READ_PHONE_STATE`: Allows an application to access phone state in read-only
    mode, including phone number and cellular network information'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`READ_SMS`: Allows an application to read SMS'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`RECEIVE_SMS`: Allows an application to receive SMS'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`SEND_SMS`: Allows an application to send SMS'
  id: totrans-40
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`SYSTEM_ALERT_WINDOW`: Allows an application to create windows shown on top
    of all other applications'
  id: totrans-41
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`WAKE_LOCK`: Allows an application to keep the processor from sleeping or the
    screen from dimming'
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`WRITE_CONTACTS`: Allows an application to write contact data'
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`WRITE_EXTERNAL_STORAGE`: Allows an application to write to external storage,
    for example, an SD card'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`WRITE_SETTINGS`: Allows an application to read or write the system settings'
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`WRITE_SMS`: Allows an application to write SMS stored on the phone or its
    SIM card, or delete them'
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'We already know that our sample attempted to download an APK file. If we look
    at the **Persistence and Installation Behavior** section, we see that it is able
    not only to download applications, but also to install them:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/6134b9cd-9fec-457a-a252-d0ff347b4c2b.png)'
  id: totrans-48
  prefs: []
  type: TYPE_IMG
- en: 'To survive reboots, the sample requested permission to execute the code after
    the phone is rebooted (`RECEIVE_BOOT_COMPLETED`), created a new wake lock to have
    the device stay on, and was able to start a service for autostart purposes:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/e73758e9-8e69-4c5c-915e-617faa45ce61.png)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
- en: 'Let''s dive into the **Hooking and other Techniques for Hiding and Protection**
    section. The sample is able to abort broadcast events; it helps malicious application
    to hide phone events, such as incoming SMS:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/a3c4ec4c-da51-43b5-8fd9-96bec706711e.png)'
  id: totrans-52
  prefs: []
  type: TYPE_IMG
- en: 'Another interesting piece of information here is that our sample requested
    permission to terminate background processes:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/4a710d47-1900-496d-909e-06c495f6aad8.png)'
  id: totrans-54
  prefs: []
  type: TYPE_IMG
- en: 'The **Language, Device and Operating System Detection** section shows that
    the sample collects information about the SIM provider country code, service provider
    name, mobile country code, mobile network code, WiFi MAC address, voicemail number,
    operating system version, and unique device IDs, such as **International Mobile
    Equipment Identity** (**IMEI**), **M****obile Equipment IDentifier** (**MEID**), and
    **Electronic Serial Number** (**ESN**):'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/e5fde6bf-7902-4979-9396-ffc343433342.png)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
- en: 'The following screenshot shows the unique device IDs collected by the sample:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/e75da8f1-a373-4402-94a3-5643434470b3.png)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
- en: 'The next section shows that the application monitors outgoing phone calls,
    is able to create SMS data, and checks whether a SIM card is installed:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/cbd61e43-0831-4a63-b56b-7f90fd1bf50b.png)'
  id: totrans-60
  prefs: []
  type: TYPE_IMG
- en: 'What is more, it monitors incoming phone calls and reads originating phone
    numbers, parses SMS (body and originating number), and queries the list of installed
    applications and packages:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/996fa3ea-66cb-47a1-acbd-fa5815b40fa5.png)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
- en: 'Finally, if we look at the **URLs** subsection of the **Antivirus Detection**
    section, we see that the APK file that our sample attempted to download was detected
    as malicious by Avira URL Cloud:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/3c6ba1c3-8db3-4960-bfee-f05398b0cb44.png)'
  id: totrans-64
  prefs: []
  type: TYPE_IMG
- en: You may have noticed that there are more URLs in the previous screenshot; these
    are potentially malware command and control servers.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
- en: 'To sum up, let''s gather together the pieces of information we got from the
    dynamic analysis of our sample with **Joe Sandbox**:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: Based on antivirus detection and the artefacts we have uncovered, the piece
    of malware we analyzed is a banking Trojan.
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It's able to download additional pieces of malware from `www.poog.co.kr`.
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It collects information about banking-related applications.
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It is able to add an overlay to other applications.
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It is able to monitor incoming and outgoing calls, read and write SMS messages,
    and intercept them.
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It is able to terminate the processes of other applications.
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It's able to collect information about the device it's running on.
  id: totrans-73
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It requests permission to execute the code after the phone is rebooted for persistence.
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It potentially uses `http://rtrjkrykki.iego.net/appHome/` or `http://192.151.226.138:80/appHome/`
    as a command and control server.
  id: totrans-75
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The next sections will walk you through the steps required to perform static
    analysis of Android malicious applications.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
- en: Static analysis of malicious Android applications
  id: totrans-77
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To perform dynamic analysis of the previously identified malicious Android application,
    we ran it in a controlled environment with the help of Joe Sandbox. In contrast
    to dynamic analysis, static analysis allows an examiner to understand malware
    behavior without actually running it. Let's start the static analysis of our malware
    sample, beginning with unpacking it.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
- en: Unpacking Android applications
  id: totrans-79
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: To view the contents of an APK file, you can use any archiver. A good example
    is 7-Zip, a free and open source archiver, which is available here: [https://www.7-zip.org/download.html](https://www.7-zip.org/download.html).
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: 'To unpack an APK file, right-click on it, choose **7-Zip**, and then **Open
    archive**:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/c1e0d50c-c566-49bd-be70-b483be267b05.png)'
  id: totrans-82
  prefs: []
  type: TYPE_IMG
- en: Contents of an APK file
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
- en: 'Now you can browse the contents of the APK file and export its parts for further
    analysis. In the next section, we will focus on the Android manifest file: `AndroidManifest.xml`.'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: Manifest file decoding and analysis
  id: totrans-85
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The manifest file describes essential information about an application to the
    Android build tools, the Android operating system, and Google Play. If you open
    such a file in a text editor, you will see that most of the data is encoded and
    can't normally be viewed.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: If we want to analyze its contents, we need to use an Android binary XML decoder.
    One such decoder is `axmldec`, which is available for download here: [https://github.com/ytsutano/axmldec/releases](https://github.com/ytsutano/axmldec/releases).
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
- en: 'To decode the extracted manifest file, run `axmldec` from the Command Prompt
    with the following argument:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'The output file can be easily viewed with a text editor of your choice. The
    file contains lots of useful pieces of information. For example, we can get the
    package name:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Also, we can get information about the main activity. It is the first screen
    to appear when the user launches the application. Each activity can then start
    another activity in order to perform different actions. In our case, the main
    activity is `com.cc.MainActinn`:'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'There is another activity – `com.cc.WebInterfaceActivity`:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-95
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: This activity has a number of **broadcast receivers**. Broadcast receivers allow
    applications to receive **intents** that are broadcast by the system or by other
    applications. An intent is a message defined by an intent object that describes
    an action to perform. When an application issues an intent to the system, the
    system locates an application component that can handle the intent, based on the
    intent filter declarations in the manifest file.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
- en: 'Let''s start from `com.cc.MyAdminReceiver`, which is used for gaining device
    admin privileges:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'The next broadcast receiver is `com.cc.BootRt`:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-100
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'As you can see, it receives the following information:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
- en: Whether the device finished its booting process
  id: totrans-102
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Whether the device is shutting down
  id: totrans-103
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Whether the user is present after the device wakes up
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Another broadcast receiver is `com.cc.A123`:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'It receives the following information/performs the following actions:'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: If the device finished its booting process the phone state
  id: totrans-108
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If it starts a new outgoing call
  id: totrans-109
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If it's connected to a power source
  id: totrans-110
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If it's disconnected from a power source
  id: totrans-111
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the timezone changed
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the time was set
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the time has changed
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a user ID has been removed
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the device has entered USB Mass Storage mode
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the device has exited USB Mass Storage mode
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a new application package has been installed
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If an existing application package has been changed
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the user has cleared the data of a package
  id: totrans-120
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If an application is first launched
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If an application has been completely removed from the device
  id: totrans-122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If an application has been downloaded and installed
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a package needs to be verified
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a new version of an application package has been installed
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If an application has been fully or only partially uninstalled
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the user has restarted a package
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a new version of a current application has been installed over an existing
    one
  id: totrans-128
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If external media is present but cannot be mounted
  id: totrans-129
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If package management should be started due to a low-memory condition
  id: totrans-130
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If external media was removed from a SD card slot, but the mount point was not
    unmounted
  id: totrans-131
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the **Media Button** was pressed
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If external media is present and being disk checked
  id: totrans-133
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the user has expressed the desire to remove the external storage media
  id: totrans-134
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If external media is present and mounted
  id: totrans-135
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If external media is present, but is using an incompatible filesystem or is
    blank
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If external media has been removed
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the media scanner has finished scanning a directory
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Requests the media scanner scans a file and adds it to the media database
  id: totrans-139
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the media scanner has started scanning a directory
  id: totrans-140
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If external media is unmounted because it is being shared via USB Mass Storage
  id: totrans-141
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the current device's locale has changed
  id: totrans-142
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If an input method has been changed
  id: totrans-143
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a wired headset has been plugged in or unplugged
  id: totrans-144
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a GTalk connection has been disconnected
  id: totrans-145
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a GTalk connection has been established
  id: totrans-146
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the resources for a set of packages are currently unavailable since the media
    on which they exist is unavailable
  id: totrans-147
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the resources for a set of packages are currently available
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If there are changes in the physical docking state of the device
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a low storage space condition on the device no longer exists
  id: totrans-150
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If there is a low storage space condition on the device
  id: totrans-151
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the date has changed
  id: totrans-152
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a user action should request a temporary system dialog to dismiss
  id: totrans-153
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the Camera Button was pressed
  id: totrans-154
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the battery is now okay after being low
  id: totrans-155
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the device has been in a low battery condition
  id: totrans-156
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Charging state, level, and other information about the battery
  id: totrans-157
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the user has switched the phone into or out of Airplane Mode
  id: totrans-158
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a provider's data has changed, for example, the number of unread emails changes
  id: totrans-159
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the device is shutting down
  id: totrans-160
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the user is present after the device wakes up
  id: totrans-161
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If the current system wallpaper has changed
  id: totrans-162
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If Wi-Fi is enabled, disabled, enabling, disabling, or unknown
  id: totrans-163
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Calls the `su` binary to get root access
  id: totrans-164
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a change in network connectivity has occurred
  id: totrans-165
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: If a new text-based SMS message has been received by the device
  id: totrans-166
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Also, we have information about three services in our malicious application''s
    manifest file, `com.cc.service.Int`, `com.cc.service.Ir`, and `com.cc.service.Hearttttt`:'
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-168
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Unlike activities, services do not have a visual user interface. If you look
    at their intent filters, you will notice that each service receives a broadcast
    once the device finishes its booting process, so it can be started automatically
    in the background.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
- en: 'The last section of the manifest file contains the permissions the application
    uses:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: We have already discussed permissions in the dynamic analysis section, so we
    won't cover them here again. Let's dive even deeper and start working on code
    decompilation.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: Android application decompilation
  id: totrans-173
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: For this step, we will need another file from the APK file: `classes.dex`. To
    convert `.dex` (Dalvik Executable) to `.class` files in a `.jar` container, we
    need to perform decompilation. We can use `dex2jar` to solve this task, which
    is available here: [https://github.com/pxb1988/dex2jar](https://github.com/pxb1988/dex2jar).
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: 'To decompile `classes.dex`, run `d2j-dex2jar.bat` from the Command Prompt with
    the following argument:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-176
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: This is it. Now, we have a `classes.jar` file that contains all of the Java
    classes from `classes.dex`. We will view and analyze this `.jar` file in the following
    section.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: Viewing and analyzing decompiled code
  id: totrans-178
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Now we can view and analyze the data we unpacked and decompiled in the previous
    steps. We can use JD-GUI to do this. JD-GUI is a free utility that is able to
    display the Java source codes of `.class` files. You can download this tool here: [http://jd.benow.ca/](http://jd.benow.ca/).
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
- en: 'Here are the contents of `classes.jar` displayed by JD-GUI:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/504e6253-9391-429b-87f0-6129b4f22693.png)'
  id: totrans-181
  prefs: []
  type: TYPE_IMG
- en: The contents of classes.jar
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: 'We already know a lot about our banking Trojan; let''s try to learn something
    new from code analysis. We identified two suspicious URLs as the result of dynamic
    analysis, `rtrjkrykki.iego.net/appHome/` and `192.151.226.138:80/appHome/`. Most
    likely this is the same server, so let''s try to find at least one of the URLs
    in the code using JD-GUI:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/ed826477-6013-4b1e-b39f-2707e9306fc8.png)'
  id: totrans-184
  prefs: []
  type: TYPE_IMG
- en: Searching for URL with JD-GUI
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: 'Okay, now we know that the URL is found in `ConstantDatas.class`. Let''s look
    inside:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/8a3c4026-7f41-4089-b19f-e8eccb3cc532.png)'
  id: totrans-187
  prefs: []
  type: TYPE_IMG
- en: A part of the ConstantDatas.class contents
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
- en: 'If we search for `BANKURL`, we will find that it''s used in `MainActinn.class`:'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/e572e059-3d73-479e-a273-32b876ea4ee2.png)'
  id: totrans-190
  prefs: []
  type: TYPE_IMG
- en: A part of the MainActinn.class contents
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
- en: 'Look at the following line: `"ConstantDatas.URL = ConstantDatas.BANKURL;"`.
    Let''s search for `ConstantDatas.URL` now. We''ll find a good hit in `Hearttttt.class`:'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
- en: '![](img/405dcae8-8b94-4553-be09-828ff7329e88.png)'
  id: totrans-193
  prefs: []
  type: TYPE_IMG
- en: A part of the Hearttttt.class contents
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: Here, you can see that the application collects information about the device
    it's installed on and its operating system, installed banking applications, mobile
    country code and mobile network code, unique subscriber ID, and so on, and posts
    this data in JSON format to `192.151.226.138:80/appHome/servlet/OnLine`.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
- en: As you can see, you can get a lot of additional information from static code
    analysis; sometimes it's relatively easy, sometimes it's not, as a malware sample
    can be highly obfuscated.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，通过静态代码分析，你可以获得大量的附加信息；有时这相对简单，有时则不然，因为恶意软件样本可能会高度混淆。
- en: To analyze code with a higher rate of success, we highly recommend you start
    learning Android programming. Refer to the books provided in the *Further reading*
    section.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 为了以更高的成功率进行代码分析，我们强烈建议你开始学习Android编程。请参考*深入阅读*部分提供的书籍。
- en: Summary
  id: totrans-198
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter introduced you to dynamic and static analysis of malicious Android
    applications. You've learned how to use an online sandbox to perform dynamic analysis,
    unpack an Android application, analyze its manifest file, and decompile its code.
    Finally, you've been introduced to the concepts of decompiled code analysis.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍了恶意Android应用程序的动态和静态分析。你已经学习了如何使用在线沙箱进行动态分析，如何解包Android应用程序，分析其清单文件，并反编译其代码。最后，你已经了解了反编译代码分析的概念。
- en: Further reading
  id: totrans-200
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 深入阅读
- en: 'Please refer to the following references:'
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 请参阅以下参考资料：
- en: '*Documentation for app developers*: [https://developer.android.com/docs/](https://developer.android.com/docs/)'
  id: totrans-202
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*应用开发者文档*：[https://developer.android.com/docs/](https://developer.android.com/docs/)'
- en: '*John Horton, Android Programming for Beginners - Second Edition*: [https://www.packtpub.com/application-development/android-programming-beginners-second-edition](https://www.packtpub.com/application-development/android-programming-beginners-second-edition)'
  id: totrans-203
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*John Horton，《Android编程入门（第二版）》*：[https://www.packtpub.com/application-development/android-programming-beginners-second-edition](https://www.packtpub.com/application-development/android-programming-beginners-second-edition)'
