<html><head></head><body>
		<div><h1 id="_idParaDest-140"><em class="italic">Chapter 9</em>: <a id="_idTextAnchor143"/>Security Best Practices</h1>
			<p>In this book, we have already covered the most important topics regarding Azure security, from governance and monitoring to identity, network, and data protection, to specific tools such as Azure Security Center and Azure Sentinel. In this final chapter, you will find some tips and tricks the authors are using regularly in their projects.</p>
			<p>The topics we will cover in the following sections include the following:</p>
			<ul>
				<li>Log Analytics design considerations</li>
				<li>Understanding Azure SQL Database security features</li>
				<li>Security in Azure App Service </li>
			</ul>
			<h1 id="_idParaDest-141"><a id="_idTextAnchor144"/>Log Analytics design considerations</h1>
			<p>You've already learned that Azure Security Center and Azure Sentinel rely heavily on Azure Log Analytics. But there <a id="_idIndexMarker466"/>are some important considerations to make before you start your security monitoring journey in the cloud. </p>
			<p>The two most important paradigms in this context are these:</p>
			<ul>
				<li>Using as few Log Analytics workspaces as possible</li>
				<li>Using regional workspaces to avoid Azure bandwidth costs</li>
			</ul>
			<p>From a technical point of view, it's the best idea to only use a single, central workspace so all the data resides in one place. Having a single workspace, you can easily, efficiently, and quickly correlate your data to get <a id="_idIndexMarker467"/>the respective insights. You also only need to take care of a single <strong class="bold">role-based access control</strong> (<strong class="bold">RBAC</strong>) model for this workspace. However, fine-grained RBAC models demand more effort.</p>
			<p>From a monetary point of view, however, you should plan for regional workspaces instead of a central workspace if you are using Azure resources in different Azure regions. For on-premises servers, it does not make <a id="_idIndexMarker468"/>a big difference what layout you are planning for because all <strong class="bold">incoming network traffic</strong> (<strong class="bold">ingress</strong>) to an Azure region is free. The Microsoft Monitoring Agent will send data to Azure, but there is no regular data transfer from Azure to your on-premises servers. The problem is <a id="_idIndexMarker469"/>that you must pay for <strong class="bold">outgoing traffic</strong> (<strong class="bold">egress</strong>) out of an Azure region. Now, if you use a single, central Log Analytics workspace and have Azure <strong class="bold">Virtual Machines </strong>(<strong class="bold">VMs</strong>) deployed in <a id="_idIndexMarker470"/>different Azure regions, outgoing data transfers from these VMs to your workspace would generate traffic costs.</p>
			<p>In order to bring both paradigms together, the idea is to create one single workspace in every Azure region you are using, not only to avoid regular traffic costs but also to still stick to the idea of having as few workspaces as possible.</p>
			<p>If you use several workspaces, you can no longer use auto-provisioning in Azure Security Center. Because of the <a id="_idIndexMarker471"/>automation process, you can only configure one workspace per subscription. Since an Azure subscription can contain resources from all, or at least several, Azure regions, depending on your policies, you need another way to automatically deploy the Microsoft Monitoring Agent to <a id="_idIndexMarker472"/>your Azure VM. This is where <strong class="bold">Infrastructure as Code</strong> (<strong class="bold">IaC</strong>) comes into play. With <strong class="bold">Azure Resource Manager</strong> (<strong class="bold">ARM</strong>) templates, Terraform, or PowerShell, you can <a id="_idIndexMarker473"/>deploy Azure VM and install the Log Analytics VM extension at the same time. The Log Analytics VM extension is deployed and managed through the ARM and fully supports CI/CD pipelines in your DevOps scenario. That said, when you use IaC deployments for your VM in your DevOps scenario, you can also update, manage, and configure the agent through your pipeline. If you then also have configured policies, blueprints, and all the other governance features you have learned about in <a href="B15414_02_Final_JM_ePub.xhtml#_idTextAnchor038"><em class="italic">Chapter 2</em></a>, <em class="italic">Governance and Security</em>, you can easily adhere to your corporate security policy and leverage automation at the same time.</p>
			<p>Next, we are going to look at other Azure services' security features and how they can help us increase security.</p>
			<h1 id="_idParaDest-142"><a id="_idTextAnchor145"/>Understanding Azure SQL Database security features</h1>
			<p>Some security features related to Azure SQL Database were mentioned in <a href="B15414_06_Final_JM_ePub.xhtml#_idTextAnchor111"><em class="italic">Chapter 6</em></a>, <em class="italic">Data Security</em>, where we <a id="_idIndexMarker474"/>discussed data security. But there are additional features we can use to increase security.</p>
			<p>The first feature and line of defense when it comes to Azure SQL Database is a firewall. This built-in tool, by default, blocks access to the database from any IP address that is not preauthorized (whitelisted). It's important to mention that firewall settings are on the Azure SQL Server level and will be inherited to all databases on the server. If we need to allow access to one IP address to a single database, we may want to reconsider our resource strategy. Allowing an IP address to access a single database will enable access to all databases on the same server. Because of this, we need to consider putting only databases used by the same applications or the same group of users on a single server.</p>
			<p>Allowing a new IP address to connect to Azure SQL Server can be done from the Azure SQL Server firewall settings. We have the option to add a single IP address (the start and end IP will be the same), or add a range of IP addresses (from the start IP to the end IP). If we want to allow our current IP address, there is a convenient <strong class="bold">Add client IP</strong> button. This will automatically detect the IP address we are coming from and add a new rule to allow that IP address. After any rule is added, we need to save changes in order for them to become effective. </p>
			<p>An example of firewall settings is shown in the following figure:</p>
			<div><div><img src="img/Fig_9.1.jpg" alt="Figure 9.1 – Azure SQL Server firewall settings&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.1 – Azure SQL Server firewall settings</p>
			<p>Under <strong class="bold">Firewall</strong> <strong class="bold">settings</strong>, there <a id="_idIndexMarker475"/>are two additional options we can use:</p>
			<ul>
				<li><strong class="bold">Allow Azure services and resources to access this server</strong></li>
				<li><strong class="bold">Connections from the VNET/Subnet</strong></li>
			</ul>
			<p>The option to <a id="_idIndexMarker476"/>allow Azure services sounds compelling, but we need to be very careful. At first look, this option looks helpful and most people will probably think they should allow Azure services to connect. It makes our life so much easier when we don't have to worry about how our web app connects to a database. But this option does not allow only your Azure service to connect, it allows any Azure service to connect. Allowing Azure services and resources to connect will only check if the connection is coming from an Azure data center, it will not limit connection to your subscription or tenant. Allowing this option will make Azure SQL Database more vulnerable, and I would recommend you keep this option off.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout"><strong class="bold">Allow Azure services and resources to access this server</strong> is set to <strong class="bold">OFF</strong> by default, but it wasn't always the case. Previously, this setting was enabled by default. If you have Azure SQL Database already created, make sure this setting is disabled.</p>
			<p>Connection from VNET/Subnet allows us to create VNET integration by allowing certain VNET (or limiting this only to subnets) to connect to Azure SQL Database. This approach is more secure as the database does not need to be exposed over the internet and all communication is done on a secure private network.</p>
			<p>But Azure SQL <a id="_idIndexMarker477"/>Database is just one example of built-in security features on a service level. Almost every service has some service-specific security features. Azure App Service is another excellent example with many security options available, which we will be covering next. </p>
			<h1 id="_idParaDest-143"><a id="_idTextAnchor146"/>Security in Azure App Service</h1>
			<p>Azure App Service is an HTTP-based service for hosting web applications and APIs, with support for multiple programming languages. It's also another great example of an Azure service with multiple security features built-in. We can control access, protocols, certificates, and many other things. </p>
			<p>One of the <a id="_idIndexMarker478"/>early problems we need to solve for any application is authentication. App Service allows us to set up authentication based on a few different providers: <strong class="bold">Azure Active Directory</strong> (<strong class="bold">Azure AD</strong>), Microsoft (or Live) account, Facebook, Google, and Twitter. Naturally, the best <a id="_idIndexMarker479"/>integration method is using Azure AD, as it is native and also allows you further control through Azure AD tools and features.</p>
			<p>In order to set up Azure AD authentication for App Service, we need to do the following:</p>
			<ol>
				<li value="1">In the <strong class="bold">App Service Authentication</strong> blade, we need to select <strong class="bold">Azure Active Directory</strong>, as in the following figure:<div><img src="img/Fig_9.2.jpg" alt="Figure 9.2 – Azure App Service authentication&#13;&#10;"/></div><p class="figure-caption">Figure 9.2 – Azure App Service authentication</p></li>
				<li>We have two options in authentication settings. If we choose <strong class="bold">Express</strong>, this will create a service principal and all required permissions for us automatically. If we choose <strong class="bold">Advanced</strong> settings, we will need to provide a service principal and create permissions ourselves. The following figure shows an example of <strong class="bold">Express</strong> settings:<div><img src="img/Fig_9.3.jpg" alt="Figure 9.3 – App Service Azure AD authentication&#13;&#10;"/></div><p class="figure-caption">Figure 9.3 – App Service Azure AD authentication</p></li>
				<li>After everything <a id="_idIndexMarker480"/>is configured, we need to ensure that the user is required to log in with <strong class="bold">Azure</strong> <strong class="bold">Active</strong> <strong class="bold">Directory</strong> in order to access the application, as in the following figure:<div><img src="img/Fig_9.4.jpg" alt="Figure 9.4 – Enforcing Azure AD login&#13;&#10;"/></div><p class="figure-caption">Figure 9.4 – Enforcing Azure AD login</p></li>
				<li>When accessing <a id="_idIndexMarker481"/>the application, the user will be prompted to <strong class="bold">Sign</strong> <strong class="bold">in</strong> with their Azure AD account in order to proceed, as in the following figure:</li>
			</ol>
			<div><div><img src="img/Fig_9.5.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.5 – User is required to sign in in order to access the application</p>
			<p>Another set of security features in Azure App Service is <strong class="bold">Protocol</strong> <strong class="bold">Settings</strong>. Here, we can force the application to use only HTTPS, control the minimal TLS version, or if an incoming client certificate is required. We can also configure <strong class="bold">TLS/SSL bindings</strong> to specify the certificate that will be used when responding to a request to a specific hostname. Both public and private certificates can be used:</p>
			<div><div><img src="img/Fig_9.6.jpg" alt="Figure 9.6 – App Service protocol settings&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.6 – App Service protocol settings</p>
			<p>Private certificates <a id="_idIndexMarker482"/>can be imported from App Service (to a specific web app), uploaded, imported <a id="_idIndexMarker483"/>from Azure Key Vault, or we can create a new <strong class="bold">App Service Managed Certificate</strong>. </p>
			<p class="callout-heading">Note</p>
			<p class="callout"><strong class="bold">App Service Managed Certificate</strong> is available to all web apps on App Service, not just on the web app where it's created.</p>
			<p>In the following figure, we <a id="_idIndexMarker484"/>can see the <strong class="bold">Private Key Certificate</strong> settings:</p>
			<div><div><img src="img/Fig_9.7.jpg" alt="Figure 9.7 – App Service private key certificate&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.7 – App Service private key certificate</p>
			<p><strong class="bold">Public</strong> <strong class="bold">Key</strong> <strong class="bold">Certificate</strong> requires a certificate issued by a recognized <strong class="bold">Certificate Authority</strong> (<strong class="bold">CA</strong>). This certificate is <a id="_idIndexMarker485"/>usually used by publicly accessible web applications, and serves as <a id="_idIndexMarker486"/>proof that the website is trustworthy:</p>
			<div><div><img src="img/Fig_9.8.jpg" alt="Figure 9.8 – Public key certificate&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.8 – Public key certificate</p>
			<p>Under networking <a id="_idIndexMarker487"/>settings in App Service, we have multiple options. Most of the options are related to secure connections and the integration of a web app with private networks. This was already mentioned in <a href="B15414_04_Final_JM_ePub.xhtml#_idTextAnchor087"><em class="italic">Chapter 4</em></a>, <em class="italic">Azure Network Security</em>, when we discussed network security. We can achieve this with both VNET integration and hybrid connections. Also, this section includes <a id="_idIndexMarker488"/>options to enable services such as Azure Front Door (as the web application firewall for globally distributed applications) and <strong class="bold">Content Delivery Network</strong> (<strong class="bold">CDN</strong>). The last option under network settings is access restrictions. All network settings associated with Azure App Service are shown in the following figure:</p>
			<div><div><img src="img/Fig_9.9.jpg" alt="Figure 9.9 – Azure App Service network settings &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.9 – Azure App Service network settings </p>
			<p><strong class="bold">Access</strong> <strong class="bold">Restrictions</strong> is a very <a id="_idIndexMarker489"/>useful feature in <strong class="bold">Azure App Service</strong> settings. Using <strong class="bold">Access</strong> <strong class="bold">Restrictions</strong>, we can block access from specific IP addresses or allow access only from <a id="_idIndexMarker490"/>whitelisted IP addresses. Essentially, <strong class="bold">Access Restrictions</strong> works very similarly to <strong class="bold">Network Security Groups</strong> (<strong class="bold">NSGs</strong>), by creating rules and assigning <a id="_idIndexMarker491"/>priority to them. However, <strong class="bold">Access Restrictions</strong> focuses on public access where NSGs control broader networks with both public and private network rules. In the following figure, we can see an example of creating a block rule:</p>
			<div><div><img src="img/Fig_9.10.jpg" alt="Figure 9.10 – App Service Access restriction&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.10 – App Service Access restriction</p>
			<p>To create <a id="_idIndexMarker492"/>a block rule, we need to provide the following information:</p>
			<ul>
				<li><strong class="bold">Name</strong></li>
				<li><strong class="bold">Action</strong> (allow or deny access)</li>
				<li><strong class="bold">Priority</strong></li>
				<li><strong class="bold">Description</strong></li>
				<li><strong class="bold">Type</strong> (IPv4 or IPv6)</li>
				<li><strong class="bold">IP Address Block</strong></li>
			</ul>
			<p>In the preceding example, a rule is created to block access from IP address block <code>208.130.0.0/16</code>. If anyone tries to access the application from any IP address in the specified IP address range, the request will be blocked and the user will be prevented from reaching the web app.</p>
			<p>As we are able to use priorities, we can also approach things differently, and allow access only from whitelisted IP addresses. In this case, we would create a block rule that would prevent anyone from accessing the application and assign <code>200</code>. Another rule would be created to allow access from a specific IP address range with <code>100</code> (this can be any value under <code>200</code>). Allowing a rule for specified IP addresses would override the rule to block, because of its higher priority. But it would still prevent anyone else from accessing the application.</p>
			<p>Another challenge we face with the cloud is secrets management. We need to be careful how secrets, connections strings, and other sensitive information are used and make sure that none of these are exposed. As in many cases we have already discussed in this book, Azure Key Vault comes to the rescue. Similar to <a id="_idIndexMarker493"/>passing secrets when using IaC (as discussed in <a href="B15414_05_Final_JM_ePub.xhtml#_idTextAnchor099"><em class="italic">Chapter 5</em></a>, <em class="italic">Azure Key Vault</em>), or managing keys and certificates (discussed in <a href="B15414_06_Final_JM_ePub.xhtml#_idTextAnchor111"><em class="italic">Chapter 6</em></a>, <em class="italic">Data Security</em>), Azure Key Vault can be used to secure any sensitive information needed by Azure App Service. Instead of storing sensitive information in web config files or in App Service Configuration (where information is hidden, but visible if the user has enough permissions), we can use a managed identity that will allow access to Azure Key Vault, where sensitive information is stored in a secure way. An example of identity settings in App Service is shown in the following figure:</p>
			<div><div><img src="img/Fig_9.11.jpg" alt="Figure 9.11 – Managed identity in Azure App Service&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 9.11 – Managed identity in Azure App Service</p>
			<p>As we can see, there are two types of managed identity that we can set: <strong class="bold">System assigned</strong> and <strong class="bold">User</strong> <strong class="bold">assigned</strong>. <strong class="bold">System</strong> <strong class="bold">assigned</strong> will generate <a id="_idIndexMarker494"/>a managed identity and set up necessary options. In <strong class="bold">User</strong> <a id="_idTextAnchor147"/><strong class="bold">assigned</strong>, we need <a id="_idIndexMarker495"/>to create a managed identity ourselves, and create any necessary permissions and settings. If we require using more than one managed identity for a service, we need to use a <strong class="bold">User</strong> <strong class="bold">assigned</strong> managed identity, because a service can have only one system-assigned managed identity. </p>
			<p>A <strong class="bold">System</strong> <strong class="bold">assigned</strong> managed identity is tied to a resource life cycle, and once a resource is removed, the managed identity is removed as well. The managed identity is generated in order to be used for that service and is not used by any other service. This is not the case with a <strong class="bold">User assigned</strong> identity, as more resources can use the same managed identity. </p>
			<h1 id="_idParaDest-144"><a id="_idTextAnchor148"/>Summary</h1>
			<p>At the very end of this book, we have covered all aspects of Microsoft Azure security. From the shared responsibility model to advanced security features, we have come to an end. It's important to remember that the cloud changes all the time, and more and more services are available that can help us to increase security.</p>
			<p>Let's focus on the most important takeaways from this book:</p>
			<ul>
				<li>Keep your identity and secrets secure with all the means available.</li>
				<li>When it comes to access, take two approaches: <strong class="bold">Just Enough Administration</strong> (<strong class="bold">JEA</strong>) and <strong class="bold">Just-in-Time Administration</strong> (<strong class="bold">JIT Administration</strong>).</li>
				<li>Nothing should be exposed to public access if it's not necessary, especially management and security access.</li>
				<li>Data should be encrypted at all times.</li>
				<li>All communication and traffic should be encrypted (over HTTPS) and on a secure (private) network, if possible.</li>
				<li>Azure Security Center and Azure Sentinel can help you with analytics, detection, and recommendations to stay on top of cloud security and keep Azure resources safe.</li>
				<li>Besides services focused on security, all Azure services have security features of their own. Use these features to increase security.</li>
			</ul>
			<p>Microsoft Azure changes all the times; new features are added, and existing features are updated almost daily. So, in the future, options might change, but these options are there to present an idea of how to approach cloud security. These seven key points are what we need to focus on; how we complete these tasks is insignificant. </p>
			<h1 id="_idParaDest-145"><a id="_idTextAnchor149"/>Questions</h1>
			<ol>
				<li value="1">What is Log Analytics best practice?<p>A. Use a single workspace</p><p>B. Use regional workspaces</p><p>C. Use multiple workspaces for each region and each service</p></li>
				<li>We can control access to Azure SQL Database with…<p>A. An access list</p><p>B. A firewall</p><p>C. Conditional access</p></li>
				<li>Which type of certificate is supported in Azure App Service?<p>A. Private</p><p>B. Public</p><p>C. Wildcard</p><p>D. All of the above</p><p>E. Only 1 and 2</p><p>F. Only 2 and 3</p></li>
				<li>We can control access to Azure App Service with…<p>A. Access restriction</p><p>B. A firewall</p><p>C. Conditional access</p></li>
				<li>What is used to enable App Service communication with other Azure services?<p>A. Service Principal</p><p>B. Managed identity</p><p>C. Azure Key Vault</p></li>
				<li>Azure App Service supports authentication with…<p>A. Azure Active Directory (Azure AD)</p><p>B. Microsoft account</p><p>C. Twitter</p><p>D. All of the above</p><p>E. Only 1 and 2</p><p>F. Only 2 and 3</p></li>
				<li>Security in Azure can be set up from…<p>A. Azure Security Center</p><p>B. Azure Sentinel</p><p>C. Different services and features</p><p>D. Azure AD</p></li>
			</ol>
			<h1 id="_idParaDest-146"><a id="_idTextAnchor150"/>Further reading</h1>
			<ul>
				<li><em class="italic">Hands-On Cloud Administration in Azure</em> by Mustafa Toroman: <a href="https://www.packtpub.com/virtualization-and-cloud/hands-cloud-administration-azure">https://www.packtpub.com/virtualization-and-cloud/hands-cloud-administration-azure</a>.</li>
				<li><em class="italic">Azure Administration Cookbook</em> by Kamil Mrzyglod: <a href="https://www.packtpub.com/cloud-networking/azure-administration-cookbook">https://www.packtpub.com/cloud-networking/azure-administration-cookbook</a>.</li>
				<li><em class="italic">Active Directory Administration Cookbook</em> by Sander Berkouwer: <a href="https://www.packtpub.com/virtualization-and-cloud/active-directory-administration-cookbook">https://www.packtpub.com/virtualization-and-cloud/active-directory-administration-cookbook</a>.</li>
				<li><em class="italic">Azure Networking Cookbook</em> by Mustafa Toroman: <a href="https://www.packtpub.com/virtualization-and-cloud/azure-networking-cookbook">https://www.packtpub.com/virtualization-and-cloud/azure-networking-cookbook</a>.</li>
				<li><em class="italic">Hands-On Azure for Developers</em> by Kamil Mrzyglod: <a href="https://www.packtpub.com/virtualization-and-cloud/hands-azure-developers">https://www.packtpub.com/virtualization-and-cloud/hands-azure-developers</a>.</li>
			</ul>
		</div>
	</body></html>