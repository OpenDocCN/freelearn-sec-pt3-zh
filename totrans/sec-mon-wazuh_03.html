<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-78"><a id="_idTextAnchor077"/>3</h1>
<h1 id="_idParaDest-79"><a id="_idTextAnchor078"/>Threat Intelligence and Analysis</h1>
<p>According to a Ponemon Institute study (<a href="https://webroot-cms-cdn.s3.amazonaws.com/9114/5445/5911/ponemon-importance-of-cyber-threat-intelligence.pdf">https://webroot-cms-cdn.s3.amazonaws.com/9114/5445/5911/ponemon-importance-of-cyber-threat-intelligence.pdf</a>), organizations with robust threat intelligence respond to cyberattacks 53% faster, highlighting its importance in threat analysis, incident response, and mitigation. Simply put, threat intelligence is data that is gathered, processed, and studied to figure out why a threat actor does what they do, who they attack, and how they do it. Threat intelligence data empowers security operations teams to proactively defend against potential security incidents, improving their ability to detect, analyze, and eradicate the threat effectively. When you integrate threat intelligence capabilities into the Wazuh platform, <strong class="bold">security operations center</strong> (<strong class="bold">SOC</strong>) analysts<a id="_idIndexMarker289"/> can get more context for each security alert. In this chapter, we aim to enhance Wazuh’s threat intelligence capabilities. To achieve this, we will leverage the <strong class="bold">Malware Information Sharing Platform</strong> (<strong class="bold">MISP</strong>), an open-source project designed for the collection and <a id="_idIndexMarker290"/>sharing of threat intelligence. Additionally, we will incorporate TheHive/Cortex, a comprehensive suite tailored for scalable threat analysis and incident response. By integrating these tools with Wazuh, we enable security teams to conduct thorough threat analyses and streamline incident response processes. This integration facilitates the automation of threat intelligence tasks, resulting in reduced response times and enhanced security for organizations.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>What is threat intelligence?</li>
<li>Automated threat intelligence</li>
<li>Setting up TheHive and Cortex</li>
<li>Setting up an MISP project</li>
<li>Integrating Wazuh and TheHive</li>
<li>Integrating TheHive and Cortex with MISP</li>
<li>Use cases</li>
</ul>
<h1 id="_idParaDest-80"><a id="_idTextAnchor079"/>What is threat intelligence?</h1>
<p><strong class="bold">Threat intelligence</strong>, or <strong class="bold">cyber threat Intelligence</strong>, is <a id="_idIndexMarker291"/>basically knowledge about threat <a id="_idIndexMarker292"/>actors (an individual or group of attackers that carry out hacking campaigns against companies or government bodies), their motives, and their capabilities. Threat intelligence is all about staying on top of the latest threats and risks lurking on the internet. Threat intelligence enables us to make faster, more informed, data-backed security decisions and change our behavior from reactive to proactive in the fight against attackers. Threat intelligence helps every domain of cybersecurity, including<a id="_idIndexMarker293"/> SOC analysts, intel analysts, <strong class="bold">chief information security officers</strong> (<strong class="bold">CISOs</strong>), etc. By collecting and analyzing threat intelligence information, organizations can be empowered through early detection and prevention, informed decision-making using context, improved incident response, a<a id="_idIndexMarker294"/> better understanding of attackers’ tactics, <strong class="bold">techniques, and procedures</strong> (<strong class="bold">TTPs</strong>), better security defense against growing threats, and more.</p>
<p>In this section, we will talk about:</p>
<ul>
<li>Types of threat intelligence</li>
<li>How SOC analysts use threat intelligence</li>
</ul>
<h2 id="_idParaDest-81"><a id="_idTextAnchor080"/>Types of threat intelligence</h2>
<p>In the constantly changing <a id="_idIndexMarker295"/>world of cybersecurity, companies that want to strengthen their defenses must stay ahead of new risks and utilize threat intelligence. Threat<a id="_idIndexMarker296"/> intelligence is <a id="_idIndexMarker297"/>mainly<a id="_idIndexMarker298"/> offered<a id="_idIndexMarker299"/> in three<a id="_idIndexMarker300"/> types: <em class="italic">tactical intelligence</em>, <em class="italic">operational intelligence</em>, and <em class="italic">strategic intelligence</em>. By using <a id="_idIndexMarker301"/>these types of threat intelligence, businesses can not only learn about how threat actors’ strategies change over time but also plan their defenses to successfully deal with cyber threats that are always changing. Let’s understand all three types of threat intelligence in detail:</p>
<ul>
<li><strong class="bold">Tactical intelligence</strong>: Tactical intelligence<a id="_idIndexMarker302"/> is concerned with the immediate future, is technical in nature, and<a id="_idIndexMarker303"/> identifies <a id="_idIndexMarker304"/>simple <strong class="bold">indicators of compromise</strong> (<strong class="bold">IOC</strong>). IOCs are technical information collected during investigations, threat-hunting activities, or malware analyses. IOCs are actual pieces of data, such as IP addresses, domains, file hashes, etc. They can even be collected via open source and free data feeds such as: <a id="_idIndexMarker305"/><ul><li>AlienVault<a id="_idIndexMarker306"/> OTX (<a href="https://otx.alienvault.com/">https://otx.alienvault.com/</a></li><li>Abuse.ch (<a href="https://abuse.ch/">https://abuse.ch/</a>)</li><li>Blocklist.de (<a href="https://www.blocklist.de">https://www.blocklist.de</a>), and <a id="_idIndexMarker307"/></li><li>Proofpoint <a id="_idIndexMarker308"/>Emerging Threats (<a href="https://rules.emergingthreats.net">https://rules.emergingthreats.net</a>). </li></ul></li>
<li>This tactical intelligence data is consumed by IT analysts and SOC analysts. It typically has a very short lifespan because IOCs such as malicious IP addresses or domain names can become obsolete in a matter of days or even hours.</li>
<li><strong class="bold">Operational intelligence</strong>: Every <a id="_idIndexMarker309"/>attack has a “<em class="italic">who</em>,” a “<em class="italic">why</em>,” and a “<em class="italic">how</em>.” The “<em class="italic">who</em>” is referred to as identification. The “<em class="italic">why</em>” is referred to as<a id="_idIndexMarker310"/> motivation or intent. The “<em class="italic">how</em>” is made up of the threat actor’s TTPs. This gives the blue team or security operations team insight into how adversaries plan, conduct, and sustain campaigns and major operations. This is called operational intelligence. Tactical intelligence plus human analysis gives this intelligence a longer useful lifespan.</li>
<li><strong class="bold">Strategic intelligence</strong>: Strategic intelligence<a id="_idIndexMarker311"/> assists decision-makers <a id="_idIndexMarker312"/>in understanding the threats that cyber threats pose to their organizations. With this knowledge, they can make cybersecurity investments that protect their organizations while also aligning with their strategic priorities. CISOs and management teams are the real consumers of this intelligence. Strategic intelligence requires human data collection and analysis, which requires a deep understanding of cybersecurity and geopolitics. Strategic intelligence<a id="_idIndexMarker313"/> is usually prepared <a id="_idIndexMarker314"/>in the form of reports.</li>
</ul>
<p>Combining these different types of threat data can help businesses create complete and flexible cyber defenses against a wide range of cyber threats.</p>
<p>Next, we will focus on how SOC analysts can consume threat intelligence data (especially tactical and operational intelligence) for better detection and analysis of threats.</p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor081"/>How SOC analysts use threat intelligence</h2>
<p>In the previous section, we learned how SOC teams utilize both tactical and operational intelligence information. Threat intelligence provides valuable information about the latest threats, attack methods, malicious actors, and vulnerabilities. Let’s talk about the practical steps SOC analysts take when using threat intelligence:</p>
<ol>
<li><strong class="bold">Gather observables</strong>: Observables <a id="_idIndexMarker315"/>are pieces of possible threat information. Examples include IP addresses, domain names, URLs, file hashes, email addresses, and more. Observables can be collected via SIEM tools, EDR, email security tools, open source and free threat intelligence feeds, etc.</li>
<li><strong class="bold">Enrichment and context</strong>: After identifying suspicious observables, gather context and enrich the information to better understand the threat. For example, you discovered an IP address (123.45.67.89) connecting to a newly registered domain (<a href="http://malicious-website.com">malicious-website.com</a>). You begin by enriching this data by searching threat intelligence databases and historical data. This IP address has previously been linked to several phishing campaigns, and the domain is hosted in a high-risk region known for cybercriminal activity.</li>
<li><code>123.45.67.89</code></li><li>Domain IOC: <a href="http://malicious-website.com">malicious-website.com</a></li><li>URL path IOC: <a href="http://malicious-website.com/login">malicious-website.com/login</a></li></ul><p class="list-inset">These IOCs are now added to the security tools in your organization, such as firewalls, intrusion detection systems, and SIEM solutions. If any of these IOCs are matched, it indicates malicious activity that warrants investigation.</p></li>
<li><strong class="bold">Detection and response</strong>: With the enhanced IOCs in place, the security systems of your organization, such as SIEM, IDS, or XDR, actively monitor network traffic and logs for matches against these indicators. When a match is discovered, an alert is generated, and the SOC team is prompted to initiate incident response procedures. For example, an employee clicks a link that leads to the IOC-mentioned URL path (<a href="http://malicious-website.com/login">malicious-website.com/login</a>). This triggers an alert in the intrusion detection system of your organization (e.g. Suricata). The SOC team investigates the incident after receiving the alert. They verify that the user’s computer has visited a malicious URL and may have been exposed to malware. The SOC team isolates the compromised system, initiates malware analysis, and initiates the containment and eradication processes to prevent further spread.</li>
<li><strong class="bold">Continuous improvement</strong>: After the incident has been resolved, the SOC team conducts a post-incident analysis. This involves evaluating the efficacy of the threat detection process, refining the IOCs, and learning from past responses to improve future response strategies. During analysis, the SOC team determines that the phishing attempt originated from an email with a subject line referencing a fake job offer. They decide to add email subject patterns to their IOCs<a id="_idIndexMarker318"/> to detect similar phishing campaigns more effectively in the future.</li>
</ol>
<p class="callout-heading">Note</p>
<p class="callout">IOCs are not just limited to domains, IP addresses, or URLs; they can also be file hashes, email addresses, email subjects and patterns, registry keys, network signatures (data payloads or packet headers), behavioral indicators (unusual file modification, new user accounts), custom YARA rules, user agents, HTTP headers, DNS records, SSL certificates, hosting information, etc.</p>
<p>We learned about how SOC analysts utilize threat intelligence information; however, in order to make it more efficient, we need to automate the threat intelligence process, including collection, observable analysis, and updates.</p>
<h1 id="_idParaDest-83"><a id="_idTextAnchor082"/>Automated threat intelligence</h1>
<p>As of now, you might have <a id="_idIndexMarker319"/>realized the importance of threat intelligence for SOC analysts or blue team. But imagine, if there are thousands of observables generated every day, it will be very difficult to manually copy/paste each observable and search them in the threat intelligence database or feeds. This brings a lot of challenges to SOC, such as delayed threat detection, missed alerts, a lack of consistency, and slow response times. In this section, we will design an automated threat intelligence system and integrate it with Wazuh. We will cover the following:</p>
<ul>
<li>Designing automated threat intelligence</li>
<li>Introduction to MISP</li>
<li>TheHive and Cortex</li>
<li>The workings of threat intelligence and analysis</li>
</ul>
<h2 id="_idParaDest-84"><a id="_idTextAnchor083"/>Designing automated threat intelligence</h2>
<p>Wazuh <a id="_idIndexMarker320"/>is a security platform that<a id="_idIndexMarker321"/> collects security events from all endpoints. To integrate threat intelligence capabilities, we will use an MISP project—an open-source threat intelligence sharing platform. The integration between Wazuh and MISP can be accomplished by using MISP API, as shown in the following figure:</p>
<div><div><img alt="Figure 3.1 – Proposed integration of Wazuh with MISP" src="img/B19549_3_01.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1 – Proposed integration of Wazuh with MISP</p>
<p>However, the design will not allow the security team to track every observable and security incident. We need to build a system wherein we can take the security events from Wazuh <a id="_idIndexMarker322"/>and analyze the observables of each event separately against threat intelligence feeds. In short, we have three tools in this design:</p>
<ul>
<li>Wazuh (security events collection)</li>
<li>A security incident management tool (for receiving alerts from Wazuh and performing a lookup with threat intelligence data)</li>
<li>A threat intelligence tool (this tool is created to provide threat intelligence data to the security incident management tool)</li>
<li>Top of Form</li>
</ul>
<p>We will use the TheHive tool for<a id="_idIndexMarker323"/> security incident management and an MISP project for threat intelligence management. The following figure gives you an idea of the proposed integration of Wazuh with TheHive/Cortex and MISP:</p>
<div><div><img alt="Figure 3.2 – Proposed integration of Wazuh with TheHive/Cortex and MISP" src="img/B19549_3_02.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.2 – Proposed integration of Wazuh with TheHive/Cortex and MISP</p>
<p>This integration of Wazuh, TheHive, and MISP has some major advantages:</p>
<ul>
<li><strong class="bold">Centralized threat intelligence</strong>: The integration lets threat intelligence from MISP be put together in TheHive, creating a central location for Wazuh to store and analyze security events and decide what to do about them. This integration lets security teams correlate events with known risks and IOCs, which makes responding to incidents more accurate and quicker.</li>
<li><strong class="bold">Scalable security operations</strong>: The integration streamlines the handling of security events, enabling scalable security operations. Through the utilization of Wazuh’s detection capabilities, TheHive’s case management skills, and MISP’s threat intelligence capabilities, organizations can effectively handle and address an increasing volume of security incidents without requiring significantly more manual effort.</li>
<li><strong class="bold">Automated incident response</strong>: Although this chapter is about threat intelligence integration, by integrating TheHive, we can also accomplish automated incident response capabilities. By utilizing information from MISP, security analysts can generate response playbooks in TheHive, which enables them to provide more consistent and prompt responses to security incidents identified by <a id="_idIndexMarker324"/>Wazuh.</li>
</ul>
<p>Let’s first quickly understand the capabilities of each of these tools. Then, we will set them up and integrate them with each other.</p>
<h3>Introduction to MISP</h3>
<p><strong class="bold">MISP</strong> is an <a id="_idIndexMarker325"/>open-source threat intelligence platform that enables organizations and security professionals to collect, share, and collaborate on structured threat information. MISP has seven core layers:</p>
<ul>
<li><strong class="bold">Data layer</strong>: This <a id="_idIndexMarker326"/>layer focuses on gathering detailed information about security incidents and threats from the actual threat intelligence data. The primary components of the data layer are as follows:<ul><li><strong class="bold">Events</strong>: Security events<a id="_idIndexMarker327"/> or threat information.</li><li><strong class="bold">Attributes</strong>: Describes<a id="_idIndexMarker328"/> aspects of threats such as IP addresses, domains, hashes, email addresses, etc.</li><li><strong class="bold">Objects</strong>: A template <a id="_idIndexMarker329"/>that specifies contextualized and<a id="_idIndexMarker330"/> organized information about threats.</li></ul></li>
<li><strong class="bold">Context layer</strong>: This layer is <a id="_idIndexMarker331"/>concerned with creating links and correlations between <a id="_idIndexMarker332"/>various pieces of threat intelligence data.</li>
<li><strong class="bold">Correlation layer</strong>: This <a id="_idIndexMarker333"/>layer is responsible for identifying patterns and correlation<a id="_idIndexMarker334"/>s between various events and properties.</li>
<li><strong class="bold">Warning list layer</strong>: Warning <a id="_idIndexMarker335"/>lists are collections of indicators that are considered to be<a id="_idIndexMarker336"/> malicious or suspicious.</li>
<li><strong class="bold">Taxonomies layer</strong>: Taxonomies<a id="_idIndexMarker337"/> standardize threat intelligence data<a id="_idIndexMarker338"/> categorization and classification. They aid in the consistent and orderly organization and description of threats.</li>
<li><strong class="bold">Galaxies layer</strong>: Galaxies are groups <a id="_idIndexMarker339"/>of connected information regarding <a id="_idIndexMarker340"/>various threats, such as threat actors, methods, malware families, and so on. They provide contextual information to help you understand dangers better.</li>
<li><strong class="bold">Feed layer</strong>: Feeds entail <a id="_idIndexMarker341"/>incorporating external threat intelligence sources into <a id="_idIndexMarker342"/>MISP. This layer enables MISP to automatically retrieve and incorporate data from a variety of reliable sources, thereby enhancing the threat intelligence database.</li>
</ul>
<p>As we discussed earlier, we need TheHive as a broker that accepts the security alerts from Wazuh and allows us to analyze each observable against MISP threat intelligence data.</p>
<p>TheHive consists of two tools: TheHive for incident management and Cortex for integration with tons of threat intelligence platforms. TheHive<a id="_idIndexMarker343"/> and Cortex<a id="_idIndexMarker344"/> constitute a potent integration designed for SOC analysts. This integration bridges the gap between effective collaboration and advanced threat analysis, thereby enhancing the SOC’s ability to identify, mitigate, and respond to cybersecurity threats.</p>
<h3>TheHive</h3>
<p><strong class="bold">TheHive</strong> is an <a id="_idIndexMarker345"/>incident response platform designed to help SOC analysts analyze security alerts and incidents. It facilitates collaboration and information sharing among different team members during security investigations and incident responses. Some of the important capabilities of TheHive are as follows:</p>
<ul>
<li><strong class="bold">Observable analysis</strong>: TheHive <a id="_idIndexMarker346"/>can analyze the alerts received from Wazuh, and this enables SOC analysts to pre-qualify alerts before deciding whether to ignore them or convert them into cases.</li>
</ul>
<div><div><img alt="Figure 3.3 – Observable preview" src="img/B19549_3_03.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3 – Observable preview</p>
<ul>
<li><strong class="bold">Case timeline</strong>: A <a id="_idIndexMarker347"/>case timeline illustrates the entirety of the case’s lifecycle, including initial alerts, ongoing and completed tasks, identified IOCs, and much more.</li>
</ul>
<div><div><img alt="Figure 3.4 – Case timeline in TheHive" src="img/B19549_3_04.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.4 – Case timeline in TheHive</p>
<ul>
<li><strong class="bold">Integration</strong>: TheHive<a id="_idIndexMarker348"/> version 5 has strong and default integration capabilities with Cortex, Wazuh, and MISP. However, it can also be integrated with IBM QRadar, Splunk SIEM, Elasticsearch, VirusTotal, and many more.</li>
<li><strong class="bold">Alert TTPs</strong>: TheHive can <a id="_idIndexMarker349"/>contain a set of MITRE ATT&amp;CK TTPs with ATT&amp;CK mapping post-integration with<a id="_idIndexMarker350"/> MISP. MITRE ATT&amp;CK (standing for <strong class="bold">Adversarial Tactics, Techniques, and Common Knowledge</strong>) is a framework that classifies cyber threat behaviors and techniques employed by attackers at various stages of an attack. We will learn more about the MITRE ATT&amp;CK framework in <a href="B19549_06.xhtml#_idTextAnchor163"><em class="italic">Chapter 6</em></a>, <em class="italic">Threat Hunting </em><em class="italic">with Wazuh</em>.</li>
</ul>
<div><div><img alt="Figure 3.5 – Visualizing TTPs in the TheHive platform" src="img/B19549_3_05.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.5 – Visualizing TTPs in the TheHive platform</p>
<p>TheHive and Cortex are made to work together without any problems. TheHive can send observables from incidents to Cortex so that the preset analyzers can look at them. Some jobs can be automated with this integration, which cuts down on the amount of work that needs to be done by hand in the incident response process. Let’s explore the capabilities of Cortex.</p>
<h3>Cortex</h3>
<p><strong class="bold">Cortex</strong> is a <a id="_idIndexMarker351"/>part of the TheHive project. It automates threat intelligence and response, providing SOC analysts with the ability to detect and respond to threats quickly and effectively. One of the core features of Cortex is its ability to integrate several security tools, threat intelligence feeds, security services, and more. Cortex serves as a central repository for this intelligence, allowing analysts to manage and access the information they require with ease.</p>
<p>Cortex has two major components:</p>
<ul>
<li><strong class="bold">Analyzers</strong>: Analyzers<a id="_idIndexMarker352"/> gather and enrich data from various sources to help<a id="_idIndexMarker353"/> SOC analyst teams. There are many types of analyzers that connect to online security services, threat feeds, and databases. After transforming the data, the analyzer can enrich it by checking it against a list of known malicious indicators, querying online services for more information, or running custom scripts for more advanced analysis.</li>
<li><strong class="bold">Responders</strong>: Responders<a id="_idIndexMarker354"/> are used for acting in accordance with the <a id="_idIndexMarker355"/>enriched data supplied by the analyzers. Responders come in a variety of forms, each intended to carry out a particular task, such as blocking an IP address, isolating an infected device, or alerting a security analyst.</li>
</ul>
<h2 id="_idParaDest-85"><a id="_idTextAnchor084"/>Understanding the workings of automated threat intelligence and analysis</h2>
<p>The final design <a id="_idIndexMarker356"/>workflow involves all three<a id="_idIndexMarker357"/> components: Wazuh, TheHive/Cortex, and MISP. This recommended design helps enterprises build an effective and scalable<a id="_idIndexMarker358"/> incident response system. Some of the important steps involved in this automated <a id="_idIndexMarker359"/>threat intelligence and analysis design with Wazuh, TheHive/Cortex, and MISP<a id="_idIndexMarker360"/> are as follows:</p>
<ul>
<li><strong class="bold">Event transfer</strong>: Post-integration, TheHive can receive the security events from Wazuh. We can also configure Wazuh to send only specific types of alerts, such as security alerts matching rule level three or higher.</li>
<li><strong class="bold">Alert triage</strong>: Once the alert is received from Wazuh by TheHive, it can invoke Cortex to immediately look at the observables that are linked to it. This can include things such as running security scans, comparing observables to MISP threat intelligence feeds, or getting more information from the internet.</li>
<li><strong class="bold">Response action</strong>: TheHive can initiate response actions based on Cortex analysis results, such as altering the status of an event, providing tasks for analysts, or generating reports. It helps in the automation of portions of the incident response <a id="_idIndexMarker361"/>workflow.</li>
</ul>
<div><div><img alt="Figure 3.6 – Workflow of threat intelligence and analysis with Wazuh, TheHive, and MISP" src="img/B19549_3_06.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.6 – Workflow of threat intelligence and analysis with Wazuh, TheHive, and MISP</p>
<p>Now that we have learned the entire flow of automated threat intelligence, incident management, and analysis, let’s begin to set up Wazuh, TheHive/Cortex, and MISP tools and integrate them to work seamlessly.</p>
<h1 id="_idParaDest-86"><a id="_idTextAnchor085"/>Setting up TheHive and Cortex</h1>
<p>The deployment design <a id="_idIndexMarker362"/>of TheHive provides companies with flexibility by allowing for both standalone server deployments (deployment on a single server) and clustered deployments (multiple servers work together to handle the TheHive application load). It is recommended to use cluster mode deployment for large production environments. Some of the software components<a id="_idIndexMarker363"/> of TheHive are as follows:</p>
<ul>
<li><strong class="bold">Apache Cassandra</strong>: TheHive utilizes the <a id="_idIndexMarker364"/>Apache Cassandra<a id="_idIndexMarker365"/> database to store its data. Cassandra is a distributed NoSQL database known for its scalability and capability to manage massive amounts of data across a cluster of numerous nodes. Cassandra is utilized within the framework of TheHive to store data pertaining to cases, incidents, and other pertinent information.</li>
<li><strong class="bold">Elasticsearch</strong>: TheHive uses Elasticsearch<a id="_idIndexMarker366"/> for indexing. It is a powerful analytics and search<a id="_idIndexMarker367"/> engine that makes data indexing, querying, and searching more effective. It improves TheHive’s search performance and speed, which makes it simpler for users to find and evaluate data.</li>
<li><strong class="bold">S3 MINIO</strong>: When a <a id="_idIndexMarker368"/>clustered deployment is necessary or when organizations need <a id="_idIndexMarker369"/>scalable and distributed file storage, TheHive provides support for S3-compatible storage solutions<a id="_idIndexMarker370"/> such as <strong class="bold">MINIO</strong>. AWS provides a scalable object <a id="_idIndexMarker371"/>storage, called <strong class="bold">S3</strong> (<strong class="bold">Simple Storage Service</strong>). An open-source substitute called MINIO is compatible with the S3 API.</li>
</ul>
<p>The TheHive application, database, index engine, and file storage can be run separately so each layer can be a node or cluster. TheHive could be set up in a complex clustered architecture using virtual IP addresses and load balancers.</p>
<p>We can set up TheHive and<a id="_idIndexMarker372"/> Cortex in different environments, such as Ubuntu servers, Docker, Kubernetes, etc. To simplify the installation process, we are going to use Docker Compose. We need to take the following steps:</p>
<ol>
<li>Install Docker Compose</li>
<li>Prepare the YML script for the TheHive module</li>
<li>Launch and test</li>
<li>Create an organization and user on TheHive</li>
<li>Create an organization and user on Cortex</li>
</ol>
<h2 id="_idParaDest-87"><a id="_idTextAnchor086"/>Install Docker Compose</h2>
<p>Let’s start with the Ubuntu Server. I’ll <a id="_idIndexMarker373"/>use Ubuntu 23.10 and take the following steps to install Docker Compose:</p>
<ol>
<li><code>apt</code> commands to install Docker dependencies:<pre class="source-code">
<strong class="bold">$ sudo apt update</strong>
<strong class="bold">$ sudo apt install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common</strong></pre></li> <li><strong class="bold">Set up the official Docker repository</strong>: Although Docker packages are available in the default Ubuntu 20.04 repositories, it is recommended that you use the official Docker repository. Run the following commands to enable the Docker repository:<pre class="source-code">
<strong class="bold">$ curl -fsSL </strong><a href="https://download.docker.com/linux/ubuntu/gpg">https://download.docker.com/linux/ubuntu/gpg</a><strong class="bold"> | sudo apt-key add -</strong>
<strong class="bold">$ sudo add-apt-repository \ "deb [arch=amd64] </strong><a href="https://download.docker.com/linux/ubuntu">https://download.docker.com/linux/ubuntu</a><strong class="bold"> \ $(lsb_release -cs) stable"</strong></pre></li> <li><strong class="bold">Install Docker with apt command</strong>: We are now ready to install the most recent and stable version of Docker from its official repository. Run the following to install it:<pre class="source-code">
<strong class="bold">$ sudo apt-get update</strong>
<strong class="bold">$ sudo apt install docker-ce –y</strong></pre><p class="list-inset">After installing the Docker package, run the following command to add your local user to the Docker group:</p><pre class="source-code"><strong class="bold">$ sudo usermod -aG docker rajneesh</strong>
<strong class="bold">$ sudo usermod -aG docker root</strong>
<strong class="bold">$ docker version</strong></pre><p class="list-inset">Verify whether the Docker daemon service is running:</pre><pre class="source-code"><strong class="bold">$ sudo systemctl status docker</strong></pre></li> <li>Install Docker Compose on Ubuntu 23.10. To install Docker Compose on Ubuntu Linux, run the following commands sequentially:<pre class="source-code">
<strong class="bold">$ sudo curl -L "</strong><a href="https://github.com/docker/compose/releases/download/1.29.0/docker-compose-$(uname">https://github.com/docker/compose/releases/download/1.29.0/docker-compose-$(uname</a><strong class="bold"> -s)-$(uname -m)" -o /usr/local/bin/docker-compose</strong>
<strong class="bold">$ sudo chmod +x /usr/local/bin/docker-compose</strong></pre><p class="list-inset">Check the<a id="_idIndexMarker374"/> Docker Compose version by running the following command:</p><pre class="source-code"><strong class="bold">$ docker-compose --version</strong></pre></li> </ol>
<p>If the Docker installation is good, you should see the output with the Docker compose version, OpenSSL version, CPython version, etc.</p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor087"/>Prepare the YML script for the TheHive module</h2>
<p>The primary distinction<a id="_idIndexMarker375"/> between <code>docker run</code> and <code>docker-compose</code> is that <code>docker run</code> is entirely command line-based, whereas <code>docker-compose</code> reads configuration data from a YAML file. So, the beauty of Docker Compose is that we can install all the modules of TheHive with a single YML script, and once this YML script is executed by Docker, all the modules will be turned up. Now, let’s prepare our TheHive YML script:</p>
<ol>
<li><code>theHive</code> and change the directory:<pre class="source-code">
<strong class="bold">$ mkdir theHive</strong>
<code>docker-compose.yml</code> is a configuration file that allows us to configure and launch multiple Docker containers within a single file. Let’s create a <code>docker-compose.yml</code> file with the code shared in the GitHub repository at <a href="https://github.com/PacktPublishing/Security-Monitoring-using-Wazuh/blob/main/Chapter%203/theHive_Docker_Compose.yml">https://github.com/PacktPublishing/Security-Monitoring-using-Wazuh/blob/main/Chapter%203/theHive_Docker_Compose.yml</a>.<p class="list-inset">You can<a id="_idIndexMarker376"/> also find the YML code from the link here: <a href="https://docs.strangebee.com/thehive/setup/installation/docker/">https://docs.strangebee.com/thehive/setup/installation/docker/</a></p></li>
</ol>
<h2 id="_idParaDest-89"><a id="_idTextAnchor088"/>Launch and test</h2>
<p>To deploy the <a id="_idIndexMarker377"/>TheHive, run the following command from the TheHive directory:</p>
<pre class="console">
$ docker-compose up -d</pre> <p>Next, wait for two or three minutes. Open your browser and access TheHive at http:://&lt;Server_IP&gt;:9000 and Cortex at <code>http:://&lt;Server_IP&gt;:9001</code>.</p>
<p>The default credentials of TheHive application are as follows:</p>
<ul>
<li><code>admin@thehive.local</code></li>
<li><code>secret</code></li>
</ul>
<p>Next, Cortex doesn’t provide default credentials; you have to reset the database and set a new username and password. These will be our default admin credentials.</p>
<p>Once you have admin credentials for both theHive and Cortex, we will create an organization and a user under it and generate an API key.</p>
<h2 id="_idParaDest-90"><a id="_idTextAnchor089"/>Create an organization and user on TheHive</h2>
<p>Once you’re<a id="_idIndexMarker378"/> logged in, we need to do a few things. We need to first create an organization and then a user:</p>
<ol>
<li>To create an organization, go to <strong class="bold">Organization</strong> and click <strong class="bold">Add</strong>. Enter a <strong class="bold">Name</strong> and <strong class="bold">Description</strong> and set the tasks sharing rule to <strong class="bold">Manual</strong>.</li>
<li>Next, create two users for the haxcamp organization—a user and an API user. Go to <code>admin</code> and <code>haxcamp</code> organizations. Let us assign the user to the <code>haxamp</code> organizations.</li></ul></li>
<li>Now, let’s create API users. This user account will be used to integrate TheHive with the Wazuh manager. To create an API user, go to <code>API User</code> for the <code>api@haxcamp.local</code> for the login ID, set the account type to <code>org-admin user</code>. Once the API user is created, click on <strong class="bold">Reveal</strong>:</li>
</ol>
<div><div><img alt="Figure 3.7 – Retrieve TheHive API" src="img/B19549_3_07.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.7 – Retrieve TheHive API</p>
<p>Copy the API key and save it somewhere. We will require this API key when integrating TheHive with the Wazuh manager.</p>
<h2 id="_idParaDest-91"><a id="_idTextAnchor090"/>Create an organization and user on Cortex</h2>
<p>Once you’ve set<a id="_idIndexMarker379"/> your admin credentials on Cortex, you need to create an organization. Fill in <strong class="bold">Name</strong> and <strong class="bold">Description</strong>:</p>
<div><div><img alt="Figure 3.8 – Setting up organization details in Cortex" src="img/B19549_3_08.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.8 – Setting up organization details in Cortex</p>
<p>Next, we need to create a user. To do that, go to <strong class="bold">Users</strong>, click on <strong class="bold">Add user</strong>, and fill in <strong class="bold">Login</strong>, <strong class="bold">Full name</strong>, <strong class="bold">Organizations &amp; </strong><strong class="bold">Roles</strong>:</p>
<div><div><img alt="Figure 3.9 – Creating and adding a user in Cortex" src="img/B19549_3_09.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.9 – Creating and adding a user in Cortex</p>
<p>You will notice the following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">Login</strong>: This represents the login username or email address of the user.</li>
<li><strong class="bold">Organization</strong>: This represents the organization the user belongs to.</li>
<li><strong class="bold">Roles</strong>: This shows the role of the user.</li>
</ul>
<p>After creating the<a id="_idIndexMarker380"/> user, you can click on <strong class="bold">Reveal</strong> to reveal the API key and save that for future use when we integrate Cortex with MISP:</p>
<div><div><img alt="Figure 3.10 – Retrieving the Cortex API" src="img/B19549_3_10.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.10 – Retrieving the Cortex API</p>
<p>Alright, now one of the three tools is deployed and ready to use. Let’s work on deploying our MISP project before we finally get to Wazuh.</p>
<h1 id="_idParaDest-92"><a id="_idTextAnchor091"/>Setting up MISP</h1>
<p><strong class="bold">MISP</strong> is an <a id="_idIndexMarker381"/>open source software and there are different ways we can install it to build our own threat intelligence and share it with the community. MISP can be installed on most Linux distributions, and the MISP community has created simple install scripts. MISP has many dependencies and combines various software to function properly. This is also known as<a id="_idIndexMarker382"/> the <strong class="bold">LAMP</strong> stack:</p>
<ul>
<li>Linux operating system</li>
<li>Apache for web server</li>
<li>MySQL relational database</li>
<li>Miscellaneous—PHP, Perl, Python</li>
</ul>
<p>We can deploy MISP in different environments (<a href="https://www.misp-project.org/download/">https://www.misp-project.org/download/</a>), such as Docker, VirtualBox VM, and VMware VM. Deploying MISP and its dependencies via Docker is by far the simplest installation process I’ve found. VirtualBox VM and VMware VM are good for lab and testing environments. Take the following steps to set up MISP:</p>
<ol>
<li>Fulfill the requirements.</li>
<li>Install Docker and Docker Compose.</li>
<li>Set up and launch MISP.</li>
<li>Add an organization and users.</li>
<li>Add feeds.</li>
</ol>
<h2 id="_idParaDest-93"><a id="_idTextAnchor092"/>Fulfill the requirements</h2>
<p>To set up MISP in the <a id="_idIndexMarker383"/>Docker environment, we require Ubuntu Server 22.04.</p>
<h2 id="_idParaDest-94"><a id="_idTextAnchor093"/>Install Docker and Docker Compose</h2>
<p>To set up<a id="_idIndexMarker384"/> Docker and<a id="_idIndexMarker385"/> Docker Compose, refer the <em class="italic">step 1</em> of <em class="italic">Setting </em><em class="italic">up TheHive/Cortex</em>.</p>
<h2 id="_idParaDest-95"><a id="_idTextAnchor094"/>Set up and Launch MISP</h2>
<p>Now that we’ve<a id="_idIndexMarker386"/> installed Docker, we need to install the MISP Docker image and configure the environmental variable. This will have four sub-steps:</p>
<ol>
<li>Clone the Git repository.</li>
<li>Modify the environmental variable file.</li>
<li>Start Docker Compose.</li>
<li>Launch MISP.</li>
</ol>
<p>We will initiate the installation of MISP using their official GitHub repository, as explained:</p>
<ol>
<li><strong class="bold">Clone the Git repository</strong>: Let’s clone the get repository with the following command:<pre class="source-code">
<code>template.env</code> to <code>.env</code> (on the root directory) and edit the environment variables in the <code>.</code><code>env</code> file:</pre><pre class="source-code">
<strong class="bold">$ cp template.env .env</strong></pre><p class="list-inset">Next, open the file and edit it using the GNU nano editor:</p><pre class="source-code"><strong class="bold">$ nano .env</strong> 
and set the MISP_BASEURL to https://&lt;Server_IP&gt;</pre><p class="list-inset">The final file should look like this:</p><pre class="source-code"><strong class="bold">MYSQL_HOST=misp_db</strong>
<strong class="bold">MYSQL_DATABASE=misp</strong>
<strong class="bold">MYSQL_USER=misp</strong>
<strong class="bold">MYSQL_PASSWORD=misp</strong>
<strong class="bold">MYSQL_ROOT_PASSWORD=misp</strong>
<strong class="bold">MISP_ADMIN_EMAIL=admin@admin.test</strong>
<strong class="bold">MISP_ADMIN_PASSPHRASE=admin</strong>
<strong class="bold">MISP_BASEURL=https://&lt;Server_IP&gt;</strong>
<strong class="bold">POSTFIX_RELAY_HOST=relay.fqdn</strong>
<strong class="bold">TIMEZONE=Europe/Brussels</strong>
<strong class="bold">DATA_DIR=./data</strong></pre></li> <li><strong class="bold">Start Docker Compose</strong>: To start the <a id="_idIndexMarker387"/>MISP Docker container, we need to build it using this command:<pre class="source-code">
<code>https://&lt;MISP_Server_IP&gt;</code>.<p class="list-inset">The default credentials are as follows:</pre><ul><li>Username: <code>admin@admin.test</code></li><li>Password: <code>admin</code></li></ul></li>
</ol>
<h2 id="_idParaDest-96"><a id="_idTextAnchor095"/>Add an organization and users</h2>
<p>We need to create a local <a id="_idIndexMarker389"/>organization and add a user to it. Go to <strong class="bold">Administration</strong> and enter the <strong class="bold">Organization</strong> identifier, Generate <strong class="bold">UUID</strong>, Upload the company logo (optional), and click on <strong class="bold">Submit</strong>.</p>
<div><div><img alt="Figure 3.11 – Setting up organization details in the MISP platform" src="img/B19549_3_11.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.11 – Setting up organization details in the MISP platform</p>
<p>You will notice the<a id="_idIndexMarker390"/> following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">Organization Identifier</strong>: This represents a unique name for each organization.</li>
<li><strong class="bold">UUID</strong>: This is a unique identifier that ensures that each piece of information has a global unique identifier. You can even generate UUID online from a website such as <a href="http://www.uuidgenerator.net">www.uuidgenerator.net</a>.</li>
</ul>
<p>Now, to add a user to your organization, go to <strong class="bold">Administration</strong> &gt; <strong class="bold">Add User</strong> and enter your email, set the password, select your own organization, set the role to <strong class="bold">Org Admin</strong>, and click on <strong class="bold">Create User</strong>.</p>
<div><div><img alt="Figure 3.12 – Adding an admin user on MISP" src="img/B19549_3_12.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.12 – Adding an admin user on MISP</p>
<p>You will notice the <a id="_idIndexMarker391"/>following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">Email</strong>: This represents the email address of the admin user.</li>
<li><strong class="bold">Organization</strong>: This represents the organization’s name.</li>
<li><strong class="bold">Role</strong>: This<a id="_idIndexMarker392"/> represents the role of the user. In this case, you should set it to <strong class="bold">admin</strong>.</li>
</ul>
<h2 id="_idParaDest-97"><a id="_idTextAnchor096"/>Add feeds</h2>
<p>MISP uses<a id="_idIndexMarker393"/> feeds to download threat reports, IOCs, and other information. These feeds contain all of the data stored by MISP. Feeds are not enabled by default when configuring MISP. To use our feeds, we must import and enable them. Fortunately, MISP helps us with some good threat intelligence feeds. This feed information is fetched in JSON format and can be downloaded from their official GitHub repository at <a href="https://github.com/MISP/MISP/blob/2.4/app/files/feed-metadata/defaults.json">https://github.com/MISP/MISP/blob/2.4/app/files/feed-metadata/defaults.json</a>.</p>
<p>Copy the raw data. Next, visit the MISP application, go to <strong class="bold">Sync Actions</strong>, click on <strong class="bold">Import Feeds from JSON</strong>, and paste the metadata there:</p>
<div><div><img alt="Figure 3.13 – Adding feeds to MISP" src="img/B19549_3_13.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.13 – Adding feeds to MISP</p>
<p>Here, <strong class="bold">Server metadata</strong> represents<a id="_idIndexMarker394"/> the JSON value of the threat intelligence feeds.</p>
<p>Next, enable the feeds. To do that, go to <strong class="bold">Sync Actions</strong> and click on <strong class="bold">List Feeds</strong>. Select all the feeds and click on <strong class="bold">Enable Selected</strong>:</p>
<div><div><img alt="Figure 3.14 – Visualizing feeds in MISP" src="img/B19549_3_14.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.14 – Visualizing feeds in MISP</p>
<p>Here <strong class="bold">List Feeds</strong> represents <a id="_idIndexMarker395"/>a list of all the threat intelligence feeds with their providers’ details.</p>
<p>This completes our task of setting up MISP applications. Next, we will work on integrating Wazuh and MISP with TheHive.</p>
<h1 id="_idParaDest-98"><a id="_idTextAnchor097"/>Integrating Wazuh with TheHive</h1>
<p>We will integrate<a id="_idIndexMarker396"/> Wazuh with TheHive to automatically send Wazuh alerts to TheHive. SOC analysts will then be able to investigate and respond to these alerts, as well as create cases if necessary. In this section, we will take the following steps:</p>
<ol>
<li>Install the TheHive Python script on the Wazuh manager.</li>
<li>Create an integration Python script on the Wazuh manager.</li>
<li>Create a Bash script on the Wazuh manager.</li>
<li>Integrate TheHive server in Wazuh server configurations.</li>
<li>Restart the manager.</li>
<li>Visualize the alerts on TheHive.</li>
</ol>
<h2 id="_idParaDest-99"><a id="_idTextAnchor098"/>Install TheHive Python script on the Wazuh manager</h2>
<p>We will use a<a id="_idIndexMarker397"/> Python script that will enable custom integration of TheHive with the Wazuh manager. We’ll write in the following step which we will use as a reference. This module is operational as of the time of this writing after being tested with TheHive version 5.2.1.</p>
<p>Let’s first install the <code>thehive4py</code> module using the following command:</p>
<pre class="console">
sudo /var/ossec/framework/python/bin/pip3 install thehive4py</pre> <h2 id="_idParaDest-100"><a id="_idTextAnchor099"/>Create an integration Python script on the Wazuh manager</h2>
<p>It is necessary to build <a id="_idIndexMarker398"/>the script <code>custom-w2thive.py</code> in the <code>/var/ossec/integrations/</code> directory to allow for the integration of TheHive with Wazuh. You can find the full code from the GitHub repository at <a href="https://github.com/PacktPublishing/Security-Monitoring-using-Wazuh/blob/main/Chapter%203/custom_thehive_integration_Wazuh.py">https://github.com/PacktPublishing/Security-Monitoring-using-Wazuh/blob/main/Chapter%203/custom_thehive_integration_Wazuh.py</a>. Let me explain the import statement of this code to clarify how it is being built. I have broken down the first part (the import statement).</p>
<h3>Import statement</h3>
<p>This<a id="_idIndexMarker399"/> part of the python code defines the imported module or packages.</p>
<pre class="source-code">
#!/var/ossec/framework/python/bin/python3
import json
import sys
import os
import re
import logging
import uuid
from thehive4py.api import TheHiveApi
=</pre> <p>Here, the lines import various Python modules, including <code>json</code>, <code>sys</code>, <code>os</code>, <code>re</code>, <code>logging</code>, <code>uuid</code>, and specific modules from the <code>thehive4py</code> package.</p>
<h3>User configuration</h3>
<p>This section<a id="_idIndexMarker400"/> of the code defines the user-configurable parameters as global variables:</p>
<pre class="source-code">
lvl_threshold=0
suricata_lvl_threshold=3
debug_enabled = False
info_enabled = True</pre> <p>Let us break down the code:</p>
<ul>
<li><code>lvl_threshold=0</code>: This indicates that TheHive will receive all the alerts generated by Wazuh. If you have a large network with thousands of monitored agents, keep it higher so that you get more relevant alerts.</li>
<li><code>debug_enable = False</code>: This represents the debugging option. In this case, it is set to <code>False</code>.</li>
<li><code>info_enabled= True</code>: This is the information logging option. In this code, it is set to <code>True</code>.</li>
</ul>
<p>Now, let’s set proper permissions and ownership using the <code>chmod</code> and <code>chown</code> commands:</p>
<pre class="console">
sudo chmod 755 /var/ossec/integrations/custom-w2thive.py
sudo chown root:wazuh /var/ossec/integrations/custom-w2thive.py</pre> <h2 id="_idParaDest-101"><a id="_idTextAnchor100"/>Create a Bash script on the Wazuh manager</h2>
<p>To <a id="_idIndexMarker401"/>successfully execute the <code>.py</code> script developed, we must construct a bash script called <code>custom-w2thive</code> and place it in <code>/var/ossec/integrations/custom-w2thive</code>. You can copy the entire code from the GitHub repository at <a href="https://github.com/PacktPublishing/Security-Monitoring-using-Wazuh/blob/main/Chapter%203/custom_thehive_bash_script_Wazuh..sh">https://github.com/PacktPublishing/Security-Monitoring-using-Wazuh/blob/main/Chapter%203/custom_thehive_bash_script_Wazuh..sh</a>. Let me break down this bash script to help you understand its functionality.</p>
<h3>Setting variables</h3>
<p>In this part of the bash script, some variables are defined as shown in the code:</p>
<pre class="source-code">
WPYTHON_BIN="framework/python/bin/python3"
SCRIPT_PATH_NAME="$0"
DIR_NAME="$(cd $(dirname ${SCRIPT_PATH_NAME}); pwd -P)"
SCRIPT_NAME="$(basename ${SCRIPT_PATH_NAME})"</pre> <ul>
<li><code>WPYTHON_BIN</code> is set to the path of the Python 3 interpreter</li>
<li><code>SCRIPT_PATH_NAME</code> is set to the full path of the script</li>
<li><code>DIR_NAME</code> is set to the absolute path of the directory containing the script</li>
<li><code>SCRIPT_NAME</code> is set to the base name of the script</li>
</ul>
<h3>Determining the Python script path</h3>
<p>This part of the script is used to get the location of the <code>custom-w2thive.py</code> file:</p>
<pre class="source-code">
case ${DIR_NAME} in
    */active-response/bin | */wodles*)
        if [ -z "${WAZUH_PATH}" ]; then
            WAZUH_PATH="$(cd ${DIR_NAME}/../..; pwd)"
        fi
    PYTHON_SCRIPT="${DIR_NAME}/${SCRIPT_NAME}.py"
    ;;
    */bin)
    if [ -z "${WAZUH_PATH}" ]; then
        WAZUH_PATH="$(cd ${DIR_NAME}/..; pwd)"
    fi
    PYTHON_SCRIPT="${WAZUH_PATH}/framework/scripts/${SCRIPT_NAME}.py"
    ;;
     */integrations)
        if [ -z "${WAZUH_PATH}" ]; then
            WAZUH_PATH="$(cd ${DIR_NAME}/..; pwd)"
        fi
    PYTHON_SCRIPT="${DIR_NAME}/${SCRIPT_NAME}.py"
    ;;
Esac</pre> <p>Let us break them down the <a id="_idIndexMarker402"/>preceding code:</p>
<ul>
<li><code>*/active-response/bin | */wodles*)</code>: This is a pattern that if matched, sets <code>WAZUH_PATH</code> and <code>PYTHON_SCRIPT</code> to <code>${DIR_NAME}/${SCRIPT_NAME}.py</code>.</li>
<li><code>(*/bin)</code>: This is another pattern that, if matched, sets <code>WAZUH_PATH</code> and <code>PYTHON_SCRIPT</code> to <code>${WAZUH_PATH}/framework/scripts/${SCRIPT_NAME}.py</code>.</li>
<li><code>(*/integrations)</code>: This is the third pattern that, if matched, sets <code>WAZUH_PATH</code> and <code>PYTHON_SCRIPT</code> to <code>${DIR_NAME}/${SCRIPT_NAME}.py</code>.</li>
</ul>
<h3>Setting the Python script path</h3>
<p>Once the<a id="_idIndexMarker403"/> Python script is set in <code>PYTHON_SCRIPT</code>, this script executes the Python script:</p>
<pre class="source-code">
${WAZUH_PATH}/${WPYTHON_BIN} ${PYTHON_SCRIPT} $@</pre> <p>Here, <code>(${WAZUH_PATH}/${WPYTHON_BIN})</code> with any command-line arguments is passed to the Bash script (<code>$@</code>).</p>
<p>As we did earlier, let’s again set the required permissions and ownership using <code>chmod</code> and <code>chown</code>, respectively:</p>
<pre class="console">
sudo chmod 755 /var/ossec/integrations/custom-w2thive
sudo chown root:wazuh /var/ossec/integrations/custom-w2thive</pre> <h2 id="_idParaDest-102"><a id="_idTextAnchor101"/>Integrate the TheHive server in the Wazuh server configurations</h2>
<p>Now, you <a id="_idIndexMarker404"/>need to modify <code>/var/ossec/etc/ossec.conf</code> using your favorite text editor and insert the following code:</p>
<pre class="source-code">
&lt;ossec_config&gt;
…
  &lt;integration&gt;
    &lt;name&gt;custom-w2thive&lt;/name&gt;
    &lt;hook_url&gt;http://TheHive_Server_IP:9000&lt;/hook_url&gt;
    &lt;api_key&gt;RWw/Ii0yE6l+Nnd3nv3o3Uz+5UuHQYTM&lt;/api_key&gt;
    &lt;alert_format&gt;json&lt;/alert_format&gt;
  &lt;/integration&gt;
…
&lt;/ossec_config&gt;</pre> <p>Let us break down the code:</p>
<ul>
<li><code>&lt;integration&gt;</code>: This specifies the integration with the external applications or platforms.</li>
<li><code>&lt;hootk_url&gt;</code>: This defines the URL endpoint. In this case, it is the URL of the TheHive platform.</li>
<li><code>&lt;api_key&gt;</code>: This represents the API key associated with the integration. In this case, it is the API<a id="_idIndexMarker405"/> key of the TheHive platform.</li>
</ul>
<h2 id="_idParaDest-103"><a id="_idTextAnchor102"/>Restart and test</h2>
<p>Once <a id="_idIndexMarker406"/>complete, you need to restart the Wazuh manager:</p>
<pre class="console">
sudo systemctl restart wazuh-manager</pre> <h2 id="_idParaDest-104"><a id="_idTextAnchor103"/>Visualizing the alerts on TheHive</h2>
<p>If everything <a id="_idIndexMarker407"/>went according to plan, you should soon start seeing notifications generated under the <strong class="bold">Alerts</strong> tab in TheHive. As you can see in the screenshot, it worked:</p>
<div><div><img alt="Figure 3.15 – Visualizing alerts on TheHive" src="img/B19549_3_15.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.15 – Visualizing alerts on TheHive</p>
<p>Next, we need to integrate TheHive/Cortex with MISP threat intel to perform observable analysis.</p>
<h1 id="_idParaDest-105"><a id="_idTextAnchor104"/>Integrating TheHive and Cortex with MISP</h1>
<p>TheHive<a id="_idIndexMarker408"/> and Cortex<a id="_idIndexMarker409"/> are powerful when they work together. TheHive is helpful in incident response, case management, collaboration, and threat analysis while Cortex is a powerful threat intel aggregator. Once we Integrate TheHive and Cortex with MISP, we can even run the observable analyzer directly from TheHive as a result; we don’t have to manually perform analysis by going to Cortex. In order to achieve this automation, we need to do three things:</p>
<ol>
<li>Integrate TheHive with Cortex</li>
<li>Integrate Cortex with MISP</li>
<li>Integrate TheHive with MISP</li>
</ol>
<h2 id="_idParaDest-106"><a id="_idTextAnchor105"/>Integrate TheHive with Cortex</h2>
<p>To integrate TheHive and <a id="_idIndexMarker410"/>Cortex, you need to enter the Cortex API key<a id="_idIndexMarker411"/> in the TheHive settings. I hope you’ve copied the Cortex API key, as explained in the earlier section <em class="italic">Setting up TheHive and Cortex</em> | <em class="italic">Create an organization and user on Cortex</em>. Now, in order to complete the integration, log in with the admin account or switch to the admin profile and click on the <strong class="bold">Platform Management</strong> tab. Test the server connection, as shown in the screenshot:</p>
<div><div><img alt="Figure 3.16 – Testing the server connection between TheHive and Cortex" src="img/B19549_3_16.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.16 – Testing the server connection between TheHive and Cortex</p>
<p>You will notice the following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">API Key</strong>: This represents the API key of the Cortex server</li>
<li><strong class="bold">Do not check Certificate Authority</strong>: It is recommended to keep this disabled if you have not installed SSL on the server</li>
</ul>
<h2 id="_idParaDest-107"><a id="_idTextAnchor106"/>Integrate Cortex with MISP</h2>
<p>Log in<a id="_idIndexMarker412"/> to Cortex with your newly created account and then go to <code>MISP_2_1 Analyzer</code>:</p>
<div><div><img alt="Figure 3.17 – Searching for MISP analyzer under Cortex" src="img/B19549_3_17.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.17 – Searching for MISP analyzer under Cortex</p>
<p>Here, <strong class="bold">MISP_2_1</strong> represents the MISP analyzers for performing observable analysis.</p>
<p>Next, click on <strong class="bold">Edit</strong> and a prompt will appear to configure the MISP integration. Enter a name, MISP base URL, and MISP API key, and set <strong class="bold">cert_check</strong> to <strong class="bold">False</strong> (if you haven’t configured the SSL):</p>
<div><div><img alt="Figure 3.18 – Integrating MISP with Cortex" src="img/B19549_3_18.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.18 – Integrating MISP with Cortex</p>
<p>You will<a id="_idIndexMarker414"/> need to<a id="_idIndexMarker415"/> enter the following:</p>
<ul>
<li><strong class="bold">Name</strong>: This indicates the name of the MISP analyzer.</li>
<li><strong class="bold">URL</strong>: This represents the URL of the MISP platform.</li>
<li><strong class="bold">Key</strong>: This indicates the API key of the MISP server.</li>
<li><strong class="bold">cert_check</strong>: This will dictate whether the Cortex will perform an SSL check or not. In this case, we will keep it <strong class="bold">False</strong>.</li>
</ul>
<p>Now, it’s time to verify the integration with a sample analyzer. In the top left, you have a <strong class="bold">New Analysis</strong> button. Now, set <strong class="bold">TLP</strong> to <strong class="bold">AMBER</strong>, <strong class="bold">PAP</strong> to <strong class="bold">AMBER</strong>, and <strong class="bold">Data Type</strong> to <strong class="bold">domain</strong>. Immediately, you get a new <strong class="bold">Button MISP_2_1</strong>, as shown:</p>
<div><div><img alt="Figure 3.19 – Running MISP analyzer on Cortex" src="img/B19549_3_19.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.19 – Running MISP analyzer on Cortex</p>
<h2 id="_idParaDest-108"><a id="_idTextAnchor107"/>Integrate TheHive with MISP</h2>
<p>The best part about <a id="_idIndexMarker416"/>TheHive suite is that MISP is already integrated with it. You <a id="_idIndexMarker417"/>only need to enter the API key of MISP in the TheHive platform. To complete the integration, log in with an admin account or switch to an admin profile and click on the <strong class="bold">Platform Management</strong> tab. You need to set up the MISP server name, server URL, and API key, and then you can test the connection, as shown in the screenshot:</p>
<div><div><img alt="Figure 3.20 – Testing the connection between TheHive and MISP" src="img/B19549_3_20.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.20 – Testing the connection between TheHive and MISP</p>
<p>You will notice the<a id="_idIndexMarker418"/> following in <a id="_idIndexMarker419"/>the preceding screenshot:</p>
<ul>
<li><strong class="bold">Server name</strong>: This is the name of the MISP server.</li>
<li><strong class="bold">Server url</strong>: This represents the URL of the MISP server.</li>
<li><strong class="bold">API Key</strong>: This indicates the API key of the MISP server.</li>
<li><strong class="bold">Purpose</strong>: This shows how this API integration will be used. It can be <strong class="bold">Export</strong>, <strong class="bold">Import</strong>, or both. In this case, we will set it to <strong class="bold">Export</strong> to send queries.</li>
<li><strong class="bold">Do not check Certificate Authority</strong>: It is recommended to keep this disabled if you have not installed SSL on the server.</li>
<li><strong class="bold">Test server connection</strong>: This runs a connection check between TheHive and the MISP server.</li>
</ul>
<p>Finally, the installation and integration of all three tools—Wazuh, TheHive/Cortex, and MISP—is complete. We will now focus on some important use cases of threat intelligence and analysis.</p>
<h1 id="_idParaDest-109"><a id="_idTextAnchor108"/>Use cases</h1>
<p>Wazuh and<a id="_idIndexMarker420"/> TheHive integration offers a lot of benefits to SOC analysts and incident response teams. We will go through different use cases to explore several features of TheHive and MISP that work extremely well with Wazuh. We will go through some common use cases such as investigating suspicious file and network connections and tracking TTPs. In this section, we will cover the following topics:</p>
<ul>
<li>Pre-requisites</li>
<li>Reviewing alerts</li>
<li>Creating a case</li>
<li>Analyzing file observable</li>
<li>Analyzing network observable</li>
<li>Managing TTPs</li>
</ul>
<h2 id="_idParaDest-110"><a id="_idTextAnchor109"/>Pre-requisites</h2>
<p>Before we get<a id="_idIndexMarker421"/> into some use cases of threat intelligence and analysis with Wazuh, TheHive, and MISP, we need to ensure these requirements are fulfilled:</p>
<ul>
<li>A Wazuh server</li>
<li>An Ubuntu server running TheHive and Cortex using Docker</li>
<li>An Ubuntu server running an MISP server</li>
<li>Ubuntu Desktop or Ubuntu Server with the Wazuh agent installed</li>
</ul>
<h2 id="_idParaDest-111"><a id="_idTextAnchor110"/>Reviewing alert</h2>
<p>Once you integrate <a id="_idIndexMarker422"/>Wazuh with TheHive, you will start getting security alerts. Before you start investigating alerts or analyzing any observable against the MISP server, you need to get a good understanding of TheHive alert attributes. You can review all the important attributes of an alert in the following screenshot:</p>
<div><div><img alt="Figure 3.21 – Reviewing security alerts on TheHive" src="img/B19549_3_21.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.21 – Reviewing security alerts on TheHive</p>
<p>You will notice the following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">General</strong>: This is a tab that has <strong class="bold">Tags</strong>, <strong class="bold">Description</strong>, Wazuh <strong class="bold">Rule</strong>, and Wazuh <strong class="bold">Agent</strong> information</li>
<li><strong class="bold">Observable</strong>: This shows information such as IP addresses, domains, URLs, hashes, etc.</li>
<li><strong class="bold">TTPs</strong>: This shows MITRE attack tactics and techniques</li>
<li><strong class="bold">Similar Cases</strong>: This will show you existing related cases</li>
<li><strong class="bold">Similar Alerts</strong>: This will show you similar alerts</li>
<li><strong class="bold">Responder</strong>: This shows TheHive responder reports</li>
<li><strong class="bold">History</strong>: This shows the history of alerts</li>
</ul>
<p>In the top left, you have action items, such as the following:</p>
<ul>
<li><strong class="bold">Create case from alert</strong>: You can create a brand new case with this alert. I recommend you do this only when you’re certain that it is not a false positive.</li>
<li><strong class="bold">Merge selection into case</strong>: You can merge alerts into a single case.</li>
<li><strong class="bold">Ignore new update</strong>: Once selected, you will not get any update on this alert.</li>
<li><strong class="bold">Start</strong>: Once you click on this play button, you can take it ahead without creating a case. You can change the status of the alert to <strong class="bold">Pending</strong>, add some summary notes, and assign it to another analyst or Tier 2 analyst.</li>
<li><strong class="bold">Close</strong>: If you are certain that it’s a false positive or duplicate, you can close the alert.</li>
</ul>
<p>Based on your<a id="_idIndexMarker423"/> investigation, you can also change the status of the alert, as shown in this screenshot:</p>
<div><div><img alt="Figure 3.22 – Changing the alert status" src="img/B19549_3_22.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.22 – Changing the alert status</p>
<p>You will notice the following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">Status</strong>: This is the alert status, and it can be <strong class="bold">New</strong>, <strong class="bold">In Progress</strong>, <strong class="bold">Pending</strong>, <strong class="bold">Imported</strong>, <strong class="bold">Duplicate</strong>, <strong class="bold">False Positive</strong>, or <strong class="bold">Ignored</strong>. In this case, it is set to <strong class="bold">Duplicate</strong>.</li>
<li><strong class="bold">Assignee</strong>: This states whom you want to assign this alert to. It can be your team <a id="_idIndexMarker424"/>member, SOC Level 2, the threat intelligence team, etc.</li>
</ul>
<h2 id="_idParaDest-112"><a id="_idTextAnchor111"/>Creating a case</h2>
<p>Once you are <a id="_idIndexMarker425"/>confident that you need to work on a certain alert, you can either create a fresh case or use a case template. Once you click on an empty case, you need to enter details such as the case title, severity, tasks, etc. You can create multiple tasks and assign them to different team members, as shown in screenshot:</p>
<div><div><img alt="Figure 3.23 – Creating a new case in TheHive" src="img/B19549_3_23.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.23 – Creating a new case in TheHive</p>
<p>You will notice<a id="_idIndexMarker426"/> the following in the preceding screenshot:</p>
<ul>
<li><code>Suspicious </code><code>File detected</code>.</li>
<li><strong class="bold">Severity</strong>: This represents how critical the case is.</li>
<li><strong class="bold">Add a task</strong>: This <a id="_idIndexMarker427"/>allows you to add multiple tasks.</li>
</ul>
<h2 id="_idParaDest-113"><a id="_idTextAnchor112"/>Analyzing file observables</h2>
<p>As we know, observables are<a id="_idIndexMarker428"/> initial information that needs to be analyzed before it is marked as an IOC. TheHive detects observables from Wazuh security events. Then, we can analyze the observables against multiple threat Intelligence feeds. The pre-defined observable types are IPs, email addresses, URLs, domain names, files, and hashes.</p>
<p>When you create a case from an alert, observables from alerts are also transferred to the theHive case. Even if you don’t have any observables, you can create an observable and analyze it against MISP threat intelligence feeds. You can click on <strong class="bold">Add an Observable</strong> and enter the details, as shown in the following screenshot:</p>
<div><div><img alt="Figure 3.24 – Adding an observable in TheHive" src="img/B19549_3_24.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.24 – Adding an observable in TheHive</p>
<p>You will <a id="_idIndexMarker429"/>notice the following in the preceding screenshot:</p>
<ul>
<li><code>filename</code>.</li>
<li><code>svchost.exe</code> file.</li>
<li><strong class="bold">Tags</strong>: Write any relevant tags.</li>
<li><strong class="bold">Description</strong>: Write a simple and relevant description.</li>
</ul>
<p>Next, let’s click on hamburger menu on the left of the <code>filename</code> observable and select <strong class="bold">Run analyzers</strong>, as shown in the following screenshot:</p>
<div><div><img alt="Figure 3.25 – Information about the observable" src="img/B19549_3_25.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.25 – Information about the observable</p>
<p>You will notice the following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">Svchost[.]exe</strong>: This is the sample file and is added as an observable.</li>
<li><code>Svshost[.]exe</code> and run the analyzer against the MISP server for threat intelligence lookup. Once we select <strong class="bold">Run analyzers</strong>, you should see <strong class="bold">MISP_2_1</strong>. Select it and click on <strong class="bold">Run Selected Analyzer</strong>, as <a id="_idIndexMarker430"/>shown in this screenshot:</li>
</ul>
<div><div><img alt="Figure 3.26 – Executing the MISP analyzer" src="img/B19549_3_26.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.26 – Executing the MISP analyzer</p>
<p>Next, wait for 10 to 20 seconds<a id="_idIndexMarker431"/> and you should get a report under the same observable from the MISP Server. Bingo! As shown in the screenshot, you can find the result from the MISP server:</p>
<div><div><img alt="Figure 3.27 – Receiving the threat intelligence result from the MISP server" src="img/B19549_3_27.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.27 – Receiving the threat intelligence result from the MISP server</p>
<p>Once you click on it, you will see all eight matching events (threat intel feeds) in MISP, as shown:</p>
<div><div><img alt="Figure 3.28 – Visualizing the observable analysis report from the MISP Server" src="img/B19549_3_28.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.28 – Visualizing the observable analysis report from the MISP Server</p>
<p>You can go to any of the MISP events and click on <strong class="bold">EventID</strong>. You will be redirected to the MISP server for a specific event, as shown in this screenshot:</p>
<div><div><img alt="Figure 3.29 – Visualizing the threat intelligence event from the MISP server" src="img/B19549_3_29.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.29 – Visualizing the threat intelligence event from the MISP server</p>
<p>You will notice the<a id="_idIndexMarker432"/> following in the preceding screenshot:</p>
<ul>
<li><strong class="bold">EventID</strong>: This represents the event ID from the MISP server. In this case, the event ID is <strong class="bold">1125</strong>.</li>
<li><strong class="bold">From</strong>: This represents the threat intelligence feed provider. In this case, it is <strong class="bold">CIRCL</strong>.</li>
</ul>
<p>To explore this specific event even further, we can log in to our MISP server and navigate to <code>1125</code> and find the result, as shown in this screenshot:</p>
<div><div><img alt="Figure 3.30 – Visualizing the event in the MISP server" src="img/B19549_3_30.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.30 – Visualizing the event in the MISP server</p>
<p>Let us break down<a id="_idIndexMarker433"/> some of the entries:</p>
<ul>
<li><strong class="bold">Info</strong>: This is a brief and descriptive summary of the event. In this case, it is <strong class="bold">IECrypt sample analyzed with VMRay Analyzer Report for </strong><strong class="bold">Sample #245141</strong>.</li>
<li><strong class="bold">Date</strong>: This is the date and time when the event was created.</li>
<li><strong class="bold">Threat Level</strong>: This represents the severity or criticality of the threat. It can be low, medium, or high.</li>
<li><strong class="bold">Analysis</strong>: This indicates the current analysis state of the event, e.g., initial, ongoing, or completed.</li>
<li><strong class="bold">Distribution</strong>: This specifies the distribution level of the event, finding out who can access the information, such as only the organization, the sharing group, or the community. In this case, it is <strong class="bold">All Communities</strong>.</li>
<li><strong class="bold">Tags</strong>: This is <a id="_idIndexMarker434"/>a list of tags associated with the event, delivering additional categorization or metadata.</li>
</ul>
<h2 id="_idParaDest-114"><a id="_idTextAnchor113"/>Analyzing network observables</h2>
<p>Now, let’s suppose<a id="_idIndexMarker435"/> you have some IP and domain observables. We can also test them in the same manner, or you can add related observables found during the investigation of other events. You can navigate to the <strong class="bold">Observables</strong> tab and, as you can see in the screenshot, we have some IP addresses as observables:</p>
<div><div><img alt="Figure 3.31 – Visualizing IP address observables in TheHIve" src="img/B19549_3_31.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.31 – Visualizing IP address observables in TheHIve</p>
<p>Let us break down the highlighted boxes in the screenshot:</p>
<ul>
<li><strong class="bold">95[.]154[.]195[.]171</strong>: This is a sample IP address observable that needs to be analyzed by the MISP server</li>
<li><strong class="bold">drivgoogle[.]firewall-gateway[.]com</strong>: This is a sample domain name in the observable list that needs to be analyzed by the security team</li>
</ul>
<p>Next, wait for 10 to 20 seconds and you should get a report under the same observable from the MISP Server. Awesome! As shown in the next screenshot, you can find the result from the MISP server:</p>
<div><div><img alt="Figure 3.32 – Visualizing the observable analysis report from the MISP Server" src="img/B19549_3_32.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.32 – Visualizing the observable analysis report from the MISP Server</p>
<p>Here, <code>1125</code>.</p>
<h2 id="_idParaDest-115"><a id="_idTextAnchor114"/>Managing TTPs</h2>
<p>TTP analysis <a id="_idIndexMarker437"/>can aid security teams in detecting and mitigating attacks by revealing how threat actors conduct their operations. TTPs are tactics, techniques, and procedures used by threat actors. The MITRE ATT&amp;CK framework empowers SOC teams to identify and address TTPs they encounter. The MITRE ATT&amp;CK framework consists of 14 tactics and hundreds of associated techniques and procedures. TheHive imports TTPs from Wazuh events and enhances our security investigation. You can also add a new TTP to any case by taking these steps:</p>
<ol>
<li>Go to a specific case.</li>
<li>Click on TTPs at the top.</li>
<li>Click on Add.</li>
<li>Enter occur data.</li>
<li>Choose the tactic.</li>
<li>Choose a technique ID.</li>
</ol>
<p>You can add a <a id="_idIndexMarker438"/>new TTP and enter the relevant information, as shown in the following screenshot:</p>
<div><div><img alt="Figure 3.33 – Adding TTPs in TheHive" src="img/B19549_3_33.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.33 – Adding TTPs in TheHive</p>
<p>You will notice the following:</p>
<ul>
<li><strong class="bold">Catalogue</strong>: This represents the category of attack. In this case, we selected <strong class="bold">Enterprise Attack</strong>.</li>
<li><strong class="bold">Occur date</strong>: This indicates the date on which the attack happened.</li>
<li><strong class="bold">Technique</strong>: This represents the technique and its ID from the MITRE ATT&amp;CK matrix.</li>
<li><strong class="bold">Procedure</strong>: This <a id="_idIndexMarker439"/>requires you to manually enter the step-by-step instructions or sequences of actions that threat actors follow to execute a specific technique.</li>
</ul>
<p>This completes our overview of the use cases of threat intelligence and analysis using Wazuh, TheHive, Cortex, and the MISP server. To learn more about the administration, features, and<a id="_idIndexMarker440"/> integration, you<a id="_idIndexMarker441"/> can visit their official <a id="_idIndexMarker442"/>websites:</p>
<ul>
<li>TheHive: <a href="https://docs.strangebee.com/thehive/setup/">https://docs.strangebee.com/thehive/setup/</a></li>
<li>Cortex: <a href="https://docs.strangebee.com/cortex/">https://docs.strangebee.com/cortex/</a></li>
<li>MISP: <a href="https://www.misp-project.org/documentation/">https://www.misp-project.org/documentation/</a></li>
</ul>
<h1 id="_idParaDest-116"><a id="_idTextAnchor115"/>Summary</h1>
<p>This chapter on threat intelligence and analysis using MISP provided a comprehensive guide to understanding and implementing a practical threat intelligence and analysis system. We learned the critical role of MISP—when integrated with Wazuh and TheHive—in helping security analysts perform observable analyses and add TTPs. We also covered some important use cases of TheHive and Cortex for performing analyses of files, IP addresses, domains, etc. against the MISP threat intelligence database.</p>
<p>In the next chapter, we will learn how to enhance Wazuh’s capabilities using security automation tools such as Shuffle. We will learn the importance of security automation and the integration of Shuffle with Wazuh, and we will also go through some use cases as well.</p>
</div>
</body></html>