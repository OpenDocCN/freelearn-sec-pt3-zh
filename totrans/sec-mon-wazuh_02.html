<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-43"><a id="_idTextAnchor042"/>2</h1>
<h1 id="_idParaDest-44"><a id="_idTextAnchor043"/>Malware Detection Using Wazuh</h1>
<p><strong class="bold">Malware</strong> is short for <strong class="bold">malicious software</strong>, and it is installed on a computer without the user’s <a id="_idIndexMarker169"/>permission. Attackers can use malware to encrypt, steal <a id="_idIndexMarker170"/>computer data, or spy on system activity. <strong class="bold">Malware detection</strong> is a process of monitoring and analyzing computer systems and networks for the presence of malicious software and files. Security products detect malware by matching the signature of known malware samples and also by monitoring anomalous behavior. However, some malware can evade detection using multiple techniques once it enters the system. Wazuh utilizes a wide range of approaches to address and counter those techniques to detect malicious files and suspicious activities. In this chapter, we will learn about different Wazuh modules to detect malicious files and integrate some third-party tools to enhance its detection capabilities.</p>
<p>In this chapter, we’ll cover the following topics:</p>
<ul>
<li>Types of malware</li>
<li>Wazuh’s capabilities for malware detection</li>
<li>Malware <a id="_idIndexMarker171"/>detection using <strong class="bold">file integrity </strong><strong class="bold">monitoring</strong> (<strong class="bold">FIM</strong>)</li>
<li><strong class="bold">VirusTotal</strong> Integration</li>
<li>The CDB list</li>
<li>Integrating <a id="_idIndexMarker172"/>Windows Defender logs</li>
<li>Integrating <strong class="bold">System Monitor</strong> (<strong class="bold">Sysmon</strong>) to <a id="_idIndexMarker173"/>detect fileless malware</li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">In this chapter, we will utilize a real malware sample for testing; please make sure your system is running in isolation or in a controlled environment.</p>
<h1 id="_idParaDest-45"><a id="_idTextAnchor044"/>Types of malware</h1>
<p>Malware <a id="_idIndexMarker174"/>can take many forms, each with its own distinct capabilities and objectives. Some common types of malware include the following:</p>
<ul>
<li><strong class="bold">Viruses</strong>: Malware <a id="_idIndexMarker175"/>that attaches itself to <a id="_idIndexMarker176"/>legitimate files and programs and spreads by infecting other files. Viruses can cause damage by corrupting or destroying data. Examples include ILOVEYOU, Mydoom, and Anna Kournikova.</li>
<li><strong class="bold">Worms</strong>: Malware <a id="_idIndexMarker177"/>that copies itself and spreads <a id="_idIndexMarker178"/>through networks by taking advantage of security holes to infect other connected systems. Examples include Blaster, Mydoom, and Slammer.</li>
<li><strong class="bold">Trojans</strong>: Malicious software that looks like legitimate files or programs. Once installed, Trojans <a id="_idIndexMarker179"/>can let cybercriminals <a id="_idIndexMarker180"/>in without permission, which can lead to data theft, espionage, or more damage. Examples are Zeus (designed to steal financial information such as credit or debit cards), SpyEye (targets online banking information), and Poison Ivy (controls the victim machine remotely).</li>
<li><strong class="bold">Ransomware</strong>: Malware that encrypts the data of a victim, making it impossible <a id="_idIndexMarker181"/>to access until a ransom is <a id="_idIndexMarker182"/>paid to the attackers. Businesses and people can suffer a lot from ransomware attacks. Examples include Locky, WannaCry, and Ryuk.</li>
<li><strong class="bold">Spyware</strong>: Malware <a id="_idIndexMarker183"/>that is designed <a id="_idIndexMarker184"/>to covertly monitor and collect information from an infected system, including sensitive data, passwords, and browsing habits. Examples <a id="_idIndexMarker185"/>include CoolWebSearch (delivered through pop-up ads) and FinSpy (used by <a id="_idIndexMarker186"/>law enforcement agencies to capture screenshots and intercept communications).</li>
<li><strong class="bold">Rootkits</strong>: Malware <a id="_idIndexMarker187"/>that gets privileged <a id="_idIndexMarker188"/>access to a system without being noticed. This lets attackers hide their presence and keep control of the system that has been compromised. Examples include Sony BMG Rootkit, Alureon, and ZeroAccess.</li>
</ul>
<p>Malware is usually spread through different ways, such as phishing emails, malicious downloads, infected websites, and external devices such as USB drives that have been hacked. Cybercriminals are always changing their methods to avoid being caught and take advantage of new weaknesses. Now, let’s learn about some of the important Wazuh capabilities for malware detection.</p>
<h1 id="_idParaDest-46"><a id="_idTextAnchor045"/>Wazuh capabilities for malware detection</h1>
<p>Wazuh offers several capabilities that contribute to its effectiveness in detecting malware. This is <a id="_idIndexMarker189"/>accomplished through the use of a combination of log analysis, intrusion detection, and threat intelligence. It also provides real-time alerting, event correlation, and the ability to execute custom scripts for automated reaction activities, making it a powerful tool for effectively identifying and responding to malware attacks. The following are some of Wazuh’s methods for malware detection:</p>
<ul>
<li><strong class="bold">Threat detection rules and FIM</strong>: In this method, Wazuh utilizes its built-in capability <a id="_idIndexMarker190"/>to detect any critical file modification. Some of the capabilities are:<ul><li>Wazuh employs <a id="_idIndexMarker191"/>a set of predefined, continuously <a id="_idIndexMarker192"/>monitored threat detection principles. The purpose of these principles is to identify suspicious activities, events, and patterns that may indicate malware infections or security breaches.</li><li>Wazuh’s malware detection relies heavily on FIM. It monitors modifications to files and directories, such as additions and deletions. Wazuh generates an alert <a id="_idIndexMarker193"/>when an unauthorized or unanticipated change occurs, which may indicate malware activity.</li></ul></li>
<li><strong class="bold">Rootkit behavior detection</strong>: Wazuh uses the rootcheck function to detect anomalies <a id="_idIndexMarker194"/>that might indicate the presence of malware in an endpoint:<ul><li>Rootkits <a id="_idIndexMarker195"/>are a form of malware that can conceal their presence and other malicious actions on a compromised system. Wazuh identifies rootkit-like activities using behavior-based detection techniques.</li><li>Wazuh searches for suspicious system behavior, such as unauthorized privilege escalation, attempts to conceal files or processes, and other activities that are typically associated with rootkits. When such conduct is identified, an alert is triggered.</li></ul></li>
<li><strong class="bold">VirusTotal integration</strong>: Wazuh detects <a id="_idIndexMarker196"/>malicious files through integration with VirusTotal:<ul><li>VirusTotal is a <a id="_idIndexMarker197"/>web-based service that scans files and URLs for potential hazards using multiple antivirus engines and threat intelligence sources. Wazuh incorporates VirusTotal to improve its malware detection capabilities.</li><li>When Wazuh encounters a file or URL that it suspects to be malicious, it can automatically submit the sample for analysis by VirusTotal. The result includes findings from multiple antivirus engines, which are then integrated into Wazuh’s alerting mechanism. If the file is identified as malicious by multiple engines, the confidence in the alert is increased.</li></ul></li>
<li><strong class="bold">YARA integration</strong>: Wazuh detects <a id="_idIndexMarker198"/>malware samples using YARA, which is an open-source tool that identifies and classifies malware artifacts based on their binary patterns:<ul><li>YARA is a powerful tool that lets you write your own rules to find malware and certain patterns in files and processes. Wazuh works with YARA, so users can make their own rules for YARA to use to find malware that fits their needs.</li><li>Security <a id="_idIndexMarker199"/>professionals can use YARA integration to create custom signatures that detect specific malware strains or behaviors that are not covered by the normal Wazuh rules. These custom rules can be added to the Wazuh ruleset and used to monitor the environment.</li></ul></li>
</ul>
<p>Now that <a id="_idIndexMarker200"/>we understand some important malware detection capabilities of the Wazuh platform, we can start to learn about different use cases with Wazuh. In the next section, we will learn how to detect malware using the FIM module of Wazuh.</p>
<h1 id="_idParaDest-47"><a id="_idTextAnchor046"/>Malware detection using FIM</h1>
<p>When a <a id="_idIndexMarker201"/>system gets compromised by malware, it may create new files or modify existing files, such as the following file types:</p>
<ul>
<li>Executable files (<code>.exe</code>, <code>.dll</code>, <code>.bat</code>, and <code>.vbs</code>)</li>
<li>Configuration files (<code>.cfg</code> and <code>.ini</code>)</li>
<li>Temporary files (<code>.tmp</code>)</li>
<li>Registry entries</li>
<li>Log files (<code>.log</code>)</li>
<li>Payload files</li>
<li>Hidden files and directories</li>
<li>Batch scripts (<code>.bat</code>)</li>
<li>PowerShell (<code>.ps1</code>)</li>
<li>Specially crafted documents with a malicious payload (<code>.doc</code>, <code>.xls</code>, and <code>.pdf</code>)</li>
</ul>
<p>Using this information, we can create an FIM rule in Wazuh to detect any file changes. However, we will <a id="_idIndexMarker202"/>get a high number of false positive alerts, too. To solve this problem, we can focus on a specific directory or folder. We will learn more in this section.</p>
<p>In this section, we’ll learn how to create Wazuh rules to detect some of the common malware patterns.</p>
<p>We’ll cover the following use cases:</p>
<ul>
<li>Configuring and testing FIM on an Ubuntu machine</li>
<li>Detecting suspicious files on a <strong class="bold">PHP</strong> server using the FIM module</li>
</ul>
<h2 id="_idParaDest-48"><a id="_idTextAnchor047"/>Configuring and testing FIM on an Ubuntu machine</h2>
<p>FIM is <a id="_idIndexMarker203"/>a technology <a id="_idIndexMarker204"/>that monitors <a id="_idIndexMarker205"/>the integrity of system <a id="_idIndexMarker206"/>and application <a id="_idIndexMarker207"/>files. It safeguards sensitive data, application, and device files by routinely monitoring, scanning, and <a id="_idIndexMarker208"/>confirming their integrity. It works by detecting changes to mission-critical files in the network and as a result, it brings down the risk associated with data breaches.</p>
<p>The good <a id="_idIndexMarker209"/>news is that Wazuh has a built-in capability for FIM. This is possible because Wazuh uses an <strong class="bold">Open Source HIDS Security</strong> (<strong class="bold">OSSEC</strong>) agent. OSSEC is a free, open-source host-based intrusion detection system. When a user or process creates, modifies, or deletes a monitored file, the Wazuh FIM module initiates an alert. Let’s understand a file integrity check by setting up a FIM module on an Ubuntu machine. In order to test this use case, you need to follow these steps.</p>
<h3>Requirements</h3>
<p>To test <a id="_idIndexMarker210"/>the FIM use case, we would require the following:</p>
<ul>
<li>The Wazuh manager</li>
<li>An Ubuntu machine (with the Wazuh agent installed)</li>
</ul>
<h3>Step 1 – Setting up the Wazuh agent on an Ubuntu machine</h3>
<p>By default, the FIM module is enabled on the Wazuh agent. The configuration of the FIM module <a id="_idIndexMarker211"/>is present in the  <code>&lt;syscheck&gt;</code> tag under the <code>ossec.conf</code> file located at <code>/var/ossec/etc</code>. We only need to add directories (to be monitored) under the <code>&lt;syscheck&gt;</code> block. The following configuration will monitor specified files and directories for any types of changes or modifications:</p>
<pre class="source-code">
&lt;syscheck&gt;
  &lt;disabled&gt;no&lt;/disabled&gt;
  &lt;frequency&gt;720&lt;/frequency&gt;
  &lt;scan_on_start&gt;yes&lt;/scan_on_start&gt;
  &lt;directories check_all="yes" report_changes="yes" real_time="yes"&gt;/etc,/bin,/sbin&lt;/directories&gt;
  &lt;directories check_all="yes" report_changes="yes" real_time="yes"&gt;/lib,/lib64,/usr/lib,/usr/lib64&lt;/directories&gt;
  &lt;directories check_all="yes" report_changes="yes" real_time="yes"&gt;/var/www,/var/log,/var/named&lt;/directories&gt;
  &lt;ignore&gt;/etc/mtab&lt;/ignore&gt;
  &lt;ignore&gt;/etc/hosts.deny&lt;/ignore&gt;
  &lt;ignore&gt;/etc/mail/statistics&lt;/ignore&gt;
  &lt;ignore&gt;/etc/random-seed&lt;/ignore&gt;
  &lt;ignore&gt;/etc/adjtime&lt;/ignore&gt;
  &lt;ignore&gt;/etc/httpd/logs&lt;/ignore&gt;
  &lt;ignore&gt;/etc/utmpx&lt;/ignore&gt;
  &lt;ignore&gt;/etc/wtmpx&lt;/ignore&gt;
  &lt;ignore&gt;/etc/cups/certs&lt;/ignore&gt;
  &lt;ignore&gt;/etc/dumpdates&lt;/ignore&gt;
  &lt;ignore&gt;/etc/svc/volatile&lt;/ignore&gt;
  &lt;ignore&gt;/sys/kernel/security&lt;/ignore&gt;
  &lt;ignore&gt;/sys/kernel/debug&lt;/ignore&gt;
  &lt;ignore&gt;/sys&lt;/ignore&gt;
  &lt;ignore&gt;/dev&lt;/ignore&gt;
  &lt;ignore&gt;/tmp&lt;/ignore&gt;
  &lt;ignore&gt;/proc&lt;/ignore&gt;
  &lt;ignore&gt;/var/run&lt;/ignore&gt;
  &lt;ignore&gt;/var/lock&lt;/ignore&gt;
  &lt;ignore&gt;/var/run/utmp&lt;/ignore&gt;
&lt;/syscheck&gt;</pre> <p>Let’s <a id="_idIndexMarker212"/>break down the preceding configuration:</p>
<ul>
<li>The <code>&lt;disabled&gt;</code> tag is set to <code>no</code> to enable the syscheck module on Wazuh.</li>
<li>The <code>&lt;scan_on_start&gt;</code> tag is set to <code>yes</code> to conduct the initial scan when the Wazuh agent shows up.</li>
<li>The <code>&lt;frequency&gt;</code> tag is set to <code>720</code> to conduct a file monitoring scan every 720 minutes.</li>
<li>The <code>&lt;directories&gt;</code> tags talk about all the directories to monitor. In this example, we’re <a id="_idIndexMarker213"/>monitoring important system directories such as <code>/etc</code>, <code>/bin</code>, <code>/sbin</code>, <code>/lib</code>, <code>/lib64</code>, <code>/usr/lib</code>, <code>/usr/lib64</code>, <code>/var/www</code>, <code>/var/log</code>, and <code>/var/named</code>.</li>
<li>The <code>&lt;ignore&gt;</code> tags indicate files or directories to ignore during the monitoring process. These are common system files that are not generally important for FIM analysis.</li>
</ul>
<h3>Step 2 – Restart the Wazuh agent</h3>
<p>For <a id="_idIndexMarker214"/>the configuration changes to take effect, we need to restart the <code>wazuh-agent</code> service as shown in the following:</p>
<pre class="console">
sudo systemctl restart wazuh-agent</pre> <h3>Step 3 – Visualizing the alerts</h3>
<p>To visualize <a id="_idIndexMarker215"/>the alerts, you can navigate to <strong class="bold">Security Alerts</strong> or the <strong class="bold">Integrity Monitoring</strong> module in the Wazuh dashboard and check for the file-added alerts as shown in the following figure:</p>
<p class="IMG---Figure"> </p>
<div><div><img alt="Figure 2.1 – Visualizing the file-added alert on the Wazuh manager" src="img/B19549_2_01.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.1 – Visualizing the file-added alert on the Wazuh manager</p>
<p>Let’s break this down:</p>
<ul>
<li><code>decoder.name: syscheck_new_entry</code>: This field represents a new entry related to system checks or FIM that have been detected by the Wazuh agent. In this case, a file has been added.</li>
<li><code>full.log: File '/root/infectedfile.txt'added</code>: This represents that a new file called <code>infectedfile.txt</code> has been added.</li>
</ul>
<p>In this <a id="_idIndexMarker216"/>use case, we have learned to detect file changes in <code>/root</code> using the FIM module of Wazuh. In the next section, we will learn to detect possible malware in the PHP server.</p>
<h2 id="_idParaDest-49"><a id="_idTextAnchor048"/>Detecting suspicious files in the PHP server using the FIM module</h2>
<p>PHP <a id="_idIndexMarker217"/>is known for its simplicity, speed, and flexibility. Currently, there are more than <a id="_idIndexMarker218"/>33 million websites <a id="_idIndexMarker219"/>that use PHP. The most common PHP file extensions are <code>.php</code>, <code>.phtml</code>, <code>.php3</code>, <code>.php4</code>, <code>.php5</code>, <code>.php7</code>, and <code>.phps</code>.</p>
<p>These files are commonly found in the <code>/var/www/html/</code>,<code> /var/www/public_html/</code>, and root directory. In order to test possible malware using the FIM module in the PHP server, you need to follow these steps.</p>
<h3>Requirements</h3>
<p>To detect <a id="_idIndexMarker220"/>possible malicious files in the PHP server using Wazuh’s FIM module, you need the following system requirements:</p>
<ul>
<li>The Wazuh manager</li>
<li>An Ubuntu server, which should have the PHP server package and Wazuh agent installed</li>
</ul>
<h3>Creating a Wazuh rule</h3>
<p>We will create a Wazuh rule to detect file creation and modification on the PHP server. We will <a id="_idIndexMarker221"/>add different types of PHP file <a id="_idIndexMarker222"/>extensions under the <code>&lt;field&gt;</code> tag of the Wazuh rule. We will cover this use case along with testing and finally, we will visualize the alerts on the Wazuh manager:</p>
<h4>Create a Wazuh rule to detect PHP file creation/modification</h4>
<p>To create <a id="_idIndexMarker223"/>a Wazuh rule, go to <code>custom_fim.xml</code> and add the following rule:</p>
<pre class="source-code">
&lt;group name="linux, webshell, windows,"&gt;
  &lt;!-- This rule detects file creation. --&gt;
  &lt;rule id="100500" level="12"&gt;
    &lt;if_sid&gt;554,550&lt;/if_sid&gt;
    &lt;field name="file" type="pcre2"&gt;(?i).php$|.phtml$|.php3$|.php4$|.php5$|.phps$|.phar$|.asp$|.aspx$|.jsp$|.cshtml$|.vbhtml$&lt;/field&gt;
    &lt;description&gt;[File creation]: Possible web shell scripting file ($(file)) created&lt;/description&gt;
  &lt;/rule&gt;
&lt;/group&gt;</pre> <p>Let’s break this code down:</p>
<ul>
<li><code>&lt;if_sid&gt;554&lt;/if_sid&gt;</code>: This tag represents a list of rule IDs. This rule will match when a rule ID on the list has previously been matched. In this case, rule ID <code>100500</code> will match when rule ID <code>554</code> gets triggered. Rule ID <code>554</code> is fired when a file is added, and rule ID <code>550</code> represents the change in the integrity checksum.</li>
<li><code>&lt;field name="file" type="pcre2"&gt;(?i).php$|.phtml$|.php3$|.php4$|.php5$|.phps$|.phar$|.asp$|.aspx$|.jsp$|.cshtml$|.vbhtml$&lt;/field&gt;</code>: This is used as a requisite to trigger the rule. It will check for a match in the content of a file extracted by the decoder. In this case, the content is the list of all possible PHP file extensions.</li>
</ul>
<h4>Testing</h4>
<p> To test <a id="_idIndexMarker225"/>our FIM rule, we will add a new file called <code>antivirusupdate.php</code> in the root directory using the <code>touch</code> command as shown in the following figure.</p>
<div><div><img alt="Figure 2.2  – Creating  a blank file in the root directory" src="img/B19549_2_02.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.2  – Creating  a blank file in the root directory</p>
<h4>Visualizing the alerts</h4>
<p>To visualize <a id="_idIndexMarker226"/>the FIM alerts, navigate to the <strong class="bold">Security Alerts</strong> module of the Wazuh dashboard and you will find the alert as shown in the following figure.</p>
<div><div><img alt="Figure 2.3 – Visualizing possible web shell alerts on the Wazuh manager" src="img/B19549_2_03.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.3 – Visualizing possible web shell alerts on the Wazuh manager</p>
<p>Let’s <a id="_idIndexMarker227"/>break this down:</p>
<ul>
<li><code>full.log</code>: <code>File '/root/antivirusupdate.php' added Mode</code>: This represents the full logs on the Wazuh manager</li>
<li><code>rule.description</code>: This represents the triggered rule ID. In this case, the rule ID is 100500</li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">This FIM rule may lead to a lot of false positive alerts on the Wazuh dashboard. To overcome this situation, you can fine-tune your <code>&lt;syscheck&gt;</code> block by adding more <code>&lt;</code><code>ignore&gt;</code> tags.</p>
<p>In the next section, we will detect malicious files using the CDB list in the Wazuh manager.</p>
<h1 id="_idParaDest-50"><a id="_idTextAnchor049"/>The CDB list</h1>
<p>The CDB list in Wazuh serves as a repository for distinct hashes or checksums of malicious <a id="_idIndexMarker228"/>and benign files. The Wazuh security platform can precisely compare the files’ cryptographic representations on a system and those kept in the CDB. The CDB list consists of lists of users, file hashes, IP addresses, domain names, and so on. In this section, we will cover the following topics:</p>
<ul>
<li>The workings of the CDB list</li>
<li>Setting up the Wazuh server</li>
<li>Configuring Windows endpoints</li>
<li>Testing</li>
<li>Visualizing the alerts</li>
</ul>
<h2 id="_idParaDest-51"><a id="_idTextAnchor050"/>The workings of the CDB list</h2>
<p>You can save a list of users, file hashes, IP addresses, and domain names in a text file called a <a id="_idIndexMarker229"/>CDB list. A CDB list can have entries added in a <code>key:value</code> pair or a <code>key:only</code> format. Lists on CDBs can function as allow or deny lists. Wazuh processes the CDB list in the process mentioned here:</p>
<ol>
<li><strong class="bold">Hash generation</strong>: CDB lists consist of hashes of both good and bad content such as IP addresses, malware hashes, and domain names. A hash is a unique fixed-length value generated based on the CDB list content.</li>
<li><strong class="bold">File comparison</strong>: Wazuh computes file hashes during a system scan and compares them to the CDB entries.</li>
<li><strong class="bold">Identification</strong>: Wazuh marks a file as possibly malicious if its hash matches a known malicious hash in the CDB.</li>
<li><strong class="bold">Alerts and reactions</strong>: Based on the set policies, Wazuh has the ability to trigger alerts or responses upon detection.</li>
</ol>
<p>We’ve learned about how Wazuh processes the CDB list. Now, let’s go through the first practical use case of the CDB list wherein we will detect malicious IP addresses using the CDB list.</p>
<h2 id="_idParaDest-52"><a id="_idTextAnchor051"/>Setting up the Wazuh server</h2>
<p>We need to set up our Wazuh server with the CDB list of malware hashes and create the required <a id="_idIndexMarker230"/>rules to trigger alerts when a file with a hash matches CDB malware hashes. We need to follow these steps to accomplish that:</p>
<ol>
<li><code>/ossec/etc/lists</code> directory on the Wazuh server. To add a new CDB list for malware hashes, create a new file with the name <code>malware-hashes</code> using the following command:<pre class="source-code">
<code>key:value</code> pair where <code>key</code> will be the actual malware hash and <code>value</code> will be the name or keyword. Now, there are several sources from where we can download and use the malware hashes for the CDB list. One of the popular sources is a list published by Nextron Systems. You can view and download the list from the official GitHub page (<a href="https://github.com/Neo23x0/signature-base/blob/master/iocs/hash-iocs.txt">https://github.com/Neo23x0/signature-base/blob/master/iocs/hash-iocs.txt</a>). For testing purposes, we will use a few popular malware hashes such as Mirai and Fanny.<p class="list-inset">Open the file using the <code>Nano</code> editor:</p><pre class="source-code">
<strong class="bold">nano /var/ossec/etc/lists/malware-hashes</strong></pre><p class="list-inset">Then enter the malware hash in the format shown in the following:</p></li> </ol>
<div><div><img alt="Figure 2.4 – The CDB list of malware hashes" src="img/B19549_2_04.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.4 – The CDB list of malware hashes</p>
<p class="list-inset">In the preceding image, we have the hash of three types of malware: <code>mirai</code>, <code>Xbash</code>, and <code>fanny</code>.</p>
<ol>
<li value="3"><code>&lt;ruleset&gt;</code> block, you may add a reference to the CDB list in the <code>/var/ossec/etc/ossec.conf</code> Wazuh manager configuration file:<pre class="source-code">
&lt;ruleset&gt;
 &lt;!-- Default ruleset --&gt;
&lt;list&gt;etc/lists/malware-hashes&lt;/list&gt;
 &lt;ruleset&gt;</pre></li> <li><code>/var/ossec/etc/rules/local_rules.xml</code> file. When Wazuh finds a match between the MD5 hash of a recently created or updated file and a malware hash in the CDB list, this rule triggers. When an event occurs that indicates a newly created or modified file exists, rules <code>554</code> and <code>550</code> will be triggered:<pre class="source-code">
&lt;group name="malware,"&gt;
  &lt;rule id="110002" level="13"&gt;
    &lt;if_sid&gt;554, 550&lt;/if_sid&gt;
    &lt;list field="md5" lookup="match_key"&gt;etc/lists/malware-hashes&lt;/list&gt;
    &lt;description&gt;Known Malware File Hash is detected: $(file)&lt;/description&gt;
    &lt;mitre&gt;
      &lt;id&gt;T1204.002&lt;/id&gt;
    &lt;/mitre&gt;
  &lt;/rule&gt;
&lt;/group&gt;</pre></li> <li><strong class="bold">Restart the manager</strong>: We have to restart the Wazuh manager to apply the changes:<pre class="source-code">
<strong class="bold">systemctl restart wazuh-manager</strong></pre></li> </ol>
<p>We have <a id="_idIndexMarker232"/>successfully created a CDB list of malware hashes and security rules to compare it with the hash of each file in the Wazuh agent. In the next step, we will set up a Windows endpoint to detect any file changes so that it can trigger the CDB list to perform a comparison of file hashes.</p>
<h2 id="_idParaDest-53"><a id="_idTextAnchor052"/>Configuring the Windows endpoint</h2>
<p>We need <a id="_idIndexMarker233"/>to set up our Windows endpoint to detect file changes. We will configure <code>&lt;syscheck&gt;</code> to track file changes in the <code>Downloads</code> folder. You can choose any folder:</p>
<pre class="source-code">
&lt;ossec_config&gt;
 &lt;syscheck&gt;
&lt;disabled&gt;no&lt;/disabled&gt;
&lt;syscheck&gt; &lt;disabled&gt;no&lt;/disabled&gt;
&lt;directories check_all="yes" realtime="yes"&gt;/PATH/TO/MONITORED/DIRECTORY&lt;/directories&gt;
 &lt;/syscheck&gt;
&lt;/ossec_config&gt;</pre> <p>Let’s break this code down:</p>
<ul>
<li><code>check_all="yes"</code>: This ensures that Wazuh verifies every aspect of the file, such as its size, permissions, owner, last modification date, inode, and hash sums</li>
<li><code>realtime="yes</code>”: Wazuh will perform real-time monitoring and trigger alerts</li>
</ul>
<p>Next, restart the Wazuh agent using the following command:</p>
<pre class="console">
systemctl restart wazuh-agent</pre> <h2 id="_idParaDest-54"><a id="_idTextAnchor053"/>Testing</h2>
<p>Download <a id="_idIndexMarker234"/>the Mirai malware sample and put it in the area that the FIM module is monitoring to make sure everything is working right. In our case, it is a <code>Downloads</code> folder.</p>
<p class="callout-heading">Note</p>
<p class="callout">Be careful as these malicious files are harmful, so only use them for tests. Do not put them in places where they will be used.</p>
<p>Use the following PowerShell command to download the Mirai malware sample and store it in the <code>Downloads</code> folder:</p>
<pre class="console">
Invoke-WebRequest -Uri https://wazuh-demo.s3-us-west-1.amazonaws.com/mirai -OutFile C:/Users/Administrator/Downloads/mirai</pre> <h2 id="_idParaDest-55"><a id="_idTextAnchor054"/>Visualizing the alerts</h2>
<p>Wazuh immediately detects the malware sample. As you can see in the following figure, we have <a id="_idIndexMarker235"/>an alert with the <code>Known Malware File Hash is </code><code>detected</code> description:</p>
<div><div><img alt="Figure 2.5 – Know Malware File Hash is detected" src="img/B19549_2_05.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.5 – Know Malware File Hash is detected</p>
<p>If you expand the alert, you can see the full log, rule ID, and other information as shown in the following figure:</p>
<div><div><img alt="Figure 2.6 – Visualizing the Mirai malware alerts" src="img/B19549_2_06.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.6 – Visualizing the Mirai malware alerts</p>
<p>Let’s <a id="_idIndexMarker236"/>break this down:</p>
<ul>
<li><code>rule.description:</code> <code>Know Malware File Hash is detected</code>: This represents the description of rule ID 11002</li>
<li><code>full.log:</code> <code>File 'c:\users\administrator\downloads\mirai' modified</code>: This shows the full log information with the location, mode, attributes, and old/new modifications</li>
</ul>
<p>We have successfully tested the CDB list to detect known malware using file hashes stored in the form of <code>key:value</code> pairs within the CDB list. Moreover, there are some more use cases of the CDB list such as detecting unknown users and detecting blacklisted IP addresses. In the next section, we will learn to detect malware using the VirusTotal API.</p>
<h1 id="_idParaDest-56"><a id="_idTextAnchor055"/>VirusTotal integration</h1>
<p>VirusTotal is a free online service that analyzes files and URLs to detect malware and other malicious content. It uses over 70 types of antivirus software and URL blocklisting engineers to <a id="_idIndexMarker237"/>provide detailed information about the submitted file, URL, or IP address. VirusTotal allows users to contribute their own findings and submit comments on files and URLs. These contributions can help improve the service’s accuracy and provide valuable insights to other users. VirusTotal provides an API with multiple paid plans. However, it also has a free plan where you can request four lookups per minute with a daily quote of 500 lookups.</p>
<p>In this use case of malware detection, we will use a FIM module to monitor the changes and then trigger VirusTotal to scan the files in that directory. We will cover the following points:</p>
<ul>
<li>Set up a VirusTotal account</li>
<li>Integrate VirusTotal with the Wazuh manager</li>
<li>Create a Wazuh rule on the Wazuh manager</li>
<li>Set up a FIM check on Ubuntu Server</li>
<li>Testing malware detection</li>
</ul>
<h2 id="_idParaDest-57"><a id="_idTextAnchor056"/>Set up VirusTotal account</h2>
<p>In order <a id="_idIndexMarker238"/>to set up the VirusTotal account, simply visit <a href="http://VirusTotal.com">VirusTotal.com</a> and sign up. After signing up, go to your profile and click <strong class="bold">API key</strong>. Copy the API key safely as shown in the following figure:</p>
<div><div><img alt="Figure 2.7 – Retrieving the VirusTotal API key" src="img/B19549_2_07.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.7 – Retrieving the VirusTotal API key</p>
<h2 id="_idParaDest-58"><a id="_idTextAnchor057"/>Integrate VirusTotal with the Wazuh manager</h2>
<p>Wazuh has <a id="_idIndexMarker239"/>prebuilt VirusTotal integration scripts located in <code>/var/ossec/integrations</code>. Now, all you have to do is to call this VirusTotal script in <code>/var/ossec/etc/ossec.conf</code> file, and to do that, add a <code>&lt;integration&gt;</code> tag as shown in the following:</p>
<pre class="source-code">
&lt;ossec_config&gt;
  &lt;integration&gt;
    &lt;name&gt;virustotal&lt;/name&gt;
    &lt;api_key&gt;&lt;YOUR_VIRUS_TOTAL_API_KEY&gt;&lt;/api_key&gt; &lt;!-- Replace with your VirusTotal API key --&gt;
    &lt;rule_id&gt;100200,100201&lt;/rule_id&gt;
    &lt;alert_format&gt;json&lt;/alert_format&gt;
  &lt;/integration&gt;
&lt;/ossec_config&gt;</pre> <p>Let’s break this code down:</p>
<ul>
<li><code>&lt;api_key&gt;</code>: This represents the VirusTotal API key. You need to replace the <code>YOUR_VIRUS_TOTAL_API_KEY</code> text with your API key.</li>
<li><code>&lt;rule_id&gt;100200,100201&lt;/rule_id&gt;</code>: This represents the rule that triggers the VirusTotal inspection. In this case, we have rule ID 100200 and <code>100201</code>. We haven’t created these rules yet; we will write these rules to detect file <a id="_idIndexMarker240"/>changes in a specific folder of the endpoint. This will be covered in the next step.</li>
</ul>
<h2 id="_idParaDest-59"><a id="_idTextAnchor058"/>Create a Wazuh rule on the Wazuh manager</h2>
<p>Now, we <a id="_idIndexMarker241"/>want to trigger VirusTotal scanning only when any file is changed, added, or deleted to avoid tons of false positive alerts. We will create an FIM rule with an ID of <code>100200</code> and <code>100201</code> in the <code>local_rule.xml</code> file located at <code>/var/ossec/etc/rules</code> in the Wazuh manager. The Wazuh rules can be written as shown in the following:</p>
<pre class="source-code">
&lt;group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,"&gt;
    &lt;!-- Rules for Linux systems --&gt;
    &lt;rule id="100200" level="7"&gt;
        &lt;if_sid&gt;550&lt;/if_sid&gt;
        &lt;field name="file"&gt;/root&lt;/field&gt;
        &lt;description&gt;File modified in /root directory.&lt;/description&gt;
    &lt;/rule&gt;
    &lt;rule id="100201" level="7"&gt;
        &lt;if_sid&gt;554&lt;/if_sid&gt;
        &lt;field name="file"&gt;/root&lt;/field&gt;
        &lt;description&gt;File added to /root directory.&lt;/description&gt;
    &lt;/rule&gt;
&lt;/group&gt;</pre> <p>Let’s break this down:</p>
<ul>
<li><code>&lt;if_sid&gt;550&lt;/if_sid&gt;</code>: This specifies a condition that triggers this rule. It’s triggered when the event ID (SID) <code>550</code> occurs. The Wazuh rule <code>550</code> indicates that <a id="_idIndexMarker242"/>the integrity checksum changed.</li>
<li><code>&lt;if_sid&gt;554&lt;/if_sid&gt;</code>: This rule triggers when the event ID <code>554</code> occurs. The Wazuh rule indicates that a file has been added to the system.</li>
</ul>
<h2 id="_idParaDest-60"><a id="_idTextAnchor059"/>Set up an FIM check on Ubuntu Server</h2>
<p>We want <a id="_idIndexMarker243"/>the Wazuh agent to first detect any file changes in the <code>/root</code> directory and this will trigger the Wazuh rule ID <code>100200</code> and <code>100201</code>. To enable syscheck to detect any file changes in the <code>/root</code> directory, we need to make the following changes:</p>
<ol>
<li><code>&lt;syscheck&gt;</code> block in the <code>/var/ossec/etc/ossec.conf</code> Wazuh agent configuration file. Make sure that <code>&lt;disabled&gt;</code> is set to <code>no</code>. This enables the Wazuh FIM to monitor directory changes.</li>
<li><code>/root</code> directory to enable an FIM check of <code>&lt;directories check_all="yes" </code><code>report_changes="yes" realtime="yes"&gt;/root&lt;/directories&gt;</code>.</li>
<li><code>ossec.conf</code> file, we need to restart the Wazuh agent with the following command:<pre class="source-code">
<strong class="bold">sudo systemctl restart wazuh-agent</strong></pre></li> </ol>
<p>This completes the Wazuh agent restart process. In the next step, we will test VirusTotal using a sample malware file.</p>
<h2 id="_idParaDest-61"><a id="_idTextAnchor060"/>Testing malware detection</h2>
<p>To test <a id="_idIndexMarker244"/>malware detection using VirusTotal, we will <a id="_idIndexMarker245"/>use the <strong class="bold">European Institute for Computer Antivirus Research</strong> (<strong class="bold">EICAR</strong>) test file. An EICAR test file is used to test the response of antivirus software and it is built by <a id="_idIndexMarker246"/>the European Institute for Computer Antivirus Research (hence, EICAR) and the <strong class="bold">Computer Antivirus Research Organization</strong> (<strong class="bold">CARO</strong>). You can download the test file from their official website: <a href="https://www.eicar.org/download-anti-malware-testfile/">https://www.eicar.org/download-anti-malware-testfile/</a>.</p>
<p class="callout-heading">Note</p>
<p class="callout">If you are testing this for a Windows machine, you need to disable the <strong class="bold">Enhanced security</strong> option on Google Chrome and <strong class="bold">Real-time protection</strong> on Windows Defender to allow the download.</p>
<p>Once the EICAR file is downloaded, move it to the root directory.</p>
<h2 id="_idParaDest-62"><a id="_idTextAnchor061"/>Visualizing the alerts</h2>
<p>To view <a id="_idIndexMarker247"/>the alerts, navigate to the <strong class="bold">Security Alerts</strong> module of the Wazuh dashboard and you should find the alerts as shown in the following figure.</p>
<div><div><img alt="Figure 2.8 – Visualizing the VirusTotal alert on the Wazuh dashboard" src="img/B19549_2_08.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.8 – Visualizing the VirusTotal alert on the Wazuh dashboard</p>
<p>Let’s <a id="_idIndexMarker248"/>break this down:</p>
<ul>
<li><code>data.integration:</code> <code>virustotal</code>: This represents the third-party integration used in Wazuh. In this case, it is VirusTotal.</li>
<li><code>data.virustotal.permalink</code>: This represents the URL of the VirusTotal detection page.</li>
</ul>
<p>We have successfully detected an EICAR file using VirusTotal and Wazuh. In the next section, we will learn how to integrate Windows Defender (an antivirus solution) with the Wazuh platform.</p>
<h1 id="_idParaDest-63"><a id="_idTextAnchor062"/>Integrating Windows Defender logs</h1>
<p>Windows <a id="_idIndexMarker249"/>Defender is an antivirus software module of Microsoft Windows. As per the <em class="italic">2023 Antivirus Market Report</em>, Windows Defender is the most common free antivirus product for PC users, with around 40% of the market share of free antivirus software. For more information on this, you can check the following link: <a href="https://www.security.org/antivirus/antivirus-consumer-report-annual/">https://www.security.org/antivirus/antivirus-consumer-report-annual/</a>. Additionally, Microsoft also offers endpoint security solutions for enterprises called Windows Defender for Endpoint. This makes us put more attention on integrating Windows Defender with Wazuh. By default, Wazuh cannot read the Windows Defender logs. Hence, it is important for us to put extra effort into making it possible.</p>
<p>In this <a id="_idIndexMarker250"/>section, we’ll learn to push Windows Defender logs to the Wazuh manager. You will learn about the following:</p>
<ul>
<li>How to get started with Windows Defender logs</li>
<li>Setting up the Wazuh agent to collect Windows Defender logs</li>
<li>Testing for malware detection</li>
<li>Visualizing the alerts</li>
</ul>
<h2 id="_idParaDest-64"><a id="_idTextAnchor063"/>Getting started with Windows Defender logs</h2>
<p>Windows Defender logs help SOC analysts understand the security status of endpoints, identify <a id="_idIndexMarker251"/>potential cyber threats, and also help them investigate any security incidents. Windows Defender logs encompass several pieces of information such as scan activities, threat detection, updates, quarantine, remediation, firewall and network activities, and real-time protection.</p>
<p>Let’s first understand where the Defender logs are stored. Well, You can view the logs in <strong class="bold">Event Viewer</strong>.</p>
<p>Go to <strong class="bold">Event Viewer</strong> | <strong class="bold">Applications and Services Logs</strong> | <strong class="bold">Microsoft</strong> | <strong class="bold">Windows</strong> | <strong class="bold">Windows Defender</strong> | <strong class="bold">Operational</strong>.</p>
<p>The general tab will give you information about the scan type and user information. However, the <strong class="bold">Details</strong> tab will give you complete information on that threat detection.</p>
<p class="IMG---Figure"> </p>
<div><div><img alt="Figure 2.9 – Visualizing Windows Event Viewer" src="img/B19549_2_09.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.9 – Visualizing Windows Event Viewer</p>
<p>To get <a id="_idIndexMarker252"/>more detailed information about this event, you can navigate to the <strong class="bold">Details</strong> tab shown in the following figure:</p>
<div><div><img alt="Figure 2.10 – Details of the Windows Defender event" src="img/B19549_2_10.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.10 – Details of the Windows Defender event</p>
<h2 id="_idParaDest-65"><a id="_idTextAnchor064"/>Setting up the Wazuh agent to collect Windows Defender logs</h2>
<p>We need to push the Defender logs in the <code>ossec.conf</code> file of the Wazuh agent. To collect <a id="_idIndexMarker253"/>Windows Defender logs, you must configure the Wazuh agent using the Wazuh manager or locally using the <code>ossec.conf</code> agent file located at <code>C:\Program </code><code>Files (x86)\ossec-agent</code>.</p>
<p>In a large network, manually going to each Wazuh agent and making the changes in each agent is a cumbersome task. Wazuh helps us with the <code>agent.conf</code> file, which pushes the configuration to specific agent groups.</p>
<p>Login to the Wazuh dashboard, go to <code>&lt;localfile&gt;</code> tag in the <code>agent.conf</code> file as shown in the following:</p>
<pre class="source-code">
&lt;localfile&gt;
&lt;location&gt; Microsoft-Windows-Windows Defender/Operational&lt;/location&gt; &lt;log_format&gt;eventchannel&lt;/log_format&gt;
&lt;/localfile&gt;</pre> <p>Let’s <a id="_idIndexMarker254"/>break this down:</p>
<ul>
<li><code>&lt;localfile&gt;</code>: This tag is used to define the local log file or file path that the Wazuh agent should monitor.</li>
<li><code>&lt;location&gt; Microsoft-Windows-Windows Defender/Operational&lt;/location&gt;</code>: This represents the location or path of the log file that Wazuh should monitor. In this case, it is monitoring the <code>Microsoft-Windows-Windows Defender/Operational</code> log location.</li>
<li><code>&lt;log_format&gt;</code>: This tag specifies the format.</li>
</ul>
<p>Now, for these changes to take effect, you need to restart the Wazuh agent using the following command:</p>
<pre class="console">
sudo systemctl restart wazuh-agent</pre> <p class="callout-heading">Note:</p>
<p class="callout">To verify the location of Windows Defender events, you can also navigate to the <code>Microsoft-Windows-Windows Defender/Operational</code> location under <strong class="bold">Event Viewer</strong> and check for the log name as shown in the following figure.</p>
<div><div><img alt="Figure 2.11 – Checking Log Name for Windows Defender events" src="img/B19549_2_11.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.11 – Checking Log Name for Windows Defender events</p>
<h2 id="_idParaDest-66"><a id="_idTextAnchor065"/>Testing for malware detection</h2>
<p>To test <a id="_idIndexMarker255"/>the malware detection using VirusTotal, we will use an EICAR test file. You can download the EICAR test file from their official website: <a href="https://www.eicar.org/download-anti-malware-testfile/">https://www.eicar.org/download-anti-malware-testfile/</a>.</p>
<p class="callout-heading">Note</p>
<p class="callout">You need to disable the <strong class="bold">Enhanced security</strong> option on Google Chrome and <strong class="bold">Real-time protection</strong> on Windows Defender to allow the download.</p>
<h2 id="_idParaDest-67"><a id="_idTextAnchor066"/>Visualizing the alerts</h2>
<p>To visualize <a id="_idIndexMarker256"/>the alerts related to the EICAR test file, you can navigate to <strong class="bold">Security Alerts</strong> in the Wazuh manager and check for the Windows Defender alerts as shown in the following figure:</p>
<div><div><img alt="Figure 2.12 – Visualizing Windows Defender alerts in the Wazuh manager" src="img/B19549_2_12.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.12 – Visualizing Windows Defender alerts in the Wazuh manager</p>
<p>Let’s break this down:</p>
<ul>
<li><code>data.win.eventdata.product Name:</code> <code>Microsoft Defender Antivirus</code>:  This represents the name of the product that generated the alert. In this case, it is Microsoft Defender Antivirus.</li>
<li><code>data.win.system.channel:</code> <code>Microsoft-Windows-Windows Defender/Operational</code>: This indicates the channel or source from where the alert originated. In this case, it is the <code>Microsoft-Windows-Windows </code><code>Defender/Operational</code> channel.</li>
<li><code>rule.description:</code> <code>Windows Defender: Antimalware platform detected  potentially unwanted software ()</code>: This provides the description of the triggered rule.</li>
<li><code>rule.groups:</code> <code>windows, windows_defender</code>: This field specifies the groups or categories to which the rule or alert belongs. In this case, we have <code>Windows</code> and <code>Windows_defender</code> indicating that it’s a Windows-specific alert related to Windows Defender.</li>
</ul>
<p>We have <a id="_idIndexMarker257"/>successfully collected and visualized the alerts from the Windows Defender solution. In the next section, we will learn to install and integrate Sysmon modules on a Windows machine to enhance the detection capabilities of the Wazuh platform.</p>
<h1 id="_idParaDest-68"><a id="_idTextAnchor067"/>Integrating Sysmon to detect fileless malware</h1>
<p>Malicious code that operates directly within a computer’s memory rather than the hard drive <a id="_idIndexMarker258"/>is known as fileless malware. It is “fileless” in the <a id="_idIndexMarker259"/>sense that no files are downloaded to your hard drive when your machine is infected. This makes it more difficult to detect using traditional antivirus or anti-malware tools, which primarily scan disk files.</p>
<p><strong class="bold">Sysmon</strong> is a device <a id="_idIndexMarker260"/>driver and Windows system service that provides advanced monitoring and logging capabilities. It was created by Microsoft’s Sysinternals team to <a id="_idIndexMarker261"/>monitor various aspects of system activity, such as processes, network connections, and file changes. While Sysmon does not specifically focus on detecting fileless malware, its comprehensive monitoring capabilities can undoubtedly assist in identifying and mitigating the impact of fileless malware attacks. We can enhance Wazuh’s malware detection capabilities by installing Sysmon on each Windows machine. To test the fileless attack detection, we will use the APTSimulator tool to simulate the attack and visualize them on the Wazuh manager.</p>
<p>In this section, we will learn how to detect fileless malware using Sysmon and finally, we will visualize them on the Wazuh dashboard. We will cover the following items in this section:</p>
<ul>
<li>How do fileless attacks work?</li>
<li>Requirements for lab setup</li>
<li>Setting up Sysmon on a Windows machine</li>
<li>Configure the Wazuh agent to monitor Sysmon events</li>
<li>Creating Sysmon rules on the Wazuh manager</li>
<li>Testing malware detection</li>
<li>Visualizing the alerts</li>
</ul>
<h2 id="_idParaDest-69"><a id="_idTextAnchor068"/>How do fileless malware attacks work?</h2>
<p>In its operation, a fileless malware attack is fairly unique. Understanding how it works can help <a id="_idIndexMarker262"/>an organization protect against future fileless malware attacks. Let’s learn about the different stages involved in the fileless malware attack. Each attack stage will be explained, and the techniques and tools used by the attackers will be explained in the following subsections.</p>
<h3>Stage 1 – Gain access</h3>
<p>Threat actors <a id="_idIndexMarker263"/>must first gain access to the target machine in order to carry out an attack. Some of the common techniques and tools involved in this stage are mentioned here:</p>
<ul>
<li><strong class="bold">Techniques</strong>: Remotely exploit a vulnerability and gain remote access via web scripting or a social engineering scheme such as phishing emails</li>
<li><strong class="bold">Tools</strong>: ProLock and Bumblebee</li>
</ul>
<h3>Stage 2 – Steal credentials</h3>
<p>Using the access gained in the previous step, the attacker now attempts to obtain credentials <a id="_idIndexMarker264"/>for the environment he has compromised, which will allow him to easily move to other systems in that environment. Some of the techniques and tools that he could have used are as follows:</p>
<ul>
<li><strong class="bold">Techniques</strong>: Remotely exploit a vulnerability and gain remote access via web scripting (e.g., Mimikatz)</li>
<li><strong class="bold">Tools</strong>: Mimikatz and Kessel</li>
</ul>
<h3>Stage 3 – Maintain persistence</h3>
<p>Now, the attacker creates a backdoor that will allow him to return to this environment at any <a id="_idIndexMarker265"/>time without having to repeat the initial steps of the attack. Some of the techniques and tools are as follows:</p>
<ul>
<li><strong class="bold">Techniques</strong>: Modify the registry to create a backdoor</li>
<li><strong class="bold">Tools</strong>: Sticky Keys Bypass, Chinoxy, HALFBAKED, HiKit, and ShimRat</li>
</ul>
<h3>Stage 4 – Exfiltrate data</h3>
<p>In the final step, the attacker collects the data he desires and prepares it for exfiltration by copying <a id="_idIndexMarker266"/>it to a single location and then compressing it with commonly available system tools such as Compact. The attacker then uploads the data via FTP to remove it from the victim’s environment. Some of the techniques and tools are as follows:</p>
<ul>
<li><strong class="bold">Techniques</strong>: Using DNS tunneling, traffic normalization, use of an encrypted channel, and so on</li>
<li><strong class="bold">Tools</strong>: FTP, SoreFang, and SPACESHIP</li>
</ul>
<h2 id="_idParaDest-70"><a id="_idTextAnchor069"/>Requirement for the lab</h2>
<p>To test <a id="_idIndexMarker267"/>the fileless malware detection, we need the following system:</p>
<ul>
<li>The Wazuh server</li>
<li>Windows 10 or 11 or Windows Server 2016 or 2019, which should have the Wazuh agent installed</li>
</ul>
<h2 id="_idParaDest-71"><a id="_idTextAnchor070"/>Setting up Sysmon on a Windows machine</h2>
<p>In this <a id="_idIndexMarker268"/>step, we’ll set up our Windows 11 endpoint with the Sysmon package.</p>
<p>Sysmon offers comprehensive data about process creation, network connections, and file creation time changes. Sysmon generates events and stores them in <code>Applications</code> and <code>Services Logs/Microsoft/Windows/Sysmon/Operational</code>. To install Sysmon on a Windows <a id="_idIndexMarker269"/>machine, you need to follow the steps as explained in the following sections.</p>
<h3>Step 1 – Download and extract Sysmon</h3>
<p>To download <a id="_idIndexMarker270"/>Sysmon on your Windows machine, visit its official <a id="_idIndexMarker271"/>website: <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon</a>. Once downloaded, extract the Sysmon archive to a folder of your choice on your Windows machine.</p>
<h3>Step 2 – Download the SwiftOnSecurity Sysmon configuration</h3>
<p>SwiftOnSecurity’s Sysmon configuration is a well-known and simple configuration file created by <a id="_idIndexMarker272"/>popular security professionals. Using this configuration can enhance our Windows monitoring capabilities. To download the SwiftOnSecurity Sysmon configuration file, visit their official GitHub repository (<a href="https://github.com/SwiftOnSecurity/sysmon-config">https://github.com/SwiftOnSecurity/sysmon-config</a>) and download the latest version of the configuration file called <code>SysmonConfig.xml</code>.</p>
<p class="callout-heading">Note</p>
<p class="callout">Make sure you place the <code>SysmonConfig.xml</code> file in the same folder where you extracted Sysmon.</p>
<h3>Step 3 – Install Sysmon with the SwiftOnSecurity configuration</h3>
<p>To <a id="_idIndexMarker273"/>install Sysmon using the SwiftOnSecurity configuration file called <code>SysmonConfig.xml</code>, you need to follow some steps as explained here:</p>
<ol>
<li>Open a command prompt or PowerShell with administrative privileges.</li>
<li>Navigate to the folder where Sysmon is extracted.</li>
<li>Now, run the following command to install Sysmon with the SwiftOnSecurity configuration:<pre class="source-code">
<code>-accepteula</code>: It represents the <strong class="bold">end user license agreement</strong> (<strong class="bold">EULA</strong>) for <a id="_idIndexMarker275"/>Sysmon. By including this flag, you are acknowledging and agreeing to the terms of use.</li></ul></li> </ol>
<h3>Verify installation</h3>
<p>After the <a id="_idIndexMarker276"/>installation, you can verify that Sysmon is running properly by checking <code>Applications and Services Logs/Microsoft/Windows/Sysmon/Operational</code>, and you should start getting Sysmon-related events as shown in the following figure:</p>
<div><div><img alt="Figure 2.13 – Visualizing Sysmon events in Event Viewer" src="img/B19549_2_13.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.13 – Visualizing Sysmon events in Event Viewer</p>
<p>Let’s <a id="_idIndexMarker277"/>break this down:</p>
<ul>
<li><strong class="bold">Level</strong>: This refers to the severity of an event. The levels are usually categorized as follows:<ul><li><strong class="bold">0</strong>: Information</li><li><strong class="bold">1</strong>: Warning</li><li><strong class="bold">2</strong>: Error</li><li><strong class="bold">3</strong>: Critical</li></ul></li>
<li><strong class="bold">Source</strong>: This field indicates the software or component that generated the event. In this case, it is Sysmon.</li>
<li><strong class="bold">Event ID</strong>: It is a unique value assigned to each type of event. Sysmon uses different event IDs for various purposes:<ul><li><strong class="bold">Event ID 1</strong>: Process creation</li><li><strong class="bold">Event ID 2</strong>: File creation</li><li><strong class="bold">Event ID 3</strong>: Network connection</li><li><strong class="bold">Event ID 7</strong>: Image loaded</li><li><strong class="bold">Event ID 10</strong>: Process access</li><li><strong class="bold">Event ID 11</strong>: File creation</li><li><strong class="bold">Event ID 12</strong>: Registry event (object create and delete)</li><li><strong class="bold">Event ID 13</strong>: Registry event (value set)</li><li><strong class="bold">Event ID 14</strong>: Registry event (key and value rename)</li><li><strong class="bold">Event ID 15</strong>: File creation stream hash</li><li><strong class="bold">Event ID 17</strong>: Pipe event (pipe created)</li><li><strong class="bold">Event ID 18</strong>: Pipe event (pipe connected)</li><li><strong class="bold">Event ID 22</strong>: DNS request</li></ul></li>
<li><strong class="bold">Task Category</strong>: This provdes <a id="_idIndexMarker278"/>the classification for the events. It is the name of the event IDs as listed earlier.</li>
</ul>
<h2 id="_idParaDest-72"><a id="_idTextAnchor071"/>Configure the Wazuh agent to monitor Sysmon events</h2>
<p>Assuming <a id="_idIndexMarker279"/>the Wazuh agent <a id="_idIndexMarker280"/>is already installed and running, you need to inform the agent to monitor Sysmon events. To do that, we need to include the following block in the <code>ossec.conf</code> file:</p>
<pre class="source-code">
&lt;localfile&gt;
&lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;
&lt;log_format&gt;eventchannel&lt;/log_format&gt;
&lt;/localfile&gt;</pre> <p>To ensure our changes take effect, we need to restart the agent.</p>
<h2 id="_idParaDest-73"><a id="_idTextAnchor072"/>Configure the Wazuh manager</h2>
<p>We are required to create a custom rule in the Wazuh manager to match the Sysmon events <a id="_idIndexMarker281"/>generated by the Windows machine. This rule will ensure that the Wazuh manager triggers an alert every time it gets a Sysmon-related event.</p>
<p>To create a rule, go to the Wazuh dashboard and navigate to <code>custom_sysmon.xml</code>), and paste the following rules:</p>
<pre class="source-code">
&lt;!-- Log Sysmon Alerts --&gt;
&lt;group name="sysmon"&gt;
&lt;rule id="101100" level="5"&gt;
&lt;if_sid&gt;61650&lt;/if_sid&gt;
&lt;description&gt;Sysmon - Event 22: DNS Query.&lt;/description&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;/rule&gt;
&lt;rule id="101101" level="5"&gt;
&lt;if_sid&gt;61603&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 1: Process creation.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101102" level="5"&gt;
&lt;if_sid&gt;61604&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 2: A process changed a file creation time.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101103" level="5"&gt;
&lt;if_sid&gt;61605&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 3: Network connection.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101104" level="5"&gt;
&lt;if_sid&gt;61606&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 4: Sysmon service state changed.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101105" level="5"&gt;
&lt;if_sid&gt;61607&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 5: Process terminated.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101106" level="5"&gt;
&lt;if_sid&gt;61608&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 6: Driver loaded.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101107" level="5"&gt;
&lt;if_sid&gt;61609&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 7: Image loaded.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101108" level="5"&gt;
&lt;if_sid&gt;61610&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 8: CreateRemoteThread.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101109" level="5"&gt;
&lt;if_sid&gt;61611&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 9: RawAccessRead.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101110" level="5"&gt;
&lt;if_sid&gt;61612&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 10: ProcessAccess.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101111" level="5"&gt;
&lt;if_sid&gt;61613&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 11: FileCreate.&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101112" level="5"&gt;
&lt;if_sid&gt;61614&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 12: RegistryEvent (Object create and delete).&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101113" level="5"&gt;
&lt;if_sid&gt;61615&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 13: RegistryEvent (Value Set).&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101114" level="5"&gt;
&lt;if_sid&gt;61616&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 14: RegistryEvent (Key and Value Rename).&lt;/description&gt;
&lt;/rule&gt;
&lt;rule id="101115" level="5"&gt;
&lt;if_sid&gt;61617&lt;/if_sid&gt;
      &lt;options&gt;no_full_log&lt;/options&gt;
&lt;description&gt;Sysmon - Event 15: FileCreateStreamHash.&lt;/description&gt;
&lt;/rule&gt;
&lt;/group&gt;</pre> <p>Let’s <a id="_idIndexMarker282"/>break this down:</p>
<ul>
<li><code>&lt;group&gt;</code>: This tag is used to organize rules and helps in managing and categorizing rules based on their functionality.</li>
<li><code>&lt;rule&gt;</code>: This defines the individual rule with the <code>id</code> and <code>level</code> attributes. In the preceding ruleset, the rule ID ranges from 101100 to 101107 with <code>level=5</code>.</li>
<li><code>&lt;if_sid&gt;</code>: This tag <a id="_idIndexMarker283"/>is used as a requisite to trigger any rule when a rule ID has previously matched. Let’s look at a couple of the following rules:<ul><li><code>Rule ID "101100"</code> with <code>if_sid "61650"</code> will be checked when the requisites of rule ID 61650 are satisfied</li><li><code>Rule ID "101101"</code> with <code>if_sid "61603"</code> will be checked when the requisites of rule ID 61603 are satisfied</li><li><code>Rule ID "101102"</code> with <code>if_sid "61604"</code> will be checked when the requisites of rule ID 61604 are satisfied</li><li><code>Rule ID "101103"</code> with <code>if_sid "61605"</code> will be checked when the requisites of rule ID 61605 are satisfied</li><li><code>Rule ID "101104"</code> with <code>IF_SID "61606"</code> will be checked when the requisites of rule ID 61606 are satisfied</li><li><code>Rule ID "101105"</code> with <code>IF_SID "61607"</code> will be checked when the requisites of rule ID 61607 are satisfied</li><li><code>Rule ID "101106"</code> with <code>IF_SID "61608"</code> will be checked when the requisites of rule ID 61608 are satisfied</li><li><code>Rule ID "101107"</code> with <code>IF_SID "61609"</code> will be checked when the requisites of rule ID 61609 are satisfied</li></ul></li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">You can review the details of each of the mentioned <code>IF_SID</code> under the Wazuh rule file called <code>0595-win-sysmon_rules.xml</code>. You can find this file under the <strong class="bold">Rules</strong> section of the Wazuh dashboard or in the Wazuh’s official GitHub repository located at <a href="https://github.com/wazuh/wazuh-ruleset/tree/master/rules">https://github.com/wazuh/wazuh-ruleset/tree/master/rules</a>.</p>
<p>For changes <a id="_idIndexMarker284"/>to take effect, you have to restart the Wazuh manager on the dashboard as shown in the following figure:</p>
<div><div><img alt="Figure 2.14 – Restarting the Wazuh manager" src="img/B19549_2_14.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.14 – Restarting the Wazuh manager</p>
<p>To restart the Wazuh manager using the command line, you can enter the following command:</p>
<pre class="console">
systemctl restart wazuh-manager</pre> <p>In the next step, we will test our Wazuh rules by initiating attacks simulated by the APTSimulator tool and will visualize the alerts on the Wazuh dashboard.</p>
<h2 id="_idParaDest-74"><a id="_idTextAnchor073"/>Testing</h2>
<p>To test a <a id="_idIndexMarker285"/>fileless malware scenario, we will use the APTSimulator tool developed by Florian Roth. It is a Windows batch script that employs several tools and output files to make a system appear to be compromised. To execute this APTSimulator script, download the file on a Windows machine and execute the <code>.</code><code>bat</code> file.</p>
<p>Here is the link to download: <a href="https://github.com/NextronSystems/APTSimulator">https://github.com/NextronSystems/APTSimulator</a>.</p>
<p>Once you download this script on your Windows Server, open the command prompt, go to the <code>APTSimulator-0.9.4</code> folder, and execute the bat file <code>APTSimulator.bat</code>, as shown in the following figure.</p>
<p class="IMG---Figure"> </p>
<div><div><img alt="Figure 2.15 – Executing APTSimulator for testing Sysmon alerts" src="img/B19549_2_15.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.15 – Executing APTSimulator for testing Sysmon alerts</p>
<p>Type <code>0</code>. This will <a id="_idIndexMarker286"/>run every test including Collection, Command and Control, <strong class="bold">Credential Access</strong>, <strong class="bold">Defense Evasion</strong>, <strong class="bold">Discovery</strong>, <strong class="bold">Execution</strong>, <strong class="bold">Lateral Movement</strong>, <strong class="bold">Persistence</strong>, and <strong class="bold">Privilege Escalation</strong>.</p>
<p class="callout-heading">Note</p>
<p class="callout">Some of the attacks might not work so you can skip them.</p>
<h2 id="_idParaDest-75"><a id="_idTextAnchor074"/>Visualizing the alerts</h2>
<p>To visualize <a id="_idIndexMarker287"/>the Sysmon alerts from the Windows machine, navigate to the <strong class="bold">Security Alerts</strong> module in the Wazuh dashboard and you should see multiple alerts as shown in the following figure:</p>
<div><div><img alt="Figure 2.16 – Visualizing the Sysmon alerts in the Wazuh dashboard" src="img/B19549_2_16.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.16 – Visualizing the Sysmon alerts in the Wazuh dashboard</p>
<p>Here, you can <a id="_idIndexMarker288"/>see that we got a wide range of Sysmon events such as <strong class="bold">Process Creation (Event 1)</strong>, <strong class="bold">DNS Query (Event 22)</strong>, <strong class="bold">Network Connection (Event 3)</strong>, and <strong class="bold">RegistryEvent (Event 13)</strong>. All these Sysmon events can be used to conduct further analysis.</p>
<h1 id="_idParaDest-76"><a id="_idTextAnchor075"/>Summary</h1>
<p>This chapter introduced us to the synergy between Wazuh and malware detection, covering its capabilities in FIM and using VirusTotal for enhanced threat intelligence and the CDB list to build a list of known malware hashes. The integration of Windows Defender logs with Wazuh provided us with a unified look at security events on a Windows machine. In the end, we talked about the integration of Sysmon with a Windows machine to detect fileless malware on the Windows machine.</p>
<p>In the next chapter, we will learn how to enhance Wazuh’s threat intelligence capabilities by integrating the <strong class="bold">Malware Information Sharing Platform</strong> (<strong class="bold">MISP</strong>). To build a scalable system, we will also integrate TheHive and Cortex with the MISP platform.</p>
</div>


<div><h1 id="_idParaDest-77" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor076"/>Part 2: Threat Intelligence, Automation, Incident Response, and Threat Hunting</h1>
</div>
<div><p>In this part, you will learn how to extend the Wazuh threat intelligence capability by integrating the MISP platform. You will learn to integrate TheHive with Wazuh and MISP to perform threat analysis. In addition to that, you will learn how to automate security operations and management of the Wazuh platform using the <strong class="bold">security orchestration, automation, and response</strong> (<strong class="bold">SOAR</strong>) tool, <strong class="bold">Shuffle</strong>. You will also learn to perform automated incident responses using a Wazuh-native feature called Active Response such as blocking brute force attempts and automatically isolating infected machines. Lastly, we will learn how to leverage the Wazuh platform to conduct proactive threat hunting.</p>
<p>This part includes the following chapters:</p>
<ul>
<li><a href="B19549_03.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Threat Intelligence and Analysis</em></li>
<li><a href="B19549_04.xhtml#_idTextAnchor116"><em class="italic">Chapter 4</em></a>, <em class="italic">Security Automation and Orchestration Using Shuffle</em></li>
<li><a href="B19549_05.xhtml#_idTextAnchor136"><em class="italic">Chapter 5</em></a><em class="italic">: Incident Response with Wazuh</em></li>
<li><a href="B19549_06.xhtml#_idTextAnchor163"><em class="italic">Chapter 6</em></a><em class="italic">: Threat Hunting with Wazuh</em></li>
</ul>
</div>
<div><div></div>
</div>
<div><div></div>
</div>
</body></html>