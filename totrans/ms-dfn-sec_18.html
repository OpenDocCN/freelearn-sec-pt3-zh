<html><head></head><body>
		<div><h1 id="_idParaDest-336"><em class="italic"><a id="_idTextAnchor350"/>Chapter 15</em>: Leveraging Pentesting for Defensive Security</h1>
			<p><em class="italic">"Companies have to invest time and resources in defensive security to identify new vulnerabilities that allow them to anticipate the movements of the adversary. As Sun Tzu says in The Art of War: "To know your enemy, you must become your enemy."</em></p>
			<p><em class="italic"> – Dagoberto Herrera, University Dean</em></p>
			<p>While pentesting is a task normally reserved for <strong class="bold">offensive security teams</strong> (also called <strong class="bold">red teams</strong>), the truth is that as a master in defensive security, you also need to know at least the basics of pentesting.</p>
			<p>In fact, this chapter is not aimed to make you a pentester. Instead, the goal of this chapter is to show you the most popular tools used by pentesters (and attackers) to show you how easy and dangerous those attacks can be. </p>
			<p>The chapter starts with some mandatory theory to be able to then move on to some exacting labs in which you can experiment using your own hands with the simplicity and power of those offensive security tools. </p>
			<p>The main topics that we will cover in this chapter are as follows:</p>
			<ul>
				<li>Understanding the importance of logs</li>
				<li>Knowing your enemy's best friend: Metasploit</li>
				<li>Other offensive hacking tools</li>
			</ul>
			<h1 id="_idParaDest-337"><a id="_idTextAnchor351"/>Technical requirements </h1>
			<p>A virtual machine with <strong class="bold">Kali Linux</strong> with <strong class="bold">Damn Vulnerable Web Application</strong> (<strong class="bold">DVWA</strong>) installed (could be the same as what we installed in <a href="B16290_12_Final_JC_ePub.xhtml#_idTextAnchor287"><em class="italic">Chapter 12</em></a>, <em class="italic">Mastering Web App Security</em>.</p>
			<p>A machine with virtualization software such as <strong class="bold">VirtualBox</strong> will be used to create a virtual machine with Metasploitable.</p>
			<h1 id="_idParaDest-338"><a id="_idTextAnchor352"/>Understanding the importance of logs</h1>
			<p>Before talking about the importance of logs, let's take a few minutes to understand some of the core attributes <a id="_idIndexMarker1445"/>of logs, including their origins, the types, and even some standards used in the industry. </p>
			<h2 id="_idParaDest-339"><a id="_idTextAnchor353"/>Log files</h2>
			<p>Logs were created as a way to record events in the operating system or applications. They started as a <a id="_idIndexMarker1446"/>great debugging and troubleshooting tool, but now they are used for many other purposes, such as <em class="italic">auditing</em>, <em class="italic">security</em>, and <em class="italic">compliance</em>:</p>
			<div><div><img src="img/Figure_15.1_B16290.jpg" alt="Figure 15.1 – View of logs on a Windows system&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.1 – View of logs on a Windows system</p>
			<p>Most log files are simple text files with common attributes such as log type, timestamp, ID, and user. Most operating systems and applications categorize the different types of logs for <a id="_idIndexMarker1447"/>ease of analysis. The most common categories are as follows:</p>
			<ul>
				<li>Error log</li>
				<li>System log</li>
				<li>Application log</li>
				<li>Access log</li>
				<li>Transaction log</li>
			</ul>
			<p>In theory, this sounds very simple, right? But in reality, it is not, and let's see why. Imagine the following scenario.</p>
			<p>You have a server with Windows Server that by itself generates around 500 logs per minute, you have a database that generates 400 logs per minute, plus 6 applications that, combined, generate another 300 logs per minute. This means that your server is generating an average of 1,000 logs per minute, which is about 24,000 logs a day or 720,000 logs in a month in only one server. Now, if you multiply this by the number of servers in your organization <a id="_idIndexMarker1448"/>and even other devices such as routers and IoT (which also generate logs), then this becomes unmanageable, and this is why you must apply <strong class="bold">log management techniques</strong>.</p>
			<h2 id="_idParaDest-340"><a id="_idTextAnchor354"/>Log management</h2>
			<p>As a cybersecurity expert, you must apply log management techniques to take advantage of logs. In fact, if they are not properly managed, logs can become useless and even a burden <a id="_idIndexMarker1449"/>on your infrastructure, but if you properly manage them, they can become a powerful source of information.</p>
			<p>But don't worry because here are the things you need to keep in mind to ensure you manage your logs like a master:</p>
			<ul>
				<li><strong class="bold">Log structure</strong>: There are many types of log formats but having logs in different formats will only increase the complexity of log management. That is why companies try <a id="_idIndexMarker1450"/>to adhere to one standard to make sure the log structure is the same across systems.<p>One of the most famous standards is <strong class="bold">Syslog</strong>, which was created as early as 1980 and became almost a standard for Unix-like systems. </p></li>
				<li><strong class="bold">Log collection</strong>: A best practice is to have a centralized system to capture all logs. This can be done by a third-party system that collects logs from a plurality of systems to centralize all logs in a single place. In some cases, a company may want to create a server just to collect logs from a critical business activity, for example, creating a server to collect all logs from a critical web application.</li>
				<li><code>IIS_log_334455</code>, <code>SQL_log_01_02_2021</code>).<p>Depending on the size of your infrastructure, this activity can become impossible to be done manually, therefore it is highly recommended to use a log management solution that allows you to add custom tags to your logs based on the source.</p></li>
				<li><strong class="bold">Log analysis</strong>: The real value of logs is the information that we can gather from them, and that information can only be obtained by performing a deep analysis of the logs. Log analysis will help you to generate metrics, find patterns, and even gather threat intelligence by correlating logs between systems.<p>More advanced systems will even incorporate an artificial intelligence engine that will leverage machine learning techniques to provide better insights and even predictions based on your logs.</p></li>
				<li><strong class="bold">Log storage and archiving</strong>: There are a lot of reasons to archive your logs. One of the main reasons is related to compliance and regulations that may require the company to keep logs archived for a given period of time. But even if your company is not regulated, it is a good practice to create a policy related to the archival of logs to determine how long you must keep your logs and even break down those times based on the type and importance of logs (to save some space).</li>
			</ul>
			<p>OK, now that we've reviewed the basics of logs and log management, it is time to recap the benefits and importance of logs in your role as cybersecurity master.</p>
			<h2 id="_idParaDest-341"><a id="_idTextAnchor355"/>The importance of logs</h2>
			<p>As mentioned before, let's do a review of the most relevant topics that highlight the importance of logs <a id="_idIndexMarker1452"/>and why you must invest time and resources into log management:</p>
			<ul>
				<li><strong class="bold">Compliance and audit</strong>: You must ensure that your logs are aligned with applicable regulations. In fact, missing logs could result in very high fines for your company, therefore <a id="_idIndexMarker1453"/>you must ensure your logs policy is aligned with <a id="_idIndexMarker1454"/>all local and <a id="_idIndexMarker1455"/>international regulations, such as <strong class="bold">Payment Card Industry Data Security Standard (PCI-DSS)</strong>, <strong class="bold">Healthcare Information Portability and Accountability Act (HIPAA)</strong>, <strong class="bold">General Data Protection Regulation (GDPR)</strong>, and so on.</li>
				<li><strong class="bold">Troubleshooting</strong>: While this task may be out of your scope (and may be performed by the <strong class="bold">Information Technology (IT)</strong> department), you should consider this when creating your logs policy to ensure this is aligned with the IT department's needs to perform troubleshooting activities. Additionally, you need to ensure that they have access only to the logs they need to reduce the risk of other logs being altered or deleted.</li>
				<li><strong class="bold">Investigations</strong>: Logs are a powerful tool to detect wrongdoers, including external and internal users. Therefore, you must ensure that critical systems are generating logs. Also, you need to ensure that logs are activated on new systems (such as <strong class="bold">Internet of Things (IoT)</strong> devices) to also keep track of the activity on those devices.</li>
				<li><strong class="bold">Sanctions and legal actions</strong>: Logs are typically used as a legal way to prove that some activities were performed by a given user and, therefore, they are normally used as evidence to take legal or internal actions. Therefore, archiving and ensuring the integrity of logs are essential tasks. </li>
				<li><strong class="bold">Key metrics validation</strong>: Logs can help you to confirm whether a given <strong class="bold">Service-Level Agreement</strong> (<strong class="bold">SLA</strong>) or contract requirement was met or breached. For example, logs can confirm whether a service you provide was down and <a id="_idIndexMarker1456"/>whether the uptime was breached or not based on contractual requirements.</li>
				<li><strong class="bold">Support cybersecurity tools</strong>: Many cybersecurity tools such as SIEM use logs as their main inputs, therefore good log management will enhance the functionality of said tools. </li>
				<li><strong class="bold">Log integrity</strong>: As we learned, logs are very important, but their effectiveness relies on their integrity, so you must ensure that logs remain untouched. There are several attacks <a id="_idIndexMarker1457"/>aimed to alter log files; in fact, this is known as <strong class="bold">log spoofing</strong>. To learn more about this, please refer to the OWASP page <a id="_idIndexMarker1458"/>about log injection at <a href="https://owasp.org/www-community/attacks/Log_Injection">https://owasp.org/www-community/attacks/Log_Injection</a>.</li>
			</ul>
			<p>By now, we have reviewed everything you need to know about logs and log management. </p>
			<p>Now it's time to move on to the core of this chapter and get into more technical topics to learn all you need to know about one of the best and most famous attack frameworks used by attackers: <em class="italic">the great Metasploit</em>.</p>
			<h1 id="_idParaDest-342"><a id="_idTextAnchor356"/>Knowing your enemy's best friend – Metasploit</h1>
			<p>Let's start by clarifying that <strong class="bold">Metasploit</strong> is a great framework that, like any other tool, can be used for good or bad. In fact, chances are that your company will receive at least one attack coming from this tool, but the good news is that you can leverage this same framework to test your infrastructure by using offensive security techniques with Metasploit. </p>
			<p>But wait, wasn't this book about defensive security? Yes, but as a master in defensive security, you also need to understand how to leverage some offensive security techniques to keep your infrastructure safe.</p>
			<h2 id="_idParaDest-343"><a id="_idTextAnchor357"/>Metasploit </h2>
			<p>If you have been around the cybersecurity area, then you will have at least heard about Metasploit, but what exactly is Metasploit?</p>
			<p>Metasploit is an open source <a id="_idIndexMarker1459"/>framework developed in collaboration between the open source community and <strong class="bold">Rapid7</strong>.</p>
			<p>One of the <a id="_idIndexMarker1460"/>great features of Metasploit is its functionality with modules that <a id="_idIndexMarker1461"/>enables you <a id="_idIndexMarker1462"/>to use this framework to launch <strong class="bold">exploits</strong>, <strong class="bold">payloads</strong>, <strong class="bold">scans</strong>, and more.</p>
			<p>In terms of <a id="_idIndexMarker1463"/>exploits, Metasploit <a id="_idIndexMarker1464"/>has more than 2,000 exploits that <a id="_idIndexMarker1465"/>are applicable to <a id="_idIndexMarker1466"/>almost all <a id="_idIndexMarker1467"/>known operating <a id="_idIndexMarker1468"/>systems, including <strong class="bold">Advanced Interactive eXecutive (AIX)</strong>, <strong class="bold">Solaris</strong>, <strong class="bold">Berkeley Standard Distribution (BSD)</strong>, <strong class="bold">FreeBSD</strong>, <strong class="bold">Hewlett Packard Unix (HP-UX)</strong>, <strong class="bold">Unix</strong>, and, of course, <strong class="bold">Windows</strong>.</p>
			<p>Additionally, Metasploit has <a id="_idIndexMarker1469"/>more than 500 payloads, which includes <strong class="bold">static payloads</strong>, <strong class="bold">dynamic payloads</strong>, <strong class="bold">Command Shell</strong>, and <strong class="bold">Meterpreter</strong>.</p>
			<p>But those <a id="_idIndexMarker1470"/>numbers increase constantly because since this is an open source <a id="_idIndexMarker1471"/>project, exploits and payloads are being constantly uploaded by the <a id="_idIndexMarker1472"/>community and normally reviewed by senior community members and Rapid7. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">Metasploit will allow you to <em class="italic">find, validate, and test vulnerabilities in your systems before others do</em>! This is very important because it will allow you to see the real security status of your systems and infrastructure and act upon the findings.</p>
			<p>As mentioned, Metasploit <a id="_idIndexMarker1473"/>is a very big project and at the beginning, it could be very confusing, so let's continue by exploring the different versions of this tool.</p>
			<h2 id="_idParaDest-344"><a id="_idTextAnchor358"/>Metasploit editions</h2>
			<p>Since its conception in 2003, there have been several editions of Metasploit. Some of them are still active <a id="_idIndexMarker1474"/>while some of them have been retired (such as Metasploit Community Edition and Express). Now let's look at the current active editions of Metasploit.</p>
			<h3>Metasploit Framework edition</h3>
			<p>This can be called <em class="italic">the classic version of Metasploit</em>. This is a free command-line version that comes <a id="_idIndexMarker1475"/>preinstalled on Kali Linux. This is by far the most popular version of Metasploit and there are countless books, videos, and tutorials about it. To get more <a id="_idIndexMarker1476"/>information about this version, you can visit the official site at <a href="https://www.metasploit.com/get-started">https://www.metasploit.com/get-started</a>.</p>
			<h3>Metasploit Pro</h3>
			<p>This is the paid version of Metasploit, supported by Rapid7, which basically adds a plurality of features <a id="_idIndexMarker1477"/>such as wizards, integrations via a remote API, a plurality of automation tools, and a variety of infiltration tools, including a testing platform to test the top 10 OWASP vulnerabilities on web applications.</p>
			<p>Here, you can find a detailed comparison of this paid version and the free framework version: <a href="https://www.rapid7.com/products/metasploit/download/editions/">https://www.rapid7.com/products/metasploit/download/editions/</a>.</p>
			<h3>Armitage</h3>
			<p><strong class="bold">Armitage</strong> allows<a id="_idIndexMarker1478"/> you to graphically visualize targets and execute a plurality of exploits against them using Metasploit <a id="_idIndexMarker1479"/>in the background. This is a great tool to introduce people to Metasploit and to discover the benefits and powers of this tool.</p>
			<p>Armitage is also free and can be easily installed on Kali Linux. Next, we will show you how.</p>
			<h2 id="_idParaDest-345"><a id="_idTextAnchor359"/>Installing Armitage</h2>
			<p>As mentioned, Armitage is a great way to start your first steps with Metasploit, so let's install it on our Kali Linux machine.</p>
			<p>Now, Kali Linux comes <a id="_idIndexMarker1480"/>with Metasploit installed by default; however, you need to set it up to use for the first time, so before installing Armitage, we need to set up Metasploit.</p>
			<h2 id="_idParaDest-346"><a id="_idTextAnchor360"/>Configuring Metasploit for the first time</h2>
			<p>Metasploit uses <strong class="bold">PostgreSQL</strong> as a database, however the latest versions of Kali have this service <a id="_idIndexMarker1481"/>stopped by default, so the first step will be to start PostgreSQL and set it up to <a id="_idIndexMarker1482"/>run at boot:</p>
			<pre>sudo systemctl enable --now postgresql</pre>
			<p>As seen in the following figure, <code>postgresql</code> is now up and running:</p>
			<div><div><img src="img/Figure_15.2_B16290.jpg" alt="Figure 15.2 – Running PostgreSQL&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.2 – Running PostgreSQL</p>
			<p>Now, let's use the following command to create the required databases:</p>
			<pre>sudo msfdb init</pre>
			<p>Now, I highly recommend you check for available updates. In fact, in my case, my installation was <a id="_idIndexMarker1483"/>quite recent and I got more than 120 MB of updates. To get them, just type the following commands:</p>
			<pre>sudo apt update
sudo apt install metasploit-framework</pre>
			<p>Now you can successfully launch Metasploit by using the following command:</p>
			<pre>sudo msfconsole</pre>
			<p>If everything went correctly, then you should see the welcome page of Metasploit, as seen in the following figure:</p>
			<div><div><img src="img/Figure_15.3_B16290.jpg" alt="Figure 15.3 – Metasploit welcome screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.3 – Metasploit welcome screen</p>
			<p>Notice that this <a id="_idIndexMarker1484"/>screen provides some basic information, such as the number of exploits available, payloads, <strong class="bold">No OPeration (NOPs)</strong>, and so on.</p>
			<h2 id="_idParaDest-347"><a id="_idTextAnchor361"/>Installing Armitage (continued)</h2>
			<p>OK, now that Metasploit is up and running, let's go back to the installation and setup of Armitage.</p>
			<p>Let's start by <a id="_idIndexMarker1485"/>stopping the Metasploit service:</p>
			<pre>sudo service metasploit stop</pre>
			<p>Normally, we would need to do an <code>apt-get</code> update, but since we just did it, we can go directly to install Armitage:</p>
			<pre>sudo apt-get install armitage</pre>
			<p>Once it finishes, you should be able to start Armitage with the following command:</p>
			<pre>armitage</pre>
			<p>Then, you will get <a id="_idIndexMarker1486"/>a prompt screen. Just leave the defaults and click on <strong class="bold">Connect</strong>, as seen in the following figure:</p>
			<div><div><img src="img/Figure_15.4_B16290.jpg" alt="Figure 15.4 – Entering Armitage&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.4 – Entering Armitage</p>
			<p>Congratulations, at <a id="_idIndexMarker1487"/>this point you have both <strong class="bold">Metasploit</strong> and <strong class="bold">Armitage</strong> up and running.</p>
			<h2 id="_idParaDest-348"><a id="_idTextAnchor362"/>Exploring Armitage</h2>
			<p>Now, let's explore the GUI of Armitage to discover some of the tools that we can use.</p>
			<p>As seen in <a id="_idIndexMarker1488"/>the following figure, the GUI is very simple and intuitive (which is great for starters):</p>
			<div><div><img src="img/Figure_15.5_B16290.jpg" alt="Figure 15.5 – Armitage main screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.5 – Armitage main screen</p>
			<p>Now, let's see the main features that we have available:</p>
			<ul>
				<li><code>search smb</code> on the console, as seen in the following figure:</p></li>
			</ul>
			<div><div><img src="img/Figure_15.6_B16290.jpg" alt="Figure 15.6 – Armitage console&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.6 – Armitage console</p>
			<p>But the main idea of using Armitage is for the GUI, so let's take a look at those options.</p>
			<ul>
				<li><strong class="bold">Modules</strong>: As seen in <em class="italic">Figure 15.5</em>, there is a series of folders on the left side of the screen. Those folders are <strong class="bold">modules</strong> that contain all the exploits, payloads, auxiliaries, and <a id="_idIndexMarker1490"/>posts that you can execute.<p>As mentioned before, Metasploit has exploits for almost all operating systems, and you can see that list when you expand the <strong class="bold">exploit</strong> section, as seen in the following figure:</p></li>
			</ul>
			<div><div><img src="img/Figure_15.7_B16290.jpg" alt="Figure 15.7 – Module view listing the exploits by operating system&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.7 – Module view listing the exploits by operating system</p>
			<ul>
				<li><strong class="bold">Attacks</strong>: Here, you can <a id="_idIndexMarker1491"/>find a plurality of attacks that can be launched against the targeted machines.</li>
				<li><strong class="bold">Hosts</strong>: This menu contains a plurality of scans aimed at finding available targets. </li>
			</ul>
			<p>Now, let's do a quick lab to show you how easily an attacker can launch an attack against your systems using Armitage.</p>
			<h2 id="_idParaDest-349"><a id="_idTextAnchor363"/>Launching an attack with Armitage</h2>
			<p>Before we launch an <a id="_idIndexMarker1492"/>attack, we need to find a vulnerable machine that we own so that we can safely run the test, and we can easily achieve this with Metasploitable!</p>
			<h3>Metasploitable</h3>
			<p><strong class="bold">Metasploitable</strong> is a virtual Unix machine that was designed to be vulnerable so it can be used by security experts <a id="_idIndexMarker1493"/>and enthusiasts (like you) as a playground for testing.</p>
			<p>It is super easy to use; in fact, you only need to download the image of the virtual machine, load it up on your favorite hypervisor (such as VirtualBox), and you are ready to go. The<a id="_idIndexMarker1494"/> image can be download from here: <a href="https://sourceforge.net/projects/metasploitable">https://sourceforge.net/projects/metasploitable</a>.</p>
			<p>Now, let's do a scan to see what vulnerabilities we can find on this Metasploitable machine. To do that, let's go to <strong class="bold">Host</strong> | <strong class="bold">Nmap Scans</strong> | <strong class="bold">Intense Scan</strong> | <strong class="bold">all TCP ports</strong>.</p>
			<p>Then, select a range of IPs; in this case, I used <code>192.168.1.0/24</code>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can see the results of the scan in real time in the console at the bottom part of the screen (next to the <strong class="bold">Console</strong> tab we talked about earlier) to gather additional information about the scan.</p>
			<p>As an example, the following figure shows the outputs of a scan of a Windows 7 machine. Notice how the scan was able to gather important data such as the computer name, operating system, and service pack information:</p>
			<div><div><img src="img/Figure_15.8_B16290.jpg" alt="Figure 15.8 – Outputs of the Nmap scan&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.8 – Outputs of the Nmap scan</p>
			<p>Now, going back to our scan, you will notice that this scan may take a few minutes (depending on the number of devices) but once it finishes, it will show you a pop-up message, as seen in the following figure:</p>
			<div><div><img src="img/Figure_15.9_B16290.jpg" alt="Figure 15.9 – Successful completion of the intense scan&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.9 – Successful completion of the intense scan</p>
			<p>Now you will see all the systems or devices that were found on the scan. In our case, the Metasploitable machine <a id="_idIndexMarker1495"/>was identified with the IP <code>192.168.1.224</code> and, as seen in the following figure, it added a Linux icon as this machine was identified as a Linux computer:</p>
			<div><div><img src="img/Figure_15.10_B16290.jpg" alt="Figure 15.10 – Machines found during the scan&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption"> </p>
			<p class="figure-caption">Figure 15.10 – Machines found during the scan</p>
			<p>So, let's do a right-click to see what type of attacks can be performed against each machine. In our example, we can see that the scan was able to find several services that can be exploited to gain access to the system, as seen in the following figure:</p>
			<div><div><img src="img/Figure_15.11_B16290.jpg" alt=" Figure 15.11 – List of login services enabled&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption"> Figure 15.11 – List of login services enabled</p>
			<p>Now, let's see whether we can log in using VNC. To do that, we will have to go to the modules menu at the <a id="_idIndexMarker1496"/>left of the screen, navigate to <code>auxiliary/scanner/vnc/vnc_login</code>, and double-click to open it. Then, press <strong class="bold">Launch</strong> and wait for the outputs on the command view below.</p>
			<p>Surprise surprise, the system was able to brute force the VNC password, as shown in the following figure:</p>
			<div><div><img src="img/Figure_15.12_B16290.jpg" alt=" Figure 15.12 – Brute force of the VNC password&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption"> Figure 15.12 – Brute force of the VNC password</p>
			<p>Now, we can open a terminal to test whether we can log in to VNC using that password.</p>
			<p>To achieve that, just open a terminal and type the following (in your case, replace the following IP <a id="_idIndexMarker1497"/>with the IP of your Metasploitable machine): </p>
			<pre>vncviewer 192.168.1.224:5900</pre>
			<p>Then, type the password. In this case, type <code>password</code> and hit <em class="italic">Enter</em>.</p>
			<p>Now you will have full access to the target machine, as shown in the following figure:</p>
			<div><div><img src="img/Figure_15.13_B16290.jpg" alt="Figure 15.13 – Remote accessing the target machine through VNC&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.13 – Remote accessing the target machine through VNC</p>
			<p>This was only a quick example to see how easily an attacker can get into an unprotected system, and by unprotected, we are talking about a system with an operating system that is no longer <a id="_idIndexMarker1498"/>in support, a non-hardened server, a server missing updates or security patches, and so on.</p>
			<p>However, there are many more options that you can use to experiment with Armitage, for example, the following:</p>
			<ul>
				<li>Gather information about the database services running on the system, including the version, and even perform a brute force attack against them.</li>
				<li>Gather information about the FTP version, including anonymous login and brute force attacks.</li>
				<li>Execute a plurality of exploits based on the operating system of the target system.</li>
				<li>Select from a plurality of payloads to send and many more.</li>
			</ul>
			<p>Now it is time <a id="_idIndexMarker1499"/>to move back to Metasploit and play around a bit with the real tool.</p>
			<h2 id="_idParaDest-350"><a id="_idTextAnchor364"/>Executing Metasploit</h2>
			<p>In Metasploit, there is no GUI like Armitage. Here, you will have to navigate to and execute the <a id="_idIndexMarker1500"/>modules, attacks, and payloads with pure commands.</p>
			<p>But don't worry, let's do an example together to see how easy it can be to perform an attack on a server using the Metasploit Framework.</p>
			<p>For this example, we will again use our vulnerable Metasploitable machine and our aim will be to try to attack their FTP server. </p>
			<p>So, the first step will be to run Metasploit again:</p>
			<pre>sudo msfconsole</pre>
			<p>Now, let's do a search for <code>ftp</code> to find the modules available to attack an FTP server:</p>
			<pre>search ftp</pre>
			<p>Unfortunately, the query showed more than 170 results so we need to find a way to narrow down that list to find the best module for the attack. </p>
			<p>One option is to determine the version of the FTP server running on the system so that we can do a search for modules related to that specific version. To do that, let's use our old friend Nmap (already preinstalled on Kali Linux).</p>
			<p>Now, a normal <code>nmap</code> scan will just tell us the port of the services running, but if we want to also see the version of those services, we need to use the <code>-sV</code> parameter, as shown here:</p>
			<pre>nmap -sV 192.168.1.224</pre>
			<p>Then, you should see a result like the one shown in the following figure:</p>
			<div><div><img src="img/Figure_15.14_B16290.jpg" alt="Figure 15.14 – Using Nmap to gather the version of the FTP server&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.14 – Using Nmap to gather the version of the FTP server</p>
			<p>Now, let's go back to Metasploit and do a search for <code>vsftpd</code>:</p>
			<pre>search vsftpd</pre>
			<p>Great, the search <a id="_idIndexMarker1501"/>found an exploit for that FTP server, as seen in the following figure:</p>
			<div><div><img src="img/Figure_15.15_B16290.jpg" alt="Figure 15.15 – Exploit for vsftpd on Metasploit&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.15 – Exploit for vsftpd on Metasploit</p>
			<p>Now, let's use the <code>info</code> command to gather additional information about this module:</p>
			<pre>info 0</pre>
			<p>In the following figure, we can see a lot of useful information, such as the name of the exploit, the platform, the release date, and the authors, but the most important part for us is the <code>RHOST</code>, which is not set, and <code>RPORT</code>, which is already set by default to <code>21</code>:</p>
			<div><div><img src="img/Figure_15.16_B16290.jpg" alt="Figure 15.16 – Exploring additional information of exploits on Metasploit&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.16 – Exploring additional information of exploits on Metasploit</p>
			<p>As seen in <em class="italic">Figure 15.16</em>, we can call the exploit by either using the long name or the identifier (in this case <code>0</code>):</p>
			<pre>use 0</pre>
			<p>Now, let's set <code>RHOST</code> to the IP of the target machine:</p>
			<pre>set RHOST 192.168.1.224</pre>
			<p>Now the system should reply with a message that <code>RHOST</code> was set to the IP address specified, but if you <a id="_idIndexMarker1502"/>want to double-check, you can also use the <code>show options</code> command, as seen in the following figure:</p>
			<div><div><img src="img/Figure_15.17_B16290.jpg" alt="Figure 15.17 – Using show options to confirm the exploit settings&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.17 – Using show options to confirm the exploit settings</p>
			<p>Now everything seems to be ready to execute the exploit with the following command:</p>
			<pre>run</pre>
			<p>And now, as seen in the following figure, we have full access to the target machine. In fact, you can see <a id="_idIndexMarker1503"/>that we can execute a lot of commands on the target (victim machine), such as <code>whoami</code> (which terrifyingly shows that we are connected as root). Also, we did <code>ifconfig</code> to confirm that we are issuing the commands on the target machine:</p>
			<div><div><img src="img/Figure_15.18_B16290.jpg" alt="Figure 15.18 – Gathering full remote access with Metasploit&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.18 – Gathering full remote access with Metasploit</p>
			<p>Those were some simple examples to show you how easy it is to attack a system using Metasploit. But from the point of view of defensive security, here are some takeaways to highlight:</p>
			<ul>
				<li>The importance of patching to prevent attacks</li>
				<li>The importance of hardening to prevent the execution of remote exploits</li>
				<li>The value of using offensive tools to test your environment against real threats</li>
				<li>The simplicity of the <a id="_idIndexMarker1504"/>attacks and how easy it is to discover information about your systems to tailor an attack against your infrastructure and systems</li>
			</ul>
			<p>While Metasploit is the most famous offensive security framework, there are other tools used by attackers to get into your systems, so let's also look at other offensive security tools.</p>
			<h1 id="_idParaDest-351"><a id="_idTextAnchor365"/>Other offensive hacking tools</h1>
			<p>Let's review<a id="_idIndexMarker1505"/> the most famous offensive security tools currently available, both free and paid.</p>
			<h2 id="_idParaDest-352"><a id="_idTextAnchor366"/>Searchsploit</h2>
			<p>We talked in<a id="_idIndexMarker1506"/> previous chapters about <a href="https://www.exploit-db.com/">https://www.exploit-db.com/</a>, which is a huge database with more than 44,000 exploits available to download. The website is great and it shows a lot of <a id="_idIndexMarker1507"/>useful information in a friendly way, but searching for an exploit on the page, downloading it, and then executing it could be a bit time-consuming. Here is where <code>exploit-db</code> and run them directly from the terminal; yes, it's that easy!</p>
			<p>Let's do a quick example. Imagine you added a <strong class="bold">Joomla</strong> server to your organization and you want to test it against <a id="_idIndexMarker1508"/>known vulnerabilities. You can run the following command:</p>
			<pre>searchsploit -t joomla</pre>
			<p>The <code>-t</code> option will just give us results in which the word Joomla is in the title of the exploit.</p>
			<p>Now, imagine your boss asked you to install a YouTube plugin on your Joomla server. Then, let's see how we can find out about vulnerabilities related to that plugin:</p>
			<pre>searchsploit -t joomla youtube</pre>
			<p>As seen in the following figure, the tool found three vulnerabilities associated with YouTube Joomla plugins:</p>
			<div><div><img src="img/Figure_15.19_B16290.jpg" alt="Figure 15.19 – Finding vulnerabilities using Searchsploit&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.19 – Finding vulnerabilities using Searchsploit</p>
			<p>The next step is <a id="_idIndexMarker1509"/>to run the exploit, which is quite <a id="_idIndexMarker1510"/>easy. First, you need to copy the path of the script with the following command:</p>
			<pre>searchsploit -p 34087</pre>
			<p>Then, as seen in the following figure, you will get a response with the full path of the script. Just copy and paste that path and you will be able to run the exploit!</p>
			<div><div><img src="img/Figure_15.20_B16290.jpg" alt="Figure 15.20 – Obtaining the path to execute the exploit on Searchsploit&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.20 – Obtaining the path to execute the exploit on Searchsploit</p>
			<p>As mentioned before, executing those exploits is very easy, therefore this is one of the reasons<a id="_idIndexMarker1511"/> why <a id="_idIndexMarker1512"/>you need to <em class="italic">make sure you test those vulnerabilities before they are exploited by an attacker</em>.</p>
			<h2 id="_idParaDest-353"><a id="_idTextAnchor367"/>sqlmap</h2>
			<p><strong class="bold">sqlmap</strong> is a very <a id="_idIndexMarker1513"/>powerful penetration testing tool to detect and exploit SQL injection vulnerabilities on <a id="_idIndexMarker1514"/>database servers. It is packed with a lot of cool features, including the following:</p>
			<ul>
				<li>Upload and download files.</li>
				<li>Dump entire database tables.</li>
				<li>Advanced search for specific tables or columns across databases.</li>
				<li>Enumeration <a id="_idIndexMarker1515"/>of users, password hashes, roles, tables, columns, and more.</li>
				<li>Recognition of password hashes and support to crack them with dictionary-based attacks.</li>
			</ul>
			<p>Additionally, <code>sqlmap</code> fully supports most common SQL servers, including MySQL, PostgreSQL, Microsoft SQL, Microsoft Access, and SQLite.</p>
			<p><code>sqlmap</code> is already preinstalled on Kali Linux, so if you want to learn more about the tool, you can type the following command, which highlights the basic commands of the tool:</p>
			<pre>sqlmap -h</pre>
			<p>As a fun<a id="_idIndexMarker1516"/> fact, notice that the <code>-g</code> option allows you to process <em class="italic">Google dork</em> results as target URLs.</p>
			<h2 id="_idParaDest-354"><a id="_idTextAnchor368"/>Weevely</h2>
			<p><strong class="bold">Weevely</strong> is a <a id="_idIndexMarker1517"/>very interesting tool that provides a web shell to attack web applications. It has a lot of <a id="_idIndexMarker1518"/>interesting features, including the following:</p>
			<ul>
				<li>HTTP and HTTPS proxies to browse through the infected web application.</li>
				<li>Ability to brute force SQL accounts on the targeted system.</li>
				<li>Mount the remote filesystem.</li>
				<li>Direct <a id="_idIndexMarker1519"/>shell access to the target.</li>
				<li>Upload and download files.</li>
				<li>File navigation and more.</li>
			</ul>
			<p>I am sure that you would love to see an attack with this tool, so let's do a quick lab to show you how Weevely works.</p>
			<p>For this lab, we will use DVWA as the target machine on our Kali Linux machine. </p>
			<p class="callout-heading">Tip </p>
			<p class="callout">In <a href="B16290_12_Final_JC_ePub.xhtml#_idTextAnchor287"><em class="italic">Chapter 12</em></a>, <em class="italic">Mastering Web App Security</em>, we covered the installation and setup of DVWA, so if you have not installed it, then just go back to that chapter and follow our simple steps to get it up and running. </p>
			<p>Now, assuming that you have DVWA already installed on your Kali Linux machine, then we just need <a id="_idIndexMarker1520"/>to go ahead and run it.</p>
			<p>The first step will be to start the database services with the following command:</p>
			<pre>sudo service mysql start</pre>
			<p>Then, let's start the Apache server with the following command:</p>
			<pre>sudo service apache2 start</pre>
			<p>Now, let's open a web browser to open DVWA using the following address:</p>
			<p><code>127.0.0.1/DWVA/</code></p>
			<p>Now you<a id="_idIndexMarker1521"/> should see the login page of DVWA, as shown in the following figure:</p>
			<div><div><img src="img/Figure_15.21_B16290.jpg" alt="Figure 15.21 – DVWA login page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.21 – DVWA login page</p>
			<p>To log in, just use the admin credentials that you created during the setup of DVWA.</p>
			<p>Now that you are in, let's go and change the security to low. To do that, just go to the left menu and <a id="_idIndexMarker1522"/>search for <strong class="bold">DVWA Security</strong>, then change the drop-down menu to <strong class="bold">Low</strong> and click on <strong class="bold">Submit</strong>, as shown in the following figure:</p>
			<div><div><img src="img/Figure_15.22_B16290.jpg" alt="Figure 15.22 – Lowering the security level in DVWA&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.22 – Lowering the security level in DVWA</p>
			<p>At this<a id="_idIndexMarker1523"/> point, our target machine is ready to be attacked!</p>
			<p>To create the shell, let's go back to Kali and use the following command:</p>
			<pre>weevely generate mypassword /home/kali/myshell.php</pre>
			<p>Notice that <code>mypassword</code> is the password of the shell that we are creating and the rest is the path and filename of the shell. In this example, I am saving it under my user directory with the name <code>myshell.php</code>.</p>
			<p>Now, you can navigate to your user directory to confirm that the file was created, as shown in the following figure:</p>
			<div><div><img src="img/Figure_15.23_B16290.jpg" alt="Figure 15.23 – Local copy of the shell created on Weevely&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.23 – Local copy of the shell created on Weevely</p>
			<p>Now, let's go back to DVWA to upload our shell. </p>
			<p>To do that, just go to <code>myshell.php</code>, and click on <strong class="bold">Upload</strong>.</p>
			<p>Now, we need to <a id="_idIndexMarker1524"/>copy the location of the file on the server. To do that, just <a id="_idIndexMarker1525"/>copy the first part of the URL (<code>http://127.0.0.1/DVWA</code>) and the path highlighted in the <em class="italic">successfully uploaded</em> message (<code>/hackable/uploads/myshell.php</code>), as shown in the following figure:</p>
			<div><div><img src="img/Figure_15.24_B16290.jpg" alt="Figure 15.24 – Path of the shell on DVWA&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.24 – Path of the shell on DVWA</p>
			<p>Now, the path should look like this:</p>
			<pre>http://127.0.0.1/DVWA/hackable/uploads/myshell.php</pre>
			<p>Now, let's again open the console of Kali Linux to execute the shell with the following command (notice that here, we are basically adding the path to the server plus the password to run the shell):</p>
			<pre>weevely http://127.0.0.1/DVWA/hackable/uploads/myshell.php mypassword</pre>
			<p>And now, as seen in the following figure, you have full access to the server, including to see the<a id="_idIndexMarker1526"/> current <a id="_idIndexMarker1527"/>user, file navigation, and more:</p>
			<div><div><img src="img/Figure_15.25_B16290.jpg" alt="Figure 15.25 – Results of the Weevely attack&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.25 – Results of the Weevely attack</p>
			<p>Of course, there are many more tools used for offensive security and we encourage you to discover them, but by now, you should have a clear understanding of the power of those tools to attack your infrastructure, including servers, web applications, and even databases. </p>
			<h1 id="_idParaDest-355"><a id="_idTextAnchor369"/>Summary</h1>
			<p>I hope you enjoyed this chapter as much as I did. Here, we learned about logs, why they are important, and even how to successfully manage them (log management).</p>
			<p>Then, we moved into the technical side of the chapter to find out more about the most famous offensive security tool: Metasploit.</p>
			<p>Then, to get started with Metasploit, we did a hands-on lab using Armitage and Metasploitable.</p>
			<p>Once we got more immersed in the Metasploit Framework, we did another hands-on lab directly with Metasploit in which we got full control over the target machine.</p>
			<p>But there was more: we did two more labs, one with Searchsploit and another very cool lab with Weevely in which we even used the DVWA that we installed in <a href="B16290_12_Final_JC_ePub.xhtml#_idTextAnchor287"><em class="italic">Chapter 12</em></a>, <em class="italic">Mastering Web App Security</em>.</p>
			<p>Now, it is time to move on to another super interesting and very technical chapter in which we will discover some of the tools and techniques used in <strong class="bold">computer forensics!</strong></p>
			<h1 id="_idParaDest-356"><a id="_idTextAnchor370"/>Further reading</h1>
			<p>If you want to know more about Metasploit and the available versions, visit the official site at <a href="https://www.metasploit.com/">https://www.metasploit.com/</a>.</p>
			<p>Also, the official GitHub for Metasploit can be found here: <a href="https://github.com/rapid7/metasploit-framework">https://github.com/rapid7/metasploit-framework</a>.</p>
		</div>
	</body></html>