<html><head></head><body>
<div id="_idContainer192">
<h1 class="chapter-number" id="_idParaDest-169"><a id="_idTextAnchor173"/><span class="koboSpan" id="kobo.1.1">10</span></h1>
<h1 id="_idParaDest-170"><a id="_idTextAnchor174"/><span class="koboSpan" id="kobo.2.1">Analyzing System Memory</span></h1>
<p><span class="koboSpan" id="kobo.3.1">For a long time, law enforcement and other organizations performing digital forensic tasks associated with incident investigations often relied on methodologies that focused on evidence contained within the hard drive of a machine. </span><span class="koboSpan" id="kobo.3.2">Procedures dictated that the system should be powered down and the hard drive removed for imaging. </span><span class="koboSpan" id="kobo.3.3">While this methodology and the associated procedures were effective at ensuring the integrity of the evidence, this overlooked the wealth of information that was contained within the </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Random Access Memory</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">RAM</span></strong><span class="koboSpan" id="kobo.7.1">), or memory for short, of the targeted system. </span><span class="koboSpan" id="kobo.7.2">As a result, incident response analysts began to focus a great deal of attention on ensuring that appropriate methods were employed that maintained the integrity of this evidence, as well as giving them a platform from which to obtain information of </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">evidentiary value.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">This chapter will focus on the types of evidence that can be located within the memory of a system, the tools and techniques available to incident response analysts, and, finally, how to analyze this information to obtain a clear understanding of how the system was compromised. </span><span class="koboSpan" id="kobo.9.2">In addition, these techniques can also be integrated into the analysis of other evidence, such as network log files and files located on the </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">targeted system.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">In this chapter, the following main topic areas will </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">be addressed:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.13.1">Memory analysis overview</span></strong><span class="koboSpan" id="kobo.14.1">: This section addresses the critical data points that can be discovered through proper </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">memory analysis</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.16.1">Memory analysis methodology</span></strong><span class="koboSpan" id="kobo.17.1">: A structured approach is important to ensure that responders can extract the </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">necessary data</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.19.1">Memory analysis with Volatility</span></strong><span class="koboSpan" id="kobo.20.1">: Often thought of as the gold standard of memory analysis, this command-line tool has extensive features for data acquisition </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">and analysis</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.22.1">Memory analysis with Strings</span></strong><span class="koboSpan" id="kobo.23.1">: A simple but effective tool that affords responders the ability to cull data from those areas of memory that other tools </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">may miss</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.25.1">At the end of this chapter, you will have both an understanding of the methodology and the tools necessary for finding data points, analyzing them, and extracting other evidence for </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">follow-up analysis.</span></span></p>
<h1 id="_idParaDest-171"><a id="_idTextAnchor175"/><span class="koboSpan" id="kobo.27.1">Memory analysis overview</span></h1>
<p><span class="koboSpan" id="kobo.28.1">When </span><a id="_idIndexMarker863"/><span class="koboSpan" id="kobo.29.1">discussing how to analyze the memory of a system, two terms are used interchangeably. </span><span class="koboSpan" id="kobo.29.2">The terms RAM and memory are used to describe the portion of the computer’s internal systems where the operating system places data utilized by applications and the system hardware while that application or hardware is in use. </span><span class="koboSpan" id="kobo.29.3">What makes RAM or memory different from storage is the volatile nature of the data. </span><span class="koboSpan" id="kobo.29.4">Often, if the system is shut down, the data will </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">be lost.</span></span></p>
<p><span class="koboSpan" id="kobo.31.1">One change in operating systems that has had a direct impact on memory analysis is the advent of the 64-bit OS. </span><span class="koboSpan" id="kobo.31.2">The use of a 64-bit register allows the OS to reference a total of 17,179,869,184 GB of memory. </span><span class="koboSpan" id="kobo.31.3">When compared to the 32-bit OS, this is several million times the amount of data previously available. </span><span class="koboSpan" id="kobo.31.4">As a result, there is a good deal of data contained within RAM at the time a system is running that is valuable in incident investigation. </span><span class="koboSpan" id="kobo.31.5">This includes </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">the following:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.33.1">Running processes</span></span></li>
<li><span class="koboSpan" id="kobo.34.1">Loaded </span><strong class="bold"><span class="koboSpan" id="kobo.35.1">Dynamic Link </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.36.1">Libraries</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.37.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.38.1">DLL</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.40.1">Loaded </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">device drivers</span></span></li>
<li><span class="koboSpan" id="kobo.42.1">Open registry keys </span></li>
<li><span class="koboSpan" id="kobo.43.1">Network connections </span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.44.1">Command history</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.45.1">As the necessity for analyzing the memory of systems has increased, there are several tools that analysts have at their disposal. </span><span class="koboSpan" id="kobo.45.2">This chapter will focus on three such tools; all of them are either open source or freeware and can be deployed easily. </span><span class="koboSpan" id="kobo.45.3">These tools allow analysts to gain critical insight into the activity of exploits and malware that have impacted </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">a system.</span></span></p>
<p><span class="koboSpan" id="kobo.47.1">Throughout this chapter, two memory captures will be utilized. </span><span class="koboSpan" id="kobo.47.2">The first memory capture is from a Windows system that has been infected by the Cridex virus. </span><span class="koboSpan" id="kobo.47.3">The memory image can be downloaded </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">from </span></span><a href="http://files.sempersecurus.org/dumps/cridex_memdump.zip"><span class="No-Break"><span class="koboSpan" id="kobo.49.1">http://files.sempersecurus.org/dumps/cridex_memdump.zip</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.50.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.51.1">The second is another Windows system that is part of a training exercise available </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">at </span></span><a href="https://dfirmadness.com/case001/DC01-memory.zip"><span class="No-Break"><span class="koboSpan" id="kobo.53.1">https://dfirmadness.com/case001/DC01-memory.zip</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.54.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">While both of the malware infections are relatively old, they are useful for highlighting specific features of the toolsets we are going </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">to examine.</span></span></p>
<h1 id="_idParaDest-172"><a id="_idTextAnchor176"/><span class="koboSpan" id="kobo.57.1">Memory analysis methodology</span></h1>
<p><span class="koboSpan" id="kobo.58.1">When examining </span><a id="_idIndexMarker864"/><span class="koboSpan" id="kobo.59.1">system memory, analysts should follow a methodology. </span><span class="koboSpan" id="kobo.59.2">This ensures that all potential evidence is uncovered and can be utilized in an incident investigation. </span><span class="koboSpan" id="kobo.59.3">We will examine two methodologies. </span><span class="koboSpan" id="kobo.59.4">The first of these is the SANS six-part methodology. </span><span class="koboSpan" id="kobo.59.5">This is geared toward identifying indicators of compromise associated with the execution of malware. </span><span class="koboSpan" id="kobo.59.6">Another methodology focuses on leveraging an IP address or other network artifact to identify the malicious code associated with that </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">IP address.</span></span></p>
<p><span class="koboSpan" id="kobo.61.1">One of the chief aims of memory analysis is to identify potentially malicious processes or executables that can be extracted and examined. </span><span class="koboSpan" id="kobo.61.2">Much of the material that is present in this chapter will carry over into </span><a href="B18571_16.xhtml#_idTextAnchor284"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.62.1">Chapter 16</span></em></span></a><span class="koboSpan" id="kobo.63.1">, where the extracted data will be </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">further analyzed.</span></span></p>
<h2 id="_idParaDest-173"><a id="_idTextAnchor177"/><span class="koboSpan" id="kobo.65.1">SANS six-part methodology</span></h2>
<p><span class="koboSpan" id="kobo.66.1">The SANS institution makes use of </span><a id="_idIndexMarker865"/><span class="koboSpan" id="kobo.67.1">a six-part methodology for analyzing memory images. </span><span class="koboSpan" id="kobo.67.2">This process is designed to start from an overall view of what is running to identifying and accessing the malicious software. </span><span class="koboSpan" id="kobo.67.3">The SANS methodology</span><a id="_idIndexMarker866"/><span class="koboSpan" id="kobo.68.1"> follows the </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">following steps:</span></span></p>
<ol>
<li value="1"><strong class="bold"><span class="koboSpan" id="kobo.70.1">Identify rogue processes</span></strong><span class="koboSpan" id="kobo.71.1">: Malware often hides its behavior behind processes that, on the surface, may seem legitimate. </span><span class="koboSpan" id="kobo.71.2">Uncovering these involves identifying what processes are running, finding the location in the operating system they are running from, and verifying that only legitimate processes are in use. </span><span class="koboSpan" id="kobo.71.3">Sometimes, processes are hidden in plain sight, and adversaries change a single letter in a process name. </span><span class="koboSpan" id="kobo.71.4">Other times, they will attempt to execute a process from an </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">illegitimate source.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.73.1">Analyze process DLLs and handles</span></strong><span class="koboSpan" id="kobo.74.1">: Once a process or multiple processes have been identified as rogue, the next step is to examine the DLL files associated with the process, as well as other factors such as account information. </span><span class="koboSpan" id="kobo.74.2">DLL files are often leveraged by malware coders to hide their activity. </span><span class="koboSpan" id="kobo.74.3">Techniques for using DLL files to compromise a system include techniques where malware coders insert their own malicious DLL files as part of the malware. </span><span class="koboSpan" id="kobo.74.4">Other techniques include DLL injection, where a path to one of the malicious DLLs is written in </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">the process.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.76.1">Review network artifacts</span></strong><span class="koboSpan" id="kobo.77.1">: Malware, especially multi-stage malware, requires a connection </span><a id="_idIndexMarker867"/><span class="koboSpan" id="kobo.78.1">to the internet. </span><span class="koboSpan" id="kobo.78.2">Even</span><a id="_idIndexMarker868"/><span class="koboSpan" id="kobo.79.1"> systems that are fully compromised often beacon out to C2 servers. </span><span class="koboSpan" id="kobo.79.2">Active and listening network connections are contained within the memory of these systems. </span><span class="koboSpan" id="kobo.79.3">Identifying external host IP addresses may give some insight into what type of compromise has </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">taken place.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.81.1">Look for evidence of code injection</span></strong><span class="koboSpan" id="kobo.82.1">: Techniques such as process hollowing, and unmapped sections of the memory are often used by advanced malware coders. </span><span class="koboSpan" id="kobo.82.2">Memory analysis tools help analysts find evidence of </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">these techniques.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.84.1">Check for signs of a rootkit</span></strong><span class="koboSpan" id="kobo.85.1">: Achieving persistence is a goal for many external threat actors. </span><span class="koboSpan" id="kobo.85.2">If they can compromise the system initially, they must maintain that. </span><span class="koboSpan" id="kobo.85.3">As a result, adversaries might use a rootkit or malware that embeds itself deep within the operating system. </span><span class="koboSpan" id="kobo.85.4">This malware allows the adversary to have continuous and often elevated access to the system while </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">remaining undetected.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.87.1">Dump suspicious processes and drivers</span></strong><span class="koboSpan" id="kobo.88.1">: After locating any suspicious processes or executables, analysts </span><a id="_idIndexMarker869"/><span class="koboSpan" id="kobo.89.1">need to be able to acquire them for</span><a id="_idIndexMarker870"/><span class="koboSpan" id="kobo.90.1"> later analysis with </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">additional tools.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.92.1">Next, we will look at the network </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">connections methodology.</span></span></p>
<h2 id="_idParaDest-174"><a id="_idTextAnchor178"/><span class="koboSpan" id="kobo.94.1">Network connections methodology</span></h2>
<p><span class="koboSpan" id="kobo.95.1">In many incidents, the</span><a id="_idIndexMarker871"/><span class="koboSpan" id="kobo.96.1"> first indication that a system has been compromised</span><a id="_idIndexMarker872"/><span class="koboSpan" id="kobo.97.1"> is attempted or completed connections to external hosts. </span><span class="koboSpan" id="kobo.97.2">Detection mechanisms such as firewalls or web proxies may indicate that a system or systems are attempting to communicate with suspect external hosts. </span><span class="koboSpan" id="kobo.97.3">From this starting position, it may be possible to identify potential malware on </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">a system:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.99.1">Suspicious network connections</span></strong><span class="koboSpan" id="kobo.100.1">: Conducting a review of network connections on hosts that have been associated with external connections will often provide the process that is attempting </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">to communicate.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.102.1">Process name</span></strong><span class="koboSpan" id="kobo.103.1">: Examining the process from the network connections allows analysts to perform similar actions found within the SANS methodology. </span><span class="koboSpan" id="kobo.103.2">It is advisable for the analyst to also determine whether the identified process is one that often requires a </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">network connection.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.105.1">Parent process ID</span></strong><span class="koboSpan" id="kobo.106.1">: Further insight into the parent process is useful for determining whether the process is legitimate and has a legitimate need to communicate via a </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">network connection.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.108.1">Associated entities</span></strong><span class="koboSpan" id="kobo.109.1">: Finally, examining the associated DLLs and other artifacts brings us to the stage</span><a id="_idIndexMarker873"/><span class="koboSpan" id="kobo.110.1"> where they can be acquired </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">and </span></span><span class="No-Break"><a id="_idIndexMarker874"/></span><span class="No-Break"><span class="koboSpan" id="kobo.112.1">analyzed.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.113.1">Now, let’s look at some memory </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">analysis tools.</span></span></p>
<h1 id="_idParaDest-175"><a id="_idTextAnchor179"/><span class="koboSpan" id="kobo.115.1">Memory analysis tools</span></h1>
<p><span class="koboSpan" id="kobo.116.1">Analysts </span><a id="_idIndexMarker875"/><span class="koboSpan" id="kobo.117.1">can use several tools to review memory images. </span><span class="koboSpan" id="kobo.117.2">Some tools provide a GUI for ease of use, while others operate via the command line, making them useful for scripting. </span><span class="koboSpan" id="kobo.117.3">In this chapter, three tools will be examined. </span><span class="koboSpan" id="kobo.117.4">The first of these, Mandiant Redline, is a GUI-based memory analysis tool that examines memory images for signs of rogue processes and scores them based on several factors. </span><span class="koboSpan" id="kobo.117.5">The second of these tools is Volatility, a command-line tool that allows analysts to drill into the details of the memory image and identify potentially malicious code. </span><span class="koboSpan" id="kobo.117.6">The final tool that will be examined is the Strings utility available in Linux. </span><span class="koboSpan" id="kobo.117.7">Strings allows keyword searching through GREP, which allows the responder to identify IOCs that may not be readily visible with the </span><span class="No-Break"><span class="koboSpan" id="kobo.118.1">other tools.</span></span></p>
<h2 id="_idParaDest-176"><a id="_idTextAnchor180"/><span class="koboSpan" id="kobo.119.1">Memory analysis with Volatility</span></h2>
<p><span class="koboSpan" id="kobo.120.1">Volatility is an</span><a id="_idIndexMarker876"/><span class="koboSpan" id="kobo.121.1"> advanced open source memory forensics framework. </span><span class="koboSpan" id="kobo.121.2">The </span><a id="_idIndexMarker877"/><span class="koboSpan" id="kobo.122.1">primary tool within the framework is the Volatility Python script, which utilizes a wide array of plugins to analyze memory images. </span><span class="koboSpan" id="kobo.122.2">As a result, Volatility can be run on any operating system that supports Python. </span><span class="koboSpan" id="kobo.122.3">In addition, Volatility can be utilized against memory image files from most of the commonly distributed operating systems, including Windows for Windows XP to Windows Server 2016, macOS, and, finally, common </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">Linux distributions.</span></span></p>
<p><span class="koboSpan" id="kobo.124.1">A range of plugins is available for Volatility, with more being developed. </span><span class="koboSpan" id="kobo.124.2">To examine system memory, we will examine several plugins to ensure that you have sufficient information to conduct a proper analysis. </span><span class="koboSpan" id="kobo.124.3">However, before using Volatility, it is recommended that you ensure that your software is up to date and that any new plugins have been explored to determine their applicability to the current </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">incident investigation.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.126.1">Volatility versions</span></p>
<p class="callout"><span class="koboSpan" id="kobo.127.1">Volatility is</span><a id="_idIndexMarker878"/><span class="koboSpan" id="kobo.128.1"> currently in version 3, but version 2 is still in use, especially for analysts that may still need to analyze memory images from Windows XP or Server 2003 systems. </span><span class="koboSpan" id="kobo.128.2">The main difference between the two is that version 3 no longer requires the analyst to set a system profile for Volatility to correctly parse the memory image. </span><span class="koboSpan" id="kobo.128.3">In addition, there have been changes to the syntax of the various plugins. </span><span class="koboSpan" id="kobo.128.4">Ashley Pearson’s Volatility cheat sheet blog, available at </span><a href="https://blog.onfvp.com/post/volatility-cheatsheet/"><span class="koboSpan" id="kobo.129.1">https://blog.onfvp.com/post/volatility-cheatsheet/</span></a><span class="koboSpan" id="kobo.130.1">, shows </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">the differences.</span></span></p>
<h3><span class="koboSpan" id="kobo.132.1">Installing Volatility</span></h3>
<p><span class="koboSpan" id="kobo.133.1">Volatility is </span><a id="_idIndexMarker879"/><span class="koboSpan" id="kobo.134.1">available for Linux, Windows, and macOS. </span><span class="koboSpan" id="kobo.134.2">Information on </span><a id="_idIndexMarker880"/><span class="koboSpan" id="kobo.135.1">installing it on the various OSs is available at </span><a href="https://www.volatilityfoundation.org/releases"><span class="koboSpan" id="kobo.136.1">https://www.volatilityfoundation.org/releases</span></a><span class="koboSpan" id="kobo.137.1">. </span><span class="koboSpan" id="kobo.137.2">For this chapter, Volatility was installed on the Linux Ubuntu subsystem available on the Windows 10 OS. </span><span class="koboSpan" id="kobo.137.3">The following command will install Volatility on the Ubuntu subsystem, as well as other </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">Linux OSs:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.139.1">
forensics@ubuntu:~$ git clone https://github.com/volatilityfoundation/volatility3.git</span></pre>
<p><span class="koboSpan" id="kobo.140.1">This will produce the </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer176">
<span class="koboSpan" id="kobo.142.1"><img alt="Figure 10.1 – Installing Volatility " src="image/Image_B18571_10_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.143.1">Figure 10.1 – Installing Volatility</span></p>
<p><span class="koboSpan" id="kobo.144.1">Running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">ls</span></strong><span class="koboSpan" id="kobo.146.1"> command shows the various scripts and files that are part of the </span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">Volatility framework:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer177">
<span class="koboSpan" id="kobo.148.1"><img alt="Figure 10.2 – Verifying the Volatility installation " src="image/Image_B18571_10_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.149.1">Figure 10.2 – Verifying the Volatility installation</span></p>
<p><span class="koboSpan" id="kobo.150.1">You can</span><a id="_idIndexMarker881"/><span class="koboSpan" id="kobo.151.1"> access the help menu in Volatility by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.152.1">following command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer178">
<span class="koboSpan" id="kobo.153.1"><img alt="Figure 10.3 – Volatility help menu " src="image/Image_B18571_10_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.154.1">Figure 10.3 – Volatility help menu</span></p>
<h3><span class="koboSpan" id="kobo.155.1">Volatility commands</span></h3>
<p><span class="koboSpan" id="kobo.156.1">Volatility uses a </span><a id="_idIndexMarker882"/><span class="koboSpan" id="kobo.157.1">straightforward command structure. </span><span class="koboSpan" id="kobo.157.2">When using the Python file, as we are here, use Python 3 and then the Volatility Python file. </span><span class="koboSpan" id="kobo.157.3">Next, indicate the path to the file and finally the plugin. </span><span class="koboSpan" id="kobo.157.4">Additional parameters are dependent on the plugin; you will see this in several of the plugins that we will discuss. </span><span class="koboSpan" id="kobo.157.5">This is how the command line should look: </span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.158.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f &lt;Memory Image File&gt; &lt;operatingsystem.plugin&gt;</span></pre>
<p><span class="koboSpan" id="kobo.159.1">Let’s go ahead and cover some of the plugins we can leverage </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">with Volatility.</span></span></p>
<h3><span class="koboSpan" id="kobo.161.1">Volatility image information</span></h3>
<p><span class="koboSpan" id="kobo.162.1">First, we </span><a id="_idIndexMarker883"/><span class="koboSpan" id="kobo.163.1">will start by getting some initial information about the memory image and the system that it was obtained from. </span><span class="koboSpan" id="kobo.163.2">Even if the analyst is certain of the OS, it is still a good practice to run the memory images against Volatility’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.164.1">windows.info</span></strong><span class="koboSpan" id="kobo.165.1"> plugin. </span><span class="koboSpan" id="kobo.165.2">The output of this plugin identifies the potential profile of the memory image that becomes critical to utilizing the other plugins available. </span><span class="koboSpan" id="kobo.165.3">In general, the Volatility syntax is composed of the path to the memory image and the specific plugin. </span><span class="koboSpan" id="kobo.165.4">In this case, the following command </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">is used:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.167.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.info</span></pre>
<p><span class="koboSpan" id="kobo.168.1">This produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">following results:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer179">
<span class="koboSpan" id="kobo.170.1"><img alt="Figure 10.4 – The windows.info plugin " src="image/Image_B18571_10_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.171.1">Figure 10.4 – The windows.info plugin</span></p>
<p><span class="koboSpan" id="kobo.172.1">In this </span><a id="_idIndexMarker884"/><span class="koboSpan" id="kobo.173.1">case, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">NTBuildLab</span></strong><span class="koboSpan" id="kobo.175.1"> field indicates that the memory image is from a Windows XP machine. </span><span class="koboSpan" id="kobo.175.2">Next, let’s start analyzing the Windows process information. </span></p>
<h3><span class="koboSpan" id="kobo.176.1">Volatility process analysis</span></h3>
<p><span class="koboSpan" id="kobo.177.1">In keeping with the </span><a id="_idIndexMarker885"/><span class="koboSpan" id="kobo.178.1">SANS six-part methodology, the first of the plugins that will be discussed are those that provide data about the processes running on the system at the time of the memory capture. </span><span class="koboSpan" id="kobo.178.2">The aim here is to identify those processes that appear suspicious and to identify any related data associated </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">with them.</span></span></p>
<h4><span class="koboSpan" id="kobo.180.1">Process list</span></h4>
<p><span class="koboSpan" id="kobo.181.1">The </span><a id="_idIndexMarker886"/><span class="koboSpan" id="kobo.182.1">first of these will be the </span><strong class="source-inline"><span class="koboSpan" id="kobo.183.1">windows.pslist</span></strong><span class="koboSpan" id="kobo.184.1"> plugin. </span><span class="koboSpan" id="kobo.184.2">This</span><a id="_idIndexMarker887"/><span class="koboSpan" id="kobo.185.1"> plugin lists the current processes running in memory. </span><span class="koboSpan" id="kobo.185.2">This plugin outputs the offset, process name, PID, the number of threads and handles, and the date and time the process started and exited. </span><span class="koboSpan" id="kobo.185.3">Because the </span><strong class="source-inline"><span class="koboSpan" id="kobo.186.1">pslist</span></strong><span class="koboSpan" id="kobo.187.1"> plugin walks the doubly-linked list indicated by </span><strong class="bold"><span class="koboSpan" id="kobo.188.1">PsActiveProcessHead</span></strong><span class="koboSpan" id="kobo.189.1">, it </span><a id="_idIndexMarker888"/><span class="koboSpan" id="kobo.190.1">cannot detect hidden or unlinked processes. </span><span class="koboSpan" id="kobo.190.2">To execute this plugin, enter the following into the </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">Command Prompt:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.192.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.pslist</span></pre>
<p><span class="koboSpan" id="kobo.193.1">This will produce the </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer180">
<span class="koboSpan" id="kobo.195.1"><img alt="Figure 10.5 – Process list " src="image/Image_B18571_10_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.196.1">Figure 10.5 – Process list</span></p>
<p><span class="koboSpan" id="kobo.197.1">An initial</span><a id="_idIndexMarker889"/><span class="koboSpan" id="kobo.198.1"> analysis of the output does show a suspicious entry. </span><span class="koboSpan" id="kobo.198.2">Based on a cursory examination, a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.199.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.200.1"> was executed. </span><span class="koboSpan" id="kobo.200.2">This suspicion is largely based on the non-standard file name but as we get further into the process, we will get some more context and insight about </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">this file.</span></span></p>
<h4><span class="koboSpan" id="kobo.202.1">Process scan</span></h4>
<p><span class="koboSpan" id="kobo.203.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">windows.psscan</span></strong><span class="koboSpan" id="kobo.205.1"> plugin</span><a id="_idIndexMarker890"/><span class="koboSpan" id="kobo.206.1"> allows an analyst to examine processes that have been terminated. </span><span class="koboSpan" id="kobo.206.2">As </span><a id="_idIndexMarker891"/><span class="koboSpan" id="kobo.207.1">we discussed previously, </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">pslist</span></strong><span class="koboSpan" id="kobo.209.1"> only shows active processes. </span><strong class="source-inline"><span class="koboSpan" id="kobo.210.1">psscan</span></strong><span class="koboSpan" id="kobo.211.1"> can provide data about the possibility of a rootkit upon examining those processes that have been unlinked or hidden. </span><span class="koboSpan" id="kobo.211.2">The following command will execute </span><span class="No-Break"><span class="koboSpan" id="kobo.212.1">the plugin:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.213.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.psscan</span></pre>
<p><span class="koboSpan" id="kobo.214.1">This command produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer181">
<span class="koboSpan" id="kobo.216.1"><img alt="Figure 10.6 – Process scan " src="image/Image_B18571_10_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.217.1">Figure 10.6 – Process scan</span></p>
<p><span class="koboSpan" id="kobo.218.1">From the </span><a id="_idIndexMarker892"/><span class="koboSpan" id="kobo.219.1">output of this plugin, it does not appear that any additional processes have exited. </span><span class="koboSpan" id="kobo.219.2">The responder can then start to look at the existing processes for any that may appear to </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">be malicious.</span></span></p>
<h4><span class="koboSpan" id="kobo.221.1">Process tree</span></h4>
<p><span class="koboSpan" id="kobo.222.1">It is often </span><a id="_idIndexMarker893"/><span class="koboSpan" id="kobo.223.1">necessary for responders to see what parent processes that child processes are executed under. </span><span class="koboSpan" id="kobo.223.2">One indicator of a system being compromised is the identification of a process executed outside the normal parent process. </span><span class="koboSpan" id="kobo.223.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">windows.pstree</span></strong><span class="koboSpan" id="kobo.225.1"> plugin</span><a id="_idIndexMarker894"/><span class="koboSpan" id="kobo.226.1"> provides examiners with a tree-like structure that identifies the parent process that is executing a potential suspect process. </span><span class="koboSpan" id="kobo.226.2">The Cridex image is run with this plugin, utilizing the </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.228.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.pstree</span></pre>
<p><span class="koboSpan" id="kobo.229.1">This command produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.230.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer182">
<span class="koboSpan" id="kobo.231.1"><img alt="Figure 10.7 – Process tree " src="image/Image_B18571_10_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.232.1">Figure 10.7 – Process tree</span></p>
<p><span class="koboSpan" id="kobo.233.1">An analysis of the results from the three plugins shows an interesting entry. </span><span class="koboSpan" id="kobo.233.2">PID 1640 is associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.235.1"> executable. </span><span class="koboSpan" id="kobo.235.2">The responder may focus on this since it may not look like an application that should run. </span><span class="koboSpan" id="kobo.235.3">Further, the parent PID indicates that it was run via </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">Windows Explorer:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer183">
<span class="koboSpan" id="kobo.237.1"><img alt="Figure 10.8 – Suspicious processes " src="image/Image_B18571_10_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.238.1">Figure 10.8 – Suspicious processes</span></p>
<p><span class="koboSpan" id="kobo.239.1">From here, the</span><a id="_idIndexMarker895"/><span class="koboSpan" id="kobo.240.1"> responder can supplement the existing process data with additional data, such as which DLLs are loaded and other </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">ancillary data.</span></span></p>
<h4><span class="koboSpan" id="kobo.242.1">DLL list</span></h4>
<p><span class="koboSpan" id="kobo.243.1">Responders</span><a id="_idIndexMarker896"/><span class="koboSpan" id="kobo.244.1"> can also check the loaded DLL files associated with a process. </span><span class="koboSpan" id="kobo.244.2">This allows the analyst to determine whether a suspect process accessed these files when it was executed. </span><span class="koboSpan" id="kobo.244.3">For example, if a responder would like to examine the DLL files that are loaded as part of the suspect processes, PID 1640, the following command can </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">be run:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.246.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.dlllist --pid 1640</span></pre>
<p><span class="koboSpan" id="kobo.247.1">This command produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer184">
<span class="koboSpan" id="kobo.249.1"><img alt="Figure 10.9 – Associated DLL files " src="image/Image_B18571_10_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.250.1">Figure 10.9 – Associated DLL files</span></p>
<p><span class="koboSpan" id="kobo.251.1">From here, analysts may be able to determine some of the functionality of the process by analyzing the various DLL files that are loaded. </span><span class="koboSpan" id="kobo.251.2">Later in this chapter, these DLL files will be acquired for </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">further examination.</span></span></p>
<h4><span class="koboSpan" id="kobo.253.1">The windows.handles plugin</span></h4>
<p><span class="koboSpan" id="kobo.254.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">windows.handles</span></strong><span class="koboSpan" id="kobo.256.1"> plugin </span><a id="_idIndexMarker897"/><span class="koboSpan" id="kobo.257.1">allows analysts to view what types of handles are open in an </span><a id="_idIndexMarker898"/><span class="koboSpan" id="kobo.258.1">existing process. </span><span class="koboSpan" id="kobo.258.2">These handles are references to resources that are managed by the operating system. </span><span class="koboSpan" id="kobo.258.3">This data provides the responder with an understanding of the specific blocks of memory an application or process is using. </span><span class="koboSpan" id="kobo.258.4">This includes a wide variety of information, including registry keys and files associated with that process. </span><span class="koboSpan" id="kobo.258.5">To identify the open handles for PID 1640 that were previously identified, the following command can </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">be used:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.260.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.handles --pid 1640</span></pre>
<p><span class="koboSpan" id="kobo.261.1">This command produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.262.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer185">
<span class="koboSpan" id="kobo.263.1"><img alt="Figure 10.10 – Handles output " src="image/Image_B18571_10_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.264.1">Figure 10.10 – Handles output</span></p>
<p><span class="koboSpan" id="kobo.265.1">As the output indicates, the suspect process has several open handle processes, threads, and registry keys. </span><span class="koboSpan" id="kobo.265.2">These may become important data points moving forward and give some indication of the </span><a id="_idIndexMarker899"/><span class="koboSpan" id="kobo.266.1">behavior of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">reader_sl.exe</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.268.1"> executable.</span></span></p>
<h4><span class="koboSpan" id="kobo.269.1">LDR modules</span></h4>
<p><span class="koboSpan" id="kobo.270.1">A common practice </span><a id="_idIndexMarker900"/><span class="koboSpan" id="kobo.271.1">with malware coders is attempting to hide the activities of the malware. </span><span class="koboSpan" id="kobo.271.2">One technique is to attempt to hide the DLL files associated with the malicious code. </span><span class="koboSpan" id="kobo.271.3">This can be accomplished by unlinking the suspect DLL from</span><a id="_idIndexMarker901"/><span class="koboSpan" id="kobo.272.1"> the </span><strong class="bold"><span class="koboSpan" id="kobo.273.1">Process Environment Block</span></strong><span class="koboSpan" id="kobo.274.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.275.1">PEB</span></strong><span class="koboSpan" id="kobo.276.1">). </span><span class="koboSpan" id="kobo.276.2">While this may provide some obfuscation on the surface, there is still trace evidence of the DLL’s existence contained within the </span><strong class="bold"><span class="koboSpan" id="kobo.277.1">Virtual Address Descriptor</span></strong><span class="koboSpan" id="kobo.278.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.279.1">VAD</span></strong><span class="koboSpan" id="kobo.280.1">). </span><span class="koboSpan" id="kobo.280.2">The </span><a id="_idIndexMarker902"/><span class="koboSpan" id="kobo.281.1">VAD is a mechanism that identifies a DLL file’s base address and full path. </span><span class="koboSpan" id="kobo.281.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.282.1">windows.ldrmodules</span></strong><span class="koboSpan" id="kobo.283.1"> plugin</span><a id="_idIndexMarker903"/><span class="koboSpan" id="kobo.284.1"> compares the list of processes and determines if they are in the PEB. </span><span class="koboSpan" id="kobo.284.2">The following command runs </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">windows.ldrmodules</span></strong><span class="koboSpan" id="kobo.286.1"> against the Cridex </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">image file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.288.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.ldrmodules –pid 1640</span></pre>
<p><span class="koboSpan" id="kobo.289.1">This produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer186">
<span class="koboSpan" id="kobo.291.1"><img alt="Figure 10.11 – LDR modules output " src="image/Image_B18571_10_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.292.1">Figure 10.11 – LDR modules output</span></p>
<p><span class="koboSpan" id="kobo.293.1">A review of the output reveals an interesting entry on the top line. </span><span class="koboSpan" id="kobo.293.2">From this output, the </span><strong class="bold"><span class="koboSpan" id="kobo.294.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.295.1"> process does appear to have an issue associated with the DLL file. </span><span class="koboSpan" id="kobo.295.2">The indicator that this process is suspect is the </span><strong class="bold"><span class="koboSpan" id="kobo.296.1">False</span></strong><span class="koboSpan" id="kobo.297.1"> indicator in the </span><strong class="bold"><span class="koboSpan" id="kobo.298.1">InInit</span></strong><span class="koboSpan" id="kobo.299.1"> column for the first entry. </span><span class="koboSpan" id="kobo.299.2">This indicates that the executable has de-linked the DLL files and that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.301.1"> file </span><a id="_idIndexMarker904"/><span class="koboSpan" id="kobo.302.1">warrants </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">further investigation.</span></span></p>
<h4><span class="koboSpan" id="kobo.304.1">Malfind</span></h4>
<p><span class="koboSpan" id="kobo.305.1">Adversaries use a</span><a id="_idIndexMarker905"/><span class="koboSpan" id="kobo.306.1"> variety of code injection techniques to run malware. </span><span class="koboSpan" id="kobo.306.2">The Volatility </span><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">windows.malfind</span></strong><span class="koboSpan" id="kobo.308.1"> plugin</span><a id="_idIndexMarker906"/><span class="koboSpan" id="kobo.309.1"> displays ranges within memory that may contain injected code. </span><span class="koboSpan" id="kobo.309.2">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.311.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem windows.malfind</span></pre>
<p><span class="koboSpan" id="kobo.312.1">This produces the following </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1">abridged output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer187">
<span class="koboSpan" id="kobo.314.1"><img alt="Figure 10.12 – Malfind output " src="image/Image_B18571_10_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.315.1">Figure 10.12 – Malfind output</span></p>
<p><span class="koboSpan" id="kobo.316.1">In this screen </span><a id="_idIndexMarker907"/><span class="koboSpan" id="kobo.317.1">capture, the two processes, </span><strong class="source-inline"><span class="koboSpan" id="kobo.318.1">explorer.exe</span></strong><span class="koboSpan" id="kobo.319.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.321.1">, are indicated as executable due to the MZ header for both files. </span><span class="koboSpan" id="kobo.321.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">malfind</span></strong><span class="koboSpan" id="kobo.323.1"> plugin does not automatically indicate that the processes in question are malware but indicates further analysis should be conducted. </span><span class="koboSpan" id="kobo.323.2">In this case, we will look at extracting code associated with </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.325.1"> from memory, along with extracting the associated </span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">DLL files.</span></span></p>
<h4><span class="koboSpan" id="kobo.327.1">Dumpfiles</span></h4>
<p><span class="koboSpan" id="kobo.328.1">Now that we have</span><a id="_idIndexMarker908"/><span class="koboSpan" id="kobo.329.1"> identified the suspected file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.331.1">, let’s use </span><a id="_idIndexMarker909"/><span class="koboSpan" id="kobo.332.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">windows.dumpfiles</span></strong><span class="koboSpan" id="kobo.334.1"> plugin. </span><span class="koboSpan" id="kobo.334.2">In this case, the plugin requires an output file. </span><span class="koboSpan" id="kobo.334.3">In this case, we will output the </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">/home/forensics/EvidenceFiles/PID1640Dump</span></strong><span class="koboSpan" id="kobo.336.1"> directory. </span><span class="koboSpan" id="kobo.336.2">Finally, Process ID 1640 is used instead of a filename. </span><span class="koboSpan" id="kobo.336.3">The overall command looks </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.338.1">
forensics@ubuntu:~/volatility3$ python3 vol.py -f /home/forensics/EvidenceFiles/MemoryImages/cridex.vmem -o /home/forensics/EvidenceFiles/PID1640Dump/ windows.dumpfiles --pid 1640</span></pre>
<p><span class="koboSpan" id="kobo.339.1">This command outputs </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">the following:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer188">
<span class="koboSpan" id="kobo.341.1"><img alt="Figure 10.13 – Dumpfiles output " src="image/Image_B18571_10_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.342.1">Figure 10.13 – Dumpfiles output</span></p>
<p><span class="koboSpan" id="kobo.343.1">In this case, there are </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">.dat</span></strong><span class="koboSpan" id="kobo.345.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.346.1">.img</span></strong><span class="koboSpan" id="kobo.347.1"> files for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.349.1"> executable, along with the corresponding DLL files. </span><span class="koboSpan" id="kobo.349.2">By examining the </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">reader_sl.exe</span></strong><span class="koboSpan" id="kobo.351.1"> image file with a hex editor, we can see the </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">header information:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer189">
<span class="koboSpan" id="kobo.353.1"><img alt="Figure 10.14 – Hex view of reader_sl.exe " src="image/Image_B18571_10_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.354.1">Figure 10.14 – Hex view of reader_sl.exe</span></p>
<p><span class="koboSpan" id="kobo.355.1">Next, obtaining an </span><a id="_idIndexMarker910"/><span class="koboSpan" id="kobo.356.1">MD5 hash of the file output allows us to search VirusTotal for any information about the file. </span><span class="koboSpan" id="kobo.356.2">The hash can be obtained by running the </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.358.1">
forensics@ubuntu:~/EvidenceFiles/PID1640Dump$ md5sum file.0x821ccf90.0x82137c08.ImageSectionObject.reader_sl.exe.img</span></pre>
<p><span class="koboSpan" id="kobo.359.1">This outputs the </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">2a63509ad62eeeed0564dcb0981d90e1</span></strong><span class="koboSpan" id="kobo.361.1"> hash. </span><span class="koboSpan" id="kobo.361.2">A check of VirusTotal produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer190">
<span class="koboSpan" id="kobo.363.1"><img alt="Figure 10.15 – VirusTotal results " src="image/Image_B18571_10_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.364.1">Figure 10.15 – VirusTotal results</span></p>
<p><span class="koboSpan" id="kobo.365.1">While it might seem</span><a id="_idIndexMarker911"/><span class="koboSpan" id="kobo.366.1"> strange for there to only be anti-virus companies indicating that the file hash is malicious, this does bring up a point: Volatility will only output the code that is contained in memory and not the entire file. </span><span class="koboSpan" id="kobo.366.2">This is critical to keep in mind when extracting code. </span><span class="koboSpan" id="kobo.366.3">Even if the antivirus providers indicate it is not malicious, the file associated with the code may still be. </span><span class="koboSpan" id="kobo.366.4">Depending on the investigation, the data that’s extracted will have to go through a much more detailed malware analysis. </span></p>
<h2 id="_idParaDest-177"><a id="_idTextAnchor181"/><span class="koboSpan" id="kobo.367.1">Volatility Workbench</span></h2>
<p><span class="koboSpan" id="kobo.368.1">One aspect of </span><a id="_idIndexMarker912"/><span class="koboSpan" id="kobo.369.1">working with Volatility is using the command line. </span><span class="koboSpan" id="kobo.369.2">The main advantage of using Volatility in the command line is the ability to create scripts that automate the commands and output to text files. </span><span class="koboSpan" id="kobo.369.3">The drawback for analysts that are not used to working with Volatility and the command line is that they may need to continually reference commands or struggle with the correct syntax. </span></p>
<p><span class="koboSpan" id="kobo.370.1">An option for analysts that may want a GUI-based version of Volatility is PassMark Software’s Volatility Workbench. </span><span class="koboSpan" id="kobo.370.2">This tool </span><a id="_idIndexMarker913"/><span class="koboSpan" id="kobo.371.1">can be downloaded at </span><a href="https://www.osforensics.com/tools/volatility-workbench.html"><span class="koboSpan" id="kobo.372.1">https://www.osforensics.com/tools/volatility-workbench.html</span></a><span class="koboSpan" id="kobo.373.1"> and installed on a Windows platform. </span><span class="koboSpan" id="kobo.373.2">Once installed, the GUI allows the analyst to navigate to the image file and set the </span><strong class="bold"><span class="koboSpan" id="kobo.374.1">Platform</span></strong><span class="koboSpan" id="kobo.375.1"> and the </span><strong class="bold"><span class="koboSpan" id="kobo.376.1">Command</span></strong><span class="koboSpan" id="kobo.377.1"> processes. </span><span class="koboSpan" id="kobo.377.2">Once those are set, the Volatility command can be run. </span><span class="koboSpan" id="kobo.377.3">For example, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">windows.pslist</span></strong><span class="koboSpan" id="kobo.379.1"> plugin was run against a Windows </span><span class="No-Break"><span class="koboSpan" id="kobo.380.1">memory capture:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer191">
<span class="koboSpan" id="kobo.381.1"><img alt="Figure 10.16 – Volatility Workbench " src="image/Image_B18571_10_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.382.1">Figure 10.16 – Volatility Workbench</span></p>
<p><span class="koboSpan" id="kobo.383.1">The tool also </span><a id="_idIndexMarker914"/><span class="koboSpan" id="kobo.384.1">has additional functionality, such as logging all the commands and outputs, along with the ability to copy them to a clipboard so that the output can be included in the incident reporting. </span><span class="koboSpan" id="kobo.384.2">As stated previously, this is a solid option for analysts that do not need the additional functionality and flexibility of the </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">command line.</span></span></p>
<p><span class="koboSpan" id="kobo.386.1">Next, we will look at how to augment memory analysis using the simple Strings tool </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">and GREP.</span></span></p>
<h1 id="_idParaDest-178"><a id="_idTextAnchor182"/><span class="koboSpan" id="kobo.388.1">Memory analysis with Strings</span></h1>
<p><span class="koboSpan" id="kobo.389.1">In the previous</span><a id="_idIndexMarker915"/><span class="koboSpan" id="kobo.390.1"> section, the Volatility tools we looked at focused on those</span><a id="_idIndexMarker916"/><span class="koboSpan" id="kobo.391.1"> areas of the memory image that are mapped. </span><span class="koboSpan" id="kobo.391.2">If data is not mapped properly, these tools would be unable to extract the data and present it properly. </span><span class="koboSpan" id="kobo.391.3">This is one of the drawbacks of these tools for memory analysis. </span><span class="koboSpan" id="kobo.391.4">There is a good deal of data that will become unstructured and invisible to these tools. </span><span class="koboSpan" id="kobo.391.5">This could be the case when network connections are shut down or processes are exited. </span><span class="koboSpan" id="kobo.391.6">Even though they may not show up when the RAM is examined via Volatility, trace evidence will often still be present. </span><span class="koboSpan" id="kobo.391.7">Other evidence such as the pagefile also contains evidence that is unmapped </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">and searchable.</span></span></p>
<p><span class="koboSpan" id="kobo.393.1">One tool that is useful for extracting these traces is the Strings command, which is present in many Linux and Windows OSs. </span><span class="koboSpan" id="kobo.393.2">Strings allows a responder to search for human-readable strings of </span><a id="_idIndexMarker917"/><span class="koboSpan" id="kobo.394.1">characters. </span><span class="koboSpan" id="kobo.394.2">Given a set of keywords or </span><strong class="bold"><span class="koboSpan" id="kobo.395.1">Global Regular Expression Print</span></strong><span class="koboSpan" id="kobo.396.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.397.1">GREP)</span></strong><span class="koboSpan" id="kobo.398.1"> commands, the responder may be able to extract additional relative data, even from RAM captures that may have been corrupted via malware or </span><span class="No-Break"><span class="koboSpan" id="kobo.399.1">improper acquisitions.</span></span></p>
<h2 id="_idParaDest-179"><a id="_idTextAnchor183"/><span class="koboSpan" id="kobo.400.1">Installing Strings</span></h2>
<p><span class="koboSpan" id="kobo.401.1">Strings will</span><a id="_idIndexMarker918"/><span class="koboSpan" id="kobo.402.1"> often come preinstalled in many Linux distributions. </span><span class="koboSpan" id="kobo.402.2">Windows has a standalone</span><a id="_idIndexMarker919"/><span class="koboSpan" id="kobo.403.1"> executable for string searches available at </span><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/strings"><span class="koboSpan" id="kobo.404.1">https://docs.microsoft.com/en-us/sysinternals/downloads/strings</span></a><span class="koboSpan" id="kobo.405.1">. </span><span class="koboSpan" id="kobo.405.2">If Strings is not installed on the Linux platform of choice for the responder, the following command will </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">install it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.407.1">
forensics@ubuntu:~$ sudo apt install binutils</span></pre>
<p><span class="koboSpan" id="kobo.408.1">For a rather simple tool, Strings is a powerful way to search through bulk data for specific keyword-based strings. </span><span class="koboSpan" id="kobo.408.2">In this book, the focus will be on extracting specific data points with the following </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">Strings syntax:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.410.1">
forensics@ubuntu:~$  strings &lt;file name&gt; | grep &lt;Regular Expression&gt; </span></pre>
<h2 id="_idParaDest-180"><a id="_idTextAnchor184"/><span class="koboSpan" id="kobo.411.1">Common Strings searches</span></h2>
<p><span class="koboSpan" id="kobo.412.1">Network artifacts </span><a id="_idIndexMarker920"/><span class="koboSpan" id="kobo.413.1">such as IP addresses and domains can often be found within the pagefile or memory. </span><span class="koboSpan" id="kobo.413.2">To find IP addresses, use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">strings</span></strong><span class="koboSpan" id="kobo.415.1"> command with the </span><span class="No-Break"><span class="koboSpan" id="kobo.416.1">following parameters:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.417.1">
forensics@ubuntu:~$  strings pagefile.sys | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b"</span></pre>
<p><span class="koboSpan" id="kobo.418.1">To find URIs and URLs, use </span><strong class="source-inline"><span class="koboSpan" id="kobo.419.1">http</span></strong><span class="koboSpan" id="kobo.420.1"> or </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.421.1">https</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">, respectively:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.423.1">
forensics@ubuntu:~$  strings pagefile.sys  | grep "^https?://" | sort | uniq | less </span></pre>
<p><span class="koboSpan" id="kobo.424.1">There are also remnants of email addresses that may be discoverable. </span><span class="koboSpan" id="kobo.424.2">This is very useful in investigating possible phishing attempts. </span><span class="koboSpan" id="kobo.424.3">To find email addresses, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.426.1">
forensics@ubuntu:~$ strings pagefile.sys | egrep '([[:alnum:]_.-]{1,64}+@[[:alnum:]_.-]{2,255}+?\.[[:alpha:].]{2,4})'</span></pre>
<p><span class="koboSpan" id="kobo.427.1">There is a wide range of search terms and parameters, and it is impossible to cover all of them in this chapter. </span><span class="koboSpan" id="kobo.427.2">The main takeaway from this is that the analyst can leverage string searches across the memory image and pagefile as part of the overall </span><span class="No-Break"><span class="koboSpan" id="kobo.428.1">memory analysis.</span></span></p>
<h1 id="_idParaDest-181"><a id="_idTextAnchor185"/><span class="koboSpan" id="kobo.429.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.430.1">This chapter discussed two major topic areas of memory analysis. </span><span class="koboSpan" id="kobo.430.2">First, we covered the available data points and the methodology that can be followed. </span><span class="koboSpan" id="kobo.430.3">In addition, several tools, such as Volatility, Volatility Workbench, and Strings, have been explored. </span><span class="koboSpan" id="kobo.430.4">In addition to an overview of these tools, several of their features have been explored. </span><span class="koboSpan" id="kobo.430.5">This only scratches the surface of the number of features each of these tools has to offer the incident response analyst. </span><span class="koboSpan" id="kobo.430.6">These tools, taken in conjunction with a methodology for analyzing system RAM, can give the analyst a powerful tool for determining if a system has been compromised. </span><span class="koboSpan" id="kobo.430.7">With malware becoming more advanced, including malware that executes entirely in RAM, analysts must incorporate memory analysis into their capabilities. </span><span class="koboSpan" id="kobo.430.8">Marrying these techniques with network evidence collection can provide analysts and their organizations with a powerful tool to identify and remediate </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">an incident.</span></span></p>
<p><span class="koboSpan" id="kobo.432.1">In the next chapter, we will delve into examining a system’s </span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">permanent storage.</span></span></p>
<h1 id="_idParaDest-182"><a id="_idTextAnchor186"/><span class="koboSpan" id="kobo.434.1">Questions</span></h1>
<p><span class="koboSpan" id="kobo.435.1">Answer the following questions to test your knowledge of </span><span class="No-Break"><span class="koboSpan" id="kobo.436.1">this chapter:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.437.1">What are some of the data points that can be found via </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">memory analysis?</span></span><ol><li><span class="No-Break"><span class="koboSpan" id="kobo.439.1">Running processes</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.440.1">Network connection</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.441.1">Command history</span></span></li><li><span class="koboSpan" id="kobo.442.1">All of </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">the above</span></span></li></ol></li>
<li><span class="koboSpan" id="kobo.444.1">What is not part of the network connections methodology? </span><ol><li><span class="No-Break"><span class="koboSpan" id="kobo.445.1">Process name</span></span></li><li><span class="koboSpan" id="kobo.446.1">Parent </span><span class="No-Break"><span class="koboSpan" id="kobo.447.1">process ID</span></span></li><li><span class="koboSpan" id="kobo.448.1">Check for signs of </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">a rootkit</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.450.1">Associated entities</span></span></li></ol></li>
<li><span class="koboSpan" id="kobo.451.1">Dumping files associated with a process will never introduce malware into a </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">responder’s system.</span></span><ol><li><span class="No-Break"><span class="koboSpan" id="kobo.453.1">True</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.454.1">False</span></span></li></ol></li>
<li><span class="koboSpan" id="kobo.455.1">One of the primary goals of memory analysis is to acquire malicious processes or executables for </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">further analysis.</span></span><ol><li><span class="No-Break"><span class="koboSpan" id="kobo.457.1">True</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.458.1">False</span></span></li></ol></li>
</ol>
<h1 id="_idParaDest-183"><a id="_idTextAnchor187"/><span class="koboSpan" id="kobo.459.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.460.1">For more information about the topics covered in this chapter, refer to </span><span class="No-Break"><span class="koboSpan" id="kobo.461.1">the following:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.462.1">SANS Memory Forensics Cheat </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.463.1">Sheet</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.464.1">: </span></span><a href="https://digital-forensics.sans.org/blog/2017/12/11/updated-memory-forensics-cheat-sheet"><span class="No-Break"><span class="koboSpan" id="kobo.465.1">https://digital-forensics.sans.org/blog/2017/12/11/updated-memory-forensics-cheat-sheet</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.466.1">The Art of Memory </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.467.1">Forensics</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">: </span></span><a href="https://www.memoryanalysis.net/amf"><span class="No-Break"><span class="koboSpan" id="kobo.469.1">https://www.memoryanalysis.net/amf</span></span></a></li>
</ul>
</div>
<div>
<div id="_idContainer193">
</div>
</div>
</body></html>