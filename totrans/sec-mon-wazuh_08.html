<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-215"><a id="_idTextAnchor214"/>8</h1>
<h1 id="_idParaDest-216"><a id="_idTextAnchor215"/>Appendix</h1>
<p>We have now reached the <em class="italic">Appendix</em> chapter. Here, we will cover several custom Wazuh rules. Wazuh has already built thousands of rules to enhance its detection capabilities. However, we will write some important custom Wazuh rules to detect PowerShell, Linux Auditd, Kaspersky, and Symon-related alerts. This chapter covers the following topics:</p>
<ul>
<li>Custom PowerShell rules</li>
<li>Custom Auditd rules</li>
<li>Custom Kaspersky Endpoint Security rules</li>
<li>Custom Sysmon rules</li>
</ul>
<h1 id="_idParaDest-217"><a id="_idTextAnchor216"/>Custom PowerShell rules</h1>
<p>To enhance the Wazuh detection capabilities for Windows machines, we need to integrate some <a id="_idIndexMarker840"/>custom PowerShell Wazuh rules. Each rule can be created with specific conditions, severity levels, and other optional configurations. We will cover the following types of rules in this section:</p>
<ul>
<li>PowerShell event information</li>
<li>PowerShell error logs</li>
<li>PowerShell warning logs</li>
<li>PowerShell critical logs</li>
</ul>
<h2 id="_idParaDest-218"><a id="_idTextAnchor217"/>PowerShell event information</h2>
<p>We can <a id="_idIndexMarker841"/>create a custom PowerShell <a id="_idIndexMarker842"/>rule to get event information, as shown in the following:</p>
<pre class="source-code">
&lt;rule id="200101" level="1"&gt;
    &lt;if_sid&gt;60009&lt;/if_sid&gt;
    &lt;field name="win.system.providerName"&gt;^PowerShell$&lt;/field&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
    &lt;group&gt;windows_powershell,&lt;/group&gt;
    &lt;description&gt;PowerShell Log Information&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker843"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;60009&lt;/if_sid&gt;</code>: This represents the list of rule IDs. It will match <a id="_idIndexMarker844"/>when a rule ID on the list has previously matched. Rule ID <code>60009</code> is a pre-built Wazuh rule for Windows informational events.</li>
<li><code>&lt;field name="win.system.providerName"&gt;^PowerShell$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite to trigger the rule. It will check for a match in the content of a field extracted by the decoder. In this case, it will check whether the <code>win.system.providerName</code> log field has the <code>PowerShell</code> keyword.</li>
<li><code>&lt;group&gt;windows_powershell,&lt;/group&gt;</code>: This enforces that the alert will be categorized under a specific group. In this case, it is <code>windows_powershell</code>.</li>
</ul>
<h2 id="_idParaDest-219"><a id="_idTextAnchor218"/>PowerShell error logs</h2>
<p>PowerShell <a id="_idIndexMarker845"/>error logs typically contain <a id="_idIndexMarker846"/>information related to errors, warnings, and other events. To detect such PowerShell error logs, we can create custom Wazuh rules, as shown here:</p>
<pre class="source-code">
&lt;rule id="200102" level="7"&gt;
    &lt;if_sid&gt;60011&lt;/if_sid&gt;
    &lt;field name="win.system.providerName"&gt;^Microsoft-Windows-PowerShell$&lt;/field&gt;
    &lt;mitre&gt;
      &lt;id&gt;T1086&lt;/id&gt;
    &lt;/mitre&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
    &lt;group&gt;windows_powershell,&lt;/group&gt;
    &lt;description&gt;Powershell Error logs&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker847"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;60011&lt;/if_sid&gt;</code>: This represents the list of rule IDs. It will match <a id="_idIndexMarker848"/>when a rule ID on the list has previously matched. Rule ID <code>60011</code> is a pre-built Wazuh rule for Windows error events.</li>
<li><code>&lt;field name="win.system.providerName"&gt;^Microsoft-Windows-PowerShell$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite to trigger the rule. It will check for a match in the content of a field extracted by the decoder. In this case, it will check whether the <code>win.system.providerName</code> log field has the <code>Microsoft-Windows-PowerShell</code> keyword.</li>
<li><code>&lt;group&gt;windows_powershell,&lt;/group&gt;</code>: This enforces that the alert will be categorized under a specific group. In this case, it is <code>windows_powershell</code>.</li>
</ul>
<h2 id="_idParaDest-220"><a id="_idTextAnchor219"/>PowerShell warning logs</h2>
<p>PowerShell <a id="_idIndexMarker849"/>also generates non-critical <a id="_idIndexMarker850"/>alerts during script execution. This is helpful for security investigation. To detect such alerts on the Wazuh manager, we can create custom Wazuh rules, as shown here:</p>
<pre class="source-code">
&lt;rule id="200103" level="5"&gt;
    &lt;if_sid&gt;200101&lt;/if_sid&gt;
    &lt;field name="win.system.providerName"&gt;^Microsoft-Windows-PowerShell$&lt;/field&gt;
    &lt;field name="win.system.severityValue"&gt;^WARNING$&lt;/field&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
    &lt;group&gt;windows_powershell,&lt;/group&gt;
    &lt;description&gt;Powershell Warning Event&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker851"/>have the following:</p>
<ul>
<li><code>&lt;field name="win.system.providerName"&gt;^Microsoft-Windows-PowerShell$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite <a id="_idIndexMarker852"/>to trigger the rule. It will check for a match in the content of a field extracted by the decoder. In this case, it will check whether the <code>win.system.providerName</code> log field has the <code>Microsoft-Windows-PowerShell</code> keyword.</li>
<li><code>&lt;field name="win.system.severityValue"&gt;^WARNING$&lt;/field&gt;</code>: It will check whether the <code>win.system.severityValue</code> log field has the <code>WARNING</code> keyword.</li>
<li><code>&lt;group&gt;windows_powershell,&lt;/group&gt;</code>: This enforces that the alert will be categorized under a specific group. In this case, it is <code>windows_powershell</code>.</li>
</ul>
<h2 id="_idParaDest-221"><a id="_idTextAnchor220"/>PowerShell critical logs</h2>
<p>PowerShell <a id="_idIndexMarker853"/>generates critical alerts <a id="_idIndexMarker854"/>where there are some severe errors during execution. To detect such alerts, we can create custom Wazuh rules, as shown here:</p>
<pre class="source-code">
&lt;rule id="200103" level="12"&gt;
    &lt;if_sid&gt;60012&lt;/if_sid&gt;
    &lt;field name="win.system.providerName"&gt;^Microsoft-Windows-PowerShell$&lt;/field&gt;
    &lt;mitre&gt;
      &lt;id&gt;T1086&lt;/id&gt;
    &lt;/mitre&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
    &lt;group&gt;windows_powershell,&lt;/group&gt;
    &lt;description&gt;Powershell Critical EventLog&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker855"/>have the following:</p>
<ul>
<li><code>&lt;field name="win.system.severityValue"&gt;^WARNING$&lt;/field&gt;</code>: It will check <a id="_idIndexMarker856"/>whether the <code>win.system.severityValue</code> log field has the <code>WARNING</code> keyword.</li>
<li><code>&lt;group&gt;windows_powershell,&lt;/group&gt;</code>: This enforces that the alert will be categorized under a specific group. In this case, it is <code>windows_powershell</code>.</li>
</ul>
<p>This completes some of the important custom PowerShell rules. In the next section, we will cover Wazuh rules for Linux Auditd modules.</p>
<h1 id="_idParaDest-222"><a id="_idTextAnchor221"/>Custom Wazuh rules for Auditd</h1>
<p>Custom Wazuh <a id="_idIndexMarker857"/>rules for Auditd provide a tailored method to enhance Wazuh’s capabilities to detect Linux command executions. This will also help the security team to detect critical security events, track user activities, and ensure regulatory compliance.</p>
<h2 id="_idParaDest-223"><a id="_idTextAnchor222"/>Auditd syscall rule</h2>
<p>We can <a id="_idIndexMarker858"/>create a Wazuh rule to detect any <a id="_idIndexMarker859"/>system call (syscall) events, as written here:</p>
<pre class="source-code">
  &lt;rule id="200200" level="3"&gt;
    &lt;decoded_as&gt;auditd-syscall&lt;/decoded_as&gt;
    &lt;description&gt;Auditd: System Calls Event &lt;/description&gt;
    &lt;group&gt;syscall,&lt;/group&gt;
  &lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;decoded_as&gt;auditd-syscall&lt;/decoded_as&gt;</code>: This represents a requisite to trigger the rule. It will be triggered only if the event has been decoded by a specific <code>decoder</code>. In this case, it is <code>auditd-syscall</code>.</li>
</ul>
<h2 id="_idParaDest-224"><a id="_idTextAnchor223"/>Auditd path</h2>
<p>Linux Auditd <a id="_idIndexMarker860"/>generates an event for every path record. We will create <a id="_idIndexMarker861"/>a Wazuh rule to capture the event for Auditd path messages, as shown:</p>
<pre class="source-code">
  &lt;rule id="200201" level="3"&gt;
    &lt;decoded_as&gt;auditd-path&lt;/decoded_as&gt;
    &lt;description&gt;Auditd: Path Message event.&lt;/description&gt;
    &lt;group&gt;path,&lt;/group&gt;
  &lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;decoded_as&gt;auditd-syscall&lt;/decoded_as&gt;</code>: This represents a requisite to trigger the rule. It will be triggered only if the event has been decoded by a specific <code>decoder</code>. In this case, it is <code>auditd-path</code>.</li>
</ul>
<h2 id="_idParaDest-225"><a id="_idTextAnchor224"/>Detecting a change in the user environment</h2>
<p>To <a id="_idIndexMarker862"/>detect any changes <a id="_idIndexMarker863"/>in the user environment, we can create a custom Wazuh rule to detect changes in <code>bash_profile</code>, as written here:</p>
<pre class="source-code">
&lt;rule id="200202" level="12"&gt;
  &lt;if_sid&gt;200201&lt;/if_sid&gt;
  &lt;list field="audit.directory.name" lookup="address_match_key"&gt;etc/lists/bash_profile&lt;/list&gt;
  &lt;description&gt; Auditd: Detects change of user environment&lt;/description&gt;
  &lt;group&gt;path,&lt;/group&gt;
  &lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;list field="audit.directory.name" lookup="address_match_key"&gt;etc/lists/bash_profile&lt;/list&gt;</code>: The <code>&lt;list&gt;</code> tag performs a CDB lookup, and the <code>field</code> attribute is used as a key in the CBD list. In this case, the CDB list <code>audit.directory.name</code> is used and <code>address_match_key</code> is used to search for the IP address and key.</li>
</ul>
<p>We’ve learned how to build custom Wazuh rules for Linux Auditd modules. In the next section, we will build Wazuh rules for Kaspersky Endpoint Security solutions.</p>
<h1 id="_idParaDest-226"><a id="_idTextAnchor225"/>Custom Wazuh rules for Kaspersky Endpoint Security</h1>
<p><strong class="bold">Kaspersky Endpoint Security</strong> is a leading security provider, delivering cloud security, embedded <a id="_idIndexMarker864"/>security, threat management, and <a id="_idIndexMarker865"/>industrial security. To enhance Wazuh’s capability to detect Kaspersky endpoint alerts, we need to create custom Wazuh rules. In this section, we will cover the following topics:</p>
<ul>
<li>Kaspersky’s general rules</li>
<li>Rules to detect events when a Kaspersky agent restarts</li>
<li>Rules for quarantine alerts</li>
</ul>
<h2 id="_idParaDest-227"><a id="_idTextAnchor226"/>Kaspersky’s general rules</h2>
<p>Kaspersky <a id="_idIndexMarker866"/>Endpoint Security generates some general alerts. To detect those alerts, the following Wazuh rule needs to be created:</p>
<pre class="source-code">
  &lt;rule id="200300" level="0"&gt;
    &lt;if_sid&gt;60009&lt;/if_sid&gt;
    &lt;field name="win.system.channel"&gt;^Kaspersky Event Log$&lt;/field&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
    &lt;description&gt;Kapersky rule for the System channel&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;field name="win.system.channel"&gt;^Kaspersky Event Log$&lt;/field&gt;</code>: It will check whether the <code>win.system.channel</code> log field  has the <code>Kaspersky Event </code><code>Log</code> keyword</li>
</ul>
<h2 id="_idParaDest-228"><a id="_idTextAnchor227"/>Rules to detect events when the Kaspersky agent restarts</h2>
<p>To <a id="_idIndexMarker867"/>detect events when the Kaspersky agent restarts, a custom Wazuh rule needs to be created, as shown here:</p>
<pre class="source-code">
&lt;rule id="200301" level="10"&gt;
   &lt;if_sid&gt;200300&lt;/if_sid&gt;
   &lt;field name="win.system.providerName"&gt;klnagent&lt;/field&gt;
     &lt;field name="win.system.eventID"&gt;1&lt;/field&gt;
     &lt;description&gt;Kaspersky Agent Restarted&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker868"/>have the following:</p>
<ul>
<li><code>&lt;field name="win.system.providerName"&gt;klnagent&lt;/field&gt;</code>: It will check whether the <code>win.system.providerName</code> log field has the <code>klnagent&lt;field name="win.system.eventID"&gt;1&lt;/field&gt;</code> keyword. This represents another field within the Windows event log. This rule triggers if the value of <code>eventID</code> is <code>1</code>. In Windows event logging, <code>eventID</code> 1 often represents system startup or the start of a logging session or a restart of the Windows Time service.</li>
</ul>
<h2 id="_idParaDest-229"><a id="_idTextAnchor228"/>Rules for quarantine alert</h2>
<p>To <a id="_idIndexMarker869"/>detect whether a suspicious file has been quarantined, we can a custom Wazuh rule to trigger the alert, as shown here:</p>
<pre class="source-code">
&lt;rule id="200302" level="10"&gt;
   &lt;if_sid&gt;200300&lt;/if_sid&gt;
   &lt;field name="win.system.providerName"&gt;klnagent&lt;/field&gt;
   &lt;field name="win.system.message" type="pcre2"&gt;(?i)^"Quarantine&lt;/field&gt;
     &lt;description&gt;Kaspersky Agent - Quarantine Event&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;field name="win.system.message" type="pcre2"&gt;(?i)^"Quarantine&lt;/field&gt;</code>: It will check whether the <code>win.system.message</code> log field has the <code>Quarantine.&lt;field name="win.system.message" type="pcre2"&gt;(?i)^"Quarantine&lt;/field&gt;</code> keyword. This specifies another field within the Windows event log; this time it is the <code>message</code> field. This rule triggers if the message contains the <code>Quarantine</code> keyword. This is done <a id="_idIndexMarker870"/>by using a regular expression library called <strong class="bold">Perl Compatible Regular </strong><strong class="bold">Expressions</strong> (<strong class="bold">PCRE2</strong>).</li>
</ul>
<p>We have learned how to build custom Wazuh rules to detect Kaspersky Endpoint Security events. In the next section, we will build custom rules to detect Sysmon events.</p>
<h1 id="_idParaDest-230"><a id="_idTextAnchor229"/>Custom Wazuh rules for Sysmon</h1>
<p><strong class="bold">Sysmon</strong> – a Windows Sysinternals tool – provides an in-depth view into system-related activities. Sysmon helps <a id="_idIndexMarker871"/>us detect a wide range of activities, such as process <a id="_idIndexMarker872"/>creation, file creation and modification, registry changes, driver loading, DLL loading, named pipe creation, process access, and DNS query logging. In order to expand Wazuh’s detection capability, we need to build a custom Wazuh rule to generate alerts. There is a total of 30 Sysmon events, as explained on the <a id="_idIndexMarker873"/>official Microsoft website (<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon">https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon</a>). However, we will cover the most important Sysmon events that are mapped with some specific MITRE ATT&amp;CK techniques. These rules are developed by taking reference from the official GitHub account of SOCFortress – a SaaS-based cybersecurity platform. You can also refer to the list of all the Wazuh rules mapped with MITRE techn<a href="https://github.com/socfortress/Wazuh-Rules/tree/main/Windows_Sysmon">iques against Sysmon events here: https://github.com/socfortress/Wa</a>zuh-Rules/tree/main/Windows_Sysmon. In this section, we will cover some of the important Sysmon events, as mentioned here:</p>
<ul>
<li>Sysmon Event 1: Process Creation</li>
<li>Sysmon Event 2: Process changed a File Creation Time</li>
<li>Sysmon Event 3: Network Connection</li>
<li>Sysmon Event 7: Image loaded</li>
<li>Sysmon Event 10: Process Access</li>
<li>Sysmon Event 11: File Creation</li>
<li>Sysmon Event 12: Registry Event (Object create and delete)</li>
<li>Sysmon Event 13: Registry Event (Value Set)</li>
<li>Sysmon Event 14: Registry Event (Key and Value Rename)</li>
<li>Sysmon Event 15: File  Creation StreamHash</li>
<li>Sysmon Event 17: Pipe Creation</li>
<li>Sysmon Event 18: Pipe Event</li>
<li>Sysmon Event 22: DNS Request</li>
</ul>
<h2 id="_idParaDest-231"><a id="_idTextAnchor230"/>Sysmon Event 1: Process Creation</h2>
<p>A Wazuh <a id="_idIndexMarker874"/>rule for the detection of a <em class="italic">Process Creation</em> event allows the security team to monitor suspicious unauthorized processes being executed and is written as follows:</p>
<pre class="source-code">
&lt;rule id="200401" level="3"&gt;
    &lt;if_sid&gt;61603&lt;/if_sid&gt;
    &lt;description&gt;Sysmon - Event 1: Process creation $(win.eventdata.description)&lt;/description&gt;
    &lt;mitre&gt;
&lt;id&gt;T1546&lt;/id&gt;
&lt;/mitre&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
    &lt;group&gt;sysmon_event1,windows_sysmon_event1,&lt;/group&gt;
  &lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61603&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200401</code> will be triggered only when the parent rule <code>61603</code> matches. Rule ID <code>61603</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<h2 id="_idParaDest-232"><a id="_idTextAnchor231"/>Sysmon Event 2: Process changed a File Creation Time</h2>
<p>The File Creation event of the Sysmon module detects the creation of potentially infected <a id="_idIndexMarker875"/>files or unexpected file changes, providing insights into file-based malware threats. The custom Wazuh rule for Sysmon Event 2 can be created as follows:</p>
<pre class="source-code">
&lt;rule id="200402" level="3"&gt;
  &lt;if_sid&gt;61604&lt;/if_sid&gt;
  &lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1099,technique_name=Timestomp$&lt;/field&gt;
  &lt;description&gt;Sysmon - Event 2: A process changed a file creation time by $(win.eventdata.image)&lt;/description&gt;
  &lt;mitre&gt;
  &lt;id&gt;T1099&lt;/id&gt;
  &lt;/mitre&gt;
  &lt;options&gt;no_full_log&lt;/options&gt;
  &lt;group&gt;sysmon_event2,&lt;/group&gt;
  &lt;/rule&gt;
&lt;/group&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61604&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200402</code> will be triggered only when the parent rule <code>61604</code> matches. Rule ID <code>61604</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<h2 id="_idParaDest-233"><a id="_idTextAnchor232"/>Sysmon Event 3: Network Connection</h2>
<p>Sysmon <a id="_idIndexMarker876"/>Event 3 is generated when it detects any unusual or unauthorized network connections. To detect such a network connection, we can create a custom Wazuh rule, as shown here:</p>
<pre class="source-code">
&lt;rule id="200403" level="3"&gt;
&lt;if_sid&gt;61605&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1021,technique_name=Remote Services$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 3: Network connection by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1021&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event3,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61605&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200403</code> will be triggered only when the parent rule <code>61605</code> matches. Rule ID <code>61605</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<h2 id="_idParaDest-234"><a id="_idTextAnchor233"/>Sysmon Event 7: Image loaded</h2>
<p>The <a id="_idIndexMarker877"/>Image Loaded event is generated when malicious code is injected into a normal process. The Wazuh rule to detect such events is shown here:</p>
<pre class="source-code">
&lt;rule id="200404" level="3"&gt;
&lt;if_sid&gt;61609&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1059.001,technique_name=PowerShell$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 7: Image loaded by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1059&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event7,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker878"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61609&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200404</code> will be triggered only when the parent rule <code>61609</code> matches. Rule ID <code>61609</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<h2 id="_idParaDest-235"><a id="_idTextAnchor234"/>Sysmon Event 10: Process Access</h2>
<p>The Process Access event helps the security team to detect suspicious activities such as process <a id="_idIndexMarker879"/>memory modification or injection, often linked to an advanced attack chain. To visualize such events, the following Wazuh rule needs to be created:</p>
<pre class="source-code">
&lt;rule id="200405" level="3"&gt;
&lt;if_sid&gt;61612&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1003,technique_name=Credential Dumping$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 10: ProcessAccess by $(win.eventdata.sourceimage)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1003&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event_10,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker880"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61612&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200405</code> will be triggered only when the parent rule <code>61612</code> matches. Rule ID <code>61612</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<h2 id="_idParaDest-236"><a id="_idTextAnchor235"/>Sysmon Event 11: File Creation</h2>
<p>The File Creation event provides redundancy for file creation monitoring and helps provide <a id="_idIndexMarker881"/>maximum coverage for file-based malware threats. A Wazuh rule to detect such events can be created, as shown here:</p>
<pre class="source-code">
&lt;rule id="200406" level="3"&gt;
&lt;if_sid&gt;61613&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1546.011,technique_name=Application Shimming$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 11: FileCreate by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1546&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event_11,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker882"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61613&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200406</code> will be triggered only when the parent rule <code>61613</code> matches. Rule ID <code>61609</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<h2 id="_idParaDest-237"><a id="_idTextAnchor236"/>Sysmon Event 12: Registry Event (Object create and delete)</h2>
<p>Sysmon Event 12 captures logs when a new registry key or subkey is created or an existing <a id="_idIndexMarker883"/>one is deleted. This is useful for detecting unauthorized changes to the registry, which may indicate the presence of file-less malware. A Wazuh rule can be created to detect such events, as shown here:</p>
<pre class="source-code">
&lt;rule id="200407" level="3"&gt;
&lt;if_sid&gt;61614&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1546.011,technique_name=Application Shimming$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 12: RegistryEvent (Object create and delete) by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1546&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event_12,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker884"/>have the following</p>
<ul>
<li><code>&lt;if_sid&gt;61614&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200407</code> will be triggered only when the parent rule <code>61614</code> matches. Rule ID <code>61614</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<h2 id="_idParaDest-238"><a id="_idTextAnchor237"/>Sysmon Event 13: Registry Event(Value Set)</h2>
<p>Sysmon Event 13 is triggered when a new value is set, or an existing value is modified within <a id="_idIndexMarker885"/>a registry key. This event is important to detect changes related to malware persistence or privilege escalation techniques. A Wazuh rule can be created to detect such an event, as shown here:</p>
<pre class="source-code">
&lt;rule id="200408" level="3"&gt;
&lt;if_sid&gt;61615&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1546.011,technique_name=Application Shimming$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 13: RegistryEvent (Value Set) by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1546&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event_13,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61615&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200408</code> will be triggered only when the parent rule <code>61615</code> matches. Rule ID <code>61615</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
<li><code>&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1546.011,technique_name=Application Shimming$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite to trigger the rule. It will check for a match in the <a id="_idIndexMarker886"/>content of a field extracted by the decoder. In this case, it will check whether the <code>win.eventdata.RuleName</code> log field has the <code>technique_id=T1546.011,technique_name=Application Shimming </code><code>l</code> keywords.</li>
</ul>
<h2 id="_idParaDest-239"><a id="_idTextAnchor238"/>Sysmon Event 14: Registry Event(Key and Value Rename)</h2>
<p>Sysmon Event 14 is triggered when a registry key or value is renamed. These techniques can <a id="_idIndexMarker887"/>be used by advanced attackers to evade anti-malware detection or disrupt the system. A Wazuh rule can be created to detect such events, as written here:</p>
<pre class="source-code">
&lt;rule id="200409" level="3"&gt;
  &lt;if_sid&gt;61616&lt;/if_sid&gt;
  &lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1546.011,technique_name=Application Shimming$&lt;/field&gt;
  &lt;description&gt;Sysmon - Event 14: RegistryEvent (Key and Value Rename) by $(win.eventdata.image)&lt;/description&gt;
  &lt;mitre&gt;
  &lt;id&gt;T1546&lt;/id&gt;
  &lt;/mitre&gt;
  &lt;options&gt;no_full_log&lt;/options&gt;
  &lt;group&gt;sysmon_event_14,&lt;/group&gt;
  &lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker888"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61616&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200409</code> will be triggered only when the parent rule <code>61615</code> matches. Rule ID <code>61615</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
<li><code>&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1546.011,technique_name=Application Shimming$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite to trigger the rule. It will check for a match in the content of a field extracted by the decoder. In this case, it will check whether the <code>win.eventdata.RuleName</code> log field has the <code>technique_id=T1546.011,technique_name=Application Shimming </code><code>l</code> keyword.</li>
</ul>
<h2 id="_idParaDest-240"><a id="_idTextAnchor239"/>Sysmon Event 15: File Creation StreamHash</h2>
<p>Sysmon Event 15 captures the file creation activities with the hash of the file. To create a Wazuh <a id="_idIndexMarker889"/>rule to detect such events, we can create a custom rule, as shown here:</p>
<pre class="source-code">
  &lt;rule id="200410" level="3"&gt;
  &lt;if_sid&gt;61617&lt;/if_sid&gt;
  &lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1089,technique_name=Drive-by Compromise$&lt;/field&gt;
  &lt;description&gt;Sysmon - Event 15: FileCreateStreamHash by $(win.eventdata.image)&lt;/description&gt;
  &lt;mitre&gt;
  &lt;id&gt;T1089&lt;/id&gt;
  &lt;/mitre&gt;
  &lt;options&gt;no_full_log&lt;/options&gt;
  &lt;group&gt;sysmon_event_15,&lt;/group&gt;
  &lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker890"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61617&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200410</code> will be triggered only when the parent rule <code>61617</code> matches. Rule ID <code>61617</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
<li><code>&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1089,technique_name=Drive-by Compromise$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite to trigger the rule. It will check for a match in the content of a field extracted by the decoder. In this case, it will check whether the <code>win.eventdata.RuleName</code> log field has the <code>technique_id=T1089,technique_name=Drive-by Compromise </code><code>l</code> keyword.</li>
</ul>
<h2 id="_idParaDest-241"><a id="_idTextAnchor240"/>Sysmon Event 17: Pipe Creation</h2>
<p>Sysmon Event 17 records the creation of named pipes, which allows for inter-process communication <a id="_idIndexMarker891"/>on a system. This helps to identify any suspicious activities related to the setting up of named pipes. A custom Wazuh rule can be built to detect such events, as shown here:</p>
<pre class="source-code">
&lt;rule id="200411" level="3"&gt;
&lt;if_sid&gt;61646&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1021.002,technique_name=SMB/Windows Admin Shares$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 17: PipeEvent (Pipe Created) by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1021&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event_17,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker892"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61646&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200411</code> will be triggered only when the parent rule <code>61646</code> matches. Rule ID <code>61646</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
<li><code>&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1021.002,technique_name=SMB/Windows Admin Shares$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite to trigger the rule. It will check for a match in the content of a field extracted by the decoder. In this case, it will check whether the <code>win.eventdata.RuleName</code> log field has the<code> "technique_id=T1021.002,technique_name=SMB/Windows Admin </code><code>Shares</code> keyword.</li>
</ul>
<h2 id="_idParaDest-242"><a id="_idTextAnchor241"/>Sysmon Event 18: Pipe Event</h2>
<p>Sysmon <a id="_idIndexMarker893"/>Event 18 captures additional information about pipes, such as opening, closing, or reading to named pipes, and helps in detecting anomalous behavior in the system. A Wazuh rule can be created to detect such events, as written here:</p>
<pre class="source-code">
&lt;rule id="200412" level="3"&gt;
&lt;if_sid&gt;61647&lt;/if_sid&gt;
&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1021.002,technique_name=SMB/Windows Admin Shares$&lt;/field&gt;
&lt;description&gt;Sysmon - Event 18: PipeEvent (Pipe Connected) by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1021&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event_18,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker894"/>have the following</p>
<ul>
<li><code>&lt;if_sid&gt;61647&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200412</code> will be triggered only when the parent rule <code>61647</code> matches. Rule ID <code>61646</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
<li><code>&lt;field name="win.eventdata.RuleName"&gt;^technique_id=T1021.002,technique_name=SMB/Windows Admin Shares$&lt;/field&gt;</code>: The <code>&lt;field&gt;</code> tag is used as a requisite to trigger the rule. It will check for a match in the content of a field extracted by the decoder. In this case, it will check whether the <code>win.eventdata.RuleName</code> log field has the <code>technique_id=T1021.002,technique_name=SMB/Windows Admin </code><code>Shares</code> keyword.</li>
</ul>
<h2 id="_idParaDest-243"><a id="_idTextAnchor242"/>Sysmon Event 22: DNS Request</h2>
<p>Sysmon Event 22 records DNS requests initiated by processes on the machine. This helps us to monitor <a id="_idIndexMarker895"/>requests to potentially malicious servers or commands and control centers. A Wazuh rule to detect such DNS requests can created, as shown:</p>
<pre class="source-code">
&lt;rule id="200413" level="3"&gt;
&lt;if_sid&gt;61644&lt;/if_sid&gt;
&lt;description&gt;Sysmon - Event 22: DNS Request by $(win.eventdata.image)&lt;/description&gt;
&lt;mitre&gt;
&lt;id&gt;T1071&lt;/id&gt;
&lt;/mitre&gt;
&lt;options&gt;no_full_log&lt;/options&gt;
&lt;group&gt;sysmon_event_22,&lt;/group&gt;
&lt;/rule&gt;</pre> <p>Here, we <a id="_idIndexMarker896"/>have the following:</p>
<ul>
<li><code>&lt;if_sid&gt;61644&lt;/if_sid&gt;</code>: The <code>&lt;if_sid&gt;</code> tag is used as a requisite to trigger the rule. In this case, rule <code>200412</code> will be triggered only when the parent rule <code>61644</code> matches. Rule ID <code>61644</code> is already created in the Wazuh manager under the filename <code>0595-win-sysmon_rules.xml</code>.</li>
</ul>
<p>We’ve learned how to create custom Sysmon rules for Wazuh. We can create multiple granular rules under each category of Sysmon events. To explore a list of all the custom Sysmon <a id="_idIndexMarker897"/>rules for Wazuh, you can visit the official SOCFotress GitHub repository here: <a href="https://github.com/socfortress/Wazuh-Rules/tree/main/Windows_Sysmon">https://github.com/socfortress/Wazuh-Rules/tree/main/Windows_Sysmon</a>.</p>
<h1 id="_idParaDest-244"><a id="_idTextAnchor243"/>Summary</h1>
<p>In this chapter, we have covered some of the important custom Wazuh rules for different types of events, such as PowerShell events, Linux Auditd events, Kaspersky endpoint protection events, and Sysmon events. In the next chapter, we will cover a list of important terms related to the Wazuh platform.</p>
</div>
</body></html>