<html><head></head><body><div><p>&#13;
			<h1 id="_idParaDest-104"><em class="italic"><a id="_idTextAnchor125"/>Chapter 7</em>: Using Ghidra Headless Analyzer</h1>&#13;
			<p><a id="_idTextAnchor126"/>In this chapter, you will learn about the non-GUI capabilities of Ghidra, which are very useful when analyzing multiple binaries, automating tasks, or integrating Ghidra with other tools.</p>&#13;
			<p>You've probably seen some films with hackers using black terminals with green font. There is some truth behind this stereotype. GUI applications are beautiful, user-friendly, and intuitive but they are also slow. After analyzing Ghidra headless mode, you will learn why shell applications and command line-based tools are the most efficient solution in a lot of cases.</p>&#13;
			<p><a id="_idTextAnchor127"/><a id="_idTextAnchor128"/>Headless Analyzer is a powerful command line-based (non-GUI) version of Ghidra, which will be introduced in this chapter.</p>&#13;
			<p>In this chapter, we're going to learn why a command line-based tool is very useful in a lot of cases. We will learn how to use headless mode to populate projects and how to perform an analysis of existing binaries. We will also learn how to run non-GUI scripts (and GUI scripts that don't make use of GUI functionalities) in a project using Ghidra Headless Analyzer.</p>&#13;
			<p>We will cover the following topics in this chapter:</p>&#13;
			<ul>&#13;
				<li>Why use headless mode?</li>&#13;
				<li>Creating and populating projects</li>&#13;
				<li>Performing analysis on imported or existing binaries</li>&#13;
				<li>Running non-GUI scripts in a project</li>&#13;
			</ul>&#13;
			<h1 id="_idParaDest-105"><a id="_idTextAnchor129"/>Technical requirements </h1>&#13;
			<p>The code for this chapter can be found at <a href="https://github.com/PacktPublishing/Ghidra-Software-Reverse-Engineering-for-Beginners/tree/master/Chapter07">https://github.com/PacktPublishing/Ghidra-Software-Reverse-Engineering-for-Beginners/tree/master/Chapter07</a>.</p>&#13;
			<p>Check out the following link to see the Code in Action video: <a href="https://bit.ly/3oAM6Uy">https://bit.ly/3oAM6Uy</a></p>&#13;
			<h1 id="_idParaDest-106"><a id="_idTextAnchor130"/>Why use headless mode?</h1>&#13;
			<p>As previously said, non-GUI applications allow you to work faster because, generally speaking, it is faster <a id="_idIndexMarker248"/>to write a command than to perform a GUI operation such as clicking a menu option, and then filling in some form, and finally submitting it.</p>&#13;
			<p>On the other hand, non-GUI applications can be easily integrated with scripts, allowing you to apply a process to multiple binaries, integrate the application with other tools, and so on.</p>&#13;
			<p>Imagine you are analyzing some malware using Ghidra and then you identify an encrypted <a id="_idIndexMarker249"/>string containing the <strong class="bold">Command and Control</strong> (<strong class="bold">C&amp;C</strong>) URL pointing to the server that controls the malware. Then, you are required to retrieve the C&amp;C URLs of thousands of malware samples in order to sinkhole the domains, in other words, in order to deactivate thousands of malware samples.</p>&#13;
			<p>Given this situation, to load every malware sample into Ghidra and look for the C&amp;C URL is not an option, even if you have developed a script to decrypt the C&amp;C URL, because it will consume more time than necessary. It is in these cases where you will need to use Ghidra headless mode.</p>&#13;
			<p>Ghidra headless mode can be launched using the <code>analyzeHeadless.bat</code> and <code>analyzeHeadless</code> scripts (for Microsoft Windows and Linux/macOS operating systems, respectively) located in Ghidra's <code>support</code> directory. The command syntax is the following:</p>&#13;
			<pre>analyzeHeadless &lt;project_location&gt; &lt;project_name&gt;[/&lt;folder_path&gt;] | ghidra://&lt;server&gt;[:&lt;port&gt;]/&lt;repository_name&gt;[/&lt;folder_path&gt;]</pre>&#13;
			<pre>    [[-import [&lt;directory&gt;|&lt;file&gt;]+] | [-process [&lt;project_file&gt;]]]</pre>&#13;
			<pre>    [-preScript &lt;ScriptName&gt; [&lt;arg&gt;]*]</pre>&#13;
			<pre>    [-postScript &lt;ScriptName&gt; [&lt;arg&gt;]*]</pre>&#13;
			<pre>    [-scriptPath "&lt;path1&gt;[;&lt;path2&gt;...]"]</pre>&#13;
			<pre>    [-propertiesPath "&lt;path1&gt;[;&lt;path2&gt;...]"]</pre>&#13;
			<pre>    [-scriptlog &lt;path to script log file&gt;]</pre>&#13;
			<pre>    [-log &lt;path to log file&gt;]</pre>&#13;
			<pre>    [-overwrite]</pre>&#13;
			<pre>    [-recursive]</pre>&#13;
			<pre>    [-readOnly]</pre>&#13;
			<pre>    [-deleteProject]</pre>&#13;
			<pre>    [-noanalysis]</pre>&#13;
			<pre>    [-processor &lt;languageID&gt;]</pre>&#13;
			<pre>    [-cspec &lt;compilerSpecID&gt;]</pre>&#13;
			<pre>    [-analysisTimeoutPerFile &lt;timeout in seconds&gt;]</pre>&#13;
			<pre>    [-keystore &lt;KeystorePath&gt;]</pre>&#13;
			<pre>    [-connect [&lt;userID&gt;]]</pre>&#13;
			<pre>    [-p]</pre>&#13;
			<pre>    [-commit ["&lt;comment&gt;"]]</pre>&#13;
			<pre>    [-okToDelete]</pre>&#13;
			<pre>    [-max-cpu &lt;max cpu cores to use&gt;]</pre>&#13;
			<pre>    [-loader &lt;desired loader name&gt;]</pre>&#13;
			<p>As you can see, Ghidra headless mode can deal with both individual projects and shared projects, which must be <a id="_idIndexMarker250"/>specified as a <code>server</code> repository URL using the <code>ghidra://</code> protocol.</p>&#13;
			<p class="callout-heading">Ghidra headless documentation</p>&#13;
			<p class="callout">If you want to learn more about the details and parameters of Ghidra headless mode, please check out the offline documentation included in <a id="_idIndexMarker251"/>the Ghidra program distribution: <a href="https://ghidra.re/ghidra_docs/analyzeHeadlessREADME.html">https://ghidra.re/ghidra_docs/analyzeHeadlessREADME.html</a>. </p>&#13;
			<p class="callout">Most of the Ghidra headless mode parameters will be discussed in this chapter but more exhaustive information is available in the Ghidra headless mode documentation.</p>&#13;
			<h1 id="_idParaDest-107"><a id="_idTextAnchor131"/>Creating and populating projects</h1>&#13;
			<p>The <a id="_idIndexMarker252"/>simplest operation that you can <a id="_idIndexMarker253"/>perform using Ghidra headless mode is to create a project containing a binary file.</p>&#13;
			<p>As we did in <em class="italic">Section 1</em>, <em class="italic">Getting Started with Ghidra</em>, let's create a new empty project (I will name it <code>MyFirstProject</code> and it will be located in the <code>C:\Users\virusito\projects</code> directory) containing a <em class="italic">hello world</em> binary file named <code>hello_world.exe</code>. </p>&#13;
			<p class="callout-heading">Note</p>&#13;
			<p class="callout">Notice that the <code>C:\Users\virusito\projects</code> directory must exist as it will not be created for you. On the other hand, <code>MyFirstProject</code> will be created by Ghidra, so you don't need to create it.</p>&#13;
			<p class="callout">Notice also that if the optional <code>[/&lt;folder_path&gt;]</code> folder path is included in the command, the import(s) will be rooted under this project folder.</p>&#13;
			<p>Please execute the following <a id="_idIndexMarker254"/>lines to create the <code>MyFirstProject</code> Ghidra project <a id="_idIndexMarker255"/>located in the <code>C:\Users\virusito\projects</code> directory:</p>&#13;
			<pre>C:\ghidra_9.1.2\support&gt;mkdir c:\Users\virusito\projects</pre>&#13;
			<pre>C:\ghidra_9.1.2\support&gt;analyzeHeadless.bat</pre>&#13;
			<pre>C:\Users\virusito\projects MyFirstProject –import C:\Users\virusito\hello_world\hello_world.exe</pre>&#13;
			<p>You will see the following output:</p>&#13;
			<div>&#13;
				<div>&#13;
					<img src="img/B16207_07_001.jpg" alt="Figure 7.1 – Using Ghidra headless mode to create a Ghidra project&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 7.1 – Using Ghidra headless mode to create a Ghidra project</p>&#13;
			<p>As shown in the <code>INFO</code> section of the output, some analysis was performed on the <code>hello_world.exe</code> file. You can omit the analysis by appending the <code>–noanalysis</code> flag to the previous command. The result of this Ghidra headless mode command is the following project:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_07_002.jpg" alt="Figure 7.2 – Ghidra project created using Ghidra headless mode&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 7.2 – Ghidra project created using Ghidra headless mode</p>&#13;
			<p>You can also add multiple binaries at once by using wildcard characters:</p>&#13;
			<ul>&#13;
				<li><code>*</code> to match a sequence of characters used</li>&#13;
				<li><code>?</code> to match a single character</li>&#13;
				<li><code>[a-z]</code> to match a range of characters</li>&#13;
				<li><code>[!a-z]</code> to match when a range of characters does not appear</li>&#13;
			</ul>&#13;
			<p>For <a id="_idIndexMarker256"/>instance, we can create a project named <code>MyFirstProject</code> containing <a id="_idIndexMarker257"/>all the executable files that exist in the <code>hello_world</code> directory:</p>&#13;
			<pre>C:\ghidra_9.1.2\support&gt; analyzeHeadless.bat C:\Users\virusito\projects MyFirstProject -import C:\Users\virusito\hello_world\*.exe</pre>&#13;
			<p>It is also possible to specify some interesting flags:</p>&#13;
			<ul>&#13;
				<li>Include the <code>-recursive</code> flag to analyze subfolders.</li>&#13;
				<li>Include the <code>-overwrite</code> flag to overwrite existing files in the project when a conflict happens.</li>&#13;
				<li>Include the <code>-readOnly</code> flag to not save imported files into the project.</li>&#13;
				<li>Include the <code>-deleteProject</code> flag to delete the project after scripts and/or analysis have been completed.</li>&#13;
				<li>Include the <code>-max-cpu &lt;max cpu cores to use&gt;</code> flag to limit the number of CPUs used during headless processing.</li>&#13;
				<li>Include the <code>-okToDelete</code> flag to allow the program disposition when it is in <code>-process</code> mode to delete binaries of a project. The following options allow you to control program disposition:<p>- Use <code>HeadlessContinuationOption.ABORT</code> to abort scripts or analysis whose execution is to take place after this script.</p><p>- Use <code>HeadlessContinuationOption.ABORT_AND_DELETE</code> to act as <code>HeadlessContinuationOption.ABORT</code> but also delete the current (existing) program.</p><p>- Use <code>HeadlessContinuationOption.CONTINUE_THEN_DELETE</code> to delete <a id="_idIndexMarker258"/>the (existing) program <a id="_idIndexMarker259"/>after processing it.</p><p>- Use <code>HeadlessContinuationOption.CONTINUE</code> with analysis and/or scripts.</p></li>&#13;
				<li>Include <code>-loader &lt;desired loader name&gt;</code> to force the file to be imported using a specific loader.</li>&#13;
				<li>Include <code>-processor &lt;languageID&gt;</code> and/or <code>-cspec &lt;compilerSpecID&gt;</code> to indicate the processor information and/or compiler specifications, respectively. Available languages and compiler specifications are both available in the <code>ghidra_x.x\Ghidra\Processors\proc_name\data\languages\*.ldefs</code> directory.</li>&#13;
				<li>Include <code>-log &lt;path to log file&gt;</code> to change the analysis and non-script logging information from the user's <code>application.log</code> directory file to a given log file path.</li>&#13;
			</ul>&#13;
			<p>In this section, you learned how to create a project and how to populate it with binaries using headless mode. In the next section, you will learn how to perform analysis on the binaries of a Ghidra project.</p>&#13;
			<h1 id="_idParaDest-108"><a id="_idTextAnchor132"/>Performing analysis on imported or existing binaries</h1>&#13;
			<p>As mentioned in the <a id="_idIndexMarker260"/>previous section, analysis is <a id="_idIndexMarker261"/>performed by default when creating a project. On the other hand, you can also run pre-/post-scripts (these kinds of scripts will be discussed later in this section) and/or analyze a given project using the following parameter: </p>&#13;
			<pre>-process [&lt;project_file&gt;]	</pre>&#13;
			<p>As an example, you can perform an analysis of the <code>hello_world.exe</code> file located in <code>MyFirstProject</code>:</p>&#13;
			<pre>C:\ghidra_9.1.2\support&gt; analyzeHeadless.bat C:\Users\virusito\projects MyFirstProject -process hello_world.exe</pre>&#13;
			<p>Of course, you can also use wildcards and/or the <code>-recursive</code> flag when executing this command:</p>&#13;
			<pre>C:\ghidra_9.1.2\support&gt; analyzeHeadless.bat C:\Users\virusito\projects MyFirstProject -process '*.exe'</pre>&#13;
			<p class="callout-heading">Note</p>&#13;
			<p class="callout">When importing files, make sure that the specified project is not already open in the Ghidra GUI. </p>&#13;
			<p class="callout">Also take into account that when importing in bulk, files starting with <code>.</code> are ignored.</p>&#13;
			<p>Apart from analyzing a single file or a set of files, you can also run scripts targeting these files.</p>&#13;
			<p>In fact, the kinds of scripts you are running are named according to the analysis time:</p>&#13;
			<ul>&#13;
				<li><strong class="bold">Pre-scripts</strong>: These kinds of scripts <a id="_idIndexMarker262"/>will be executed before the analysis. The syntax is the following:<pre><strong class="bold">-preScript &lt;ScriptName.ext&gt; [&lt;arg&gt;]*	</strong></pre></li>&#13;
				<li><strong class="bold">Post-scripts</strong>: These kinds of <a id="_idIndexMarker263"/>scripts will be executed after the analysis. The syntax is the following:<pre><strong class="bold">-postScript &lt;ScriptName.ext&gt; [&lt;arg&gt;]*</strong></pre></li>&#13;
			</ul>&#13;
			<p>When executing a pre-/post-script, as you can see in the syntax, you only need to provide the <a id="_idIndexMarker264"/>name of the script instead of a full <a id="_idIndexMarker265"/>path. This is because the script will be searched for in <code>$USER_HOME/ghidra_scripts</code>. You can modify this behavior by configuring a list of paths separated by a <code>;</code> character:</p>&#13;
			<pre>-scriptPath "$GHIDRA_HOME/Ghidra/Features/Base/ghidra_scripts;/myscripts"</pre>&#13;
			<p>Also notice that for Linux systems, you need to escape the backslash character: </p>&#13;
			<pre>-scriptPath "\$GHIDRA_HOME/Ghidra/Features/Base/ghidra_scripts;/myscripts"</pre>&#13;
			<p>Paths must start with <code>$GHIDRA_SCRIPT</code> (corresponding to the Ghidra installation directory) or <code>$GHIDRA_HOME</code> (corresponding to the user's home directory).</p>&#13;
			<p class="callout-heading">Setting an analysis timeout</p>&#13;
			<p class="callout">You can set an analysis timeout to interrupt the analysis if it is taking too long. To do that, use the following syntax: <code>-analysisTimeoutPerFile &lt;timeout in seconds&gt;</code>. </p>&#13;
			<p class="callout">When the timeout is reached, the analysis is interrupted and the post-scripts are executed as scheduled. Post-scripts can check whether the analysis was interrupted via the <code>getHeadlessAnalysisTimeoutStatus()</code> method.</p>&#13;
			<p>It is also possible to specify some interesting options: </p>&#13;
			<ul>&#13;
				<li>Set the path where <code>*.properties</code> files used by scripts or secondary subscripts exist. Note that paths must start with <code>$GHIDRA_SCRIPT</code>:<pre><strong class="bold">-propertiesPath "&lt;path1&gt;[;&lt;path2&gt;…]"</strong></pre></li>&#13;
				<li>Set the <a id="_idIndexMarker266"/>path where the script logging <a id="_idIndexMarker267"/>information will be written:<pre><strong class="bold">–scriptlog &lt;path to script log file&gt;</strong></pre></li>&#13;
			</ul>&#13;
			<p>Now that you know what kinds of scripts exist in Ghidra, next, we will go over how to implement and run them in a Ghidra project.</p>&#13;
			<h1 id="_idParaDest-109"><a id="_idTextAnchor133"/>Running non-GUI scripts in a project</h1>&#13;
			<p>As mentioned before, you can use Ghidra <a id="_idIndexMarker268"/>headless mode to run scripts before and after the analysis of a file (pre-scripts and post-scripts, respectively).</p>&#13;
			<p>As you know, non-GUI scripts run without human interaction, so it is recommended to write a headless script extending from the <code>HeadlessScript</code> class that, at the same time, extends from the already-known <code>GhidraScript</code> class.</p>&#13;
			<p>But extending from <code>HeadlessScript</code> is not a must. You can write a headed script extending from the <code>GhidraScript</code> class directly and it will also work when running in headless mode, but if some GUI-specific method is called, then <code>ImproperUseException</code> will be thrown.</p>&#13;
			<p>A similar thing happens in reverse. When a script extending from <code>HeadlessScript</code> is running on Ghidra headed mode, if a <code>HeadlessScript</code>-only method is called, an exception will also be thrown.</p>&#13;
			<p>Let's adapt an existing Ghidra script currently extending from <code>GhidraScript</code> in order to extend from <code>HeadlessScript</code> and see how it works and how it can be useful in practice (the <code>Apache License, Version 2.0</code> header was omitted for brevity):</p>&#13;
			<pre>//Prompts the user for a search string and searches the </pre>&#13;
			<pre>//program listing for the first occurrence of that string.</pre>&#13;
			<pre>//@category Search</pre>&#13;
			<pre>import ghidra.app.script.GhidraScript;</pre>&#13;
			<pre>import ghidra.program.model.address.Address;</pre>&#13;
			<pre>public class FindTextScript extends GhidraScript {</pre>&#13;
			<pre>    /**</pre>&#13;
			<pre>     * @see ghidra.app.script.GhidraScript#run()</pre>&#13;
			<pre>     */</pre>&#13;
			<pre>    @Override</pre>&#13;
			<pre>    public void run() throws Exception {</pre>&#13;
			<pre>		if (currentAddress == null) {</pre>&#13;
			<pre>			println("NO CURRENT ADDRESS");</pre>&#13;
			<pre>			return;</pre>&#13;
			<pre>		}</pre>&#13;
			<pre>		if (currentProgram == null) {</pre>&#13;
			<pre>			println("NO CURRENT PROGRAM");</pre>&#13;
			<pre>			return;</pre>&#13;
			<pre>		}</pre>&#13;
			<pre>        String search = askString("Text Search", "Enter search string: ");</pre>&#13;
			<pre>        Address addr = find(search);</pre>&#13;
			<pre>        if (addr != null) {</pre>&#13;
			<pre>            println("Search match found at "+addr);</pre>&#13;
			<pre>            goTo(addr);</pre>&#13;
			<pre>        }</pre>&#13;
			<pre>        else {</pre>&#13;
			<pre>            println("No search matched found.");</pre>&#13;
			<pre>        }</pre>&#13;
			<pre>    }</pre>&#13;
			<pre>}</pre>&#13;
			<p>We can perform the following optional modifications:</p>&#13;
			<ul>&#13;
				<li>Replace <code>import ghidra.app.script.GhidraScript</code> with <code>ghidra.app.util.headless.HeadlessScript</code>.</li>&#13;
				<li>Extend from <code>HeadlessScript</code> instead of <code>GhidraScript</code>.</li>&#13;
				<li>Rename the <code>FindTextScript</code> class to <code>HeadlessFindTextScript</code>.</li>&#13;
			</ul>&#13;
			<p>We need to perform the following mandatory modifications:</p>&#13;
			<ul>&#13;
				<li>To pass a parameter to an <code>askXxx()</code> method such as <code>askString()</code>, you will need to create an <code>*.properties</code> file. So, let's create a <code>HeadlessFindTextScript.properties</code> file containing the required string:<pre>#
# This is the HeadlessFindTextScript.properties file
#
Text Search Enter search string: = http://</pre></li>&#13;
				<li>Print out the <a id="_idIndexMarker269"/>string value, not just its address:<pre>String addrValue = getDataAt(addr).getDefaultValueRepresentation();
println("0x" + addr + ": " + addrValue);</pre></li>&#13;
			</ul>&#13;
			<p>This is the result after the mentioned modifications were applied to the original script (the <code>Apache License, Version 2.0</code> header was omitted for brevity): </p>&#13;
			<pre>//Prompts the user for a search string and searches the</pre>&#13;
			<pre>//program listing for the first occurrence of that string.</pre>&#13;
			<pre>//@category Search</pre>&#13;
			<pre>import ghidra.app.script.GhidraScript;</pre>&#13;
			<pre>import ghidra.app.util.headless.HeadlessScript;</pre>&#13;
			<pre>import ghidra.program.model.address.Address;</pre>&#13;
			<pre>public class HeadlessFindTextScript extends GhidraScript {</pre>&#13;
			<pre>    /**</pre>&#13;
			<pre>     * @see ghidra.app.script.GhidraScript#run()</pre>&#13;
			<pre>     */</pre>&#13;
			<pre>    @Override</pre>&#13;
			<pre>    public void run() throws Exception {</pre>&#13;
			<pre>        if (currentAddress == null) {</pre>&#13;
			<pre>            println("NO CURRENT ADDRESS");</pre>&#13;
			<pre>            return;</pre>&#13;
			<pre>        }</pre>&#13;
			<pre>        if (currentProgram == null) {</pre>&#13;
			<pre>            println("NO CURRENT PROGRAM");</pre>&#13;
			<pre>            return;</pre>&#13;
			<pre>        }</pre>&#13;
			<pre>        String search = askString("Text Search", "Enter search string: ");</pre>&#13;
			<pre>        Address addr = find(search);</pre>&#13;
			<pre>        if (addr != null) {</pre>&#13;
			<pre>            String addrValue = getDataAt(addr).getDefaultValueRepresentation();</pre>&#13;
			<pre>            println("0x" + addr + ": " + addrValue);</pre>&#13;
			<pre>            goTo(addr);</pre>&#13;
			<pre>        }</pre>&#13;
			<pre>        else {</pre>&#13;
			<pre>            println("No search matched found.");</pre>&#13;
			<pre>        }</pre>&#13;
			<pre>    }</pre>&#13;
			<pre>}</pre>&#13;
			<p>Now, we <a id="_idIndexMarker270"/>can try this post-script over a set of random malware samples. <strong class="bold">Please ensure you fully understand the risks of analyzing malware before you continue reading.</strong></p>&#13;
			<p class="callout-heading">The risks of analyzing malware</p>&#13;
			<p class="callout">When analyzing malware, your <a id="_idIndexMarker271"/>computer and network are at risk (you cannot reduce the risk to zero but can try to get it to almost zero). To avoid this risk, we covered how to set up a reasonably safe malware analysis environment in <a href="B16207_05_Final_SK_ePub.xhtml#_idTextAnchor082"><em class="italic">Chapter 5</em></a>, <em class="italic">Reversing Malware Using Ghidra</em>, for the purposes of the chapter.</p>&#13;
			<p class="callout">Since, in this case, you will need an internet connection to download samples, I recommend you learn how to set up an isolated malware lab using the following resources: https://archive.org/details/Day1Part10DynamicMalwareAnalysis and <a href="https://blog.christophetd.fr/malware-analysis-lab-with-virtualbox-inetsim-and-burp/">https://blog.christophetd.fr/malware-analysis-lab-with-virtualbox-inetsim-and-burp/</a>.</p>&#13;
			<p>To do so, start by executing the script that downloads all malware samples listed in this malware <a id="_idIndexMarker272"/>sample database, <a href="https://das-malwerk.herokuapp.com/">https://das-malwerk.herokuapp.com/</a>, generating two directories:</p>&#13;
			<ul>&#13;
				<li><code>compressed_malware_samples</code>, where malware samples are downloaded.</li>&#13;
				<li><code>decompressed_malware_samples</code>, where malware samples are uncompressed and decrypted by a 7Z decompressor using the password <code>infected</code>. Malware samples are, by convention, encrypted using the mentioned password.</li>&#13;
			</ul>&#13;
			<p>The script to download all <a id="_idIndexMarker273"/>malware samples is the following:</p>&#13;
			<pre>#!/usr/bin/env python</pre>&#13;
			<pre>import os</pre>&#13;
			<pre>import urllib.request</pre>&#13;
			<pre>import re</pre>&#13;
			<pre>import subprocess</pre>&#13;
			<pre>from pathlib import Path</pre>&#13;
			<pre>from bs4 import BeautifulSoup</pre>&#13;
			<pre>url = 'https://s3.eu-central-1.amazonaws.com/dasmalwerk/'</pre>&#13;
			<pre>Path("compressed_malware_samples").mkdir(parents=True, exist_ok=True)</pre>&#13;
			<pre>dasmalwerk = urllib.request.urlopen(urllib.request.Request(url, data=None, headers={'User-Agent': 'Packt'})).read().decode('utf-8')</pre>&#13;
			<pre>soup = BeautifulSoup(dasmalwerk, 'lxml')</pre>&#13;
			<pre>malware_samples = soup.findAll('key')</pre>&#13;
			<pre>for sample in malware_samples:</pre>&#13;
			<pre>    if(not sample.string.endswith('.zip')):</pre>&#13;
			<pre>        continue</pre>&#13;
			<pre>    sample_url="{0}{1}".format(url, sample.string)</pre>&#13;
			<pre>    print("[*] Downloading sample: {0}".format(sample_url))</pre>&#13;
			<pre>    try:</pre>&#13;
			<pre>        sample_filename = 'compressed_malware_samples{0}{1}'.format(os.sep, sample.string.split('/')[-1])</pre>&#13;
			<pre>        with urllib.request.urlopen(sample_url) as d, open(sample_filename, "wb") as opfile:</pre>&#13;
			<pre>            data = d.read()</pre>&#13;
			<pre>            opfile.write(data)</pre>&#13;
			<pre>            print("    [-] Downloaded.")</pre>&#13;
			<pre>        subprocess.call(['C:\\Program Files\\7-Zip\\7z.exe', 'e', sample_filename, '*', '-odecompressed_malware_samples', '-pinfected', '-y', '-r'], stdout=subprocess.DEVNULL)</pre>&#13;
			<pre>        print("    [-] Uncompressed.")</pre>&#13;
			<pre>    except:</pre>&#13;
			<pre>        print("    [-] Error :-(")</pre>&#13;
			<p>This is what the output looks like:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_07_003.jpg" alt="Figure 7.3 – Downloading malware samples&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 7.3 – Downloading malware samples</p>&#13;
			<p>In order to execute the script over this set of malware samples, we can use the following command:</p>&#13;
			<pre>analyzeHeadless.bat C:\Users\virusito\projects MalwareSampleSetProject -postScript C:\Users\virusito\ghidra_scripts\HeadlessFindTextScript.java -import C:\Users\virusito\malware_samples_downloader\decompressed_malware_samples\* -overwrite</pre>&#13;
			<p>The <code>http://</code> string, as <a id="_idIndexMarker274"/>specified in <code>HeadlessFindTextScript.properties</code>, is matched once at <code>0x004c96d8</code>:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_07_004.jpg" alt="Figure 7.4 – Finding the http:// string occurrences in malware samples&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 7.4 – Finding the http:// string occurrences in malware samples</p>&#13;
			<p>Let's check whether this finding is correct using Ghidra headed mode. To do this, open the <code>C:\Users\virusito\projects\MalwareSampleSetProject.gpr</code> project and then open the malware sample file where the <code>http://</code> string was found:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_07_005.jpg" alt="Figure 7.5 – Openning the malware sample with Ghidra's CodeBrowser&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 7.5 – Openning the malware sample with Ghidra's CodeBrowser</p>&#13;
			<p>Go to the matched <a id="_idIndexMarker275"/>address using the <em class="italic">G</em> hotkey:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_07_006.jpg" alt="Figure 7.6 – Going to the 0x004c96d8 address using Ghidra headed mode&#13;&#10;"/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 7.6 – Going to the 0x004c96d8 address using Ghidra headed mode</p>&#13;
			<p>You will see the string pointed to by this memory address:</p>&#13;
			<p>&#13;
				<div>&#13;
					<img src="img/B16207_07_007.jpg" alt=""/>&#13;
				</p>&#13;
			</div>&#13;
			<p class="figure-caption"> </p>&#13;
			<p class="figure-caption">Figure 7.7 – Showing the http:// string occurrence in the 0x004c96d8 <a id="_idTextAnchor134"/>&#13;
address using Ghidra headed mode</p>&#13;
			<p>Since the string shown in headed mode matches the result of the script, we have confirmed that it is <a id="_idIndexMarker276"/>working as expected. As you can see, it is very easy to automate the analysis of multiple binaries using Ghidra headless mode.</p>&#13;
			<h1 id="_idParaDest-110"><a id="_idTextAnchor135"/>Summary</h1>&#13;
			<p>In this chapter, you learned how to use Ghidra headless mode to analyze multiple binaries and automate tasks. We started by reviewing the most relevant parameters of Ghidra headless mode and then started to apply this knowledge with practical examples.</p>&#13;
			<p>We learned how to create a project, populate it with binaries, analyze it, and run pre-/post-scripts over these binaries. We also learned that is possible to execute a GUI script in headless mode and a non-GUI script in headed mode, as well as the exceptions that can occur and why.</p>&#13;
			<p>In the next chapter of this book, we will cover binary audits using Ghidra. We will take this opportunity to review the different kinds of memory corruption vulnerabilities, how to hunt them, and how to exploit them.</p>&#13;
			<h1 id="_idParaDest-111"><a id="_idTextAnchor136"/>Questions</h1>&#13;
			<ol>&#13;
				<li>Since it is possible to execute headed scripts in headless mode, why do you need to program headless mode scripts?</li>&#13;
				<li>When is it appropriate to use Ghidra in headless mode and when should you use Ghidra in headed mode?</li>&#13;
				<li>What is the difference between looking for strings in a binary file using Ghidra and looking for them using a command tool such as <code>grep</code> or <code>strings</code>?</li>&#13;
			</ol>&#13;
			<h1 id="_idParaDest-112"><a id="_idTextAnchor137"/>Further reading</h1>&#13;
			<p>You can refer to the following links for more information on the topics covered in this chapter:</p>&#13;
			<ul>&#13;
				<li>Headless Analyzer documentation: <a href="https://ghidra.re/ghidra_docs/analyzeHeadlessREADME.html">https://ghidra.re/ghidra_docs/analyzeHeadlessREADME.html</a></li>&#13;
				<li>Headless Analyzer course: <a href="https://ghidra.re/courses/GhidraClass/Intermediate/HeadlessAnalyzer.html">https://ghidra.re/courses/GhidraClass/Intermediate/HeadlessAnalyzer.html</a></li>&#13;
				<li>Web server exposing Ghidra analysis via Ghidra headless mode: <a href="https://github.com/Cisco-Talos/Ghidraaas">https://github.com/Cisco-Talos/Ghidraaas</a></li>&#13;
			</ul>&#13;
		</div>&#13;
	</div></body></html>