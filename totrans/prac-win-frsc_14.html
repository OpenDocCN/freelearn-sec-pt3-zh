<html><head></head><body><div class="appendix" title="Appendix&#xA0;appB.&#xA0;Case Study"><div class="titlepage"><div><div><h1 class="title"><a id="B"/>Appendix appB. Case Study</h1></div></div></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec82"/>Introduction</h1></div></div></div><p>In this appendix, we will use an infected machine to illustrate how to conduct primary analysis on different types of evidence, and we will go through live analysis along with the post-mortem analysis.</p></div></div>
<div class="section" title="Scenario"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec83"/>Scenario</h1></div></div></div><p>To conduct this analysis, we created a small virtual network with the following structure:</p><div class="mediaobject"><img src="graphics/image_66_001.jpg" alt="Scenario"/></div><p>All the scenario parts were created using virtualization, including the required Internet hosts to download the malware. The machine is infected with ZeusVM malware. The malware executable can be downloaded for educational use only from the Zoo at <a class="ulink" href="https://github.com/ytisf/theZoo/blob/master/malwares/Binaries/ZeusVM/ZeusVM.zip">https://github.com/ytisf/theZoo/blob/master/malwares/Binaries/ZeusVM/ZeusVM.zip</a>. The malware sample SHA256 after unzipping is as follows:</p><p><code class="literal">b04637c11c63dd5a4a599d7104f0c5880717b5d5b32e0104de5a416963f06118</code></p><p><code class="literal">theZoo</code> is a project that was created to make the possibility of malware analysis open and available to the public. <code class="literal">theZoo</code> was created by Yuval tisf Nativ, and it is now maintained by Shahak Shalev.</p><p>You can download the malware sample, recreate or infect a virtual machine with this malware, and follow the analysis steps in this appendix.</p><p>The machine used in this scenario is Windows 7 Enterprise 64 bit.</p></div>
<div class="section" title="Acquisition"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec84"/>Acquisition</h1></div></div></div><p>As we discussed before, the best practice is to start the evidence acquisition before changing anything in the machine under investigation. The acquired evidence must be stored in the USB storage device or network share. In our case, a USB storage device can be used between the infected and the analysis machines, but it must be carefully wiped after the analysis. Network acquisition with another analysis Linux virtual machine over the virtual network will be efficient in our case as well. Network acquisition will be as discussed before in <a class="link" href="ch04.html" title="Chapter 4. Nonvolatile Data Acquisition">Chapter 4</a>, <span class="emphasis"><em>Nonvolatile Data Acquisition</em></span>. We need to acquire the memory and hard disk of the infected machine.</p><p>Exercise: You need to perform this step, as we discussed before in the acquisition sections in <a class="link" href="ch03.html" title="Chapter 3. Volatile Data Collection">Chapter 3</a>, <span class="emphasis"><em>Volatile Data Collection</em></span>, and <a class="link" href="ch04.html" title="Chapter 4. Nonvolatile Data Acquisition">Chapter 4</a>, <span class="emphasis"><em>Nonvolatile Data Acquisition</em></span>.</p></div>
<div class="section" title="Live analysis"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec85"/>Live analysis</h1></div></div></div><p>Next, let's perform some live analysis on the infected machine in hand. This live analysis will give us quick results. It may overwrite some traces in the system, but in our case here, we have already acquired our evidence.</p><div class="section" title="The running processes"><div class="titlepage"><div><div><h2 class="title"><a id="ch14lvl2sec117"/>The running processes</h2></div></div></div><p>Listing the running processes will allow us to notice any maliciously-named processes that may relate to malware behavior. We can list the running processes using the <code class="literal">native tasklist</code> command:</p><div class="mediaobject"><img src="graphics/image_66_002.jpg" alt="The running processes"/></div><p>We can also use <code class="literal">processexplorer</code> from Sysinternals. We will notice no malicious names, but we can see that there are two processes named <code class="literal">explorer.exe</code> within the system. One holds an ID of <code class="literal">2256</code> ran for compatibility with 32 bit images but its current directory is <code class="literal">C:\Users\&lt;&lt;UserName&gt;&gt;\AppData\Roaming\</code> as shown in the Process Explorer in the following screenshot. Also, please note that this process most likely will hold another ID if you ran the malware in a machine on your own:</p><div class="mediaobject"><img src="graphics/image_66_003.jpg" alt="The running processes"/></div><p>To investigate this process more, we can use <code class="literal">ProcessActivityView</code> from DART tools to see which files are accessed by this process in real time. We will find this process access a file located and named <code class="literal">C:\Users\&lt;&lt;UserName&gt;&gt;\AppData\Roaming\Tyull\yquna.tmp</code>.</p><p>The folder name and filenames seem to be randomly created which is a typical malware behavior.</p><p>Then, if we try to scan the running system with the GMER tool, it will detect some injected code in the running process <code class="literal">2256 explorer.exe</code>, as follows:</p><div class="mediaobject"><img src="graphics/image_66_004.jpg" alt="The running processes"/></div></div><div class="section" title="Network activities"><div class="titlepage"><div><div><h2 class="title"><a id="ch14lvl2sec118"/>Network activities</h2></div></div></div><p>Most of the malware samples out there need a network connection to complete their goal and connect to the attacker. By checking the network activities on the suspicious connection, we will notice that it listens for connections and port <code class="literal">37337</code>. Here, we must note that we already isolated the machine from the Internet and the internal network and such connections can't be completed:</p><div class="mediaobject"><img src="graphics/image_66_005.jpg" alt="Network activities"/></div><p>Port <code class="literal">37337</code> is known for its wide usage in malware-related activities.</p></div><div class="section" title="Autorun keys"><div class="titlepage"><div><div><h2 class="title"><a id="ch14lvl2sec119"/>Autorun keys</h2></div></div></div><p>We also can check for the autorun keys in the system, which are used by the malware to preserve their existence in the system even after system reboot. We can do this using the Sysinternals tool <code class="literal">autorunsc.exe</code> or its GUI <code class="literal">autoruns.exe</code>. We can use the command-line version with the following options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">-l</code>: These are elements that start automatically at login (the default option)</li><li class="listitem" style="list-style-type: disc"><code class="literal">-t</code>: These are assigned tasks</li><li class="listitem" style="list-style-type: disc"><code class="literal">-m</code>: These do not display elements that are digitally signed by Microsoft</li><li class="listitem" style="list-style-type: disc"><code class="literal">-v</code>: These verify digital signatures</li></ul></div><div class="mediaobject"><img src="graphics/image_66_006.jpg" alt="Autorun keys"/></div><p>Under the <code class="literal">HKCU\Software\Microsoft\Windows\CurrentVersion\Run</code> registry key, the location of this unknown executable is <code class="literal">C:\users\&lt;&lt;UserName&gt;&gt;\appdata\roaming\imyrug\epqe.exe</code>. Pay attention to the key last access date, which is old.</p><p>We can extract this executable for further analysis, such as reverse engineering and malware analysis, to make sure that it is malicious and understand its functionality. The same results can be found using the GUI version of the tool:</p><div class="mediaobject"><img src="graphics/image_66_007.jpg" alt="Autorun keys"/></div><p>So, the question now is what added this executable to the registry keys?</p></div></div>
<div class="section" title="Prefetch files"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec86"/>Prefetch files</h1></div></div></div><p>To try to answer the previous question, we can start analyzing the prefetch files. From DART, open the WinPrefetchView tool. This tool will automatically parse the prefetch files of the live system and view their results in human readable format.</p><p>After spending some time in viewing the files and searching for the executable named <code class="literal">epqe</code>, we can find that <code class="literal">eqpe.exe</code> ran just two seconds after a file named <code class="literal">latest_report.pdf.exe</code> ran in the system, and at the same second the <code class="literal">Explorer.exe</code> started:</p><div class="mediaobject"><img src="graphics/image_66_008.jpg" alt="Prefetch files"/></div><p>As we can see, the first filename is very suspicious. It is located under <code class="literal">C:\Users\&lt;&lt;UserName&gt;&gt;\Downloads\latest_report.pdf.exe</code>. If we tried to search this location for this file, we won't find it. In the list of files used by this <code class="literal">latest_report.pdf.exe</code> file, according to <code class="literal">WinPrefetchView</code>, we will find the <code class="literal">epqe.exe</code> file used or created by this file:</p><div class="mediaobject"><img src="graphics/image_66_009.jpg" alt="Prefetch files"/></div><p>However, what made the victim download this malicious executable?</p></div>
<div class="section" title="Browser analysis"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec87"/>Browser analysis</h1></div></div></div><p>The <code class="literal">last_report.pdf.exe</code> file may have been copied to the machine from another storage or over the network, but because it was located in the <code class="literal">Downloads</code> folder, it may be more reasonable to start investigating the browser history.</p><p>The installed browsers in the system were Internet Explorer and Mozilla Firefox. By investigating both with DART tools, we can find some interesting results from <code class="literal">MozillaHistoryView</code>:</p><div class="mediaobject"><img src="graphics/image_66_010.jpg" alt="Browser analysis"/></div><p>We can see that the file was downloaded from <code class="literal">http://www.maldomain.com/public/latest_report.pdf.exe</code>. However, we can see that the visit time was just after the user visited <code class="literal">mail.yahoo.com</code>, which increases the chance that the malicious link was sent to the victim in an e-mail.</p><p>If we have the ability to open the victim's mailbox to prove or refute this assumption, in our case, we will find the following message:</p><div class="mediaobject"><img src="graphics/image_66_011.jpg" alt="Browser analysis"/></div><p>We can find this e-mail where the language isn't accurate and the link was added in order to display other text <code class="literal">this link</code> rather than the actual link:</p><div class="mediaobject"><img src="graphics/image_66_012.jpg" alt="Browser analysis"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>Note: The e-mail and browser history analysis results won't appear in your analysis if you run the malware within a machine on your own.</p></div></div></div>
<div class="section" title="Postmortem analysis"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec88"/>Postmortem analysis</h1></div></div></div><p>Before performing the live analysis, we acquired the evidence. These were the memory and the hard drive. Let's see what we can get from this evidence.</p><div class="section" title="Memory analysis"><div class="titlepage"><div><div><h2 class="title"><a id="ch14lvl2sec120"/>Memory analysis</h2></div></div></div><p>The memory is the working space for the operating system, and we can get many traces of any malware that ran within the system from the memory analysis. In this section, we will use the volatility framework to analyze the dumped memory file and try to get the same information that we got from the live analysis.</p><p>To get information about the profile of the memory file, we can use the imageinfo plugin:</p><p>From the output, the image profile that we will use is <code class="literal">Win7SP0x64</code>. Then, let's list the running processes and the network connections, as we discussed in the memory analysis chapter:</p><div class="mediaobject"><img src="graphics/image_66_014.jpg" alt="Memory analysis"/></div><p>We will notice the two <code class="literal">explorer.exe</code> processes, but we can't see any hidden processes. There are two processes named <code class="literal">dllhost.exe</code>, which can be found in the psscan plugin's output only. However, these two processes were exited and their structures were still in memory, and they can be found by psscan plugin, as we can see from the output of the psscan plugin:</p><div class="mediaobject"><img src="graphics/image_66_015.jpg" alt="Memory analysis"/></div><p>Then, we can filter, based on the malicious connections that can be found in the system using the netscan plugin:</p><div class="mediaobject"><img src="graphics/image_66_016.jpg" alt="Memory analysis"/></div><p>We will find <code class="literal">explorer.exe</code> process's listening connections on port <code class="literal">37337</code>. So, let's focus on this process.</p><p>Let's dump this process and search for any interesting strings that can identify its function:</p><div class="mediaobject"><img src="graphics/image_66_017.jpg" alt="Memory analysis"/></div><p>If we run the <code class="literal">strings 2256.dmp | more</code> command, it will show many strings in the process dump file. Some of these strings, such as <code class="literal">Run and Runonce</code>, should make us think about registry keys. To list the registry keys in memory, we can use the hivelist plugin:</p><div class="mediaobject"><img src="graphics/image_66_018.jpg" alt="Memory analysis"/></div><p>Now, we have the locations of the opened hives in memory. We can browse through these hives in memory using the printkey plugin with the virtual offset of the registry hive.</p><p>We can try different hives, but let's try the <code class="literal">ntuser.dat</code> hive of the system user. Check <code class="literal">Software\Microsoft\Windows\CurrentVersion\Run</code>:</p><div class="mediaobject"><img src="graphics/image_66_019.jpg" alt="Memory analysis"/></div><p>We can find the unknown executable in the memory as well. Now, let's try to scan for all opened files in memory and filter on this filename:</p><div class="mediaobject"><img src="graphics/image_66_020.jpg" alt="Memory analysis"/></div><p>Then, convert the body file to the timeline file using the following command:</p><pre class="programlisting">
<span class="strong"><strong>mactime -b mft.body &gt; mft.tmline</strong></span>
</pre><p>The output will be a timeline of all the activities in the system. If we tried to filter based on the suspicious executable filename, we can get the same sequence that we got from investigating the prefetch files during live analysis:</p><div class="mediaobject"><img src="graphics/image_66_021.jpg" alt="Memory analysis"/></div><p>Then, we can try to recover the <code class="literal">latest_report.pdf.exe</code> from the hard disk image. Actually, the malware deleted that file and created the <code class="literal">epqe.exe</code> instead. But, what if we wanted to get this file and couldn't recover that file from the hard disk.</p></div><div class="section" title="Network analysis"><div class="titlepage"><div><div><h2 class="title"><a id="ch14lvl2sec121"/>Network analysis</h2></div></div></div><p>The network traffic is the most volatile evidence. For our scenario here, we dumped the network traffic during the attack simulation to a <code class="literal">pcap</code> file.</p><p>To analyze the network traffic, we will use the Networkminer tool that is installed within the Wine environment in our Linux analysis virtual machine.</p><p>Networkminer will parse the <code class="literal">pcap</code> file and view detailed information about the <code class="literal">maldomain.com</code> domain:</p><div class="mediaobject"><img src="graphics/image_66_022.jpg" alt="Network analysis"/></div><p>It will also export the downloaded file with detailed information:</p><div class="mediaobject"><img src="graphics/image_66_023.jpg" alt="Network analysis"/></div><p>From the network traffic, we can export and analyze the first <code class="literal">latest_report.pdf.exe</code> executable file.</p></div><div class="section" title="Timeline analysis"><div class="titlepage"><div><div><h2 class="title"><a id="ch14lvl2sec122"/>Timeline analysis</h2></div></div></div><p>In this section, we will create a complete timeline of all the activities in the hard disk from the acquired disk image using log2timeline and the Plaso framework.</p><p>We will run all the parsers of Windows 7 against the acquired image. However, first, we need to get the offset of the <code class="literal">C:</code> partition in image using <code class="literal">mmls</code> tool from TSK:</p><div class="mediaobject"><img src="graphics/image_66_024.jpg" alt="Timeline analysis"/></div><p>Then, we will use this offset with log2timeline. The process of generating the body file will take a long time because it parses the whole volume for any event mentioned in Win7 parsers:</p><div class="mediaobject"><img src="graphics/image_66_025.jpg" alt="Timeline analysis"/></div><p>Once this is finished, we can use the <code class="literal">psort.py</code> tool to view parts of the body file on our choice with the command line, as we did in the timeline analysis in <a class="link" href="ch05.html" title="Chapter 5. Timeline">Chapter 5</a>, <span class="emphasis"><em>Timeline</em></span>.</p><p>Or, we can convert the timeline body file into a CSV formatted file in order to view it with any spreadsheet program. The conversion will take some time to complete:</p><div class="mediaobject"><img src="graphics/image_66_026.jpg" alt="Timeline analysis"/></div><p>Once the conversion finishes, you can open the new file in, for example, Excel:</p><div class="mediaobject"><img src="graphics/image_66_027.jpg" alt="Timeline analysis"/></div><p>Then, we can use the Excel filtering tools to filter the output based on our needs, such as showing the prefetch analysis of the malicious files:</p><div class="mediaobject"><img src="graphics/image_66_028.jpg" alt="Timeline analysis"/></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch14lvl1sec89"/>Summary</h1></div></div></div><p>After we finished the main book chapters, in this appendix we conducted a primary analysis and discovered malware in an infected machine. We used different analysis techniques, live analysis and postmortem analysis, and explained how to get the same results from both ways. Although, live analysis is easier, it is not applicable all the time. This is why we must be aware of both techniques for the real-life investigations.</p></div></body></html>