<html><head></head><body>
		<div><h1 id="_idParaDest-111"><em class="italic">Chapter 6</em>: <a id="_idTextAnchor111"/>Data Security</h1>
			<p>Like everything else, data in the cloud must be treated differently to that in on-premises environments. As data is leaving our local environment, and is usually accessible over the internet, we need to be extra careful. We have already mentioned that all data is encrypted at rest, and most communication goes over <strong class="bold">HTTPS</strong> (<strong class="bold">Hypertext Transfer Protocol over Secure Socket Layer</strong>) and is encrypted in the <a id="_idIndexMarker365"/>move as well. However, there are multiple steps that we can take to ensure additional security and satisfy compliance and different security requirements.</p>
			<p>In this chapter, we will be using Azure Key Vault extensively. We've seen how Azure Key Vault can be used for secrets and password management, but we will also see how it can be used to increase data security as well.</p>
			<p>We will cover the following topics in this chapter:</p>
			<ul>
				<li>Understanding Azure Storage</li>
				<li>Understanding Azure Virtual Machine disks</li>
				<li>Working on Azure SQL Database</li>
			</ul>
			<h1 id="_idParaDest-112"><a id="_idTextAnchor112"/>Technical requirements</h1>
			<p>For this chapter, the following is required:</p>
			<ul>
				<li>PowerShell 5.1, or higher, on Windows (or PowerShell Core 6.x and later on any other platform, including Windows)</li>
				<li>Azure PowerShell modules</li>
				<li>Visual Studio Code</li>
				<li>An Azure subscription</li>
			</ul>
			<h1 id="_idParaDest-113"><a id="_idTextAnchor113"/>Understanding Azure Storage</h1>
			<p>Azure Storage is Microsoft's cloud storage service and is highly available, secure, and scalable, plus, it supports a variety of programming languages. It is usually the first data service users encounter when they start using Azure. </p>
			<p>All communication <a id="_idIndexMarker366"/>inside Azure data centers is over HTTPS, but what happens when we access data from outside? As per the shared responsibility model (explained in <a href="B15414_01_Final_JM_ePub.xhtml#_idTextAnchor021"><em class="italic">Chapter 1</em></a>,<em class="italic"> Azure Security Introduction</em>), this falls under the user's responsibility. Because of different user requirements, Microsoft does not enforce traffic over HTTPS by default, but there is an option that users can enable to enforce traffic to be encrypted.</p>
			<p>Under <strong class="bold">Configuration</strong>, there is an option called <strong class="bold">Secure transfer required</strong>. To ensure that all traffic is encrypted and over HTTPS, we need to enable this option, as in the following screenshot:</p>
			<div><div><img src="img/Fig_6.1.jpg" alt="Figure 6.1 – Azure Storage secure transfer &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.1 – Azure Storage secure transfer </p>
			<p>When <strong class="bold">Secure transfer required</strong> is enabled, all requests that are not over HTTPS will be rejected, even if they have valid access parameters (such as an access signature or a token). This enhances transfer security by allowing the request to Azure Storage only when coming by a secure connection.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">It's important to remember that Azure Storage does not support HTTPS for custom domain names, so this option does not apply when a custom domain name is used.</p>
			<p>Another thing we need to consider is what happens when files are accidentally deleted. This can occur for a <a id="_idIndexMarker367"/>number of reasons, such as a user deleting a file by mistake, or numerous applications using the same Azure Storage and one application deleting a file needed by another application. Of course, such situations can be caused by malicious attacks and with intent to cause damage as well. To avoid such situations, we can enable the <strong class="bold">Blob soft delete</strong> option under the <strong class="bold">Data Protection</strong> setting. </p>
			<p>An example is shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.2.jpg" alt="Figure 6.2 – Blob soft delete &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.2 – Blob soft delete </p>
			<p><code>7</code> and <code>365</code> days. Besides recovering deleted files<strong class="bold">, Blob soft delete</strong> enables us to recover previous versions of files, too. If a file is accidentally modified, or we need a previous version of a <a id="_idIndexMarker368"/>file for some other reason<strong class="bold">, Blob soft delete</strong> can help us to restore the file to any point in time, as long as it's in the timeframe of the effective retention period. </p>
			<p class="callout-heading">Important note</p>
			<p class="callout"><strong class="bold">Blob soft delete</strong> and the retention period are effective from the moment they are set and cannot be used retroactively. For example, if we discover that we lost a file and then enable this option, it will not help us recover the lost file. To be able to recover files, we need to have the option in place before the incident happens.</p>
			<p>Data in Azure is encrypted at rest, and that's no different with Azure Storage. But data is encrypted with Microsoft-managed keys, and this is not always acceptable. In certain situations, caused by compliance and security requirements, we must be in control of keys <a id="_idIndexMarker369"/>that are used for encryption. To address such needs, Microsoft has enabled encryption of data with the <strong class="bold">Bring Your Own Key </strong>(<strong class="bold">BYOK</strong>) option. The option to use your own key can be enabled under the <strong class="bold">Encryption</strong> option, as in the following screenshot:</p>
			<p class="figure-caption"> </p>
			<div><div><img src="img/Fig_6.3.jpg" alt="Figure 6.3 – Azure Storage encryption options&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.3 – Azure Storage encryption options</p>
			<p>BYOK is enabled by the use of Azure Key Vault, where keys used for storage encryption are stored. </p>
			<p>Once we enable <strong class="bold">Use your own key</strong>, new settings will appear where we need to provide key vault information. An example is shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.4.jpg" alt="Figure 6.4 – Storage encryption with a custom key&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.4 – Storage encryption with a custom key</p>
			<p>We can either provide a key <strong class="bold">Uniform Resource Identifier </strong>(<strong class="bold">URI</strong>), which will contain information <a id="_idIndexMarker370"/>about the key vault and key that will be used for encryption, or we can use a second option, which will allow us to select the available key vault and key from a list. Both <a id="_idIndexMarker371"/>options will have identical outcomes and the storage will be encrypted. Any new files added to Azure Storage will be encrypted automatically. Any existing files will be retroactively encrypted by a background encryption process, but it will not happen instantly, and the process to encrypt existing data will take time.</p>
			<p>Keys in Azure Key Vault can be easily created, but we can also <a id="_idIndexMarker372"/>import existing keys from a <strong class="bold">Hardware Security Module</strong> (<strong class="bold">HSM</strong>). This is for further security and compliance requirements and enables ultimate key management where crypto keys are safeguarded by a dedicated crypt processor.</p>
			<p>Encryption in Azure Storage is not only available through the Azure portal, but also through using Azure PowerShell. The following script will create a new Azure Storage account, Key Vault, and key, and then use all the resources provided to encrypt the Azure Storage account that was just created: </p>
			<pre>New-AzResourceGroup -Name 'Packt-Encrypt' -Location 'EastUS'
$storageAccount = Set-AzStorageAccount -ResourceGroupName 'Packt-Encrypt' `
    -Name packtstorageencryption `
    -AssignIdentity
New-AzKeyvault -name 'Pact-KV-01' -ResourceGroupName 'Packt-Encrypt' `
-Location 'EastUS' `
-EnabledForDiskEncryption `
-EnableSoftDelete `
-EnablePurgeProtection
$KeyVault = Get-AzKeyVault -VaultName 'Pact-KV-01' -ResourceGroupName 'Packt-Encrypt'
Set-AzKeyVaultAccessPolicy `
    -VaultName $keyVault.VaultName `
    -ObjectId $storageAccount.Identity.PrincipalId `
    -PermissionsToKeys wrapkey,unwrapkey,get,recover
$key = Add-AzKeyVaultKey -VaultName $keyVault.VaultName -Name 'MyKey' -Destination 'Software'
Set-AzStorageAccount -ResourceGroupName $storageAccount.ResourceGroupName `
    -AccountName $storageAccount.StorageAccountName `
    -KeyvaultEncryption `
    -KeyName $key.Name `
    -KeyVersion $key.Version `
    -KeyVaultUri $keyVault.VaultUri </pre>
			<p>Another thing we need to consider with Azure Storage is <strong class="bold">Advanced Threat Protection</strong> (<strong class="bold">ATP</strong>). This option is <a id="_idIndexMarker373"/>enabled under <strong class="bold">Advanced Security</strong> and it takes our security one step further. It uses security intelligence to detect any threat to our data and provides <a id="_idIndexMarker374"/>recommendations in order to increase security. </p>
			<p>An example of the <strong class="bold">Advanced Threat Protection</strong> blade under the storage account is shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.5.jpg" alt="Figure 6.5 – Azure Storage ATP&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.5 – Azure Storage ATP</p>
			<p>ATP compares our security settings to the recommended baseline and provides us with additional security options that can be implemented. The second part is to detect unusual and potentially harmful attempts to access or exploit Azure Storage. ATP is closely connected to Azure Security Center, which will be covered in <a href="B15414_07_Final_JM_ePub.xhtml#_idTextAnchor119"><em class="italic">Chapter 7</em></a>, <em class="italic">Azure Security Center</em>. But the storage account is not the only Azure service related to storage. Almost every Azure service uses some kind of storage. Among these services, we <a id="_idIndexMarker375"/>have Azure <strong class="bold">Virtual Machines</strong> (<strong class="bold">VMs</strong>) disks, so let's see how can we make these more secure.</p>
			<h1 id="_idParaDest-114"><a id="_idTextAnchor114"/>Understanding Azure Virtual Machines disks</h1>
			<p>Azure VM is part of Microsoft's <strong class="bold">Infrastructure as a Service</strong> (<strong class="bold">IaaS</strong>) offering and is another service that a <a id="_idIndexMarker376"/>lot of users encounter early in the cloud journey. Azure VM is usually selected when <a id="_idIndexMarker377"/>the user requires more control over the environment than other services can offer. But with more control also comes more responsibility. </p>
			<p>Besides network management, which was covered in <a href="B15414_04_Final_JM_ePub.xhtml#_idTextAnchor087"><em class="italic">Chapter 4</em></a>, <em class="italic">Azure Network Security</em>, we need to address how we handle data in Azure VM, and by data, we mainly mean disks. Just like all other data, disks for Azure VM are encrypted at rest, and VM uses Azure Service Fabric to securely access content stored on these disks. </p>
			<p>But what happens if we decide to download or export a disk used by these machines? Once a disk leaves Azure, it is in an unencrypted state and can be used in any way. This opens certain vulnerabilities that need to be addressed. What if someone gains access to Azure (but does not have access to a VM) and downloads a disk? What if someone decides to back up all disks, but to an unsecure location? These are only a couple of the scenarios that can create serious problems with unauthorized and malicious access to Azure VM disks. </p>
			<p>Fortunately, we have the option to use Azure Key Vault and enable the further encryption of disks. Disks encrypted in this way will stay encrypted even after they are exported, downloaded, or leave an Azure data center in any way.</p>
			<p>If we go to Azure VM and take a look at our disks, we can see that, by default, disk encryption is not enabled. An example is shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.6.jpg" alt="Figure 6.6 – Azure VM disk options to encrypt disks&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.6 – Azure VM disk options to encrypt disks</p>
			<p>We need to use Azure Key Vault and we need the key to be stored in the key vault. </p>
			<p>We can use Azure PowerShell to <a id="_idIndexMarker378"/>enable disk encryption for Azure VM disks. A sample script is provided here:</p>
			<pre>New-AzResourceGroup -Name "Packt-Encrypt" -Location "EastUS"
$cred = Get-Credential 
New-AzVM -Name 'Packt-VM-01' `
-Credential $cred `
-ResourceGroupName 'Packt-Encrypt' `
-Image win2016datacenter `
-Size Standard_D2S_V3
New-AzKeyvault -name 'Pact-KV-01' `
-ResourceGroupName 'Packt-Encrypt' `
-Location EastUS `
-EnabledForDiskEncryption `
-EnableSoftDelete `
-EnablePurgeProtection
$KeyVault = Get-AzKeyVault -VaultName 'Pact-KV-01' -ResourceGroupName 'Packt-Encrypt'
Set-AzVMDiskEncryptionExtension -ResourceGroupName 'Packt-Encrypt' `
-VMName 'Packt-VM-01' `
-DiskEncryptionKeyVaultUrl $KeyVault.VaultUri `
-DiskEncryptionKeyVaultId $KeyVault.ResourceId
Get-AzVmDiskEncryptionStatus -VMName Packt-VM-01 -ResourceGroupName Packt-Encrypt </pre>
			<p>This script creates a new Azure VM, a new key vault, and a new key. The created resources are then used to enable disk encryption for the just-created Azure VM. Finally, we can check the status <a id="_idIndexMarker379"/>of the disk and verify whether it was successfully encrypted. We can verify that the disk is encrypted in the Azure portal, as shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.7.jpg" alt=""/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.7– Azure VM portal</p>
			<p>The Azure VM disk is not encrypted: it can be accessed, used to create a new VM (Azure or a local Hyper-V), or attached to <a id="_idIndexMarker380"/>an existing VM. Encrypting the disk will prevent such access, unless the user has access to the key vault that was used during the encryption process.</p>
			<p>Working on Azure SQL Database</p>
			<p>Azure SQL Database is Microsoft's relational database cloud offering, which falls under the platform as a service <a id="_idIndexMarker381"/>model, often referred to as <strong class="bold">Database as a Service</strong> (<strong class="bold">DBaaS</strong>). It's highly available and provides a high-performance <a id="_idIndexMarker382"/>data storage layer. Because of that, it's often the choice when it comes to selecting a database in the cloud.</p>
			<p>There is a whole section of security-related features in Azure SQL Database's settings. There are four different options:</p>
			<ul>
				<li><strong class="bold">ADVANCED DATA SECURITY</strong></li>
				<li><strong class="bold">AUDITING</strong></li>
				<li><strong class="bold">DYNAMIC DATA MASKING</strong></li>
				<li><strong class="bold">TRANSPARENT DATA ENCRYPTION</strong></li>
			</ul>
			<p>If we enable <strong class="bold">ADVANCED DATA SECURITY</strong>, we get a few advantages:</p>
			<ul>
				<li><strong class="bold">VULNERABILITY ASSESSMENT SETTINGS</strong></li>
				<li><strong class="bold">ADVANCED THREAT PROTECTION SETTINGS</strong></li>
				<li><strong class="bold">DATA DISCOVERY &amp; CLASSIFICATION</strong> </li>
			</ul>
			<p>The options to enable <strong class="bold">ADVANCED DATA SECURITY</strong> are shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.8.jpg" alt="Figure 6.8 – Azure SQL Database advanced data security&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.8 – Azure SQL Database advanced data security</p>
			<p>Each of <a id="_idIndexMarker383"/>these options has additional configurations, which we need to set before using <strong class="bold">ADVANCED DATA SECURITY</strong>:</p>
			<ol>
				<li><strong class="bold">VULNERABILITY ASSESSMENT SETTINGS</strong> requires Azure Storage, which is where data will be kept and will provide security recommendations based on the current status. The assessment will be performed manually, and we can select whether the <a id="_idIndexMarker384"/>report will be sent to specific users or to all admins and subscription owners. The assessment report has the following format:<div><img src="img/Fig_6.9.jpg" alt="Figure 6.9 – Azure SQL Database assessment results&#13;&#10;"/></div><p class="figure-caption">Figure 6.9 – Azure SQL Database assessment results</p><p>The vulnerability assessment compares our current settings to the baseline and provides a list of checks that are not satisfied. It also provides a classification of checks based on risk level: <strong class="bold">High risk</strong>, <strong class="bold">Medium risk</strong>, and <strong class="bold">Low risk</strong>. </p></li>
				<li><strong class="bold">ADVANCED THREAT PROTECTION SETTINGS</strong> is very similar to this option in Azure Storage: it detects anything unusual and potentially harmful. We have a couple of <a id="_idIndexMarker385"/>additional settings compared to Azure Storage: we can select what types of threats we want to detect and define who gets notifications if a threat is detected. <p>A list of threats we can monitor is shown in the following diagram:</p><div><img src="img/Fig_6.10.jpg" alt="Figure 6.10 – Azure SQL Database advanced threat protection settings&#13;&#10;"/></div><p class="figure-caption">Figure 6.10 – Azure SQL Database advanced threat protection settings</p><p>Similar to <strong class="bold">VULNERABILITY ASSESSMENT SETTINGS</strong>, notifications about threats can be sent to specific users or all admins and subscription owners.</p></li>
				<li>The final option under <strong class="bold">ADVANCED DATA SECURITY</strong> is <strong class="bold">DATA DISCOVERY &amp; CLASSIFICATION</strong>. This option carries out data assessment and provides a classification for any data that should be confidential. Assessments are carried out <a id="_idIndexMarker386"/>based on various compliance and security requirements, and data is classified as confidential based on one or more criteria. For example, we may have some user information that should be classified <a id="_idIndexMarker387"/>based on the <strong class="bold">General Data Protection Regulation</strong> <strong class="bold">(GDPR)</strong>. But among user information, we may have social security or credit card numbers that are classified by many other compliance requirements. <strong class="bold">DATA DISCOVERY &amp; CLASSIFICATION</strong> only provides information about classified data types, but it's up to the user to decide what to proceed with and how to do so.</li>
			</ol>
			<p>This brings us to the next security setting under Azure SQL Database – <strong class="bold">Dynamic Data Masking</strong>. In the past, we could provide the user with access to different layers, such as database, schema, table, or row. However, we could not provide access based <a id="_idIndexMarker388"/>on the column. <strong class="bold">Dynamic Data Masking</strong> changes this and enables us to provide user access to a table but mask certain columns that the user should not be able to access. </p>
			<p>For example, let's say that we want to provide access to a customer table, but the user should not be able to access the customer's email address. We can create masking on the email column, and the user will be able to see all the information except the masked column, which will be displayed as masked (there are default masks for common data types, but custom masks can be created). For masked columns, we can exclude certain users. All administrators are excluded by default and cannot be excluded. An example of <strong class="bold">Dynamic Data Masking</strong> is shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.11.jpg" alt="Figure 6.11 – Dynamic Data Masking&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.11 – Dynamic Data Masking</p>
			<p><strong class="bold">Dynamic Data Masking</strong> is connected to <strong class="bold">DATA DISCOVERY &amp; CLASSIFICATION</strong>. The user will receive data masking recommendations based on information provided by <strong class="bold">DATA DISCOVERY &amp; CLASSIFICATION</strong>.</p>
			<p>The<strong class="bold"> Auditing</strong> option enables us to define where various logs will be stored. There are three different options available:</p>
			<ul>
				<li><strong class="bold">Storage</strong></li>
				<li><strong class="bold">Log Analytics </strong></li>
				<li><strong class="bold">Event Hubs</strong></li>
			</ul>
			<p>As many regulatory and security <a id="_idIndexMarker389"/>compliance standards require access and event logs to be stored, this option enables us to not only keep logs for auditing purposes but also to help us to understand and trace events whenever needed. Auditing can be enabled for a single database or on a server level. In the case that server auditing is enabled, logs will be kept for all databases located on that server. </p>
			<p>The last security setting <a id="_idIndexMarker390"/>under Azure SQL Database is <strong class="bold">Transparent Database Encryption</strong> (<strong class="bold">TDE</strong>). TDE is a method of encrypting data at rest and performs real-time encryption and decryption of data and log files at the page <a id="_idIndexMarker391"/>level. It uses a <strong class="bold">Database Encryption Key</strong> (<strong class="bold">DEK</strong>) to encrypt data, associated backups, and transactional logs.</p>
			<p>For older databases, this setting is <a id="_idIndexMarker392"/>not enabled, the TDE status is <strong class="bold">OFF</strong>, and <strong class="bold">Encryption</strong> <strong class="bold">status</strong> is <strong class="bold">Unencrypted</strong>. An example of this is shown in the following screesnhot:</p>
			<div><div><img src="img/Fig_6.12.jpg" alt="Figure 6.12 – Azure SQL Database TDE settings&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.12 – Azure SQL Database TDE settings</p>
			<p>For newer databases, TDE is already on and the encryption status is encrypted, as shown in the following screenshot:</p>
			<div><div><img src="img/Fig_6.13.jpg" alt="Figure 6.13 – Azure SQL Database encrypted with TDE&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.13 – Azure SQL Database encrypted with TDE</p>
			<p>We will get the same effect by switching TDE on for older databases. However, this method uses Microsoft-provided <a id="_idIndexMarker393"/>keys for encryption. If we need to follow regulatory and security compliance standards and manage keys ourselves, we must turn to Azure <strong class="bold">Key Vault</strong> once again. To enable TDE with our own key from Azure <strong class="bold">Key Vault</strong>, we must enable this setting at the server level. Under TDE settings, under <strong class="bold">Server</strong>, we can turn <strong class="bold">Use your own key</strong> on, as in the following screenshot:</p>
			<div><div><img src="img/Fig_6.14.jpg" alt="Figure 6.14 – Using a custom key for TDE&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 6.14 – Using a custom key for TDE</p>
			<p>Once we turn this option on, we need to provide the key vault and key that will be used. Optionally, we can set the selected key to be the default TDE protector.</p>
			<p>Enabling the option to use the key from the key vault for TDE will not enable TDE on every database located on the selected server. TDE must be enabled for each database separately. If this <a id="_idIndexMarker394"/>option is not set on the server, enabling TDE on the database will use Microsoft-managed keys. If the option is enabled on the server level, enabling TDE on the database will use the key from the key vault that is defined.</p>
			<p>Encryption can be set using Azure PowerShell, as in the following sample script:</p>
			<ol>
				<li value="1">We need to define parameters for execution. These will be used across the entire script, basically in each and every command we execute:<pre>$RGName = 'Packt-Encrypt'$servername = 'packtSQL'$DBName = 'test'</pre></li>
				<li>Next we need to log in to our Azure subscription:<pre><code>$cred = Get-Credential</code> </pre></li>
				<li>We will create Resource group, Azure SQL Server and Azure SQL database.<pre>$RG = New-AzResourceGroup -Name $RGName -Location 'EastUS'
$server = Set-AzSqlServer -ResourceGroupName $RG.ResourceGroupName `
-ServerName $servername `
-AssignIdentity
$server = New-AzSqlServer -ResourceGroupName $RG.ResourceGroupName  `
-Location 'EastUS' `
-ServerName $server.ServerName `
-ServerVersion "12.0" `
-SqlAdministratorCredentials $cred `
-AssignIdentity
$database = New-AzSqlDatabase  -ResourceGroupName $RG.ResourceGroupName `
-ServerName $server.ServerName `
-DatabaseName $DBName `
-RequestedServiceObjectiveName "S0" `
-SampleName "AdventureWorksLT"</pre></li>
				<li>Next, we need to create the Azure Key vault, which will be used in the data encryption process:<pre>New-AzKeyvault -name 'Pact-KV-01' -ResourceGroupName $RG.ResourceGroupName`
-Location 'EastUS' `
-EnabledForDiskEncryption `
-EnableSoftDelete `
-EnablePurgeProtection
$KeyVault = Get-AzKeyVault -VaultName 'Pact-KV-01' `
-ResourceGroupName $RG.ResourceGroupName</pre></li>
				<li>We now need to set the key vault access policy to enable encryption and add a key that will be used to encrypt the data: <pre>Set-AzKeyVaultAccessPolicy `
-VaultName $keyVault.VaultName `
-ObjectId $storageAccount.Identity.PrincipalId `
-PermissionsToKeys wrapkey,unwrapkey,get,recover
$key = Add-AzKeyVaultKey -VaultName $keyVault.VaultName `
-Name 'MyKey' `
-Destination 'Software'</pre></li>
				<li>Finally, we assign a key to Azure SQL Server, enable TDE using custom key from Key Vault, and encrypt the <a id="_idIndexMarker395"/>database using that key:<pre>Add-AzSqlServerKeyVaultKey -ResourceGroupName $RG.ResourceGroupName  `
-ServerName $server.ServerName `
-KeyId $key.Id
Set-AzSqlServerTransparentDataEncryptionProtector -ResourceGroupName $RG.ResourceGroupName  `
-ServerName $server.ServerName `
-Type AzureKeyVault `
-KeyId $key.Id
Get-AzSqlServerTransparentDataEncryptionProtector -ResourceGroupName $RG.ResourceGroupName  `
-ServerName $server.ServerName
Set-AzSqlDatabaseTransparentDataEncryption -ResourceGroupName -ResourceGroupName $RG.ResourceGroupName  `
-ServerName $server.ServerName `
-DatabaseName $database.DatabaseName `
-State "Enabled" </pre></li>
			</ol>
			<p>If the database has TDE enabled, with Microsoft-managed keys, enabling our own key from the key vault on a <a id="_idIndexMarker396"/>server level will not automatically transfer the encryption from the managed key to our own key. We must perform decryption and enable encryption again to use the key f<a id="_idTextAnchor115"/>rom the key vault.</p>
			<h1 id="_idParaDest-115"><a id="_idTextAnchor116"/>Summary</h1>
			<p>With all this work on the network and identity levels, we still need to do more and encrypt our data in the cloud. But is that enough? Often it is not, and then we find ourselves needing to do even more. Threats are becoming more and more sophisticated, and we need to find ways of increasing our security. In this chapter, we briefly mentioned Azure Security Center. It may be the one thing that can give us an advantage in creating a secure cloud environment and stopping threats and attacks before they even happen. </p>
			<p>In the next chapter, we will discuss how Azure Security Center uses security intelligence to be a central security safeguard in Azure.</p>
			<h1 id="_idParaDest-116"><a id="_idTextAnchor117"/>Questions</h1>
			<ol>
				<li value="1">What will the <strong class="bold">Secure transfer required</strong> option do?<p>A. Enforce data encryption</p><p>B. Enforce HTTPS</p><p>C. Enforce FTPS</p></li>
				<li>To protect data from accidental deletion, what needs to be enabled?<p>A. Data protection</p><p>B. Recycle Bin</p><p>C. Blob soft delete</p></li>
				<li>Is data in Azure Storage encrypted by default?<p>A. Yes</p><p>B. No</p></li>
				<li>Are Azure <strong class="bold">Virtual Machine</strong> (<strong class="bold">VM</strong>) disks encrypted by default?<p>A. Yes</p><p>B. No</p></li>
				<li>Is Azure SQL Database encrypted by default?<p>A. Yes</p><p>B. No</p></li>
				<li>Data in Azure can be encrypted with…<p>A. Microsoft-provided keys</p><p>B. User-provided keys</p><p>C. Both of the above</p></li>
				<li>Data in Azure SQL Database can be restricted using…<p>A. Data Classification</p><p>B. Dynamic Data Masking</p><p>C. Transparent Database Encryption (TDE)</p></li>
			</ol>
		</div>
	</body></html>