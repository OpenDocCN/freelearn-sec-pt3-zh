<html><head></head><body>
<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2"><h1 class="chapter-number" id="_idParaDest-84"><a id="_idTextAnchor095" class="pcalibre1 pcalibre2 pcalibre"/>5</h1>

<h3 id="_idParaDest-85" class="calibre6"><a id="_idTextAnchor096" class="pcalibre1 pcalibre2 pcalibre"/>DFIR Investigations – Logs in Azure</h3>
<p class="calibre3">In the previous chapter, we discussed responding to incidents in <strong class="bold">Amazon Web Services</strong> (<strong class="bold">AWS</strong>). This chapter will focus on responding to incidents in Microsoft Azure, the second most popular cloud computing product. One critical aspect of incident response in Azure is analyzing log data from different Azure services. In this chapter, we will explore the various log sources available in Azure, how to acquire them, and best practices for analyzing this data to detect, contain, and resolve security incidents in Azure. By understanding the tools and techniques available for incident response in Azure, incident response professionals can better protect and respond to an organization’s cloud infrastructure in the context of a <span>security incident.</span></p>
<p class="calibre3">Following a similar pattern to AWS, understanding which logs within Azure are available by default versus what defenders and investigators may have to enable is critical to cloud forensics. This chapter outlines the various logs available for some of the important Azure services and products discussed in <a href="part0021_split_000.html#_idTextAnchor042" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 3</em></span></a>, and also looks at utilizing these sources in the context of an investigation. Specifically, we will discuss the following Azure <span>data sources:</span></p>

<ul class="calibre12">
<li class="calibre13">Azure <span>Log Analytics</span></li>
<li class="calibre13">Azure <span>Virtual Network</span></li>
<li class="calibre13"><span>Azure Storage</span></li>
<li class="calibre13">Azure <span>Virtual Machines</span></li>
<li class="calibre13"><span>Microsoft Sentinel</span></li>
</ul>
</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h1 id="_idParaDest-86" class="calibre5"><a id="_idTextAnchor097" class="pcalibre1 pcalibre2 pcalibre"/>Azure Log Analytics</h1>
<p class="calibre3">Azure Log Analytics is a cloud-based service offered by Azure that allows organizations to collect, analyze, and gain insights from their log<a id="_idIndexMarker316" class="pcalibre1 pcalibre2 pcalibre"/> and operational data. It provides a centralized platform for monitoring, troubleshooting, and detecting anomalies across various cloud and on-premises environments. With Azure Log Analytics, organizations can gain visibility into their systems and applications, enabling them to make informed decisions and take proactive action to maintain optimal performance <span>and security.</span></p>
<p class="calibre3">Azure Log Analytics can be considered the equivalent of AWS CloudTrail (discussed in <a href="part0022_split_000.html#_idTextAnchor065" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 4</em></span></a>) when it comes to collecting and analyzing logs from various Azure services. By collecting logs from these services, organizations can gain insights into their performance, availability, and security. It provides a unified platform for monitoring and troubleshooting <span>Azure</span><span><a id="_idIndexMarker317" class="pcalibre1 pcalibre2 pcalibre"/></span><span> resources.</span></p>
<p class="calibre3">Azure Log Analytics is of paramount importance as it serves as the backbone for logging within the Azure ecosystem, providing comprehensive insights into Virtual Network environments, storage services, and EC2 instances. For that reason, we’ll briefly introduce the Azure Log Analytics role for the main Azure products and services here, then demonstrate how to integrate Log Analytics in the Azure product section of <span>this chapter.</span></p>
<p class="calibre3">To effectively manage and optimize cloud operations, organizations rely on Azure Log Analytics for comprehensive insights across various <span>Azure services:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Azure Virtual Networks</strong>: Azure Log Analytics integrates with Azure Network Watcher, which provides insights into<a id="_idIndexMarker318" class="pcalibre1 pcalibre2 pcalibre"/> Virtual Network traffic, network security groups, and flow logs. By analyzing these logs, organizations <a id="_idIndexMarker319" class="pcalibre1 pcalibre2 pcalibre"/>can monitor network activity, detect suspicious behavior, and ensure compliance with <span>security policies.</span></li>
<li class="calibre13"><strong class="bold">Azure Storage</strong>: Azure Log Analytics can collect logs from Azure Storage services, such as Blob storage and<a id="_idIndexMarker320" class="pcalibre1 pcalibre2 pcalibre"/> Table storage. This enables organizations to monitor and analyze storage-related activities, such as read and write operations, access patterns, and storage <span>capacity utilization.</span></li>
<li class="calibre13"><strong class="bold">Azure instances</strong>: Azure Log Analytics<a id="_idIndexMarker321" class="pcalibre1 pcalibre2 pcalibre"/> agents can be installed on Azure VMs to collect log data from these instances. This includes logs related to operating system events, application logs, and custom <span>log files.</span></li>
</ul>
<p class="calibre3">The idea with Log Analytics is to have telemetry from all your Azure resources available to query and/or visualize. Incident responders can then query these logs for any indicators of compromise. The following screenshot shows an example of log queries in Azure Monitor. We will discuss Azure Monitor later in <span>this chapter:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer066"><img alt="Figure 4.1 – Example of log queries" src="../images/00158.jpeg" class="calibre73"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.1 – Example of log queries</p>
<p class="calibre3">The query language in<a id="_idIndexMarker322" class="pcalibre1 pcalibre2 pcalibre"/> Azure is based on <strong class="bold">Kusto Query Language</strong> (<strong class="bold">KQL</strong>). KQL provides a syntax and set of operators that enable incident responders to retrieve, analyze, and visualize large <a id="_idIndexMarker323" class="pcalibre1 pcalibre2 pcalibre"/>volumes of data stored in Azure. Understanding KQL is critical for <span>incident responders.</span></p>
<p class="calibre3">While Azure Log Analytics, with its KQL, offers robust capabilities to parse vast datasets and retrieve essential insights, it becomes even more pivotal when considering the network infrastructure it monitors. Azure Virtual Networks, a cornerstone of Microsoft’s cloud environment, presents its own set of complexities. Understanding these networks and their interactions is paramount, and Log Analytics provides the tools to keep a keen eye <span>on them.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h1 id="_idParaDest-87" class="calibre5"><a id="_idTextAnchor098" class="pcalibre1 pcalibre2 pcalibre"/>Azure Virtual Networks</h1>
<p class="calibre3">A virtual network is very similar to<a id="_idIndexMarker324" class="pcalibre1 pcalibre2 pcalibre"/> the traditional network that you would operate and stand up in your own organization’s data center. Similar to how networking allows your organization’s assets and resources to communicate with each other, Azure’s Virtual Network service allows you to build a network for your Azure resources and services to communicate with each other, the public internet, or any of an organization’s on-premise networks <span>and resources.</span></p>
<p class="calibre3">Similar to AWS’s VPC, when you create a virtual machine resource in Azure, you can create an Azure Virtual Network or use an existing one (if it has been created already). Your virtual network is just like any other entity managed by Azure (known as an Azure Resource), such as a<a id="_idIndexMarker325" class="pcalibre1 pcalibre2 pcalibre"/> virtual machine, data store, database, or any other service we had previously discussed in <a href="part0021_split_000.html#_idTextAnchor042" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 3</em></span></a><span>.</span></p>
<p class="calibre3">For demonstration purposes and the purpose of this section, we have a created virtual network in Azure called <strong class="source-inline">CloudForensicsTestVM-vnet</strong>. All virtual networks can be accessed directly from the <strong class="bold">Virtual networks</strong> service on Azure’s <span><strong class="bold">Home</strong></span><span> page:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer067"><img alt="Figure 4.2 – Example of a virtual network" src="../images/00176.jpeg" class="calibre74"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.2 – Example of a virtual network</p>
<p class="calibre3">Depending on the size of an organization, there will likely be unused virtual networks that have been created for testing and development – incident responders should consider starting with investigating virtual networks containing production servers/services or critical jewels or investigating a virtual network based on whether any VMs contained have been <span>reported compromised.</span></p>
<p class="calibre3">Investigators can expand into a virtual network and determine its network properties and configurations, as <a id="_idIndexMarker326" class="pcalibre1 pcalibre2 pcalibre"/><span>shown here:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer068"><img alt="Figure 4.3 – Example of virtual network properties" src="../images/00193.jpeg" class="calibre75"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.3 – Example of virtual network properties</p>
<p class="calibre3">All virtual networks within Azure contain five <span>key tabs:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Topology</strong>: This is your virtual network topology. Think of this as a network diagram that’s auto-generated by Azure. This is especially useful for investigators to gain an understanding of an organization’s cloud infrastructure without dependence on whether the IT team has maintained networking diagrams and documentation. The following screenshot shows an example network topology containing a network interface and a single VM instance – the outline surrounding the interface and VM represents the virtual network and <span>default subnet:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer069"><img alt="Figure 4.4 – Example of a virtual network topology" src="../images/00012.jpeg" class="calibre76"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.4 – Example of a virtual network topology</p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Properties</strong>: This tab will include all networking configuration properties for your virtual network. This includes your IP address space, subnets, and Virtual Network ID. Investigators<a id="_idIndexMarker327" class="pcalibre1 pcalibre2 pcalibre"/> should take note of the address space and subnet IPs as understanding the network’s IP address range and subnet allows responders to identify and trace the origin of suspicious activities or malicious traffic. Further, knowing your address space allows you to correlate with other log sources that may capture resource IPs (for example, <span>EDR logs):</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer070"><img alt="Figure 4.5 – Example of network properties" src="../images/00031.jpeg" class="calibre77"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.5 – Example of network properties</p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Capabilities</strong>: This tab contains Azure products and services that may be utilized to further enhance the virtual network. For example, organizations may enable Azure’s DDoS protection or Azure Firewall as opposed to configuring their own load balancer or <a id="_idIndexMarker328" class="pcalibre1 pcalibre2 pcalibre"/>firewall. These capabilities not only provide additional security protection for Azure resources and assets but also act as additional log sources in an incident. For example, enabling Microsoft Defender for Cloud will provide threat protection for your VMs, containers, databases, storage app services, and more. Cloud Defender will generate additional security alerts/logs for any malicious activity detected in your Azure resource. We will dive deeper into Microsoft Defender for Cloud later in <span>this chapter:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer071"><img alt="Figure 4.6 – Example of virtual network capabilities" src="../images/00049.jpeg" class="calibre78"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.6 – Example of virtual network capabilities</p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Recommendations</strong>: The <strong class="bold">Recommendations</strong> tab provides a list of Azure recommendations based on cost, security, reliability, performance, and operational excellence. Threat management teams can utilize the <strong class="bold">Recommendations</strong> tab to enable any security posture and reliability quick wins based on personalized best practices defined by Microsoft’s automated advisor engine. Further, incident responders could utilize this tab for any recommendations to determine any gaps that may exist at the time of the incident and provide<a id="_idIndexMarker329" class="pcalibre1 pcalibre2 pcalibre"/> this in their recommendations report for threat management teams <span>to action:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer072"><img alt="Figure 4.7 – Example of Microsoft’s virtual network recommendations" src="../images/00066.jpeg" class="calibre79"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.7 – Example of Microsoft’s virtual network recommendations</p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Tutorials</strong>: This tab provides a list of free training from Microsoft. Microsoft, Amazon, and Google all continuously update features and products within their cloud offering. As a result, incident responders can utilize this tab to gain a quick understanding of any newly <span>added features.</span></li>
</ul>
<p class="calibre3">One essential tool that complements these properties and ensures the robustness of the network’s security<a id="_idIndexMarker330" class="pcalibre1 pcalibre2 pcalibre"/> posture is Azure’s <strong class="bold">Network Security Group</strong> (<strong class="bold">NSG</strong>) flow logs. These logs provide granular visibility into network traffic, bridging the gap between network configuration and actual <span>network activity.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h2 id="_idParaDest-88" class="calibre10"><a id="_idTextAnchor099" class="pcalibre1 pcalibre2 pcalibre"/>NSG flow logs</h2>
<p class="calibre3">In Azure, an NSG and a virtual network are two different concepts that play distinct roles in network security and network infrastructure management. An NSG is a fundamental component of Azure’s network <a id="_idIndexMarker331" class="pcalibre1 pcalibre2 pcalibre"/>security architecture. It acts as a virtual firewall for controlling inbound and outbound traffic to VMs, subnets, or network interfaces<a id="_idIndexMarker332" class="pcalibre1 pcalibre2 pcalibre"/> within an Azure virtual network. NSGs allow you to define inbound and outbound security rules to filter network traffic based on protocols, ports, source IP addresses, and destination IP addresses. They provide a fine-grained level of network security control by allowing or denying traffic based on <span>rule configurations.</span></p>
<p class="calibre3">An Azure virtual network is a foundational construct in Azure networking that represents an isolated network <a id="_idIndexMarker333" class="pcalibre1 pcalibre2 pcalibre"/>environment in the Azure cloud. As we have seen previously in this chapter, Azure Virtual Network allows organizations to define IP address ranges, subnets, and network topology to build their <span>network infrastructure.</span></p>
<p class="calibre3">Defining <strong class="bold">access control lists</strong> (<strong class="bold">ACLs</strong>) for an NSG in Azure involves configuring rules that control inbound and outbound network traffic for associated resources within a virtual network. ACLs act as virtual firewalls and provide granular control over network communication. Through NSG rules, you can specify allowed or denied traffic based on source/destination IP addresses, ports, and protocols. These rules help enforce security policies and restrict unauthorized access to VMs or subnets, allowing administrators to define and manage network traffic flow effectively. An example of an NSG is shown in the <span>following screenshot:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer073"><img alt="Figure 4.8 – Example of an NSG" src="../images/00084.jpeg" class="calibre80"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.8 – Example of an NSG</p>
<p class="calibre3">Defining ACLs in Azure and AWS have similarities in terms of their purpose and functionality. Both platforms allow users to create rules that control inbound and outbound network traffic based on source/destination IP addresses, ports, and protocols. An example of ACL <a id="_idIndexMarker334" class="pcalibre1 pcalibre2 pcalibre"/>rules for Azure NSGs is shown in the following screenshot. In this instance, the<a id="_idIndexMarker335" class="pcalibre1 pcalibre2 pcalibre"/> network only allows incoming (inbound) connections to port <strong class="source-inline">22</strong> (SSH) from a public source IP that has been redacted for <span>security reasons:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer074"><img alt="Figure 4.9 – ACLs" src="../images/00103.jpeg" class="calibre81"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.9 – ACLs</p>
<p class="calibre3">Incident responders can analyze ACLs to identify any unauthorized inbound connection rules (for example, RDP port open, allowing incoming connections from any IP address) or create new ACL rules to block any network-based indicators of compromise (for example, command and <span>control IPs).</span></p>
<p class="calibre3">As discussed in <a href="part0022_split_000.html#_idTextAnchor065" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 4</em></span></a>, a (network) flow log is a record of network traffic flow information, capturing details such as source and destination IP addresses, ports, protocols, and other relevant metadata related to network traffic. In the context of Azure, NSG flow logs specifically refer to the flow logs generated by NSGs in Azure. NSG flow logs provide visibility into the network traffic flowing through NSGs within a <span>virtual network.</span></p>
<p class="calibre3">By enabling NSG flow logs, organizations gain insights into network communication patterns, allowing them to monitor and analyze traffic behavior, detect anomalies, troubleshoot connectivity issues, and enhance network security analysis. These logs can be leveraged for forensic analysis, providing a valuable resource for understanding the full extent of a security breach and securing Azure <span>network environments.</span></p>
<p class="calibre3">Similar to AWS’s VPC flow logs, NSG flow logs are not enabled by default in Azure. As a result, they require explicit setup. To enable NSG flow logging, you must create an NSG flow log resource in Azure. Next, Azure gives you the option to download NSG logs locally, forward them to another tool (for example, a <strong class="bold">security information and event management</strong> (<strong class="bold">SIEM</strong>) system), or <a id="_idIndexMarker336" class="pcalibre1 pcalibre2 pcalibre"/>use Microsoft’s Azure Network Watcher Traffic Analytics solution. Traffic Analytics analyzes your Azure NSG flow logs within Azure, allowing organizations to visualize and query network activity and identify threats and areas of concern (open ports, unusual network traffic, and so on). The following three sequential steps are<a id="_idIndexMarker337" class="pcalibre1 pcalibre2 pcalibre"/> required to enable and view NSG <span>flow logs:</span></p>

<ol class="calibre14">
<li class="calibre13"><strong class="bold">Create an Azure storage account</strong>: To enable and create NSG flow logging, you must create and allocate storage to hold<a id="_idIndexMarker338" class="pcalibre1 pcalibre2 pcalibre"/> these logs in Azure. This can be done while you’re creating the flow log in Azure. Refer to the following screenshot to gain a visual understanding of an example storage account being set up in Azure, particularly during the NSG flow log <span>creation process:</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer075"><img alt="Figure 4.10 – Creating a storage account" src="../images/00125.jpeg" class="calibre82"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.10 – Creating a storage account</p>
<p class="calibre3">The following screenshot demonstrates the creation of a flow log <span>in Azure:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer076"><img alt="Figure 4.11 – Creating a flow log" src="../images/00146.jpeg" class="calibre83"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.11 – Creating a flow log</p>

<ol class="calibre14">
<li value="2" class="calibre13"><strong class="bold">Create an NSG flow log</strong>: This includes populating resources as well as other properties related to <a id="_idIndexMarker339" class="pcalibre1 pcalibre2 pcalibre"/>flow logging. You can export, process, analyze, and visualize NSG flow logs by using tools such as Microsoft’s Traffic Analytics, Splunk, Grafana, or<a id="_idIndexMarker340" class="pcalibre1 pcalibre2 pcalibre"/> any other SIEM tool. In this example, we will enable Microsoft’s Traffic Analytics as it is already integrated into Microsoft and allows quick and easy ingestion of the logs. The following screenshot demonstrates how to enable Traffic Analytics and send your network traffic to an Azure Log <span>Analytics workspace:</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer077"><img alt="Figure 4.12 – Creating a flow log and enabling Traffic Analytics" src="../images/00163.jpeg" class="calibre84"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.12 – Creating a flow log and enabling Traffic Analytics</p>

<ol class="calibre14">
<li value="3" class="calibre13">Navigate to the Traffic Analytics workspace you created in <em class="italic">step 2</em> to view and query the NSG flow log that<a id="_idIndexMarker341" class="pcalibre1 pcalibre2 pcalibre"/> was created in <em class="italic">steps 1</em> <span>and </span><span><em class="italic">2</em></span><span>.</span>
<p class="calibre3">Microsoft provides the<a id="_idIndexMarker342" class="pcalibre1 pcalibre2 pcalibre"/> following pre-built query to query NSG <span>flow logs:</span></p>
<pre class="source-code">AzureNetworkAnalytics_CL
| where SubType_s == "FlowLog"
| extend FlowDirection = iff(FlowDirection_s == 'O', 'Outbound', 'Inbound')
| extend AllowedOrDenied = iff(FlowStatus_s == 'A', 'Allowed', 'Denied')
| extend SourceIP = iff(isempty(SrcIP_s), extract_all(@"(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})", SrcPublicIPs_s), SrcIP_s)
| extend DestinationIP = iff(isempty(DestIP_s), extract_all(@"(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})", DestPublicIPs_s), DestIP_s)
| extend Protocol = case(L4Protocol_s == 'T', "TCP", L4Protocol_s == 'U', "UDP", L4Protocol_s)
| project-rename NSGFL_Version = FASchemaVersion_s
| project TimeGenerated, FlowDirection, AllowedOrDenied, SourceIP, DestinationIP, DestPort_d, Protocol, L7Protocol_s, NSGList_s, NSGRule_s, NSGFL_Version
| limit 100</pre></li> </ol>
<p class="calibre3">Here is a breakdown of the <span>KQL query:</span></p>

<ul class="calibre12">
<li class="calibre13">Table selection: <strong class="source-inline">AzureNetworkAnalytics_CL</strong> specifies the data table from which the query fetches the data – in this case, the Azure Network <span>Analytics logs</span></li>
<li class="calibre13">Filtering: <strong class="source-inline">| where SubType_s == "FlowLog"</strong> filters the data so that it only includes where the <strong class="source-inline">SubType</strong> column has a value <span>of </span><span><strong class="source-inline">FlowLog</strong></span></li>
<li class="calibre13">Data transformation <a id="_idIndexMarker343" class="pcalibre1 pcalibre2 pcalibre"/>with <strong class="source-inline">extend</strong>: The <strong class="source-inline">extend</strong> command is <a id="_idIndexMarker344" class="pcalibre1 pcalibre2 pcalibre"/>used multiple times to add new columns to <span>the data:</span><ul class="calibre17"><li class="calibre13"><strong class="source-inline">FlowDirection = iff(FlowDirection_s == 'O', 'Outbound', 'Inbound')</strong>: This adds a new column, <strong class="source-inline">FlowDirection</strong>, that classifies the flow direction as <strong class="source-inline">'Outbound'</strong> or <strong class="source-inline">'Inbound'</strong> based on the value <span>in </span><span><strong class="source-inline">FlowDirection_s</strong></span></li><li class="calibre13"><strong class="source-inline">AllowedOrDenied = iff(FlowStatus_s == 'A', 'Allowed', 'Denied')</strong>: This determines whether the flow was allowed <span>or denied</span></li><li class="calibre13"><strong class="source-inline">SourceIP</strong> and <strong class="source-inline">DestinationIP</strong>: These lines handle IP address extraction <span>and formatting</span></li><li class="calibre13"><strong class="source-inline">Protocol = case(...)</strong>: This sets the protocol as TCP or UDP or retains the original value based on <span>the condition</span></li></ul></li>
<li class="calibre13">Renaming a column: <strong class="source-inline">| project-rename NSGFL_Version = FASchemaVersion_s</strong> renames the <strong class="source-inline">FASchemaVersion_s</strong> column <span>to </span><span><strong class="source-inline">NSGFL_Version</strong></span></li>
<li class="calibre13">Selecting specific columns: The <strong class="source-inline">project</strong> command is used to select specific columns to be included in<a id="_idIndexMarker345" class="pcalibre1 pcalibre2 pcalibre"/> the <span>final output</span></li>
<li class="calibre13">Limiting results: <strong class="source-inline">| limit 100</strong> limits the output to the first <span>100 records</span></li>
</ul>
<p class="calibre3">In general, a KQL query will have the <a id="_idIndexMarker346" class="pcalibre1 pcalibre2 pcalibre"/>following <span>general structure:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Table selection</strong>: Queries start by specifying a data table (for example, <span>network events)</span></li>
<li class="calibre13"><strong class="bold">Pipes</strong> (<strong class="source-inline">|</strong>): This is used to chain different commands, where the output of one command is passed as input to <span>the next</span></li>
<li class="calibre13"><strong class="bold">Filtering (where)</strong>: This is used to include only those records that meet <span>certain criteria</span></li>
<li class="calibre13"><strong class="bold">Data transformation (extend)</strong>: This adds new columns or modifies <span>existing ones</span></li>
<li class="calibre13"><strong class="bold">Aggregation and grouping</strong>: Functions such as <strong class="source-inline">sum</strong>, <strong class="source-inline">count</strong>, <strong class="source-inline">avg</strong>, and <strong class="source-inline">group by</strong> are used for <span>data aggregation</span></li>
<li class="calibre13"><strong class="bold">Projection (project)</strong>: This specifies which columns to include in the <span>final output</span></li>
<li class="calibre13"><strong class="bold">Sorting and limiting</strong>: Commands such as <strong class="source-inline">sort by</strong> and <strong class="source-inline">limit</strong> control the order and the number of records in <span>the output</span></li>
</ul>
<p class="calibre3">The query results are shown in the following screenshot. As you can see, all allowed and denied inbound/outbound traffic is captured and displayed in tabular format. In this case, the entry containing an allowed inbound connection is our SSH connection into the VM resource (<strong class="bold">SourceIP</strong> has been redacted for privacy reasons) and signifies a potential point of entry and unauthorized access into <span>the VM:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer078"><img alt="Figure 4.13 – Flow log query results" src="../images/00182.jpeg" class="calibre85"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.13 – Flow log query results</p>
<p class="calibre3">Digital forensic and incident response use cases do not significantly change when transitioning from AWS flow logs to Azure flow logs due to their underlying purpose of capturing network traffic data. While there might be differences in the log format, user interface, and naming<a id="_idIndexMarker347" class="pcalibre1 pcalibre2 pcalibre"/> convention, both solutions offer valuable insights into network activity, facilitating investigations, threat detection, and incident response, regardless of the <span>cloud provider.</span></p>
<p class="calibre3">Within the realm of Azure Virtual Network, we’ve delved into creating a flow log and its subsequent querying, shedding<a id="_idIndexMarker348" class="pcalibre1 pcalibre2 pcalibre"/> light on the dynamic interplay of network data. Our next focus will be Azure Storage – a vital piece of the Azure ecosystem that not only stores such logs but offers extensive capabilities for managing and accessing vast volumes of <span>data seamlessly.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h2 id="_idParaDest-89" class="calibre10"><a id="_idTextAnchor100" class="pcalibre1 pcalibre2 pcalibre"/>Azure Storage</h2>
<p class="calibre3">Azure Storage is a cloud-based storage service provided by Azure. Azure Storage provides different storage options, one of which is Azure <span>Blob storage.</span></p>
<p class="calibre3">Azure Blobs, or Azure Binary<a id="_idIndexMarker349" class="pcalibre1 pcalibre2 pcalibre"/> Large Objects, are specific storage types <a id="_idIndexMarker350" class="pcalibre1 pcalibre2 pcalibre"/>within Azure Storage that are designed for storing unstructured data such as documents, images, videos, and other file types. It offers a simple and cost-effective way to store large amounts of data and provides features such as high availability, durability, and scalability. Azure Blobs are commonly used for backup and restore, content distribution, media streaming, and as a data source for applications running in <span>the cloud.</span></p>
<p class="calibre3">Within an Azure storage account, incident responders may want to start by reviewing the level of access for a <a id="_idIndexMarker351" class="pcalibre1 pcalibre2 pcalibre"/>given storage account (and by extension, the data it holds). This can be accomplished by navigating to the storage account’s <strong class="bold">Access Control (IAM)</strong> page and checking all users <a id="_idIndexMarker352" class="pcalibre1 pcalibre2 pcalibre"/>with access to <span>the data:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer079"><img alt="Figure 4.14 – The Access Control (IAM) pane" src="../images/00126.jpeg" class="calibre86"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.14 – The Access Control (IAM) pane</p>
<p class="calibre3">Next, investigators can utilize the <strong class="bold">Activity log</strong> page in the storage account – this can be found in the left pane. <strong class="bold">Activity log</strong> will show Azure tenant-wide activity at a subscription/Azure tenant level (for example, we can determine when a storage account was created in Azure and by whom). Turning to the following screenshot, we are presented with illustrative examples of an <span>activity log:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer080"><img alt="Figure 4.15 – Activity log" src="../images/00194.jpeg" class="calibre87"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.15 – Activity log</p>
<p class="calibre3">While the preceding screenshot provides an initial overview of the storage activity log, capturing its inherent<a id="_idIndexMarker353" class="pcalibre1 pcalibre2 pcalibre"/> structure and key data points, the following screenshot<a id="_idIndexMarker354" class="pcalibre1 pcalibre2 pcalibre"/> delves deeper, showcasing the results of a specific query, offering you insights into the type of information that can be extracted and analyzed from <span>such logs:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer081"><img alt="Figure 4.16 – Activity log (continued...)" src="../images/00151.jpeg" class="calibre88"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.16 – Activity log (continued...)</p>
<p class="calibre3">Investigators can export the log in the log format of their choice (for example, JSON, CSV, and so on) and analyze for any unusual activity – for example, which accounts modified your Azure resources (including storage resources) and what actions took place. The activity log<a id="_idIndexMarker355" class="pcalibre1 pcalibre2 pcalibre"/> contains all activity and therefore captures any new features or capabilities that have been<a id="_idIndexMarker356" class="pcalibre1 pcalibre2 pcalibre"/> turned on <span>and/or updated.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h2 id="_idParaDest-90" class="calibre10"><a id="_idTextAnchor101" class="pcalibre1 pcalibre2 pcalibre"/>Azure Monitor</h2>
<p class="calibre3">Azure Monitor is a comprehensive <a id="_idIndexMarker357" class="pcalibre1 pcalibre2 pcalibre"/>monitoring solution offered by Azure that allows organizations to collect, analyze, and act on telemetry data from various <a id="_idIndexMarker358" class="pcalibre1 pcalibre2 pcalibre"/>Azure resources, including Azure Storage and Azure Blobs. It provides insights into the performance, availability, and health of these resources, helping organizations gain visibility and make <span>informed decisions.</span></p>
<p class="calibre3">Incident responders can utilize the data produced from Azure Monitor for forensic investigation. For example, in the context of Azure Storage, incident responders can use Azure Monitor to chart egress (outgoing) data from an Azure storage account or blob. Incident responders can then use the egress data visualization to narrow down any spikes of egress data – that is, at which point in time there was an unusual amount of data leaving the organization’s cloud storage. This is particularly useful for security incidents involving data exfiltration as it allows incident responders to not only narrow down on dates/times of interest but also gain an understanding of the quantity of data that may have been stolen by bad actors. The following screenshot demonstrates an example of Azure Monitor being used to visualize and chart egress data over <span>30 days:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer082"><img alt="Figure 4.17 – Azure Monitor visualization of egress data" src="../images/00133.jpeg" class="calibre89"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.17 – Azure Monitor visualization of egress data</p>
<p class="calibre3">Similar to the virtual network logs we discussed previously, an organization’s resource logs (including a storage account and Storage Blob), must also be connected to an Azure Log Analytics workspace to<a id="_idIndexMarker359" class="pcalibre1 pcalibre2 pcalibre"/> enable the features of the Azure Monitor log, as well as run queries against this data. We had previously connected VPC logs to a Traffic Analytics workspace, which meant sending the VPC network data to<a id="_idIndexMarker360" class="pcalibre1 pcalibre2 pcalibre"/> a Log Analytics workspace in the backend to read and write traffic logs to. The following is a screenshot from Microsoft’s Azure portal on how to get set up with enabling Log Analytics for all your <span>Storage-related resources:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer083"><img alt="Figure 4.18 – Getting started with Log Analytics" src="../images/00099.jpeg" class="calibre90"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.18 – Getting started with Log Analytics</p>
<p class="calibre3">The following screenshot <a id="_idIndexMarker361" class="pcalibre1 pcalibre2 pcalibre"/>shows how to connect an Azure storage account (and its resources) to a Log Analytics workspace. From the left pane, navigate to <strong class="bold">Diagnostic settings</strong> to enable logs being<a id="_idIndexMarker362" class="pcalibre1 pcalibre2 pcalibre"/> sent to <span>Log Analytics:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer084"><img alt="Figure 4.19 – Connecting Log Analytics to storage resources" src="../images/00134.jpeg" class="calibre91"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.19 – Connecting Log Analytics to storage resources</p>
<p class="calibre3">Next, you should see all associated resources under your storage accounts. To enable Log Analytics, click on the storage account or any <span>other resource:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer085"><img alt="Figure 4.20 – Connecting Log Analytics to storage resources (continued…)" src="../images/00152.jpeg" class="calibre92"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.20 – Connecting Log Analytics to storage resources (continued…)</p>
<p class="calibre3">Transitioning to the following <a id="_idIndexMarker363" class="pcalibre1 pcalibre2 pcalibre"/>screenshot, we’re zooming into the nuanced procedure of connecting log analytics, this time specifically focusing on the<a id="_idIndexMarker364" class="pcalibre1 pcalibre2 pcalibre"/> diagnostic settings of a particular <span>storage account:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer086"><img alt="Figure 4.21 – Connecting Log Analytics to storage resources (continued…)" src="../images/00189.jpeg" class="calibre93"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.21 – Connecting Log Analytics to storage resources (continued…)</p>
<p class="calibre3">Finally, the following screenshot provides a detailed look into these diagnostic settings, highlighting the intricacies and parameters that users can leverage <span>and configure:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer087"><img alt="Figure 4.22 – Connecting Log Analytics to storage resources (continued…)" src="../images/00045.jpeg" class="calibre94"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.22 – Connecting Log Analytics to storage resources (continued…)</p>
<p class="calibre3">A similar process can be applied to<a id="_idIndexMarker365" class="pcalibre1 pcalibre2 pcalibre"/> the Azure Blob level, sending<a id="_idIndexMarker366" class="pcalibre1 pcalibre2 pcalibre"/> all read/write/delete and transaction logs to the Log <span>Analytics workspace:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer088"><img alt="Figure 4.23 – Connecting Log Analytics to storage resources (continued…)" src="../images/00061.jpeg" class="calibre95"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.23 – Connecting Log Analytics to storage resources (continued…)</p>
<p class="calibre3">The final <strong class="bold">Diagnostics settings</strong> pane should look as follows, with <strong class="bold">Diagnostics status</strong> set <span>to </span><span><strong class="bold">Enabled</strong></span><span>:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer089"><img alt="Figure 4.24 – Connecting Log Analytics to storage resources (continued…)" src="../images/00079.jpeg" class="calibre96"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.24 – Connecting Log Analytics to storage resources (continued…)</p>
<p class="calibre3">Incident responders can now <a id="_idIndexMarker367" class="pcalibre1 pcalibre2 pcalibre"/>query Azure Storage logs using the <strong class="bold">Logs</strong> functionality under <strong class="bold">Monitoring</strong>, which opens the query panel in Azure. See the<a id="_idIndexMarker368" class="pcalibre1 pcalibre2 pcalibre"/> following sample query to get all operations on Blobs within an Azure <span>storage account:</span></p>
<pre class="source-code">StorageBlobLogs
| where TimeGenerated &gt; ago(7d)
| project TimeGenerated, OperationName, AuthenticationType, Uri, _ResourceId, CallerIpAddress</pre>
<p class="calibre3">The preceding query can be utilized to display additional columns/fields from the storage accounts’ tables (that is, <strong class="source-inline">AzureMetrics</strong> and <strong class="source-inline">StorageBlobLogs</strong>) as well as narrow down on events of interest (that is, anonymous logins, operations of interest, and so on). The following screenshot demonstrates the query results of all a storage account’s <span>blob activity:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer090"><img alt="Figure 4.25 – Query results of blob storage activity" src="../images/00120.jpeg" class="calibre97"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.25 – Query results of blob storage activity</p>
<p class="calibre3">Now that we understand the nuances of Azure Storage and the intricacies of querying Blob Storage Activity, it’s clear that Azure’s capacity for data management and analytics is vast. Moving forward, we’ll <a id="_idIndexMarker369" class="pcalibre1 pcalibre2 pcalibre"/>delve into another integral component of Azure’s infrastructure: Azure Virtual Machines. This not only complements the storage solutions but also empowers them <a id="_idIndexMarker370" class="pcalibre1 pcalibre2 pcalibre"/>by providing dynamic compute resources for <span>diverse workloads.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h1 id="_idParaDest-91" class="calibre5"><a id="_idTextAnchor102" class="pcalibre1 pcalibre2 pcalibre"/>Azure Virtual Machines log analysis</h1>
<p class="calibre3">We discussed Azure Virtual Machines in <a href="part0021_split_000.html#_idTextAnchor042" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 3</em></span></a>. In Azure, VMs are widely used to deploy and run various applications <a id="_idIndexMarker371" class="pcalibre1 pcalibre2 pcalibre"/>and services. To ensure the security and stability of these VMs, incident responders and administrators must analyze the logs<a id="_idIndexMarker372" class="pcalibre1 pcalibre2 pcalibre"/> generated by the VMs. These logs provide valuable insights into the system’s activities, performance, security incidents, and potential vulnerabilities. In this section, we will explore the different log sources within Azure that incident responders can analyze for effective VM <span>log analysis.</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Azure Log Analytics</strong>: Azure Log Analytics is a powerful tool that centralizes log data from various sources, including Azure VMs. It provides a comprehensive log management solution and offers advanced querying and visualization capabilities. By integrating Azure VMs with Log Analytics, incident responders can collect and analyze logs from multiple VMs in a unified manner. The logs that are collected can include performance data, system events, security events, and custom application logs. Incident responders can utilize Log Analytics by leveraging its powerful querying capabilities using KQL. By constructing KQL queries targeted toward your VMs, incident responders can search through logs and telemetry data collected by Azure Monitor to<a id="_idIndexMarker373" class="pcalibre1 pcalibre2 pcalibre"/> identify potential <strong class="bold">indicators of compromise</strong> (<strong class="bold">IoCs</strong>) such as suspicious IP addresses, unusual network traffic patterns, or specific event logs associated with known threats. These queries can be tailored to filter and correlate relevant data sources, enabling proactive threat hunting and rapid identification of compromised systems or malicious activities within an <span>Azure environment.</span></li>
<li class="calibre13"><strong class="bold">Windows Event Logs</strong>: Azure <a id="_idIndexMarker374" class="pcalibre1 pcalibre2 pcalibre"/>VMs running on Windows operating systems generate Windows Event Logs, which capture important system events and errors. Incident responders can analyze these logs to identify system crashes, application failures, login attempts, and other critical events. Windows Event Logs are categorized into different event log channels, such as System, Security, Application, and more, making it easier to filter and analyze specific types <span>of events.</span></li>
<li class="calibre13"><strong class="bold">Azure Activity Logs</strong>: Azure Activity Logs provides an audit trail of operations performed on Azure resources, including VMs. These logs capture information about resource creation, updates, and deletions, as well as administrative actions taken by users and Azure services. Incident responders can leverage Azure Activity Logs to track changes made to VM configurations, identify potential misconfigurations, and investigate <span>suspicious activities.</span></li>
<li class="calibre13"><strong class="bold">Azure Monitor</strong>: Azure Monitor can also be utilized to capture VM performance metrics, diagnostic logs, and even custom application logs. Incident responders can utilize Azure Monitor to visualize anomalies in the VM, such as unusual CPU usage or disk bandwidth, which may suggest unauthorized access. Azure Monitor also integrates <a id="_idIndexMarker375" class="pcalibre1 pcalibre2 pcalibre"/>with <strong class="bold">Azure Kubernetes Service</strong> (<strong class="bold">AKS</strong>) to provide monitoring and logging capabilities for any AKS containers. You can enable monitoring when you create an AKS cluster or add it to an existing cluster. Additionally, Azure Monitor extends its capabilities to serverless computing resources in Azure, such as Azure Functions and Azure Logic Apps. By leveraging Application Insights, a feature of Azure Monitor, incident responders can gain in-depth insights into <span>serverless components.</span></li>
<li class="calibre13"><strong class="bold">Windows Defender Logs</strong>: For VMs running Windows Defender, incident responders can analyze the logs generated by the antivirus software. These logs contain information about detected threats, blocked malware, and other security-related events. By analyzing Windows Defender logs, responders can identify potential security breaches, investigate malware infections, and take appropriate actions to mitigate risks. Windows Defender is the endpoint security antivirus tool at the<a id="_idIndexMarker376" class="pcalibre1 pcalibre2 pcalibre"/> endpoint level (that is, installed on <span>your VMs).</span></li>
<li class="calibre13"><strong class="bold">Azure Linux VMs and Linux Logs</strong>: For Linux-based VMs in Microsoft Azure, incident responders can analyze logs generated by the system’s syslog service and Microsoft security tools. Incident responders can utilize Azure’s integration with Linux VMs, which provides system events through syslog, such as system alerts, errors, user login activities, and other system-level messages. These logs are instrumental in tracing system anomalies, security incidents, and potential unauthorized access. In addition to the basic syslog capabilities, Azure offers integration with its suite of security tools, such as Microsoft Defender, which can be used to enhance the security monitoring of Linux VMs. Microsoft Defender provides advanced threat protection features, detecting and analyzing potential threats and vulnerabilities for <span>Linux resources.</span></li>
</ul>
<p class="calibre3">Having explored the diverse range of log sources available on Azure Virtual Machines, from Azure Log Analytics to Windows Defender Logs, it’s evident that Azure provides comprehensive tools for incident responders to track and analyze VM activities. With this foundation in place, we can now shift our focus to an even more integrated security solution within the Azure ecosystem: Microsoft Defender for Cloud. This solution synergistically utilizes these logs to offer holistic security insights and proactive <span>threat protection.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h2 id="_idParaDest-92" class="calibre10"><a id="_idTextAnchor103" class="pcalibre1 pcalibre2 pcalibre"/>Microsoft Defender for Cloud</h2>
<p class="calibre3">Previously called Azure Security Center, Microsoft Defender for Cloud provides advanced threat detection and security monitoring for Azure resources, including VMs. It analyzes security-related events, performs behavioral analysis, and provides security recommendations. Incident responders<a id="_idIndexMarker377" class="pcalibre1 pcalibre2 pcalibre"/> can leverage Microsoft Defender for Cloud to identify potential security vulnerabilities, investigate security incidents, and respond to threats effectively. The following screenshot demonstrates an example of security alerts being reported by Microsoft Defender for Cloud. In this example, we can observe that Mimikatz’s credential theft tool was detected on a VM resource. Incident responders can utilize these alerts in the larger context of their investigation to determine attack tactics utilized by <span>bad actors:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer091"><img alt="Figure 4.26 – Microsoft Defender for Cloud alerts" src="../images/00026.jpeg" class="calibre98"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.26 – Microsoft Defender for Cloud alerts</p>
<p class="calibre3">Microsoft Defender for Cloud also provides configuration recommendations based on continuous monitoring, which can help incident responders identify any outstanding security vulnerabilities. The following screenshot shows an example of the <strong class="bold">Recommendations</strong> pane in Microsoft Defender <span>for Cloud:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer092"><img alt="Figure 4.27 – Microsoft Defender for Cloud – Recommendations" src="../images/00177.jpeg" class="calibre99"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.27 – Microsoft Defender for Cloud – Recommendations</p>
<p class="calibre3">While Microsoft Defender for Cloud offers comprehensive monitoring and security recommendations, Azure also provides tools for in-depth network traffic analysis for your VMs. One of the most valuable tools for this purpose is NSG flow logs. This feature gives administrators granular<a id="_idIndexMarker378" class="pcalibre1 pcalibre2 pcalibre"/> insights into network activities, complementing the protections provided by Microsoft Defender <span>for Cloud.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h2 id="_idParaDest-93" class="calibre10"><a id="_idTextAnchor104" class="pcalibre1 pcalibre2 pcalibre"/>NSG flow logs</h2>
<p class="calibre3">NSG flow logs capture information about network traffic flowing through NSGs associated with Azure VMs. These logs <a id="_idIndexMarker379" class="pcalibre1 pcalibre2 pcalibre"/>provide insights into allowed and denied network connections, including source and destination IP addresses, ports, and protocols. Incident responders can analyze NSG flow logs to detect suspicious network activities, identify potential attacks, and enforce network security policies effectively. We discussed NSG flow logs earlier in <span>this chapter.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Products and services such as Virtual Network, Storage, and Virtual Machines in Azure share common monitoring and logging capabilities through services such as Azure Log Analytics, Azure Monitor, and Azure Activity. These services provide comprehensive insights into the health, performance, and activity of the resources deployed <span>in Azure.</span></p>
<p class="callout">Regardless of whether you are monitoring a virtual network, storage, or VMs, the fundamental approach remains similar. Azure Log Analytics allows you to collect, centralize, and analyze logs and metrics from various sources. Azure Monitor provides a unified monitoring experience, offering alerts, dashboards, and visualizations to gain real-time insights into resource performance and availability. Azure Activity Logs captures subscription-level events and actions for auditing and <span>tracking purposes.</span></p>
<p class="calibre3">After delving into the intricacies of logging information of Azure Virtual Machines, specifically the capabilities of Microsoft Defender for Cloud and NSG flow logs, it’s clear that Azure offers robust tools for security and traffic analysis. However, Azure’s suite doesn’t stop there. Transitioning <a id="_idIndexMarker380" class="pcalibre1 pcalibre2 pcalibre"/>to our next section, we’ll explore the comprehensive threat intelligence capabilities of <span>Microsoft Sentinel.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h1 id="_idParaDest-94" class="calibre5"><a id="_idTextAnchor105" class="pcalibre1 pcalibre2 pcalibre"/>Microsoft Sentinel</h1>
<p class="calibre3">Microsoft Sentinel is a powerful cloud-native SIEM solution offered by Azure. It enables organizations to detect, investigate, and<a id="_idIndexMarker381" class="pcalibre1 pcalibre2 pcalibre"/> respond to security threats by collecting, analyzing, and visualizing vast amounts of security data from various sources in <span>real time.</span></p>
<p class="calibre3">A SIEM is a comprehensive software solution<a id="_idIndexMarker382" class="pcalibre1 pcalibre2 pcalibre"/> that combines <strong class="bold">security information management</strong> (<strong class="bold">SIM</strong>) and <strong class="bold">security event management</strong> (<strong class="bold">SEM</strong>) capabilities. It serves as<a id="_idIndexMarker383" class="pcalibre1 pcalibre2 pcalibre"/> a central hub for ingesting and correlating logs and events from diverse sources, providing a unified view of an organization’s <span>security landscape.</span></p>
<p class="calibre3">During a security incident, incident responders can leverage Microsoft Sentinel’s advanced features to effectively respond and mitigate threats. Here are specific ways incident responders can utilize <span>Microsoft Sentinel:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Log collection and integration</strong>: Microsoft Sentinel supports the ingestion of data from a wide range of sources, including Azure services, on-premises infrastructure, security solutions, and third-party tools. Incident responders can configure data connectors to collect logs and events, ensuring comprehensive visibility across the <span>entire environment.</span></li>
<li class="calibre13"><strong class="bold">Threat detection and analytics</strong>: Microsoft Sentinel employs machine learning algorithms and advanced analytics to detect and prioritize potential security threats. Its built-in analytics templates and detection rules help identify suspicious activities, anomalous behavior, or known attack patterns. Incident responders can leverage<a id="_idIndexMarker384" class="pcalibre1 pcalibre2 pcalibre"/> these capabilities to identify IoCs and detect <span>emerging threats.</span></li>
<li class="calibre13"><strong class="bold">Real-time monitoring and alerting</strong>: Microsoft Sentinel provides real-time monitoring of security events and generates alerts based on predefined rules and analytics. Incident responders can configure alert rules to trigger notifications when specific conditions or behaviors indicative of a security incident occur. These alerts can be customized to prioritize critical events and be integrated with other incident <span>response systems.</span></li>
<li class="calibre13"><strong class="bold">Investigation and hunting</strong>: Microsoft Sentinel offers powerful search and query capabilities to investigate security incidents thoroughly. Incident responders can query and explore large volumes of data, filter results based on various attributes, and pivot between different data dimensions. The interactive workspace in Sentinel allows responders to visualize and correlate data, enabling in-depth investigations and proactive <span>threat hunting.</span></li>
<li class="calibre13"><strong class="bold">Automated response and orchestration</strong>: Microsoft Sentinel provides playbooks, which are pre-defined automated workflows, to facilitate incident response actions. Incident responders can create playbooks to automate repetitive and manual tasks, such as enriching alerts with additional context, blocking suspicious IP addresses, or quarantining compromised assets. This feature helps streamline incident response processes and reduce <span>response times.</span></li>
<li class="calibre13"><strong class="bold">Integration with security solutions</strong>: Microsoft Sentinel integrates seamlessly with various Microsoft security solutions and third-party tools. Incident responders can leverage these integrations to enrich investigations, gather additional context, and orchestrate response actions across the security ecosystem, providing a unified and coordinated approach to <span>incident response.</span></li>
</ul>
<p class="calibre3">The following screenshot shows<a id="_idIndexMarker385" class="pcalibre1 pcalibre2 pcalibre"/> Microsoft Sentinel with active alerts and <span>data connected:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer093"><img alt="Figure 4.28 – Microsoft Sentinel – Incidents" src="../images/00195.jpeg" class="calibre100"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 4.28 – Microsoft Sentinel – Incidents</p>
<p class="calibre3">Microsoft Sentinel is not automatically activated for customers; it requires manual setup and configuration. Organizations must actively choose to implement and configure Microsoft Sentinel in their Azure environment to utilize its security analytics and threat intelligence capabilities. As we conclude our exploration of Microsoft Sentinel, it’s evident that its advanced threat intelligence and security analytics capabilities play a pivotal role in fortifying Azure’s cloud ecosystem. By utilizing Microsoft Sentinel as a SIEM, security analysts and incident responders can harness the full potential of Sentinel to safeguard their digital environments in an ever-evolving <span>threat landscape.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h1 id="_idParaDest-95" class="calibre5"><a id="_idTextAnchor106" class="pcalibre1 pcalibre2 pcalibre"/>Summary</h1>
<p class="calibre3">This chapter delved into the crucial role of log analysis in incident response within the Azure environment. It emphasized the significance of understanding the available log sources in Azure, how to obtain them, and best practices for analyzing the data to effectively detect, contain, and resolve security incidents. By familiarizing incident response professionals with the tools and techniques specific to Azure, they can enhance their ability to safeguard and respond to security incidents in a cloud <span>infrastructure context.</span></p>
<p class="calibre3">This chapter highlighted the importance of differentiating between default log availability and the need to enable certain logs, drawing parallels to AWS. Then, it outlined the diverse logs provided by essential Azure services and products, as previously discussed in <a href="part0021_split_000.html#_idTextAnchor042" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 3</em></span></a>, and examined their utilization for investigative purposes. In particular, this chapter explored Azure Log Analytics, Azure Virtual Network flow logs, Azure Storage, Azure Virtual Machines, and other Azure tools, such as Microsoft Sentinel, as valuable data sources for <span>incident response.</span></p>
<p class="calibre3">In the next chapter, we will shift our focus to <strong class="bold">Google Cloud Platform</strong> (<strong class="bold">GCP</strong>) and explore the various log sources that can be enabled and utilized <span>during incidents.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer094" class="calibre2">
<h1 id="_idParaDest-96" class="calibre5"><a id="_idTextAnchor107" class="pcalibre1 pcalibre2 pcalibre"/>Further reading</h1>
<p class="calibre3">To learn more about the topics that were covered in this chapter, take a look at the <span>following resources:</span></p>

<ul class="calibre12">
<li class="calibre13"><em class="italic">Azure </em><span><em class="italic">Monitor</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/monitor-vm" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/azure/virtual-machines/monitor-vm</span></a></li>
<li class="calibre13"><em class="italic">Microsoft Defender for </em><span><em class="italic">Cloud</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-cloud-introduction" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-cloud-introduction</span></a></li>
<li class="calibre13"><em class="italic">Log </em><span><em class="italic">Analytics</em></span><span>:</span> <a href="https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-tutorial" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-tutorial</span></a></li>
<li class="calibre13"><em class="italic">NSG flow </em><span><em class="italic">logs</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview</span></a></li>
<li class="calibre13"><em class="italic">Azure Virtual </em><span><em class="italic">Networks</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview</span></a></li>
<li class="calibre13"><em class="italic">Traffic </em><span><em class="italic">Analytics</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/azure/network-watcher/traffic-analytics" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/azure/network-watcher/traffic-analytics</span></a></li>
<li class="calibre13"><em class="italic">Microsoft Defender for </em><span><em class="italic">Endpoint</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/microsoft-defender-endpoint?view=o365-worldwide" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/microsoft-defender-endpoint?view=o365-worldwide</span></a></li>
<li class="calibre13"><em class="italic">Microsoft </em><span><em class="italic">Sentinel</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/azure/sentinel/overview" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/azure/sentinel/overview</span></a></li>
</ul></div>
</div>
</body></html>