<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-15"><a id="_idTextAnchor014"/>1</h1>
<h1 id="_idParaDest-16"><a id="_idTextAnchor015"/>Intrusion Detection System (IDS) Using Wazuh</h1>
<p>Organizations of all sizes are increasingly concerned about protecting their digital landscape. With technology growing and digital systems becoming more important, cyber threats are escalating rapidly. Organizations must take a proactive approach toward cybersecurity and deploy mechanisms and appropriate visibility controls that not only prevent but also detect threats or intrusions. The main goal of prevention techniques is to keep threats from getting into a network or system. Like deploying perimeter security <a id="_idIndexMarker000"/>solutions such as firewalls, <strong class="bold">intrusion prevention system</strong> (<strong class="bold">IPS</strong>) infrastructure, visibility and control, and, most importantly, endpoint protection and insider threats. They intend to put up barriers that make it impossible for bad people to get in or execute any cyber-attacks.</p>
<p>Detection techniques, along with preventive measures, involve keeping an eye on systems all the time for any signs of compromise or strange behavior and taking the required steps to mitigate the execution of reported malicious activity/behavior. One of the popular <a id="_idIndexMarker001"/>tools for this purpose is an <strong class="bold">intrusion detection system</strong> (<strong class="bold">IDS</strong>). Wazuh can help organizations detect potential threats or ongoing attacks, and an IDS also allows a security team to enable the early detection of possible breaches or suspicious activity, and, as a result, the security team can quickly respond to mitigate potential damage. Wazuh is a popular IDS result, which works on various levels including host-level visibility along with the capability to collect, aggregate, index, and analyze logs from various sources at a perimeter and infrastructure level; it also offers end-user activity monitoring solutions and protection. It provides a ton of features, including log collection. In addition to log collection, it has various inbuilt modules including vulnerability management, file integrity, malware detection, automated incident response, and various external integrations. Another open source popular IDS/IPS <a id="_idIndexMarker002"/>solution is <strong class="bold">Suricata</strong>, which works on a network level that helps the security team detect anomalous network behavior. In this book, we get hands-on with Wazuh capabilities and features, however, in this chapter, our focus will be on integrating Suricata IDS/IPS with Wazuh. This will help us detect any network anomalous behavior.</p>
<p>In this chapter, we will learn the following:</p>
<ul>
<li>What is an IDS?</li>
<li>Configuring an IDS on Ubuntu and Windows Server</li>
<li>Getting started with Wazuh and Suricata</li>
<li>Detecting network scanning probes</li>
<li>Testing web-based <a id="_idIndexMarker003"/>attacks with <strong class="bold">Damn Vulnerable Web </strong><strong class="bold">Application</strong> (<strong class="bold">DVWA</strong>).</li>
<li>Testing <a id="_idIndexMarker004"/>a <strong class="bold">network-based IDS</strong> (<strong class="bold">NIDS</strong>) using <strong class="bold">tmNIDS</strong></li>
</ul>
<h1 id="_idParaDest-17"><a id="_idTextAnchor016"/>What is an IDS?</h1>
<p>An IDS works by monitoring network traffic, system logs, and other relevant information to identify and <a id="_idIndexMarker005"/>analyze patterns and signatures associated with known threats or abnormal behavior. The primary goal of an IDS is to detect and alert security administrators about potential threats or breaches. When an IDS identifies suspicious behavior or patterns, it generates an alert, notifying the security team to take appropriate action.</p>
<h2 id="_idParaDest-18"><a id="_idTextAnchor017"/>Types of IDS</h2>
<p>There are two <a id="_idIndexMarker006"/>main types of IDS: NIDS and <strong class="bold">host-based IDS</strong> (<strong class="bold">HIDS</strong>). The main <a id="_idIndexMarker007"/>difference between a NIDS and a HIDS is the monitoring scope and types of activities they detect. Have a look at the following table to look at the differences:</p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-1">
<colgroup>
<col/>
<col/>
<col/>
</colgroup>
<thead>
<tr class="No-Table-Style">
<td class="No-Table-Style"/>
<td class="No-Table-Style">
<p><strong class="bold">NIDS</strong></p>
</td>
<td class="No-Table-Style">
<p><strong class="bold">HIDS</strong></p>
</td>
</tr>
</thead>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Scope</p>
</td>
<td class="No-Table-Style">
<p>It works at the network level, monitoring the data going to and from different devices to look for abnormal behaviors or events that might indicate an intrusion.</p>
</td>
<td class="No-Table-Style">
<p>It is installed directly on the host’s and monitor’s log files, system calls, file integrity, and other host-specific files for any unusual activities.</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Location</p>
</td>
<td class="No-Table-Style">
<p>Functions at one or more central places in a network’s infrastructure to monitor and analyze traffic going through those points.</p>
</td>
<td class="No-Table-Style">
<p>Operates locally on individual hosts or devices, keeping an eye on actions that are unique to that machine.</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Detection focus</p>
</td>
<td class="No-Table-Style">
<p>A NIDS detects network attacks and anomalies. It can detect port scans, DoS attacks, intrusion attempts, and other network infrastructure threats.</p>
</td>
<td class="No-Table-Style">
<p>A HIDS monitors host activity. It detects unauthorized access, file system changes, critical system file modifications, and suspicious processes or behaviors that may indicate a compromised host.</p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p>Popular tools</p>
</td>
<td class="No-Table-Style">
<p>Suricata, Snort</p>
</td>
<td class="No-Table-Style">
<p>Wazuh, OSSEC</p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 1.1 – NIDS versus HIDS</p>
<p>In the <a id="_idIndexMarker008"/>following diagram, you can see that a NIDS is installed to monitor network traffic while an HIDS monitors individual devices.</p>
<div><div><img alt="Figure 1.1 – NIDS versus HIDS" src="img/B19549_1_01.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.1 – NIDS versus HIDS</p>
<h1 id="_idParaDest-19"><a id="_idTextAnchor018"/>What is Suricata?</h1>
<p><strong class="bold">Suricata</strong> is an <a id="_idIndexMarker009"/>open-source network <strong class="bold">intrusion detection and prevention system</strong> (<strong class="bold">IDS/IPS</strong>). It is intended to monitor network traffic and detect a variety <a id="_idIndexMarker010"/>of threats, including malware, intrusion attempts, and network anomalies. Using a rule-based language, Suricata analyzes network packets in real time, allowing it to identify and respond to suspicious <a id="_idIndexMarker011"/>or malicious activities. The non-profit organization <strong class="bold">OISF</strong> (<strong class="bold">Open Information Security Foundation</strong>) owns and develops Suricata.</p>
<p>Suricata can also be deployed as an IPS in order to detect and block malicious traffic to the organization. Although IPS deployment might sound like the obvious option, unfortunately, it isn’t that friendly; it often blocks legitimate traffic as well if they aren’t configured properly. And yes, this is why the detection approach is sometimes better than the prevention approach.</p>
<p>You can <a id="_idIndexMarker012"/>download Suricata from the following link: <a href="https://suricata.io/download/">https://suricata.io/download/</a>.</p>
<p>There are multiple use cases of Suricata IDS; some of the important use cases are as follows:</p>
<ul>
<li><strong class="bold">Network traffic monitoring</strong>: Suricata analyzes real-time network traffic for threats <a id="_idIndexMarker013"/>and anomalies. Organizations need to smartly deploy Suricata at various points in the network to analyze both incoming and outgoing <a id="_idIndexMarker014"/>traffic. This use case can help us detect malware, <strong class="bold">Distributed Denial of Service</strong> (<strong class="bold">DDoS</strong>) attacks, port scans, reconnaissance data exfiltration, and so on.</li>
<li><strong class="bold">Signature and anomaly detection</strong>: Suricata detects known attack patterns or signatures by checking network traffic against a library of rules and patterns that have already been set up. In this chapter, we will use the Suricata ruleset created <a id="_idIndexMarker015"/>by the <strong class="bold">Emerging Threats</strong> (<strong class="bold">ET</strong>) community. This ruleset can help us detect known malware, viruses, web-based attacks (SQL Injection, cross-site scripting attacks, etc.), known network attack signatures, and so on.</li>
<li><strong class="bold">Protocol analysis</strong>: Suricata can deeply examine many different network technologies, such as HTTP, DNS, and TLS. This helps us to discover anomalous behaviors of protocols, such as unusual HTTP requests, DNS tunneling, and unexpected SSL/TLS handshakes.</li>
<li><strong class="bold">Logging and alerting</strong>: Suricata keeps logs and sends out alerts when it detects possible threats. These alerts can be used to get security teams to act right away, or <a id="_idIndexMarker016"/>they can be added to <strong class="bold">security information and event management</strong> (<strong class="bold">SIEM</strong>) systems so that they can be analyzed further and linked to other security events. Wazuh, Splunk, Elastic, and all the popular SIEM solutions support integration with the Suricata IDS.</li>
</ul>
<p>Let’s learn about the deployment methods of the Suricata IDS.</p>
<h2 id="_idParaDest-20"><a id="_idTextAnchor019"/>How organizations use Suricata as an IDS</h2>
<p>There are several ways to deploy the Suricata IDS and some of the important and popular <a id="_idIndexMarker017"/>deployment methods are explained in the following:</p>
<ul>
<li><strong class="bold">Inline deployment at network perimeter</strong>: Suricata sits between the external <a id="_idIndexMarker018"/>internet connection and the internal network, actively monitoring and <a id="_idIndexMarker019"/>scrutinizing network traffic in real time. It can <a id="_idIndexMarker020"/>be deployed as a physical appliance or as a <strong class="bold">virtual machine</strong> (<strong class="bold">VM</strong>). The network traffic passes through Suricata, which analyzes the packets and acts based on the criteria that have been defined.</li>
</ul>
<div><div><img alt="Figure 1.2 – Inline deployment at network perimeter" src="img/B19549_1_02.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.2 – Inline deployment at network perimeter</p>
<ul>
<li><strong class="bold">Internal network monitoring</strong>: Suricata sensors are strategically located within <a id="_idIndexMarker021"/>the internal network in order to capture network traffic between segments or departments. These sensors could be physical or virtual devices. They analyze the captured traffic and transmit alerts or records to a centralized management system for additional analysis and response. As you can see in the following diagram, the sensors will export the data to a centralized server.</li>
</ul>
<div><div><img alt="Figure 1.3 – Internal network monitoring" src="img/B19549_1_03.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.3 – Internal network monitoring</p>
<ul>
<li><strong class="bold">Cloud environment monitoring</strong>: Suricata can be deployed as virtual appliances <a id="_idIndexMarker022"/>or containers in AWS and Azure cloud environments. It is installed within the cloud infrastructure and monitors network traffic within virtual networks and between cloud resources. The captured traffic is transmitted to a central analysis system for response detection.</li>
</ul>
<div><div><img alt="Figure 1.4 – Cloud security monitoring (AWS)" src="img/B19549_1_04.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.4 – Cloud security monitoring (AWS)</p>
<ul>
<li><strong class="bold">Network tap deployment</strong>: Suricata <a id="_idIndexMarker023"/>is used in conjunction with <strong class="bold">network taps</strong> or <strong class="bold">port mirroring</strong>. Taps <a id="_idIndexMarker024"/>are strategically located <a id="_idIndexMarker025"/>at key network <a id="_idIndexMarker026"/>nodes to capture a copy of network traffic, which is then sent to Suricata for analysis. This deployment ensures accurate and comprehensive network activity visibility.</li>
</ul>
<div><div><img alt="Figure 1.5 – Network tap deployment" src="img/B19549_1_05.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.5 – Network tap deployment</p>
<p>We have <a id="_idIndexMarker027"/>learned about the different <a id="_idIndexMarker028"/>Suricata deployment methods. In the next section, we will learn about Wazuh, its core components and deployment methods, and then we will learn how to install Suricata IDS on Ubuntu Server.</p>
<h1 id="_idParaDest-21"><a id="_idTextAnchor020"/>Getting started with Wazuh and Suricata</h1>
<p>Wazuh is <a id="_idIndexMarker029"/>an open-source security monitoring <a id="_idIndexMarker030"/>platform that provides <strong class="bold">extended detection and response</strong> (<strong class="bold">XDR</strong>) and SIEM <a id="_idIndexMarker031"/>functionality. Wazuh’s capabilities include log analysis, intrusion detection, vulnerability detection, and real-time alerting, helping organizations enhance their security posture and respond to threats effectively. In this section, we will first get a basic understanding of the Wazuh platform and its core components and deployment methods, and then we will set up the Wazuh agent and connect with <a id="_idIndexMarker032"/>the Wazuh platform. Next, we will set up a Suricata IDS and integrate it <a id="_idIndexMarker033"/>with the Wazuh agent. Some of the main points we will explore are as follows:</p>
<ul>
<li>Core components of Wazuh</li>
<li>Wazuh deployment options</li>
<li>Wazuh core features</li>
<li>Wazuh modules</li>
<li>Wazuh administration</li>
<li>Installing the Wazuh server</li>
<li>Installing the Wazuh agent</li>
<li>Installing Suricata on Ubuntu Server</li>
<li>Setting up Windows Server with Suricata</li>
</ul>
<h2 id="_idParaDest-22"><a id="_idTextAnchor021"/>The core components of Wazuh</h2>
<p>Wazuh provides a centralized platform for monitoring and managing security events across the <a id="_idIndexMarker034"/>organization’s IT infrastructure. Wazuh collects, analyzes, and connects log data from different sources, such as endpoints, network devices, firewalls, proxy servers, and cloud instances. Once the logs are collected, Wazuh provides several capabilities to the security team such as file integrity monitoring, malware detection, vulnerability detection, command monitoring, system inventory, threat hunting, security configuration assessment, and incident response. The Wazuh solution is made up of three main parts: the Wazuh server, the Wazuh indexer, and the Wazuh dashboard. The Wazuh agent is installed on the endpoints that need to be monitored.</p>
<h3>The Wazuh server</h3>
<p>This central <a id="_idIndexMarker035"/>component is also used to manage <a id="_idIndexMarker036"/>the agents and analyze the data received from them:</p>
<ul>
<li>It collects logs from several sources such as hosts, network devices, firewalls, proxy servers, and syslog servers.</li>
<li>Normalizes and standardizes collected logs and events into a uniform format for analysis and correlation. It utilizes the Wazuh decoder to parse logs to display the logs in a uniform format.</li>
<li>The Wazuh server is capable of integrating logs from several data sources such as syslog, Windows event logs, Windows Sysmon, Docker logs, Palo Alto firewall logs, and Check Point firewall logs.</li>
<li>The Wazuh server also provides an API for interaction, allowing remote servers or systems to interact and query, for example, the number of active Wazuh agents, vulnerability information, Wazuh rule verification, and so on.</li>
</ul>
<h3>The Wazuh indexer</h3>
<p>It is <a id="_idIndexMarker037"/>responsible for indexing and storing alerts generated by the Wazuh server:</p>
<ul>
<li>The Wazuh <a id="_idIndexMarker038"/>indexer stores alerts sent by the Wazuh server and acts as a primary repository</li>
<li>It’s made to handle a lot of security alerts, making sure that storage and indexing work well as the system grows</li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">Indexing is the process of arranging and arranging data to enable effective and quick retrieval. It involves <a id="_idIndexMarker039"/>creating a data structure called an <strong class="bold">index</strong>.</p>
<ul>
<li>The Wazuh indexer provides robust search features that make it possible to quickly and thoroughly search through saved alerts using particular criteria or patterns</li>
<li>The Wazuh <a id="_idIndexMarker040"/>indexer uses four index patterns to store the data:<ul><li><code>wazuh-alerts-*</code>: This is <a id="_idIndexMarker041"/>the index pattern for alerts generated by the Wazuh server</li><li><code>wazuharchives-*</code>: This is the index pattern for all events sent to the Wazuh server</li><li><code>wazuh-monitoring-*</code>: This pattern is for monitoring the status of Wazuh agents</li><li><code>wazuh-statistics-*</code>: This is used for statistical information about the Wazuh server</li></ul></li>
</ul>
<h3>The Wazuh dashboard</h3>
<p>The Wazuh <a id="_idIndexMarker042"/>dashboard is a web interface that allows you to perform <a id="_idIndexMarker043"/>visualization and analysis. It also allows you to create rules, monitor events, monitor regulatory compliances (such as PCI DSS, GDPR, CIS, HIPPA, and NIST 800-53), detect vulnerable applications, and much more.</p>
<h3>Wazuh agents</h3>
<p>Wazuh <a id="_idIndexMarker044"/>agents are installed on endpoints such <a id="_idIndexMarker045"/>as servers, desktops, laptops, cloud compute instances, or VMs. Wazuh utilizes the OSSEC HIDS module to collect all the endpoint events.</p>
<p class="callout-heading">Note</p>
<p class="callout">OSSEC is <a id="_idIndexMarker046"/>a popular and open-source <strong class="bold">host-based IDS</strong> (<strong class="bold">HIDS</strong>). It is a powerful correlation and analysis module that integrates log analysis, file integrity monitoring, Windows registry monitoring, centralized policy enforcement, rootkit <a id="_idIndexMarker047"/>detection, real-time alerting, and active response. It can be installed on most <strong class="bold">operating systems</strong> (<strong class="bold">OSs</strong>) such as Linux, OpenBSD, FreeBSD, MacOS and Windows.Wazuh deployment options</p>
<p>Wazuh is known for its ability to fully monitor security and detect threats. It also has several flexible deployment options. Depending on your requirement, you can deploy Wazuh in an on-premises server, cloud, Docker container, Kubernetes, or another environment. For a production environment, Wazuh core components (i.e., the Wazuh server, the Wazuh indexer, and the Wazuh dashboard) should be installed in cluster mode. Cluster <a id="_idIndexMarker048"/>mode deployment involves <a id="_idIndexMarker049"/>setting up more than one Wazuh server node to work collectively. By spreading the work and duties among several nodes in the cluster, this configuration aims to improve speed, scalability, and resilience. Let’s cover some important deployment options:</p>
<ul>
<li><strong class="bold">Servers</strong>: Putting <a id="_idIndexMarker050"/>Wazuh on dedicated servers <a id="_idIndexMarker051"/>gives you more power and lets you make changes that work with your system. You can utilize on-premises servers or cloud instances. Remember, you need multiple server instances to deploy Wazuh in cluster mode.</li>
<li><strong class="bold">VM image</strong>: Wazuh <a id="_idIndexMarker052"/>gives you an <strong class="bold">Open Virtual Appliance</strong> (<strong class="bold">OVA</strong>) formatted VM image that is already set up. This can be imported <a id="_idIndexMarker053"/>straight into VirtualBox or any other virtualization software that works with OVA files. This is good for a lab purpose only. You <a id="_idIndexMarker054"/>can use this deployment option to test all the scenarios mentioned in this book. Download the OVA file from here: <a href="https://documentation.wazuh.com/current/deployment-options/virtual-machine/virtual-machine.html">https://documentation.wazuh.com/current/deployment-options/virtual-machine/virtual-machine.html</a>.</li>
<li><strong class="bold">Docker container</strong>: Docker is an open platform for building and running applications <a id="_idIndexMarker055"/>inside an isolated software container. Docker <a id="_idIndexMarker056"/>containers are the best way to quickly and easily set up Wazuh components in independent environments. This option is commonly used for testing, development, or situations where setup and takedown need to be done quickly. You can download <a id="_idIndexMarker057"/>the Docker image from the link here: <a href="https://hub.docker.com/u/wazuh">https://hub.docker.com/u/wazuh</a>.</li>
<li><strong class="bold">Deployment on Kubernetes</strong>: Kubernetes <a id="_idIndexMarker058"/>is an open-source <a id="_idIndexMarker059"/>container orchestration platform. You can opt for this method when managing large-scale deployment with multiple containers. This method gives you higher scalability, automated deployment, and <a id="_idIndexMarker060"/>resource optimization. You can check out the Wazuh Kubernetes repository at the following link: <a href="https://github.com/wazuh/wazuh-kubernetes">https://github.com/wazuh/wazuh-kubernetes</a>.</li>
</ul>
<p>If you want to test all the use cases throughout the book, I suggest you use the Wazuh VM deployment option by downloading the OVA file; however, for the production-level deployment, you can choose any of the remaining options. The Wazuh community has done a brilliant job in documenting the installation guide. You can refer to this link for step-by-step assistance: <a href="https://documentation.wazuh.com/current/installation-guide/index.html">https://documentation.wazuh.com/current/installation-guide/index.html</a>.</p>
<h2 id="_idParaDest-23"><a id="_idTextAnchor022"/>Wazuh modules</h2>
<p>Wazuh has <a id="_idIndexMarker061"/>a set of modules that work together to help organizations handle security events, find threats, make sure they are following the rules, and keep their systems and data safe. Once you access the Wazuh manager, the topmost option is <strong class="bold">Modules</strong>. By default, you can find multiple modules categorized under four sections as mentioned in the following diagram:</p>
<div><div><img alt="Figure 1.6 – Default Wazuh modules" src="img/B19549_1_06.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.6 – Default Wazuh modules</p>
<p>Let us look <a id="_idIndexMarker062"/>into each of those four sections in detail:</p>
<ul>
<li><strong class="bold">Security information management</strong>: This consists of the <strong class="bold">Security Events</strong> and <strong class="bold">Integrity Monitoring</strong> module. Security alerts will be triggered and displayed based on predefined Wazuh rules for identified security events. The Integrity Monitoring module monitors any unauthorized changes to critical system files and directories.</li>
<li><strong class="bold">Threat detection and response</strong>: By default, this section has two modules: <strong class="bold">Vulnerabilities</strong> and <strong class="bold">MITRE ATT&amp;CK®</strong>. However, you can also add Osquery, VirusTotal, and more. The <strong class="bold">Vulnerabilities</strong> module identifies, and tracks known vulnerabilities in the systems or software. The <strong class="bold">MITRE ATT&amp;CK</strong> module maps detected threats or incidents to the <strong class="bold">MITRE </strong><strong class="bold">ATT&amp;CK</strong> framework.</li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout"><strong class="bold">ATT&amp;CK</strong> stands for <strong class="bold">adversarial tactics, techniques, and common knowledge</strong>. <strong class="bold">MITRE</strong> is a <a id="_idIndexMarker063"/>government-funded research organization based in Bedford, MA, and McLean, VA. MITRE ATT&amp;CK is a <a id="_idIndexMarker064"/>framework that helps organizations with attacker’s tactics, techniques, and procedures to test their security controls.</p>
<ul>
<li><strong class="bold">Auditing and Policy Monitoring</strong>: This section consists of three modules: the <strong class="bold">Policy Monitoring</strong> module, the <strong class="bold">System Auditing </strong>module, and the <strong class="bold">Security configuration </strong><strong class="bold">assessment</strong> module.<ul><li>The <strong class="bold">Policy Monitoring</strong> module monitors the systems to make sure security policies are properly established.</li><li>The <strong class="bold">System Auditing</strong> module tracks and audits use activities including use login attempts, file access, and privilege changes in the endpoint.</li><li>The <strong class="bold">Security configuration assessment</strong> module is a very popular feature that <a id="_idIndexMarker065"/>checks system configurations against best practices or predefined security standards. Wazuh utilizes the CIS benchmark for most of the security configuration checks.</li></ul></li>
</ul>
<p class="callout-heading">Note</p>
<p class="callout">The <strong class="bold">Center for Internet Security</strong> (<strong class="bold">CIS</strong>) benchmarks are a set of best practices that are known <a id="_idIndexMarker066"/>around the world and are based on consensus. They are meant to help security professionals set up and manage their cybersecurity defenses.</p>
<ul>
<li><strong class="bold">Regulatory Compliance</strong>: This section consists of multiple modules including PCI DSS compliance, GDPR, HIPPA, NIST 800-53, and TSC modules. Wazuh rules are created and tagged with some of these compliances. When any of those rules get triggered, we see the alerts. This is how we can align security compliances with Wazuh.</li>
</ul>
<p>Next, let’s talk about the Wazuh Administration, where we will discuss some core features of the Wazuh manager.</p>
<h2 id="_idParaDest-24"><a id="_idTextAnchor023"/>Wazuh Administration</h2>
<p>Under the <strong class="bold">Management</strong> section of the Wazuh dashboard, we have the <strong class="bold">Administration</strong> section. As you can see in the following diagram, the <strong class="bold">Administration</strong> section <a id="_idIndexMarker067"/>includes capabilities such as <strong class="bold">Rules</strong>, <strong class="bold">Decoders</strong>, <strong class="bold">CDB lists</strong>, <strong class="bold">Groups</strong>, and <strong class="bold">Configuration</strong>.</p>
<div><div><img alt="Figure 1.7 – Wazuh administration" src="img/B19549_1_07.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.7 – Wazuh administration</p>
<p>All the features mentioned under the <strong class="bold">Administration</strong> tab play a pivotal role in ensuring the effectiveness of the Wazuh platform for real-time monitoring and threat detection. We will understand each of these features as explained in the following sections.</p>
<h3>Decoders</h3>
<p><strong class="bold">Decoders</strong> are responsible <a id="_idIndexMarker068"/>for reading incoming log entries, pulling <a id="_idIndexMarker069"/>out the important information, and putting them into a standard format that the Wazuh system can easily understand and analyze. Raw log entries can be in different formats, such as syslog, JSON, XML, or custom text formats. The job of the decoder is to figure out how these logs are put together and pull out meaningful fields and values. There are many pre-built decoders in Wazuh such as the syslog decoder, OpenSSH decoder, Suricata decoder, and the Cisco ASA decoder. To understand <a id="_idIndexMarker070"/>what decoders are and how they work, let us look at how logs from the Barracuda <strong class="bold">Web Application Firewall</strong> (<strong class="bold">WAF</strong>) are processed:</p>
<pre class="source-code">
&lt;decoder name="barracuda-svf1"&gt;
    &lt;parent&gt;barracuda-svf-email&lt;/parent&gt;
    &lt;prematch&gt;^\S+[\S+]|&lt;/prematch&gt;
    &lt;prematch&gt;^\S+&lt;/prematch&gt;
    &lt;regex&gt;^\S+[(\S+)] (\d+-\w+-\w+) \d+ \d+ |&lt;/regex&gt;
    &lt;regex&gt;^(\S+) (\d+-\w+-\w+) \d+ \d+ &lt;/regex&gt;
    &lt;order&gt;srcip, id&lt;/order&gt;
&lt;/decoder&gt;</pre> <p>Let’s break <a id="_idIndexMarker071"/>down the parts of this Wazuh decoder:</p>
<ul>
<li><code>decoder name</code>: This indicates the name of the decoder.</li>
<li><code>parent</code>: This gives us the name of the parent decoder. The parent decoder will be processed before the child decoders.</li>
<li><code>prematch</code>: This is like a condition that must match to apply the decoder. It uses regular expressions to look for a match.</li>
<li><code>regex</code>: This represents the regular expression to extract data. In the preceding decoder, we have two <code>regex</code> instances.</li>
<li><code>order</code>: This indicates the list of fields in which the extracted information or value will be stored.</li>
</ul>
<p>Decoders have <a id="_idIndexMarker072"/>many more configuration options available to them. Visit the <em class="italic">Decoders Syntax</em> page (<a href="https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/decoders.html">https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/decoders.html</a>) in the Wazuh documentation to see all of the available options.</p>
<h3>Rules</h3>
<p>Wazuh rules <a id="_idIndexMarker073"/>help the system detect attacks in the early stages, such as intrusions, software misuse, configuration issues, application errors, malware, rootkits, system anomalies, and security policy violations. Wazuh comes with several pre-built rules and decoders but also allows you to add custom rules. Let’s take a sample Wazuh rule:</p>
<pre class="source-code">
&lt;rule id="200101" level="1"&gt;
    &lt;if_sid&gt;60009&lt;/if_sid&gt;
    &lt;field name="win.system.providerName"&gt;^PowerShell$&lt;/field&gt;
    &lt;mitre&gt;
      &lt;id&gt;T1086&lt;/id&gt;
    &lt;/mitre&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
    &lt;group&gt;windows_powershell,&lt;/group&gt;
    &lt;description&gt;Powershell Information EventLog&lt;/description&gt;
  &lt;/rule&gt;</pre> <p>Let’s break this code down:</p>
<ul>
<li><code>rule id</code>: This represents the unique identifier for the Wazuh rule.</li>
<li><code>level</code>: The rule’s classification level ranges between 0 and 15. According to the rule categories page (<a href="https://documentation.wazuh.com/current/user-manual/ruleset/rules-classification.html">https://documentation.wazuh.com/current/user-manual/ruleset/rules-classification.html</a>) in the Wazuh documentation, each number indicates a distinct value and severity.</li>
<li><code>if_sid</code>: This specifies the ID of another rule (in our case, it’s <code>60009</code>), which triggers the current rule. The “if” condition is considered as the “parent” rule that must be checked first.</li>
<li><code>field name</code>: This specifies the name of the field extracted from the decoder. The value is matched by a regular expression. In this case, we are looking for the field name <code>win.system.providerName</code> with a value of <code>PowerShell</code>.</li>
<li><code>group</code>: This is used to organize the Wazuh rules. It contains the list of categories that the rules belong to. We have organized our rule in the <code>windows_powershell</code> group.</li>
</ul>
<p>There are <a id="_idIndexMarker074"/>tons of other options available for Wazuh rules. I would suggest you check out the <em class="italic">Rules Syntax</em> page at the following link: <a href="https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/rules.html">https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/rules.html</a>) in the Wazuh documentation.</p>
<h3>CDB lists</h3>
<p>The <strong class="bold">Constant Database</strong> (<strong class="bold">CDB</strong>) list enables the categorization and management of IP addresses <a id="_idIndexMarker075"/>and domains based on <a id="_idIndexMarker076"/>their characteristics. These lists can include known malicious IP addresses, suspicious domains, trusted IP addresses, whitelisted domains, and more. Admins maintain these lists by adding or removing entries based on reputation or risk levels. To learn more about CDB lists, you can visit the official <a id="_idIndexMarker077"/>Wazuh documentation for CDB lists: <a href="https://documentation.wazuh.com/current/user-manual/ruleset/cdb-list.html">https://documentation.wazuh.com/current/user-manual/ruleset/cdb-list.html</a>.</p>
<h3>Groups</h3>
<p>Agents can <a id="_idIndexMarker078"/>be grouped based on their OS or functionalities using groups; for example, all Windows agents can be grouped under a single group <a id="_idIndexMarker079"/>named Windows Agents. This is helpful when you want to push configuration changes from the Wazuh manager to all Windows agents at once. This becomes a simple and single-step solution. To learn more about grouping agents, you can visit the official Wazuh documentation here: <a href="https://documentation.wazuh.com/current/user-manual/agents/grouping-agents.html">https://documentation.wazuh.com/current/user-manual/agents/grouping-agents.html</a>.</p>
<h3>Configuration</h3>
<p>This helps security teams to fine-tune Wazuh’s main configurations such as cluster configuration, alert and output management, log data analysis, cloud security, vulnerabilities, inventory data, active response, commands, Docker listeners, and monitoring (Amazon S3, Azure logs, Google Cloud, GitHub, Office 365, etc.). All these features <a id="_idIndexMarker080"/>can even be customized from the command-line option as well. You need to locate the <code>ossec.conf</code> file in your Wazuh manager or Wazuh agent at the <code>/</code><code>var/ossec/etc</code> directory.</p>
<p>Now, let’s start deploying our Wazuh agent on the Ubuntu machine and then we will install Suricata on the same machine.</p>
<h2 id="_idParaDest-25"><a id="_idTextAnchor024"/>Installing the Wazuh server</h2>
<p>The Wazuh server is the central component of the Wazuh security platform. It consists of two important elements: the Wazuh manager and Filebeat. The Wazuh manager collects and <a id="_idIndexMarker081"/>analyzes data from the Wazuh agents and triggers alerts when it detects any threats. Filebeat forwards alerts and events to the Wazuh indexer. The Wazuh server can be installed in multiple ways, however, I’d recommend the multi-node cluster method for a production environment and the VM method for a lab environment. You can follow the guidelines for both methods in the following sections.</p>
<h3>For a production environment</h3>
<p>To set up Wazuh in the production environment, it is recommended to deploy the Wazuh server <a id="_idIndexMarker082"/>and Wazuh indexer on different hosts. This helps you handle traffic from a large number of endpoints and also to achieve high availability. The step-by-step guide to install the Wazuh server along with the indexer and dashboard is mentioned here: <a href="https://documentation.wazuh.com/current/installation-guide/index.html">https://documentation.wazuh.com/current/installation-guide/index.html</a>.</p>
<h3>For a lab environment</h3>
<p>You can use the Wazuh VM OVA file for a lab environment as it is easy to deploy. All the Wazuh <a id="_idIndexMarker083"/>components including the Wazuh server, indexer, and dashboard are unified. To install Wazuh using an OVA file, follow these steps:</p>
<ol>
<li><strong class="bold">Download the OVA file</strong>: Start by downloading the Wazuh OVA file from the official Wazuh website: <a href="https://documentation.wazuh.com/current/deployment-options/virtual-machine/virtual-machine.html">https://documentation.wazuh.com/current/deployment-options/virtual-machine/virtual-machine.html</a>.</li>
<li><strong class="bold">Import the OVA file</strong>: Use your <a id="_idIndexMarker084"/>favorite virtualization platform (e.g., VMware Workstation, VirtualBox, etc.) and import the downloaded OVA file.</li>
<li><strong class="bold">Configure VM settings</strong>: Before powering on the VM, adjust the VM settings as needed:<ul><li><strong class="bold">CPU </strong><strong class="bold">cores</strong>: 4</li><li><strong class="bold">RAM</strong>: 8 GB</li><li><strong class="bold">Storage</strong>: 50 GB</li></ul></li>
<li><strong class="bold">Access the Wazuh web interface</strong>: You can start the VM. Next, open the Web browser using the VM IP address and enter the default username and password as shown in the diagram.</li>
</ol>
<div><div><img alt="Figure 1.8 – Accessing the Wazuh web interface" src="img/B19549_1_08.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.8 – Accessing the Wazuh web interface</p>
<p class="list-inset">You need <a id="_idIndexMarker085"/>to enter the following:</p>
<ul>
<li>Username: <code>admin</code></li>
<li>Password: <code>admin</code></li>
</ul>
<h2 id="_idParaDest-26"><a id="_idTextAnchor025"/>Installing Wazuh agent</h2>
<p>A Wazuh <a id="_idIndexMarker086"/>agent is compatible with multiple OSs. Once a Wazuh agent is installed, it will communicate with the Wazuh server, pushing information and system logs in real-time using an encrypted channel.</p>
<h3>Installing a Wazuh agent on Ubuntu Server</h3>
<p>To deploy a Wazuh agent on the Ubuntu Server, you need to install the agent and configure <a id="_idIndexMarker087"/>the deployment variables. To get started <a id="_idIndexMarker088"/>with installation, you need to log in to your Wazuh dashboard, navigate to <strong class="bold">Agents</strong>, click on <strong class="bold">Deploy an agent</strong> and then follow these steps:</p>
<ol>
<li><strong class="bold">Select an OS, version, and architecture</strong>: As mentioned in the following diagram, navigate to the <strong class="bold">LINUX</strong> box and choose <strong class="bold">DEB amd64 </strong>for AMD architecture or <strong class="bold">DEB aarch64</strong> for ARM architecture.</li>
</ol>
<div><div><img alt="Figure 1.9 – Deploying a new agent" src="img/B19549_1_09.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.9 – Deploying a new agent</p>
<ol>
<li value="2"><strong class="bold">Enter the server address and other optional settings</strong>: Enter the Wazuh server address and agent name and select the group. Please make sure your desired agent group is created before you add any new agent.</li>
</ol>
<div><div><img alt=" Figure 1.10 – Choosing a server address and optional settings" src="img/B19549_1_10.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> Figure 1.10 – Choosing a server address and optional settings</p>
<p class="list-inset">Let’s <a id="_idIndexMarker089"/>break down what we’ve inputted:</p>
<ul>
<li><code>192.168.29.32</code>: This is <a id="_idIndexMarker090"/>the IP address of the Wazuh server</li>
<li><code>ubu-serv</code>: This indicates the name of the Wazuh agent</li>
<li><code>default</code>: It represents the Wazuh agent group</li>
</ul>
<ol>
<li value="3"><code>curl</code> command to download the Wazuh module and start the Wazuh agent service as mentioned in the following diagram.</li>
</ol>
<div><div><img alt=" Figure 1.11 – Retrieving the commands to download and install a Wazuh agent" src="img/B19549_1_11.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> Figure 1.11 – Retrieving the commands to download and install a Wazuh agent</p>
<p class="callout-heading">Note</p>
<p class="callout">Make sure <a id="_idIndexMarker091"/>that there are no firewall rules <a id="_idIndexMarker092"/>blocking communication between the agent and the Wazuh manager. The agent should be able to communicate with the manager over the configured port (the default is <code>1514</code>/<code>514</code> for syslog).</p>
<p>Finally, you can verify whether the agent is connected and activated by logging in to the Wazuh manager and navigating to <strong class="bold">Agents</strong>.</p>
<div><div><img alt="Figure 1.12 – Visualizing Wazuh agents" src="img/B19549_1_12.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.12 – Visualizing Wazuh agents</p>
<p class="list-inset">As you <a id="_idIndexMarker093"/>can see in the preceding <a id="_idIndexMarker094"/>diagram, the <code>ubu-serv-03</code> agent is connected with the following:</p>
<ul>
<li><code>006</code></li>
<li><code>192.168.29.172</code></li>
<li><strong class="bold">Group(s)</strong>: <strong class="bold">default</strong></li>
<li><strong class="bold">Operating system</strong>: <strong class="bold">Ubuntu 22.04</strong></li>
<li><strong class="bold">Status</strong>: <strong class="bold">active</strong></li>
</ul>
<p>Now, let’s install the Wazuh agent on Windows Server. The process will be the same for the Windows desktop, too.</p>
<h3>Installing a Wazuh agent on Windows Server</h3>
<p>You can <a id="_idIndexMarker095"/>monitor real-time events from <a id="_idIndexMarker096"/>Windows Server or a desktop on the Wazuh server by <a id="_idIndexMarker097"/>using the <strong class="bold">command line interface</strong> (<strong class="bold">CLI</strong>) or <strong class="bold">graphical user interface</strong> (<strong class="bold">GUI</strong>). To get started with installation, you need to log in to <a id="_idIndexMarker098"/>your Wazuh dashboard, navigate to <strong class="bold">Agents</strong>, click on <strong class="bold">Deploy an agent</strong> and then follow these steps:</p>
<ol>
<li><strong class="bold">Select an OS, version, and architecture</strong>: As shown in the following diagram, navigate <a id="_idIndexMarker099"/>to the <strong class="bold">WINDOWS</strong> box, choose <a id="_idIndexMarker100"/>the <strong class="bold">MSI 32/64 bits</strong> package, and then enter the Wazuh server IP address.</li>
</ol>
<div><div><img alt="Figure 1.13 – Selecting the Windows package for the Wazuh agent" src="img/B19549_1_13.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.13 – Selecting the Windows package for the Wazuh agent</p>
<ol>
<li value="2"><strong class="bold">Enter the server address and other optional settings</strong>: Enter the Wazuh server address and agent name and select the group. Please make sure your desired agent group is created before you add any new agent.</li>
</ol>
<div><div><img alt=" Figure 1.14 – Entering the server address and optional settings" src="img/B19549_1_14.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> Figure 1.14 – Entering the server address and optional settings</p>
<ol>
<li value="3"><strong class="bold">Download the package and enable the service</strong>: Copy the PowerShell command <a id="_idIndexMarker101"/>to download the Wazuh <a id="_idIndexMarker102"/>module and start the Wazuh agent service as shown in the following diagram. The following command needs to be entered on a Windows PowerShell terminal.</li>
</ol>
<div><div><img alt="Figure 1.15 – Retrieving the commands to download and install the Wazuh agent on a Windows machine" src="img/B19549_1_15.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.15 – Retrieving the commands to download and install the Wazuh agent on a Windows machine</p>
<p>Finally, you can <a id="_idIndexMarker103"/>verify whether the agent is <a id="_idIndexMarker104"/>connected and activated by logging in to the Wazuh manager and navigating to <strong class="bold">Agents</strong>.</p>
<div><div><img alt="Figure 1.16 – Visualizing Wazuh agents installed on a Windows machine" src="img/B19549_1_16.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.16 – Visualizing Wazuh agents installed on a Windows machine</p>
<p>As you can see in the preceding diagram, the <code>WIN-AGNT</code> agent is connected with the following:</p>
<ul>
<li><code>004</code></li>
<li><code>192.168.29.77</code></li>
<li><strong class="bold">Group(s)</strong>: <strong class="bold">default</strong></li>
<li><strong class="bold">Operating system</strong>: <strong class="bold">Microsoft Windows Server 2019 Datacenter </strong><strong class="bold">Evaluation 10.0.17763.737</strong></li>
<li><strong class="bold">Status</strong>: <strong class="bold">active</strong></li>
</ul>
<p>We have <a id="_idIndexMarker105"/>successfully learned how to deploy <a id="_idIndexMarker106"/>Wazuh agents on both the Ubuntu Server and Windows Server. In the next section, we will learn how to set up a Suricata IDS on Ubuntu Server.</p>
<h2 id="_idParaDest-27"><a id="_idTextAnchor026"/>Installing Suricata on Ubuntu Server</h2>
<p>With the <a id="_idIndexMarker107"/>ability to detect malicious or suspicious activities in real time, Suricata is an NSM tool, which has the potential to work as <a id="_idIndexMarker108"/>an IPS/IDS. Its goal is to stop intrusion, malware, and other types of malicious attempts from taking advantage of a network. In this section, we will learn how to install Suricata on Ubuntu server. Let’s first learn about the prerequisites.</p>
<h3>Prerequisites</h3>
<p>To install <a id="_idIndexMarker109"/>Suricata IDS on Ubuntu Server, the prerequisites are as follows:</p>
<ul>
<li>You will need to have Ubuntu Server installed (version 20.04 or higher)</li>
<li>Sudo Privileges</li>
</ul>
<h3>Installation</h3>
<p>This process <a id="_idIndexMarker110"/>involves the installation of Suricata packages using the <code>apt-get</code> command line tool and then we need to install the free and open source Suricata rules created by the ET community. The rules within the ET ruleset cover a broad spectrum of threat categories, including malware, exploits, policy violations, anomalies, botnets, and so on. To complete the installation, follow these steps:</p>
<ol>
<li><strong class="bold">Install Suricata</strong>: Log in to the terminal on Ubuntu Server and install the Suricata IDS package with the following commands:<pre class="source-code">
<strong class="bold">sudo add-apt-repository ppa:oisf/suricata-stable</strong>
<strong class="bold">sudo apt-get update</strong>
<code>/</code><code>etc/suricata/rules</code> directory:<pre class="source-code">
<strong class="bold">cd /tmp/ &amp;&amp; curl -LO https://rules.emergingthreats.net/open/suricata-6.0.8/emerging.rules.tar.gz</strong>
<strong class="bold">sudo tar -xvzf emerging.rules.tar.gz &amp;&amp; sudo mv rules/*.rules /etc/suricata/rules/</strong>
<strong class="bold">sudo chmod 640 /etc/suricata/rules/*.rules</strong></pre></li> </ol>
<p class="callout-heading">Note</p>
<p class="callout">If the rule directory is not present, you can create one by using the <code>mkdir /etc/suricata/</code> rules and then you can enter the previously mentioned commands.</p>
<ol>
<li value="3"><code>/etc/suricata/suricata.yaml</code>:<pre class="source-code">
<strong class="bold">HOME_NET: "&lt;AGENT_IP&gt;"</strong>
<strong class="bold">EXTERNAL_NET: "any"</strong>
<strong class="bold">default-rule-path: /etc/suricata/rules</strong>
<strong class="bold">rule-files:</strong>
<strong class="bold">- "*.rules"</strong>
<strong class="bold"># Linux high speed capture support</strong>
<strong class="bold">af-packet:</strong>
<code>HOME_NET</code>: This is a variable that needs to be set with the agent IP address.</li><li><code>EXTERNAL_NET</code>: This variable needs to be set with <code>"any"</code> to ensure Suricata will monitor the traffic from any external IP address.</li><li><code>default-rule-path</code>: This is set to our Suricata rule path.</li><li><code>af-packet</code>: This is a packet capture method used to capture network traffic <a id="_idIndexMarker113"/>directory from a <code>ifconfig</code> command and updating the <code>af-packet</code> settings.</li></ul></li> <li><strong class="bold">Restart the Suricata service</strong>: In order for configuration changes to take effect, we are required to restart the Suricata service using the following command:<pre class="source-code">
<code>ossec</code> config file located at <code>/var/ossec/etc/ossec.conf</code>. Suricata stores all the logs at <code>/var/log/suricata/eve.json</code>. You are required to mention this file under the <code>&lt;location&gt;</code> tag in the <code>ossec.conf</code> file:<pre class="source-code">
&lt;ossec_config&gt;
  &lt;localfile&gt;
    &lt;log_format&gt;json&lt;/log_format&gt;
    &lt;location&gt;/var/log/suricata/eve.json&lt;/location&gt;
  &lt;/localfile&gt;
&lt;/ossec_config&gt;</pre></li> <li><strong class="bold">Restart the Wazuh agent service</strong>: For the current changes to take effect, you need to restart the Wazuh agent services using the following command:<pre class="source-code">
<strong class="bold">$ sudo systemctl restart wazuh-agent</strong></pre></li> </ol>
<p>This completes <a id="_idIndexMarker114"/>Suricata’s integration with Wazuh. The Suricata IDS has been installed on Ubuntu Server along with the ET ruleset. Your endpoints are ready to trigger alerts if any malicious traffic is matched against any of the ET rulesets. Before getting into some practical use cases, let’s first get a basic understanding of Suricata rules and how to create one.</p>
<h1 id="_idParaDest-28"><a id="_idTextAnchor027"/>Understanding Suricata rules</h1>
<p>Suricata is powerful when you have a set of powerful rules. Although there are thousands <a id="_idIndexMarker115"/>of Suricata rule templates available online, it is still important to learn how to create a custom Suricata rule from scratch. In this section, we’ll learn basic Suricata rule syntax and some common use cases with attack and defense.</p>
<h2 id="_idParaDest-29"><a id="_idTextAnchor028"/>Suricata rule syntax</h2>
<p>Suricata uses <a id="_idIndexMarker116"/>rules to detect different network events, and when certain conditions are met, it can be set up to do things such as alert or block.</p>
<p>Here’s an overview of the Suricata rule syntax:</p>
<pre class="console">
action proto src_ip src_port -&gt; dest_ip dest_port (msg:"Alert message"; content:"string"; sid:12345;)</pre> <p>Let’s break this code down:</p>
<ul>
<li><code>action</code>: This says what should be done when the rule is true. It can be <code>alert</code> to send an alert, <code>drop</code> to stop the traffic, or any of the other actions that are supported.</li>
<li><code>proto</code>: This shows what kind of traffic is being matched, such as <code>tcp</code>, <code>udp</code>, and <code>icmp</code>.</li>
<li><code>src_ip</code>: This is the source IP address or range of source IP addresses. This is where the traffic comes from.</li>
<li><code>src_port</code>: This is the <a id="_idIndexMarker117"/>port or range of ports where the traffic is coming from.</li>
<li><code>dest_ip</code>: This is the IP address or range of IP addresses where the traffic is going.</li>
<li><code>dest_port</code>: This is the port or range of ports where the traffic is going.</li>
<li><code>msg</code>: The message that will be shown as an alert when the rule is true.</li>
<li><code>content</code>: This is an optional field that checks the packet payload for a certain string or content.</li>
</ul>
<p>Now, based on our current Suricata configuration, we have the <code>$HOME_NET</code> and <code>$EXTERNAL_NET</code> network variables. Let’s get an understanding of an example rule to detect an SSH connection:</p>
<pre class="console">
alert tcp $EXTERNAL_NET any -&gt; $HOME_NET 22 (msg:"SSH connection detected"; flow:to_server,established; content:"SSH-2.0-OpenSSH"; sid:100001;)</pre> <p>Let’s break this down:</p>
<ul>
<li><code>alert</code>: The rule specifies that an alert should be generated if the specified conditions are met.</li>
<li><code>tcp</code>: This <a id="_idIndexMarker118"/>refers to <strong class="bold">Transmission Communication Protocol</strong> (<strong class="bold">TCP</strong>) based traffic.</li>
<li><code>$EXTERNAL_NET any -&gt; $HOME_NET 22</code>: The traffic flow is defined by directing traffic from any external network IP address (<code>$EXTERNAL_NET</code>) to any home or local network IP (<code>$HOME_NET</code>) on port <code>22</code> (SSH).</li>
<li><code>(msg:"SSH connection detected";)</code>: This specifies a detailed message to be added to the alert. It indicates that the rule has identified an SSH connection in this instance.</li>
<li><code>flow:to_server,established</code>: This defines the direction of the traffic that initiates the rule. It is looking for established connections between the server (home network) and the server (external network). This portion of the rule prevents <a id="_idIndexMarker119"/>initial connection attempts from generating alerts.</li>
<li><code>content:"SSH-2.0-OpenSSH</code>: This part looks at the payload of the packet for a particular string (<code>"SSH-2.0-OpenSSH"</code>). It searches the traffic payload for this specific string, which signifies the utilization of the OpenSSH protocol and the SSH protocol in general.</li>
<li><code>sid:100001</code>: It is a unique identifier for a particular rule.</li>
</ul>
<p>Now that we’ve learned how to create some basic Suricata rules, let’s go through some Suricata IDS use cases with the Wazuh platform.</p>
<h2 id="_idParaDest-30"><a id="_idTextAnchor029"/>Network scanning probe attack and detection</h2>
<p><strong class="bold">Network scanning</strong> is the <a id="_idIndexMarker120"/>initial stage of most hacking exercises, and the most powerful tool used for this purpose is none other than the <strong class="bold">Nmap</strong> scanner. Nmap is <a id="_idIndexMarker121"/>a free and open source Linux command-line tool. Nmap helps us to scan any host to discover opened ports, software versions, OSs, and so on. It is used <a id="_idIndexMarker122"/>by security professionals for security testing, network exploration, and vulnerability detection. Threat actors also perform network scanning to discover any open ports, software versions, or vulnerability packages. In this section, we will initiate network scanning probes using the Nmap tool against our Wazuh agent (running Suricata services). The ET ruleset already consists of rules to detect Nmap-based scanning probes. We will verify it using this attack scenario. </p>
<p>We will be following the points in these sections:</p>
<ul>
<li>Lab setup</li>
<li>Attack simulation</li>
<li>Visualize on the Wazuh manager</li>
</ul>
<h3>Lab setup</h3>
<p>In this mini <a id="_idIndexMarker123"/>lab setup, we need three parts: an attacker machine (Kali Linux or Ubuntu), an Ubuntu machine or Windows machine with the Wazuh agent installed on it, and finally, our Wazuh server. If you use a Kali Linux machine, Nmap is preinstalled; however, if you use an Ubuntu machine, you can install the Nmap package using the <code>sudo apt-get install </code><code>nmap</code> command.</p>
<div><div><img alt="Figure 1.17 – Lab setup of network scanning probe detection using Nmap" src="img/B19549_1_17.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.17 – Lab setup of network scanning probe detection using Nmap</p>
<h3>Attack simulation</h3>
<p>If you are <a id="_idIndexMarker124"/>using Kali Linux or Ubuntu as an attacker machine, you can open the terminal and enter the <code>nmap</code> command using the  <code>-sS</code> keyword for an SYN scan and <code>-Pn</code> to skip host discovery. The Nmap SYN scan is a half-open scan that works by sending a TCP SYN packet to the target machine (the Wazuh agent). If the <a id="_idIndexMarker125"/>port is open, the target device responds with a <code>-sS</code> and second, to check for software version using <code>-sV</code> (version scan):</p>
<pre class="console">
# nmap -sS -Pn 10.0.2.5. // Port Scanning
# nmap -sS -sV -Pn 10.0.2.5 // Version Scanning</pre> <p>Once you run the preceding command, you will learn what all the ports are open and second, what version of the package is installed on the target machine. Let’s look at the output of the Nmap port scan command:</p>
<pre class="console">
nmap -sS -Pn 10.0.2.5
Starting Nmap 7.94 ( https://nmap.org ) at 2023-12-10 02:53 IST
Nmap scan report for 10.0.2.5
Host is up (0.0037s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
Nmap done: 1 IP address (1 host up) scanned in 1.45 seconds</pre> <p>As you can see, STATE of port <code>22/tcp</code> and <code>80/tcp</code> are open. Now, let’s look at the output of <a id="_idIndexMarker127"/>the Nmap version check command:</p>
<pre class="console">
nmap -sV -Pn 10.0.2.5
Starting Nmap 7.94 ( https://nmap.org ) at 2023-12-10 02:59 IST
Nmap scan report for 10.0.2.5
Host is up (0.0024s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.52 ((Ubuntu))
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 7.59 seconds</pre> <p>From the output, you can see from the <code>VERSION</code> column that the target is running two software packages: <code>OpenSSH 8.9</code> and Apache with version <code>2.4.52</code>.</p>
<h3>Visualize on the Wazuh dashboard</h3>
<p>To visualize <a id="_idIndexMarker128"/>the Suricata alerts, log in to the Wazuh manager and navigate to <strong class="bold">Security events</strong>. Next, select the agent. You will find the security alert shown in the following diagram.</p>
<div><div><img alt="Figure 1.18 – Visualizing network scanning probes on the Wazuh dashboard" src="img/B19549_1_18.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.18 – Visualizing network scanning probes on the Wazuh dashboard</p>
<p>You can <a id="_idIndexMarker129"/>also apply a filter with <code>rule.group: suricata</code>.</p>
<div><div><img alt="Figure 1.19 – Visualizing network scanning probes using a Suricata filter" src="img/B19549_1_19.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.19 – Visualizing network scanning probes using a Suricata filter</p>
<p>Let’s <a id="_idIndexMarker130"/>expand one of the alerts, as shown in the following.</p>
<p class="IMG---Figure"> </p>
<div><div><img alt="Figure 1.20 – The ET SCAN Potential SSH Scan OUTBOUND alert" src="img/B19549_1_20.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.20 – The ET SCAN Potential SSH Scan OUTBOUND alert</p>
<p>Let’s break some of the following down:</p>
<ul>
<li><code>data.alert.signature</code>: This field talks about the <code>ET SCAN Potential SSH Scan OUTBOUND</code> Suricata rule that detected this abnormal traffic. <code>ET</code> represents the ET ruleset.</li>
<li><code>data.dest_ip</code>: This gives us the victim IP address.</li>
<li><code>data.src_ip</code>: This gives us the attacker IP address.</li>
<li><code>data.alert.action</code>: This field indicates the action taken by Wazuh in response to a detected security event.</li>
<li><code>alerts.severity</code>: This field represents the severity level assigned to the security event by Wazuh.</li>
</ul>
<p>So, this was <a id="_idIndexMarker131"/>the simple use case of how Suricata can detect the network scanning probes and how Wazuh visualizes it on the dashboard. In the next section, we will learn how to detect web-based attacks on our intentionally vulnerable application DVWA.</p>
<h1 id="_idParaDest-31"><a id="_idTextAnchor030"/>Testing web-based attacks using DVWA</h1>
<p>As per a CDNetworks report, around 45.127 billion web applications were detected and blocked throughout 2022, which is an increase of 96.35% compared to 2021 (<a href="https://www.cdnetworks.com/news/state-of-waap-2022/">https://www.cdnetworks.com/news/state-of-waap-2022/</a>). Attacks on web applications <a id="_idIndexMarker132"/>have become so common that <a id="_idIndexMarker133"/>they are now the main cause of data breaches. Some of the most common types of web application <a id="_idIndexMarker134"/>attacks include <strong class="bold">cross-site scripting</strong> (<strong class="bold">XSS</strong>), DDoS, <strong class="bold">cross-site request forgery</strong> (<strong class="bold">CSRF</strong>), <strong class="bold">XML External Entity</strong> (<strong class="bold">XXE</strong>), and <a id="_idIndexMarker135"/>SQL Injection. Suricata with the ET ruleset can detect <a id="_idIndexMarker136"/>such attacks by dissecting packet payloads and scrutinizing HTTP/HTTPS protocol headers for anomalies or abnormal traffic patterns. In this section, we will utilize an intentionally infected web application, DVWA. DVWA is a PHP-based application and is popular among penetration testers and ethical hackers as it helps them get hands-on with security vulnerability and exploitation. We will cover these points in the following subsections:</p>
<ul>
<li>Lab setup</li>
<li>Setting up the victim server with DVWA</li>
<li>Test an SQL Injection attack</li>
<li>Test a reflected XSS attack</li>
</ul>
<h2 id="_idParaDest-32"><a id="_idTextAnchor031"/>Lab setup</h2>
<p>In this <a id="_idIndexMarker137"/>lab setup, we need four parts: an attacker machine (Kali Linux or Ubuntu), a victim server (DVWA running on a Debian server), a TAP server (Wazuh and Suricata agents on Ubuntu), and a Wazuh server. The lab design is in the following figure:</p>
<div><div><img alt="Figure 1.21 – The lab setup for detecting web-based attacks using Suricata" src="img/B19549_1_21.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.21 – The lab setup for detecting web-based attacks using Suricata</p>
<p>Let’s <a id="_idIndexMarker138"/>break this down further:</p>
<ul>
<li>The attacker machine is Kali Linux, but you can use any other machine.</li>
<li>The DVWA application has been installed on a Debian-based server.</li>
<li>Ubuntu Server deployed in promiscuous mode (a network setting) and running a Suricata IDS and Wazuh agent. Promiscuous mode allows the network adapter to intercept and read all the network traffic that it receives.</li>
<li>The Wazuh server is deployed as a VM.</li>
</ul>
<h2 id="_idParaDest-33"><a id="_idTextAnchor032"/>Setting up the victim server with DVWA</h2>
<p>We will <a id="_idIndexMarker139"/>be installing a DVWA application on a Debian-based Linux distribution. You can download it from the following link: <a href="https://www.debian.org/distrib/">https://www.debian.org/distrib/</a>. Our DVWA application has some dependencies such as <code>php</code>, an <code>apache2</code> web server, and a MySQL database:</p>
<ol>
<li>Let’s first install all of them with the following command:<pre class="source-code">
<code>yes</code> and then create a user and set its privileges:<pre class="l2-source"><strong class="bold">CREATE USER 'dvwa'@'localhost' IDENTIFIED BY 'password'; GRANT ALL PRIVILEGES ON dvwa.* TO 'dvwa'@'localhost' IDENTIFIED BY 'password';</strong></pre></li></ol></li>
<li>Next, install the DVWA application. The DVWA source code is available on GitHub. You can enter the following command under <code>/var/www/html</code>:<pre class="source-code">
<strong class="bold">cd /var/www/html</strong>
<strong class="bold">sudo git clone &lt;https://github.com/digininja/DVWA.git&gt;</strong>
<code>/var/www/html/config</code> directory. You will find the <code>config.inc.php.dist</code> file. Just make a copy of this file:<pre class="source-code">
<code>config.inc.php</code> file. Change the <code>db_user</code> to <code>dvwa</code> and <code>db_password</code> to <code>password</code>.</li>
<li>Start the <code>mysql</code> service:<pre class="source-code">
<code>php</code> file and go to <code>/etc/php/x.x/apache2/</code> to open the <code>php.ini</code> file.</li>
<li>Search for <code>allow_url_include</code> and set to <strong class="bold">On</strong>.</li>
<li>Launch DVWA.</li>
<li>Open <a id="_idIndexMarker140"/>DVWA with <a href="http://localhost/DVWA/setup.php">http://localhost/DVWA/setup.php</a> and then reset the database.</li>
<li>Now, log in to DVWA with the default credentials:<pre class="source-code">
<strong class="bold">username: admin</strong>
<strong class="bold">password: password</strong></pre></li> </ol>
<p>This completes our DVWA application installation. Next, we can start testing the DVWA application from Kali Linux against SQL Injection and XSS as explained in the next section.</p>
<h2 id="_idParaDest-34"><a id="_idTextAnchor033"/>Test an SQL Injection attack</h2>
<p>SQL Injection, or <strong class="bold">SQLi</strong>, is a type <a id="_idIndexMarker141"/>of cyberattack in which malicious <a id="_idIndexMarker142"/>SQL code is injected into an application. This lets the attacker extract or modify the contents of the database. This attack modifies the database by tricking the program into running SQL commands that weren’t intended to be run. In order to test the DVWA application against SQL Injection vulnerability, we need to insert our malicious payload into the HTTP request itself:</p>
<pre class="console">
http://&lt;DVWA_IP_ADDRESS&gt;/DVWA/vulnerabilities/sqli/?id=a' UNION SELECT "Hello","Hello Again";-- -&amp;Submit=Submit</pre> <p>Let’s break this down:</p>
<ul>
<li><code>UNION SELECT "Hello","Hello Again"</code>: The <code>UNION SELECT</code> statement is used to combine the results of two or more <code>SELECT</code> queries into a single result set. In this case, the attacker wants to add their own information to the query result. <code>"Hello"</code> and <code>"Hello Again"</code> are the text information that the attacker wants to inject into the query result.</li>
<li><code>-- -</code>: This is a comment in SQL. Everything following this on the same line is considered a comment and ignored by the SQL processor.</li>
<li><code>&amp;Submit=Submit</code>: This part suggests that the query could be part of a form submission where the <code>Submit</code> parameter is sent with the <code>Submit</code> value.</li>
</ul>
<p>Now, let’s check on our Wazuh dashboard for the relevant security alerts.</p>
<div><div><img alt="Figure 1.22 – Visualizing SQL Injection alerts" src="img/B19549_1_22.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.22 – Visualizing SQL Injection alerts</p>
<p>As you <a id="_idIndexMarker143"/>expand the individual security alert, you will see detailed information about the alert, the Suricata ET rule, and the category as shown in the following figure:</p>
<div><div><img alt="Figure 1.23 – Suricata alert for SQL Injection on the Wazuh dashboard" src="img/B19549_1_23.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.23 – Suricata alert for SQL Injection on the Wazuh dashboard</p>
<p>Let’s break this down:</p>
<ul>
<li><code>Suricata: Alert - ET WEB_SERVER Possible SQL Injection Attempt UNION SELECT</code>: This represents the security alert name</li>
<li><code>data.alert.category</code> <code>Web Application Attack</code>: This shows the category of the rule as specified in the Suricata ET ruleset</li>
<li><code>Data.alert.metadata.tag: SQL_Injection</code>: This shows the metadata of the Suricata ET ruleset for web application attacks</li>
</ul>
<p>As we <a id="_idIndexMarker144"/>scroll down the alert information even further, we will see more information, as shown in the following figure.</p>
<div><div><img alt="Figure 1.24 – Detailed information of a Suricata alert for SQL Injection" src="img/B19549_1_24.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.24 – Detailed information of a Suricata alert for SQL Injection</p>
<p>Let’s break this down:</p>
<ul>
<li><code>data.http.http.user_agent</code>: This represents the browser information from where the attack has been attempted</li>
<li><code>data.http.url: /DVWA/vulnerabilities/sqli/?id=a%27%20UNION%20SELECT%20%22text1%22,%22text2%22;--%20-&amp;Submit=Submit</code>: This represents a URL query string for the DVWA, specifically targeting a SQL Injection vulnerability.</li>
</ul>
<p>Now, we have learned about how to detect SQL Injection attacks using a Suricata IDS and visualize them on a Wazuh dashboard. In the next section, we will test our DVWA application <a id="_idIndexMarker145"/>for XSS vulnerabilities. We will later detect and visualize them on a Wazuh dashboard.</p>
<h2 id="_idParaDest-35"><a id="_idTextAnchor034"/>Test a reflected XSS attack</h2>
<p>XSS is a type of code injection attack that targets websites and sends malicious scripts to a user’s <a id="_idIndexMarker146"/>web browser to execute. In a <strong class="bold">reflected XSS</strong> attack, the attacker inserts malicious script into a website or app, which is <a id="_idIndexMarker147"/>subsequently reflected onto the user’s browser from the web server. This kind of attack is possible when a user inputs information into the application, and the application reflects it back to the user without enough sanitization or validation. To test if our intentionally vulnerable application, DVWA, for a reflected XSS attack, we can submit a piece of JavaScript code and verify whether it is reflecting the data back to our browser.</p>
<p>You can open the DVWA application and navigate to the <strong class="bold">XSS (Reflected)</strong> tab. Next, enter a sample JavaScript code as written here:</p>
<pre class="source-code">
&lt;script&gt;alert("Hello");&lt;/script&gt;</pre> <p>Let’s break this down:</p>
<ul>
<li><code>&lt;script&gt; tag</code>: This indicates a piece of JavaScript code that should be executed by the browser</li>
<li><code>Alert("Hello")</code>: This is a function that tells the browser to display a pop-up box with the <strong class="bold">Hello</strong> text when the script is executed</li>
</ul>
<p>You can enter the JavaScript code and click on the <strong class="bold">Submit</strong> button as shown in the following diagram.</p>
<div><div><img alt="Figure 1.25 – Initiating a reflected XSS attack on DVWA" src="img/B19549_1_25.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.25 – Initiating a reflected XSS attack on DVWA</p>
<p>The <a id="_idIndexMarker148"/>DVWA application doesn’t have a sanitization check for user inputs, making it vulnerable to reflected XSS attacks. As a result, we will see the <strong class="bold">Hello</strong> text reflected back to our browser as shown in the following diagram.</p>
<div><div><img alt="Figure 1.26 – Visualizing reflected XSS on DVWA" src="img/B19549_1_26.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.26 – Visualizing reflected XSS on DVWA</p>
<p>So, the <a id="_idIndexMarker149"/>attack was successful. Let’s visualize the alert on the Wazuh dashboard. Navigate to <strong class="bold">Security Alerts</strong> and select the agent.</p>
<div><div><img alt=" Figure 1.27 – Suricata alert against an XSS attack" src="img/B19549_1_27.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> Figure 1.27 – Suricata alert against an XSS attack</p>
<p>Let’s <a id="_idIndexMarker150"/>break this down:</p>
<ul>
<li><code>Security Alert – ET WEB_SERVER Script tag in URI Cross Site Scripting Attempt</code>: This represents the security alert name and signature name.</li>
<li><code>data.alert.category</code> <code>Web Application Attack</code>: This represents the category of the alert based on the Suricata ET ruleset.</li>
<li><code>data.alert.metadata.tag</code> <code>Cross_Site_Scripting, XSS</code>: This represents the metadata of the security alerts. In our case, it’s <code>Cross_Site_Scripting</code> and <code>XSS</code>.</li>
</ul>
<p>In this section, we have successfully launched the SQL Injection and reflected XSS on the intentionally vulnerable application called DVWA. Finally, we were able to detect the attacks using Suricata ET rules and visualize them on the Wazuh dashboard.</p>
<p>In the next section, we will emulate multiple attacks on an Ubuntu machine using the tmNIDS project and visualize it on the Wazuh manager.</p>
<h1 id="_idParaDest-36"><a id="_idTextAnchor035"/>Testing NIDS with tmNIDS</h1>
<p><strong class="bold">tmNIDS</strong> is a GitHub <a id="_idIndexMarker151"/>project maintained by <em class="italic">3CoreSec</em>. tmNIDS is a simple framework designed for <a id="_idIndexMarker152"/>testing the detection <a id="_idIndexMarker153"/>capabilities of NIDS such as Suricata and Snort. The tests inside tmNIDS are designed to align with rulesets compatible with the ET community. The ET community builds and shares Suricata rules to detect a wide range of attacks such as web-based attacks, network attacks, and DDoS attacks. In this section, we will learn to simulate attacks using tmNIDS and we will visualize them on the Wazuh dashboard. We will cover these points in the following subsections:</p>
<ul>
<li>Lab setup</li>
<li>Installing tmNIDS on Ubuntu Server</li>
<li>Testing for a malicious User-Agent</li>
<li>Testing for a Tor connection</li>
<li>Test everything at once</li>
</ul>
<h2 id="_idParaDest-37"><a id="_idTextAnchor036"/>Lab setup</h2>
<p>In this <a id="_idIndexMarker154"/>lab setup, we have two devices: Ubuntu Server running the Wazuh agent, Suricata IDS, and tmNIDS, and second, the Wazuh server installed using a VM OVA file. The lab design is in the following figure.</p>
<div><div><img alt=" Figure 1.28 – Lab set for testing Suricata IDS rules using tmNIDS" src="img/B19549_1_28.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"> Figure 1.28 – Lab set for testing Suricata IDS rules using tmNIDS</p>
<h2 id="_idParaDest-38"><a id="_idTextAnchor037"/>Installing tmNIDS on Ubuntu Server</h2>
<p>The source <a id="_idIndexMarker155"/>code of the tmNIDS project is published <a id="_idIndexMarker156"/>on GitHub (<a href="https://github.com/3CORESec/testmynids.org">https://github.com/3CORESec/testmynids.org</a>). To install tmNIDS, we can run a <code>curl</code> command to download the packages:</p>
<pre class="console">
curl –sSL https://raw.githubusercontent.com/3CORESec/testmynids.org/master/tmNIDS&gt; -o /tmp/tmNIDS &amp;&amp; chmod +x /tmp/tmNIDS &amp;&amp; /tmp/tmNIDS</pre> <p>Let’s break this down:</p>
<ul>
<li><code>curl</code>: This is a utility tool that initiates a request to download data from the specific URL.</li>
<li><code>-sSL</code>: Here, <code>-s</code> stands for showing progress without any output. The <code>S</code> flag will show errors if <code>curl</code> encounters any problem during the request and the <code>L</code> flag represents redirection.</li>
<li><code>-o /tmp/tmNIDS</code>: This informs <code>curl</code> to save downloaded files as <code>/</code><code>tmp</code> directory.</li>
<li><code>chmod +x /tmp/tmNIDS</code>: It changes the file permissions of the downloaded file to executable.</li>
</ul>
<p>Once the <a id="_idIndexMarker157"/>package has been executed, you will see <a id="_idIndexMarker158"/>a list of 12 tests for Suricata IDS as in the following diagram.</p>
<div><div><img alt="Figure 1.29 – Visualizing tmNIDS detection tester" src="img/B19549_1_29.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.29 – Visualizing tmNIDS detection tester</p>
<p>So, now <a id="_idIndexMarker159"/>that our tmNIDS is ready, we can start testing <a id="_idIndexMarker160"/>our Ubuntu Server (running Suricata IDS) against multiple attacks as explained in the next sections.</p>
<h2 id="_idParaDest-39"><a id="_idTextAnchor038"/>Testing for a malicious User-Agent</h2>
<p>In this scenario, we will execute test 3 from the tmNIDS tests, which is <code>HTTP Malware User-Agent</code>. For every HTTP request, there is a <code>User-Agent</code> header that describes the user’s <a id="_idIndexMarker161"/>browser, device, and OS. When an HTTP web browser sends a request to a web server, it inserts this header to identify itself to the server. The <code>User-Agent</code> string usually contains information such as the browser’s name and version, OS, device type, and sometimes extra data such as rendering engine details. If you take a closer look at the HTTP header using Google developer mode, you will find the <code>User-Agent</code> information:</p>
<pre class="console">
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36</pre> <p>This <code>User-Agent</code> string says that the browser is running on a Windows 10 64-bit system, using the Chrome browser (version <code>96.0.4664.45</code>) with rendering engines associated with both WebKit (Safari) and Gecko (Firefox).</p>
<p>To test <a id="_idIndexMarker162"/>the Ubuntu Server (running Suricata IDS) against <code>HTTP Malware User-Agent test</code>, enter <code>3</code> on the <code>tmNIDS</code> prompt.</p>
<div><div><img alt="Figure 1.30 – Choosing option 3 from the tmNIDS detection tester" src="img/B19549_1_30.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.30 – Choosing option 3 from the tmNIDS detection tester</p>
<p>Now, let’s visualize the alerts on the Wazuh dashboard. You can navigate to the <strong class="bold">Security Alerts</strong> module and select the endpoint. You can find the alerts as shown in the following diagram.</p>
<div><div><img alt="Figure 1.31 – Suricata alert against a suspicious User-Agent" src="img/B19549_1_31.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.31 – Suricata alert against a suspicious User-Agent</p>
<p>Let’s <a id="_idIndexMarker163"/>break some of the following down:</p>
<ul>
<li><code>Suricata: Alert – ET POLICY GNU/LINUX APT User-Agent Outbound likely to package management</code>: This represents the <strong class="bold">Security alerts</strong> name and signature</li>
<li><code>data.alert.category : Not Suspicious Traffic</code>: This represents the category of the ET ruleset category</li>
<li><code>data.alert.signature : ET POLICY GNU/Linux APT User-Agent Outbound likely related to package management</code>: This suggests potential APT-related outbound network activity, possibly tied to package management.</li>
</ul>
<p>After successfully testing <code>HTTP Malicious User-Agent</code> and visualizing alerts on the Wazuh dashboard, we will test the Tor connection in the next section.</p>
<h2 id="_idParaDest-40"><a id="_idTextAnchor039"/>Testing for Tor connection</h2>
<p>In this scenario, we will execute test 5, which is <code>Tor</code>. <strong class="bold">Tor</strong> is a decentralized, anonymous network <a id="_idIndexMarker164"/>that users can use to browse the internet privately and safely. However, it is often used by hackers, malicious actors, and cybercriminals who access the dark web and sell stolen data and illegal goods online. Its anonymity features can keep attackers’ identities secret, making it hard for the government to track their actions and hence, it is important for every organization to block any traffic from Tor services. The <a id="_idIndexMarker165"/>most popular Tor application is <strong class="bold">Tor Browser</strong>. When anyone accesses any website through the Tor Browser, it goes through proxy nodes, making it difficult for anyone to intercept. From a cybersecurity point of view, we can build a list of IP addresses of such nodes and eventually block them, or block Tor-based applications based on their signatures.</p>
<p>To test this scenario, go back to the tmNIDS prompt and enter <code>5</code>. The Tor attack will be executed on our Ubuntu Server running Suricata IDS.</p>
<div><div><img alt="Figure 1.32 – Choosing option 5 from the tmNIDS detection tester" src="img/B19549_1_32.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.32 – Choosing option 5 from the tmNIDS detection tester</p>
<p>To visualize the alert, navigate to the <strong class="bold">Security Alerts</strong> module of Wazuh and check for the relevant alerts shown in the following diagram.</p>
<div><div><img alt="Figure 1.33 – Suricata alert against Tor hidden traffic" src="img/B19549_1_33.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.33 – Suricata alert against Tor hidden traffic</p>
<p>Both have been detected by the Suricata ET ruleset. There are two rule descriptions:</p>
<ul>
<li><code>Suricata: Alert - ET POLICY DNS Query for TOR Hidden Domain .onion Accessible </code><code>Via TOR</code></li>
<li><code>Suricata: Alert - ET MALWARE Cryptowall .onion </code><code>Proxy Domain</code></li>
</ul>
<p>We have <a id="_idIndexMarker166"/>successfully tested the Tor .onion DNS response test and visualized the alerts on the Wazuh manager. In the next section, we will run all the tests at once and visualize the alerts.</p>
<h2 id="_idParaDest-41"><a id="_idTextAnchor040"/>Testing everything at once</h2>
<p>Now, this is <a id="_idIndexMarker167"/>like a non-stop rifle. You basically launch all the tests at once. To start, type <code>11</code> under the tmNIDS tests prompt and monitor the events on the Wazuh manager.</p>
<div><div><img alt="Figure 1.34 – Suricata alerts against all the tmNIDS tests" src="img/B19549_1_34.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 1.34 – Suricata alerts against all the tmNIDS tests</p>
<p>As you can see, we have <a id="_idIndexMarker168"/>received alerts against all the tests listed in the tmNIDS detection tester. This shows that our Suricata IDS along with the ET ruleset are effective against attacks launched by the tmNIDS project.</p>
<h1 id="_idParaDest-42"><a id="_idTextAnchor041"/>Summary</h1>
<p>In this chapter, we learned about Wazuh and its integration with the Suricata IDS to effectively detect anomalous traffic behavior. We started by exploring the Suricata IDS and its deployment method. We then covered the setup of Wazuh, the configuration of Suricata rules, and practical threat detection using DVWA. We then learned about testing Suricata rulesets using a tmNIDS tester.</p>
<p>In the next chapter, we will learn about the different malware detection capabilities of the Wazuh platform. We will also explore third-party integration for the purpose of detecting advanced malware files and signatures.</p>
</div>
</body></html>