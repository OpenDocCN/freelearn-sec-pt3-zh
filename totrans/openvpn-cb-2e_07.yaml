- en: Chapter 7. Troubleshooting OpenVPN - Routing
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following troubleshooting topics:'
  prefs: []
  type: TYPE_NORMAL
- en: The missing return route
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Missing return routes when `iroute` is used
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: All clients function except the OpenVPN endpoints
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Source routing
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Routing and permissions on Windows
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Unable to change Windows network location
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Troubleshooting client-to-client traffic routing
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Understanding the `MULTI: bad source` warnings'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Failure when redirecting the default gateway
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The topic of this chapter and the previous one is troubleshooting the OpenVPN.
    This chapter focuses on the all-too-common routing issues that occur when setting
    up a VPN. As more than half of the questions asked on the `openvpn-users` mailing
    list can be traced back to routing issues, this chapter intends to provide answers
    to some of the more frequent routing misconfigurations.
  prefs: []
  type: TYPE_NORMAL
- en: The recipes in these chapters will therefore deal with first, breaking the things,
    and then, providing the tools for how to find and solve the configuration errors.
  prefs: []
  type: TYPE_NORMAL
- en: The missing return route
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: After setting up OpenVPN successfully for the very first time, it is very common
    to misconfigure the network routes for the VPN. In this recipe, we will first
    set up a basic TUN-style VPN as is done in [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*.
    At first, routing will not work until the right routes are added. The purpose
    of this recipe is to describe how to troubleshoot such a routing error.
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We use the following network layout:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting ready](img/image00380.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Set up the client and server certificates using the *Setting up the public and
    private keys* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks*. For this recipe, the server
    computer was running CentOS 6 Linux and OpenVPN 2.3.11\. The client was running
    Fedora 22 Linux and OpenVPN 2.3.11\. Keep the configuration file `basic-udp-server.conf`
    from the *Server-side routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    as well as the client configuration file `basic-udp-client.conf`.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Start the server using the configuration file `basic-udp-server.conf`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Next, start the client:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'At this point, it is possible to ping the remote VPN IP and all the interfaces
    that are on the VPN server themselves:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: If either of these pings fails, then the VPN connection has not been established
    successfully and there is no need to continue.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'If no routes have been added to the server-side gateway, then all other hosts
    on the remote `10.198.0.0/16` network will be unavailable:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'If we add a route on the LAN gateway of the remote network to explicitly forward
    all the VPN traffic to the VPN server, then we can reach all machines on the remote
    LAN (like it was done in the *Server-side routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Here, `10.198.1.1` is the LAN IP address of the VPN server. In this case, the
    remote LAN gateway is running Linux. The exact syntax for adding a static route
    to the gateway will vary with the model and operating system of the gateway.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Now, all the machines are reachable:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'When the VPN client attempts to make a connection to a host on the server-side
    LAN, packets are sent with a source and destination IP address:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Source IP** = `10.200.0.2`: This address is the VPN tunnel''s IP address'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Destination IP** = **IP**: This is the IP of the host we''re trying to contact'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The remote host will want to reply with a packet, with the source and destination
    IP addresses swapped. When the remote host wants to send the packet, it does not
    know where to send it to, as the address `10.200.0.2` is our private VPN address.
    It then forwards the packet to the LAN gateway. However, the LAN gateway also
    does not know where to return the packets to, and will forward them out to its
    default gateway. When the packets reach a router that is connected directly to
    the Internet, that router usually will decide to drop (throw away) the packets,
    causing the host to become unreachable.
  prefs: []
  type: TYPE_NORMAL
- en: By adding a route on the remote LAN gateway - telling it that all the traffic
    for the network `10.200.0.0/24` should be forwarded to the VPN server - the packets
    are sent back to the right machine. The VPN server will forward the packets back
    to the VPN client and the connection is established.
  prefs: []
  type: TYPE_NORMAL
- en: The step to ping the remote VPN endpoint first and then the server-LAN IP (`10.198.0.10`)
    may seem superfluous at first but these are crucial steps when troubleshooting
    routing issues. If these steps already fail, then there is no need to look at
    the missing routes.
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this section, we will focus on different solutions to the problem described
    in this recipe.
  prefs: []
  type: TYPE_NORMAL
- en: Masquerading
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: A quick and dirty solution to the above issue is outlined in the *Server-side
    routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks*. In the *There's More...*
    section of that recipe, masquerading (a form of NAT'ing) is used to make it appear
    as if all the traffic is coming from the OpenVPN server itself. This is perfect
    if you have no control over the remote LAN gateway, but it is not a very clean
    routing solution. Certain applications do not behave very well when NAT'ted. Also,
    from a security logging point of view, it is sometimes better to avoid NAT'ting,
    as you are mapping multiple IP addresses onto a single one, thereby losing information.
  prefs: []
  type: TYPE_NORMAL
- en: Adding routes on the LAN hosts
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Instead of adding a route to the remote LAN gateway, it is also possible to
    add a route on each of the remote LAN hosts that the VPN client needs to reach.
    This solution is perfect if the VPN client only needs to be able to reach a limited
    set of server-side hosts, but it does not scale very well.
  prefs: []
  type: TYPE_NORMAL
- en: See also
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The *Server-side routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2. 
    Client-server IP-only Networks"), *Client-server IP-only Networks*, which contains
    the basic setup for routing the traffic from the server-side LAN
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Missing return routes when iroute is used
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This recipe is a continuation of the previous one. After ensuring that a single
    VPN client can reach the server-side LAN, the next step is to make sure that other
    hosts behind the VPN client can reach the hosts on the server-side LAN.
  prefs: []
  type: TYPE_NORMAL
- en: 'In this recipe, we will first set up a VPN as is done in the *Routing: subnets
    on both sides* recipe from Chapter 2, *Client-Server IP-Only Networks*. If no
    return routes are set up, then the hosts on the client-side LAN will not be able
    to reach the hosts on the server-side LAN and vice versa. By adding the appropriate
    routes, the issue is resolved.'
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We use the following network layout:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting ready](img/image00381.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: 'Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client was running Fedora 22 Linux and OpenVPN 2.3.11\.
    Keep the configuration file `example2-5-server.conf`, from the *Routing: subnets
    on both sides* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks*, as well as the client configuration, `basic-udp-client.conf`,
    from the *Server-side routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*.'
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Start the server:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Next, start the client:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'At this point, it is possible to ping the remote VPN IP and all the interfaces
    that are on the VPN server itself, and vice versa:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'The routing table on the server shows that the remote network is routed correctly:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'When we try to ping a remote host on the server-side LAN it fails, as was the
    case in the previous recipe. Vice versa, when we try to ping a client-side LAN
    host from a host on the server-side LAN, we see:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'By adding the appropriate routes on the gateways at both the sides, the routing
    is restored. First, the gateway on the server-side LAN:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Here, `10.198.0.10` is the LAN IP address of the VPN server.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Next, the gateway/router on the client-side LAN:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Here, `192.168.4.64` is the LAN IP address of the VPN client.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: After this, the hosts on the LANs can reach each other.
  prefs: []
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Similar to the previous recipe, when a host on the Site A''s LAN attempts to
    make a connection to a host on the Site B''s LAN packets that are sent with a
    source and destination IP address:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Source IP** = `192.168.4.64`: Site A''s LAN address'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Destination IP** = `10.198.1.12`: Site B''s LAN address'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The remote host will want to reply with a packet with the source and destination
    IP addresses swapped. When the remote host wants to send the packet, it forwards
    the packet to the LAN gateway. However, the LAN gateway also does not know where
    to return the packets to, and will forward them out to its default gateway. When
    the packets reach a router that is connected directly to the Internet, then the
    router usually will decide to drop (throw away) the packets, causing the host
    to become unreachable.
  prefs: []
  type: TYPE_NORMAL
- en: A similar problem occurred in the previous recipe, but now the IP addresses
    of the packets are the actual Site A's and Site B's LAN IP addresses.
  prefs: []
  type: TYPE_NORMAL
- en: By adding the appropriate routes on both the sides, the problem is alleviated.
  prefs: []
  type: TYPE_NORMAL
- en: 'When troubleshooting this sort of routing issue, it is very important to start
    at the innermost network (the actual VPN, in this case) and then work your way
    outwards:'
  prefs: []
  type: TYPE_NORMAL
- en: First, make sure the VPN endpoints can see each other.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Make sure the VPN client can reach the server LAN IP and vice versa.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Make sure the VPN client can reach a host on the server-side LAN.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Make sure a host on the server-side LAN can see the VPN client.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Make sure a host on the client-side LAN can see the VPN server.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Finally, make sure a host on the client-side LAN can see a host on the server-side
    LAN and vice versa.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Again, a quick and a dirty solution to the above issue is outlined in the *Server-side
    routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks*. In that recipe, masquerading
    is used to make it appear as if all the traffic is coming from the OpenVPN server
    itself. In particular when connecting subnets over a VPN, this is not advisable,
    as masquerading makes it impossible to tell which client is connecting to which
    server and vice versa. Therefore, a fully-routed setup is preferred in this case.
  prefs: []
  type: TYPE_NORMAL
- en: See also
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The *Routing: subnets on both sides* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    which explains in detail how to set up routing on both the client and the server
    side'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: All clients function except the OpenVPN endpoints
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: This recipe is again a continuation of the previous one. The previous recipe
    explained how to troubleshoot routing issues when connecting a client-side LAN
    (or subnet) to a server-side LAN. However, in the previous recipe, an omission
    in the routing configuration was made on purpose. In this recipe, we will focus
    on troubleshooting this quite common omission.
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We use the following network layout:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting ready](img/image00382.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11.
  prefs: []
  type: TYPE_NORMAL
- en: 'The client was running Fedora 22 Linux and OpenVPN 2.3.11\. Keep the configuration
    file `example2-5-server.conf` from the *Routing: subnets on both sides* from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*, at hand, as well as the client configuration, `basic-udp-client.conf`,
    from the *Server-side routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*.'
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Start the server:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Next, start the client:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Add the appropriate routes on the gateways at both the sides:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: After this, all the hosts on the LANs can reach each other.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'We verify this by pinging various machines on the LANs on either of the sides:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'All of them work. However, when the VPN server tries to ping a host on the
    client-side LAN, it fails:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Similarly, the client can only reach the LAN IP of the server and none of the
    other hosts.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'On Linux and UNIX hosts, it is possible to explicitly specify the source IP
    address:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: That works! So, there is a problem with the source address of the packets.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'By adding an extra route for the VPN subnet itself, to the gateways on both
    the ends, this issue is resolved:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Now, the VPN server can reach all the hosts on the client''s subnet and vice
    versa:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE20]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'To troubleshoot issues like these, it is very handy to write out all the source
    addresses and the destination addresses of the LANs involved. In this case, the
    problem occurs when the VPN server wants to connect to a host on the client-side
    LAN. On the VPN server, the packet that is sent to the client-side host is sent
    out of the VPN interface directly. Therefore, the source address of this packet
    is set to the IP address of the VPN interface itself. Thus, the packet has the
    following IP addresses:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Source IP** = `10.200.0.1`: VPN server''s IP address'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Destination IP** = `192.168.4.66`: Site A''s LAN address'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The remote host will want to reply with a packet with the source and destination
    IP addresses swapped. When the remote host wants to send the packet, it forwards
    the packet to the LAN gateway. However, the LAN gateway also does not know where
    to return the packets to, and will forward them out to its default gateway. When
    the packets reach a router that is connected directly to the Internet, that router
    usually will decide to drop (throw away) the packets, causing the host to become
    unreachable.
  prefs: []
  type: TYPE_NORMAL
- en: This problem occurs only on the VPN server and VPN client. On all other hosts
    on the client-side and server-side LAN, the LAN IP address is used and routing
    works as configured in the previous recipe.
  prefs: []
  type: TYPE_NORMAL
- en: By adding the appropriate routes on both the sides the problem is resolved.
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A good use of NAT'ing in this recipe would be to remove any references to the
    VPN IP range from the routing tables. This can be done by just masquerading the
    VPN endpoint addresses. If this is done, the extra routes are no longer needed
    on the gateways on both the LANs. For example, by adding a NAT'ing rule on the
    server and a similar one on the client, the extra routes on the gateways are no
    longer needed.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: Note that this is easily done on Linux and UNIX-based operating systems but
    it requires more effort on Windows.
  prefs: []
  type: TYPE_NORMAL
- en: See also
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The *Routing: subnets on both sides* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    which explains in detail how to set up routing on both the client and the server
    side'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Source routing
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: As the network configurations grow more complex, the requirement for more advanced
    features, such as the source routing features, increases. Source routing is typically
    used whenever a server is connected to a network (or the Internet) using two network
    interfaces (see the following image). In this case, it is important to ensure
    that the connections that are started on one of the interfaces are kept to that
    interface. If the incoming traffic for a (VPN) connection is made on the first
    interface but the return traffic is sent back over the second interface, then
    VPN connections, amongst others, will fail, as we shall see in this recipe. Source
    routing is an advanced feature of most of the modern operating systems. In this
    recipe, we will show how to set up source routing using the Linux `iproute2` tools,
    but the same can be achieved on other operating systems using similar tools.
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We use the following network layout:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting ready](img/image00383.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11 and was connected to a router with two IP addresses: `192.168.4.65`
    and `192.168.2.13`; the default gateway for the system was `192.168.2.1`, which
    means that the traffic will leave the interface with the IP address `192.168.2.13`
    by default. The secondary gateway had the IP address `192.168.4.1`. The client
    was running Windows 7 64bit and OpenVPN 2.3.11\. The client IP address was `192.168.2.10`
    with default route `192.168.2.1`. Keep the configuration file `basic-udp-server.conf`
    from the *Server-side routing* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    as well as the client configuration file `basic-udp-client.ovpn` from the *Using
    an ifconfig-pool block* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2. 
    Client-server IP-only Networks"), *Client-server IP-only Networks*.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Start the server using the configuration file `basic-udp-server.conf`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE22]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Next, start the client:![How to do it...](img/image00384.jpeg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In this configuration, the remote server address `openvpnserver.example.com`
    resolves to `192.168.4.65`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The connection will fail to start and the client OpenVPN log file will show
    the following message repeated a few times:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE23]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'By adding a source routing rule to return all the traffic, which comes in on
    one interface (`192.168.4.65`) from a host on the other interface (the subnet `192.168.2.0/24`),
    wants to leave the interface (`192.168.2.0/24`) to the router associated with
    the incoming subnet (`192.168.4.1`), the connection is restored:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE24]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Now, the client can successfully connect to the VPN server.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: When a connection is made from the client `192.168.2.10` to the VPN server `192.168.4.65`,
    the return route is chosen to be the shortest one possible, which in the setup
    described here is `192.168.2.1`. The server operating system will set the return
    IP address of the packets to `192.168.2.13`, as that is the IP address of the
    interface associated with that network. This confuses the OpenVPN client, as it
    connects to host `192.168.4.65` but gets return traffic from `192.168.2.13`. By
    explicitly forcing traffic to go out the other interface ( `192.168.4.65`), this
    asymmetric routing issue is resolved.
  prefs: []
  type: TYPE_NORMAL
- en: 'The exact syntax of the source routing rules is highly dependent on the exact
    network configuration, but the general idea of the three commands outlined in
    the section *How to do it* is to:'
  prefs: []
  type: TYPE_NORMAL
- en: Create a routing table with ID `100` and set the default gateway device for
    this table to `eth0`, which has the IP address `192.168.4.65`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Create a routing rule that any traffic which comes from client `192.168.2.10`
    is redirected to the routing table
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Create a routing rule that any traffic which wants to leave client `192.168.2.10`
    is redirected to the routing table
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The routing rules would need to be tweaked for a live situation, as these rules
    block out certain other types of network traffic, but the principle is correct.
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: More advanced routing control can be done using **LARTC** (**Linux Advanced
    Routing and Traffic Control**). A better approach would be to mark packets coming
    on the interface and only redirect the marked packets to the correct outgoing
    interface.
  prefs: []
  type: TYPE_NORMAL
- en: Routing and permissions on Windows
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will focus on the common error experienced by the users when
    the VPN client machine is running Windows without full or elevated privileges.
    Under certain circumstances, the OpenVPN client can connect successfully but the
    routes that are pushed out by the remote server are not correctly set up. This
    recipe will focus on how to troubleshoot and correct this error.
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client was running Windows 7 64bit and OpenVPN 2.3.11\.
    Keep the configuration file `basic-udp-server.conf` from the *Server-side routing*
    recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only
    Networks"), *Client-server IP-only Networks*, as well as the client configuration
    file `basic-udp-client.ovpn` from the *Using an ifconfig-pool block* recipe from
    [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Log in on Windows as a non-privileged user, being a user without `Power User`
    or `Administrator` privileges. Also, make sure to temporarily remove the **Run
    as Administrator** flag from OpenVPN to launch OpenVPN without elevated privileges.
    This can be done by unchecking the **Run this program as an administrator** flag
    in the OpenVPN GUI properties:![How to do it...](img/image00385.jpeg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Start the server using the configuration file `basic-udp-server.conf`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE25]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Finally, start the client.![How to do it...](img/image00386.jpeg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The connection will start and the OpenVPN GUI light will turn green. However,
    the client OpenVPN log file will show the following messages:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: 'If you attempt to reach a host on the server-side LAN, it will fail:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: The solution to this issue is to give the proper networking rights to the user,
    or to restore elevated privileges for OpenVPN again.
  prefs: []
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The OpenVPN client tries to open the TAP-Win32 adapter, which is allowed in
    a default installation. However, when the server pushes out a route to the client
    using:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: Then, the OpenVPN client will not be able to actually add this route to the
    system routing tables, due to missing administrator privileges. However, the VPN
    connection is successfully established and the GUI client shows a successful connection.
  prefs: []
  type: TYPE_NORMAL
- en: Note that even without the `push "route"` statement, the Windows OpenVPN GUI
    showed a green icon, suggesting the connection had started. Technically speaking,
    it is true that the connection has been established, but this should still be
    considered as a bug.
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Windows XP and higher versions include a **Run As Administrator** service that
    allows a user to temporarily run a program with a higher privilege level. This
    mechanism was expanded in Windows Vista/7 and was made the default when launching
    applications. This has actually been the cause of numerous questions on the `openvpn-users`
    mailing list when running OpenVPN on these platforms.
  prefs: []
  type: TYPE_NORMAL
- en: Unable to change Windows network location
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'The title of this recipe may not seem related to routing issues, but the Windows
    network location depends on routing to work. Starting with Windows Vista, Microsoft
    introduced the concept of network locations. By default, there are multiple network
    locations: **Home**, **Work** and **Public** for Windows 7 and **Private** and **Public**
    for Windows 8 and above. These network locations apply to all network adapters,
    including OpenVPN''s virtual TAP-Win network adapter.'
  prefs: []
  type: TYPE_NORMAL
- en: The **Home** network location is intended for a home network. Similarly, the **Work**
    network location also provides a high level of trust at work, allowing the computer
    to share files, connect to printers and so on. In Windows 8 and above, the **Home**
    and **Work** network locations are merged together to become the trusted **Private**
    network location. The **Public** network location is not trusted and access to
    network resources is restricted by Windows, even when the Windows firewall is
    disabled.
  prefs: []
  type: TYPE_NORMAL
- en: The routing properties of an OpenVPN setup determine whether the TAP-Win adapter
    is trusted or not, and thus whether file sharing is allowed. In this recipe, we
    will show how to change an OpenVPN setup so that the network location can be altered.
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client was running Windows 7 64bit and OpenVPN 2.3.11\.
    Keep the configuration file `example2-7-server.conf` from the *Redirecting the
    default gateway* recipe from Chapter 2, *Client-server IP-only Networks* at hand,
    as well as the client configuration file `basic-udp-client.ovpn` from the *Using
    an ifconfig-pool block* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2. 
    Client-server IP-only Networks"), *Client-server IP-only Networks*.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Start the server using the configuration file `example-2-7-server.conf`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Next, start the client.![How to do it...](img/image00387.jpeg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Go to the **Network and Sharing Center** and observe that the TAP adapter is
    in the section **Public Network** and that it is not possible to change this.
    Also, try to access a file share via the VPN tunnel. This should not be possible.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Change the server configuration by removing `def1` from the `push redirect-gateway
    def1` line:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Restart the VPN connection on both sides.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: As the VPN connection comes up, Windows will ask you for the location of the
    new network **Network**:![How to do it...](img/image00388.jpeg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Choose the **Work network** location, then give the new network the name `VPN`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Now, go to the **Network and Sharing Center** once more and observe that the
    TAP adapter (named **vpn0**) is in the work network location **VPN**:![How to
    do it...](img/image00389.jpeg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Even though all network traffic is routed over the VPN (using `redirect-gateway
    def1`) Windows does not trust the VPN adapter and hence will refuse full access
    over the VPN tunnel. Windows will only trust a network adapter if it advertises
    a default gateway (0.0.0.0/0), or the network adapter must be part of a Windows
    domain. This can be fixed by changing the server configuration to use:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: It is also possible to use the Windows Registry editor to change the network
    location, but this is not recommended, as it will mark all network adapters as
    trusted.
  prefs: []
  type: TYPE_NORMAL
- en: Troubleshooting client-to-client traffic routing
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will troubleshoot a VPN setup where it is the intention that
    client-to-client traffic is enabled, but the server configuration directive "client-to-client"
    is missing. In a TUN-style network, it is possible to allow client-to-client traffic
    without this directive and it even allows the server administrator to apply firewalling
    rules to the traffic between clients. In a TAP-style network, this is generally
    not possible, as will be explained in the *There's more...* section.
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We use the following network layout:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting ready](img/image00390.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The first client was running Fedora 22 Linux and OpenVPN
    2.3.11\. The second client was running Windows 7 64bit and OpenVPN 2.3.11\. Keep
    the configuration file `basic-udp-server.conf` from the *Server-side routing*
    recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only
    Networks"), *Client-server IP-only Networks*, as well as the client configuration
    file `basic-udp-client.ovpn` from the *Using an ifconfig-pool block* recipe from
    [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Start the server using the configuration file, `basic-udp-server.conf`:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE32]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Next, start the Linux client.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE33]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: And finally, start the Windows client:![How to do it...](img/image00391.jpeg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Next, try to ping the Windows client from the Linux client (make sure no firewalls
    are blocking the traffic):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE34]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: It is possible that the host is already reachable, but in that case the firewall
    on the server is very permissive.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'At this point, it is instructive to set up `iptables` logging on the VPN server:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE35]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Then try the ping again. This will result in the following messages in `/var/log/messages`:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE36]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'The first client `10.200.0.2` is trying to reach the second client `10.200.0.3`.
    This issue can be resolved by adding the `client-to-client` configuration directive
    to the server configuration file and restarting the OpenVPN server, or it can
    be resolved by allowing tunnel traffic to be forwarded:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: When the first OpenVPN client tries to reach the second client, packets are
    sent to the server itself. The OpenVPN server does not know how to handle these
    packets and hands them off to the kernel. The kernel forwards the packets based
    on whether routing is enabled and whether the firewall rules (`iptables`) allow
    it. If not, then the packet is simply dropped and the second client is never reached.
  prefs: []
  type: TYPE_NORMAL
- en: 'By adding the following directive, the OpenVPN server process deals with the
    client-to-client traffic internally, bypassing the kernel forwarding, and the
    firewalling rules:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: The alternative solution, which is slightly more secure but also less scalable,
    is to properly set up routing in the Linux kernel.
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In a TAP-style network, the above `iptables` rule does not work. In a TAP-style
    network, all the clients are a part of the same broadcast domain. When the `client-to-client`
    directive is omitted and a client tries to reach another client, it first sends
    out `arp` who has messages to find out the MAC address of the other client. The
    OpenVPN server will ignore these requests and will also not forward them to other
    clients, regardless of whether an `iptables` rule is set or not. Hence, the clients
    cannot easily reach each other without the `client-to-client` directive, unless
    tricks like proxy-ARP are used.
  prefs: []
  type: TYPE_NORMAL
- en: See also
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The *Enabling client-to-client traffic* recipe, from [Chapter 3](part0038.xhtml#aid-147LC1
    "Chapter 3. Client-server Ethernet-style Networks"), *Client-server Ethernet-style
    Networks*, which explains how client-to-client traffic is set up in a TAP-style
    environment
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Understanding the MULTI: bad source warnings'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this recipe, we focus again on a VPN configuration where we try to connect
    a client-side LAN to a server-side LAN. Normally, this is done by adding a `client-config-dir`
    directive to the OpenVPN server configuration, and then by adding the appropriate
    CCD file. However, if the CCD file is not found or is not readable, then the VPN
    connection will function properly, but the hosts on the client-side LAN will not
    be able to reach the hosts on the server-side LAN and vice versa. In this case,
    the OpenVPN server log file will show messages of the form `MULTI: bad source`,
    if the verbosity is set high enough. In this recipe, we will first set up a VPN
    as is done in the *Routing: * *subnets on both sides* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    but with a missing CCD file for the client. Then, we will show how to trigger
    the `MULTI: bad source` warnings and what can be done to resolve the issue.'
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We use the following network layout:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting ready](img/image00392.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Set up the client and server certificates using the first recipe from the [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client was running Fedora 22 Linux and OpenVPN 2.3.11\.
    Keep the configuration file `example2-5-server.conf` from the *Using client-config-dir
    files* recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server
    IP-only Networks"), *Client-server IP-only Networks*. For the client, keep the
    configuration file `basic-udp-client.conf` from the *Server-side routing* recipe
    from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'First, make sure the client CCD file is not accessible:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE39]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Start the server using the configuration file `example2-5-server.conf` and
    with increased verbosity:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE40]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Next, start the client to connect successfully:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE41]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'However, when a host on the client-side LAN tries to reach a machine on the
    server-side LAN, the following message appears in the OpenVPN server log file:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE42]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: In this recipe, the root cause of the problem can be resolved as done in the
    *Troubleshooting client-config-dir issues* recipe from [Chapter 6](part0071.xhtml#aid-23MNU1
    "Chapter 6. Troubleshooting OpenVPN - Configurations"), *Troubleshooting OpenVPN
    - Configurations*, fix the permissions of the directory `/etc/openvpn/cookbook/clients`
    and reconnect the OpenVPN client.
  prefs: []
  type: TYPE_NORMAL
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In order to connect a remote LAN to an OpenVPN server, two server-configuration
    directives are needed:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: 'And also a CCD file containing the name of the client certificate. The CCD
    file contains:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: 'Without this, the OpenVPN server does not know which VPN client the remote
    network is connected to. If a packet comes in from a client that the OpenVPN server
    does not know about, then the packet is dropped and, with "verb 5" or higher,
    the warning `MULTI: bad source` is printed.'
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Apart from the warnings explained above, there is one other major reason for
    the `MULTI: bad source` messages to occur.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Other occurrences of the MULTI: bad source message'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Sometimes the `MULTI: bad source` message is printed in the OpenVPN server
    log file even when no client-side LAN is connected to the VPN client. This happens
    most often with VPN clients running Windows. When a file share is accessed over
    the VPN connection, Windows sometimes sends packets with a different source IP
    address to that of the VPN interface. These packets are not recognized by the
    OpenVPN server and the warning is printed. The solution to this issue is not known.'
  prefs: []
  type: TYPE_NORMAL
- en: See also
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The *Routing: subnets on both sides* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    which explains the basics of setting up a `client-config-dir` setup'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The *Troubleshooting client-config-dir issues* recipe from [Chapter 6](part0071.xhtml#aid-23MNU1
    "Chapter 6. Troubleshooting OpenVPN - Configurations"), *Troubleshooting OpenVPN
    - Configurations*, which goes deeper into some of the frequently made mistakes
    when using the `client-config-dir` directive
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Failure when redirecting the default gateway
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this recipe, we will troubleshoot an infrequent yet very persistent issue
    that can occur when setting up a VPN connection. When the `redirect-gateway` directive
    is used to redirect the default gateway on an OpenVPN client, it sometimes causes
    the client to lose all the Internet connections. This particularly occurs when
    the client machine on which OpenVPN is running is connected to the rest of the
    network or with the Internet using a PPP-based connection, such as PPPoE or PPPoA,
    especially, when using a GPRS/UMTS connections via a mobile phone.
  prefs: []
  type: TYPE_NORMAL
- en: When this occurs, OpenVPN sometimes is not capable of determining the default
    gateway before it is redirected. After the default gateway is redirected to the
    OpenVPN tunnel, the whole tunnel collapses on itself, as all the traffic, including
    the encrypted tunnel traffic itself, is redirected into the tunnel, causing the
    VPN to lock up.
  prefs: []
  type: TYPE_NORMAL
- en: This recipe will show how to detect this situation and what can be done about
    it. In this recipe, we will not use a GPRS/UMTS connection but we will use a PPP-over-SSH
    connection, which behaves in a similar fashion and is more readily available.
  prefs: []
  type: TYPE_NORMAL
- en: Getting ready
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We use the following network layout:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Getting ready](img/image00393.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Set up the client and server certificates using the first recipe from [Chapter
    2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only Networks"), *Client-server
    IP-only Networks*. For this recipe, the server computer was running CentOS 6 Linux
    and OpenVPN 2.3.11\. The client was running Fedora 22 Linux and OpenVPN 2.3.11\.
    Keep the configuration file `basic-udp-server.conf` from the *Server-side routing*
    recipe from [Chapter 2](part0025.xhtml#aid-NQU21 "Chapter 2.  Client-server IP-only
    Networks"), *Client-server IP-only Networks*.
  prefs: []
  type: TYPE_NORMAL
- en: Make sure the client is connected to the network using a PPP connection, as
    otherwise the issue described in the title of this recipe will not occur. For
    this recipe, a PPP-over-SSH connection and the default route was altered to point
    to the `ppp0` device.
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Start the server and add an extra parameter to direct the default gateway:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE45]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Create the client configuration file:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE46]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: Save it as `example7-9-client.conf`.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Check the system routes before starting the client:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE47]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Now, start the client:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE48]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'The connection will start but after a few seconds will stop and the log file
    will contain a warning message:'
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE49]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Check the system routes again:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE50]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The default gateway is now the VPN tunnel but the original route to the gateway
    is now gone.
  prefs: []
  type: TYPE_NORMAL
- en: 'All the connections on the client have stopped. What''s worse, when the OpenVPN
    client is aborted (by pressing **Ctrl** +**C** in the terminal window) the default
    route is not restored, as the OpenVPN process does not have the proper rights
    to do so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: The result is that the default gateway on the client machine is gone. The only
    solution is to reload the network adapter so that all the system defaults are
    restored.
  prefs: []
  type: TYPE_NORMAL
- en: 'The solution to the above problem is to use the following as is done in the
    *Redirecting the default gateway* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: How it works...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: When the OpenVPN client initializes, it always tries to create a direct route
    to the OpenVPN server via the existing system gateway. Under certain circumstances
    this fails, mostly due to an odd network configuration. It is seen most often
    when the default gateway is a dial-up or PPPoE connection, which is used in certain
    ADSL/VDSL setups and especially when using GPRS/UMTS connections.
  prefs: []
  type: TYPE_NORMAL
- en: When the OpenVPN client is instructed to redirect all the traffic over the VPN
    tunnel, it normally sends the encrypted VPN traffic itself over a direct link
    to the OpenVPN server. You can think of the encrypted VPN traffic as outside of
    the tunnel. However, when this direct route is missing, then this outside traffic
    is also sent into the tunnel, creating a tunneling loop from which the VPN can
    never recover.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the example used in this recipe, the situation is made worse by using the
    client configuration directive:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: 'This tells the OpenVPN process to drop all the privileges after starting. When
    the client is aborted because the tunnel is not functioning properly, the client
    is not capable of restoring the original gateway and the system is left in a non-functioning
    state:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: Only by adding a new default gateway can the network be restored.
  prefs: []
  type: TYPE_NORMAL
- en: 'The proper fix is to use:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: 'This will not overwrite the existing default gateway but will add two extra
    routes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: Both of which cover half the available network space. These two routes effectively
    replace the existing default route whilst not overwriting it.
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: This "biting your own tail" problem was much more common with older versions
    of OpenVPN. In current versions of OpenVPN, the detection of the default gateway
    was much improved and this problem now rarely occurs anymore. However, it is useful
    to see what happens when the problem does occur.
  prefs: []
  type: TYPE_NORMAL
- en: See also
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The *Redirecting the default gateway* recipe from [Chapter 2](part0025.xhtml#aid-NQU21
    "Chapter 2.  Client-server IP-only Networks"), *Client-server IP-only Networks*,
    which explains how to properly redirect all traffic via the VPN tunnel
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
