- en: '12'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Analyzing Compromised Cloud Productivity Suites
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The reality is that most cloud-based security incidents within an organization
    will occur at the productivity suite level. As we discussed in [*Chapter 7*](part0026_split_000.html#_idTextAnchor137),
    Microsoft 365 and Google Workspace are the most popular SaaS-based platforms in
    the industry. Organizations rely on Microsoft 365 and Google Workspace for business
    applications and services such as email, storage, office applications, and much
    more. Through the rise in the adoption of SaaS-based email solutions through Microsoft
    365 and Google Workspace by corporations, these platforms have become a prime
    target for business email compromise attacks. Since these email accounts are integrally
    linked to other services within 365 and Workspace, such compromises also pose
    a risk to any additional service connected to the user’s account, amplifying the
    potential for broader security breaches and a larger impact.
  prefs: []
  type: TYPE_NORMAL
- en: 'This chapter will dive into the details of compromised productivity suites,
    specifically Microsoft 365 and Google Workspace, from start to finish. We will
    discuss the following topics in this chapter:'
  prefs: []
  type: TYPE_NORMAL
- en: Business email compromise explained
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Initial scoping and remediation steps
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Microsoft 365 incident response
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Google Workspace incident response
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Business email compromise explained
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '**Business email compromise** (**BEC**) is a sophisticated type of cyber fraud
    targeting organizations through deceptive practices involving email communications.
    This threat exploits the reliance of businesses on email for corporate correspondence,
    manipulating trust and authority to execute some sort of unauthorized fund transfers,
    obtain sensitive information, or move laterally into the IT network.'
  prefs: []
  type: TYPE_NORMAL
- en: BEC attack phases
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'The phases that attackers utilize to conduct BEC attacks are demonstrated in
    *Figure 12**.1*:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.1 – BEC attack phases](img/00040.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.1 – BEC attack phases
  prefs: []
  type: TYPE_NORMAL
- en: 'Having observed the stages outlined in the figure, let’s dive into each phase
    with a detailed breakdown:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Reconnaissance**: In this phase, attackers meticulously study the victim
    organization’s hierarchy, communication patterns, and specific jargon used. If
    an attacker has access to an account already, they simply run searches within
    the email system to understand communication patterns and jargon at the organization.
    Otherwise, the attacker utilizes information that may be public about the company
    from various sources, such as LinkedIn and the victim organization’s website.
    Attackers may use publicly available information, social engineering tactics,
    or even previous data breaches to collect data. This reconnaissance phase allows
    them to craft convincing emails mimicking users from inside the organization and
    spoof or target specific accounts of interest.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: BEC attacks are typically not random mass mailings but are directed at specific
    individuals within an organization, such as those with authority over finances
    or access to confidential data. As an example, the CFO of an organization is commonly
    targeted as they not only have access to confidential financial information, but
    they have the authority to approve transactions at the organization.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Email spoofing or account takeover**: Attackers either spoof a legitimate
    email address or gain unauthorized access to a legitimate account, often through
    phishing attacks or exploiting weak security practices.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Attackers frequently create “fake” websites that appear to look the same as
    the login pages of popular productivity suites (Microsoft 365 or Google Workspace).
    They achieve this by manipulating HTML and CSS to replicate the styling of these
    legitimate sites. The domains of these fake sites are often slightly altered versions
    of the real ones, designed to appear as if they belong to the organization’s productivity
    suite tenant. For example, a fake domain for Microsoft 365 could be `microsoft365-login.com`
    instead of the legitimate `microsoft.com`, and for Google Workspace, it might
    be `googledocs-signin.com` instead of `google.com`. These fraudulent pages usually
    consist of forms designed to harvest and send back user credentials to the attackers.
    Unsuspecting users who enter their login details on these fake pages unintentionally
    provide attackers with access to their personal or corporate accounts, leading
    to account compromise.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: If attackers cannot gain access to accounts in the organization, they typically
    purchase domains that appear to be very similar to the organization instead. As
    an example, instead of `ACME.com`, `AMCE.com` is purchased from domain registrars
    so that the attacker can also create email accounts sharing domains that closely
    resemble legitimate user emails at the victim organization. As an example, `Alice@AMCE.com`
    would be set up and used by attackers to mimic a legitimate user and account for
    Alice from ACME. Most users would not catch the subtle change in the domain from
    ACME to AMCE in their email correspondence.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Preparation**: In this phase, the attacker prepares the tools and methods
    they will use to execute the attack. This could include crafting convincing phishing
    emails, creating fake invoices, or setting up bank accounts for receiving fraudulent
    payments. This is based on their objective and the type of BEC, which we will
    discuss in the next section.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Exploitation**: In this stage, the victim interacts with the email, leading
    to the attacker’s desired outcome. For BEC, this often means complying with the
    instructions in the email, such as transferring funds or providing confidential
    information.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Malware installation (if applicable)**: While not always a part of BEC, in
    some cases, the attacker might use the opportunity to install malware on the victim’s
    system. This can be for long-term access, data exfiltration, or to facilitate
    further attacks. This is how attackers can pivot from the productivity suite account
    hosted and protected in the cloud to actual devices in the organization’s IT network.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Actions on objectives**: The ultimate goal of the attacker is realized in
    this stage. For BEC, this usually involves the unauthorized transfer of funds
    to the attacker’s account or the acquisition of sensitive information. The attacker’s
    objectives are achieved once they receive the funds or information they were seeking.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Persistence and anti-forensics (if applicable)**: In sophisticated BEC schemes,
    attackers might try to maintain access to the victim’s systems for future attacks
    or to hide evidence of their activities. This might involve setting up auto-forwarding
    rules outside the network, deletion of email evidence, creating backdoors in terms
    of application consents, or using other techniques to conceal their presence.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Common types of BECs
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Now that we’ve explored the various phases of a BEC attack, let’s discuss the
    common types of BECs that organizations frequently encounter:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Invoice fraud**: The scammer pretends to be a supplier or vendor of the target
    company, requesting payment for services or goods to a fraudulent account.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**C-suite fraud**: Attackers pose as the company’s CEO or any high-ranking
    executive and send emails to employees, usually in the finance department, instructing
    them to transfer funds to an account controlled by the attacker.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Attorney impersonation**: Attackers pose as a lawyer or legal representative
    involved with the company, often under the guise of urgent and confidential matters,
    to misdirect funds or gain sensitive information.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Data theft**: Here, the objective is not necessarily immediate financial
    gain but the theft of sensitive data, which could be employee tax information,
    intellectual property, or customer data.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Account compromise**: An employee’s email account is hacked and then used
    to request payments from vendors listed in their email contacts.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Credentials harvesting**: An employee’s email account is hacked and then
    used to further harvest more credentials from outside the organization to trusted
    contracts and vendors.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Motive for attackers**: The primary motivation behind BEC attacks is financial
    gain. Attackers exploit the trust within business communication channels to divert
    funds or obtain sensitive information that can be monetized. Additionally, the
    data harvested from such attacks, such as credentials and employee personal information
    or intellectual property, can be sold on the dark web or used for further attacks,
    including repeat BEC attacks and ransomware. The sophisticated and targeted nature
    of these attacks often leads to a higher success rate and potentially greater
    financial rewards for the attackers, making BEC a lucrative form of cybercrime.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A deep understanding of the varied BEC attack types, from invoice fraud to data
    theft, is essential for effective defense against these sophisticated and financially
    motivated cyber threats. Identifying types of BEC allows both technical and business
    controls to prevent these incidents. For example, organizations can implement
    controls to verbally verify transaction approvals over a set amount to prevent
    invoice and C-suite fraud.
  prefs: []
  type: TYPE_NORMAL
- en: Initial scoping and response
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'When responding to a BEC attack as an incident responder, the **initial scoping
    phase** is critical for understanding the breadth and depth of the incident. This
    phase involves gathering as much information as possible to assess the situation
    accurately. This initial scoping involves talking with the cloud productivity
    suite (Microsoft 365 or Google Workspace) IT administrators, organization general
    counsel, C-suite, and accounting staff to better understand the following, even
    before any technical forensic analysis:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Timeline of the attack**: Understanding when the attack started is crucial.
    Ask when the first signs of compromise were noticed and at what point users noticed
    anything suspicious. This could include unusual email activity, reports of suspicious
    emails from within or outside the organization, or financial transactions that
    were flagged as anomalous. If attackers were successful in transferring any unauthorized
    funds, note these dates in the timeline.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Extent of the compromise**: Determine which accounts have been compromised.
    This involves checking for signs of unauthorized access, such as login attempts
    from unfamiliar locations or devices, and changes in account settings or permissions
    that were not initiated by the account owners. If attackers were successful, IT
    administrators for the productivity suites would have already narrowed down on
    the accounts of interest. We will discuss how to determine evidence of compromise
    in the *Microsoft 365 incident response* and *Google Workspace incident* *response*
    sections.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Attack vectors**: Investigate how the attackers gained access. Was it through
    phishing emails, credential stuffing, or exploiting security vulnerabilities?
    Understanding the attack vector is essential for preventing future breaches. In
    some instances, users can recall at what points they may have entered their credentials
    to a phishing site. Furthermore, have the organization and/or individual users
    suffered a data breach in the past? If so, their username and credentials could
    be circulating on the dark web. It is not uncommon for employees to use their
    corporate email addresses for personal services. If those personal services suffer
    a data breach, the employee’s corporate information may be exposed.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Data exfiltration**: Assess what information has been accessed or exfiltrated.
    This includes sensitive emails, attachments, and any data stored in the compromised
    accounts. Knowing the type of data exposed helps in understanding the potential
    impact of the breach.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Communication with affected parties**: Determine who has been affected by
    the breach, both internally and externally. This might include employees, customers,
    or business partners who have communicated with the compromised accounts.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Security measures in place**: Review the existing security measures. Were
    there any security protocols that were bypassed or ineffective? This could include
    multi-factor authentication, regular password changes, and employee training on
    recognizing phishing attempts.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Previous incidents**: Inquire if there have been previous similar incidents.
    Understanding past incidents can provide insights into potential weaknesses or
    repeated patterns of attacks. It has become much more common for repeat attacks,
    especially if attackers were successful in diverting funds in the past. They may
    see an organization as an easy repeat target.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Current response actions**: Check what actions have already been taken in
    response to the discovery of the attack. This can include changing passwords,
    disconnecting potentially compromised systems from the network, or notifying affected
    individuals.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Microsoft 365 access**: This is the most important step to actually kick
    off the response and investigation as an incident responder. You will require
    the organization’s Microsoft 365 administrator to create an account in their 365
    tenant with the following roles. For the most part, the accesses required to respond
    to a 365 compromise are as follows:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Azure AD:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Global reader
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Security reader
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Exchange online admin, a custom role with the following permissions:'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Mail recipients
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Security group creation and memberships
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: View only audit log
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: View only configuration
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: View only recipients
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Microsoft Purview (compliance):'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Compliance administrator
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: eDiscovery manager
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: These role names are likely to change within the Microsoft ecosystem; however,
    the key here is that you will require some sort of global reader or security reader
    role to allow you to run searches in the audit logs.
  prefs: []
  type: TYPE_NORMAL
- en: The initial scoping phase sets the stage for effective incident response by
    providing a clear picture of the attack. Next, we will dive a bit deeper into
    triaging and forensics for Microsoft 365 and Google Workspace.
  prefs: []
  type: TYPE_NORMAL
- en: Remediation steps
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'During the initial scoping of the incident, regardless of whether it’s Microsoft
    365 or Google Workspace, there are several steps that the organization can follow
    to ensure that the attacker is no longer in their environment prior to incident
    responders starting forensics. User interfaces and productivity suites change;
    however, the following steps are always relevant:'
  prefs: []
  type: TYPE_NORMAL
- en: Reset the passwords of any accounts that were impacted or are suspected to be
    compromised.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Enable **multi-factor authentication** (**MFA**) organization-wide or, at the
    very least, for privileged accounts.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Remove any suspicious automation (i.e., email forwarding rules outside of the
    domain) and any suspicious inbox rules set inside the mailbox. We will discuss
    this further in the upcoming section.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Remove compromised accounts from any privileged or elevated role at the organization.
    For example, compromised accounts belonging to IT administrators should temporarily
    have their accesses limited to prevent further unauthorized activities.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Despite any changes in productivity suites such as Microsoft 365 or Google Workspace,
    these high-level steps, including password resets and access limitations, are
    universally applicable and crucial for safeguarding against cyber threats in a
    productivity suite environment. The product’s UI and details may change; however,
    the steps remain the same.
  prefs: []
  type: TYPE_NORMAL
- en: Microsoft 365 incident response
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: After the initial scoping to understand the incident, the next step is to determine
    indicators of compromise and begin the threat hunt. This section delves into the
    tools and techniques that incident responders can employ to automate the log acquisition
    and analysis process, specifically to an organization that is utilizing Microsoft
    365 as their cloud productivity suite. A key focus is on utilizing Microsoft 365’s
    built-in security and compliance tools, such as Microsoft Purview, to rapidly
    gather logs and track suspicious activities.
  prefs: []
  type: TYPE_NORMAL
- en: Tooling
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In [*Chapter 7*](part0026_split_000.html#_idTextAnchor137), we discussed the
    various auditing and compliance features in Microsoft 365, one of which was Microsoft
    unified audit logs. These logs provide a consolidated view of all Microsoft 365
    activity and are critical for investigating and understanding the extent of the
    compromise. Here’s how incident responders can leverage the audit log search GUI
    in Microsoft 365 for this purpose:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Accessing the audit log search**: The audit log search is accessible through
    Microsoft Purview. Incident responders need to navigate to the **Audit** section
    to begin.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Scoping the incident**: Before running a search, it’s crucial to complete
    the initial scoping of the incident, as we discussed in the previous section.
    This is because the initial scoping involves understanding the timeline of the
    incident, the suspected compromised accounts, and the nature of the activities
    that are of interest. This initial scoping helps in applying the right filters.
    Otherwise, incident responders will have to run general searches, which may take
    a while to execute and can be difficult to quickly analyze and triage afterward.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Apply filters**: The audit log search provides various filters to narrow
    down the search results:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Date and time**: Specify the time frame for the incident'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Activities**: Filter by specific activities, such as file accesses, user
    logins, and administrative actions'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Users**: Focus the search on specific user accounts that are suspected to
    be compromised'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**File, folder, and site**: Narrow down to specific files, folders, or SharePoint
    sites if relevant'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Running the search**: After applying the necessary filters, run the search.
    The GUI will display a list of events that match the criteria. Either classic
    or new searches can be used; however, note that classic searches will not save
    the history of the searches you conduct. Furthermore, classic searches are limited
    to only running concurrent search jobs.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Exporting logs for detailed analysis**: For a more in-depth analysis, users
    can export the search results to a CSV file. This allows for additional analysis
    using external tools for archiving purposes. The exported data includes detailed
    information about each event, such as the source IP address, user agent, and the
    exact operations performed.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: Exporting results through the audit search user interface is limited to only
    10,0000 entries. As a result, it’s important to ensure that your search results
    are refined under 10,000 or search jobs are broken down into multiple batches
    to ensure all entries are exported.
  prefs: []
  type: TYPE_NORMAL
- en: '**Utilizing external tools**: Once the logs are exported, incident responders
    can utilize various data analysis tools to sift through the data. Tools such as
    Excel, Power BI, or specialized forensic tools can be used to analyze patterns,
    create timelines, and correlate events across different logs.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Analyzing results**: Examine the results to identify any unusual or unauthorized
    activities. Look for patterns or anomalies that could indicate malicious behavior.
    We will discuss analysis further in the next section.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Searching for and extracting 365 audit logs
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The following figures demonstrate how to run searches and extract the audit
    logs in CSV:'
  prefs: []
  type: TYPE_NORMAL
- en: 'The following screenshot demonstrates the audit log search tab with available
    filters to further refine queries:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 12.2 – Microsoft 365 Audit search log tab](img/00057.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.2 – Microsoft 365 Audit search log tab
  prefs: []
  type: TYPE_NORMAL
- en: 'Search jobs are created on execution and listed below the audit log filters,
    as demonstrated:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 12.3 – Audit log search jobs](img/00075.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.3 – Audit log search jobs
  prefs: []
  type: TYPE_NORMAL
- en: 'Once search jobs are completed, results are organized in a table, as shown:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 12.4 – Audit log search results (UI)](img/00095.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.4 – Audit log search results (UI)
  prefs: []
  type: TYPE_NORMAL
- en: 'The next figure is an example of successful login and failed login events:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 12.5 – Audit log search results – login events](img/00116.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.5 – Audit log search results – login events
  prefs: []
  type: TYPE_NORMAL
- en: 'The following figure demonstrates an example of an event’s **Details** pane:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 12.6 – Audit log event details](img/00139.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.6 – Audit log event details
  prefs: []
  type: TYPE_NORMAL
- en: 'All search results can be exported as a CSV file, as shown:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '![Figure 12.7 – Audit log export process](img/00155.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.7 – Audit log export process
  prefs: []
  type: TYPE_NORMAL
- en: 'The resulting file is a CSV file; however, the majority of the fields will
    be stored in the `AuditData` column in the JSON format. The exported CSV is as
    follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.8 – Audit log export (CSV)](img/00173.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.8 – Audit log export (CSV)
  prefs: []
  type: TYPE_NORMAL
- en: Extracting audit logs using PowerShell
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'The unified audit logs can also be programmatically extracted using PowerShell:'
  prefs: []
  type: TYPE_NORMAL
- en: Open PowerShell as an administrator and navigate to your folder of choosing;
    for example, `C:\Incident Response\`.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Connect to the Microsoft 365 tenant with the following commands:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Define a log time range (modify as needed; here, we will start with 30 days):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: $AuditLogs = Search-UnifiedAuditLog -StartDate $StartDate -EndDate $EndDate
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Export the log as a CSV:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Release the 365 session (i.e., disconnect):'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: The resulting CSV will be very similar to the export generated through the user
    interface in *Figure 12**.8*.
  prefs: []
  type: TYPE_NORMAL
- en: Utilizing Microsoft Power Query
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Whether exported through the Purview user interface or programmatically, a large
    amount of the data and useful fields will be stored in JSON. As a result, incident
    responders must complete the additional step of parsing this data for it to be
    useful (or easily searchable). Incident responders can utilize a JSON parsing
    tool of their choice, but in this example, we will utilize Microsoft Power Query.
    Power Query can be employed to drill down into the bulk of JSON data. The process
    involves importing the CSV file into Excel and then using Power Query’s advanced
    data transformation capabilities to parse the JSON fields. This parsing translates
    the JSON data into a structured format that aligns with the traditional columns
    and rows of Excel. Users can expand the JSON fields into individual columns, making
    the data more accessible and easier to analyze. This transformation is crucial
    for incident responders who need to dissect and understand intricate details of
    user activities, security events, and system changes logged in the audit data
    column. By leveraging Microsoft’s Power Query, organizations can efficiently convert
    the complex JSON data into a more manageable and analyzable format.
  prefs: []
  type: TYPE_NORMAL
- en: 'The steps to utilize Microsoft Power Query are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Starting with the unified audit log CSV, our next step is to create a new workbook
    in Microsoft Excel:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 12.9 – Audit log results to be transformed](img/00191.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.9 – Audit log results to be transformed
  prefs: []
  type: TYPE_NORMAL
- en: 'Create a new workbook:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 12.10 – New Excel workbook](img/00010.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.10 – New Excel workbook
  prefs: []
  type: TYPE_NORMAL
- en: Next, you will need to navigate to the **Data** tab and click on **Get Data**
    | **From File** | **From Text/CSV**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 12.11 – Importing the audit data export](img/00029.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.11 – Importing the audit data export
  prefs: []
  type: TYPE_NORMAL
- en: Next, you will import the unified audit log CSV and click `AuditData` column,
    which contains the JSON. Note that Power Query is limited to the maximum number
    of rows filled to a worksheet (i.e., 1,048,576).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 12.12 – Power Query options to load data](img/00047.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.12 – Power Query options to load data
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, audit data is transformed using the **Transform Data** option. The results
    are shown in the next figure:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 12.13 – Power Query results](img/00063.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.13 – Power Query results
  prefs: []
  type: TYPE_NORMAL
- en: Next, right-click on the `AuditData` column and click on **Transform** | **JSON**.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Figure 12.14 – Transforming the JSON data column](img/00082.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.14 – Transforming the JSON data column
  prefs: []
  type: TYPE_NORMAL
- en: 'As shown next, your JSON data has now been transformed into CSV columns (for
    example, `AuditData.ClientIP`):'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.15 – Resulting CSV column](img/00101.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.15 – Resulting CSV column
  prefs: []
  type: TYPE_NORMAL
- en: 'The following figure demonstrates the resulting data after the column has been
    transformed in Power Query:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.16 – Expanding the transformed column](img/00123.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.16 – Expanding the transformed column
  prefs: []
  type: TYPE_NORMAL
- en: The result is a CSV file with all your audit data in a friendly, readable format
    to utilize Excel (or the tool of your choice) for further analysis.
  prefs: []
  type: TYPE_NORMAL
- en: Cloud forensics using HAWK
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Incident responders can also utilize some open source tools based on the Microsoft
    365 API, such as HAWK (Github.com/T0pCyber/hawk).
  prefs: []
  type: TYPE_NORMAL
- en: '**HAWK** is a PowerShell-based tool for gathering information related to Microsoft
    365 compromises. It searches and parses out a lot of useful information specific
    to a 365 compromise from the 365 configuration and the audit logs, such as the
    creation of new inbox rules, consent grants, a list of all users with administrator
    access, and much more. This simplifies the incident response process, as incident
    responders can find all information in their respective CSV as opposed to navigating
    to configurations in 365 or extracting it manually through the audit logs.'
  prefs: []
  type: TYPE_NORMAL
- en: Important Note
  prefs: []
  type: TYPE_NORMAL
- en: 'The HAWK tool can be found on GitHub:'
  prefs: []
  type: TYPE_NORMAL
- en: '[https://github.com/T0pCyber/hawk](https://github.com/T0pCyber/hawk)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the HAWK Module PowerShell Gallery download:'
  prefs: []
  type: TYPE_NORMAL
- en: '[https://www.powershellgallery.com/packages/HAWK/3.1.0](https://www.powershellgallery.com/packages/HAWK/3.1.0)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is the HAWK documentation:'
  prefs: []
  type: TYPE_NORMAL
- en: '[https://cloudforensicator.com/](https://cloudforensicator.com/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'To run HAWK, you require PowerShell on your system with administrator rights
    and an internet connection:'
  prefs: []
  type: TYPE_NORMAL
- en: Open PowerShell as an administrator and navigate to the `C:\Incident Response\`
    folder using the `cd` command.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Install the HAWK module:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Install and import the Microsoft 365 Exchange Online management module and
    the Microsoft 365 module:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Log in to the impacted 365 tenant with the following commands and authenticate
    with your Microsoft 365 username and password:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'Run the HAWK tool:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs:
  - PREF_IND
  type: TYPE_PRE
- en: 'An example of the resulting files is shown in the following figure:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.17 – HAWK results](img/00144.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.17 – HAWK results
  prefs: []
  type: TYPE_NORMAL
- en: As mentioned in HAWK’s GitHub, HAWK is designed to quickly get incident responders
    the data they need. It is not meant to complete the analysis for you. A full breakdown
    of all generated log files can be found on the HAWK documentation page.
  prefs: []
  type: TYPE_NORMAL
- en: Analysis
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The goal of our analysis is to identify any evidence of compromise. The very
    first piece of analysis to be conducted is determining evidence of unauthorized
    access. This is best determined by identifying login events by using the `Activity`
    or `Operation` column in the unified audit logs in Microsoft 365\. This column
    records the specific action that has been performed within the environment. In
    essence, it serves as a detailed ledger of activities, ranging from file access
    and sharing to administrative changes and login events. Each entry in the `Operation`
    column is tagged with a descriptive label that identifies the nature of the action,
    making it a valuable resource for incident responders.
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: All audited activities (i.e., operations) can be found in Microsoft’s documentation
    at [https://learn.microsoft.com/en-us/purview/audit-log-activities](https://learn.microsoft.com/en-us/purview/audit-log-activities).
  prefs: []
  type: TYPE_NORMAL
- en: The first step to determine compromise is filtering for `UserLoggedIn` events,
    which is essential for monitoring and investigating unauthorized access. By analyzing
    these events, incident responders can track when and how users log into the system,
    providing crucial insights into threat actor behavior.
  prefs: []
  type: TYPE_NORMAL
- en: For instance, an unusual pattern of login activities, such as logins at unusual
    hours or from unexpected locations, can be early indicators of unauthorized access.
    This will allow incident responders to determine any indicators related to the
    compromise, such as login user agent strings and IP addresses.
  prefs: []
  type: TYPE_NORMAL
- en: 'The strongest indicator in terms of login activity will not be analyzing unusual
    login times but analyzing the location of IPs associated with the login events.
    This can be done by filtering the unified audit logs by the `UserLoggedIn` events
    and looking up the associated IP addresses (the `ClientIP` field in `AuditData`)
    with any bulk IP address lookup software (such as `ipinfo.io`). See *Figure 12**.18*
    and *Figure 12**.19* for an example of this:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.18 – Client IP audit data](img/00161.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.18 – Client IP audit data
  prefs: []
  type: TYPE_NORMAL
- en: These IPs can be copied to a lookup IP service that will give you the specific
    cities, regions, and countries associated with each IP. For example, looking up
    one of the IPs starting with `69` on IPinfo provides information stating that
    the user had logged in from an IP based in Minnesota, USA.
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.19 – IPInfo.io lookup results](img/00180.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.19 – IPInfo.io lookup results
  prefs: []
  type: TYPE_NORMAL
- en: The geographical information can be exported from your geo IP lookup service
    of choice and compared against all users in your audit log. As an incident responder,
    your next step is to determine whether the geographic location aligns with the
    organization’s business operations or if the user was confirmed in the IP’s location
    on that date. If the user had not traveled to the location, the user account can
    be deemed compromised. Incident responders can also analyze other pieces of the
    IP information, such as VPN/proxy use, or see if the hosting provider does not
    align with the user’s normal (baseline) IP address.
  prefs: []
  type: TYPE_NORMAL
- en: 'Continuing from analyzing unusual login locations, another key threat-hunting
    task for incident responders is checking for changes in mailbox rules. **Mailbox
    rules** are automatic actions triggered by incoming emails. If attackers get into
    a user’s account, they can secretly make or change rules. These unauthorized rules
    might redirect emails to other accounts, delete specific messages, or manage phishing
    emails to avoid being caught. The key operations to focus on are as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**New-InboxRule**: This operation is logged when a new mailbox rule is created.
    Incident responders should scrutinize any instance of this operation, paying close
    attention to rules that forward emails to external domains, automatically delete
    messages, or sort emails in a suspicious manner. A sudden increase in the creation
    of new rules, especially those with unusual criteria, should raise an alert.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Set-InboxRule**: This indicates modifications to existing mailbox rules.
    Alterations to established rules, especially those that change the rule’s action
    or condition, can be a sign of an attacker trying to manipulate email flow subtly.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Remove-InboxRule**: The deletion of mailbox rules is captured under this
    operation. While it might seem benign, the removal of certain rules, particularly
    security-related ones, can be a tactic used by attackers to reduce detection of
    their activities.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**New-TransportRule and Set-TransportRule**: These operations are associated
    with the creation and modification of transport rules, which are more complex
    and can control email flow at the organizational level. Unauthorized changes here
    could have widespread implications.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'For example, the next screenshot is from a compromised 365 incident where threat
    actors had created a new inbox rule called `zz`. This inbox rule automatically
    deletes any emails that contain the following words in the subject line or body:
    “scam”, “fraud”, “phish”, and an email address that has been sanitized for privacy
    reasons. This is because the attacker is trying to cover their tracks such that
    any emails or warnings from others related to their objective, that is, to “scam”
    or “fraud” the organization out of money, will be automatically deleted, and as
    a result, the threat attacker can complete their attack unnoticed.'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.20 – Example malicious inbox rule](img/00199.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.20 – Example malicious inbox rule
  prefs: []
  type: TYPE_NORMAL
- en: In addition to monitoring these specific operations, correlating this information
    with other login data, such as login locations and times, can provide a more comprehensive
    picture of the attacker’s activities. For example, the creation of a new inbox
    rule immediately following a login from an unusual geographic location can be
    a strong indicator of a compromised account.
  prefs: []
  type: TYPE_NORMAL
- en: 'When addressing the issue of data exfiltration in Microsoft 365 compromises,
    incident responders need to focus on specific operations within the audit logs
    that can indicate unauthorized data movement or access. Data exfiltration can
    occur in various ways, such as through Outlook synchronization, accessing data
    via a web browser, or other activities. Understanding these nuances is vital for
    identifying potential breaches:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Outlook client synchronization (via SyncFolderItems operation)**: This operation
    is logged when a user’s Outlook client syncs with the mailbox. Excessive or unusual
    sync activities, especially from unfamiliar devices or locations, can indicate
    that someone is trying to download a large amount of data. Comparing the volume
    and frequency of these sync operations against typical user behavior can reveal
    anomalies.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`MailItemsAccessed` events, especially from attacker IP addresses, suggests
    not only unauthorized access but that the threat actors viewed the contents of
    those mail items.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`FileDownloaded`, `FileCopied`, `FileMoved`, and `FileDeleted` within SharePoint
    or OneDrive for Business are key indicators. These actions, particularly in high
    volumes or from atypical locations, can signal that someone is exfiltrating data.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Email forwarding rules (New-InboxRule, Set-InboxRule)**: As with mailbox
    compromises, the creation or modification of inbox rules that automatically forward
    emails to external addresses can be a method of data exfiltration.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**eDiscovery search and export operations (SearchQueryInitiated, SearchQueryPerformed,
    ExportStarted)**: These operations indicate that someone is performing searches
    and possibly exporting data from eDiscovery, which can be a sophisticated way
    of extracting large datasets for malicious purposes.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Unusual sending patterns (Send and SendAs operations)**: A spike in email
    sending activities, especially those with large attachments or sent to external
    recipients, might indicate an attempt to exfiltrate data via email.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: All mailbox audited activities (i.e., operations) can be found in Microsoft’s
    documentation at [https://learn.microsoft.com/en-us/purview/audit-mailboxes](https://learn.microsoft.com/en-us/purview/audit-mailboxes).
  prefs: []
  type: TYPE_NORMAL
- en: One of the key questions that organizations must answer during a productivity
    suite breach is whether data was exfiltrated by attackers. Analyzing the outlined
    operations will allow incident responders to better understand the scope of the
    incident from a data breach perspective.
  prefs: []
  type: TYPE_NORMAL
- en: 'Incident responders should also consider reviewing the following valuable sources
    of information in the context of a 365 compromise:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Impersonation rights**: These rights allow a user to perform actions on behalf
    of another user. Incident responders should check for unexpected or unauthorized
    assignments of impersonation rights. This can be done by reviewing the role assignments
    for each user.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**List of Azure Active Directory administrators**: Reviewing the current Azure
    **Active Directory** (**AD**) administrators is important. You can view this list
    in the Azure AD admin center. Look for any unfamiliar accounts or changes in administrator
    roles, as attackers can elevate privileges to gain wider access in a 365 compromise.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**List of Azure AD users**: Incident responders should audit a list of all
    users in Azure AD. Pay special attention to newly created users, especially those
    with high privileges. Check this list through the Azure AD admin center. Unexpected
    user accounts can be a sign that an attacker has created backdoors.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Consent grants**: These are permissions granted to applications to access
    user data. Review the consent grants in the Azure AD admin center for any unusual
    or broad permissions granted to unknown or suspicious applications. Excessive
    permissions can be abused for data access and exfiltration.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**eDiscovery roles**: Users with eDiscovery roles can search and export content
    from mailboxes and sites. Check who has been assigned these roles in Microsoft
    Purview. Though unlikely, unauthorized eDiscovery role assignments can indicate
    an attempt to illicitly access and export sensitive data.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Exchange online administrators**: It’s important to regularly review who
    has administrative privileges in Exchange Online, as these accounts have significant
    control over email operations. Check for any unexpected changes or additions in
    the Exchange admin center.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Transport rules (mail flow)**: These are rules set up in Exchange Online
    to control mail flow. Review the transport rules for any that redirect or copy
    emails to external domains, which can be a method of data exfiltration.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: All of these sources for analysis can be reviewed by the CSVs that are generated
    by the HAWK tool, as demonstrated in *Figure 12**.17*.
  prefs: []
  type: TYPE_NORMAL
- en: Google Workspace incident response
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: After understanding the basics of an incident as we have discussed in the *Initial
    scoping and response* section, incident responders using Google Workspace face
    the challenge of identifying compromises and starting threat hunting. **Google
    Workspace**, unlike Microsoft 365, offers fewer tools for this purpose, focusing
    mainly on its audit and reporting features. These tools, while not as extensive,
    are crucial for collecting logs and spotting unusual activities. This means responders
    often need to supplement these tools with external resources and more hands-on
    analysis to effectively track and investigate potential security breaches in Google
    Workspace environments.
  prefs: []
  type: TYPE_NORMAL
- en: Tooling
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In a similar vein to our discussion on Microsoft 365, let’s explore how incident
    responders can leverage audit logs in Google Workspace to investigate and understand
    the extent of compromises:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Accessing the audit logs**: In Google Workspace, the audit logs are accessible
    through the Admin console. Incident responders can find these logs by navigating
    to the **Reports** section and then to the **Audit** subsection.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: As with Microsoft 365, the initial step involves understanding the incident’s
    timeline, identifying potentially compromised accounts, and determining the nature
    of suspicious activities. This understanding helps to apply the right filters
    in the audit logs, making the search more efficient and focused.
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '**Applying filters in audit log search**: Google Workspace’s audit log search
    offers various filters to refine searches:'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Date and time**: Set the specific time frame of interest'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Events**: Choose from a range of activities, such as email sent, file shared,
    admin activity, and more'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Users**: Focus on specific user accounts under suspicion'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Applications**: Filter by specific Google Workspace applications, such as
    Gmail, Drive, and Calendar, if relevant'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Running the search**: After setting the filters, run the search. The results
    will display a list of events that fit the criteria, which can then be reviewed
    for any suspicious activity.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Exporting logs for analysis**: Google Workspace allows the exporting of search
    results for more detailed analysis. These exports can include comprehensive event
    information such as IP addresses, actions taken, and affected resources.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Utilizing external tools for analysis**: Once exported, the logs can be further
    analyzed using tools such as Excel or other data analysis software. This step
    is crucial for spotting patterns, creating timelines, and correlating events across
    different logs.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Analyzing results**: Carefully examine the audit log entries for unusual
    or unauthorized activities. Look for anomalies or patterns that could suggest
    malicious behavior, such as mass file downloads, unusual login times, or unexpected
    external sharing of documents. This is further discussed in the upcoming *Analysis*
    section.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: Similar to Microsoft 365, exporting results from Google Workspace audit logs
    may have limitations in terms of the number of entries that one can export. It’s
    important to ensure that your search is precise enough to capture all relevant
    data without exceeding these limits (typically 100,000 entries).
  prefs: []
  type: TYPE_NORMAL
- en: Searching and extracting Google Workspace logs
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'As discussed in [*Chapter 7*](part0026_split_000.html#_idTextAnchor137), Google
    Workspace provides a range of audit logs, each tailored to different applications
    and activities. Key logs include the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Admin activity logs**: Track administrative actions such as changes to settings
    or user management'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Login logs**: Monitor user sign-in attempts, successful or otherwise, which
    is crucial for identifying unauthorized access attempts'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Drive audit logs**: Essential for tracking file sharing and access within
    Google Drive'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Gmail logs**: Monitor for unusual email activities, such as mass deletions
    or forwarding rules'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'To export the Google Workspace’s audit logs, incident responders can follow
    these steps:'
  prefs: []
  type: TYPE_NORMAL
- en: In the Google Workspace admin console (`admin.google.com`), go to **Reports**
    and then **Audit** **and Investigations.**
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Choose the specific audit log (e.g., admin log events, user log events, and
    group log events).
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Apply the necessary filters and run the search.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the results are displayed, use the **Download** or **Export** option to
    save the data for further analysis.
  prefs: []
  type: TYPE_NORMAL
- en: The exported logs can be in the CSV format, making it easier to import into
    data analysis tools. When using tools such as Excel, responders can sort, filter,
    and use functions to analyze the data more effectively.
  prefs: []
  type: TYPE_NORMAL
- en: 'The following figures demonstrate the steps to export the audit events. Start
    by navigating to the **Reporting** and then going to the **Audit and investigation**
    tab, as shown:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.21 – Reporting tab](img/00016.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.21 – Reporting tab
  prefs: []
  type: TYPE_NORMAL
- en: 'The following screenshot demonstrates all available logs under the **Audit
    and investigation** tab in the Google Workspace administrative console:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.22 – Audit and investigations](img/00035.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.22 – Audit and investigations
  prefs: []
  type: TYPE_NORMAL
- en: 'Similar to Microsoft 365 audit log searches, filters can be set, as shown in
    this figure:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.23 – User events](img/00052.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.23 – User events
  prefs: []
  type: TYPE_NORMAL
- en: 'An example of the exported data is shown here:'
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 12.24 – Exported user events](img/00070.jpeg)'
  prefs: []
  type: TYPE_IMG
- en: Figure 12.24 – Exported user events
  prefs: []
  type: TYPE_NORMAL
- en: Next, we will dive into the analysis portion of a Google Workspace compromise.
    A similar process to the Microsoft 365 analysis is to be followed for Google Workspace
    with a difference in audit logs and their syntax. The principles of verifying
    unusual logins remain the same.
  prefs: []
  type: TYPE_NORMAL
- en: Analysis
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'An analysis of a compromised Google Workspace environment requires focusing
    on mainly user and admin events. Incident responders need to thoroughly investigate
    these logs to identify evidence of unauthorized access and other indicators of
    compromise, similar to Microsoft 365, but this time in the Google ecosystem:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Login audit log analysis (user** **log events)**:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Key events**: Focus on **Successful login** and **Login failure** events.
    These indicate successful and unsuccessful login attempts.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Patterns to look for**: Repeated login failures followed by a success, particularly
    from varied IP addresses or geographic locations, could signal brute force attempts.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**IP and geolocation analysis**: Compare the IP addresses from the logs against
    the user’s typical login locations. Discrepancies in geolocation data can be a
    strong indicator of unauthorized access.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Gmail (Email)** **log investigation**:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Critical events**: Look for **Email sent**, **Email read**, and **Email**
    **deleted** activities.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Anomalies to detect**: High volumes of outbound emails to unknown addresses,
    bulk deletion of emails, or opening numerous emails in a short time frame can
    suggest account takeover. Furthermore, look into the creation and modification
    of any inbox rules, similar to what we discussed in the *Microsoft 365 incident*
    *response* section.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Admin activity** **log review**:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Significant events**: Monitor **User creation**, **User role change**, and
    **Service** **settings changed**.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Red flags**: Unauthorized creation of new users, escalation of privileges,
    or alterations in security settings are critical areas of concern.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**OAuth token** **activity monitoring**:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Key events**: Track **Token granted** and **Token** **revoked** actions.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Concerning observations**: The granting of tokens to unfamiliar third-party
    applications or an unusual pattern of token revocations can indicate that an attacker
    is trying to access data or services.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Groups audit** **log examination**:'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Crucial events**: Monitor **Group member added** and **Group** **settings
    changed**.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Indicators of compromise**: An indicator is the addition of unknown members
    to critical groups or unauthorized changes in group settings, particularly in
    groups with access to sensitive information.'
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: For each of these areas, incident responders should employ a context-driven
    approach. This involves looking beyond the mere occurrence of events to understanding
    their relevance in the broader context of user behavior and organizational norms.
    Analyzing the frequency, timing, and pattern deviations is crucial. We saw earlier
    in the *Microsoft 365 incident response* section how the login IPs can be looked
    up with an IP lookup service to better understand unauthorized access—the same
    process can be followed for Google Workspace.
  prefs: []
  type: TYPE_NORMAL
- en: Important note
  prefs: []
  type: TYPE_NORMAL
- en: Google Workspace’s UI and syntax may change in the future, as these are active
    products being developed by their teams. As a result, some of the event names
    may change, but their principles are the same (for example, **Successful login**
    could change to **Login success** or vice versa).
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this final chapter on analyzing compromised cloud productivity suites, we
    explored how to tackle security incidents in the two most popular cloud-based
    productivity suites, Microsoft 365 and Google Workspace. These platforms, crucial
    for emails, storage, and office applications, are frequently targeted in BEC attacks.
    BEC, a sophisticated form of cyber fraud, often involves attackers gaining unauthorized
    access through email spoofing or account takeovers, leading to broader security
    breaches.
  prefs: []
  type: TYPE_NORMAL
- en: The chapter provided a guide to understanding BEC, its phases, and attacker
    methods. It then outlined crucial steps for initial scoping and remediation, essential
    for effective incident response. For Microsoft 365, it focused on using tools
    such as unified audit logs and Microsoft Purview for log analysis. It also discussed
    an open source PowerShell-based tool, HAWK, for streamlined data collection.
  prefs: []
  type: TYPE_NORMAL
- en: In contrast, Google Workspace incident response was discussed, with its more
    limited, yet vital, set of audit and reporting tools. The process involves using
    Google Workspace’s audit logs to identify suspicious activities. This chapter
    equipped you with the knowledge to effectively respond to incidents in both Microsoft
    365 and Google Workspace.
  prefs: []
  type: TYPE_NORMAL
- en: Further reading
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: '*Microsoft* *Purview*: [https://learn.microsoft.com/en-us/purview/](https://learn.microsoft.com/en-us/purview/)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*What is a Business Email Compromise (**BEC)*—Microsoft: [https://www.microsoft.com/en-ca/security/business/security-101/what-is-business-email-compromise-bec](https://www.microsoft.com/en-ca/security/business/security-101/what-is-business-email-compromise-bec)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Identify and secure compromised accounts*—Google Workspace: [https://support.google.com/a/topic/1355151?hl=en&ref_topic=1258984&sjid=10797876945924014941-NC](https://support.google.com/a/topic/1355151?hl=en&ref_topic=1258984&sjid=10797876945924014941-NC)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
