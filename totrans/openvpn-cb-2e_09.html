<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch09"/>Chapter 9. OS Integration</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Linux - using <code class="literal">NetworkManager</code></li><li class="listitem">Linux - using <code class="literal">pull-resolv-conf</code></li><li class="listitem">Windows - elevated privileges</li><li class="listitem">Windows - using the CryptoAPI store</li><li class="listitem">Windows - updating the DNS cache</li><li class="listitem">Windows - running OpenVPN as a service</li><li class="listitem">Windows - public versus private network adapters</li><li class="listitem">Windows - routing methods</li><li class="listitem">Windows 8+- ensuring DNS lookups are secure</li><li class="listitem">Android- using the OpenVPN for Android clients</li><li class="listitem">Push-peer-info - pushing options to Android clients</li></ul></div><div><div><div><div><h1 class="title"><a id="ch09lvl1sec95"/>Introduction</h1></div></div></div><p>In this chapter, we will focus on how to use OpenVPN on Linux, Windows, and Android. For each operating system, an entire chapter could be written to describe the intricacies of running OpenVPN in both the client and server mode, but as space is limited, we will focus only on the interaction of the OpenVPN client with the OS. The purpose of the recipes in this chapter is to outline some of the common pitfalls when running OpenVPN on a particular platform. The recipes focus mainly on the configuration of OpenVPN itself, not on how to integrate a working VPN setup into the rest of the network infrastructure.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec96"/>Linux - using NetworkManager</h1></div></div></div><p>When Linux is used as a desktop operating system, the network configuration is configured using the Linux NetworkManager in most of the cases. This package allows a non-root user to start and stop the network connections, connect and disconnect from wireless networks, and also to set up several types of VPN connections, including OpenVPN. In this recipe, we will show how to configure an OpenVPN connection using the GNOME variant of the NetworkManager.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec358"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. This version of Linux comes with NetworkManager 1.0.8, including the <code class="literal">NetworkManager-openvpn</code> plugin. The <code class="literal">NetworkManager-openvpn</code> plugin is not installed by default and needs to be explicitly added to the system. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, in the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec359"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the NetworkManager configuration screen by right-clicking on the NetworkManager icon in the taskbar and selecting <strong>Edit Connections</strong>. A window will pop up.</li><li class="listitem">Choose the <strong>VPN</strong> tab to set up a new VPN connection:<div><img src="img/image00406.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on the <strong>Add</strong> button to bring up the next screen:<div><img src="img/image00407.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select the <strong>OpenVPN</strong> as the VPN type and click on the <strong>Create...</strong> button. If the VPN connection type <strong>OpenVPN</strong> is not available, then the <code class="literal">NetworkManager-openvpn</code> plugin is not installed.</li><li class="listitem">Fill in the details of the <strong>VPN</strong> tab of the next window:<div><img src="img/image00408.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>The <strong>Gateway</strong> is the hostname or IP address of the OpenVPN server. The <strong>Type</strong> of authentication is <strong>Certificates</strong><strong> (TLS</strong><strong>)</strong>. Then, for the <strong>User Certificate</strong>, <strong>CA Certificate</strong>, and <strong>Private Key</strong> fields, browse to the directory where the client files <code class="literal">client1.crt</code>, <code class="literal">ca.crt</code>, and <code class="literal">client1.key</code> are located, respectively. Fill in the <strong>Private Key Password</strong> fields, if required. Do not click on the <strong>Save</strong> button just yet, click on <strong>Advanced</strong><strong>...</strong> instead.</p></li><li class="listitem">In the next window, go to the <strong>Security</strong> tab:<div><img src="img/image00409.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select the encryption cipher and HMAC authentication protocol to use for the connection and then click on <strong>OK</strong>.</li><li class="listitem">Then, go to the <strong>TLS Authentication</strong> tab.<div><img src="img/image00410.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Enable <strong>Verify peer (server) certificate usage signature</strong>, then select <strong>Use additional TLS authentication</strong>, and browse to the location of the <code class="literal">ta.key</code> file. Choose <strong>1</strong> for the key direction.</li><li class="listitem">Click on <strong>OK</strong> when done and then click on <strong>Apply</strong> to save the new VPN connection.</li><li class="listitem">Next, start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">And finally, on the client, start the VPN connection by clicking on the NetworkManager icon, choosing<strong>VPN Connections</strong> and selecting <strong>Example 9-1</strong>:<div><img src="img/image00411.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div><p>You can verify whether the VPN connection is established correctly by pinging the VPN server IP.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec360"/>How it works...</h2></div></div></div><p>The <code class="literal">NetworkManager-openvpn</code> plugin is a GUI for setting up an OpenVPN client configuration file. All the settings made are the equivalent of setting up the client configuration file as done in the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec361"/>There's more...</h2></div></div></div><p>The <code class="literal">NetworkManager-openvpn</code> plugin supports some advanced configuration settings:</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec76"/>Setting up routes using NetworkManager</h3></div></div></div><p>The <code class="literal">NetworkManager-openvpn</code> plugin can also be used to set up VPN-specific routes. Open the main VPN configuration screen again and go to the <strong>IPv4 Settings</strong> tab. Click on the <strong>Routes...</strong> button on this screen:</p><div><img src="img/image00412.jpeg" alt="Setting up routes using NetworkManager"/></div><p style="clear:both; height: 1em;"> </p><p>A new window will appear:</p><div><img src="img/image00413.jpeg" alt="Setting up routes using NetworkManager"/></div><p style="clear:both; height: 1em;"> </p><p>Routes pushed by the server can be overruled using the <strong>Ignore automatically obtained routes</strong> option. By default, the <code class="literal">NetworkManager-openvpn</code> plugin will enable <code class="literal">redirect-gateway</code>, even if it is not pushed by the server. This behavior can be overruled by checking the <strong>Use this connection only for resources on its network</strong> checkbox.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec77"/>DNS settings</h3></div></div></div><p>The <code class="literal">NetworkManager-openvpn</code> plugin also updates the <code class="literal">/etc/resolv.conf</code> file if the OpenVPN server pushes out DNS servers using the following directive:</p><pre class="programlisting">push "dhcp-option DNS a.b.c.d" &#13;
</pre></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec78"/>Scripting</h3></div></div></div><p>Note that NetworkManager does not allow scripting or plugins on the client side, as they are a security risk when configured by a non-root user.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec97"/>Linux - using pull-resolv-conf</h1></div></div></div><p>One of the most common pitfalls when setting up a VPN connection on Linux is when the OpenVPN server pushes out new DNS settings. In the previous recipe, we saw that the <code class="literal">NetworkManager-openvpn</code> plugin also updated the system configuration file that contained the DNS setting, <code class="literal">/etc/resolv.conf</code>. If the command line is used, this is not done automatically. By default, OpenVPN comes with two scripts to add and remove DNS servers from the <code class="literal">/etc/resolv.conf</code> file. This recipe will show how to use these scripts.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec362"/>Getting ready</h2></div></div></div><p>We will use the following network layout:</p><div><img src="img/image00414.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the <code class="literal">basic-udp-server.conf</code> configuration file from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the <code class="literal"> basic-udp-client.conf</code> client configuration file at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec363"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Append the following line to the <code class="literal">basic-udp-server.conf</code> file:<pre class="programlisting">        push "dhcp-option DNS 10.198.0.1" &#13;
</pre><p>Here, <code class="literal">10.198.0.1</code> is the address of a DNS server on the VPN server LAN. Save it as <code class="literal">example9-2-server.conf</code>.</p></li><li class="listitem">Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config example9-2-server.conf</strong>
</pre></li><li class="listitem">Similarly, for the client, add the following lines to the <code class="literal">basic-udp-client.conf</code> file:<pre class="programlisting">        script-security 2 &#13;
        up   "/etc/openvpn/cookbook/client.up" &#13;
        down "/etc/openvpn/cookbook/client.down" &#13;
</pre></li><li class="listitem">Save it as <code class="literal">example9-2-client.conf</code>. Copy over the <code class="literal">client.up</code> and <code class="literal">client.down</code> files from the OpenVPN <code class="literal">contrib</code> directory and make them executable. On CentOS 6 and Fedora 22, these files are located in the <code class="literal">/usr/share/doc/openvpn-2.3.11/contrib/pull-resolv-conf</code> directory:<pre class="programlisting">
<strong>[root@client]# cd /etc/openvpn/cookbook</strong>
<strong>[root@client]# cp /usr/share/doc/openvpn-2.3.11/contrib/pull-&#13;
        resolv-conf/client.* .</strong>
<strong>[root@client]# chmod 755 client.*</strong>
</pre></li><li class="listitem">And finally, start the client:<pre class="programlisting">
<strong>[root@client]# openvpn --config example9-2-client.conf</strong>
</pre></li></ol><div></div><p>After the VPN connection comes up, check the contents of the <code class="literal">/etc/resolv.conf</code> file. The first line should contain the DNS server as specified by the OpenVPN server:</p><pre class="programlisting">nameserver 10.198.0.1 &#13;
</pre><p>When the VPN connection is terminated, the entry is removed again.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec364"/>How it works...</h2></div></div></div><p>The scripts supplied with OpenVPN parse the environment variable, <code class="literal">foreign_option_*</code>, and look for DOMAIN and DNS settings. These settings are then written out to the beginning of the <code class="literal">/etc/resolv.conf</code> file. This causes the DNS server and the DOMAIN pushed by the OpenVPN server to take precedence over the system's DNS and DOMAIN settings.</p><p>When the VPN connection is dropped, the same settings are removed from the <code class="literal">/etc/resolv.conf</code> file.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec365"/>There's more...</h2></div></div></div><p>Note that when the <code class="literal">NetworkManager-openvpn</code> plugin is used, these scripts are not necessary, as the NetworkManager itself updates the <code class="literal">/etc/resolv.conf</code> file.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec98"/>Windows - elevated privileges</h1></div></div></div><p>With the introduction of Windows Vista, Microsoft introduced <strong>User Access Control</strong> (<strong>UAC</strong>). UAC is meant to safeguard users from running programs that can modify the operating system itself. Before such a program is run, a privilege elevation is required even if the user has full administrator rights. A dialog box appears that the user must click on before the execution begins. In order to run OpenVPN, elevated privileges are needed, as OpenVPN wants to open a system device and start a VPN connection. Especially if routes need to be added to the system, elevated privileges are essential.</p><p>With OpenVPN 2.3+, privilege elevation is built into the OpenVPN GUI application. That is, even if the <strong>Run as Administrator</strong> flag is turned off, the OpenVPN GUI application will still request elevated privileges when it is launched. This recipe will demonstrate this behavior, which was not present in older versions of OpenVPN.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec366"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client computer was running Windows 7 SP1 and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For the client, keep the configuration file, <code class="literal">basic-udp-client.ovpn</code>, from the <em>Using an ifconfig-pool block</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec367"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">First, start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Make sure that the OpenVPN is not running and that the tray icon is not present.</li><li class="listitem">Before starting the OpenVPN GUI, right-click on the OpenVPN GUI icon that was placed on your desktop after installing the OpenVPN 2.3.11 installer for Windows.</li><li class="listitem">In the <strong>Properties</strong> screen that comes up, click on the <strong>Compatibility</strong> tab and disable <strong>Run this program as an administrator</strong>:<div><img src="img/image00415.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <strong>OK</strong>.</li><li class="listitem">Start the OpenVPN GUI. Note that it will still prompt for permissions (the following screenshot is for Windows Vista, but a similar window will pop up for Windows 7+):<div><img src="img/image00416.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Click on <strong>Continue</strong> to start the OpenVPN GUI as usual.</li><li class="listitem">Start the OpenVPN client by launching the <code class="literal">example5-1</code> configuration file:<div><img src="img/image00417.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Verify that the VPN connection is established and that the log file, <code class="literal">c:\temp\openvpn.log</code>, has been created.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec368"/>How it works...</h2></div></div></div><p>When the OpenVPN GUI application is launched, the user must always confirm that it can run with elevated privileges. This is now built into the OpenVPN GUI application itself, and is visible by noticing the shield at the right bottom of the application's icon:</p><div><img src="img/image00418.jpeg" alt="How it works..."/></div><p style="clear:both; height: 1em;"> </p><p>After that, the OpenVPN GUI can launch other executables that will also inherit these privileges. When the GUI launches the <code class="literal">openvpn.exe</code> process, it can open the VPN adapter, alter the routing tables, and run the up and down scripts.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec99"/>Windows - using the CryptoAPI store</h1></div></div></div><p>OpenVPN has the capability of using the Windows CryptoAPI store to retrieve the public and private key needed for setting up a connection. This improves security somewhat, as the CryptoAPI store is more secure than the plaintext <code class="literal">.crt</code> and <code class="literal">.key</code> files that are normally used to set up an OpenVPN connection.</p><p>In this recipe, we will configure an OpenVPN client to retrieve the required information from the CryptoAPI store when connecting to the server. This recipe was tested on Windows 7, but it will also work on other versions of Windows.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec369"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client computer was running Windows 7 SP1 and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks </em>at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec370"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">First, we need to import the client certificate into the CryptoAPI store. In order to do that we must convert the existing <code class="literal">client2.crt</code> and <code class="literal">client2.key</code> files to PKCS12 format. Open a Windows command shell and change the directory to the location where these files are located:<pre class="programlisting">
<strong>[winclient]C:&gt; cd C:\Program Files\OpenVPN\config</strong>
<strong>[winclient]C:\Program Files\OpenVPN\config&gt;..\bin\openssl &#13;
        pkcs12</strong>
<strong>    -export -in client2.crt -inkey client2.key -out client2.p12</strong>
<strong>Enter pass phrase for client2.key: [existing password]</strong>
<strong>Enter Export Password: [new export password]</strong>
<strong>Verifying - Enter Export Password: [repeat export password]</strong>
</pre></li><li class="listitem">Next, import the PKCS12 file into the Windows CryptoAPI store:<pre class="programlisting">
<strong>[winclient]C:\Program Files\OpenVPN\config&gt;start client2.p12</strong>
</pre><p>The certificate import wizard will start.</p></li><li class="listitem">Click on <strong>Next</strong> on the first screen and again click on <strong>Next</strong> on the second screen. Then, you must supply the export password from the previous step:<div><img src="img/image00419.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>If you select the <strong>Enable strong private key protection. You will be prompted every time the private key is used by an application if you enable this option</strong> checkbox, the certificate and private key are even better protected, but you will be required to retype the password every time OpenVPN starts.</p></li><li class="listitem">Click on <strong>Next</strong>. In the next screen, select the default option, <strong>Automatically select the certificate store</strong>, and click on <strong>Next</strong> once more. By clicking on <strong>Finish</strong> in the next screen, the certificate import is completed.<div><img src="img/image00420.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Create the client configuration file:<pre class="programlisting">        client &#13;
        proto udp &#13;
        remote openvpnserver.example.com &#13;
        port 1194 &#13;
 &#13;
        dev tun &#13;
        nobind &#13;
 &#13;
        remote-cert-tls server &#13;
        tls-auth "c:/program files/openvpn/config/ta.key" 1 &#13;
        ca          "c:/program files/openvpn/config/ca.crt" &#13;
        cryptoapicert  "SUBJ:Client2" &#13;
</pre></li><li class="listitem">Save the configuration file as <code class="literal">example9-4.ovpn</code>. Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Start the VPN connection using the OpenVPN GUI.</li></ol><div></div><p>The VPN connection should be established without asking for a private key password. If the CryptoAPI option, <strong>Enable strong private key protection</strong>, was enabled, a separate dialog will pop up to ask for the CryptoAPI password.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec371"/>How it works...</h2></div></div></div><p>The Windows OpenVPN client software is capable of extracting a certificate and public key from the Windows CryptoAPI store if either the certificate subject name is specified using the keyword, <code class="literal">SUBJ:</code>, or if the certificate thumbprint or fingerprint is specified using the keyword, <code class="literal">THUMB:</code>. After retrieving the certificate and private key from the CryptoAPI store, the VPN connection is established in exactly the same manner as if a plaintext certificate and private key files had been used.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec372"/>There's more...</h2></div></div></div><p>There are several small yet important details when using the Windows CryptoAPI store. We will cover this in the following sections.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec79"/>The CA certificate file</h3></div></div></div><p>Note that it is still required to specify the CA certificate using the following line:</p><pre class="programlisting">ca c:/program files/openvpn/config/ca.crt &#13;
</pre><p>In theory, it would be possible to also retrieve the CA certificate from the CryptoAPI store, but this is currently not implemented in OpenVPN. Also, note that the CA certificate file needs to contain the certificate authority that was used to sign the server-side certificate, not the client-side certificate.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec80"/>Certificate fingerprint</h3></div></div></div><p>Instead of supplying <code class="literal">cryptoapicert SUBJ:&lt;subject name&gt;</code>, it is also possible to specify <code class="literal">cryptoapicert THUMB:&lt;fingerprint&gt;</code>.</p><p>The fingerprint or thumbprint of an X509 certificate can be retrieved both by either looking up the <code class="literal">Thumb</code> property for the imported certificate in the Windows Certificate store or by typing the OpenSSL command:</p><pre class="programlisting">
<strong>C:\Program Files\OpenVPN\config&gt;..\bin\openssl x509 \</strong>
<strong>    -fingerprint -noout -in client2.crt</strong>
<strong>SHA1 Fingerprint=91:93:72:7D:0D:D7:33:58:81:DA:DE:2C:17:1E:36:43:58:40:BF:50</strong>
</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec100"/>Windows - updating the DNS cache</h1></div></div></div><p>A frequently recurring question on the OpenVPN users mailing lists is related to the DNS name resolution on Windows after the VPN connection is established. If the OpenVPN server pushes out a new DNS server, then this is automatically picked up by the OpenVPN client, yet the name resolution does not always work right after establishing the connection. This has little to do with OpenVPN and more to do with the way the Windows DNS caching service works. As this question comes up quite regularly, a new directive, <code class="literal">register-dns</code>, was added in OpenVPN 2.1.3. When this directive is specified, OpenVPN updates the Windows DNS cache and registers the VPN IP address in the Windows DNS tables. As this feature was introduced only recently, this recipe will also show how the Windows DNS cache can be updated using a script when the VPN connection is established. Some users disable the DNS caching service altogether, which seems to have little impact on the operating system, except for a small performance penalty when using a slow network.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec373"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client computer was running Windows 7 SP1 and OpenVPN 2.3.11. Keep the server configuration file, <code class="literal">example9-2-server.conf</code>, from the <em>Linux: using pull-resolv-conf</em> recipe at hand, as well as the client configuration file, <code class="literal">basic-udp-client.ovpn</code>, from the <em>Using an ifconfig-pool block</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec374"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config example9-2-server.conf</strong>
</pre></li><li class="listitem">Add a line to the <code class="literal">basic-udp-client.ovpn</code> configuration file:<pre class="programlisting">        register-dns &#13;
</pre></li><li class="listitem">Save this configuration file as <code class="literal">example9-5.ovpn</code>. Start the OpenVPN client.<p>The OpenVPN GUI status window will show that the Windows service <code class="literal">dnscache</code> has restarted:</p><div><img src="img/image00421.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>After the VPN connection is established, verify that the name resolution is using the VPN-supplied DNS server, for example, by using the <code class="literal">nslookup</code> command.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec375"/>How it works...</h2></div></div></div><p>When the VPN connection is established, the OpenVPN client software sends a DHCP packet to the TAP-Win32 adapter with the IP address, default gateway, and the other network-related information, such as a new DNS server. This information is picked up by the operating system but the local DNS caching service is not notified immediately. The <code class="literal">register-dns</code> directive executes the following commands:</p><pre class="programlisting">
<strong>net stop dnscache</strong>
<strong>net start dnscache</strong>
<strong>ipconfig /flushdns</strong>
<strong>ipconfig /registerdns</strong>
</pre><p>By forcing a restart of the DNS caching service, the DNS server supplied by the VPN connection is used immediately.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec376"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Windows 8+ - ensuring DNS lookups are secure</em> recipe later in this chapter, which goes into detail of how to ensure that DNS lookups are passed over the VPN tunnel only</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec101"/>Windows - running OpenVPN as a service</h1></div></div></div><p>One of the lesser known features of the Windows version of OpenVPN is its ability to run it as a service. This allows OpenVPN to start and establish a VPN connection without a user logging in on the system. The OpenVPN service is installed by default, but is not started automatically.</p><p>In this recipe, we will show how the OpenVPN service can be controlled using the OpenVPN GUI application and how to perform troubleshooting on the service.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec377"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client computer was running Windows 7 SP1 and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand. For the client, keep the configuration file, <code class="literal">basic-udp-client.ovpn</code>, from the <em>Using an ifconfig-pool block</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec378"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Before starting the OpenVPN GUI application on the client side, we first launch the Windows registry editor, <code class="literal">regedit</code> (using elevated privileges). Find the <code class="literal">HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN-GUI</code> key.<div><img src="img/image00422.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Take a note of the <code class="literal">config_dir</code> registry key, which is normally set to <code class="literal">C:\Program Files\OpenVPN\config</code>.</li><li class="listitem">Set the registry key <strong>allow_service</strong> to <strong>1</strong>. Also, take note of the registry key, <code class="literal">log_dir</code>, which is normally set to <code class="literal">C:\Program Files\OpenVPN\log</code>.</li><li class="listitem">Now, browse to the registry key, <code class="literal">HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN</code>, and check the <code class="literal">config_dir</code> and <code class="literal">log_dir</code> keys again. They should be pointing to the same directories as for the OpenVPN GUI application.</li><li class="listitem">Close the registry editor.</li><li class="listitem">Launch the OpenVPN GUI. Right-click on the icon in the taskbar. A new menu option will have appeared.<div><img src="img/image00423.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>But do not start the service yet.</p></li><li class="listitem">First, modify the client configuration file, <code class="literal">basic-udp-client.ovpn</code>, by changing the following lines:<pre class="programlisting">        cert     "c:/program files/openvpn/config/client2.crt" &#13;
        key      "c:/program files/openvpn/config/client2.key" &#13;
</pre><p>Change these to the following:</p><pre class="programlisting">        cert     "c:/program files/openvpn/config/client1.crt" &#13;
        key      "c:/program files/openvpn/config/client1.key" &#13;
</pre><p>The <code class="literal">client2.key</code> client certificate from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, is protected by a password, whereas the <code class="literal">client1.key</code> file is not. Save the configuration file as <code class="literal">example9-6.ovpn</code>.</p></li><li class="listitem">Move all other <code class="literal">.ovpn</code> files to another directory to make sure that this is the only <code class="literal">.ovpn</code> file in the <code class="literal">config</code> directory.</li><li class="listitem">Now, start the OpenVPN service. After a while, the VPN connection will be established, as can be seen on both the client and the server in the log files.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec379"/>How it works...</h2></div></div></div><p>A Windows service is launched at system startup before a user is logged in. The OpenVPN service scans the directory pointed to by the registry key, <code class="literal">HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN\config_dir</code>.</p><p>This starts an OpenVPN process for each file with the <code class="literal">.ovpn</code>  extension in that directory. The output of each of these processes is logged into the log directory pointed to by the registry key:</p><pre class="programlisting">HKEY_LOCAL_MACHINE\SOFTWARE\OpenVPN\log_dir &#13;
</pre><p>Here, the log filename is the same as the configuration name, but now with the <code class="literal">.log</code> extension. For this recipe, the configuration file was <code class="literal">C:\Program Files\OpenVPN\config\example9-6.ovpn</code> and the log file was <code class="literal">C:\Program Files\OpenVPN\log\example9-6.log</code>.</p><p>There is no need to launch the OpenVPN GUI to start these connections, but the GUI application does offer a convenient method of managing the OpenVPN service, if the right registry key is added.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec380"/>There's more...</h2></div></div></div><p>There are a few important notes when using the OpenVPN service, which are outlined here.</p><div><div><div><div><h3 class="title"><a id="ch09lvl3sec81"/>Automatic service startup</h3></div></div></div><p>To make the OpenVPN service start at system startup, open the <strong>Services</strong> administrative control panel by navigating to <strong>Control Panel</strong> | <strong>Administrative Tools</strong> | <strong>Services</strong>. Double-click on the <strong>OpenVPN Service</strong> to open the properties and set the <strong>Startup type</strong> field to <strong>Automatic</strong>:</p><div><img src="img/image00424.jpeg" alt="Automatic service startup"/></div><p style="clear:both; height: 1em;"> </p><p>Click on <strong>OK</strong> and close the <strong>Services</strong> administrative control panel. Reboot Windows and verify on the server side that the client is connecting at system startup.</p></div><div><div><div><div><h3 class="title"><a id="ch09lvl3sec82"/>OpenVPN user name</h3></div></div></div><p>When the OpenVPN service is used, the corresponding OpenVPN processes are normally run under the account <strong>SYSTEM</strong>, as can be seen in the following screenshot:</p><div><img src="img/image00425.jpeg" alt="OpenVPN user name"/></div><p style="clear:both; height: 1em;"> </p><p>This has some implications regarding the permissions on the configuration files. Special care also needs to be taken when using the <code class="literal">cryptoapicert</code> directive, as by default, those certificates end up in the user certificate store, which is not accessible to the <strong>SYSTEM</strong> account. It is possible to use the <code class="literal">cryptoapicert</code> directive, but the imported certificate must be installed as a (local) system certificate and not as a user certificate.</p></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec381"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Windows - using the CryptoAPI store</em> recipe earlier in this chapter, which explains how to use the Windows CryptoAPI store to store the user certificate and private key</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec102"/>Windows - public versus private network adapters</h1></div></div></div><p>With Windows Vista and 7, Microsoft introduced the concept of network classes. Network interfaces can be part of a <strong>Private</strong> or <strong>Public</strong> network. When using OpenVPN, one must be careful in which type of network the adapter is placed. By default, OpenVPN's TAP-Win32 adapter is placed in a <strong>Public</strong> network, which has a side-effect that it is not possible to mount file shares. In this recipe, we will show how to change the network type so that the trusted services such as file sharing are possible over a VPN connection. While this has little to do with configuring the OpenVPN per se, this issue comes up often enough to warrant a recipe.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec382"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client computer was running Windows 7 SP1 and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand. For the client, keep the configuration file, <code class="literal">basic-udp-client.ovpn</code>, from the <em>Using an ifconfig-pool block</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec383"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Append the following line to the <code class="literal">basic-udp-server.conf</code> file:<pre class="programlisting">        push "route 0.0.0.0 0.0.0.0 vpn_gateway 300" &#13;
</pre></li><li class="listitem">Save it as <code class="literal">example9-7-server.conf</code>. Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config example9-7-server.conf</strong>
</pre></li><li class="listitem">On the Windows client, launch the OpenVPN GUI.</li><li class="listitem">After the VPN connection is established, a window will pop up asking you what type of network this is. For Windows 7, you can choose <strong>Home</strong>, <strong>Work</strong>, or <strong>Public</strong>; for Windows 8+, the choice is either <strong>Private</strong> or <strong>Public</strong>.</li><li class="listitem">Select the <strong>Work</strong> network, and then open the <strong>Network and Sharing Center</strong>:<div><img src="img/image00426.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec384"/>How it works...</h2></div></div></div><p>With Windows 7+, each network type has different access rights. The network type with the fewest rights is <strong>Public</strong>, which means that the applications can set up TCP/IP connections, but they cannot access any of the resources available in the <strong>Work</strong> or <strong>Private</strong> networks, such as local printers and the local disks. When sharing resources that are on the same network as the OpenVPN client, this can become an issue.</p><p>Windows determines the type of network by looking at whether a default gateway is present for that network. If no default gateway is specified, the network is considered to be untrustworthy and hence it is made public. There is no option to easily change this afterward.</p><p>To overcome this peculiarity, we supply a default gateway with a very high metric:</p><pre class="programlisting">push "route 0.0.0.0 0.0.0.0 vpn_gateway 300" &#13;
</pre><p>Using a very high metric, we avoid the problem that all network traffic is routed over the VPN, which can lead to <em>biting-your-own-tail</em> problems.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec385"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Windows - elevated privileges</em> recipe earlier in this chapter, which explains in more detail about how to run the OpenVPN GUI application with elevated privileges</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec103"/>Windows - routing methods</h1></div></div></div><p>When routes are pushed to a Windows client, there are two methods for adding these routes to the system routing tables:</p><div><ul class="itemizedlist"><li class="listitem">Using the IPAPI helper functions (the default)</li></ul></div><div><ul class="itemizedlist"><li class="listitem">Using the <code class="literal">ROUTE.EXE</code> program</li></ul></div><p>In most cases, the IPAPI method works fine, but sometimes, it is necessary to overrule this behavior. In this recipe, we will show how this is done and what to look for in the client log file to verify that the right method has been chosen.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec386"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client computer was running Windows 7 SP1 and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand. For the client, keep the configuration file, <code class="literal">basic-udp-client.ovpn</code>, from the <em>Using an ifconfig-pool block</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec387"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Add the following lines to the <code class="literal">basic-udp-client.ovpn</code> configuration file:<pre class="programlisting">        verb 5 &#13;
        route-method ipapi &#13;
</pre></li><li class="listitem">Save this configuration file as <code class="literal">example9-8.ovpn</code>. Start the OpenVPN client with this configuration.</li><li class="listitem">After the connection has been established, bring up the <strong>Show Status</strong> window again and look at the last lines of the connection log. The log will show lines similar to the following:<pre class="programlisting">        ...  C:\WINDOWS\system32\route.exe ADD 10.198.0.0 MASK &#13;
        255.255.0.0 10.200.0.1 &#13;
        ... Route addition via IPAPI succeeded &#13;
        ... Initialization Sequence Completed &#13;
</pre><p>Even though the <code class="literal">route-method</code> directive was set to <code class="literal">ipapi</code>, the log file prints out the path of the Windows <code class="literal">route.exe</code> command. The second line shows that the route was actually added using the IPAPI helper functions.</p></li><li class="listitem">Now, modify the configuration file, <code class="literal">example9-8.ovpn</code>, to the following:<pre class="programlisting">        verb 5 &#13;
        route-method exe &#13;
</pre></li><li class="listitem">Restart the OpenVPN client.</li><li class="listitem">Look at the last lines of the connection log again. This time the message, <strong>Route addition via IPAPI succeeded</strong>, will not be present in the log file, which means that the <code class="literal">route.exe</code> command was used. Instead, you will see something similar to this:<pre class="programlisting">        ...  C:\WINDOWS\system32\route.exe ADD 10.198.0.0 MASK &#13;
        255.255.0.0 10.200.0.1 &#13;
        ... env_block: add PATH=C:\Windows\System32;C:\Windows;... &#13;
        ... Initialization Sequence Completed &#13;
</pre><p>The line starting with <code class="literal">env_block</code> indicates that a set of environment variables were set up prior to launching the external <code class="literal">route.exe</code> command.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec388"/>How it works...</h2></div></div></div><p>The <code class="literal">route-method</code> directive has three options:</p><div><ul class="itemizedlist"><li class="listitem"><code class="literal">adaptive</code>: First, try the IPAPI method, and fallback to the <code class="literal">route.exe</code> method if IPAPI fails. This is the default.</li><li class="listitem"><code class="literal">ipapi</code>: Always use the IPAPI helper functions to add routes.</li><li class="listitem"><code class="literal">exe</code>: Always use the external program, <code class="literal">route.exe</code>.</li></ul></div><p>Based on this directive, the OpenVPN client will choose how to add routes to the Windows routing tables. Note that if OpenVPN cannot add a route, it will not abort the connection. The current OpenVPN GUI does not detect this and will show a green icon in the taskbar, suggesting a fully successful connection.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec389"/>There's more...</h2></div></div></div><p>OpenVPN is preconfigured to look for the <code class="literal">route.exe</code> program in the directory where Windows is installed, usually <code class="literal">C:\WINDOWS\system32</code>. If Windows is installed in a different directory, the <code class="literal">win-sys</code> directive can be used. The <code class="literal">win-sys</code> directive has two options:</p><div><ul class="itemizedlist"><li class="listitem">The default option, <code class="literal">env</code>, which means that the OpenVPN client will use the contents of the environment variable, <code class="literal">windir</code>, to locate the Windows operating system. This environment variable is always set in a normal Windows setup. Starting with OpenVPN 2.3, this is the default setting and a warning message is printed if <code class="literal">win-sys env</code> is specified.</li><li class="listitem">The directory name where the Windows operating system can be found, for example, <code class="literal">D:\WINDOWS</code>. This should be used only if the <code class="literal">route.exe</code> program is in a non-standard location.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec104"/>Windows 8+ - ensuring DNS lookups are secure</h1></div></div></div><p>Starting with Windows 8.1, Microsoft introduced a new feature for resolving hostnames to IP addresses. Whenever an application wants to resolve a hostname, a DNS query is sent out over all network adapters found in the system. The answer from the first adapter that responds to the query is used.</p><p>If a user wants to tunnel all traffic over a VPN in a secure manner, then this feature is not desirable. In a hostile network environment, a bogus IP address could be returned or even the fact that a DNS lookup for a particular host is made could be considered dangerous.</p><p>Starting with OpenVPN 2.3.10, a new option, <code class="literal">block-outside-dns</code>, was added to suppress this feature. In this recipe, we will show how to use this option.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec390"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client computer was running Windows 8.1 and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand. For the client, keep the configuration file, <code class="literal">basic-udp-client.ovpn</code>, from the <em>Using an ifconfig-pool block</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec391"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Add the following lines to the <code class="literal">basic-udp-client.ovpn</code> configuration file:<pre class="programlisting">        verb 5 &#13;
        block-outside-dns &#13;
</pre></li><li class="listitem">Save this configuration file as <code class="literal">example9-9.ovpn</code>. Start the OpenVPN client with this configuration.</li><li class="listitem">After the connection has been established, bring up the <strong>Show Status</strong> window again and look at the last lines of the connection log. The output should be similar to the following:<div><img src="img/image00427.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>In this log file, the <strong>Windows Filtering Platform</strong> (<strong>WFP</strong>) is initialized and special rules are added to block DNS traffic.</p></li><li class="listitem">Stop the OpenVPN client and check the log file again. You should see a line indicating that the WFP engine is shut down, thereby removing the filtering rules added by OpenVPN:<pre class="programlisting">        ... Closing TUN/TAP interface &#13;
        ... Uninitializing WFP &#13;
</pre></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec392"/>How it works...</h2></div></div></div><p>With the <code class="literal">block-outside-dns</code> directive, a set of Windows filtering rules are created after the VPN connection has been established. These filter (or firewalling) rules prevent DNS lookups from being sent over all network adapters found on the Windows client, except for queries made over the TAP adapter. When the OpenVPN connection is terminated, the WFP rules are removed.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec393"/>There's more...</h2></div></div></div><p>Be careful when using this option with OpenVPN 2.3 when you have multiple simultaneous tunnels open. In some cases, the WFP rules that are added by the first tunnel are not restored properly when the second tunnel is shut down, thereby blocking all DNS traffic.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec105"/>Android - using the OpenVPN for Android clients</h1></div></div></div><p>OpenVPN can also be used on mobile devices, such as Android or iPhone smartphones. In this recipe, we will show how to set up a basic configuration file for the OpenVPN for the Android app. The same configuration can be used on iPhones and iPads.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec394"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client device was running Android 4.2 and OpenVPN for Android version 0.6.57. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand. For the client, keep the configuration file, <code class="literal">basic-udp-client.ovpn</code>, from the <em>Using an ifconfig-pool block</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks </em>at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec395"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Create the OpenVPN app profile by converting the <code class="literal">basic-udp-client.ovpn</code> file to an inline configuration file. This is done by replacing all references to external files with the inline blobs. We then add these inline blobs by copying the contents from the external files. The resulting configuration file will look similar to this:<pre class="programlisting">        client &#13;
        proto udp &#13;
        remote openvpnserver.example.com &#13;
        port 1194 &#13;
        dev tun &#13;
        nobind &#13;
        remote-cert-tls server &#13;
        key-direction 1 &#13;
        push-peer-info &#13;
 &#13;
        &lt;ca&gt; &#13;
        -----BEGIN CERTIFICATE----- &#13;
        MIIGDzCCA/egAwIBAgIJAJOj7Wg... &#13;
        ... &#13;
        -----END CERTIFICATE----- &#13;
        &lt;/ca&gt; &#13;
 &#13;
        &lt;cert&gt; &#13;
        -----BEGIN CERTIFICATE----- &#13;
        MIIFKzCCAxOgAwIBAgIBAjANBgi... &#13;
        ... &#13;
        -----END CERTIFICATE----- &#13;
        &lt;/cert&gt; &#13;
 &#13;
        &lt;key&gt; &#13;
        -----BEGIN RSA PRIVATE KEY----- &#13;
        MIIEvgIBADANBgkqhkiG9w0BAQEF... &#13;
        ... &#13;
        -----END RSA PRIVATE KEY----- &#13;
        &lt;/key&gt; &#13;
 &#13;
        &lt;tls-auth&gt; &#13;
        -----BEGIN OpenVPN Static key V1----- &#13;
        5f5b2bfff373961654089871b40a39eb &#13;
        ... &#13;
        -----END OpenVPN Static key V1----- &#13;
        &lt;/tls-auth&gt; &#13;
</pre></li><li class="listitem">Save this configuration file as <code class="literal">example9-10.ovpn</code>.</li><li class="listitem">Transfer the app configuration file to the Android smartphone.</li><li class="listitem">Start the OpenVPN for Android app and import the <code class="literal">example9-10.ovpn</code> profile. If all goes well, you should see an output similar to this:<div><img src="img/image00428.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Launch the OpenVPN profile. After the connection has been established, the app will show the current status and log with the top line showing <strong>Connected: SUCCESS, 10.200.0.2, 192.168.96.101, 1194:</strong><div><img src="img/image00429.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p><p>
</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec396"/>How it works...</h2></div></div></div><p>The OpenVPN for Android app is based on the same source code as the open source OpenVPN software. Hence, almost all options that can be specified in a normal configuration file can also be specified in an OpenVPN app profile. However, it is recommended to include all certificate and keying information inside the profile, as it makes it much easier to transfer the configuration to the device.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec397"/>There's more...</h2></div></div></div><p>If you want to transfer the app profile by uploading it to a web server first, then make sure that the file type and extensions remain intact. The mobile device will treat the configuration file as a plain text file if it does not recognize it as an OpenVPN profile and you will not be able to import it into the OpenVPN for Android app. In such cases, it may be desirable to transfer the <code class="literal">.ovpn</code> file inside a ZIP (<code class="literal">.zip</code>) file.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec398"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Inline certificates</em> recipe in the next chapter, which goes into detail on using inline certificates</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch09lvl1sec106"/>Push-peer-info - pushing options to Android clients</h1></div></div></div><p>This recipe is a continuation of the previous recipe. When integrating mobile clients into an existing OpenVPN setup, it is often necessary to treat these mobile clients differently from the regular OpenVPN clients. In some cases, it will be necessary to redirect all traffic for mobile clients over the VPN tunnel or a different encryption scheme needs to be used to optimize the OpenVPN app on the Android device. In this recipe, we will demonstrate how to push an option to an Android client, while leaving the options for all other clients unchanged.</p><div><div><div><div><h2 class="title"><a id="ch09lvl2sec399"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.4. The client device was running Android 4.2 and OpenVPN for Android version 0.6.57. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em> at hand. For the client, keep the configuration file, <code class="literal">example9-10.ovpn</code>, from previous recipe at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec400"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Append the following lines to the <code class="literal">basic-udp-server.conf</code> server configuration file:<pre class="programlisting">        script-security 2 &#13;
        client-connect    /etc/openvpn/cookbook/example9-11.sh &#13;
</pre></li><li class="listitem">Save it as <code class="literal">example9-11-server.conf</code>. Next, create the connect script:<pre class="programlisting">        #!/bin/bash &#13;
 &#13;
        # Redirect the default gateway for all Android clients &#13;
        if [ "x_${IV_PLAT}" = "x_android" ] &#13;
        then &#13;
            echo "push "redirect-gateway def1"" &gt;&gt; $1 &#13;
        fi &#13;
</pre></li><li class="listitem">Save this file as <code class="literal">example9-11.sh</code>. Make sure that the script is executable and start the server:<pre class="programlisting">
<strong>[root@server]# chmod 755 example9-11.sh</strong>
<strong>[root@server]# openvpn --config example9-11-server.conf</strong>
</pre></li><li class="listitem">Start the OpenVPN for Android app and establish the VPN connection.</li><li class="listitem">After the connection has been established, use another app, such as Fing, to ensure that all traffic is redirected via the OpenVPN tunnel:<div><img src="img/image00430.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">The first address in the traceroute output is <code class="literal">10.200.0.1</code>, demonstrating that the traffic is redirected via the OpenVPN server.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec401"/>How it works...</h2></div></div></div><p>In the OpenVPN for Android configuration, we added the <code class="literal">push-peer-info</code> option. This causes the OpenVPN client to send configuration details to the server. Starting with OpenVPN 2.4, these configuration details are available both inside plugins and scripts. The <code class="literal">client-connect</code> script examines the environment variable, <code class="literal">IV_PLAT</code>, and pushes a <code class="literal">redirect-gateway</code> if an Android client is connecting.</p></div><div><div><div><div><h2 class="title"><a id="ch09lvl2sec402"/>There's more...</h2></div></div></div><p>The <code class="literal">push-peer-info</code> option is available in all OpenVPN 2.3 clients. However, support on the server side to actually process this information was added in version 2.4. The following peer information is sent to the server:</p><div><ul class="itemizedlist"><li class="listitem"><code class="literal">IV_COMP_STUB=1, IV_COMP_STUBv2=1</code>: This indicates that the client supports compression stubs. It also means that the server can push compression options to the client.</li><li class="listitem"><code class="literal">IV_GUI_VER=de.blinkt.openvpn_0.6.57</code>: This indicates the client GUI version. In this case, the OpenVPN for Android client version 0.6.57 was used.</li><li class="listitem"><code class="literal">IV_HWADDR=00:00:00:00:00:00</code>: This indicates the client's Ethernet hardware address. On Android clients, this option is always <code class="literal">00:00:00</code>, but on other platforms the MAC address of the TUN/TAP adapter is transmitted.</li><li class="listitem"><code class="literal">IV_LZ4=1, IV_LZ4v2=1, IV_LZO=1</code>: This indicates that the client supports LZ4, LZ4v2, and LZO compression.</li><li class="listitem"><code class="literal">IV_NCP=2</code>: This indicates that the client supports encryption cipher negotiation. This allows the client and server to negotiate the most optimal compression and HMAC algorithms.</li><li class="listitem"><code class="literal">IV_PLAT=android</code>: This indicates the client platform.</li><li class="listitem"><code class="literal">IV_PROTO=2</code>: This indicates the version of the push-peer-info format. In the future, the format or set of variables sent to the server might change, which would warrant an increase in the version number.</li><li class="listitem"><code class="literal">IV_RGI6=1</code>: This indicates that the client supports redirection of the IPv6 gateway address.</li><li class="listitem"><code class="literal">IV_SSL=OpenSSL_1.0.2h__3_May_2016</code>: This indicates the SSL library and version that is used by the OpenVPN client. This could be important to determine whether a particular client is susceptible to a crypto library vulnerability.</li><li class="listitem"><code class="literal">IV_VER=2.4_master</code>: This indicates the version of the OpenVPN software on the client.</li></ul></div></div></div></body></html>