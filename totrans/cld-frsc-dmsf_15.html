<html><head></head><body>
<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2"><h1 class="chapter-number" id="_idParaDest-213"><a id="_idTextAnchor227" class="pcalibre1 pcalibre2 pcalibre"/>12</h1>

<h3 id="_idParaDest-214" class="calibre6"><a id="_idTextAnchor228" class="pcalibre1 pcalibre2 pcalibre"/>Analyzing Compromised Cloud Productivity Suites</h3>
<p class="calibre3">The reality is that most cloud-based security incidents within an organization will occur at the productivity suite level. As we discussed in <a href="part0026_split_000.html#_idTextAnchor137" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 7</em></span></a>, Microsoft 365 and Google Workspace are the most popular SaaS-based platforms in the industry. Organizations rely on Microsoft 365 and Google Workspace for business applications and services such as email, storage, office applications, and much more. Through the rise in the adoption of SaaS-based email solutions through Microsoft 365 and Google Workspace by corporations, these platforms have become a prime target for business email compromise attacks. Since these email accounts are integrally linked to other services within 365 and Workspace, such compromises also pose a risk to any additional service connected to the user’s account, amplifying the potential for broader security breaches and a <span>larger impact.</span></p>
<p class="calibre3">This chapter will dive into the details of compromised productivity suites, specifically Microsoft 365 and Google Workspace, from start to finish. We will discuss the following topics in <span>this chapter:</span></p>

<ul class="calibre12">
<li class="calibre13">Business email <span>compromise explained</span></li>
<li class="calibre13">Initial scoping and <span>remediation steps</span></li>
<li class="calibre13">Microsoft 365 <span>incident response</span></li>
<li class="calibre13">Google Workspace <span>incident response</span></li>
</ul>
</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h1 id="_idParaDest-215" class="calibre5"><a id="_idTextAnchor229" class="pcalibre1 pcalibre2 pcalibre"/>Business email compromise explained</h1>
<p class="calibre3"><strong class="bold">Business email compromise</strong> (<strong class="bold">BEC</strong>) is a sophisticated type of cyber fraud targeting organizations<a id="_idIndexMarker1051" class="pcalibre1 pcalibre2 pcalibre"/> through deceptive practices involving email communications. This threat exploits the reliance of businesses on email for corporate correspondence, manipulating trust and authority to execute some sort of unauthorized fund <a id="_idIndexMarker1052" class="pcalibre1 pcalibre2 pcalibre"/>transfers, obtain sensitive information, or move laterally into the <span>IT network.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h2 id="_idParaDest-216" class="calibre10"><a id="_idTextAnchor230" class="pcalibre1 pcalibre2 pcalibre"/>BEC attack phases</h2>
<p class="calibre3">The phases that <a id="_idIndexMarker1053" class="pcalibre1 pcalibre2 pcalibre"/>attackers utilize to conduct BEC attacks are demonstrated in <span><em class="italic">Figure 12</em></span><span><em class="italic">.1</em></span><span>:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer191"><img alt="Figure 12.1 – BEC attack phases" src="../images/00040.jpeg" class="calibre191"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.1 – BEC attack phases</p>
<p class="calibre3">Having observed the stages outlined in the figure, let’s dive into each phase with a <span>detailed breakdown:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Reconnaissance</strong>: In this phase, attackers meticulously study the victim organization’s hierarchy, communication patterns, and specific jargon used. If an attacker has access to an account already, they simply run searches within the email system to understand communication patterns and jargon at the organization. Otherwise, the attacker utilizes information that may be public about the company from various sources, such as LinkedIn and the victim organization’s website. Attackers may use publicly available information, social engineering tactics, or even previous data breaches to collect data. This reconnaissance phase allows them to craft convincing emails mimicking users from inside the organization and spoof or target specific accounts <span>of interest.</span>
<p class="calibre3">BEC attacks are typically not random mass mailings but are directed at specific individuals within an organization, such as those with authority over finances or access to confidential data. As an example, the CFO of an organization is commonly targeted as they not only have access to confidential financial information, but they have the authority to approve transactions at <span>the organization.</span></p>
</li>
<li class="calibre13"><strong class="bold">Email spoofing or account takeover</strong>: Attackers either spoof a legitimate email address or<a id="_idIndexMarker1054" class="pcalibre1 pcalibre2 pcalibre"/> gain unauthorized access to a legitimate account, often through phishing attacks or exploiting weak <span>security practices.</span>
<p class="calibre3">Attackers frequently create “fake” websites that appear to look the same as the login pages of popular productivity suites (Microsoft 365 or Google Workspace). They achieve this by manipulating HTML and CSS to replicate the styling of these legitimate sites. The domains of these fake sites are often slightly altered versions of the real ones, designed to appear as if they belong to the organization’s productivity suite tenant. For example, a fake domain for Microsoft 365 could be <strong class="source-inline">microsoft365-login.com</strong> instead of the legitimate <strong class="source-inline">microsoft.com</strong>, and for Google Workspace, it might be <strong class="source-inline">googledocs-signin.com</strong> instead of <strong class="source-inline">google.com</strong>. These fraudulent pages usually consist of forms designed to harvest and send back user credentials to the attackers. Unsuspecting users who enter their login details on these fake pages unintentionally provide attackers with access to their personal or corporate accounts, leading to <span>account compromise.</span></p>
<p class="calibre3">If attackers cannot gain access to accounts in the organization, they typically purchase domains that appear to be very similar to the organization instead. As an example, instead of <strong class="source-inline">ACME.com</strong>, <strong class="source-inline">AMCE.com</strong> is purchased from domain registrars so that the attacker can also create email accounts sharing domains that closely resemble legitimate user emails at the victim organization. As an example, <strong class="source-inline">Alice@AMCE.com</strong> would be set up and used by attackers to mimic a legitimate user and account for Alice from ACME. Most users would not catch the subtle change in the domain from ACME to AMCE in their <span>email correspondence.</span></p>
</li>
<li class="calibre13"><strong class="bold">Preparation</strong>: In this phase, the attacker prepares the tools and methods they will use to execute the attack. This could include crafting convincing phishing emails, creating fake invoices, or setting up bank accounts for receiving fraudulent payments. This is based on their objective and the type of BEC, which we will discuss in the <span>next section.</span></li>
<li class="calibre13"><strong class="bold">Exploitation</strong>: In this stage, the victim interacts with the email, leading to the attacker’s desired <a id="_idIndexMarker1055" class="pcalibre1 pcalibre2 pcalibre"/>outcome. For BEC, this often means complying with the instructions in the email, such as transferring funds or providing <span>confidential information.</span></li>
<li class="calibre13"><strong class="bold">Malware installation (if applicable)</strong>: While not always a part of BEC, in some cases, the attacker might use the opportunity to install malware on the victim’s system. This can be for long-term access, data exfiltration, or to facilitate further attacks. This is how attackers can pivot from the productivity suite account hosted and protected in the cloud to actual devices in the organization’s <span>IT network.</span></li>
<li class="calibre13"><strong class="bold">Actions on objectives</strong>: The ultimate goal of the attacker is realized in this stage. For BEC, this usually involves the unauthorized transfer of funds to the attacker’s account or the acquisition of sensitive information. The attacker’s objectives are achieved once they receive the funds or information they <span>were seeking.</span></li>
<li class="calibre13"><strong class="bold">Persistence and anti-forensics (if applicable)</strong>: In sophisticated BEC schemes, attackers might try to maintain access to the victim’s systems for future attacks or to hide evidence of their activities. This might involve setting up auto-forwarding rules outside the network, deletion of email evidence, creating backdoors in terms of application consents, or using other techniques to conceal <span>their</span><span><a id="_idIndexMarker1056" class="pcalibre1 pcalibre2 pcalibre"/></span><span> presence.</span></li>
</ul>
</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h2 id="_idParaDest-217" class="calibre10"><a id="_idTextAnchor231" class="pcalibre1 pcalibre2 pcalibre"/>Common types of BECs</h2>
<p class="calibre3">Now that we’ve explored the various phases of a BEC attack, let’s discuss the common types of BECs that <a id="_idIndexMarker1057" class="pcalibre1 pcalibre2 pcalibre"/>organizations <span>frequently encounter:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Invoice fraud</strong>: The scammer pretends to be a supplier or vendor of the target company, requesting payment for services or goods to a <span>fraudulent account.</span></li>
<li class="calibre13"><strong class="bold">C-suite fraud</strong>: Attackers pose as the company’s CEO or any high-ranking executive and send emails to employees, usually in the finance department, instructing them to transfer funds to an account controlled by <span>the attacker.</span></li>
<li class="calibre13"><strong class="bold">Attorney impersonation</strong>: Attackers pose as a lawyer or legal representative involved with the company, often under the guise of urgent and confidential matters, to misdirect funds or gain <span>sensitive information.</span></li>
<li class="calibre13"><strong class="bold">Data theft</strong>: Here, the objective is not necessarily immediate financial gain but the theft of sensitive data, which could be employee tax information, intellectual property, or <span>customer data.</span></li>
<li class="calibre13"><strong class="bold">Account compromise</strong>: An employee’s email account is hacked and then used to request payments from vendors listed in their <span>email contacts.</span></li>
<li class="calibre13"><strong class="bold">Credentials harvesting</strong>: An employee’s email account is hacked and then used to further harvest more credentials from outside the organization to trusted contracts <span>and vendors.</span></li>
<li class="calibre13"><strong class="bold">Motive for attackers</strong>: The primary motivation behind BEC attacks is financial gain. Attackers exploit the trust within business communication channels to divert funds or obtain sensitive information that can be monetized. Additionally, the data harvested from such attacks, such as credentials and employee personal information or intellectual property, can be sold on the dark web or used for further attacks, including repeat BEC attacks and ransomware. The sophisticated and targeted nature of these attacks often leads to a higher success rate and potentially greater financial rewards for the attackers, making BEC a lucrative form <span>of cybercrime.</span></li>
</ul>
<p class="calibre3">A deep understanding of the varied BEC attack types, from invoice fraud to data theft, is essential for effective defense against these sophisticated and financially motivated cyber threats. Identifying types of BEC allows both technical and business controls to prevent these <a id="_idIndexMarker1058" class="pcalibre1 pcalibre2 pcalibre"/>incidents. For example, organizations can implement controls to verbally verify transaction approvals over a set amount to prevent invoice and <span>C-suite fraud.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h1 id="_idParaDest-218" class="calibre5"><a id="_idTextAnchor232" class="pcalibre1 pcalibre2 pcalibre"/>Initial scoping and response</h1>
<p class="calibre3">When responding to a BEC attack as an incident responder, the <strong class="bold">initial scoping phase</strong> is critical for <a id="_idIndexMarker1059" class="pcalibre1 pcalibre2 pcalibre"/>understanding the breadth and depth of the incident. This phase involves gathering as much information as possible to assess the situation accurately. This initial scoping involves talking with the cloud productivity suite (Microsoft 365 or Google Workspace) IT administrators, organization general counsel, C-suite, and accounting staff to better understand the following, even before any technical <span>forensic analysis:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Timeline of the attack</strong>: Understanding when the attack started is crucial. Ask when the first signs of compromise were noticed and at what point users noticed anything suspicious. This could include unusual email activity, reports of suspicious emails from within or outside the organization, or financial transactions that were flagged as anomalous. If attackers were successful in transferring any unauthorized funds, note these dates in <span>the timeline.</span></li>
<li class="calibre13"><strong class="bold">Extent of the compromise</strong>: Determine which accounts have been compromised. This involves checking for signs of unauthorized access, such as login attempts from unfamiliar locations or devices, and changes in account settings or permissions that were not initiated by the account owners. If attackers were successful, IT administrators for the productivity suites would have already narrowed down on the accounts of interest. We will discuss how to determine evidence of compromise in the <em class="italic">Microsoft 365 incident response</em> and <em class="italic">Google Workspace incident </em><span><em class="italic">response</em></span><span> sections.</span></li>
<li class="calibre13"><strong class="bold">Attack vectors</strong>: Investigate how the attackers gained access. Was it through phishing emails, credential stuffing, or exploiting security vulnerabilities? Understanding the attack vector is essential for preventing future breaches. In some instances, users can recall at what points they may have entered their credentials to a phishing site. Furthermore, have the organization and/or individual users suffered a data breach in the past? If so, their username and credentials could be circulating on the dark web. It is not uncommon for employees to use their corporate email addresses for personal services. If those personal services <a id="_idIndexMarker1060" class="pcalibre1 pcalibre2 pcalibre"/>suffer a data breach, the employee’s corporate information may <span>be exposed.</span></li>
<li class="calibre13"><strong class="bold">Data exfiltration</strong>: Assess what information has been accessed or exfiltrated. This includes sensitive emails, attachments, and any data stored in the compromised accounts. Knowing the type of data exposed helps in understanding the potential impact of <span>the breach.</span></li>
<li class="calibre13"><strong class="bold">Communication with affected parties</strong>: Determine who has been affected by the breach, both internally and externally. This might include employees, customers, or business partners who have communicated with the <span>compromised accounts.</span></li>
<li class="calibre13"><strong class="bold">Security measures in place</strong>: Review the existing security measures. Were there any security protocols that were bypassed or ineffective? This could include multi-factor authentication, regular password changes, and employee training on recognizing <span>phishing attempts.</span></li>
<li class="calibre13"><strong class="bold">Previous incidents</strong>: Inquire if there have been previous similar incidents. Understanding past incidents can provide insights into potential weaknesses or repeated patterns of attacks. It has become much more common for repeat attacks, especially if attackers were successful in diverting funds in the past. They may see an organization as an easy <span>repeat target.</span></li>
<li class="calibre13"><strong class="bold">Current response actions</strong>: Check what actions have already been taken in response to the discovery of the attack. This can include changing passwords, disconnecting potentially compromised systems from the network, or notifying <span>affected individuals.</span></li>
<li class="calibre13"><strong class="bold">Microsoft 365 access</strong>: This is the most important step to actually kick off the response and investigation as an incident responder. You will require the organization’s Microsoft 365 administrator to create an account in their 365 tenant with the following roles. For the most part, the accesses required to respond to a 365<a id="_idIndexMarker1061" class="pcalibre1 pcalibre2 pcalibre"/> compromise are <span>as follows:</span><ul class="calibre17"><li class="calibre13"><span>Azure AD:</span><ul class="calibre17"><li class="calibre13"><span>Global reader</span></li><li class="calibre13"><span>Security reader</span></li></ul></li><li class="calibre13">Exchange online admin, a custom role with the <span>following permissions:</span><ul class="calibre17"><li class="calibre13"><span>Mail recipients</span></li><li class="calibre13">Security group creation <span>and memberships</span></li><li class="calibre13">View only <span>audit log</span></li><li class="calibre13">View <span>only configuration</span></li><li class="calibre13">View <span>only recipients</span></li></ul></li><li class="calibre13">Microsoft <span>Purview (compliance):</span><ul class="calibre17"><li class="calibre13"><span>Compliance administrator</span></li><li class="calibre13"><span>eDiscovery manager</span></li></ul></li></ul></li>
</ul>
<p class="calibre3">These role names are likely to change within the Microsoft ecosystem; however, the key here is that you will require some sort of global reader or security reader role to allow you to run searches in the <span>audit logs.</span></p>
<p class="calibre3">The initial scoping phase sets the stage for effective incident response by providing a clear picture<a id="_idIndexMarker1062" class="pcalibre1 pcalibre2 pcalibre"/> of the attack. Next, we will dive a bit deeper into triaging and forensics for Microsoft 365 and <span>Google Workspace.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h2 id="_idParaDest-219" class="calibre10"><a id="_idTextAnchor233" class="pcalibre1 pcalibre2 pcalibre"/>Remediation steps</h2>
<p class="calibre3">During the initial scoping<a id="_idIndexMarker1063" class="pcalibre1 pcalibre2 pcalibre"/> of the incident, regardless of whether it’s Microsoft 365 or Google Workspace, there are several steps that the organization can follow to ensure that the attacker is no longer in their environment prior to incident responders starting forensics. User interfaces and productivity suites change; however, the following steps are <span>always relevant:</span></p>

<ol class="calibre14">
<li class="calibre13">Reset the passwords of any accounts that were impacted or are suspected to <span>be compromised.</span></li>
<li class="calibre13">Enable <strong class="bold">multi-factor authentication</strong> (<strong class="bold">MFA</strong>) organization-wide or, at the very least, for <a id="_idIndexMarker1064" class="pcalibre1 pcalibre2 pcalibre"/><span>privileged accounts.</span></li>
<li class="calibre13">Remove any suspicious automation (i.e., email forwarding rules outside of the domain) and any suspicious inbox rules set inside the mailbox. We will discuss this further in the <span>upcoming section.</span></li>
<li class="calibre13">Remove compromised accounts from any privileged or elevated role at the organization. For example, compromised accounts belonging to IT administrators should temporarily have their accesses limited to prevent further <span>unauthorized activities.</span></li>
</ol>
<p class="calibre3">Despite any changes in productivity suites such as Microsoft 365 or Google Workspace, these high-level steps, including password resets and access limitations, are universally applicable and crucial for safeguarding against cyber threats in a productivity suite environment. The product’s UI and details may change; however, the steps remain <span>the same.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h1 id="_idParaDest-220" class="calibre5"><a id="_idTextAnchor234" class="pcalibre1 pcalibre2 pcalibre"/>Microsoft 365 incident response</h1>
<p class="calibre3">After the initial <a id="_idIndexMarker1065" class="pcalibre1 pcalibre2 pcalibre"/>scoping to understand the incident, the next step is to determine indicators of compromise and begin the threat hunt. This section delves into the tools and techniques that incident responders can employ to automate the log acquisition and analysis process, specifically to an organization that is utilizing Microsoft 365 as their cloud productivity suite. A key focus is on utilizing Microsoft 365’s built-in security and compliance tools, such as Microsoft Purview, to rapidly gather logs and track <span>suspicious activities.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h2 id="_idParaDest-221" class="calibre10"><a id="_idTextAnchor235" class="pcalibre1 pcalibre2 pcalibre"/>Tooling</h2>
<p class="calibre3">In <a href="part0026_split_000.html#_idTextAnchor137" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 7</em></span></a>, we <a id="_idIndexMarker1066" class="pcalibre1 pcalibre2 pcalibre"/>discussed the various auditing and compliance features in Microsoft 365, one of which was Microsoft unified audit logs. These logs provide a consolidated view of all Microsoft 365 activity and are critical for investigating and understanding the extent of the compromise. Here’s how incident responders can leverage the audit log search GUI in Microsoft 365 for <span>this purpose:</span></p>

<ol class="calibre14">
<li class="calibre13"><strong class="bold">Accessing the audit log search</strong>: The audit log search is accessible through Microsoft Purview. Incident responders need to navigate to the <strong class="bold">Audit</strong> section <span>to begin.</span></li>
<li class="calibre13"><strong class="bold">Scoping the incident</strong>: Before running a search, it’s crucial to complete the initial scoping of the incident, as we discussed in the previous section. This is because the initial scoping involves understanding the timeline of the incident, the suspected compromised accounts, and the nature of the activities that are of interest. This initial scoping helps in applying the right filters. Otherwise, incident responders will have to run general searches, which may take a while to execute and can be difficult to quickly analyze and <span>triage afterward.</span></li>
<li class="calibre13"><strong class="bold">Apply filters</strong>: The audit log search provides various filters to narrow down the <span>search results:</span><ul class="calibre17"><li class="calibre13"><strong class="bold">Date and time</strong>: Specify the time frame for <span>the incident</span></li><li class="calibre13"><strong class="bold">Activities</strong>: Filter by specific activities, such as file accesses, user logins, and <span>administrative actions</span></li><li class="calibre13"><strong class="bold">Users</strong>: Focus the search on specific user accounts that are suspected to <span>be compromised</span></li><li class="calibre13"><strong class="bold">File, folder, and site</strong>: Narrow down to specific files, folders, or SharePoint sites <span>if relevant</span></li></ul></li>
<li class="calibre13"><strong class="bold">Running the search</strong>: After applying the necessary filters, run the search. The GUI will display a list of events that match the criteria. Either classic or new searches can be used; however, note that classic searches will not save the history of the searches you conduct. Furthermore, classic searches are limited to only running concurrent <span>search jobs.</span></li>
<li class="calibre13"><strong class="bold">Exporting logs for detailed analysis</strong>: For a more in-depth analysis, users can export the search results to a CSV file. This allows for additional analysis using external tools for archiving purposes. The exported data includes detailed information about each event, such as the source IP address, user agent, and the exact <span>operations performed.</span></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">Exporting results through the audit search user interface is limited to only 10,0000 entries. As a result, it’s important to ensure that your search results are refined under 10,000 or search jobs are broken down into multiple batches to ensure all entries <span>are exported.</span></p>

<ol class="calibre14">
<li value="6" class="calibre13"><strong class="bold">Utilizing external tools</strong>: Once the logs are exported, incident responders can utilize various data analysis tools to sift through the data. Tools such as Excel, Power BI, or specialized forensic tools can be used to analyze patterns, create timelines, and correlate events across <span>different logs.</span></li>
<li class="calibre13"><strong class="bold">Analyzing results</strong>: Examine the results to identify any unusual or unauthorized <a id="_idIndexMarker1067" class="pcalibre1 pcalibre2 pcalibre"/>activities. Look for patterns or anomalies that could indicate malicious behavior. We will discuss analysis further in the <span>next section.</span></li>
</ol>
<h3 class="calibre11">Searching for and extracting 365 audit logs</h3>
<p class="calibre3">The following<a id="_idIndexMarker1068" class="pcalibre1 pcalibre2 pcalibre"/> figures <a id="_idIndexMarker1069" class="pcalibre1 pcalibre2 pcalibre"/>demonstrate how to run searches and extract the audit logs <span>in CSV:</span></p>

<ul class="calibre12">
<li class="calibre13">The following screenshot demonstrates the audit log search tab with available filters to further <span>refine queries:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer192"><img alt="Figure 12.2 – Microsoft 365 Audit search log tab" src="../images/00057.jpeg" class="calibre192"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.2 – Microsoft 365 Audit search log tab</p>

<ul class="calibre12">
<li class="calibre13">Search jobs<a id="_idIndexMarker1070" class="pcalibre1 pcalibre2 pcalibre"/> are<a id="_idIndexMarker1071" class="pcalibre1 pcalibre2 pcalibre"/> created on execution and listed below the audit log filters, <span>as demonstrated:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer193"><img alt="Figure 12.3 – Audit log search jobs" src="../images/00075.jpeg" class="calibre193"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.3 – Audit log search jobs</p>

<ul class="calibre12">
<li class="calibre13">Once search jobs are completed, results are organized in a table, <span>as shown:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer194"><img alt="Figure 12.4 – Audit log search results (UI)" src="../images/00095.jpeg" class="calibre194"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.4 – Audit log search results (UI)</p>

<ul class="calibre12">
<li class="calibre13">The next<a id="_idIndexMarker1072" class="pcalibre1 pcalibre2 pcalibre"/> figure is an example of successful login and failed <span>login events:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer195"><img alt="Figure 12.5 – Audit log search results – login events" src="../images/00116.jpeg" class="calibre195"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.5 – Audit log search results – login events</p>

<ul class="calibre12">
<li class="calibre13">The following figure demonstrates an example of an event’s <span><strong class="bold">Details</strong></span><span> pane:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer196"><img alt="Figure 12.6 – Audit log event details" src="../images/00139.jpeg" class="calibre196"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.6 – Audit log event details</p>

<ul class="calibre12">
<li class="calibre13">All search<a id="_idIndexMarker1073" class="pcalibre1 pcalibre2 pcalibre"/> results<a id="_idIndexMarker1074" class="pcalibre1 pcalibre2 pcalibre"/> can be exported as a CSV file, <span>as shown:</span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer197"><img alt="Figure 12.7 – Audit log export process" src="../images/00155.jpeg" class="calibre197"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.7 – Audit log export process</p>
<p class="calibre3">The resulting file is a CSV file; however, the majority of the fields will be stored in the <strong class="source-inline">AuditData</strong> column<a id="_idIndexMarker1075" class="pcalibre1 pcalibre2 pcalibre"/> in<a id="_idIndexMarker1076" class="pcalibre1 pcalibre2 pcalibre"/> the JSON format. The exported CSV is <span>as follows:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer198"><img alt="Figure 12.8 – Audit log export (CSV)" src="../images/00173.jpeg" class="calibre198"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.8 – Audit log export (CSV)</p>

<h3 class="calibre11">Extracting audit logs using PowerShell</h3>
<p class="calibre3">The unified <a id="_idIndexMarker1077" class="pcalibre1 pcalibre2 pcalibre"/>audit <a id="_idIndexMarker1078" class="pcalibre1 pcalibre2 pcalibre"/>logs can also be programmatically<a id="_idIndexMarker1079" class="pcalibre1 pcalibre2 pcalibre"/> extracted <span>using PowerShell:</span></p>

<ol class="calibre14">
<li class="calibre13">Open PowerShell as an administrator and navigate to your folder of choosing; for example, <span><strong class="source-inline">C:\Incident Response\</strong></span><span>.</span></li>
<li class="calibre13">Connect to the Microsoft 365 tenant with the <span>following commands:</span>
<pre class="source-code"><strong class="bold">Install-Module ExchangePowerShell</strong>
<strong class="bold">Install-Module AzureAD</strong>
<strong class="bold">Import-Module AzureAD</strong>
<strong class="bold">Import-Module ExchangePowerShell</strong>
<strong class="bold">Connect AzureAD</strong></pre></li> <li class="calibre13">Define a log time range (modify as needed; here, we will start with <span>30 days):</span>
<pre class="source-code"><strong class="bold">$StartDate = (Get-Date).AddDays(-30)</strong>
<strong class="bold">$EndDate = Get-Date</strong></pre></li> <li class="calibre13">Retrieve the audit logs using the <span><strong class="source-inline">Search-UnifiedAuditLog</strong></span><span> cmdlet:</span>
<pre class="source-code"><strong class="bold">$AuditLogs = Search-UnifiedAuditLog -StartDate $StartDate -EndDate $EndDate</strong></pre></li> <li class="calibre13">Export the log as <span>a CSV:</span>
<pre class="source-code"><strong class="bold">$AuditLogs | Export-Csv -Path "AuditLogs-last30.csv" -NoTypeInformation</strong></pre></li> <li class="calibre13">Release the 365 session (<span>i.e., disconnect):</span>
<pre class="source-code"><strong class="bold">Disconnect-MsolService</strong></pre></li> </ol>
<p class="calibre3">The resulting CSV will be very similar to the export generated through the user interface in <span><em class="italic">Figure 12</em></span><span><em class="italic">.8</em></span><span>.</span></p>

<h3 class="calibre11">Utilizing Microsoft Power Query</h3>
<p class="calibre3">Whether exported<a id="_idIndexMarker1080" class="pcalibre1 pcalibre2 pcalibre"/> through<a id="_idIndexMarker1081" class="pcalibre1 pcalibre2 pcalibre"/> the Purview user interface or programmatically, a large amount of the data and useful fields will be stored in JSON. As a result, incident responders must complete the additional step of parsing this data for it to be useful (or easily searchable). Incident responders can utilize a JSON parsing tool of their choice, but in this example, we will utilize Microsoft Power Query. Power Query can be employed to drill down into the bulk of JSON data. The process involves importing the CSV file into Excel and then using Power Query’s advanced data transformation capabilities to parse the JSON fields. This parsing translates the JSON data into a structured format that aligns with the traditional columns and rows of Excel. Users can expand the JSON fields into individual columns, making the data more accessible and easier to analyze. This transformation is crucial for incident responders who need to dissect and understand intricate details of user activities, security events, and system changes logged in the audit data column. By leveraging Microsoft’s Power Query, organizations can efficiently convert the complex JSON data into a more manageable and <span>analyzable format.</span></p>
<p class="calibre3">The steps to utilize Microsoft Power Query are <span>as follows:</span></p>

<ol class="calibre14">
<li class="calibre13">Starting with the unified audit log CSV, our next step is to create a new workbook in <span>Microsoft Excel:</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer199"><img alt="Figure 12.9 – Audit log results to be transformed" src="../images/00191.jpeg" class="calibre199"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.9 – Audit log results to be transformed</p>

<ol class="calibre14">
<li value="2" class="calibre13">Create <a id="_idIndexMarker1082" class="pcalibre1 pcalibre2 pcalibre"/>a <span>new</span><span><a id="_idIndexMarker1083" class="pcalibre1 pcalibre2 pcalibre"/></span><span> workbook:</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer200"><img alt="Figure 12.10 – New Excel workbook" src="../images/00010.jpeg" class="calibre200"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.10 – New Excel workbook</p>

<ol class="calibre14">
<li value="3" class="calibre13">Next, you will<a id="_idIndexMarker1084" class="pcalibre1 pcalibre2 pcalibre"/> need to<a id="_idIndexMarker1085" class="pcalibre1 pcalibre2 pcalibre"/> navigate to the <strong class="bold">Data</strong> tab and click on <strong class="bold">Get Data</strong> | <strong class="bold">From File</strong> | <span><strong class="bold">From Text/CSV</strong></span><span>.</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer201"><img alt="Figure 12.11 – Importing the audit data export" src="../images/00029.jpeg" class="calibre201"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.11 – Importing the audit data export</p>

<ol class="calibre14">
<li value="4" class="calibre13">Next, you will <a id="_idIndexMarker1086" class="pcalibre1 pcalibre2 pcalibre"/>import <a id="_idIndexMarker1087" class="pcalibre1 pcalibre2 pcalibre"/>the unified audit log CSV and click <strong class="bold">Transform Data</strong> to further drill down into the <strong class="source-inline">AuditData</strong> column, which contains the JSON. Note that Power Query is limited to the maximum number of rows filled to a worksheet (<span>i.e., 1,048,576).</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer202"><img alt="Figure 12.12 – Power Query options to load data" src="../images/00047.jpeg" class="calibre202"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.12 – Power Query options to load data</p>

<ol class="calibre14">
<li value="5" class="calibre13">Next, audit <a id="_idIndexMarker1088" class="pcalibre1 pcalibre2 pcalibre"/>data is<a id="_idIndexMarker1089" class="pcalibre1 pcalibre2 pcalibre"/> transformed using the <strong class="bold">Transform Data</strong> option. The results are shown in the <span>next figure:</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer203"><img alt="Figure 12.13 – Power Query results" src="../images/00063.jpeg" class="calibre203"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.13 – Power Query results</p>

<ol class="calibre14">
<li value="6" class="calibre13">Next, right-click<a id="_idIndexMarker1090" class="pcalibre1 pcalibre2 pcalibre"/> on <a id="_idIndexMarker1091" class="pcalibre1 pcalibre2 pcalibre"/>the <strong class="source-inline">AuditData</strong> column and click on <strong class="bold">Transform</strong> | <span><strong class="bold">JSON</strong></span><span>.</span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer204"><img alt="Figure 12.14 – Transforming the JSON data column" src="../images/00082.jpeg" class="calibre204"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.14 – Transforming the JSON data column</p>
<p class="calibre3">As shown<a id="_idIndexMarker1092" class="pcalibre1 pcalibre2 pcalibre"/> next, your<a id="_idIndexMarker1093" class="pcalibre1 pcalibre2 pcalibre"/> JSON data has now been transformed into CSV columns (for <span>example, </span><span><strong class="source-inline">AuditData.ClientIP</strong></span><span>):</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer205"><img alt="Figure 12.15 – Resulting CSV column" src="../images/00101.jpeg" class="calibre205"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.15 – Resulting CSV column</p>
<p class="calibre3">The following<a id="_idIndexMarker1094" class="pcalibre1 pcalibre2 pcalibre"/> figure <a id="_idIndexMarker1095" class="pcalibre1 pcalibre2 pcalibre"/>demonstrates the resulting data after the column has been transformed in <span>Power Query:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer206"><img alt="Figure 12.16 – Expanding the transformed column" src="../images/00123.jpeg" class="calibre206"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.16 – Expanding the transformed column</p>
<p class="calibre3">The result is a<a id="_idIndexMarker1096" class="pcalibre1 pcalibre2 pcalibre"/> CSV<a id="_idIndexMarker1097" class="pcalibre1 pcalibre2 pcalibre"/> file with all your audit data in a friendly, readable format to utilize Excel (or the tool of your choice) for <span>further analysis.</span></p>

<h3 class="calibre11">Cloud forensics using HAWK</h3>
<p class="calibre3">Incident<a id="_idIndexMarker1098" class="pcalibre1 pcalibre2 pcalibre"/> responders <a id="_idIndexMarker1099" class="pcalibre1 pcalibre2 pcalibre"/>can also utilize some open source tools based on<a id="_idIndexMarker1100" class="pcalibre1 pcalibre2 pcalibre"/> the Microsoft 365 API, such as <span>HAWK (</span><span>Github.com/T0pCyber/hawk</span><span>).</span></p>
<p class="calibre3"><strong class="bold">HAWK</strong> is a PowerShell-based tool for gathering information related to Microsoft 365 compromises. It searches and parses out a lot of useful information specific to a 365 compromise from the 365 configuration and the audit logs, such as the creation of new inbox rules, consent grants, a list of all users with administrator access, and much more. This simplifies the incident response process, as incident responders can find all information in their respective CSV as opposed to navigating to configurations in 365 or extracting it manually through the <span>audit logs.</span></p>
<p class="callout-heading">Important Note</p>
<p class="callout">The HAWK tool can be found <span>on GitHub:</span></p>
<p class="callout"><a href="https://github.com/T0pCyber/hawk" class="pcalibre1 pcalibre2 pcalibre"><span>https://github.com/T0pCyber/hawk</span></a></p>
<p class="callout">Here is the HAWK Module PowerShell <span>Gallery download:</span></p>
<p class="callout"><a href="https://www.powershellgallery.com/packages/HAWK/3.1.0" class="pcalibre1 pcalibre2 pcalibre"><span>https://www.powershellgallery.com/packages/HAWK/3.1.0</span></a></p>
<p class="callout">Here is the <span>HAWK documentation:</span></p>
<p class="callout"><a href="https://cloudforensicator.com/" class="pcalibre1 pcalibre2 pcalibre"><span>https://cloudforensicator.com/</span></a></p>
<p class="calibre3">To run HAWK, you require PowerShell on your system with administrator rights and an <span>internet connection:</span></p>

<ol class="calibre14">
<li class="calibre13">Open PowerShell as an administrator and navigate to the <strong class="source-inline">C:\Incident Response\</strong> folder using the <span><strong class="source-inline">cd</strong></span><span> command.</span></li>
<li class="calibre13">Install<a id="_idIndexMarker1101" class="pcalibre1 pcalibre2 pcalibre"/> the <a id="_idIndexMarker1102" class="pcalibre1 pcalibre2 pcalibre"/><span>HAWK</span><span><a id="_idIndexMarker1103" class="pcalibre1 pcalibre2 pcalibre"/></span><span> module:</span>
<pre class="source-code"><strong class="bold"> (Install-Module -Name Hawk)</strong></pre></li> <li class="calibre13">Install and import the Microsoft 365 Exchange Online management module and the Microsoft <span>365 module:</span>
<pre class="source-code"><strong class="bold">Install-Module -Name ExchangeOnlineManagement</strong>
<strong class="bold">Install-Module MSOnline</strong>
<strong class="bold">Install-Module AzureAD</strong>
<strong class="bold">Install-Module ExchangePowerShell</strong>
<strong class="bold">Import-Module AzureAD</strong>
<strong class="bold">Import-Module ExchangeOnlineManagement</strong>
<strong class="bold">Import-Module ExchangePowerShell</strong></pre></li> <li class="calibre13">Log in to the impacted 365 tenant with the following commands and authenticate with your Microsoft 365 username <span>and password:</span>
<pre class="source-code"><strong class="bold">Connect-AzureAD</strong>
<strong class="bold">Connect-MsolService</strong></pre></li> <li class="calibre13">Create a folder for your 365 files generated by HAWK. For this example, we will use <span><strong class="source-inline">C:\Incident Response\</strong></span><span>.</span></li>
<li class="calibre13">Run the <span>HAWK tool:</span>
<pre class="source-code"><strong class="bold"> Start-HawkTenantInvestigation</strong></pre></li> </ol>
<p class="calibre3">An example of the resulting files is shown in the <span>following figure:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer207"><img alt="Figure 12.17 – HAWK results" src="../images/00144.jpeg" class="calibre207"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.17 – HAWK results</p>
<p class="calibre3">As mentioned in HAWK’s GitHub, HAWK is designed to quickly get incident responders the data they <a id="_idIndexMarker1104" class="pcalibre1 pcalibre2 pcalibre"/>need. It is<a id="_idIndexMarker1105" class="pcalibre1 pcalibre2 pcalibre"/> not<a id="_idIndexMarker1106" class="pcalibre1 pcalibre2 pcalibre"/> meant to complete the analysis for you. A full breakdown of all generated log files can be found on the HAWK <span>documentation page.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h2 id="_idParaDest-222" class="calibre10"><a id="_idTextAnchor236" class="pcalibre1 pcalibre2 pcalibre"/>Analysis</h2>
<p class="calibre3">The goal of our analysis is<a id="_idIndexMarker1107" class="pcalibre1 pcalibre2 pcalibre"/> to identify any evidence of compromise. The very first piece of analysis to be conducted is determining evidence of unauthorized access. This is best determined by identifying login events by using the <strong class="source-inline">Activity</strong> or <strong class="source-inline">Operation</strong> column in the unified audit logs in Microsoft 365. This column records the specific action that has been performed within the environment. In essence, it serves as a detailed ledger of activities, ranging from file access and sharing to administrative changes and login events. Each entry in the <strong class="source-inline">Operation</strong> column is tagged with a descriptive label that identifies the nature of the action, making it a valuable resource for <span>incident responders.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">All audited activities (i.e., operations) can be found in Microsoft’s documentation <span>at </span><a href="https://learn.microsoft.com/en-us/purview/audit-log-activities" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/purview/audit-log-activities</span></a><span>.</span></p>
<p class="calibre3">The first step to determine compromise is filtering for <strong class="source-inline">UserLoggedIn</strong> events, which is essential for monitoring and investigating unauthorized access. By analyzing these events, incident responders can track when and how users log into the system, providing crucial insights into threat <span>actor behavior.</span></p>
<p class="calibre3">For instance, an<a id="_idIndexMarker1108" class="pcalibre1 pcalibre2 pcalibre"/> unusual pattern of login activities, such as logins at unusual hours or from unexpected locations, can be early indicators of unauthorized access. This will allow incident responders to determine any indicators related to the compromise, such as login user agent strings and <span>IP addresses.</span></p>
<p class="calibre3">The strongest indicator in terms of login activity will not be analyzing unusual login times but analyzing the location of IPs associated with the login events. This can be done by filtering the unified audit logs by the <strong class="source-inline">UserLoggedIn</strong> events and looking up the associated IP addresses (the <strong class="source-inline">ClientIP</strong> field in <strong class="source-inline">AuditData</strong>) with any bulk IP address lookup software (such as <strong class="source-inline">ipinfo.io</strong>). See <span><em class="italic">Figure 12</em></span><em class="italic">.18</em> and <span><em class="italic">Figure 12</em></span><em class="italic">.19</em> for an example <span>of this:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer208"><img alt="Figure 12.18 – Client IP audit data" src="../images/00161.jpeg" class="calibre208"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.18 – Client IP audit data</p>
<p class="calibre3">These IPs can<a id="_idIndexMarker1109" class="pcalibre1 pcalibre2 pcalibre"/> be copied to a lookup IP service that will give you the specific cities, regions, and countries associated with each IP. For example, looking up one of the IPs starting with <strong class="source-inline">69</strong> on IPinfo provides information stating that the user had logged in from an IP based in <span>Minnesota, USA.</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer209"><img alt="Figure 12.19 – IPInfo.io lookup results" src="../images/00180.jpeg" class="calibre209"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.19 – IPInfo.io lookup results</p>
<p class="calibre3">The geographical <a id="_idIndexMarker1110" class="pcalibre1 pcalibre2 pcalibre"/>information can be exported from your geo IP lookup service of choice and compared against all users in your audit log. As an incident responder, your next step is to determine whether the geographic location aligns with the organization’s business operations or if the user was confirmed in the IP’s location on that date. If the user had not traveled to the location, the user account can be deemed compromised. Incident responders can also analyze other pieces of the IP information, such as VPN/proxy use, or see if the hosting provider does not align with the user’s normal (baseline) <span>IP address.</span></p>
<p class="calibre3">Continuing from analyzing unusual login locations, another key threat-hunting task for incident responders is checking for changes in mailbox rules. <strong class="bold">Mailbox rules</strong> are automatic <a id="_idIndexMarker1111" class="pcalibre1 pcalibre2 pcalibre"/>actions triggered by incoming emails. If attackers get into a user’s account, they can secretly make or change rules. These unauthorized rules might redirect emails to other accounts, delete specific messages, or manage phishing emails to avoid being caught. The key operations to focus on are <span>as follows:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">New-InboxRule</strong>: This<a id="_idIndexMarker1112" class="pcalibre1 pcalibre2 pcalibre"/> operation is logged when a new mailbox rule is created. Incident responders should scrutinize any instance of this operation, paying close attention to rules that forward emails to external domains, automatically delete messages, or sort emails in a suspicious manner. A sudden increase in the creation of new rules, especially those with unusual criteria, should raise <span>an alert.</span></li>
<li class="calibre13"><strong class="bold">Set-InboxRule</strong>: This indicates modifications to existing mailbox rules. Alterations to established rules, especially those that change the rule’s action or condition, can be a sign of an attacker trying to manipulate email <span>flow subtly.</span></li>
<li class="calibre13"><strong class="bold">Remove-InboxRule</strong>: The deletion of mailbox rules is captured under this operation. While it might seem benign, the removal of certain rules, particularly security-related ones, can be a tactic used by attackers to reduce detection of <span>their activities.</span></li>
<li class="calibre13"><strong class="bold">New-TransportRule and Set-TransportRule</strong>: These operations are associated with the creation and modification of transport rules, which are more complex and can control email flow at the organizational level. Unauthorized changes here could have <span>widespread implications.</span></li>
</ul>
<p class="calibre3">For example, the <a id="_idIndexMarker1113" class="pcalibre1 pcalibre2 pcalibre"/>next screenshot is from a compromised 365 incident where threat actors had created a new inbox rule called <strong class="source-inline">zz</strong>. This inbox rule automatically deletes any emails that contain the following words in the subject line or body: “scam”, “fraud”, “phish”, and an email address that has been sanitized for privacy reasons. This is because the attacker is trying to cover their tracks such that any emails or warnings from others related to their objective, that is, to “scam” or “fraud” the organization out of money, will be automatically deleted, and as a result, the threat attacker can complete their <span>attack unnoticed.</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer210"><img alt="Figure 12.20 – Example malicious inbox rule" src="../images/00199.jpeg" class="calibre210"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.20 – Example malicious inbox rule</p>
<p class="calibre3">In addition to monitoring these specific operations, correlating this information with other login data, such as login locations and times, can provide a more comprehensive picture of the attacker’s activities. For example, the creation of a new inbox rule immediately following a login from an unusual geographic location can be a strong indicator of a <span>compromised account.</span></p>
<p class="calibre3">When addressing the issue of data exfiltration in Microsoft 365 compromises, incident responders need to focus on specific operations within the audit logs that can indicate unauthorized data movement or access. Data exfiltration can occur in various ways, such as through Outlook synchronization, accessing data via a web browser, or other activities. Understanding<a id="_idIndexMarker1114" class="pcalibre1 pcalibre2 pcalibre"/> these nuances is vital for identifying <span>potential breaches:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Outlook client synchronization (via SyncFolderItems operation)</strong>: This operation is logged when a user’s Outlook client syncs with the mailbox. Excessive or unusual sync activities, especially from unfamiliar devices or locations, can indicate that someone is trying to download a large amount of data. Comparing the volume and frequency of these sync operations against typical user behavior can <span>reveal anomalies.</span></li>
<li class="calibre13"><strong class="bold">Web browser access (MailItemsAccessed operation)</strong>: This operation is crucial for monitoring access to mail items via web browsers. An increase in the <strong class="source-inline">MailItemsAccessed</strong> events, especially from attacker IP addresses, suggests not only unauthorized access but that the threat actors viewed the contents of those <span>mail items.</span></li>
<li class="calibre13"><strong class="bold">File and document access operations</strong>: Operations such as <strong class="source-inline">FileDownloaded</strong>, <strong class="source-inline">FileCopied</strong>, <strong class="source-inline">FileMoved</strong>, and <strong class="source-inline">FileDeleted</strong> within SharePoint or OneDrive for Business are key indicators. These actions, particularly in high volumes or from atypical locations, can signal that someone is <span>exfiltrating data.</span></li>
<li class="calibre13"><strong class="bold">Email forwarding rules (New-InboxRule, Set-InboxRule)</strong>: As with mailbox compromises, the creation or modification of inbox rules that automatically forward emails to external addresses can be a method of <span>data exfiltration.</span></li>
<li class="calibre13"><strong class="bold">eDiscovery search and export operations (SearchQueryInitiated, SearchQueryPerformed, ExportStarted)</strong>: These operations indicate that someone is performing searches and possibly exporting data from eDiscovery, which can be a sophisticated way of extracting large datasets for <span>malicious purposes.</span></li>
<li class="calibre13"><strong class="bold">Unusual sending patterns (Send and SendAs operations)</strong>: A spike in email sending activities, especially those with large attachments or sent to external recipients, might indicate an attempt to exfiltrate data <span>via email.</span></li>
</ul>
<p class="callout-heading">Important note</p>
<p class="callout">All mailbox audited activities (i.e., operations) can be found in Microsoft’s documentation <span>at </span><a href="https://learn.microsoft.com/en-us/purview/audit-mailboxes" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/purview/audit-mailboxes</span></a><span>.</span></p>
<p class="calibre3">One of the key questions that organizations must answer during a productivity suite breach is whether<a id="_idIndexMarker1115" class="pcalibre1 pcalibre2 pcalibre"/> data was exfiltrated by attackers. Analyzing the outlined operations will allow incident responders to better understand the scope of the incident from a data <span>breach perspective.</span></p>
<p class="calibre3">Incident responders should also consider reviewing the following valuable sources of information in the context of a <span>365 compromise:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Impersonation rights</strong>: These rights allow a user to perform actions on behalf of another user. Incident responders should check for unexpected or unauthorized assignments of impersonation rights. This can be done by reviewing the role assignments for <span>each user.</span></li>
<li class="calibre13"><strong class="bold">List of Azure Active Directory administrators</strong>: Reviewing the current Azure <strong class="bold">Active Directory</strong> (<strong class="bold">AD</strong>) administrators <a id="_idIndexMarker1116" class="pcalibre1 pcalibre2 pcalibre"/>is important. You can view this list in the Azure AD admin center. Look for any unfamiliar accounts or changes in administrator roles, as attackers can elevate privileges to gain wider access in a <span>365 compromise.</span></li>
<li class="calibre13"><strong class="bold">List of Azure AD users</strong>: Incident responders should audit a list of all users in Azure AD. Pay special attention to newly created users, especially those with high privileges. Check this list through the Azure AD admin center. Unexpected user accounts can be a sign that an attacker has <span>created backdoors.</span></li>
<li class="calibre13"><strong class="bold">Consent grants</strong>: These are permissions granted to applications to access user data. Review the consent grants in the Azure AD admin center for any unusual or broad permissions granted to unknown or suspicious applications. Excessive permissions can be abused for data access <span>and exfiltration.</span></li>
<li class="calibre13"><strong class="bold">eDiscovery roles</strong>: Users with eDiscovery roles can search and export content from mailboxes and sites. Check who has been assigned these roles in Microsoft Purview. Though unlikely, unauthorized eDiscovery role assignments can indicate an attempt to illicitly access and export <span>sensitive data.</span></li>
<li class="calibre13"><strong class="bold">Exchange online administrators</strong>: It’s important to regularly review who has administrative privileges in Exchange Online, as these accounts have significant control over email operations. Check for any unexpected changes or additions in the Exchange <span>admin center.</span></li>
<li class="calibre13"><strong class="bold">Transport rules (mail flow)</strong>: These are rules set up in Exchange Online to control mail flow. Review the transport rules for any that redirect or copy emails to external domains, which can be a method of <span>data exfiltration.</span></li>
</ul>
<p class="calibre3">All of these sources<a id="_idIndexMarker1117" class="pcalibre1 pcalibre2 pcalibre"/> for analysis can be reviewed by the CSVs that are generated by the HAWK tool, as demonstrated in <span><em class="italic">Figure 12</em></span><span><em class="italic">.17</em></span><span>.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h1 id="_idParaDest-223" class="calibre5"><a id="_idTextAnchor237" class="pcalibre1 pcalibre2 pcalibre"/>Google Workspace incident response</h1>
<p class="calibre3">After understanding the basics <a id="_idIndexMarker1118" class="pcalibre1 pcalibre2 pcalibre"/>of an incident as we have discussed in the <em class="italic">Initial scoping and response</em> section, incident responders using Google Workspace face the challenge of identifying compromises and starting threat hunting. <strong class="bold">Google Workspace</strong>, unlike Microsoft 365, offers<a id="_idIndexMarker1119" class="pcalibre1 pcalibre2 pcalibre"/> fewer tools for this purpose, focusing mainly on its audit and reporting features. These tools, while not as extensive, are crucial for collecting logs and spotting unusual activities. This means responders often need to supplement these tools with external resources and more hands-on analysis to effectively track and investigate potential security breaches in<a id="_idIndexMarker1120" class="pcalibre1 pcalibre2 pcalibre"/> Google <span>Workspace environments.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h2 id="_idParaDest-224" class="calibre10"><a id="_idTextAnchor238" class="pcalibre1 pcalibre2 pcalibre"/>Tooling</h2>
<p class="calibre3">In a similar vein to our <a id="_idIndexMarker1121" class="pcalibre1 pcalibre2 pcalibre"/>discussion on Microsoft 365, let’s explore how incident responders can leverage audit logs in Google Workspace to investigate and understand the extent <span>of compromises:</span></p>

<ol class="calibre14">
<li class="calibre13"><strong class="bold">Accessing the audit logs</strong>: In Google Workspace, the audit logs are accessible through the Admin console. Incident responders can find these logs by navigating to the <strong class="bold">Reports</strong> section and then to the <span><strong class="bold">Audit</strong></span><span> subsection.</span>
<p class="calibre3">As with Microsoft 365, the initial step involves understanding the incident’s timeline, identifying potentially compromised accounts, and determining the nature of suspicious activities. This understanding helps to apply the right filters in the audit logs, making the search more efficient <span>and focused.</span></p>
</li>
<li class="calibre13"><strong class="bold">Applying filters in audit log search</strong>: Google Workspace’s audit log search offers various filters to <span>refine searches:</span><ul class="calibre17"><li class="calibre13"><strong class="bold">Date and time</strong>: Set the specific time frame <span>of interest</span></li><li class="calibre13"><strong class="bold">Events</strong>: Choose from a range of activities, such as email sent, file shared, admin activity, <span>and more</span></li><li class="calibre13"><strong class="bold">Users</strong>: Focus on specific user accounts <span>under suspicion</span></li><li class="calibre13"><strong class="bold">Applications</strong>: Filter by specific Google Workspace applications, such as Gmail, Drive, and Calendar, <span>if relevant</span></li></ul></li>
<li class="calibre13"><strong class="bold">Running the search</strong>: After setting the filters, run the search. The results will display a list of events that fit the criteria, which can then be reviewed for any <span>suspicious activity.</span></li>
<li class="calibre13"><strong class="bold">Exporting logs for analysis</strong>: Google Workspace allows the exporting of search results for more detailed analysis. These exports can include comprehensive event information such as IP addresses, actions taken, and <span>affected resources.</span></li>
<li class="calibre13"><strong class="bold">Utilizing external tools for analysis</strong>: Once exported, the logs can be further analyzed using tools such as Excel or other data analysis software. This step is crucial for spotting patterns, creating timelines, and correlating events across <span>different logs.</span></li>
<li class="calibre13"><strong class="bold">Analyzing results</strong>: Carefully examine the audit log entries for unusual or unauthorized activities. Look for anomalies or patterns that could suggest malicious behavior, such as mass file downloads, unusual login times, or unexpected external <a id="_idIndexMarker1122" class="pcalibre1 pcalibre2 pcalibre"/>sharing of documents. This is further discussed in the upcoming <span><em class="italic">Analysis</em></span><span> section.</span></li>
</ol>
<p class="callout-heading">Important note</p>
<p class="callout">Similar to Microsoft 365, exporting results from Google Workspace audit logs may have limitations in terms of the number of entries that one can export. It’s important to ensure that your search is precise enough to capture all relevant data without exceeding these limits (typically <span>100,000 entries).</span></p>

<h4 class="calibre136">Searching and extracting Google Workspace logs</h4>
<p class="calibre3">As discussed in <a href="part0026_split_000.html#_idTextAnchor137" class="pcalibre1 pcalibre2 pcalibre"><span><em class="italic">Chapter 7</em></span></a>, Google <a id="_idIndexMarker1123" class="pcalibre1 pcalibre2 pcalibre"/>Workspace provides a range of audit logs, each tailored to different applications and activities. Key logs include <span>the following:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Admin activity logs</strong>: Track administrative actions such as changes to settings or <span>user management</span></li>
<li class="calibre13"><strong class="bold">Login logs</strong>: Monitor user sign-in attempts, successful or otherwise, which is crucial for identifying unauthorized <span>access attempts</span></li>
<li class="calibre13"><strong class="bold">Drive audit logs</strong>: Essential for tracking file sharing and access within <span>Google Drive</span></li>
<li class="calibre13"><strong class="bold">Gmail logs</strong>: Monitor for unusual email activities, such as mass deletions or <span>forwarding rules</span></li>
</ul>
<p class="calibre3">To export the Google Workspace’s audit logs, incident responders can follow <span>these steps:</span></p>

<ol class="calibre14">
<li class="calibre13">In the Google Workspace admin console (<strong class="source-inline">admin.google.com</strong>), go to <strong class="bold">Reports</strong> and then <strong class="bold">Audit </strong><span><strong class="bold">and Investigations.</strong></span></li>
<li class="calibre13">Choose the specific audit log (e.g., admin log events, user log events, and group <span>log events).</span></li>
<li class="calibre13">Apply the necessary filters and run <span>the search.</span></li>
</ol>
<p class="calibre3">Once the results <a id="_idIndexMarker1124" class="pcalibre1 pcalibre2 pcalibre"/>are displayed, use the <strong class="bold">Download</strong> or <strong class="bold">Export</strong> option to save the data for <span>further analysis.</span></p>
<p class="calibre3">The exported logs can be in the CSV format, making it easier to import into data analysis tools. When using tools such as Excel, responders can sort, filter, and use functions to analyze the data <span>more effectively.</span></p>
<p class="calibre3">The following figures demonstrate the steps to export the audit events. Start by navigating to the <strong class="bold">Reporting</strong> and then going to the <strong class="bold">Audit and investigation</strong> tab, <span>as shown</span><span>:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer211"><img alt="Figure 12.21 – Reporting tab" src="../images/00016.jpeg" class="calibre211"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.21 – Reporting tab</p>
<p class="calibre3">The following<a id="_idIndexMarker1125" class="pcalibre1 pcalibre2 pcalibre"/> screenshot demonstrates all available logs under the <strong class="bold">Audit and investigation</strong> tab in the Google Workspace <span>administrative console:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer212"><img alt="Figure 12.22 – Audit and investigations" src="../images/00035.jpeg" class="calibre212"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.22 – Audit and investigations</p>
<p class="calibre3">Similar to Microsoft 365 audit log searches, filters can be set, as shown in <span>this figure:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer213"><img alt="Figure 12.23 – User events" src="../images/00052.jpeg" class="calibre213"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.23 – User events</p>
<p class="calibre3">An example <a id="_idIndexMarker1126" class="pcalibre1 pcalibre2 pcalibre"/>of the exported data is <span>shown here:</span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer214"><img alt="Figure 12.24 – Exported user events" src="../images/00070.jpeg" class="calibre214"/></div>
</div>
<p class="img---caption" lang="en-US">Figure 12.24 – Exported user events</p>
<p class="calibre3">Next, we will dive into the analysis portion of a Google Workspace compromise. A similar process to<a id="_idIndexMarker1127" class="pcalibre1 pcalibre2 pcalibre"/> the Microsoft 365 analysis is to be followed for Google Workspace with a difference in audit logs and their syntax. The principles of verifying unusual logins remain <span>the same.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h2 id="_idParaDest-225" class="calibre10"><a id="_idTextAnchor239" class="pcalibre1 pcalibre2 pcalibre"/>Analysis</h2>
<p class="calibre3">An analysis of a compromised <a id="_idIndexMarker1128" class="pcalibre1 pcalibre2 pcalibre"/>Google Workspace environment requires focusing on mainly user and admin events. Incident responders need to thoroughly investigate these logs to identify evidence of unauthorized access and other indicators of compromise, similar to Microsoft 365, but this time in the <span>Google ecosystem:</span></p>

<ul class="calibre12">
<li class="calibre13"><strong class="bold">Login audit log analysis (user </strong><span><strong class="bold">log events)</strong></span><span>:</span><ul class="calibre17"><li class="calibre13"><strong class="bold">Key events</strong>: Focus on <strong class="bold">Successful login</strong> and <strong class="bold">Login failure</strong> events. These indicate successful and unsuccessful <span>login attempts.</span></li><li class="calibre13"><strong class="bold">Patterns to look for</strong>: Repeated login failures followed by a success, particularly from varied IP addresses or geographic locations, could signal brute <span>force attempts.</span></li><li class="calibre13"><strong class="bold">IP and geolocation analysis</strong>: Compare the IP addresses from the logs against the user’s typical login locations. Discrepancies in geolocation data can be a strong indicator of <span>unauthorized access.</span></li></ul></li>
<li class="calibre13"><strong class="bold">Gmail (Email) </strong><span><strong class="bold">log investigation</strong></span><span>:</span><ul class="calibre17"><li class="calibre13"><strong class="bold">Critical events</strong>: Look for <strong class="bold">Email sent</strong>, <strong class="bold">Email read</strong>, and <strong class="bold">Email </strong><span><strong class="bold">deleted</strong></span><span> activities.</span></li><li class="calibre13"><strong class="bold">Anomalies to detect</strong>: High volumes of outbound emails to unknown addresses, bulk <a id="_idIndexMarker1129" class="pcalibre1 pcalibre2 pcalibre"/>deletion of emails, or opening numerous emails in a short time frame can suggest account takeover. Furthermore, look into the creation and modification of any inbox rules, similar to what we discussed in the <em class="italic">Microsoft 365 incident </em><span><em class="italic">response</em></span><span> section.</span></li></ul></li>
<li class="calibre13"><strong class="bold">Admin activity </strong><span><strong class="bold">log review</strong></span><span>:</span><ul class="calibre17"><li class="calibre13"><strong class="bold">Significant events</strong>: Monitor <strong class="bold">User creation</strong>, <strong class="bold">User role change</strong>, and <strong class="bold">Service </strong><span><strong class="bold">settings changed</strong></span><span>.</span></li><li class="calibre13"><strong class="bold">Red flags</strong>: Unauthorized creation of new users, escalation of privileges, or alterations in security settings are critical areas <span>of concern.</span></li></ul></li>
<li class="calibre13"><strong class="bold">OAuth token </strong><span><strong class="bold">activity monitoring</strong></span><span>:</span><ul class="calibre17"><li class="calibre13"><strong class="bold">Key events</strong>: Track <strong class="bold">Token granted</strong> and <strong class="bold">Token </strong><span><strong class="bold">revoked</strong></span><span> actions.</span></li><li class="calibre13"><strong class="bold">Concerning observations</strong>: The granting of tokens to unfamiliar third-party applications or an unusual pattern of token revocations can indicate that an attacker is trying to access data <span>or services.</span></li></ul></li>
<li class="calibre13"><strong class="bold">Groups audit </strong><span><strong class="bold">log examination</strong></span><span>:</span><ul class="calibre17"><li class="calibre13"><strong class="bold">Crucial events</strong>: Monitor <strong class="bold">Group member added</strong> and <strong class="bold">Group </strong><span><strong class="bold">settings changed</strong></span><span>.</span></li><li class="calibre13"><strong class="bold">Indicators of compromise</strong>: An indicator is the addition of unknown members to critical groups or unauthorized changes in group settings, particularly in groups with access to <span>sensitive information.</span></li></ul></li>
</ul>
<p class="calibre3">For each of these areas, incident responders should employ a context-driven approach. This involves looking beyond the mere occurrence of events to understanding their relevance in the broader context of user behavior and organizational norms. Analyzing the frequency, timing, and pattern deviations is crucial. We saw earlier in the <em class="italic">Microsoft 365 incident response</em> section how the login IPs can be looked up with an IP lookup service to better understand<a id="_idIndexMarker1130" class="pcalibre1 pcalibre2 pcalibre"/> unauthorized access—the same process can be followed for <span>Google Workspace.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">Google Workspace’s UI and syntax may change in the future, as these are active products being developed by their teams. As a result, some of the event names may change, but their principles are the same (for example, <strong class="bold">Successful login</strong> could change to <strong class="bold">Login success</strong> or <span>vice versa).</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h1 id="_idParaDest-226" class="calibre5"><a id="_idTextAnchor240" class="pcalibre1 pcalibre2 pcalibre"/>Summary</h1>
<p class="calibre3">In this final chapter on analyzing compromised cloud productivity suites, we explored how to tackle security incidents in the two most popular cloud-based productivity suites, Microsoft 365 and Google Workspace. These platforms, crucial for emails, storage, and office applications, are frequently targeted in BEC attacks. BEC, a sophisticated form of cyber fraud, often involves attackers gaining unauthorized access through email spoofing or account takeovers, leading to broader <span>security breaches.</span></p>
<p class="calibre3">The chapter provided a guide to understanding BEC, its phases, and attacker methods. It then outlined crucial steps for initial scoping and remediation, essential for effective incident response. For Microsoft 365, it focused on using tools such as unified audit logs and Microsoft Purview for log analysis. It also discussed an open source PowerShell-based tool, HAWK, for streamlined <span>data collection.</span></p>
<p class="calibre3">In contrast, Google Workspace incident response was discussed, with its more limited, yet vital, set of audit and reporting tools. The process involves using Google Workspace’s audit logs to identify suspicious activities. This chapter equipped you with the knowledge to effectively respond to incidents in both Microsoft 365 and <span>Google Workspace.</span></p>

</div>
</div>


<div id="sbo-rt-content" class="calibre1">
<div id="_idContainer215" class="calibre2">
<h1 id="_idParaDest-227" class="calibre5"><a id="_idTextAnchor241" class="pcalibre1 pcalibre2 pcalibre"/>Further reading</h1>
<ul class="calibre12">
<li class="calibre13"><em class="italic">Microsoft </em><span><em class="italic">Purview</em></span><span>: </span><a href="https://learn.microsoft.com/en-us/purview/" class="pcalibre1 pcalibre2 pcalibre"><span>https://learn.microsoft.com/en-us/purview/</span></a></li>
<li class="calibre13"><em class="italic">What is a Business Email Compromise (</em><span><em class="italic">BEC)</em></span><span>—Microsoft: </span><a href="https://www.microsoft.com/en-ca/security/business/security-101/what-is-business-email-compromise-bec" class="pcalibre1 pcalibre2 pcalibre"><span>https://www.microsoft.com/en-ca/security/business/security-101/what-is-business-email-compromise-bec</span></a></li>
<li class="calibre13"><em class="italic">Identify and secure compromised accounts</em>—Google <span>Workspace: </span><a href="https://support.google.com/a/topic/1355151?hl=en&amp;ref_topic=1258984&amp;sjid=10797876945924014941-NC" class="pcalibre1 pcalibre2 pcalibre"><span>https://support.google.com/a/topic/1355151?hl=en&amp;ref_topic=1258984&amp;sjid=10797876945924014941-NC</span></a></li>
</ul></div>
</div>
</body></html>