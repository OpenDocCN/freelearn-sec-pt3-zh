<html><head></head><body>
		<div><h1 id="_idParaDest-84"><em class="italic">Chapter 4</em>: <a id="_idTextAnchor087"/>Azure Network Security</h1>
			<p>In <a href="B15414_01_Final_JM_ePub.xhtml#_idTextAnchor021"><em class="italic">Chapter 1</em></a>,<em class="italic"> Azure Security Introduction</em>, we briefly touched on network security in Azure, but only discussed how network security is handled by Microsoft inside Azure data centers. As the network also falls under the shared responsibility model, in this chapter, we will discuss network security from a user aspect and how to handle the security we are responsible for.</p>
			<p>We will cover the following topics in this chapter:</p>
			<ul>
				<li>Understanding Azure Virtual Network</li>
				<li>Considering other virtual networks' security</li>
				<li>Understanding Azure Application Gateway</li>
				<li>Understanding Azure Front Door</li>
			</ul>
			<h1 id="_idParaDest-85"><a id="_idTextAnchor088"/>Understanding Azure Virtual Network</h1>
			<p>The first step in the transition from an on-premises<a id="_idIndexMarker242"/> environment to the cloud is <strong class="bold">Infrastructure as a Service</strong> (<strong class="bold">IaaS</strong>). One of the key elements in IaaS is <strong class="bold">Virtual Networks</strong> (<strong class="bold">VNets</strong>). VNets are a virtual representation of our local network with IP address ranges, subnets, and all other network components that we would find in local infrastructure. Recently, we have seen a lot of cloud network components introduced to on-premises networks as well, with the introduction of <strong class="bold">Software Defined Networking </strong>(<strong class="bold">SDN</strong>) in OS Windows Server 2016.</p>
			<p>Before we start looking at VNet security, let's remember that naming standards should be applied to all Azure resources, and networking is no exception. As environments grow, this will help you have better control over your environment, easier management, and more insight into your security posture.</p>
			<p>Each VNet that we create is a completely isolated piece of network in Azure. We can create multiple VNets inside one subscription, or even multiple VNets inside one region. There is no direct communication between any VNets, even those created inside a single subscription or region, unless configured otherwise. The first thing that needs to be <a id="_idIndexMarker243"/>configured for a VNet is the IP address range. The next thing we need is a subnet with its own range. One VNet can have multiple subnets. Each subnet must have its own IP address range within the VNet's IP address range and cannot overlap with other subnets in the same VNet. </p>
			<p>One thing we need to consider when defining the IP address range is that it should not overlap with other VNets we use. Even when there is no initial requirement to create a connection between different VNets, this may become a requirement in the future. </p>
			<p class="callout-heading">Important note</p>
			<p class="callout">VNets that have overlapping IP ranges will not be compatible for connection.</p>
			<p>VNets are used for communication between Azure resources over private IP addresses. Primarily, they're used for communication between Azure <strong class="bold">Virtual Machines (VMs)</strong>, but other resources can be configured to use private IP addresses for communication as well.</p>
			<p>Communication between Azure VMs occurs over a <strong class="bold">network interface card (NIC).</strong> Each VM can be assigned one or more NICs, depending on the VM size. A bigger size allows more NICs to be associated with a VM. Each NIC can be assigned a private and public IP address. A private IP address is required and a public IP address is optional. As a NIC must have a private IP address, it must be associated with VNet and subnet on the same VNet.</p>
			<p>As a first line of defense, we can use a <strong class="bold">network security group (NSG)</strong> to control traffic for Azure VMs. NSGs can be used to control inbound and outbound traffic. Default inbound and outbound rules are created during the NSG's creation, but we can change (or remove) these rules and create additional rules based on our requirements. The default inbound rules are shown in the following figure:</p>
			<div><div><img src="img/Fig_4.1.jpg" alt="Figure 4.1 – Inbound security rules&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.1 – Inbound security rules</p>
			<p>The default inbound rules will allow any traffic coming from within a VNet and any traffic forwarded from Azure Load Balancer. All other traffic will be blocked. </p>
			<p>Conversely, the default outbound rule will allow almost any outbound traffic. The default rules will allow any <a id="_idIndexMarker244"/>outgoing traffic to a VNet or the internet, as in the following figure:</p>
			<div><div><img src="img/Fig_4.2.jpg" alt="Figure 4.2 – Outbound security rules&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.2 – Outbound security rules</p>
			<p>To add a new inbound rule, we need to define the source, source port range, destination, destination port range, protocol, action, priority, and name. Optionally, we can add a description that will help us understand why this rule was created. An example of how to create a rule to allow traffic over port <code>443</code> (HTTPS) is shown in the following figure:</p>
			<div><div><img src="img/Fig_4.3.jpg" alt="Figure 4.3 – Adding new inbound security rules&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.3 – Adding new inbound security rules</p>
			<p>Alternatively, we can create the same rule with Azure PowerShell:</p>
			<ol>
				<li>First, we need to create a resource group where resources will be deployed:<pre>New-AzResourceGroup -Name "Packt-Security" -Location ` "westeurope"</pre></li>
				<li>Next, we need <a id="_idIndexMarker245"/>to deploy VNet:<pre>New-AzVirtualNetwork -Name "Packt-VNet" -ResourceGroupName ` "Packt-Security" -Location  "westeurope" -AddressPrefix ` 10.11.0.0/16</pre></li>
				<li>And finally, we deploy NSG and create a rule:<p>New-AzNetworkSecurityGroup -Name "nsg1" -ResourceGroupName ` "Packt-Security" -Location "westeurope"</p><pre>$nsg=Get-AzNetworkSecurityGroup -Name 'nsg1' `
-ResourceGroupName 'Packt-Security'
$nsg | Add-AzNetworkSecurityRuleConfig -Name 'Allow_HTTPS' `
-Description 'Allow_HTTPS' -Access Allow -Protocol Tcp `
-Direction Inbound -Priority 100 -SourceAddressPrefix Internet `
-SourcePortRange * -DestinationAddressPrefix * `
-DestinationPortRange 443 | Set-AzNetworkSecurityGroup </pre></li>
			</ol>
			<p>In order to add a new outbound rule, we<a id="_idIndexMarker246"/> need to define the same option as the inbound rule. An example of how to create a rule to deny traffic over port <code>22</code> is shown in the following figure:</p>
			<div><div><img src="img/Fig_4.4.jpg" alt="Figure 4.4 – Adding new outbound security rules&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.4 – Adding new outbound security rules</p>
			<p>Note that the priority plays a very important role when it comes to NSGs. A lower number means higher priority and a higher number means lower priority. If we have two rules that are in contradiction, the rule with the lower number will take precedence. For example, if we create a rule to allow traffic over port <code>443</code> with a priority of <code>100</code>, and create a rule to deny traffic over port <code>443</code> with a priority of <code>400</code>, traffic will be allowed, as the allow<a id="_idIndexMarker247"/> rule has a greater priority.</p>
			<p>Again, we can use Azure PowerShell to create the rule:</p>
			<pre>$nsg | Add-AzNetworkSecurityRuleConfig -Name 'Allow_SSH' `
-Description 'Allow_SSH' `
-Access Allow -Protocol Tcp `
-Direction Outbound -Priority 100 `
-SourceAddressPrefix VirtualNetwork  -SourcePortRange * `
-DestinationAddressPrefix * -DestinationPortRange 22 `
| Set-AzNetworkSecurityGroup </pre>
			<p>An NSG can be associated with subnets and NICs. An NSG associated on a subnet level will have all the rules applied to all the devices associated with that subnet. When an NSG is associated with a NIC, rules will be applied only to that NIC. It's recommended to associate NSGs with subnets instead of NICs for more simple management. It's easy to manage traffic on a NIC level when we have fewer VMs. But when the number of VMs is in the dozens, hundreds, or even thousands, it becomes very hard to manage traffic on a NIC level. It's much better to have VMs that have <a id="_idIndexMarker248"/>similar requirements associated on a subnet level.</p>
			<p>In order to associate an NSG with a subnet, follow these steps:</p>
			<ol>
				<li value="1">Go to the <strong class="bold">Subnet</strong> section under <strong class="bold">NSG1</strong> and select <strong class="bold">Associate</strong>, as in the following figure:<div><img src="img/Fig_4.5.jpg" alt="Figure 4.5 – NSG subnet blade&#13;&#10;"/></div><p class="figure-caption">Figure 4.5 – NSG Subnets blade</p></li>
				<li>Next, we select the virtual network, as in the following screenshot:<div><img src="img/Fig_4.6.jpg" alt="Figure 4.6 – VNet association to NSG&#13;&#10;"/></div><p class="figure-caption">Figure 4.6 – VNet association to NSG</p></li>
				<li>Finally, we select the subnet and confirm:</li>
			</ol>
			<div><div><img src="img/Fig_4.7.jpg" alt="Figure 4.7 – Subnet association to NSG&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.7 – Subnet association to NSG</p>
			<p>Now all of the Azure VMs added to this <a id="_idIndexMarker249"/>subnet will have all the NSG rules applied immediately. </p>
			<p>The Azure PowerShell script to associate an NSG with a subnet is the following:</p>
			<pre>$vnet = Get-AzVirtualNetwork -Name 'Packt-VNet' `
-ResourceGroupName 'Packt-Security'
Add-AzVirtualNetworkSubnetConfig -Name FrontEnd `
-AddressPrefix 10.11.0.0/24 -VirtualNetwork $vnet
$subnet = Get-AzVirtualNetworkSubnetConfig `
-VirtualNetwork $vnet -Name FrontEnd
$nsg = Get-AzNetworkSecurityGroup `
-ResourceGroupName 'Packt-Security' -Name 'nsg1'
$subnet.NetworkSecurityGroup = $nsg
Set-AzVirtualNetwork -VirtualNetwork $vnet </pre>
			<p>Let's take a simple three-tier application architecture as an example. Here, we would have VMs accessible from outside (over the internet), and these VMs should be placed in a DMZ subnet, which would be associated with an NSG that would allow such traffic. Next, we would have an application tier, which would allow traffic inside a VNet but no direct access over the internet. </p>
			<p>The application tier would be associated <a id="_idIndexMarker250"/>with an appropriate subnet, which would (with the NSG on a subnet level) deny traffic over the internet but allow any traffic coming from the DMZ. Lastly, we would have a database tier, which would allow only traffic coming from the application tier, using the NSG associated on a subnet level. This way, any request would be able to reach the DMZ tier. Once a request is validated, it can pass to the application tier and from there it can reach the database tier. No direct communication is allowed between the DMZ and database tiers, and a direct request is not allowed to go from the internet to the application or database tiers.</p>
			<p>For more security, resources can be associated with application groups. Using NSGs and application groups, we can create additional security rules with more network filtering options.</p>
			<p>We will now be looking at connecting on-premises networks with Azure.</p>
			<h2 id="_idParaDest-86"><a id="_idTextAnchor089"/>Connecting on-premises networks with Azure</h2>
			<p>In most cases, we already have some sort of local infrastructure and want to use the cloud as a hybrid where we combine cloud and on-premises resources. In such cases, we need to think<a id="_idIndexMarker251"/> about how we are going to access <strong class="bold">Azure Virtual Network (VNet)</strong> from our local network.</p>
			<p>There are three options available:</p>
			<ul>
				<li><strong class="bold">Point-to-Site connection (P2S)</strong> is usually used for management. It enables you to create a connection from a single <a id="_idIndexMarker252"/>on-premises computer to Azure VNet. It has a secure connection, but not the most reliable one, and shouldn't be used for production purposes, only to perform management and maintenance tasks.</li>
				<li><strong class="bold">Site-to-Site connection (S2S)</strong> is a more<a id="_idIndexMarker253"/> stable connection that enables a network-to-network connection. In this case, that would be from an on-premises network to a VNet, where all on-premises devices can connect to Azure resources and vice versa. Using S2S enables you to expend local infrastructure to Azure, use hybrid cloud, and take advantage of the best things both on-premises and cloud networks can offer. </li>
				<li><strong class="bold">ExpressRoute</strong> is a direct connection from a <a id="_idIndexMarker254"/>local data center to Azure. It doesn't go over the internet and offers a much better connection. Compared to an S2S connection, ExpressRoute offers more reliability and speed with lower network latency.</li>
			</ul>
			<p>Next, we will be checking out how to create an S2S connection.</p>
			<h2 id="_idParaDest-87"><a id="_idTextAnchor090"/>Creating an S2S connection</h2>
			<p>In order to <a id="_idIndexMarker255"/>create an S2S connection, several resources must be created. First, we need to create a <strong class="bold">Virtual Network Gateway (VNG)</strong>. During the process of <a id="_idIndexMarker256"/>creating a VNG, we need to define a subscription, a name for the VNG, the region where it will be created, and a VNet must be selected. </p>
			<p>The VNet that we can select is limited to the region where the VNG will be created. A separate gateway subnet must be defined, so we can either select an existing one or it will be created automatically if it doesn't exist on the selected VNet. </p>
			<p>In the same section, we need to define the public IP address (create a new one or select an existing one) and <a id="_idIndexMarker257"/>select to enable (or disable) active-active mode or BGP. An example is shown in the figure that follows.</p>
			<p>The following details need to be filled in:</p>
			<ul>
				<li><strong class="bold">Subscription</strong></li>
				<li><strong class="bold">Instance details</strong></li>
				<li><strong class="bold">Public IP address</strong></li>
			</ul>
			<p>You can see an example of this in the following figure:</p>
			<div><div><img src="img/Fig_4.8.jpg" alt="Figure 4.8 – Creating a VNG&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.8 – Creating a VNG</p>
			<p>Another resource we need to create is a <strong class="bold">Local Network Gateway (LNG)</strong>. To create an LNG, we <a id="_idIndexMarker258"/>need to define the following:</p>
			<ul>
				<li><strong class="bold">Name</strong></li>
				<li><strong class="bold">IP</strong> <strong class="bold">address</strong></li>
				<li><strong class="bold">Address</strong> <strong class="bold">space</strong></li>
				<li><strong class="bold">Subscription</strong></li>
				<li><strong class="bold">Resource</strong> <strong class="bold">group</strong></li>
				<li><strong class="bold">Location</strong></li>
				<li><strong class="bold">BGP</strong> <strong class="bold">settings</strong></li>
			</ul>
			<p>The BGP settings are optional. The IP <a id="_idIndexMarker259"/>address we need to define is the public IP address of our VPN device, and the address range is the address range of our local network. An example is shown in the following figure:</p>
			<div><div><img src="img/Fig_4.9.jpg" alt="Figure 4.9 – Creating an LNG&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.9 – Creating an LNG</p>
			<p>After a VNG and an LNG are created, we need to create a connection in VNet:</p>
			<ol>
				<li value="1">Under the <strong class="bold">connection settings</strong> in the <strong class="bold">VNet</strong> blade, add a new connection. </li>
				<li>The following parameters need to be defined: <strong class="bold">Name</strong>, <strong class="bold">Connection</strong> <strong class="bold">type</strong>, <strong class="bold">Virtual</strong> <strong class="bold">network</strong> <strong class="bold">gateway</strong>, <strong class="bold">Local</strong> <strong class="bold">network</strong> <strong class="bold">gateway</strong>, <strong class="bold">Shared key (PSK)</strong> and <strong class="bold">IKE</strong> <strong class="bold">Protocol</strong>. </li>
				<li><strong class="bold">Subscription</strong>, <strong class="bold">Resource</strong> <strong class="bold">group</strong> and <strong class="bold">Location</strong> will be locked and will use the same options as the ones<a id="_idIndexMarker260"/> assigned to the selected VNet:</li>
			</ol>
			<div><div><img src="img/Fig_4.10.jpg" alt="Figure 4.10 – Creating a VPN connection&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.10 – Creating a VPN connection</p>
			<p>After a connection is created in Azure, we still need to create a connection on our local VPN device. It's highly recommended to only use supported devices (most industry leaders are supported, such as Cisco, Palo Alto, and Juniper, to name a few). When configuring a connection on a local VPN device, we need to take into account all the parameters used on the Azure side. </p>
			<p>Once a connection is configured on both sides, the tunnel is up and we should be able to access Azure<a id="_idIndexMarker261"/> resources from an on-premises network and from Azure to a local network. Of course, we can control how traffic flows and what can access what, how, and under which conditions.</p>
			<p>We have now seen how to create connections between Azure VNets and local networks. But we often have a need to connect one VNet with another VNet. Of course, it's still important to keep the same level of security, even if everything is inside Azure. In the next section, we'll discuss how to connect networks in such a situation. </p>
			<h2 id="_idParaDest-88"><a id="_idTextAnchor091"/>Connecting a VNet to another VNet</h2>
			<p>In a case where we have <a id="_idIndexMarker262"/>multiple VNets in Azure, we may need to create a connection between them in order to allow services to communicate between networks. There are two ways in which we can achieve this goal: </p>
			<ul>
				<li>The first one would be to create an S2S between the VNets. In this case, the process is very similar to creating an S2S between a VNet and a local network. We need to create a VNG for both VNets, but we don't need an LNG. When creating a connection, we need to select <strong class="bold">VNet-to-VNet</strong> in <strong class="bold">Connection types</strong> and select appropriate VNGs.</li>
			</ul>
			<p>Another option would be to create VNet peering. An S2S connection is secure and encrypted, but it passes over the internet. Peering uses an Azure backbone network in order to route traffic, and it never leaves Azure. This makes peering even safer.</p>
			<p>To create peering between VNets, we need to carry out the following steps:</p>
			<ol>
				<li value="1">Go to the peerings section in the VNet blade and add a new peering. </li>
				<li>We need to define the name and the VNet we want to create a connection to. </li>
				<li>Other settings are also present, such as whether we want to allow connections to go both ways, or whether we want to allow forwarded traffic. </li>
			</ol>
			<p>A peering example is shown in the following figure:</p>
			<div><div><img src="img/Fig_4.11.jpg" alt="Figure 4.11 – Creating VNet-to-VNet peering&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.11 – Creating VNet-to-VNet peering</p>
			<p>It's very important to understand additional security settings in VNet peering and how they affect the<a id="_idIndexMarker263"/> network traffic. </p>
			<p>The network access settings will define traffic access from one VNet to another. For example, we may want to enable access from <strong class="bold">VNet A</strong> to <strong class="bold">VNet B</strong>. But, because of security settings, we want to block access from <strong class="bold">VNet B</strong> to <strong class="bold">VNet A</strong>. This way, resources in <strong class="bold">VNet A</strong> will be able to access resources in <strong class="bold">VNet B</strong>, but resources in <strong class="bold">VNet</strong> <strong class="bold">B</strong> will not be able to access resources in <strong class="bold">VNet</strong> <strong class="bold">A</strong>:</p>
			<div><div><img src="img/Fig_4.12.jpg" alt="Figure 4.12 – VNet peering&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.12 – VNet peering</p>
			<p>In the next section, we will define how we handle forwarded traffic. Let's say that <strong class="bold">VNet</strong> <strong class="bold">A</strong> is connected to <strong class="bold">VNet</strong> <strong class="bold">B</strong> and <strong class="bold">VNet</strong> <strong class="bold">C</strong>. There is no connection between <strong class="bold">VNet</strong> <strong class="bold">B</strong> and <strong class="bold">VNet</strong> <strong class="bold">C</strong>. With these settings, we define whether we want to allow traffic from <strong class="bold">VNet</strong> <strong class="bold">B</strong> to reach <strong class="bold">VNet</strong> <strong class="bold">C</strong> over <strong class="bold">VNet</strong> <strong class="bold">A</strong>. The same thing can be defined the other way around:</p>
			<div><div><img src="img/Fig_4.13.jpg" alt="Figure 4.13 – VNet peering with multiple VNets&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.13 – VNet peering with multiple VNets</p>
			<p>The gateway transit settings allow <a id="_idIndexMarker264"/>us to control whether we want a current connection to be able to use other connections with another network. For example, <strong class="bold">VNet</strong> <strong class="bold">A</strong> is connected to <strong class="bold">VNet B</strong> and <strong class="bold">VNet B</strong> is connected to an on-premises network (or another VNet). This setting will define whether traffic from <strong class="bold">VNet A</strong> will be able to reach the on-premises network. In this case, one of the VNets would be replaced with the on-premise network. If there is a connection between the on-premise network and <strong class="bold">VNet A</strong>, and a connection between <strong class="bold">VNet A</strong> and <strong class="bold">VNet B</strong>, the gateway transit would decide whether traffic from <strong class="bold">VNet B</strong> can reach the on-premise network.</p>
			<p>In the next section, we will be<a id="_idIndexMarker265"/> discussing the most important thing when it comes to security, which is service endpoints in VNets.</p>
			<h2 id="_idParaDest-89"><a id="_idTextAnchor092"/>VNet service endpoints</h2>
			<p>VNet service endpoints enable us to extend some <strong class="bold">Platform as a Service (PaaS)</strong> services to use private address spaces. With service endpoints, we connect services (that don't have<a id="_idIndexMarker266"/> this option by default) to our VNet enabling services to communicate over private IP addresses. This way, traffic is never exposed publicly, and data<a id="_idIndexMarker267"/> exchange is carried out over the Microsoft Azure backbone network.</p>
			<p>Only some Azure services support this feature:</p>
			<ul>
				<li>Azure App Service</li>
				<li>Azure Container Registry </li>
				<li>Azure Cosmos DB</li>
				<li>Azure Data Lake</li>
				<li>Azure Database for MariaDB</li>
				<li>Azure Database for MySQL</li>
				<li>Azure Database for PostgreSQL</li>
				<li>Azure Event Hub</li>
				<li>Azure Key Vault</li>
				<li>Azure Service Bus</li>
				<li>Azure Storage</li>
				<li>Azure SQL Database</li>
				<li>Azure SQL Data Warehouse</li>
			</ul>
			<p>The first security benefit from using service endpoints is definitely that data never leaves the private space. Let's say that we have Azure App Service and Azure SQL Database connected to the VNet with service endpoints. This way, all communication between the web application on App Service and the database on Azure SQL Database would be done securely over the VNet. No data would be exposed publicly, as is the case when using the same services without endpoints. </p>
			<p>Without this feature, both <a id="_idIndexMarker268"/>services would only have public IP addresses and communication between them going over the internet. Even though there are ways of doing this securely, with communication being sent encrypted over HTTPS, using service endpoints partly removes the security risk in this communication.</p>
			<p>But the security benefits of using service endpoints don't stop there. As services connected to VNet with service endpoints are assigned private IP addresses from a specific subnet, all security rules associated with this subnet are applied to our services as well. If an NSG blocks specific traffic on our subnet, the same traffic will be blocked for PaaS services as well.</p>
			<p>We can enable service points on VNet either during the creation of a VNet or at a later time. Service endpoints are enabled on a subnet level, and this can be done either on a VNet or subnet configuration. Follow these steps to enable service endpoints in VNet:</p>
			<ol>
				<li value="1">Go to the VNet blade and select <strong class="bold">service endpoints</strong>. Click <strong class="bold">add</strong> and select the subnet and services you want to use, as in the following figure:<div><img src="img/Fig_4.14.jpg" alt="Figure 4.14 – Adding PaaS service endpoints&#13;&#10;"/></div><p class="figure-caption">Figure 4.14 – Adding PaaS service endpoints</p></li>
				<li>Go to the <strong class="bold">subnet</strong> configuration and select the<a id="_idIndexMarker269"/> services, as in the following figure:</li>
			</ol>
			<div><div><img src="img/Fig_4.15.jpg" alt="Figure 4.15 – Enabling service endpoints on subnet&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.15 – Enabling service endpoints on subnet</p>
			<p>Enabling service endpoints on a VNet and subnet is only half of the job. We need to enable settings on a PaaS service for the service endpoint to take effect. When enabling the service <a id="_idIndexMarker270"/>endpoint in the service settings, only subnets with enabled service endpoints will show up.</p>
			<p>With service endpoints, we complete the network section that is available directly on Azure VNet settings. But there are other things we need to consider when it comes to network security. Let's see what else is available to increase network security in Azure.</p>
			<h1 id="_idParaDest-90"><a id="_idTextAnchor093"/>Considering other virtual networks' security</h1>
			<p>For additional security and traffic control, a <strong class="bold">Network Virtual Appliance (NVA)</strong> can be used. An NVA<a id="_idIndexMarker271"/> can be deployed from Azure Marketplace. Once deployed, you will realize that an NVA, in fact, is an Azure VM with a third-party firewall installed. Most industry leaders are present in Azure Marketplace and we can deploy firewall solutions that we are used to in an on-premises environment. It's important to mention that we don't have to decide between NSGs or NVAs; these can be combined for additional security.</p>
			<p>Additional network security can be achieved with Azure Firewall as well. Azure Firewall is a firewall as a service. It allows better network control than an NSG and can be compared to an NVA solution in many aspects. But Azure Firewall also has a few advantages compared to an NVA, such as built-in high availability, the option to deploy to multiple Availability Zones, and unrestricted cloud scalability. This means that no load balancers are needed. We can span Azure Firewall across multiple Availability Zones (and achieve an SLA of 99.99%), and scaling is configured to<a id="_idIndexMarker272"/> automatically accommodate any change in network traffic. Some options that are supported are: application filtering, network traffic filtering, FQDN tags, service tags, outbound SNAT support, inbound DNAT support, and multiple public IP addresses. With these options, we can have complete control of network traffic in our VNet. It's important to mention that Azure Firewall is compliant with many security standards, such as SOC 1 Type 2, SOC 2 Type 2, SOC 3, PCI DSS, and ISO 27001, 27018, 20000-1, 22301, 9001, and 27017.</p>
			<p>Next, we will be looking at how to deploy and configure Azure Firewall through the Azure portal.</p>
			<h2 id="_idParaDest-91"><a id="_idTextAnchor094"/>Azure Firewall deployment and configuration</h2>
			<p>This example – to deploy and configure Azure Firewall – requires Azure PowerShell. However, Azure Firewall <a id="_idIndexMarker273"/>can be configured and deployed through the Azure portal as well.</p>
			<h3 id="_idParaDest-92">Azure Firewall deployment</h3>
			<p>In order to deploy Azure Firewall, we need to<a id="_idIndexMarker274"/> set up the required network and infrastructure:</p>
			<ol>
				<li value="1">First, we need to create subnets, create a VNet, and associate the subnets with the VNet:<pre>$FWsub = New-AzVirtualNetworkSubnetConfig -Name ` AzureFirewallSubnet -AddressPrefix 10.0.1.0/26
$Worksub = New-AzVirtualNetworkSubnetConfig -Name Workload-SN ` -AddressPrefix 10.0.2.0/24
$Jumpsub = New-AzVirtualNetworkSubnetConfig -Name Jump-SN `  
-AddressPrefix 10.0.3.0/24 
$testVnet = New-AzVirtualNetwork -Name Packt-VNet `
-ResourceGroupName Packt-Security -Location "westeurope" `
-AddressPrefix 10.0.0.0/16 -Subnet $FWsub, $Worksub, $Jumpsub </pre></li>
				<li>Next, we need to deploy Azure VM, which will be used as a jump box (the VM we connect to in order to perform<a id="_idIndexMarker275"/> admin tasks on other VMs in the network; we don't connect to other VMs directly, but only through a jump box):<pre>New-AzVm -ResourceGroupName Packt-Security -Name "Srv-Jump" `
-Location "westeurope" -VirtualNetworkName Packt-VNet `
-SubnetName Jump-SN -OpenPorts 3389 -Size "Standard_DS2" </pre></li>
				<li>After the jump box, we create a test VM:<pre>$NIC = New-AzNetworkInterface -Name Srv-work `
-ResourceGroupName Packt-Security -Location "westeurope" `
-Subnetid $testVnet.Subnets[1].Id
$VirtualMachine = New-AzVMConfig -VMName Srv-Work -VMSize ` "Standard_DS2"
$VirtualMachine = Set-AzVMOperatingSystem -VM $VirtualMachine `
-Windows -ComputerName Srv-Work -ProvisionVMAgent `
-EnableAutoUpdate
$VirtualMachine = Add-AzVMNetworkInterface -VM $VirtualMachine ` -Id $NIC.Id
$VirtualMachine = Set-AzVMSourceImage -VM $VirtualMachine `
-PublisherName 'MicrosoftWindowsServer' -Offer 'WindowsServer' ` -Skus '2016-Datacenter' -Version latest
New-AzVM -ResourceGroupName Packt-Security -Location ` "westeurope" -VM $VirtualMachine -Verbose </pre></li>
				<li>Finally, we deploy Azure Firewall:<pre>$FWpip = New-AzPublicIpAddress -Name "fw-pip" `
-ResourceGroupName  Packt-Security -Location "westeurope" `
-AllocationMethod Static -Sku Standard
$Azfw = New-AzFirewall -Name Test-FW01 -ResourceGroupName `
Packt-Security -Location "westeurope" -VirtualNetworkName ` Packt-VNet -PublicIpName fw-pip
$AzfwPrivateIP = $Azfw.IpConfigurations.privateipaddress </pre></li>
				<li>Next, we will look at the Azure Firewall <a id="_idIndexMarker276"/>configuration.</li>
			</ol>
			<h4>The Azure Firewall configuration</h4>
			<p>After Azure Firewall is deployed, it doesn't actually do <a id="_idIndexMarker277"/>anything. We need to create a configuration and rules in order for Azure Firewall to be effective:</p>
			<ol>
				<li value="1">First, we will create a new route table with the BGP propagation disabled:<pre>$routeTableDG = New-AzRouteTable -Name Firewall-rt-table `
-ResourceGroupName Packt-Security -location "westeurope" `
-DisableBgpRoutePropagation
Add-AzRouteConfig -Name "DG-Route" -RouteTable $routeTableDG `
-AddressPrefix 0.0.0.0/0 -NextHopType "VirtualAppliance" `
-NextHopIpAddress $AzfwPrivateIP | Set-AzRouteTable
Set-AzVirtualNetworkSubnetConfig -VirtualNetwork $testVnet `
-Name Workload-SN -AddressPrefix 10.0.2.0/24 `
-RouteTable $routeTableDG | Set-AzVirtualNetwork </pre></li>
				<li>Next, we create an application rule that allows outbound access to <a href="http://www.google.com">www.google.com</a>:<pre>$AppRule1 = New-AzFirewallApplicationRule -Name Allow-Google `
-SourceAddress 10.0.2.0/24 -Protocol http, https `
-TargetFqdn www.google.com
$AppRuleCollection = New-AzFirewallApplicationRuleCollection `
-Name App-Coll01 -Priority 200 -ActionType Allow -Rule $AppRule1
$Azfw.ApplicationRuleCollections = $AppRuleCollection
Set-AzFirewall -AzureFirewall $Azfw </pre></li>
				<li>We then create a rule to <a id="_idIndexMarker278"/>allow a DNS on port <code>53</code>:<pre>$NetRule1 = New-AzFirewallNetworkRule -Name "Allow-DNS" `
-Protocol UDP -SourceAddress 10.0.2.0/24 `
-DestinationAddress 209.244.0.3,209.244.0.4 -DestinationPort 53
$NetRuleCollection = New-AzFirewallNetworkRuleCollection `
-Name RCNet01 -Priority 200 -Rule $NetRule1 -ActionType "Allow"
$Azfw.NetworkRuleCollections = $NetRuleCollection
Set-AzFirewall -AzureFirewall $Azfw </pre></li>
				<li>And then we need to assign a DNS to an NIC:<pre>$NIC.DnsSettings.DnsServers.Add("209.244.0.3")
$NIC.DnsSettings.DnsServers.Add("209.244.0.4")
$NIC | Set-AzNetworkInterface</pre></li>
			</ol>
			<p> Try connecting to a jump box, and then through a jump box to test the VM. From the test VM, try resolving multiple URLs. Only <a href="http://www.google.com">www.google.com</a> should succeed, as all outbound traffic is denied except for the explicit allow rule we created.</p>
			<p>Let's move on to networking<a id="_idIndexMarker279"/> in PaaS and see what else is available, besides securing PaaS with service endpoints. We can have better network control and prevent unwanted traffic even with endpoints publicly available. </p>
			<h1 id="_idParaDest-93"><a id="_idTextAnchor095"/>Understanding Azure Application Gateway</h1>
			<p>The next Azure service that can help increase security is Application Gateway. Application Gateway is a web-traffic load balancer that enables traffic management for web applications. It operates as <strong class="bold">layer 7</strong> <strong class="bold">(L-7</strong>, or <strong class="bold">application layer</strong>) load balancing. This <a id="_idIndexMarker280"/>means that it supports URL-based routing and can route requests based on the URI path or host header.</p>
			<p>Application Gateway supports <strong class="bold">Secure Socket Layer (SSL/TSL)</strong> termination at the gateway. After the gateway, traffic flows <a id="_idIndexMarker281"/>unencrypted to backend servers, which are unburdened from encryption and decryption overhead. However, if this is not an option because of security, compliance, or any other requirements, full end-to-end encryption is supported as well.</p>
			<p>Application Gateway also supports scalability and zone redundancy. Scalability allows autoscaling depending on traffic load, and zone redundancy allows the service to be deployed to multiple availability zones in order to provide better fault resiliency, and removing the need to deploy the service to multiple zones manually. </p>
			<p>Overall, Azure Application Gateway is an L-7 load balancer and we could question the security aspects of it (if we exclude SSL/TSL termination), as it's more a question of reliability and availability. But Application Gateway has an amazing security<a id="_idIndexMarker282"/> feature called Azure <strong class="bold">Web Application Firewall (WAF)</strong>. WAF protects web applications against common exploits and vulnerabilities. </p>
			<p>WAF is based on the <strong class="bold">Open Web Application Security Project (OWASP)</strong> and is updated to address the latest <a id="_idIndexMarker283"/>vulnerabilities. As it's PaaS, all updates are done automatically without any user configuration. From a policy perspective, we can create multiple custom policies and apply different sets of policies to different web applications. </p>
			<p>Two modes are available: detection <a id="_idIndexMarker284"/>and prevention. In detection mode, WAF will detect all suspicious requests but will not stop them, only log them. It's important to mention that WAF can be integrated with different logging tools, so logs can be stored for auditing purposes. When in protection mode, WAF will also block any malicious requests, return a <code>403 unauthorized access</code> exception, and close the connection. Prevention mode also logs all attacks. </p>
			<p>Attacks are categorized by four severity levels:</p>
			<ul>
				<li>Critical (5)</li>
				<li>Error (4)</li>
				<li>Warning (3) </li>
				<li>Notice (2) </li>
			</ul>
			<p>Each level has a severity value and the threshold for blocking is <code>5</code>. So, a single critical issue is enough to block a session with value <code>5</code>, but at least 2 error issues are needed to block a session, as 1 error with a value of <code>4</code> is below the threshold.</p>
			<p>WAF works as a filter before Application Gateway – it will process a request, decide whether it's valid or not, and, based <a id="_idIndexMarker285"/>on this decision, it will allow the request to proceed to Application Gateway or reject the request. Once the request is allowed by WAF, Application Gateway acts as a normal L-7 load balancer, as if WAF was turned off. You can see that in the following figure:</p>
			<div><div><img src="img/Fig_4.16.jpg" alt="Figure 4.16 – Application Gateway traffic flow&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 4.16 – Application Gateway traffic flow</p>
			<p>Some of the attacks that can be detected and prevented with WAF are listed here:</p>
			<ul>
				<li>SQL injection</li>
				<li>Cross-site scripting</li>
				<li>Command injection</li>
				<li>Request smuggling</li>
				<li>Response splitting</li>
				<li>HTTP protocol violations and anomalies</li>
				<li>Protection against crawlers and scanners</li>
				<li>Geo-filter traffic</li>
			</ul>
			<p>WAF on Application Gateway<a id="_idIndexMarker286"/> supports logging options to Azure Monitor, diagnostic logs to storage accounts, and integration with security tools such as Azure Security Center or Azure Sentinel.</p>
			<h1 id="_idParaDest-94"><a id="_idTextAnchor096"/>Understanding Azure Front Door</h1>
			<p>Azure Front Door works very <a id="_idIndexMarker287"/>similarly to Application Gateway but on a different level. Like Application Gateway, it's an L-7 load balancer with an SSL offload. The difference is that Application Gateway works with services in a single region where Azure Front Door allows us to define, manage, and monitor routing on a global level. With Azure Front Door, we can ensure the highest availability using global distribution. A similar thing can be achieved with Azure Traffic Manager (in terms of global distribution), but this service lacks L-7 load balancing and SSL offloading.</p>
			<p>What Azure Front Door provides actually combines Application Gateway and Traffic Manager to enable an L-7 load balancer with global distribution. It's also important to mention that a WAF is also available on Azure Front Door. Using a WAF on Azure Front Door, we can provide web application protection for globally distributed applications.</p>
			<h1 id="_idParaDest-95"><a id="_idTextAnchor097"/>Summary</h1>
			<p>In this chapter, we addressed network security and, prior to that, we saw how to manage cloud identities. We need to remember that network security doesn't stop with IaaS and VNets. Network security basics are usually associated with VNets and NSGs. But even with IaaS, it does not stop there, and we have options to extend with an NVA or Azure Firewall. With PaaS, we can leverage VNet's service endpoints but extend security with services like Application Gateway or Azure Front Door.</p>
			<p>But, with all the preclusions limiting who, how, when, and from where we can access our resources, we still need to handle sensitive information and data. The next chapter will address how can we manage certificates, secrets, passwords, and connection strings using Azure Key Vault.</p>
			<h1 id="_idParaDest-96"><a id="_idTextAnchor098"/>Questions</h1>
			<ol>
				<li value="1">We can control traffic in virtual networks with…<p>A. A network interface</p><p>B. A Network Security Group (NSG)</p><p>C. An Access Control List (ACL)</p></li>
				<li>What type of connection is available with on-premises networks?<p>A. Point-to-Site</p><p>B. Site-to-Site</p><p>C. VNet-to-VNet</p></li>
				<li>A connection between Virtual Networks can be made with…<p>A. VNet-to-VNet</p><p>B. VNet peering</p><p>C. Both of the above</p><p>D. None of the above</p></li>
				<li>Which feature allows us to connect PaaS services to a virtual network?<p>A. Service connection</p><p>B. Service endpoints</p><p>C. ExpressRoute</p></li>
				<li>When multiple networks are involved…<p>A. We can define a route</p><p>B. Traffic is blocked by default</p><p>C. Traffic is allowed by default</p><p>D. A and B are correct</p><p>E. A and C are correct</p></li>
				<li>Which feature in Application Gateway adds additional security?<p>A. Open Web Application Security Project (OWASP)</p><p>B. Web Application Firewall (WAF)</p><p>C. <strong class="bold">S</strong>ecure Socket Layer (SSL) / Transport Layer Security (TSL)</p></li>
				<li>What type of attack cannot be blocked with Application Gateway?<p>A. SQL injection (SQLi)</p><p>B. Cross-Site Scripting (XSS)</p><p>C. Distributed Denial of Service (DDoS)</p><p>D. HTTP protocol violations </p></li>
			</ol>
		</div>
	</body></html>