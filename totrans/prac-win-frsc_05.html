<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Timeline"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Timeline</h1></div></div></div><p>In this chapter, we will look at timeline analysis. We will learn a few different approaches to perform a timeline analysis with The Sleuth Kit and Plaso Framework. We will also cover some theoretical issues that are specific to some filesystems and how they work with file time-related attributions. Also, we will demonstrate how we can use Plaso in practice.</p><p>In a nutshell, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Timeline</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The Sleuth Kit</strong></span> (<span class="strong"><strong>TSK</strong></span>)</li><li class="listitem" style="list-style-type: disc">Plaso architecture</li><li class="listitem" style="list-style-type: disc">Plaso in practice</li></ul></div><div class="section" title="Timeline introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec29"/>Timeline introduction</h1></div></div></div><p>One question, which is very prominent in forensics is, "When?"</p><p>In other words, time is a very important factor at which analytics is based in the process of forensics. There are many artifacts that we use in an investigation which have temporal characteristics. These characteristics allow us to build the whole picture of an incident.</p><p>Moreover, timeline analysis could help when we analyze different types of evidence. Timeline analysis may be built on the base of any source that has timestamps. This could be the metadata of the filesystem, registry, event log files, log files of applications, memory, network traffic, and so on.</p><p>Certainly, the timeline is one of the most useful techniques that is applied in digital forensics. However, this is based on the analysis of particular artifacts, so it is very important to understand how to analyze the artifacts that are suppliers of timeline events.</p><p>Despite the apparent simplicity of the idea underlying the timeline, in practice, it is not so easy. One of the difficulties is the large amount of data that has to be analyzed. The issue with a running system is that there are a few users and many system services, which produce a lot of events. We need to filter out such activities from normal users.</p><p>The idea of a timeline is not very new. It has been around since the year 2000, when Rob Lee and some other forensic people started applying it in digital forensics. Originally, filesystems served as a source of data for the timeline. We will consider the NTFS filesystem as the most prevalent filesystem in our review.</p><p>The timeline of the NTFS filesystem is based on the timestamps in some attributes of the filesystem objects.</p><p>Every object of the filesystem has the following timestamps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">M</code>: This is the date of data modification</li><li class="listitem" style="list-style-type: disc"><code class="literal">A</code>: This is the date of data access</li><li class="listitem" style="list-style-type: disc"><code class="literal">C</code>: This is the date of metadata change</li><li class="listitem" style="list-style-type: disc"><code class="literal">B</code>: This is the date of metadata creation</li></ul></div><p>Based on the analysis of this data, we can determinate when a file was created, copied, moved, and so on. The NTFS filesystem uses <code class="literal">FILETIME</code> as its time format in UTC. <span class="strong"><strong>UTC</strong></span> is <span class="strong"><strong>Coordinated Universal Time</strong></span>. <code class="literal">FILETIME</code> contains a 64-bit value representing the number of 100-nanosecond intervals since January 1, 1601 (UTC). MS Windows also uses other time formats. They are the UNIX time format, DOS Date format, and <code class="literal">SYSTEMTIME</code> format.</p><p>Also, we should highlight some cases when the file is moved across different filesystems, for example, a file is copied to a USB key. In most cases, USB uses the FAT32 filesystem, so files on the FAT32 system have different attributes, and timestamps are on the NTFS and FAT32 filesystems.</p><p>Let's consider case when a file is created on the NTFS filesystem and then is copied to USB with the FAT32 filesystem. In this case, the modification date remains unchanged, but the C date on the USB drive changes and will fit to the date of file creation on the USB. Microsoft has an explanation on how attributes are changed in different situations at <a class="ulink" href="http://support.microsoft.com/kb/299648">http://support.microsoft.com/kb/299648</a>. The following are the file properties with regards to the date and time stamps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the case that a file is copied from <code class="literal">C:\fatfolder</code> to <code class="literal">C:\fatfolder\subfolder</code>, it keeps the same date and time of modification but changes the date and time of creation to the current date and time</li><li class="listitem" style="list-style-type: disc">In the case that a file is moved from <code class="literal">C:\fatfolder</code> to <code class="literal">C:\fatfolder\subfolder</code>, it keeps the same date and time of modification and keeps the same date and time of creation</li><li class="listitem" style="list-style-type: disc">In the case that a file is copied from <code class="literal">C:\fatfolder</code> to <code class="literal">D:\NTFSfolder</code>, it keeps the same date and time of modification but changes the date and time of creation to the current date and time</li><li class="listitem" style="list-style-type: disc">In the case that a file is moved from <code class="literal">C:\fatfolder</code> to <code class="literal">D:\NTFSfolder</code>, it keeps the same date and time of modification and keeps the same date and time of creation</li><li class="listitem" style="list-style-type: disc">In the case that a file is copied from <code class="literal">D:\NTFSfolder</code> to <code class="literal">D:\NTFSfolder\SUBfolder</code>, it keeps the same date and time of modification but changes the date and time of creation to the current date and time</li><li class="listitem" style="list-style-type: disc">In the case that a file is moved from <code class="literal">D:\NTFSfolder</code> to <code class="literal">D:\NTFSfolder\SUBfolder</code>, it keeps the same date and time of modification and keeps the same date and time of creation</li></ul></div><p>In all cases, the date and time of modification of a file does not change unless a property of the file has changed. The date and time of creation of the file changes, depending on whether the file was copied or moved.</p><p>The following are the folder properties with regards to the date and time stamps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the case that two new folders on an NTFS partition called <code class="literal">D:\NTFSfolder1</code> and <code class="literal">D:\NTFSfolder2</code> are created, both the date and time of creation and modification are the same<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the case that the <code class="literal">D:\NTFSfolder2</code> folder is moved into the <code class="literal">D:\NTFSfolder1</code> folder, creating <code class="literal">D:\NTFSfolder1\NTFSfolder2</code>, then the following occurs:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">D:\NTFSfolder1</code>: This is when the created folder is the same and the modified stamp changes. </li><li class="listitem" style="list-style-type: disc"><code class="literal">D:\NTFSfolder1\NTFSfolder2</code>: This is when both the created folder changes and the modified folder stay the same.<p>This behavior occurs because even though you moved the folder, a new folder is seen as being created within the <code class="literal">D:\NTFSfolder1</code> folder by the Master File Table (MFT).</p></li></ul></div></li></ul></div></li><li class="listitem" style="list-style-type: disc">In the case that the <code class="literal">D:\NTFSfolder2</code> folder is copied into the <code class="literal">D:\NTFSfolder1</code> folder, creating the <code class="literal">D:\NTFSfolder1\NTFSfolder2</code> folder, and the <code class="literal">D:\NTFSfolder2</code> folder still exists (after having copied it):<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">D:\NTFSfolder1</code>: This is when the created folder is the same and the modified folder time and date stamp changes.</li><li class="listitem" style="list-style-type: disc"><code class="literal">D:\NTFSfolder2</code>: This is when no changes occur because it is the original folder.</li><li class="listitem" style="list-style-type: disc"><code class="literal">D:\NTFSfolder1\NTFSfolder2</code>: This is when both the created folder and the modified folder change to the same stamp, which is that of the time of the move.</li></ul></div><p>This behavior occurs because even though you copied the folder, the new folder is seen as being created by the MFT and is given a new created and modified time stamp.</p></li></ul></div><p>The FAT filesystem has different behavior with regards to the modified time stamp. On a FAT filesystem, the modified date of a folder does not change if the contents of the folder change. For example,if <code class="literal">D:\FATfolder2</code> is copied or moved into <code class="literal">D:\FATfolder1</code>, the created date and modified date of <code class="literal">D:\FATfolder1</code> remain unchanged. The following table reflects the changes of attributes in accordance with operations on the file:</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>
<p><span class="strong"><strong>Operations</strong></span></p>
</td><td>
<p><span class="strong"><strong>Attribute</strong></span></p>
</td></tr><tr><td>
<p>Renaming</p>
</td><td>
<p><code class="literal">..C.</code></p>
</td></tr><tr><td>
<p>Displacement inside a volume</p>
</td><td>
<p><code class="literal">..C.</code></p>
</td></tr><tr><td>
<p>Displacement between volumes</p>
</td><td>
<p><code class="literal">.AC.</code></p>
</td></tr><tr><td>
<p>Copying</p>
</td><td>
<p><code class="literal">.ACB</code></p>
</td></tr><tr><td>
<p>Access</p>
</td><td>
<p><code class="literal">.AC.</code></p>
</td></tr><tr><td>
<p>Modification</p>
</td><td>
<p><code class="literal">M.C.</code></p>
</td></tr><tr><td>
<p>Creation</p>
</td><td>
<p><code class="literal">MACB</code></p>
</td></tr><tr><td>
<p>Deletion</p>
</td><td>
<p>....</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip8"/>Tip</h3><p>When we talk about a moving action, we mean moving of the file with Windows Explorer and the cut and paste procedure, not the <code class="literal">move</code> command in the command line.</p></div></div><p>One more thing what we want to mention is that some investigators make the mistake of assuming that disabling the last accessed time will stop any updates to the file's last access time (default on Vista+). This is incorrect. The last accessed time will be changed in the case of the copy or move commands; it remains unchanged only if the files are opening.</p><p>Also, the moving of a file by cutting and pasting in Windows Explorer in the border of the filesystem doesn't change the creation time. However, it will be changed if a file is moved on the command line with the <code class="literal">move</code> command.</p></div></div>
<div class="section" title="The Sleuth Kit"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec30"/>The Sleuth Kit</h1></div></div></div><p>Let's considers the stages of the creation of a timeline for a filesystem.</p><p>The first step for creation of the timeline is building of body file.</p><p>There are three types of data to collect:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Existing on filesystem files, which we could list with the <code class="literal">dir </code>or <code class="literal">ls </code>command.</li><li class="listitem" style="list-style-type: disc">Deleted files, which are deleted but structures of them still exist. This allows for recovering the full path and other attributes of the file. However, this depends on the filesystem, as not all filesystems allow this.</li><li class="listitem" style="list-style-type: disc">Unallocated inodes <code class="literal">($Orphan</code> files), which are file structures which do not exist anymore.</li></ul></div><p>To build a bodyfile, we will use the <code class="literal">fls</code> tool from TSK. The <code class="literal">fls</code> tool allows interacting with a forensics image as with the filesystem and extracting timeline data from the filesystem level.</p><p>This gets the value of the inode directory, processes its content, and displays the names of files in the directory (including deleted files). If the value of inode is not present, it will display the content of the root directory:</p><div class="mediaobject"><img src="graphics/image_05_001.jpg" alt="The Sleuth Kit"/></div><p>In our case, one of the most important options is <code class="literal">-m</code>, which allows output in a format for use with the mactime tool:</p><div class="mediaobject"><img src="graphics/image_05_002.jpg" alt="The Sleuth Kit"/></div><p>So if you have an <code class="literal">image.dd</code> and you want to create a timeline, you should enter the following three commands:</p><pre class="programlisting">
<span class="strong"><strong>mmls image.dd</strong></span>
<span class="strong"><strong>fls -m  -o &lt;offset of fs partition&gt; -r images.dd &gt;&#13;
    body.txt</strong></span>
<span class="strong"><strong>mactime -b body.txt -z TZ &gt;  timeline.txt</strong></span>
</pre></div>
<div class="section" title="Super timeline&#xA0;&#x2013; Plaso"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec31"/>Super timeline – Plaso</h1></div></div></div><p>The filesystem is not the only source of data that contains timestamps of events in the system. When computers work, even when users do not do anything, a lot of events occur in the system. For example, Windows XP creates a System Restore Point every 24 hours, runs disk defragmentation every three days so that sectors of deleted files will be rewritten. Windows 7 has a Volume Shadow Copy mechanism, which also creates backup files and so on. All these actions occur automatically without any user activity. So, even in idle mode, Windows has a lot of events. In the case that the system has active users, we would see many more events. The information about these events will reflect in different places: in the registry, event log files, log files of applications, browser history, and so on.</p><p>If we could use all of these sources in the timeline, we could make a whole picture of what happened in the system and link different events in logical chain. This approach is called <span class="strong"><strong>Super Timeline</strong></span>.</p><p>To build a super timeline from different sources separately and then merge results could be a complicated and longtime process. However, thanks to cool tools, such as the Plaso framework, this task became much easier.</p><p><span class="emphasis"><em>Kristinn Gudjonsson</em></span> created the<code class="literal">log2timeline</code> tool, which allows the creation of a super timeline in an automatic way. Originally, it was written in Perl, but later rewritten in Python. The Python version is now called <span class="strong"><strong>Plaso.</strong></span> It has a lot of features and flexible architecture. It allows the addition of new parsers and plugins to process new types of data.</p></div>
<div class="section" title="Plaso architecture"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec32"/>Plaso architecture</h1></div></div></div><p>Let's take a look at Plaso architecture. Plaso has a few core components which perform independent roles:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Preprocessing</li><li class="listitem" style="list-style-type: disc">Collection</li><li class="listitem" style="list-style-type: disc">Worker</li><li class="listitem" style="list-style-type: disc">Storage</li></ul></div><p>Let's look at them in more detail.</p><div class="section" title="Preprocessing"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec49"/>Preprocessing</h2></div></div></div><p>At this stage, some preprocessing tasks should be done prior to all other processing. For example, before mounting the image and determining which OS is installed on the disk, collect some information which will be used in the next stage.</p><p>The preprocessing process should collect the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The version of the OS</li><li class="listitem" style="list-style-type: disc">The hostname</li><li class="listitem" style="list-style-type: disc">Time zone information</li><li class="listitem" style="list-style-type: disc">Default applications, such as the default browser, and so on</li><li class="listitem" style="list-style-type: disc">Enumerate all users and their paths</li></ul></div></div><div class="section" title="Collection"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec50"/>Collection</h2></div></div></div><p>In the collection stage, the process goes over the image, directory, or mount point, and finds all the files that the tool can process.</p><p>The collection could be divided into three different scenarios:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In the simplest case, the collection process recursively goes through either a mount point or an image file and collects every file discovered.</li><li class="listitem" style="list-style-type: disc">During the recursive scan, if VSS are to be parsed, a hash is calculated, based on the four timestamps of every file. During the collection phase, from the VSS image, the hash value is compared to already existing hashes for that file. If the file has not previously been collected, it is included; otherwise, it is skipped.</li><li class="listitem" style="list-style-type: disc">In the case of a targeted collection, a set of file paths is defined and only the files that fit that pattern are collected.</li></ul></div></div><div class="section" title="Worker"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec51"/>Worker</h2></div></div></div><p>The worker is the main part of Plaso. The worker should be monitoring the process queue, and process each file that gets in there. During processing files, the worker will perform the following actions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Determining the type of file</li><li class="listitem" style="list-style-type: disc">Determining which parsers should be applied to it</li><li class="listitem" style="list-style-type: disc">Parsing the file and extract all events from it</li><li class="listitem" style="list-style-type: disc">Applying some defined filters to the file</li><li class="listitem" style="list-style-type: disc">Sending extracted events to the storage queue</li><li class="listitem" style="list-style-type: disc">Determining if this file contains other files within it that can be processed/extracted, and process them as well</li></ul></div></div><div class="section" title="Storage"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec52"/>Storage</h2></div></div></div><p>In the storage stage, events from the storage queue are written to a disk.</p><p>Now, let's consider the main tools from the Plaso framework:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>log2timeline</strong></span>: This is the main command line frontend to the Plaso backend. This is the tool that can be used to extract events from an image, mount point, or a file, and save it in a Plaso storage file for future processing and analysis.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Pinfo</strong></span>: This tool allows the extraction of the information, which is contained in the Plaso storage. It is simple tool, which prints out information from the storage file.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>pprof</strong></span>: This is small tool, which could be useful for developers and those that are interested in trying to optimize certain parsers.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>preg</strong></span>: This tool provides a different frontend to the registry parser. It parses an image or a registry hive and provides the user with a console or shell to work with the registry.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>pshell</strong></span>: This is an iPython console to the Plaso backend. This shell provides the user with access to all the libraries of Plaso and provides an access to more advanced analysis of the output, debugging, and experimentation.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>psort</strong></span>:The storage format of Plaso is not a human-readable format and psort allows the convertion of it to a more convenient form. It is used as a postprocessing tool to filter, sort, and process the Plaso storage file.</li></ul></div></div></div>
<div class="section" title="Plaso in practice"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec33"/>Plaso in practice</h1></div></div></div><p>Let's take a look how we can use Plaso in practice.</p><p>Let's assume that we have an image of the hard drive from the infected PC, and now we need to investigate this case to figure out how the infection occurred.</p><p>First, we need observe the image and determine partitions, which we need to analyze. To do this, we need to use the mmls tool from TSK.</p><p>Then, we can build bodyfile with log2timeline:</p><div class="mediaobject"><img src="graphics/image_05_003.jpg" alt="Plaso in practice"/></div><p>Now, we will use a dynamic format for output. The dynamic output format allows the setting of filtering rules as SQL-SELECT-like requests. We will build our rules based on the following attributes of events:</p><div class="informaltable"><table border="1"><colgroup><col/><col/></colgroup><tbody><tr><td>
<p><span class="strong"><strong>Attribute</strong></span></p>
</td><td>
<p><span class="strong"><strong>Description</strong></span></p>
</td></tr><tr><td>
<p>Date</p>
</td><td>
<p>This is the date of the event</p>
</td></tr><tr><td>
<p>Time</p>
</td><td>
<p>This is the time of the event</p>
</td></tr><tr><td>
<p>Timezone</p>
</td><td>
<p>This is the time zone of the event</p>
</td></tr><tr><td>
<p>Source</p>
</td><td>
<p>This is the source of the event (<code class="literal">FILE</code>,<code class="literal">REG</code>, ...)</p>
</td></tr><tr><td>
<p>Message, Description</p>
</td><td>
<p>This is the description of the event</p>
</td></tr><tr><td>
<p>User</p>
</td><td>
<p>This is the user associated to the event</p>
</td></tr><tr><td>
<p>Host</p>
</td><td>
<p>This is the ID of the computer associated to the event</p>
</td></tr><tr><td>
<p>inode</p>
</td><td>
<p>This is the ID of the file inside the filesystem</p>
</td></tr><tr><td>
<p>Filename</p>
</td><td>
<p>This is the name of the file linked to the event</p>
</td></tr><tr><td>
<p>Macb</p>
</td><td>
<p>This is the MACB timestamp notation</p>
</td></tr><tr><td>
<p>Timestamp_desc</p>
</td><td>
<p>This is the description of the timestamp (<code class="literal">LastWritten</code>,...)</p>
</td></tr><tr><td>
<p>Parser</p>
</td><td>
<p>This is the Module that collects and processes data (<code class="literal">WinRegistryParser</code>, ...)</p>
</td></tr></tbody></table></div><p>When we browse a list of executed files, we found a file with a suspicious name, <code class="literal">ZkPECED.exe</code>. We could use it now as a pivotal point of a timeline investigation.</p><p>So, we can filter all files, which contain the <code class="literal">ZkPECED</code> string in the name of the file.</p><p>The following figure displays the results of searching for events associated with files containing the <code class="literal">ZkPECED</code> keyword in their name, from which it is clear that on April 8, 2014, at 12:39:08 UTC (16:39:08 UTC+4), two files named <code class="literal">ZkPECED.tmp</code> and <code class="literal">ZkPECED.exe</code> were created in<code class="literal">\Users\Alina\AppData\Local\Temp</code> directory:</p><div class="mediaobject"><img src="graphics/image_05_004.jpg" alt="Plaso in practice"/></div><p>Using the <code class="literal">--sliceDateTime</code> and<code class="literal">--slice_sizeMinutes</code> parameters and the <code class="literal">psort.py</code> utility, we can restrict the sample data from the file storage (<code class="literal">timeline.body</code>) to events that occurred in the time range <span class="emphasis"><em>[DateTime-Minutes, DateTime + Minutes]</em></span>.</p><p>As we do not know where the <code class="literal">ZkPECED.exe</code> file executable came from, we perform a search for all executables created or modified within 10 minutes of 12:39:08 UTC:</p><div class="mediaobject"><img src="graphics/image_05_005.jpg" alt="Plaso in practice"/></div><p>Note that just before the appearance of the <code class="literal">ZkPECED.exe</code> file, the metadata of a file in the <code class="literal">systemhost</code> directory with the suspicious name <code class="literal">24FC2AE3CB0.exe</code> (inode 46912) changed (meaning that the file was renamed or moved locally), although its other timestamps (<code class="literal">creation</code>, <code class="literal">last modified</code>, and <code class="literal">last accessed</code>) refer back to 2010:</p><div class="mediaobject"><img src="graphics/image_05_006.jpg" alt="Plaso in practice"/></div><p>Using the <code class="literal">istat</code> utility in TSK suite, we obtain information about the attributes of the <code class="literal">24FC2AE3CB0.exe</code> file (inode 46912):</p><div class="mediaobject"><img src="graphics/image_05_007.jpg" alt="Plaso in practice"/></div><p>The preceding screenshot shows that the timestamps contained in the <code class="literal">$STANDARD_INFORMATION</code> and<code class="literal">$FILENAME</code> attributes do not match, which probably indicates that the timestamps of the<code class="literal">24FC2AE3CB0.exe</code> file (inode 46912) were changed manually.</p><p>Hence, it can be assumed that the <code class="literal">24FC2AE3CB0.exe</code> file (inode 46912) was created on April 8 at 12:31:44 UTC (16:31:44 UTC+4), and that its timestamps (created, last modified, and last accessed) were changed "manually", which is one of the signs of malware.</p><div class="section" title="Analyzing the results"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec53"/>Analyzing the results</h2></div></div></div><p>Analysis of the results of the WinRegistryParser processing module establishes that links to both suspicious executable files are stored in the Windows registry keys that are responsible for auto-running programs at system startup:</p><div class="mediaobject"><img src="graphics/image_05_008.jpg" alt="Analyzing the results"/></div><p>The screenshot also shows the time of the last modification of each of the registry keys.</p><p>As the source of the <code class="literal">24FC2AE3CB0.exe</code> file is also unknown, we perform a search for files created before 12:31:49 UTC, excluding files with <code class="literal">safe</code> extensions from the search results:</p><div class="mediaobject"><img src="graphics/image_05_009.jpg" alt="Analyzing the results"/></div><p>The result of this command will be as follows:</p><div class="mediaobject"><img src="graphics/image_05_010.jpg" alt="Analyzing the results"/></div><p>The screenshot shows that, a few seconds before the appearance of the <code class="literal">24FC2AE3CB0.exe</code> file, the <code class="literal">jp2launcher.exe</code> file process has been started. It starts the Java virtual machine for Java applets and <code class="literal">.jnlp</code> files. So after this, two Java<code class="literal">.idx</code> files named <code class="literal">7d088b-2be562b3.idx</code> (inode 48067) and <code class="literal">57ebc62f-6dfa622f.idx</code> (inode 48074) were created.</p><p>The results of the <code class="literal">JavaIDXParser</code> processing module gives us some information about objects loaded in the Java virtual machine:</p><div class="mediaobject"><img src="graphics/image_05_011.jpg" alt="Analyzing the results"/></div><p>The information displayed in the screenshot shows that a Java archive named <code class="literal">utisl.jar</code> was downloaded from the URL <code class="literal">http://finansial.gov</code> (IP 85.17.137.151), and an unknown object named <code class="literal">2</code> was downloaded from the URL <code class="literal">&gt;http://w282d1wb.athleticsdrycleaner.pw/f/1389931620/4067114524/</code>.</p><p>The <code class="literal">utisl.jar</code> Java archive is saved in the <code class="literal">/Users/Alina/AppData/LocalLow/Sun/Java/Deployment/cache/6.0/11/7d088b-2be562b3</code> file (inode 48068), and the unknown object named <code class="literal">2</code> in<code class="literal">/Users/Alina/AppData/LocalLow/Sun/Java/Deployment/cache/6.0/47/57ebc62f-6dfa622f</code> (inode 48075).</p><p>With the help of the <code class="literal">icat</code> utility in The Sleuth Kit suite, we can obtain the contents of both Java IDX files, from which we extract the size of the objects that were downloaded by the Java virtual machine:</p><div class="mediaobject"><img src="graphics/image_05_012.jpg" alt="Analyzing the results"/></div><p>The output presented in the screenshot indicates that the <code class="literal">utisl.jar</code> file («7d088b-2be562b3») is 14,052 bytes in size:</p><div class="mediaobject"><img src="graphics/image_05_013.jpg" alt="Analyzing the results"/></div><p>The output presented in the figures indicates that the object <span class="strong"><strong>2</strong></span> (<code class="literal">57ebc62f-6dfa622f</code>) is 411,648 bytes.</p><p>This is because, according to the output of the <code class="literal">istat</code> and <code class="literal">icat</code> utilities, the size and contents of the <code class="literal">/systemhost/24FC2AE3CB0.exe</code> (inode 46912) and <code class="literal">/Users/Alina/AppData/LocalLow/Sun/Java/ Deployment/cache/6.0/47/57ebc62f-6dfa622f</code> (inode 48075) files match:</p><div class="mediaobject"><img src="graphics/image_05_014.jpg" alt="Analyzing the results"/></div><p>It can be assumed that on March 13, 2014, a Java applet was downloaded from the URL <code class="literal">http://finansial.gov</code> (IP 85.17.137.151), which, when started, downloaded an executable file of size 411,648 bytes. The body of the file was saved in the <code class="literal">/systemhost/24FC2AE3CB0.exe</code> file. A link to the specified executable file was added as the <code class="literal">YI9B2F0F6EXG1Y1ZLMA</code> parameter in the <code class="literal">HKCU\Software\Microsoft\CurrentVersion\Run</code> registry key, which is responsible for auto-running programs when the operating system starts.</p><p>The results of the <code class="literal">MsiecfParser</code> parser, indicate that while working with Internet Explorer on April 8, 2014, at 12:31:13 UTC, the user accessed, perhaps unknowingly, the resource <code class="literal">http://finansial.gov</code>, from which the <code class="literal">utisl.jar</code> Java applet was subsequently downloaded and executed:</p><div class="mediaobject"><img src="graphics/image_05_015.jpg" alt="Analyzing the results"/></div><p>Next, on analyzing the results of the <code class="literal">WinEvtxParser</code> processing module, we select from the Windows security log (<code class="literal">Security.evtx</code>) successful authentication events in the system (<code class="literal">EventId</code> 4624) after the appearance of the Java <code class="literal">.idx</code> files on April 8, 2014, at 12:31:13 UTC:</p><div class="mediaobject"><img src="graphics/image_05_016.jpg" alt="Analyzing the results"/></div><p>To present the result in a more convenient form, we can convert it with the following commands:</p><pre class="programlisting">
<span class="strong"><strong>sed -r "s/^([^\[]+),.+Strings: \[(.+)\]$/\1\  \2/" |</strong></span>
<span class="strong"><strong>sed -r "s/\s*u'([^']+)'\s*/\|\1\|/g" |</strong></span>
<span class="strong"><strong>sed -r "s/\|+/\|/g" |</strong></span>
<span class="strong"><strong>awk 'BEGIN {FS="\\|"; OFS=", "}; {print $1, $7, $8, $6,&#13;
    $10, $20, $21}'</strong></span>
</pre><p>You can see them in the following screenshot:</p><div class="mediaobject"><img src="graphics/image_05_017.jpg" alt="Analyzing the results"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note9"/>Note</h3><p>Note that the authentication type, <code class="literal">(LogonType)</code>,<code class="literal">10</code>, indicates that the target system made a connection via the RDP protocol.</p></div></div><p>The screenshot shows that on April 8, several RDP protocol connections were made by the user, <code class="literal">SYSTEMSERVICE</code>. Pay attention to two features: the connection was made using IP address 127.0.0.1 (loopback), that is, effectively from the computer under investigation to itself; and the <span class="strong"><strong>security identifiers</strong></span> (<span class="strong"><strong>SIDs</strong></span>) of the user <code class="literal">SYSTEMSERVICE</code> are different, that is, the user was recreated several times in the specified time interval.</p><p>By filtering the results of the <code class="literal">WinEvtxParser</code> module for <code class="literal">EventId</code> 4720 (user creation) and the user name <code class="literal">SYSTEMSERVICE,</code> we come to the conclusion that the specified user was first created on April 8 at 12:40:52 UTC, and three attempts were later made to recreate it:</p><div class="mediaobject"><img src="graphics/image_05_018.jpg" alt="Analyzing the results"/></div><p>So, now we can establish a likely scenario for the incident: on April 8, 2014, the user Alina accessed, perhaps unknowingly, the resource <code class="literal">http://finansial.gov</code>, as a result of which the <code class="literal">utisl.jar</code> Java applet was downloaded and executed.</p><p>Next, an unknown object of size 411,648 bytes was downloaded from the URL, <code class="literal">http://w282d1wb.athleticsdrycleaner.pw/f/1389931620/4067114524/</code>, the body of which was saved in the<code class="literal">/systemhost/24FC2AE3CB0.exe</code> file. A link to the specified executable file was added as the <code class="literal">YI9B2F0F6EXG1Y1ZLMA</code> parameter in the <code class="literal">HKCU\Software\Microsoft\CurrentVersion\Run</code> registry key, which is responsible for auto-running programs at system startup.</p><p>Thereafter, the system repeatedly created a suspicious user named <code class="literal">SYSTEMSERVICE</code>, under which local connections were made to the system via the RDP protocol.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec34"/>Summary</h1></div></div></div><p>In this chapter, we looked at time-related attributions on different filesystems, how to build a timeline with TSK and with the Plaso framework.</p><p>In the next chapter, we will cover how to analyze dates on the NTFS and FAT filesystems. We will continue to work with TSK and study other utilities from TSK.</p></div></body></html>