<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Troubleshooting OpenVPN - Routing</h1></div></div></div><p>In this chapter, we will cover the following troubleshooting topics:</p><div><ul class="itemizedlist"><li class="listitem">The missing return route</li><li class="listitem">Missing return routes when <code class="literal">iroute</code> is used</li><li class="listitem">All clients function except the OpenVPN endpoints</li><li class="listitem">Source routing</li><li class="listitem">Routing and permissions on Windows</li><li class="listitem">Unable to change Windows network location</li><li class="listitem">Troubleshooting client-to-client traffic routing</li><li class="listitem">Understanding the <code class="literal">MULTI: bad source</code> warnings</li><li class="listitem">Failure when redirecting the default gateway</li></ul></div><div><div><div><div><h1 class="title"><a id="ch07lvl1sec74"/>Introduction</h1></div></div></div><p>The topic of this chapter and the previous one is troubleshooting the OpenVPN. This chapter focuses on the all-too-common routing issues that occur when setting up a VPN. As more than half of the questions asked on the <code class="literal">openvpn-users</code> mailing list can be traced back to routing issues, this chapter intends to provide answers to some of the more frequent routing misconfigurations.</p><p>The recipes in these chapters will therefore deal with first, breaking the things, and then, providing the tools for how to find and solve the configuration errors.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec75"/>The missing return route</h1></div></div></div><p>After setting up OpenVPN successfully for the very first time, it is very common to misconfigure the network routes for the VPN. In this recipe, we will first set up a basic TUN-style VPN as is done in <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. At first, routing will not work until the right routes are added. The purpose of this recipe is to describe how to troubleshoot such a routing error.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec273"/>Getting ready</h2></div></div></div><p>We use the following network layout:</p><div><img src="img/image00380.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the <em>Setting up the public and private keys</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file <code class="literal">basic-udp-server.conf</code> from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file <code class="literal">basic-udp-client.conf</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec274"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, start the client:<pre class="programlisting">
<strong>[root@client]# openvpn --config basic-udp-client.conf</strong>
<strong>...</strong>
<strong>... Initialization Sequence Completed</strong>
</pre></li><li class="listitem">At this point, it is possible to ping the remote VPN IP and all the interfaces that are on the VPN server themselves:<pre class="programlisting">        <strong>[client]$ ping -c 2 10.200.0.1</strong>&#13;
        <strong>PING 10.200.0.1 (10.200.0.1) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 10.200.0.1: icmp_seq=1 ttl=64 time=25.2 ms</strong>&#13;
        <strong>64 bytes from 10.200.0.1: icmp_seq=2 ttl=64 time=25.1 ms</strong>&#13;
        <strong>[client]$ ping -c 2 10.198.0.10</strong>&#13;
        <strong>PING 10.198.0.10 (10.198.0.10) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 10.198.0.10: icmp_seq=1 ttl=64 time=24.7 ms</strong>&#13;
        <strong>64 bytes from 10.198.0.10: icmp_seq=2 ttl=64 time=25.0 ms</strong>
</pre><p>If either of these pings fails, then the VPN connection has not been established successfully and there is no need to continue.</p></li><li class="listitem">If no routes have been added to the server-side gateway, then all other hosts on the remote <code class="literal">10.198.0.0/16</code> network will be unavailable:<pre class="programlisting">        <strong>[client]$ ping 10.198.0.1</strong>&#13;
        <strong>PING 10.198.0.1 (10.198.0.1) 56(84) bytes of data.</strong>&#13;
        <strong>^C</strong>&#13;
        <strong>--- 10.198.0.1 ping statistics ---</strong>&#13;
        <strong>1 packets transmitted, 0 received, 100% packet loss, time 764ms</strong>
</pre></li><li class="listitem">If we add a route on the LAN gateway of the remote network to explicitly forward all the VPN traffic to the VPN server, then we can reach all machines on the remote LAN (like it was done in the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>):<pre class="programlisting">        <strong>[gateway]&gt; ip route add 10.200.0.0/24 via 10.198.0.10</strong>
</pre><p>Here, <code class="literal">10.198.1.1</code> is the LAN IP address of the VPN server. In this case, the remote LAN gateway is running Linux. The exact syntax for adding a static route to the gateway will vary with the model and operating system of the gateway.</p></li><li class="listitem">Now, all the machines are reachable:<pre class="programlisting">        <strong>[client]$ ping 10.198.0.1</strong>&#13;
        <strong>PING 10.198.0.1 (10.198.0.1) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 10.198.0.1: icmp_seq=1 ttl=63 time=27.1 ms</strong>&#13;
        <strong>64 bytes from 10.198.0.1: icmp_seq=2 ttl=63 time=25.0 ms</strong>
</pre></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec275"/>How it works...</h2></div></div></div><p>When the VPN client attempts to make a connection to a host on the server-side LAN, packets are sent with a source and destination IP address:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Source IP</strong> = <code class="literal">10.200.0.2</code>: This address is the VPN tunnel's IP address</li><li class="listitem"><strong>Destination IP</strong> = <strong>IP</strong>: This is the IP of the host we're trying to contact</li></ul></div><p>The remote host will want to reply with a packet, with the source and destination IP addresses swapped. When the remote host wants to send the packet, it does not know where to send it to, as the address <code class="literal">10.200.0.2</code> is our private VPN address. It then forwards the packet to the LAN gateway. However, the LAN gateway also does not know where to return the packets to, and will forward them out to its default gateway. When the packets reach a router that is connected directly to the Internet, that router usually will decide to drop (throw away) the packets, causing the host to become unreachable.</p><p>By adding a route on the remote LAN gateway - telling it that all the traffic for the network <code class="literal">10.200.0.0/24</code> should be forwarded to the VPN server - the packets are sent back to the right machine. The VPN server will forward the packets back to the VPN client and the connection is established.</p><p>The step to ping the remote VPN endpoint first and then the server-LAN IP (<code class="literal">10.198.0.10</code>) may seem superfluous at first but these are crucial steps when troubleshooting routing issues. If these steps already fail, then there is no need to look at the missing routes.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec276"/>There's more...</h2></div></div></div><p>In this section, we will focus on different solutions to the problem described in this recipe.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec67"/>Masquerading</h3></div></div></div><p>A quick and dirty solution to the above issue is outlined in the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. In the <em>There's More...</em> section of that recipe, masquerading (a form of NAT'ing) is used to make it appear as if all the traffic is coming from the OpenVPN server itself. This is perfect if you have no control over the remote LAN gateway, but it is not a very clean routing solution. Certain applications do not behave very well when NAT'ted. Also, from a security logging point of view, it is sometimes better to avoid NAT'ting, as you are mapping multiple IP addresses onto a single one, thereby losing information.</p></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec68"/>Adding routes on the LAN hosts</h3></div></div></div><p>Instead of adding a route to the remote LAN gateway, it is also possible to add a route on each of the remote LAN hosts that the VPN client needs to reach. This solution is perfect if the VPN client only needs to be able to reach a limited set of server-side hosts, but it does not scale very well.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec277"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, which contains the basic setup for routing the traffic from the server-side LAN</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec76"/>Missing return routes when iroute is used</h1></div></div></div><p>This recipe is a continuation of the previous one. After ensuring that a single VPN client can reach the server-side LAN, the next step is to make sure that other hosts behind the VPN client can reach the hosts on the server-side LAN.</p><p>In this recipe, we will first set up a VPN as is done in the <em>Routing: subnets on both sides</em> recipe from Chapter 2, <em>Client-Server IP-Only Networks</em>. If no return routes are set up, then the hosts on the client-side LAN will not be able to reach the hosts on the server-side LAN and vice versa. By adding the appropriate routes, the issue is resolved.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec278"/>Getting ready</h2></div></div></div><p>We use the following network layout:</p><div><img src="img/image00381.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file <code class="literal">example2-5-server.conf</code>, from the <em>Routing: subnets on both sides</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration, <code class="literal">basic-udp-client.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec279"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server:<pre class="programlisting">        <strong>[root@server]# openvpn --config example2-5-server.conf</strong>
</pre></li><li class="listitem">Next, start the client:<pre class="programlisting">        <strong>[root@client]# openvpn --config basic-udp-client.conf</strong>&#13;
        <strong>...</strong>&#13;
        <strong>... Initialization Sequence Completed</strong>
</pre></li><li class="listitem">At this point, it is possible to ping the remote VPN IP and all the interfaces that are on the VPN server itself, and vice versa:<pre class="programlisting">        <strong>[client]$ ping -c 2 10.200.0.1</strong>&#13;
        <strong>PING 10.200.0.1 (10.200.0.1) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 10.200.0.1: icmp_seq=1 ttl=64 time=25.2 ms</strong>&#13;
        <strong>64 bytes from 10.200.0.1: icmp_seq=2 ttl=64 time=25.1 ms</strong>&#13;
        <strong>[client]$ ping -c 2 10.198.0.10</strong>&#13;
        <strong>PING 10.198.0.1 (10.198.0.10) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 10.198.0.10: icmp_seq=1 ttl=64 time=24.7 ms</strong>&#13;
        <strong>64 bytes from 10.198.0.10: icmp_seq=2 ttl=64 time=25.0 ms</strong>&#13;
        <strong>[server]$ ping -c 2 10.200.0.2</strong>&#13;
        <strong>PING 10.200.0.2 (10.200.0.2) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 10.200.0.2: icmp_seq=1 ttl=64 time=25.0 ms</strong>&#13;
        <strong>64 bytes from 10.200.0.2: icmp_seq=2 ttl=64 time=24.6 ms</strong>&#13;
        <strong>[server]$ ping -c 2 192.168.4.64</strong>&#13;
        <strong>PING 192.168.4.64 (192.168.4.64) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 192.168.4.64: icmp_seq=1 ttl=64 time=25.2 ms</strong>&#13;
        <strong>64 bytes from 192.168.4.64: icmp_seq=2 ttl=64 time=24.3 ms</strong>
</pre></li><li class="listitem">The routing table on the server shows that the remote network is routed correctly:<pre class="programlisting">        <strong>[server]$ netstat -rn | grep tun0</strong>&#13;
        <strong>192.168.4.0   10.200.0.1 255.255.255.0 UG 0 0 0 tun0</strong>&#13;
        <strong>10.200.0.0 0.0.0.0       255.255.255.0 U  0 0 0 tun0</strong>
</pre></li><li class="listitem">When we try to ping a remote host on the server-side LAN it fails, as was the case in the previous recipe. Vice versa, when we try to ping a client-side LAN host from a host on the server-side LAN, we see:<pre class="programlisting">        <strong>[siteB-host]$ ping -c 2 192.168.4.66</strong>&#13;
        <strong>PING 192.168.4.66 (192.168.4.66) 56(84) bytes of data.</strong>&#13;
        <strong>--- 192.168.4.66 ping statistics ---</strong>&#13;
        <strong>2 packets transmitted, 0 received, 100% packet loss, time 999ms</strong>
</pre></li><li class="listitem">By adding the appropriate routes on the gateways at both the sides, the routing is restored. First, the gateway on the server-side LAN:<pre class="programlisting">        <strong>[gateway1]&gt; ip route add 192.168.4.0/24 via 10.198.0.10</strong>
</pre><p>Here, <code class="literal">10.198.0.10</code> is the LAN IP address of the VPN server.</p><p>Next, the gateway/router on the client-side LAN:</p><pre class="programlisting">        <strong>[gateway2]&gt; ip route add 10.198.0.0/16 via 192.168.4.64</strong>
</pre><p>Here, <code class="literal">192.168.4.64</code> is the LAN IP address of the VPN client.</p></li></ol><div></div><p>After this, the hosts on the LANs can reach each other.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec280"/>How it works...</h2></div></div></div><p>Similar to the previous recipe, when a host on the Site A's LAN attempts to make a connection to a host on the Site B's LAN packets that are sent with a source and destination IP address:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Source IP</strong> = <code class="literal">192.168.4.64</code>: Site A's LAN address</li><li class="listitem"><strong>Destination IP</strong> = <code class="literal">10.198.1.12</code>: Site B's LAN address</li></ul></div><p>The remote host will want to reply with a packet with the source and destination IP addresses swapped. When the remote host wants to send the packet, it forwards the packet to the LAN gateway. However, the LAN gateway also does not know where to return the packets to, and will forward them out to its default gateway. When the packets reach a router that is connected directly to the Internet, then the router usually will decide to drop (throw away) the packets, causing the host to become unreachable.</p><p>A similar problem occurred in the previous recipe, but now the IP addresses of the packets are the actual Site A's and Site B's LAN IP addresses.</p><p>By adding the appropriate routes on both the sides, the problem is alleviated.</p><p>When troubleshooting this sort of routing issue, it is very important to start at the innermost network (the actual VPN, in this case) and then work your way outwards:</p><div><ol class="orderedlist arabic"><li class="listitem">First, make sure the VPN endpoints can see each other.</li><li class="listitem">Make sure the VPN client can reach the server LAN IP and vice versa.</li><li class="listitem">Make sure the VPN client can reach a host on the server-side LAN.</li><li class="listitem">Make sure a host on the server-side LAN can see the VPN client.</li><li class="listitem">Make sure a host on the client-side LAN can see the VPN server.</li><li class="listitem">Finally, make sure a host on the client-side LAN can see a host on the server-side LAN and vice versa.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec281"/>There's more...</h2></div></div></div><p>Again, a quick and a dirty solution to the above issue is outlined in the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. In that recipe, masquerading is used to make it appear as if all the traffic is coming from the OpenVPN server itself. In particular when connecting subnets over a VPN, this is not advisable, as masquerading makes it impossible to tell which client is connecting to which server and vice versa. Therefore, a fully-routed setup is preferred in this case.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec282"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Routing: subnets on both sides</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, which explains in detail how to set up routing on both the client and the server side</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec77"/>All clients function except the OpenVPN endpoints</h1></div></div></div><p>This recipe is again a continuation of the previous one. The previous recipe explained how to troubleshoot routing issues when connecting a client-side LAN (or subnet) to a server-side LAN. However, in the previous recipe, an omission in the routing configuration was made on purpose. In this recipe, we will focus on troubleshooting this quite common omission.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec283"/>Getting ready</h2></div></div></div><p>We use the following network layout:</p><div><img src="img/image00382.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11.</p><p>The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file <code class="literal">example2-5-server.conf</code> from the <em>Routing: subnets on both sides</em> from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, at hand, as well as the client configuration, <code class="literal">basic-udp-client.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec284"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server:<pre class="programlisting">        <strong>[root@server]# openvpn --config example2-5-server.conf</strong>
</pre></li><li class="listitem">Next, start the client:<pre class="programlisting">        <strong>[root@client]# openvpn --config basic-udp-client.conf</strong>&#13;
        <strong>...</strong>&#13;
        <strong>... Initialization Sequence Completed</strong>
</pre></li><li class="listitem">Add the appropriate routes on the gateways at both the sides:<pre class="programlisting">        <strong>[gateway1]&gt; ip route add 192.168.4.0/24 via 10.198.0.10</strong>&#13;
        <strong>[gateway2]&gt; ip route add 10.198.0.0/16 via 192.168.4.64</strong>
</pre><p>After this, all the hosts on the LANs can reach each other.</p></li><li class="listitem">We verify this by pinging various machines on the LANs on either of the sides:<pre class="programlisting">        <strong>[client]$ ping -c 2 10.198.0.10</strong>&#13;
        <strong>[server]$ ping -c 2 192.168.4.64</strong>&#13;
        <strong>[siteA-host]$ ping -c 2 10.198.0.1</strong>&#13;
        <strong>[siteB-host]$ ping -c 2 192.168.4.66</strong>
</pre><p>All of them work. However, when the VPN server tries to ping a host on the client-side LAN, it fails:</p><pre class="programlisting">        <strong>[server]$ ping -c 2 192.168.4.66</strong>&#13;
        <strong>PING 192.168.4.66 (192.168.4.66) 56(84) bytes of data.</strong>&#13;
        <strong>--- 192.168.4.66 ping statistics ---</strong>&#13;
        <strong>2 packets transmitted, 0 received, 100% packet loss, time &#13;
        1009ms</strong>
</pre><p>Similarly, the client can only reach the LAN IP of the server and none of the other hosts.</p></li><li class="listitem">On Linux and UNIX hosts, it is possible to explicitly specify the source IP address:<pre class="programlisting">        <strong>[server]$ ping -I 10.198.0.10 -c 2 192.168.4.66</strong>&#13;
        <strong>PING 192.168.4.66 (192.168.4.66) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 192.168.4.66: icmp_seq=1 ttl=63 time=25.5 ms</strong>&#13;
        <strong>64 bytes from 192.168.4.66: icmp_seq=2 ttl=63 time=24.3 ms</strong>
</pre><p>That works! So, there is a problem with the source address of the packets.</p></li><li class="listitem">By adding an extra route for the VPN subnet itself, to the gateways on both the ends, this issue is resolved:<pre class="programlisting">        <strong>[gateway1]&gt; ip route add 10.200.0.0/24 via 10.198.0.10</strong>&#13;
        <strong>[gateway2]&gt; ip route add 10.200.0.0/24 via 192.168.4.64</strong>
</pre></li><li class="listitem">Now, the VPN server can reach all the hosts on the client's subnet and vice versa:<pre class="programlisting">        <strong>[server]$ ping -c 2 192.168.4.66</strong>&#13;
        <strong>PING 192.168.4.66 (192.168.4.66) 56(84) bytes of data.</strong>&#13;
        <strong>64 bytes from 192.168.4.66: icmp_seq=1 ttl=63 time=25.3 ms</strong>&#13;
        <strong>64 bytes from 192.168.4.66: icmp_seq=2 ttl=63 time=24.9 ms</strong>
</pre></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec285"/>How it works...</h2></div></div></div><p>To troubleshoot issues like these, it is very handy to write out all the source addresses and the destination addresses of the LANs involved. In this case, the problem occurs when the VPN server wants to connect to a host on the client-side LAN. On the VPN server, the packet that is sent to the client-side host is sent out of the VPN interface directly. Therefore, the source address of this packet is set to the IP address of the VPN interface itself. Thus, the packet has the following IP addresses:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Source IP</strong> = <code class="literal">10.200.0.1</code>: VPN server's IP address</li><li class="listitem"><strong>Destination IP</strong> = <code class="literal">192.168.4.66</code>: Site A's LAN address</li></ul></div><p>The remote host will want to reply with a packet with the source and destination IP addresses swapped. When the remote host wants to send the packet, it forwards the packet to the LAN gateway. However, the LAN gateway also does not know where to return the packets to, and will forward them out to its default gateway. When the packets reach a router that is connected directly to the Internet, that router usually will decide to drop (throw away) the packets, causing the host to become unreachable.</p><p>This problem occurs only on the VPN server and VPN client. On all other hosts on the client-side and server-side LAN, the LAN IP address is used and routing works as configured in the previous recipe.</p><p>By adding the appropriate routes on both the sides the problem is resolved.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec286"/>There's more...</h2></div></div></div><p>A good use of NAT'ing in this recipe would be to remove any references to the VPN IP range from the routing tables. This can be done by just masquerading the VPN endpoint addresses. If this is done, the extra routes are no longer needed on the gateways on both the LANs. For example, by adding a NAT'ing rule on the server and a similar one on the client, the extra routes on the gateways are no longer needed.</p><pre class="programlisting">
<strong>[root@server]# iptables -t nat -I POSTROUTING -i tun0 -o eth0 \</strong>
<strong>    -s 10.200.0.0/24 -j MASQUERADE</strong>
<strong>[root@client]# iptables -t nat -I POSTROUTING -i tun0 -o eth0 \</strong>
<strong>    -s 10.200.0.0/24 -j MASQUERADE</strong>
</pre><p>Note that this is easily done on Linux and UNIX-based operating systems but it requires more effort on Windows.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec287"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Routing: subnets on both sides</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, which explains in detail how to set up routing on both the client and the server side</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec78"/>Source routing</h1></div></div></div><p>As the network configurations grow more complex, the requirement for more advanced features, such as the source routing features, increases. Source routing is typically used whenever a server is connected to a network (or the Internet) using two network interfaces (see the following image). In this case, it is important to ensure that the connections that are started on one of the interfaces are kept to that interface. If the incoming traffic for a (VPN) connection is made on the first interface but the return traffic is sent back over the second interface, then VPN connections, amongst others, will fail, as we shall see in this recipe. Source routing is an advanced feature of most of the modern operating systems. In this recipe, we will show how to set up source routing using the Linux <code class="literal">iproute2</code> tools, but the same can be achieved on other operating systems using similar tools.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec288"/>Getting ready</h2></div></div></div><p>We use the following network layout:</p><div><img src="img/image00383.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11 and was connected to a router with two IP addresses: <code class="literal">192.168.4.65</code> and <code class="literal">192.168.2.13</code>; the default gateway for the system was <code class="literal">192.168.2.1</code>, which means that the traffic will leave the interface with the IP address <code class="literal">192.168.2.13</code> by default. The secondary gateway had the IP address <code class="literal">192.168.4.1</code>. The client was running Windows 7 64bit and OpenVPN 2.3.11. The client IP address was <code class="literal">192.168.2.10</code> with default route <code class="literal">192.168.2.1</code>. Keep the configuration file <code class="literal">basic-udp-server.conf</code> from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file <code class="literal">basic-udp-client.ovpn</code> from the <em>Using an ifconfig-pool block</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec289"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, start the client:<div><img src="img/image00384.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In this configuration, the remote server address <code class="literal">openvpnserver.example.com</code> resolves to <code class="literal">192.168.4.65</code>.<p>The connection will fail to start and the client OpenVPN log file will show the following message repeated a few times:</p><pre class="programlisting">        <strong>Wed Aug 25 16:24:28 2010 TCP/UDP: Incoming packet rejected from           192.168.2.13:1194[2], expected peer address: 192.168.4.65:1194 &#13;
        (allow this incoming source address/port by removing --remote &#13;
        or adding --float)</strong>
</pre></li><li class="listitem">By adding a source routing rule to return all the traffic, which comes in on one interface (<code class="literal">192.168.4.65</code>) from a host on the other interface (the subnet <code class="literal">192.168.2.0/24</code>), wants to leave the interface (<code class="literal">192.168.2.0/24</code>) to the router associated with the incoming subnet (<code class="literal">192.168.4.1</code>), the connection is restored:<pre class="programlisting">        <strong>[root@server]# ip route add to default table 100 dev eth0 \</strong>&#13;
        <strong>                  via 192.168.4.1</strong>&#13;
        <strong>[root@server]# ip rule add from 192.168.2.10 priority 50 \</strong>&#13;
        <strong>                  table 100</strong>&#13;
        <strong>[root@server]# ip rule add to 192.168.2.10 priority 50 \</strong>&#13;
        <strong>                   table 100</strong>
</pre><p>Now, the client can successfully connect to the VPN server.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec290"/>How it works...</h2></div></div></div><p>When a connection is made from the client <code class="literal">192.168.2.10</code> to the VPN server <code class="literal">192.168.4.65</code>, the return route is chosen to be the shortest one possible, which in the setup described here is <code class="literal">192.168.2.1</code>. The server operating system will set the return IP address of the packets to <code class="literal">192.168.2.13</code>, as that is the IP address of the interface associated with that network. This confuses the OpenVPN client, as it connects to host <code class="literal">192.168.4.65</code> but gets return traffic from <code class="literal">192.168.2.13</code>. By explicitly forcing traffic to go out the other interface ( <code class="literal">192.168.4.65</code>), this asymmetric routing issue is resolved.</p><p>The exact syntax of the source routing rules is highly dependent on the exact network configuration, but the general idea of the three commands outlined in the section <em>How to do it</em> is to:</p><div><ul class="itemizedlist"><li class="listitem">Create a routing table with ID <code class="literal">100</code> and set the default gateway device for this table to <code class="literal">eth0</code>, which has the IP address <code class="literal">192.168.4.65</code></li><li class="listitem">Create a routing rule that any traffic which comes from client <code class="literal">192.168.2.10</code> is redirected to the routing table</li><li class="listitem">Create a routing rule that any traffic which wants to leave client <code class="literal">192.168.2.10</code> is redirected to the routing table</li></ul></div><p>The routing rules would need to be tweaked for a live situation, as these rules block out certain other types of network traffic, but the principle is correct.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec291"/>There's more...</h2></div></div></div><p>More advanced routing control can be done using <strong>LARTC</strong> (<strong>Linux Advanced Routing and Traffic Control</strong>). A better approach would be to mark packets coming on the interface and only redirect the marked packets to the correct outgoing interface.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec79"/>Routing and permissions on Windows</h1></div></div></div><p>In this recipe, we will focus on the common error experienced by the users when the VPN client machine is running Windows without full or elevated privileges. Under certain circumstances, the OpenVPN client can connect successfully but the routes that are pushed out by the remote server are not correctly set up. This recipe will focus on how to troubleshoot and correct this error.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec292"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Windows 7 64bit and OpenVPN 2.3.11. Keep the configuration file <code class="literal">basic-udp-server.conf</code> from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file <code class="literal">basic-udp-client.ovpn</code> from the <em>Using an ifconfig-pool block</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec293"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Log in on Windows as a non-privileged user, being a user without <code class="literal">Power User</code> or <code class="literal">Administrator</code> privileges. Also, make sure to temporarily remove the <strong>Run as Administrator</strong> flag from OpenVPN to launch OpenVPN without elevated privileges. This can be done by unchecking the <strong>Run this program as an administrator</strong> flag in the OpenVPN GUI properties:<div><img src="img/image00385.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Start the server using the configuration file <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Finally, start the client.<div><img src="img/image00386.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div><p>The connection will start and the OpenVPN GUI light will turn green. However, the client OpenVPN log file will show the following messages:</p><pre class="programlisting">
<strong>... C:\WINDOWS\system32\route.exe ADD 10.198.0.0 MASK 255.255.0.0 10.200.0.1</strong>
<strong>... ROUTE: route addition failed using CreateIpForwardEntry: Network access is denied.   [status=65 if_index=2]</strong>
<strong>... Route addition via IPAPI failed [adaptive]</strong>
<strong>Thu Aug 26 16:47:53 2010 us=187000 Route addition fallback to route.exe</strong>
</pre><p>If you attempt to reach a host on the server-side LAN, it will fail:</p><pre class="programlisting">
<strong>[WinClient]C:\&gt;ping 10.198.0.1</strong>
<strong>Pinging 10.198.0.1 with 32 bytes of data:</strong>
<strong>Request timed out.</strong>
<strong>Ping statistics for 10.198.0.1:</strong>
<strong>Packets: Sent = 1, Received = 0, Lost = 1 (100% loss)</strong>
</pre><p>The solution to this issue is to give the proper networking rights to the user, or to restore elevated privileges for OpenVPN again.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec294"/>How it works...</h2></div></div></div><p>The OpenVPN client tries to open the TAP-Win32 adapter, which is allowed in a default installation. However, when the server pushes out a route to the client using:</p><pre class="programlisting">
<strong>push "route 10.198.0.0 255.255.0.0"</strong>
</pre><p>Then, the OpenVPN client will not be able to actually add this route to the system routing tables, due to missing administrator privileges. However, the VPN connection is successfully established and the GUI client shows a successful connection.</p><p>Note that even without the <code class="literal">push "route"</code> statement, the Windows OpenVPN GUI showed a green icon, suggesting the connection had started. Technically speaking, it is true that the connection has been established, but this should still be considered as a bug.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec295"/>There's more...</h2></div></div></div><p>Windows XP and higher versions include a <strong>Run As Administrator</strong> service that allows a user to temporarily run a program with a higher privilege level. This mechanism was expanded in Windows Vista/7 and was made the default when launching applications. This has actually been the cause of numerous questions on the <code class="literal">openvpn-users</code> mailing list when running OpenVPN on these platforms.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec80"/>Unable to change Windows network location</h1></div></div></div><p>The title of this recipe may not seem related to routing issues, but the Windows network location depends on routing to work. Starting with Windows Vista, Microsoft introduced the concept of network locations. By default, there are multiple network locations: <strong>Home</strong>, <strong>Work</strong> and <strong>Public</strong> for Windows 7 and <strong>Private</strong> and <strong>Public</strong> for Windows 8 and above. These network locations apply to all network adapters, including OpenVPN's virtual TAP-Win network adapter.</p><p>The <strong>Home</strong> network location is intended for a home network. Similarly, the <strong>Work</strong> network location also provides a high level of trust at work, allowing the computer to share files, connect to printers and so on. In Windows 8 and above, the <strong>Home</strong> and <strong>Work</strong> network locations are merged together to become the trusted <strong>Private</strong> network location. The <strong>Public</strong> network location is not trusted and access to network resources is restricted by Windows, even when the Windows firewall is disabled.</p><p>The routing properties of an OpenVPN setup determine whether the TAP-Win adapter is trusted or not, and thus whether file sharing is allowed. In this recipe, we will show how to change an OpenVPN setup so that the network location can be altered.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec296"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Windows 7 64bit and OpenVPN 2.3.11. Keep the configuration file <code class="literal">example2-7-server.conf</code> from the <em>Redirecting the default gateway</em> recipe from Chapter 2, <em>Client-server IP-only Networks</em> at hand, as well as the client configuration file <code class="literal">basic-udp-client.ovpn</code> from the <em>Using an ifconfig-pool block</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec297"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file <code class="literal">example-2-7-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config example2-7-server.conf</strong>
</pre></li><li class="listitem">Next, start the client.<div><img src="img/image00387.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Go to the <strong>Network and Sharing Center</strong> and observe that the TAP adapter is in the section <strong>Public Network</strong> and that it is not possible to change this. Also, try to access a file share via the VPN tunnel. This should not be possible.</li><li class="listitem">Change the server configuration by removing <code class="literal">def1</code> from the <code class="literal">push redirect-gateway def1</code> line:<pre class="programlisting">        push "redirect-gateway" &#13;
</pre></li><li class="listitem">Restart the VPN connection on both sides.</li><li class="listitem">As the VPN connection comes up, Windows will ask you for the location of the new network <strong>Network</strong>:<div><img src="img/image00388.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Choose the <strong>Work network</strong> location, then give the new network the name <code class="literal">VPN</code>.</li><li class="listitem">Now, go to the <strong>Network and Sharing Center</strong> once more and observe that the TAP adapter (named <strong>vpn0</strong>) is in the work network location <strong>VPN</strong>:<div><img src="img/image00389.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec298"/>How it works...</h2></div></div></div><p>Even though all network traffic is routed over the VPN (using <code class="literal">redirect-gateway def1</code>) Windows does not trust the VPN adapter and hence will refuse full access over the VPN tunnel. Windows will only trust a network adapter if it advertises a default gateway (0.0.0.0/0), or the network adapter must be part of a Windows domain. This can be fixed by changing the server configuration to use:</p><pre class="programlisting">push "redirect-gateway" &#13;
</pre></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec299"/>There's more...</h2></div></div></div><p>It is also possible to use the Windows Registry editor to change the network location, but this is not recommended, as it will mark all network adapters as trusted.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec81"/>Troubleshooting client-to-client traffic routing</h1></div></div></div><p>In this recipe, we will troubleshoot a VPN setup where it is the intention that client-to-client traffic is enabled, but the server configuration directive "client-to-client" is missing. In a TUN-style network, it is possible to allow client-to-client traffic without this directive and it even allows the server administrator to apply firewalling rules to the traffic between clients. In a TAP-style network, this is generally not possible, as will be explained in the <em>There's more...</em> section.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec300"/>Getting ready</h2></div></div></div><p>We use the following network layout:</p><div><img src="img/image00390.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The first client was running Fedora 22 Linux and OpenVPN 2.3.11. The second client was running Windows 7 64bit and OpenVPN 2.3.11. Keep the configuration file <code class="literal">basic-udp-server.conf</code> from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file <code class="literal">basic-udp-client.ovpn</code> from the <em>Using an ifconfig-pool block</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec301"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, start the Linux client.<pre class="programlisting">        <strong>[root@client]# openvpn --config basic-udp-client.conf</strong>
</pre></li><li class="listitem">And finally, start the Windows client:<div><img src="img/image00391.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Next, try to ping the Windows client from the Linux client (make sure no firewalls are blocking the traffic):<pre class="programlisting">        <strong>[client]$ ping -c 2 10.200.0.3</strong>&#13;
        <strong>PING 10.200.0.3 (10.200.0.3) 56(84) bytes of data.</strong>&#13;
        <strong>--- 10.200.0.3 ping statistics ---</strong>&#13;
        <strong>2 packets transmitted, 0 received, 100% packet loss, time &#13;
        10999ms</strong>
</pre><p>It is possible that the host is already reachable, but in that case the firewall on the server is very permissive.</p></li><li class="listitem">At this point, it is instructive to set up <code class="literal">iptables</code> logging on the VPN server:<pre class="programlisting">        <strong>[root@server]# iptables -I FORWARD -i tun+ -j LOG</strong>
</pre><p>Then try the ping again. This will result in the following messages in <code class="literal">/var/log/messages</code>:</p><pre class="programlisting">        <strong>... openvpnserver kernel: IN=tun0 OUT=tun0 SRC=10.200.0.2     &#13;
        DST=10.200.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF &#13;
        PROTO=ICMP TYPE=8 CODE=0 ID=40808 SEQ=1 </strong>&#13;
        <strong>... openvpnserver kernel: IN=tun0 OUT=tun0 SRC=10.200.0.2 &#13;
        DST=10.200.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=0 DF &#13;
        PROTO=ICMP TYPE=8 CODE=0 ID=40808 SEQ=2</strong>
</pre></li></ol><div></div><p>The first client <code class="literal">10.200.0.2</code> is trying to reach the second client <code class="literal">10.200.0.3</code>. This issue can be resolved by adding the <code class="literal">client-to-client</code> configuration directive to the server configuration file and restarting the OpenVPN server, or it can be resolved by allowing tunnel traffic to be forwarded:</p><pre class="programlisting">        <strong>[server]# iptables -I FORWARD -i tun+ -o tun+ -j ACCEPT</strong>&#13;
        <strong>[server]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec302"/>How it works...</h2></div></div></div><p>When the first OpenVPN client tries to reach the second client, packets are sent to the server itself. The OpenVPN server does not know how to handle these packets and hands them off to the kernel. The kernel forwards the packets based on whether routing is enabled and whether the firewall rules (<code class="literal">iptables</code>) allow it. If not, then the packet is simply dropped and the second client is never reached.</p><p>By adding the following directive, the OpenVPN server process deals with the client-to-client traffic internally, bypassing the kernel forwarding, and the firewalling rules:</p><pre class="programlisting">client-to-client &#13;
</pre><p>The alternative solution, which is slightly more secure but also less scalable, is to properly set up routing in the Linux kernel.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec303"/>There's more...</h2></div></div></div><p>In a TAP-style network, the above <code class="literal">iptables</code> rule does not work. In a TAP-style network, all the clients are a part of the same broadcast domain. When the <code class="literal">client-to-client</code> directive is omitted and a client tries to reach another client, it first sends out <code class="literal">arp</code> who has messages to find out the MAC address of the other client. The OpenVPN server will ignore these requests and will also not forward them to other clients, regardless of whether an <code class="literal">iptables</code> rule is set or not. Hence, the clients cannot easily reach each other without the <code class="literal">client-to-client</code> directive, unless tricks like proxy-ARP are used.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec304"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Enabling client-to-client traffic</em> recipe, from <a class="link" title="Chapter 3. Client-server Ethernet-style Networks" href="part0038.xhtml#aid-147LC1">Chapter 3</a>, <em>Client-server Ethernet-style Networks</em>, which explains how client-to-client traffic is set up in a TAP-style environment</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec82"/>Understanding the MULTI: bad source warnings</h1></div></div></div><p>In this recipe, we focus again on a VPN configuration where we try to connect a client-side LAN to a server-side LAN. Normally, this is done by adding a <code class="literal">client-config-dir</code> directive to the OpenVPN server configuration, and then by adding the appropriate CCD file. However, if the CCD file is not found or is not readable, then the VPN connection will function properly, but the hosts on the client-side LAN will not be able to reach the hosts on the server-side LAN and vice versa. In this case, the OpenVPN server log file will show messages of the form <code class="literal">MULTI: bad source</code>, if the verbosity is set high enough. In this recipe, we will first set up a VPN as is done in the <em>Routing: </em>
<em>subnets on both sides</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, but with a missing CCD file for the client. Then, we will show how to trigger the <code class="literal">MULTI: bad source</code> warnings and what can be done to resolve the issue.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec305"/>Getting ready</h2></div></div></div><p>We use the following network layout:</p><div><img src="img/image00392.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the first recipe from the <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file <code class="literal">example2-5-server.conf</code> from the <em>Using client-config-dir files</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For the client, keep the configuration file <code class="literal">basic-udp-client.conf</code> from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec306"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">First, make sure the client CCD file is not accessible:<pre class="programlisting">        <strong>[root@server]# chmod 700 /etc/openvpn/cookbook/clients</strong>
</pre></li><li class="listitem">Start the server using the configuration file <code class="literal">example2-5-server.conf</code> and with increased verbosity:<pre class="programlisting">        <strong>[root@server]# openvpn --config example2-5-server.conf --verb 5</strong>
</pre></li><li class="listitem">Next, start the client to connect successfully:<pre class="programlisting">        <strong>[root@client]# openvpn --config basic-udp-client.conf</strong>&#13;
        <strong>...</strong>&#13;
        <strong>... Initialization Sequence Completed</strong>
</pre><p>However, when a host on the client-side LAN tries to reach a machine on the server-side LAN, the following message appears in the OpenVPN server log file:</p><pre class="programlisting">        <strong>... openvpnclient1/client-ip:58370 MULTI: bad source address &#13;
        from client [192.168.4.66], packet dropped</strong>
</pre></li></ol><div></div><p>In this recipe, the root cause of the problem can be resolved as done in the <em>Troubleshooting client-config-dir issues</em> recipe from <a class="link" title="Chapter 6. Troubleshooting OpenVPN - Configurations" href="part0071.xhtml#aid-23MNU1">Chapter 6</a>, <em>Troubleshooting OpenVPN - Configurations</em>, fix the permissions of the directory <code class="literal">/etc/openvpn/cookbook/clients</code> and reconnect the OpenVPN client.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec307"/>How it works...</h2></div></div></div><p>In order to connect a remote LAN to an OpenVPN server, two server-configuration directives are needed:</p><pre class="programlisting">route remote-lan remote-mask &#13;
client-config-dir /etc/openvpn/cookbook/clients &#13;
</pre><p>And also a CCD file containing the name of the client certificate. The CCD file contains:</p><pre class="programlisting">iroute remote-lan remote-mask &#13;
</pre><p>Without this, the OpenVPN server does not know which VPN client the remote network is connected to. If a packet comes in from a client that the OpenVPN server does not know about, then the packet is dropped and, with "verb 5" or higher, the warning <code class="literal">MULTI: bad source</code> is printed.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec308"/>There's more...</h2></div></div></div><p>Apart from the warnings explained above, there is one other major reason for the <code class="literal">MULTI: bad source</code> messages to occur.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec69"/>Other occurrences of the MULTI: bad source message</h3></div></div></div><p>Sometimes the <code class="literal">MULTI: bad source</code> message is printed in the OpenVPN server log file even when no client-side LAN is connected to the VPN client. This happens most often with VPN clients running Windows. When a file share is accessed over the VPN connection, Windows sometimes sends packets with a different source IP address to that of the VPN interface. These packets are not recognized by the OpenVPN server and the warning is printed. The solution to this issue is not known.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec309"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Routing: subnets on both sides</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, which explains the basics of setting up a <code class="literal">client-config-dir</code> setup</li></ul></div><div><ul class="itemizedlist"><li class="listitem">The <em>Troubleshooting client-config-dir issues</em> recipe from <a class="link" title="Chapter 6. Troubleshooting OpenVPN - Configurations" href="part0071.xhtml#aid-23MNU1">Chapter 6</a>, <em>Troubleshooting OpenVPN - Configurations</em>, which goes deeper into some of the frequently made mistakes when using the <code class="literal">client-config-dir</code> directive</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec83"/>Failure when redirecting the default gateway</h1></div></div></div><p>In this recipe, we will troubleshoot an infrequent yet very persistent issue that can occur when setting up a VPN connection. When the <code class="literal">redirect-gateway</code> directive is used to redirect the default gateway on an OpenVPN client, it sometimes causes the client to lose all the Internet connections. This particularly occurs when the client machine on which OpenVPN is running is connected to the rest of the network or with the Internet using a PPP-based connection, such as PPPoE or PPPoA, especially, when using a GPRS/UMTS connections via a mobile phone.</p><p>When this occurs, OpenVPN sometimes is not capable of determining the default gateway before it is redirected. After the default gateway is redirected to the OpenVPN tunnel, the whole tunnel collapses on itself, as all the traffic, including the encrypted tunnel traffic itself, is redirected into the tunnel, causing the VPN to lock up.</p><p>This recipe will show how to detect this situation and what can be done about it. In this recipe, we will not use a GPRS/UMTS connection but we will use a PPP-over-SSH connection, which behaves in a similar fashion and is more readily available.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec310"/>Getting ready</h2></div></div></div><p>We use the following network layout:</p><div><img src="img/image00393.jpeg" alt="Getting ready"/></div><p style="clear:both; height: 1em;"> </p><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file <code class="literal">basic-udp-server.conf</code> from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p><p>Make sure the client is connected to the network using a PPP connection, as otherwise the issue described in the title of this recipe will not occur. For this recipe, a PPP-over-SSH connection and the default route was altered to point to the <code class="literal">ppp0</code> device.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec311"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server and add an extra parameter to direct the default gateway:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf \</strong>&#13;
        <strong>  --push "redirect-gateway"</strong>
</pre></li><li class="listitem">Create the client configuration file:<pre class="programlisting">        client &#13;
        proto udp &#13;
        # next is the IP address of the VPN server via the &#13;
        # PPP-over-SSH link &#13;
        remote 192.168.222.1 &#13;
        port 1194 &#13;
 &#13;
        dev tun &#13;
        nobind &#13;
 &#13;
        ca       /etc/openvpn/cookbook/ca.crt &#13;
        cert     /etc/openvpn/cookbook/client1.crt &#13;
        key      /etc/openvpn/cookbook/client1.key &#13;
        tls-auth /etc/openvpn/cookbook/ta.key 1 &#13;
 &#13;
        user nobody &#13;
        verb 5 &#13;
</pre><p>Save it as <code class="literal">example7-9-client.conf</code>.</p></li><li class="listitem">Check the system routes before starting the client:<pre class="programlisting">        <strong>[root@client]# netstat -rn</strong>&#13;
        <strong>172.30.0.10    172.30.0.1     255.255.255.255 UGH 0 0 0 eth0</strong>&#13;
        <strong>192.168.222.1  0.0.0.0        255.255.255.255 UH  0 0 0 ppp0</strong>&#13;
        <strong>0.0.0.0        192.168.222.1  0.0.0.0         UG  0 0 0 ppp0</strong>
</pre></li><li class="listitem">Now, start the client:<pre class="programlisting">
<strong>[root@client]# openvpn --config example7-9-client.conf</strong>
</pre><p>The connection will start but after a few seconds will stop and the log file will contain a warning message:</p><pre class="programlisting">
<strong>... OpenVPN ROUTE: omitted no-op route:   &#13;
        192.168.222.1/255.255.255.255 -&gt; 192.168.222.1</strong>
</pre></li><li class="listitem">Check the system routes again:<pre class="programlisting">        <strong>[client]$ netstat -rn</strong>&#13;
        <strong>172.30.0.19    172.30.0.1     255.255.255.255 UGH 0 0 0 eth0</strong>&#13;
        <strong>192.168.222.1  0.0.0.0        255.255.255.255 UH  0 0 0 ppp0</strong>&#13;
        <strong>192.16.186.192 0.0.0.0        255.255.255.192 U   0 0 0 eth0</strong>&#13;
        <strong>10.200.0.0  0.0.0.0        255.255.248.0   U   0 0 0 tun0</strong>&#13;
        <strong>10.198.0.0     10.200.0.1  255.255.0.0     UG  0 0 0 tun0</strong>&#13;
        <strong>0.0.0.0        10.200.0.1  0.0.0.0         UG  0 0 0 tun0</strong>
</pre></li></ol><div></div><p>The default gateway is now the VPN tunnel but the original route to the gateway is now gone.</p><p>All the connections on the client have stopped. What's worse, when the OpenVPN client is aborted (by pressing <strong>Ctrl</strong> +<strong>C</strong> in the terminal window) the default route is not restored, as the OpenVPN process does not have the proper rights to do so:</p><pre class="programlisting">TCP/UDP: Closing socket &#13;
/sbin/ip route del 10.198.0.0/16 &#13;
RTNETLINK answers: Operation not permitted &#13;
ERROR: Linux route delete command failed: external program exited with error status: 2 &#13;
/sbin/ip route del 192.168.222.1/32 &#13;
RTNETLINK answers: Operation not permitted &#13;
ERROR: Linux route delete command failed: external program exited with error status: 2 &#13;
/sbin/ip route del 0.0.0.0/0 &#13;
RTNETLINK answers: Operation not permitted &#13;
ERROR: Linux route delete command failed: external program exited with error status: 2 &#13;
/sbin/ip route add 0.0.0.0/0 via 192.168.222.1 &#13;
RTNETLINK answers: Operation not permitted &#13;
ERROR: Linux route add command failed: external program exited with error status: 2 &#13;
Closing TUN/TAP interface &#13;
</pre><p>The result is that the default gateway on the client machine is gone. The only solution is to reload the network adapter so that all the system defaults are restored.</p><p>The solution to the above problem is to use the following as is done in the <em>Redirecting the default gateway</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>:</p><pre class="programlisting">push "redirect-gateway def1" &#13;
</pre></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec312"/>How it works...</h2></div></div></div><p>When the OpenVPN client initializes, it always tries to create a direct route to the OpenVPN server via the existing system gateway. Under certain circumstances this fails, mostly due to an odd network configuration. It is seen most often when the default gateway is a dial-up or PPPoE connection, which is used in certain ADSL/VDSL setups and especially when using GPRS/UMTS connections.</p><p>When the OpenVPN client is instructed to redirect all the traffic over the VPN tunnel, it normally sends the encrypted VPN traffic itself over a direct link to the OpenVPN server. You can think of the encrypted VPN traffic as outside of the tunnel. However, when this direct route is missing, then this outside traffic is also sent into the tunnel, creating a tunneling loop from which the VPN can never recover.</p><p>In the example used in this recipe, the situation is made worse by using the client configuration directive:</p><pre class="programlisting">user nobody&#13;
</pre><p>This tells the OpenVPN process to drop all the privileges after starting. When the client is aborted because the tunnel is not functioning properly, the client is not capable of restoring the original gateway and the system is left in a non-functioning state:</p><pre class="programlisting">
<strong>[client]$ netstat -rn</strong>
<strong>194.171.96.27  192.16.186.254 255.255.255.255 UGH 0 0 0 eth0</strong>
<strong>192.168.222.1  0.0.0.0        255.255.255.255 UH  0 0 0 ppp0</strong>
<strong>192.16.186.192 0.0.0.0        255.255.255.192 U   0 0 0 eth0</strong>
</pre><p>Only by adding a new default gateway can the network be restored.</p><p>The proper fix is to use:</p><pre class="programlisting">
<strong>push "redirect-gateway def1"</strong>
</pre><p>This will not overwrite the existing default gateway but will add two extra routes:</p><pre class="programlisting">0.0.0.0   10.200.0.1 128.0.0.0  UGH 0 0 0 tun0 &#13;
128.0.0.0 10.200.0.1 128.0.0.0  UGH 0 0 0 tun0 &#13;
</pre><p>Both of which cover half the available network space. These two routes effectively replace the existing default route whilst not overwriting it.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec313"/>There's more...</h2></div></div></div><p>This "biting your own tail" problem was much more common with older versions of OpenVPN. In current versions of OpenVPN, the detection of the default gateway was much improved and this problem now rarely occurs anymore. However, it is useful to see what happens when the problem does occur.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec314"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Redirecting the default gateway</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, which explains how to properly redirect all traffic via the VPN tunnel</li></ul></div></div></div></body></html>