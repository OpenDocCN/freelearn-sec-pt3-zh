<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-117"><a id="_idTextAnchor116"/>4</h1>
<h1 id="_idParaDest-118"><a id="_idTextAnchor117"/>Security Automation  Using Shuffle</h1>
<p>Every day, the average security operations team receives over 11,000 security alerts (<a href="https://start.paloaltonetworks.com/forrester-2020-state-of-secops.html">https://start.paloaltonetworks.com/forrester-2020-state-of-secops.html</a>), including suspicious activity, intrusion attempts, privileged user and account monitoring, abnormal external communication, and unauthorized access attempts.</p>
<p>The majority of an analyst’s time (almost 70%) is spent investigating, triaging, or responding to alerts, and the majority of these alerts must be processed manually, greatly slowing down a company’s alert triage process. According to the same report, about 33% of these alerts turn out to be false positives. An SOC analyst can get frustrated with this overwhelming number of security alerts and repetitive false positives. This <a id="_idIndexMarker443"/>leads to the need for security automation, and this is where <strong class="bold">SOAR</strong> (<strong class="bold">Security Orchestration and Automation Response</strong>) plays a critical role. SOAR is a set of security features that enables businesses to collaborate on incident investigation and automate security operations tasks. The <a id="_idIndexMarker444"/>ultimate goal of this SOAR is to reduce the <strong class="bold">MTTR</strong> (<strong class="bold">Mean Time to Respond)</strong>. This is achieved by automating every action or response taken by the SOC analyst. As a result, organizations stop alert fatigue for the SOC analyst and save them time. There are six core elements of SOAR: investigation, incident management, automation, reporting, vulnerability management, and threat intelligence. All of these elements are crucial for building powerful security automation in a network. Although Wazuh has some of these capabilities to build a strong security automation system, we need a third-party tool. In this chapter, we will use the Shuffle platform. Shuffle is an open-source security automation tool.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>What is SOAR?</li>
<li>How a SOC analyst uses SOAR</li>
<li>Setting up Shuffle SOAR</li>
<li>Retrieving Wazuh Alerts</li>
<li>Remotely managing Wazuh</li>
<li>Important Shuffle apps</li>
</ul>
<h1 id="_idParaDest-119"><a id="_idTextAnchor118"/>What is SOAR?</h1>
<p>According to Gartner, “<em class="italic">Security orchestration, automation and response (SOAR) solutions combine incident response, orchestration and automation, and threat intelligence (TI) management capabilities in a single platform</em>.” SOAR tools are used to <a id="_idIndexMarker445"/>implement processes such as security playbooks, workflows, or processes to support a security operation analyst or incident analyst. The functionalities of SOAR are as follows:</p>
<ul>
<li><strong class="bold">Security orchestration</strong>: Security orchestration involves the coordination of security <a id="_idIndexMarker446"/>tasks and workflows across several security tools and teams. It aims to streamline and optimize a response to security incidents and threats. We can create workflows that automate a sequence of security tasks, such as alert triage, investigation, containment, and remediation. This also involves the integration of a wide range of security tools, such as SIEM, firewalls, endpoint protection, and threat intelligence feeds. An example could be orchestrating the isolation of a compromised device from a network when a malware alert is detected.</li>
<li><strong class="bold">Security automation</strong>: Security automation focuses on the execution of predefined <a id="_idIndexMarker447"/>actions in response to security events or incidents. With event-driven workflows and the integration of various security tools, security automation enhances operation efficiency, reduces manual errors, and ensures that security responses align with organizational policies. An example of security automation in SOAR is automatically updating and patching software vulnerabilities as soon as they are discovered.</li>
<li><strong class="bold">Incident response</strong>: Incident response involves the processes and actions taken <a id="_idIndexMarker448"/>when a security incident or data breach occurs. In a SOAR system, incident response is made more efficient by orchestrating and automating security tools, tasks, executions, and so on. For example, when a data breach is detected, the SOAR platform can automatically generate an incident report, notify the relevant stakeholders, and initiate a predefined incident response plan.</li>
</ul>
<p>SOAR integrates the concepts of security orchestration and security automation to provide an all-encompassing incident response strategy.</p>
<p>Next, let’s discuss how an SOC analyst uses a SOAR platform throughout the alert and incident life cycle.</p>
<h1 id="_idParaDest-120"><a id="_idTextAnchor119"/>How a SOC analyst uses SOAR</h1>
<p>A <strong class="bold">Security Operation Center</strong> (<strong class="bold">SOC</strong>) analyst is a cybersecurity professional responsible <a id="_idIndexMarker449"/>for monitoring, detecting, analyzing and mitigating security incidents in an organization. The SOC analyst leverages a SOAR platform <a id="_idIndexMarker450"/>to enhance the efficiency and effectiveness of security <a id="_idIndexMarker451"/>operations. By utilizing SOAR, SOC analysts can make jobs easier, cut down on reaction times, and make sure that security incidents are handled in a more coordinated and consistent way. There are several stages within the incident response process where the SOAR platform can be utilized, as shown in the following diagram.</p>
<div><div><img alt="Figure 4.1 – The flow of the incident response and SOAR" src="img/B19549_4_01.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.1 – The flow of the incident response and SOAR</p>
<p>Based <a id="_idIndexMarker452"/>on the <a id="_idIndexMarker453"/>diagram, each stage can be explained as follows:</p>
<ol>
<li><strong class="bold">Alert generation</strong>: <strong class="bold">SIEM</strong> (<strong class="bold">Security Information and Event Management</strong>) systems, an <strong class="bold">IDS/IPS</strong> (<strong class="bold">Intrusion Detection System/Intrusion Prevention System</strong>), and <a id="_idIndexMarker454"/>endpoint <a id="_idIndexMarker455"/>security solutions monitor network and system activity continuously for potential threats. Wazuh triggers an alert when there is an event matching Wazuh rules, and these alerts can be as follows:<ul><li><strong class="bold">Log analysis alerts</strong>: The Wazuh platform monitors endpoints, network, and application logs for any suspicious activities, and if there is a match based on the rule, it will trigger an alert – for example, detecting multiple failed login attempts within a short period</li><li><strong class="bold">Intrusion detection system (IDS) alerts</strong>: When integrated with Suricata Network-based IDS, Wazuh can analyze network traffic for signs of malicious activities – for example, an alert gets triggered when there is a known vulnerability, network scanning, or known exploits</li><li><strong class="bold">File Integrity Monitoring (FIM) alerts</strong>: Wazuh has an in-build FIM module to detect any unauthorized file changes – for example, unauthorized file modification alerts in the root directory of the Ubuntu server</li></ul></li>
<li><strong class="bold">Alert triage and prioritization</strong>: The SOAR platform uses predefined security rules <a id="_idIndexMarker456"/>and logic to prioritize incoming alerts according <a id="_idIndexMarker457"/>to their severity, origin, and potential impact, such as a brute-force attempt or potential ransomware attack.</li>
<li><strong class="bold">Investigation and context gathering</strong>: This step involves three sub-steps – playbook execution, automated enrichment, and manual analysis:<ol><li class="upper-roman"><strong class="bold">Playbook execution</strong>: For each alert, SOAR can use an incident response playbook. Playbooks are sets of automated and manual actions that guide an analyst through the investigation process.</li><li class="upper-roman"><strong class="bold">Automated enrichment</strong>: The SOAR platform can automatically add context to notifications, such as threat intelligence data, historical logs, and asset information. This contextual information assists the analyst in determining the alert’s veracity and severity.</li><li class="upper-roman"><strong class="bold">Manual analysis</strong>: The analyst evaluates the enriched alert and may perform additional manual investigation. They may query systems, examine records, and utilize their knowledge to determine the nature and scope of the incident.</li></ol><p class="list-inset">Once the investigation and content gathering are completed, the SOAR playbook can be triggered for different actions, as mentioned in the next step.</p></li>
<li><strong class="bold">Containment, eradication and recovery</strong>: During the containment phase of incident <a id="_idIndexMarker458"/>response, immediate actions are taken to limit the intensity of an incident, involving the isolation of affected endpoints to prevent further damage. This is followed by the eradication phase, where organizations focus on removing <a id="_idIndexMarker459"/>threats from the network. It also involves identifying and eliminating the root cause of the incident. Finally, the recovery phase takes care of restoring systems and services to their normal operational state.</li>
</ol>
<p>We’ve learned about how an SOC analyst uses a SOAR platform, using an incident response example. In the next section, we will learn about the Shuffle platform.</p>
<h1 id="_idParaDest-121"><a id="_idTextAnchor120"/>Introduction to Shuffle</h1>
<p><strong class="bold">Shuffle</strong> is an <a id="_idIndexMarker460"/>open-source interpretation of SOAR. It was built by Fredrik Oedegaardstuen. It brings automation with Plug and Play enterprise apps. Shuffle relies heavily on Docker and microservices, making its design modular and powerful. Let’s discuss some <a id="_idIndexMarker461"/>important components and features of Shuffle:</p>
<ul>
<li><strong class="bold">Apps and workflows</strong>: Apps are building blocks in workflows. Workflows are the part of Shuffle where everything comes together. When you first configure Shuffle, it should provide you with more than 100 existing apps. Shuffle covers many of the popular apps, as shown in the following screenshot.</li>
</ul>
<div><div><img alt="Figure 4.2 – App and workflows in Shuffle" src="img/B19549_4_02.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.2 – App and workflows in Shuffle</p>
<ul>
<li><strong class="bold">File analysis</strong>: Shuffle <a id="_idIndexMarker462"/>can help you upload and analyze an email attachment file with Yara. You can also manually upload a file by going to <strong class="bold">Admin</strong> | <strong class="bold">Files</strong>.</li>
</ul>
<div><div><img alt="Figure 4.3 – Files for workflows in Shuffle" src="img/B19549_4_03.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.3 – Files for workflows in Shuffle</p>
<ul>
<li><strong class="bold">Shuffle cache</strong>: Shuffle <a id="_idIndexMarker463"/>can help you store any information in the key-value pair format. The value will be sticky in nature, and <a id="_idIndexMarker464"/>hence, it can be used in a timestamp for security reports, maintaining <strong class="bold">IOC</strong> (<strong class="bold">Indicators of Compromise</strong>) lists, and so on. This is available in the form of Shuffle Tools. Whenever we use the Shuffle Tools app, we need to set the action type to <strong class="bold">Set cache value</strong> for caching to work.</li>
</ul>
<div><div><img alt="Figure 4.4 – The Shuffle cache" src="img/B19549_4_04.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.4 – The Shuffle cache</p>
<ul>
<li><strong class="bold">Trigger</strong>: To achieve <a id="_idIndexMarker465"/>better security automation, Shuffle provides six types of Triggers:<ul><li><strong class="bold">Webhooks</strong>: These allow any outside source to send data in real time to Shuffle.</li><li><strong class="bold">Schedules</strong>: These make it possible to start a workflow on a schedule</li><li><strong class="bold">Subflows</strong>: Want to run another workflow from within your current one? This does that exactly.</li><li><strong class="bold">User input</strong>: Starting or continuing an action based on what an analyst decides.</li><li><strong class="bold">Office365 Email Trigger</strong>: This gets triggered when an email is received. It is useful for phishing analysis.</li><li><strong class="bold">Gmail email trigger</strong>: Similar to Office365, Gmail gets a trigger when a Google user gets an email.</li></ul></li>
<li><strong class="bold">Use cases</strong>: Users can create custom workflows to set up security use cases. The use cases in Shuffle are divided into five types – <em class="italic">Collect</em>, <em class="italic">Enrich</em>, <em class="italic">Detect</em>, <em class="italic">Respond</em>, and <em class="italic">Verify</em>. Each category can have multiple use cases. You can find the list all use cases here: <a href="https://shuffler.io/usecases">https://shuffler.io/usecases</a>.</li>
</ul>
<p>Shuffle is a <a id="_idIndexMarker466"/>powerful security automation platform, offering full user management, multi-factor authentication, single sign-on, multi-tenancy, and a lot more. Now, let’s learn to set up Shuffle using a Docker container.</p>
<h2 id="_idParaDest-122"><a id="_idTextAnchor121"/>Setting up Shuffle SOAR</h2>
<p><strong class="bold">Shuffle SOAR</strong> can be <a id="_idIndexMarker467"/>deployed in self-hosted or in the cloud. For <a id="_idIndexMarker468"/>cloud-based deployment, you simply have to visit their official website (<a href="https://shuffler.io/register">https://shuffler.io/register</a>) and create an account. In this section, we will learn how to deploy Shuffle SOAR using a self-host deployment method. We need to complete the following steps:</p>
<ol>
<li>Requirements</li>
<li>Install Shuffle.</li>
<li>Fix the prerequisites for the Shuffle database.</li>
<li>Launch Shuffle.</li>
</ol>
<h3>Requirements</h3>
<p>Shuffle can <a id="_idIndexMarker469"/>be installed using <code>docker-compose.yml</code> script. As pre-requisites, we need to have the following:</p>
<ul>
<li>Ubuntu Server 22.0 (<a href="https://ubuntu.com/download/server">https://ubuntu.com/download/server</a>)</li>
<li>Docker and Docker Compose installed</li>
</ul>
<h3>Install Shuffle</h3>
<p>When it comes to a Shuffle SOAR self-hosted deployment, currently it is only supported by Docker <a id="_idIndexMarker471"/>and Kubernetes. Here, we will utilize the Docker deployment method, and the package can be downloaded from Docker’s official GitHub repository by following these steps:</p>
<ol>
<li><code>git clone</code> command to download the Shuffle codebase from its GitHub repository:<pre class="source-code">
<strong class="bold">git clone &lt;</strong>https://github.com/Shuffle/Shuffle&gt;</pre></li> <li><strong class="bold">Change the directory to Shuffle</strong>: Move into the directory where the Shuffle code has been cloned:<pre class="source-code">
<strong class="bold">cd shuffle</strong></pre></li> </ol>
<p>Once you have downloaded the packages, you need to fix some dependency issues with the database, as detailed in the next step.</p>
<h3>Fixing the prerequisites for the Shuffle database</h3>
<p>To avoid <a id="_idIndexMarker472"/>issues with the backend database, you are required to set the permissions and change the ownership, as follows:</p>
<ol>
<li><code>shuffle-database</code>:<pre class="source-code">
<code>chmod</code> to supposedly make the directory executable:<pre class="source-code">
<code>chown</code>. You can also use it to assign the directory to a particular user or group (<code>1000:1000</code> in this example):<pre class="source-code">
<strong class="bold">sudo chown -R 1000:1000 shuffle-database</strong></pre></li> </ol>
<h3>Launch Shuffle</h3>
<p>To start Docker Compose, set up and execute Shuffle SOAR in detached mode (<code>-d flag</code>), which means it will run in the background, and you can continue to use your Terminal <a id="_idIndexMarker473"/>for other tasks. Use the following command to run Docker compose in detached mode:</p>
<pre class="console">
sudo docker compose up -d</pre> <p>These instructions essentially walk you through the installation and configuration of Shuffle, ensuring that all necessary components (the OpenSearch database directory, Docker, and Compose) are installed, and then we use Docker Compose to launch the Shuffle SOAR platform.</p>
<p>In the next section, we will learn to integrate Wazuh with Shuffle SOAR and start receiving alerts from the Wazuh platform.</p>
<h1 id="_idParaDest-123"><a id="_idTextAnchor122"/>Retrieving Wazuh alerts</h1>
<p>Wazuh and Shuffle SOAR’s combination offers an excellent synergy for automating a variety of security activities. Renowned for its strong threat detection and response capabilities, Wazuh gathers data from multiple sources throughout the infrastructure to produce alerts <a id="_idIndexMarker474"/>and insights. When combined with Shuffle, a SOAR platform created to make incident response and automation easier, it makes it possible for these alerts to be coordinated easily. By using Shuffle’s automation features, the integration lets security teams set up predefined responses to Wazuh alerts that are immediately carried out. Shuffle SOAR automates the initial analysis of alerts generated by Wazuh, filtering out false positives and prioritizing alerts based on severity. This helps security analysts focus on relevant security incidents.</p>
<p>This integration makes it possible to automate security tasks that used to be done manually, such as sorting alerts, investigating, and taking corrective actions. This frees up security teams to work on more important tasks while still protecting the network. To integrate Wazuh with Shuffle, we need to follow some steps:</p>
<ol>
<li>Integrate Wazuh with Shuffle.</li>
<li>Retrieve Wazuh alerts for abnormal user login analysis.</li>
<li>Retrieve Wazuh alerts for successful login analysis.</li>
</ol>
<h2 id="_idParaDest-124"><a id="_idTextAnchor123"/>Integrating Wazuh with Shuffle</h2>
<p>The best part about Wazuh and Shuffle integration is that Shuffle integration scripts are already <a id="_idIndexMarker475"/>present in the current version of Wazuh, and hence, we don’t have to manually create a new one. We only need to do the following:</p>
<ol>
<li><strong class="bold">Create a new Shuffle workflow</strong>: Go to the Shuffle self-hosted or cloud platform, and then create a new workflow. Next, from the <strong class="bold">Trigger</strong> section, add a Webhook node and copy the Webhook URI. Also, start the Webhook.</li>
</ol>
<div><div><img alt="Figure 4.5 – Create a new Workflow in Shuffle" src="img/B19549_4_05.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.5 – Create a new Workflow in Shuffle</p>
<ol>
<li value="2"><code>ossec.conf</code> file located at the following path:</p><pre class="source-code">
/var/ossec/etc/ossec.conf</pre><p class="list-inset">Next, add the following script:</p><pre class="source-code">&lt;integration&gt;
 &lt;name&gt;shuffle&lt;/name&gt;
&lt;level&gt;3&lt;/level&gt;
&lt;hook_url&gt;[https://&lt;Shuffle_Server_IP&gt;/api/v1/hooks/webhook_b68508da-0727-436c-8f33-412419222441](&lt;https://shuffler.io/api/v1/hooks/webhook_b68508da-0727-436c-8f33-412419222441&gt;)
&lt;/hook_url&gt;
&lt;alert_format&gt;json&lt;/alert_format&gt;
&lt;/integration&gt;</pre><p class="list-inset">Here, we <a id="_idIndexMarker476"/>request Wazuh to push all the level 3 alerts to Shuffle at the Hook URL: https://&lt;Shuffle_Server_IP&gt;/api/v1/hooks/webhook_b68508da-0727-436c-8f33-412419222441.</p><p class="list-inset">In order for Wazuh to take effect, we need to restart the Wazuh dashboard:</p><pre class="source-code"><strong class="bold">systemctl restart wazuh-manager</strong></pre></li> <li><strong class="bold">Testing</strong>: Once the integration is complete, we can come back to Shuffle. You need to save the workflow and run the test execution.</li>
</ol>
<div><div><img alt="Figure 4.6 – Test execution" src="img/B19549_4_06.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.6 – Test execution</p>
<h2 id="_idParaDest-125"><a id="_idTextAnchor124"/>Retrieve Wazuh alerts for abnormal user login analysis</h2>
<p><code>sshd: Attempt to login using a non-existent user</code>, and the alert is shown in the following screenshot.</p>
<div><div><img alt="Figure 4.7 – A Wazuh alert – sshd: Attempt to login using a non-existent user" src="img/B19549_4_07.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.7 – A Wazuh alert – sshd: Attempt to login using a non-existent user</p>
<p>Let’s <a id="_idIndexMarker479"/>break down the preceding screenshot:</p>
<ol>
<li><strong class="bold">Oct 3, 2023 @ 05:59:23.443 sshd: Attempt to login using a non-existent user</strong>: This represents the name of the alert.</li>
<li><strong class="bold">GeoLocation.city_name</strong>: This represents the city name.</li>
<li><strong class="bold">Oct 3 00:29:22 Wazuh-Agent sshd[3608]: Failed password for invalid user kat from 185.255.91.147 port 33872 ssh2</strong>: This represent the full log.</li>
<li><strong class="bold">decoder.name: sshd</strong>: This represents the extracted Wazuh’s decoder. In this case, it is <strong class="bold">sshd</strong>.</li>
</ol>
<h3>Retrieving alerts on Shuffle</h3>
<p>In order <a id="_idIndexMarker480"/>to retrieve these alerts on Shuffle, we need to follow a three-step process:</p>
<ol>
<li><strong class="bold">Create a </strong><strong class="bold">Shuffle workflow</strong>:<ol><li class="upper-roman">Go to the Shuffle platform and click on <strong class="bold">New workflows</strong>. Then, select <strong class="bold">Webhook</strong> from the left-side <strong class="bold">Workflow starters</strong> menu under <strong class="bold">Triggers</strong>, and drag <a id="_idIndexMarker481"/>and drop it to the workflow editor.</li></ol></li>
</ol>
<div><div><img alt="Figure 4.8 – A Shuffle workflow with a Webhook" src="img/B19549_4_08.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.8 – A Shuffle workflow with a Webhook</p>
<ol>
<li class="upper-roman" value="2">Next, click on the Webhook node and copy the Webhook URI. This URI will be used as the hook URL in the Wazuh manager. If you chose a self-hosted version of Shuffle, you would see the IP address instead of shuffler.io (<a href="http://shuffler.io">http://shuffler.io</a>) in the URI.</li>
</ol>
<div><div><img alt="Figure 4.9 – Retrieving the Shuffle Webhook URI" src="img/B19549_4_09.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.9 – Retrieving the Shuffle Webhook URI</p>
<ol>
<li value="2"><code>ossec.conf</code> file, located in the following path:<pre class="source-code">
/var/ossec/etc/ossec.conf</pre><p class="list-inset">Next, add the following script:</p><pre class="source-code">&lt;integration&gt;
&lt;name&gt;shuffle&lt;/name&gt;
&lt;rule_id&gt;5710&lt;/rule_id&gt;
&lt;rule_id&gt;5503&lt;/rule_id&gt;
&lt;rule_id&gt;5760&lt;/rule_id&gt;
&lt;hook_url&gt;[https://&lt;Shuffle_Server_IP&gt;/api/v1/hooks/webhook_b68508da-0727-436c-8f33-412419222441](&lt;https://shuffler.io/api/v1/hooks/webhook_b68508da-0727-436c-8f33-412419222441&gt;)
&lt;/hook_url&gt;
&lt;alert_format&gt;json&lt;/alert_format&gt;
&lt;/integration&gt;</pre><p class="list-inset">Let’s <a id="_idIndexMarker483"/>break down the preceding code:</p><ul><li><code>Rule_id 5710</code> is the Wazuh in-built rule used to detect the <code>Attempt to login</code> using a non-existent user alert</li><li><code>Rule_id 5503</code> and <code>5760</code> are related to SSH login failure</li></ul></li> <li><code>Get_User_Logins</code> node and save the workflow. Next, start the node.</li></ol></li>
</ol>
<div><div><img alt="Figure 4.10 – Start the Webhook URI" src="img/B19549_4_10.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.10 – Start the Webhook URI</p>
<ol>
<li class="upper-roman" value="2">Next, add Shuffle Tools from the <code>Get_User_Logins</code> node. Make sure you set the following:<pre class="l2-source"><strong class="bold">Name: View_response</strong>
<strong class="bold">Find Actions: Repeat back to me</strong>
<strong class="bold">Call: $exec</strong></pre></li>
</ol>
<p>Now, let’s run <a id="_idIndexMarker484"/>the test execution and then click on the show execution button. If everything is good, you should see all the alerts, as shown in the following screenshot:</p>
<div><div><img alt="Figure 4.11 – Wazuh alerts received on Shuffle" src="img/B19549_4_11.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.11 – Wazuh alerts received on Shuffle</p>
<p>Once you expand any part of the alert, you will see the entire alert in JSON format.</p>
<div><div><img alt="Figure 4.12 – A Wazuh alert in the JSON format" src="img/B19549_4_12.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.12 – A Wazuh alert in the JSON format</p>
<h2 id="_idParaDest-126"><a id="_idTextAnchor125"/>Retrieving Wazuh alerts for successful login analysis</h2>
<p>Analyzing <a id="_idIndexMarker485"/>successful logins is just as important as analyzing failed or abnormal login attempts, as it helps to detect unauthorized access, monitor privileged access, monitor for anomalies, and much more. To retrieve Wazuh alerts for successful logins, we only need to make the following changes to the previous steps:</p>
<ol>
<li>Create a new workflow,</li>
<li>Add new integration tags, as follows:<pre class="source-code">
&lt;integration&gt;
&lt;name&gt;shuffle&lt;/name&gt;
&lt;rule_id&gt;5715&lt;/rule_id&gt;
&lt;hook_url&gt;[https://&lt;Shuffle_Server_IP&gt;/api/v1/hooks/webhook_b68508da-0727-436c-8f33-412419222441](&lt;https://shuffler.io/api/v1/hooks/webhook_b68508da-0727-436c-8f33-412419222441&gt;)
&lt;/hook_url&gt;
&lt;alert_format&gt;json&lt;/alert_format&gt;
&lt;/integration&gt;</pre><p class="list-inset">Here, <code>rule_id 5715</code> indicates a successful login to the device. Additionally, you need to replace <code>hook_url</code> with a newly generated URI.</p></li> </ol>
<p>Now that <a id="_idIndexMarker486"/>we understand how to retrieve Wazuh alerts, we should be made aware of some advanced nodes to conduct enrichment, security investigation, incident responses, and so on.</p>
<h1 id="_idParaDest-127"><a id="_idTextAnchor126"/>Remotely managing Wazuh</h1>
<p>Shuffle SOAR is capable of automating multiple security operation activities. When it comes to managing the Wazuh manager and its agent, there is a manual element where a security <a id="_idIndexMarker487"/>analyst has to manually add/remove/modify different attributes. The good news is that Wazuh provides a Wazuh API to allow a trusted party to communicate and send required data. In this section, we will remotely manage multiple Wazuh-related tasks, such as managing agents, rules, CDB lists, agent groups, and decoders. We will cover the following topics in this section:</p>
<ul>
<li>Requirements</li>
<li>Managing Wazuh agents</li>
</ul>
<h2 id="_idParaDest-128"><a id="_idTextAnchor127"/>Requirement</h2>
<p>To remotely <a id="_idIndexMarker488"/>manage Wazuh using Shuffle SOAR, we need to set up three things – authentication, JWT token generation, and subsequent API requests.</p>
<h3>Authentication</h3>
<p>In order to <a id="_idIndexMarker489"/>allow Shuffle to talk to the Wazuh manager, Shuffle initiates the authentication process by providing valid authentication. The default credential of the Wazuh API is the username <code>wazuh-wui</code> and the password <code>wazuh-wui</code>.</p>
<p>Go to Shuffle and create a new workflow, and then follow these steps:</p>
<ol>
<li>From the <strong class="bold">Search Active Apps</strong> section, find the <strong class="bold">Http</strong> app and drag and drop it into the workflow editor.</li>
</ol>
<div><div><img alt="Figure 4.13 – Creating an Http app in a workflow" src="img/B19549_4_13.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.13 – Creating an Http app in a workflow</p>
<ol>
<li value="2">Next, we will create a <code>curl</code> query for authentication, as shown in the following diagram:</li>
</ol>
<div><div><img alt="Figure 4.14 – Authentication using the curl command" src="img/B19549_4_14.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.14 – Authentication using the curl command</p>
<ol>
<li value="3">Set a <a id="_idIndexMarker490"/>relevant name for the node.</li>
<li>Set <strong class="bold">Action</strong> to <strong class="bold">Curl</strong>.</li>
<li>Write a <code>curl</code> statement:<pre class="source-code">
<strong class="bold">curl -u wazuh-wui:wazuh-wui -k -X POST "&lt;https://192.168.29.32:55000/security/user/authenticate?raw=true&gt;"</strong></pre></li> </ol>
<p>Finally, save and click the <strong class="bold">Test </strong><strong class="bold">Execute</strong> button.</p>
<div><div><img alt="Figure 4.15 – Save and execute the curl Command on Shuffle" src="img/B19549_4_15.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.15 – Save and execute the curl Command on Shuffle</p>
<h3>JWT token generation</h3>
<p>Upon <a id="_idIndexMarker491"/>successful authentication, Wazuh generates <a id="_idIndexMarker492"/>a <strong class="bold">JSON Web Token</strong> (<strong class="bold">JWT</strong>). JWTs are often used for authentication and authorization in web applications and APIs.</p>
<div><div><img alt="Figure 4.16 – JWT Token generation" src="img/B19549_4_16.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.16 – JWT Token generation</p>
<h3>The subsequent API request</h3>
<p>Shuffle <a id="_idIndexMarker493"/>can now access all of Wazuh’s protected resources by inserting a JWT token into the HTTP request:</p>
<pre class="console">
curl -k -X &lt;METHOD&gt; "https://&lt;HOST_IP&gt;:55000/&lt;ENDPOINT&gt;" -H "Authorization: Bearer &lt;YOUR_JWT_TOKEN&gt;"</pre> <p>Let’s break down the preceding code:</p>
<ul>
<li><code>-k</code>: This states that <code>curl</code> will allow connections to SSL/TLS-protected (HTTPS) sites without verifying the server’s SSL certificate.</li>
<li><code>-X &lt;Method&gt;</code>: This <code>curl</code> option talks about HTTP request methods such as <code>GET</code>, <code>POST</code>, <code>PUT,</code> and <code>DELETE</code>.</li>
<li><code>&lt;ENDPOINT&gt;</code>: This represents the specific endpoint or resource on the Wazuh manager, such as agents, groups, lists, rules, and decoders.</li>
<li><code>-H</code>: This is <a id="_idIndexMarker494"/>another <code>curl</code> option that adds an HTTP header to the request. In the preceding example, we added an <code>Authorization</code> header with a <code>Bearer</code> value to the JWT token.</li>
</ul>
<h2 id="_idParaDest-129"><a id="_idTextAnchor128"/>Managing Wazuh agents</h2>
<p>We can use the Shuffle tool to manage Wazuh agents for information gathering and incident <a id="_idIndexMarker495"/>response. Wazuh API allows you to add a new agent, remove agents, restart agents, upgrade agents, and retrieve outdated agents using the Shuffle tool.</p>
<p>If you follow the previous steps, you must have retrieved the JWT token. Let’s create a new Shuffle workflow with HTTP nodes, as shown in the following screenshot:</p>
<div><div><img alt="Figure 4.17 – Retrieving Wazuh agent information" src="img/B19549_4_17.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.17 – Retrieving Wazuh agent information</p>
<p>To configure the new workflow, you need to follow the following steps:</p>
<ol>
<li>Add a new <strong class="bold">Http</strong> node.</li>
<li>Enter a name – <code>Agent_info</code>.</li>
<li>Set <strong class="bold">Find Actions</strong> to <strong class="bold">Curl</strong>.</li>
<li>Write a <code>curl</code> command:<pre class="source-code">
<code>$jwt_token</code>: This is a variable that holds the JWT token. This variable name should be the same as the node name.</li></ul></li> </ol>
<p>Next, save and test execute the workflow. You will get an output with all the agent information.</p>
<div><div><img alt="Figure 4.18 – Receiving the Wazuh agent information" src="img/B19549_4_18.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.18 – Receiving the Wazuh agent information</p>
<p>Let’s <a id="_idIndexMarker497"/>break down the preceding screenshot:</p>
<ul>
<li><strong class="bold">Status SUCCESS</strong>: This shows that the API request was successful.</li>
<li><strong class="bold">“affected items”</strong>: This shows the content of the response message. In this case, we have four items about the agent information.</li>
</ul>
<p>To learn <a id="_idIndexMarker498"/>more about managing Wazuh agents, refer to Wazuh’s official documentation at https://documentation.wazuh.com/current/user-manual/api/reference.html#tag/Agents.</p>
<p>We have learned to manage Wazuh remotely using its API. In the following section, we will learn about some important apps and the integration of Shuffle.</p>
<h1 id="_idParaDest-130"><a id="_idTextAnchor129"/>Important Shuffle apps</h1>
<p>The integration of Wazuh and Shuffle SOAR helps a security team to automate multiple recurring activities. It introduces <a id="_idIndexMarker499"/>a paradigm shift in approaching incidents, faster response time, phishing analysis, managing Wazuh, and much more. Shuffle SOAR support integration with hundreds of security tools. In this section, we will discuss some important apps and their integration with Wazuh.</p>
<h2 id="_idParaDest-131"><a id="_idTextAnchor130"/>Incident enrichment using TheHive</h2>
<p>TheHive <a id="_idIndexMarker500"/>is a powerful and a scalable <a id="_idIndexMarker501"/>security incident response tool designed <a id="_idIndexMarker502"/>for SOCs , <strong class="bold">CSIRTs</strong> (<strong class="bold">Computer Security Incident Response Teams</strong>), and <strong class="bold">CERTs</strong> (<strong class="bold">Computer Emergency Response Teams</strong>). We <a id="_idIndexMarker503"/>can use TheHive app <a id="_idIndexMarker504"/>in a Shuffle workflow to add enrichment to every alert before conducting a manual security investigation. Once you integrate TheHive with a Shuffle workflow, you can execute multiple tasks on TheHive by using API endpoints, as shown here.</p>
<div><div><img alt="Figure 4.19 – TheHive API endpoints" src="img/B19549_4_19.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.19 – TheHive API endpoints</p>
<p>An <strong class="bold">API endpoint</strong> is essentially <a id="_idIndexMarker505"/>a unique <strong class="bold">Uniform Resource Identifier</strong> (<strong class="bold">URL</strong>) or URI <a id="_idIndexMarker506"/>that provides <a id="_idIndexMarker507"/>access to an API. It facilitates <a id="_idIndexMarker508"/>communication between various software applications by serving as a point of interaction. In our case, TheHive allows Shuffle to access its capabilities using different API endpoints. For example, if you want to create a case in TheHive tool, you can use the <strong class="bold">Create case</strong> endpoint using the <strong class="bold">POST</strong> method, as shown here:</p>
<div><div><img alt="Figure 4.20 – The Create case endpoint on TheHive platform" src="img/B19549_4_20.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.20 – The Create case endpoint on TheHive platform</p>
<p>Let’s <a id="_idIndexMarker509"/>break down the preceding screenshot:</p>
<ul>
<li><strong class="bold">Apikey</strong>: This is <a id="_idIndexMarker510"/>the API key for the TheHive platform</li>
<li><strong class="bold">Url</strong>: This is <a id="_idIndexMarker511"/>the complete URL for TheHive platform</li>
</ul>
<p>Let’s look at sample workflow published by the Shuffle community. The following workflow starts by receiving a Wazuh alert and then creating a case in TheHive, adding an observable to TheHive case, retrieving artifacts, and finally, running TheHive/Cortex analyzer against MISP and VirusTotal.</p>
<div><div><img alt="Figure 4.21 – Automating TheHive case enrichment using Shuffle" src="img/B19549_4_21.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.21 – Automating TheHive case enrichment using Shuffle</p>
<p>The <a id="_idIndexMarker512"/>link to access this sample workflow <a id="_idIndexMarker513"/>is available here: <a href="https://shuffler.io/workflows/4e9f5826-a7fc-4cc1-b21d-0c7d231bcfa7?queryID=17e8f00cbed5d69823b1a0ad665d4b48">https://shuffler.io/workflows/4e9f5826-a7fc-4cc1-b21d-0c7d231bcfa7?queryID=17e8f00cbed5d69823b1a0ad665d4b48</a>.</p>
<p class="callout-heading">Note</p>
<p class="callout">The <a id="_idIndexMarker514"/>preceding sample workflow can be used once you submit all the required information, such as the Wazuh Webhook URI, TheHive API key and URL, and other essential information. Also, ensure that MISP and VirusTotal are already integrated with TheHive/Cortex to execute the analyzer, as mentioned in the preceding workflow.</p>
<h2 id="_idParaDest-132"><a id="_idTextAnchor131"/>Malware analysis using YARA</h2>
<p><strong class="bold">YARA</strong> is <a id="_idIndexMarker515"/>a tool that empowers malware researchers <a id="_idIndexMarker516"/>in identifying and categorizing malware samples. It’s <a id="_idIndexMarker517"/>a free and open source program that works on Linux, Windows, and macOS. We can use the YARA tool in a Shuffle workflow to analyze an email attachment file or any other file, based on the custom rules defined by malware researchers. Let’s take a look at the sample workflow here.</p>
<div><div><img alt="Figure 4.22 – Automated file analysis using YARA" src="img/B19549_4_22.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.22 – Automated file analysis using YARA</p>
<p>The <a id="_idIndexMarker518"/>preceding workflow was created by Taylor <a id="_idIndexMarker519"/>Walton. This workflow starts by adding an <a id="_idIndexMarker520"/>email attachment to TheHive, then creating an alert on TheHive, and finally, running a YARA scan. To run the YARA scan against each email attachment, we can prepend this workflow as follows.</p>
<div><div><img alt="Figure 4.23 – An email collection workflow" src="img/B19549_4_23.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.23 – An email collection workflow</p>
<h2 id="_idParaDest-133"><a id="_idTextAnchor132"/>Messaging and collaboration tools</h2>
<p>Shuffle <a id="_idIndexMarker521"/>has a range of workplace collaboration <a id="_idIndexMarker522"/>application integration tools, such as Microsoft Teams, Slack, Discord, Outlook, and Gmail. Each application provides tons of API endpoints such as the following:</p>
<ul>
<li>Retrieving emails and creating a message on Outlook</li>
<li>Creating a new chat on Slack</li>
<li>Writing a message to a group on Microsoft Teams and so on</li>
</ul>
<h2 id="_idParaDest-134"><a id="_idTextAnchor133"/>Threat intelligence platforms</h2>
<p>Shuffle <a id="_idIndexMarker523"/>SOAR can be integrated with threat intelligence <a id="_idIndexMarker524"/>platforms such as MISP, AbuseIPDB, and AlienVault OTX, expanding its ability to collect and correlate different threat data:</p>
<ul>
<li><strong class="bold">MISP</strong>: Shuffle <a id="_idIndexMarker525"/>SOAR connects to MISP to gain access to a collaborative threat intelligence-sharing platform, facilitating the exchange of structured threat information.</li>
<li><strong class="bold">AbuseIPDB</strong>: Integration <a id="_idIndexMarker526"/>with AbuseIPDB provides quick access to crowdsourced threat data relating to malicious IP addresses, improving the platform’s ability to detect and block possible threats.</li>
<li><strong class="bold">AlienVault OTX</strong>: Integrating <a id="_idIndexMarker527"/>with AlienVault OTX improves threat visibility by leveraging its vast store of threat indicators and worldwide data. This thorough connection enables Shuffle SOAR users to investigate and respond to security issues in depth by accessing richer, real-time threat intelligence from a variety of trusted sources.</li>
</ul>
<h2 id="_idParaDest-135"><a id="_idTextAnchor134"/>Endpoint protection/antivirus software</h2>
<p>Shuffle provides a seamless integration with top-tier endpoint protection and antivirus solutions <a id="_idIndexMarker528"/>such as CrowdStrike Falcon, Windows Defender, Sophos, and BlackBerry Cylance, improving its efficacy in <a id="_idIndexMarker529"/>incident response and threat prevention. This integration enables direct communication and orchestration between the centralized platform of Shuffle SOAR and these security technologies, enabling automated response actions based on identified threats or incidents. Once integrated, we can create a Shuffle workflow to retrieve alerts from endpoint protection and send them to TheHive for further analysis, get detection rules from CrowdStrike, and so on.</p>
<h1 id="_idParaDest-136"><a id="_idTextAnchor135"/>Summary</h1>
<p>In this chapter, we learned about the purpose of SOAR and how an SOC analyst uses SOAR in a real-world environment. We also learned how to set up a Shuffle SOAR platform using a Docker Compose environment and fixed some backend related issues. This chapter continued with the integration of Wazuh with Shuffle to receive alerts from Wazuh in real time. Finally, we learned how to remotely manage Wazuh using API integration and also covered some popular third-party integrations with Shuffle.</p>
<p>In the next chapter, we will learn about Wazuh’s active response module to build a proactive incident response system. We will also cover some practical incident response use cases.</p>
</div>
</body></html>