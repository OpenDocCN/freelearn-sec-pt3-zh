<html><head></head><body>
<div id="_idContainer060">
<h1 class="chapter-number" id="_idParaDest-84"><a id="_idTextAnchor084"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 id="_idParaDest-85"><a id="_idTextAnchor085"/><span class="koboSpan" id="kobo.2.1">Collecting Network Evidence</span></h1>
<p><span class="koboSpan" id="kobo.3.1">The traditional focus of digital forensics has been on locating evidence on a potentially compromised endpoint. </span><span class="koboSpan" id="kobo.3.2">More specifically, computer forensics is largely focused on a system’s storage. </span><span class="koboSpan" id="kobo.3.3">Law enforcement officers interested in criminal activity such as fraud or child exploitation can find the evidence required for prosecution on a single hard drive. </span><span class="koboSpan" id="kobo.3.4">In the realm of incident response, however, it is critical that the focus extends far beyond a suspected compromised system. </span><span class="koboSpan" id="kobo.3.5">For example, there is a wealth of information that can be obtained within the hardware and software in question, along with the flow of traffic from a compromised host to an external </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Command-and-Control</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">C2</span></strong><span class="koboSpan" id="kobo.7.1">) server.</span></p>
<p><span class="koboSpan" id="kobo.8.1">This chapter focuses on the preparation, identification, and collection of evidence that is commonly found among network devices and along traffic routes within an internal network. </span><span class="koboSpan" id="kobo.8.2">This collection is critical during incidents where an external threat source is in the process of commanding internal systems or stealing data from the network. </span><span class="koboSpan" id="kobo.8.3">Network-based evidence is also useful when examining host evidence, as it provides a second source of event corroboration, which is extremely useful in determining the root cause of an incident.</span></p>
<p><span class="koboSpan" id="kobo.9.1">We will cover the following topics in this chapter:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.10.1">An overview of network evidence</span></li>
<li><span class="koboSpan" id="kobo.11.1">Firewall and proxy logs</span></li>
<li><span class="koboSpan" id="kobo.12.1">NetFlow</span></li>
<li><span class="koboSpan" id="kobo.13.1">TCPDump packet capture</span></li>
<li><span class="koboSpan" id="kobo.14.1">Wireshark packet capture</span></li>
</ul>
<h1 id="_idParaDest-86"><a id="_idTextAnchor086"/><span class="koboSpan" id="kobo.15.1">An overview of network evidence</span></h1>
<p><span class="koboSpan" id="kobo.16.1">There</span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.17.1"> are network log sources that can provide CSIRT personnel and incident responders with good information. </span><span class="koboSpan" id="kobo.17.2">Each network device provides different evidence based on its manufacturer and model. </span><span class="koboSpan" id="kobo.17.3">As a preparation task, CSIRT personnel should become familiar with how to access these devices to obtain the necessary evidence or have existing communication structures in place to engage IT personnel to assist with the proper response techniques during an incident.</span></p>
<p><span class="koboSpan" id="kobo.18.1">Network devices </span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.19.1">such as switches, routers, and firewalls also have their own internal logs that maintain data on who accessed the device and made changes. </span><span class="koboSpan" id="kobo.19.2">Incident responders should become familiar with the types of network devices on their organization’s network and be able to access these logs in the event of an incident:</span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.20.1">Switches</span></strong><span class="koboSpan" id="kobo.21.1">: These </span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.22.1">are spread throughout a network through a combination of core switches that handle traffic from a range of network segments and edge switches that handle traffic for individual segments. </span><span class="koboSpan" id="kobo.22.2">As a result, traffic that originates on a host and travels out of the internal network will traverse several switches. </span><span class="koboSpan" id="kobo.22.3">Switches have two key points of evidence that should be addressed by incident responders. </span><span class="koboSpan" id="kobo.22.4">The</span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.23.1"> first is the </span><strong class="bold"><span class="koboSpan" id="kobo.24.1">Content-Addressable Memory</span></strong><span class="koboSpan" id="kobo.25.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.26.1">CAM</span></strong><span class="koboSpan" id="kobo.27.1">) table. </span><span class="koboSpan" id="kobo.27.2">This CAM table maps the physical ports on the switch to the </span><strong class="bold"><span class="koboSpan" id="kobo.28.1">Network Interface Card</span></strong><span class="koboSpan" id="kobo.29.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.30.1">NIC</span></strong><span class="koboSpan" id="kobo.31.1">) on</span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.32.1"> each device connected to the switch. </span><span class="koboSpan" id="kobo.32.2">Incident responders tracing connections to specific network jacks can utilize this information. </span><span class="koboSpan" id="kobo.32.3">This can aid the identification of possible rogue devices, such as wireless access points or systems connected to the internal network by an adversary. </span><span class="koboSpan" id="kobo.32.4">The second way in which switches can aid an incident investigation is by facilitating network traffic capture.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.33.1">Routers</span></strong><span class="koboSpan" id="kobo.34.1">: Routers </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.35.1">allow organizations to connect multiple LANs into </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.36.1">either a </span><strong class="bold"><span class="koboSpan" id="kobo.37.1">Metropolitan Area Network</span></strong><span class="koboSpan" id="kobo.38.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.39.1">MAN</span></strong><span class="koboSpan" id="kobo.40.1">) or a </span><strong class="bold"><span class="koboSpan" id="kobo.41.1">Wide Area Network</span></strong><span class="koboSpan" id="kobo.42.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.43.1">WAN</span></strong><span class="koboSpan" id="kobo.44.1">). </span><span class="koboSpan" id="kobo.44.2">As </span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.45.1">a result, they handle an extensive amount of traffic. </span><span class="koboSpan" id="kobo.45.2">The key piece of evidentiary information that routers contain is the routing table. </span><span class="koboSpan" id="kobo.45.3">This table holds the information for specific physical ports that map to the networks. </span><span class="koboSpan" id="kobo.45.4">Routers can also be configured to deny specific traffic between networks and maintain logs on allowed traffic and data flows. </span><span class="koboSpan" id="kobo.45.5">Another significant source of evidence that </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.46.1">routers can provide is NetFlow data. </span><span class="koboSpan" id="kobo.46.2">NetFlow provides data on IP addresses, ports, and protocols of network traffic. </span><span class="koboSpan" id="kobo.46.3">This data can be utilized to determine the flow of traffic from various segments of the network (NetFlow will be covered in greater detail later in this chapter).</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.47.1">Firewalls</span></strong><span class="koboSpan" id="kobo.48.1">: Firewalls</span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.49.1"> have changed significantly since the days when they were simply considered to be a different type of router. </span><span class="koboSpan" id="kobo.49.2">Next-generation firewalls contain a wide variety of features, such as intrusion detection and prevention, web filtering, data loss prevention, and detailed logs about allowed and denied traffic. </span><span class="koboSpan" id="kobo.49.3">Often, firewalls serve as a detection mechanism that alerts security personnel to potential incidents. </span><span class="koboSpan" id="kobo.49.4">This can include alerts from features</span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.50.1"> such as </span><strong class="bold"><span class="koboSpan" id="kobo.51.1">Intrusion Detection Systems</span></strong><span class="koboSpan" id="kobo.52.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.53.1">IDSs</span></strong><span class="koboSpan" id="kobo.54.1">)/</span><strong class="bold"><span class="koboSpan" id="kobo.55.1">Intrusion Prevention Systems</span></strong><span class="koboSpan" id="kobo.56.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.57.1">IPSs</span></strong><span class="koboSpan" id="kobo.58.1">), blacklists</span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.59.1"> of known bad URLs or IP addresses, or alerts flagging configuration changes to the firewall without the knowledge of IT personnel. </span><span class="koboSpan" id="kobo.59.2">Incident responders should have as much insight as possible into how their organization’s firewalls function and what data can be obtained prior to an incident.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.60.1">Network IDSs/IPSs</span></strong><span class="koboSpan" id="kobo.61.1">: These systems are purposefully designed to provide security</span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.62.1"> personnel and incident responders with information concerning potential malicious activity on the network infrastructure. </span><span class="koboSpan" id="kobo.62.2">These systems utilize a combination of network monitoring and rulesets to determine whether there is any malicious activity or not. </span><span class="koboSpan" id="kobo.62.3">IDSs are often configured to alert you to a specific malicious activity, while an IPS can detect, but also block, potential malicious activity. </span><span class="koboSpan" id="kobo.62.4">In either case, both types of platform logs are an excellent place for incident responders to locate specific evidence of malicious activity.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.63.1">Web proxy servers</span></strong><span class="koboSpan" id="kobo.64.1">: Organizations </span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.65.1">often utilize web proxy servers to control how users interact with websites and other internet-based resources. </span><span class="koboSpan" id="kobo.65.2">As a result, these devices can give an enterprise-wide picture of web traffic that both originates with and is destined for internal hosts. </span><span class="koboSpan" id="kobo.65.3">Web proxies also have additional features, such as alerting security personnel to connections </span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.66.1">to known malware C2 servers or websites that serve up malware. </span><span class="koboSpan" id="kobo.66.2">A review of web proxy logs in conjunction with a possibly compromised host may identify a source of malicious traffic or a C2 server exerting control over the host.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.67.1">Domain controllers or authentication servers</span></strong><span class="koboSpan" id="kobo.68.1">: Serving the entire network domain, authentication </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.69.1">servers are the primary location that incident </span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.70.1">responders can leverage for details on successful or unsuccessful logins, credential manipulation, or other credential uses.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.71.1">DHCP servers</span></strong><span class="koboSpan" id="kobo.72.1">: Maintaining</span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.73.1"> a list of assigned IP addresses for workstations or laptops within the organization requires an inordinate amount of upkeep. </span><span class="koboSpan" id="kobo.73.2">The</span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.74.1"> use of </span><strong class="bold"><span class="koboSpan" id="kobo.75.1">Dynamic Host Configuration Protocol</span></strong><span class="koboSpan" id="kobo.76.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.77.1">DHCP</span></strong><span class="koboSpan" id="kobo.78.1">) allows for the dynamic assignment of IP addresses to systems on the LAN. </span><span class="koboSpan" id="kobo.78.2">DHCP servers often contain logs on the assignment of IP addresses mapped to the MAC address of the host’s NIC. </span><span class="koboSpan" id="kobo.78.3">This becomes important if an incident responder has to track down a specific workstation or laptop that was connected to the network at a specific date and time.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.79.1">Application servers</span></strong><span class="koboSpan" id="kobo.80.1">: A </span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.81.1">wide range of applications from email to web applications is housed on network servers. </span><span class="koboSpan" id="kobo.81.2">Each of these can provide logs that are specific to the type of application. </span><span class="koboSpan" id="kobo.81.3">Also of interest during an incident investigation are any logs pertaining to remote connections. </span><span class="koboSpan" id="kobo.81.4">Adversaries will often pivot from a compromised system to servers to gain access to confidential data or for other follow-up activities.</span></li>
</ul>
<h2 id="_idParaDest-87"><a id="_idTextAnchor087"/><span class="koboSpan" id="kobo.82.1">Preparation</span></h2>
<p><span class="koboSpan" id="kobo.83.1">As </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.84.1">covered in the previous section, there is a wide range of network devices, each with its own method of aggregating and reporting relevant data. </span><span class="koboSpan" id="kobo.84.2">The ability to acquire network-based evidence is largely dependent on the preparations that are undertaken by an organization prior to an incident. </span><span class="koboSpan" id="kobo.84.3">Without some of the critical components of a proper infrastructure security program, key pieces of evidence will not be readily available to incident responders. </span><span class="koboSpan" id="kobo.84.4">The result is that evidence may be lost while CSIRT     members hunt down critical pieces of information. </span><span class="koboSpan" id="kobo.84.5">In terms of preparation, organizations can aid the CSIRT by having proper network documentation, up-to-date configurations of network devices, and a central log management solution, such as a SIEM, in place.</span></p>
<p><span class="koboSpan" id="kobo.85.1">Another consideration in terms of preparation is to incorporate the specific tasks that need to be performed for proper network evidence collection into the incident response playbooks. </span><span class="koboSpan" id="kobo.85.2">For example, firewall logs that are not sent to a central log management solution, such as a SIEM, are stored on the device itself. </span><span class="koboSpan" id="kobo.85.3">Playbooks that involve acquiring network evidence should be verbose enough to walk through the process of gathering these logs.</span></p>
<p><span class="koboSpan" id="kobo.86.1">Aside from the technical preparation for network evidence collection, CSIRT personnel needs to be aware of any legal or regulatory issues with regard to collecting network evidence. </span><span class="koboSpan" id="kobo.86.2">Additionally, CSIRT personnel needs to be aware that capturing network traffic can be considered an invasion of privacy if there is no policy clearly stating that network monitoring may take place. </span><span class="koboSpan" id="kobo.86.3">Therefore, the legal representative of the CSIRT should ensure that all employees of the organization understand that their use of the information system will be monitored. </span><span class="koboSpan" id="kobo.86.4">This should be expressly stated in policy prior to any</span><a id="_idTextAnchor088"/><span class="koboSpan" id="kobo.87.1"> evidence collection taking place.</span></p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor089"/><span class="koboSpan" id="kobo.88.1">A network diagram</span></h2>
<p><span class="koboSpan" id="kobo.89.1">To</span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.90.1"> identify potential sources of evidence, incident responders need to have a solid understanding of what the internal network infrastructure looks like. </span><span class="koboSpan" id="kobo.90.2">One method that can  be employed by organizations is to create and maintain an up-to-date network diagram. </span><span class="koboSpan" id="kobo.90.3">This diagram should be detailed enough that incident responders can identify individual network components such as switches, routers, or wireless access points. </span><span class="koboSpan" id="kobo.90.4">This diagram should also contain internal IP addresses so that incident responders can immediately access those systems through remote methods. </span><span class="koboSpan" id="kobo.90.5">For instance, examine the following simple network diagram:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer044">
<span class="koboSpan" id="kobo.91.1"><img alt="" src="image/Image_B18571_05_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.92.1">Figure 5.1 – A sample network diagram</span></p>
<p><span class="koboSpan" id="kobo.93.1">This</span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.94.1"> diagram allows for the quick identification of potential evidence sources. </span><span class="koboSpan" id="kobo.94.2">For example, suppose that the laptop connected to the switch at </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">192.168.2.1</span></strong><span class="koboSpan" id="kobo.96.1"> is identified as communicating with a known malware C2 server. </span><span class="koboSpan" id="kobo.96.2">A CSIRT analyst could examine the network diagram and ascertain that the C2 traffic would have to traverse several network hardware components on its way out of the internal network. </span><span class="koboSpan" id="kobo.96.3">For example, there would be traffic traversing the switch at </span><strong class="source-inline"><span class="koboSpan" id="kobo.97.1">192.168.10.1</span></strong><span class="koboSpan" id="kobo.98.1">, through the firewall</span><a id="_idTextAnchor090"/><span class="koboSpan" id="kobo.99.1"> at </span><strong class="source-inline"><span class="koboSpan" id="kobo.100.1">192.168.0.1</span></strong><span class="koboSpan" id="kobo.101.1">, and, finally, from the router out to the internet.</span></p>
<h2 id="_idParaDest-89"><a id="_idTextAnchor091"/><span class="koboSpan" id="kobo.102.1">Configuration</span></h2>
<p><span class="koboSpan" id="kobo.103.1">Determining </span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.104.1">whether an attacker has made modifications to a network device such as a switch or a router can be made easier if the CSIRT has a standard configuration immediately available. </span><span class="koboSpan" id="kobo.104.2">Organizations should already have configurations for network devices stored for disaster recovery purposes but they should also have </span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.105.1">these available to CSIRT members in the event that there is an incident.</span></p>
<h1 id="_idParaDest-90"><a id="_idTextAnchor092"/><span class="koboSpan" id="kobo.106.1">Firewalls and proxy logs</span></h1>
<p><span class="koboSpan" id="kobo.107.1">Two main sources of evidence available while investigating an incident are ingress/egress points into the network from the internet. </span><span class="koboSpan" id="kobo.107.2">Modern malware and other exploits will often require the ability to reach internet-based resources. </span><span class="koboSpan" id="kobo.107.3">This may be for the purpose of downloading additional malware or to exploit code. </span><span class="koboSpan" id="kobo.107.4">Other attacks that involve data exfiltration will require access to the internet. </span><span class="koboSpan" id="kobo.107.5">Finally, adversaries will often have to establish C2 over compromised systems. </span><span class="koboSpan" id="kobo.107.6">In these cases, traffic from various protocols will traverse the perimeter of the victim network. </span><span class="koboSpan" id="kobo.107.7">Depending on the victim, this traffic will have to traverse a firewall, internet proxy, or both. </span><span class="koboSpan" id="kobo.107.8">As a result, both technologies provide incident response personnel with a major source of evidence.</span></p>
<h2 id="_idParaDest-91"><a id="_idTextAnchor093"/><span class="koboSpan" id="kobo.108.1">Firewalls</span></h2>
<p><span class="koboSpan" id="kobo.109.1">Firewalls</span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.110.1"> have evolved from a simplified routing and blocking technology into platforms that provide a significant insight into the traffic coming into and leaving the network. </span><span class="koboSpan" id="kobo.110.2">Next-generation firewalls often combine the deny/allow ruleset with IDSs or IPSs, as well as controlling network access to applications. </span><span class="koboSpan" id="kobo.110.3">This creates a significant source of evidence that can be leveraged during an incident.</span></p>
<p><span class="koboSpan" id="kobo.111.1">Acquiring evidence from firewalls is largely dependent on the manufacturer and the specific model that is used. </span><span class="koboSpan" id="kobo.111.2">Incident responders should thoroughly understand the feature set and specific data that can be obtained as part of their preparation. </span><span class="koboSpan" id="kobo.111.3">Although features differ between vendors and models, there are some key evidence points that are near-universal:</span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.112.1">A connection log</span></strong><span class="koboSpan" id="kobo.113.1">: The</span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.114.1"> connection log provides the source and destination IP addresses and protocols of connections between internal and external systems. </span><span class="koboSpan" id="kobo.114.2">This is critical when determining whether any internal systems may have had contact with an adversary-controlled system or are possibly being controlled. </span><span class="koboSpan" id="kobo.114.3">In addition to allowed connections, the logs may also provide an insight into connections that were denied. </span><span class="koboSpan" id="kobo.114.4">One technique that is often used by adversaries is to use tools to attempt to connect to well-known ports that are commonly in use. </span><span class="koboSpan" id="kobo.114.5">If these ports are closed to </span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.115.1">external connections, there will be a deny entry in the logs. </span><span class="koboSpan" id="kobo.115.2">Successive denies across a range of ports are indicative of reconnaissance activity.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.116.1">Remote access logs</span></strong><span class="koboSpan" id="kobo.117.1">: Firewalls </span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.118.1">often serve as </span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.119.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.120.1">Virtual Private Network</span></strong><span class="koboSpan" id="kobo.121.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.122.1">VPN</span></strong><span class="koboSpan" id="kobo.123.1">) concentrator for remote access. </span><span class="koboSpan" id="kobo.123.2">If a remote user becomes infected via malware, they can introduce that infection into the internal network through the VPN. </span><span class="koboSpan" id="kobo.123.3">Remote access logs will show systems that are connected and at what time they connected. </span><span class="koboSpan" id="kobo.123.4">This may allow incident responders to correlate activities and determine whether a remote user was the source of the infection.</span></li>
</ul>
<h2 id="_idParaDest-92"><a id="_idTextAnchor094"/><span class="koboSpan" id="kobo.124.1">Web application firewalls</span></h2>
<p><span class="koboSpan" id="kobo.125.1">A </span><a id="_idIndexMarker475"/><span class="koboSpan" id="kobo.126.1">special type of firewall is the </span><strong class="bold"><span class="koboSpan" id="kobo.127.1">Web Application Firewall</span></strong><span class="koboSpan" id="kobo.128.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.129.1">WAF</span></strong><span class="koboSpan" id="kobo.130.1">). </span><span class="koboSpan" id="kobo.130.2">This device or software sits between the public internet and a web application. </span><span class="koboSpan" id="kobo.130.3">This </span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.131.1">allows an organization to protect the application from the public. </span><span class="koboSpan" id="kobo.131.2">WAF policies can be changed very quickly to respond to attacks </span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.132.1">such as </span><strong class="bold"><span class="koboSpan" id="kobo.133.1">Denial-of-Service</span></strong><span class="koboSpan" id="kobo.134.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.135.1">DoS</span></strong><span class="koboSpan" id="kobo.136.1">) or adversaries attempting to compromise the web application infrastructure. </span><span class="koboSpan" id="kobo.136.2">From an evidentiary standpoint, WAFs provide analysts with log files of connections made from the internet, along with other data points such as the type of HTTP requests made and information on the systems that access resources. </span><span class="koboSpan" id="kobo.136.3">This is a good source of evidence of attempted or successful exploitation of web servers and web applications. </span></p>
<h2 id="_idParaDest-93"><a id="_idTextAnchor095"/><span class="koboSpan" id="kobo.137.1">Web proxy servers</span></h2>
<p><span class="koboSpan" id="kobo.138.1">Adversaries</span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.139.1"> often make use of scripting such as Microsoft Visual Basic or PowerShell to download secondary exploit packages or malware. </span><span class="koboSpan" id="kobo.139.2">These scripts will often contain a URL that points to the exploit or malware. </span><span class="koboSpan" id="kobo.139.3">Adversaries make use of URLs as opposed to IP addresses, as the IP addresses can be easily changed via domain name registration, allowing them to change their infrastructure without having to change their scripts.</span></p>
<p><span class="koboSpan" id="kobo.140.1">Organizations that make use of web proxy servers for HTTP and HTTPS requests will have a record of any system on the internal network that reached out to an external site. </span><span class="koboSpan" id="kobo.140.2">From here, they may be able to identify the location and, potentially, the malware or exploit that has been downloaded. </span><span class="koboSpan" id="kobo.140.3">Additional insight may be gained from C2 traffic that makes use of similar tactics to malware.</span></p>
<p><span class="koboSpan" id="kobo.141.1">As </span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.142.1">detecting attacks often takes months, it is imperative that incident responders can view the history of an activity that has happened over the span of weeks or even months. </span><span class="koboSpan" id="kobo.142.2">Given the relatively small size of proxy requests, even just the date, time, requesting system, and the URL that was visited can provide a significant piece of evidence that might not be available otherwise.</span></p>
<h1 id="_idParaDest-94"><a id="_idTextAnchor096"/><span class="koboSpan" id="kobo.143.1">NetFlow</span></h1>
<p><span class="koboSpan" id="kobo.144.1">First designed </span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.145.1">by Cisco Systems in 1996, NetFlow is a feature found in network devices such as switches and routers that allows network administrators to monitor traffic within the network. </span><span class="koboSpan" id="kobo.145.2">NetFlow is not strictly a security tool but it does provide a good deal of data to incident responders in the event of an incident. </span><span class="koboSpan" id="kobo.145.3">NetFlow is sent by network devices via the UDP protocol to a central collection point, often called </span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.146.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.147.1">NetFlow Collector</span></strong><span class="koboSpan" id="kobo.148.1">.</span></p>
<p><span class="koboSpan" id="kobo.149.1">In a security context, NetFlow provides deep insights into the internal traffic of systems as they communicate with each other. </span><span class="koboSpan" id="kobo.149.2">This is often referred</span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.150.1"> to as </span><strong class="bold"><span class="koboSpan" id="kobo.151.1">east-west traffic</span></strong><span class="koboSpan" id="kobo.152.1">, as opposed to </span><strong class="bold"><span class="koboSpan" id="kobo.153.1">north-south traffic</span></strong><span class="koboSpan" id="kobo.154.1">, which</span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.155.1"> is used to describe internal systems communicating with external systems through the perimeter firewall. </span><span class="koboSpan" id="kobo.155.2">For example, the following diagram shows a simple network. </span><span class="koboSpan" id="kobo.155.3">In a real-world scenario, an attacker may compromise a system on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.156.1">10.10.2.0/24</span></strong><span class="koboSpan" id="kobo.157.1"> subnet. </span><span class="koboSpan" id="kobo.157.2">From there, they may attempt to pivot to a file server on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">10.10.1.0/24</span></strong><span class="koboSpan" id="kobo.159.1"> subnet. </span><span class="koboSpan" id="kobo.159.2">Once there, they can acquire confidential data and move it back to the compromised system for exfiltration. </span><span class="koboSpan" id="kobo.159.3">The switches forward the NetFlow data to the collector, which includes the IP addresses, protocols, and data size. </span><span class="koboSpan" id="kobo.159.4">This data is critical for providing incident response analysts with details that they may not normally otherwise acquire:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer045">
<span class="koboSpan" id="kobo.160.1"><img alt="" src="image/Image_B18571_05_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.161.1">Figure 5.2 – A NetFlow diagram</span></p>
<p><span class="koboSpan" id="kobo.162.1">NetFlow data is </span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.163.1">limited and depends on the types of devices that are configured to send data to the NetFlow server. </span><span class="koboSpan" id="kobo.163.2">Generally, NetFlow contains the source and destination IP addresses, the source and destination ports, the protocol, and finally, the amount of traffic sent. </span><span class="koboSpan" id="kobo.163.3">Even with this limited information, analysts gain insight into adversary activities, such as potential lateral movement or data exfiltration.</span></p>
<p><span class="koboSpan" id="kobo.164.1">Configuring </span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.165.1">NetFlow is dependent on the type and manufacturer of the network components. </span><span class="koboSpan" id="kobo.165.2">Moreover, there is a wide range of collectors and analysis tools that can be leveraged depending on the budget and other resources. </span><span class="koboSpan" id="kobo.165.3">One of the advantages of including NetFlow analysis in the overall network operations is that it not only provides data to the incident response team, but it is also highly useful in day-to-day network operations in terms of hunting down latency or other communication issues. </span><span class="koboSpan" id="kobo.165.4">This dual purpose makes including it as part of the overall network operations easier to justify.</span></p>
<h1 id="_idParaDest-95"><a id="_idTextAnchor097"/><span class="koboSpan" id="kobo.166.1">Packet capture</span></h1>
<p><span class="koboSpan" id="kobo.167.1">Capturing</span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.168.1"> network traffic is critical to having a full understanding of an incident. </span><span class="koboSpan" id="kobo.168.2">Being able to identify potential C2 IP address traffic may provide further information about the type of malware that has infected a host. </span><span class="koboSpan" id="kobo.168.3">In other types of incidents, CSIRT members may be able to identify potential exfiltration methods that an external threat actor is utilizing.</span></p>
<p><span class="koboSpan" id="kobo.169.1">One method is to set up what is referred to</span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.170.1"> as a </span><strong class="bold"><span class="koboSpan" id="kobo.171.1">network tap</span></strong><span class="koboSpan" id="kobo.172.1">. </span><span class="koboSpan" id="kobo.172.2">A network tap is a system that is in line with the compromised host and the switch. </span><span class="koboSpan" id="kobo.172.3">For example, in the network diagram, if the compromised host is on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">192.168.1.0/24</span></strong><span class="koboSpan" id="kobo.174.1"> subnet, the tap should be placed in between the host and the switch. </span><span class="koboSpan" id="kobo.174.2">This often involves placing a system in between the host and the switch.</span></p>
<p><span class="koboSpan" id="kobo.175.1">Another option is to configure a </span><strong class="bold"><span class="koboSpan" id="kobo.176.1">Switched Port Analyzer</span></strong><span class="koboSpan" id="kobo.177.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.178.1">SPAN</span></strong><span class="koboSpan" id="kobo.179.1">) port. </span><span class="koboSpan" id="kobo.179.2">In this configuration, the</span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.180.1"> switch closest to the compromised host will have port mirroring enabled. </span><span class="koboSpan" id="kobo.180.2">This then sends the traffic from the entire segment the switch is on to the system that is on the mirrored port.</span></p>
<p><span class="koboSpan" id="kobo.181.1">Finally, some network devices have built-in applications, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">tcpdump</span></strong><span class="koboSpan" id="kobo.183.1">, that can be utilized to capture traffic for further analysis. </span><span class="koboSpan" id="kobo.183.2">This may be the quickest option, as it does not require physical access to the network or the switch and can be set up remotely. </span><span class="koboSpan" id="kobo.183.3">The drawback to this method is that storage on the switch may not support a large capture file and the added strain may increase the chances of some packets not being captured.</span></p>
<h2 id="_idParaDest-96"><a id="_idTextAnchor098"/><span class="koboSpan" id="kobo.184.1">tcpdump</span></h2>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">tcpdump</span></strong><span class="koboSpan" id="kobo.186.1"> is a </span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.187.1">command-line tool</span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.188.1"> specifically designed for packet capture. </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">tcpdump</span></strong><span class="koboSpan" id="kobo.190.1"> is often included with Linux distributions and is found on many network devices. </span><span class="koboSpan" id="kobo.190.2">For many of these devices, </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">tcpdump</span></strong><span class="koboSpan" id="kobo.192.1"> has to be run as a root user or with root privileges, as it will be monitoring network traffic. </span><span class="koboSpan" id="kobo.192.2">The relevant documentation is available at </span><a href="http://www.tcpdump.org/"><span class="koboSpan" id="kobo.193.1">http://www.tcpdump.org/</span></a><span class="koboSpan" id="kobo.194.1">. </span><span class="koboSpan" id="kobo.194.2">To </span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.195.1">perform a packet capture with </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">tcpdump</span></strong><span class="koboSpan" id="kobo.197.1">, the </span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.198.1">following process can be used:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.199.1">To access the basic help menu, type the following into Command Prompt:</span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.200.1">arkime@arkime: :~$ tcpdump -h</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.201.1">The command will produce the following help menu:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer046">
<span class="koboSpan" id="kobo.202.1"><img alt="" src="image/Image_B18571_05_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.203.1">Figure 5.3 – The tcpdump help menu</span></p>
<p><span class="koboSpan" id="kobo.204.1">The </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.205.1">default </span><strong class="source-inline"><span class="koboSpan" id="kobo.206.1">tcpdump</span></strong><span class="koboSpan" id="kobo.207.1"> setting is to capture traffic on all available interfaces. </span><span class="koboSpan" id="kobo.207.2">Running the following command produces a list of all the interfaces that </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">tcpdump</span></strong><span class="koboSpan" id="kobo.209.1"> can capture traffic on:</span></p>
<pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.210.1">arkime@arkime::~$ tcpdump -D</span></strong></pre>
<p><span class="koboSpan" id="kobo.211.1">The following screenshot shows that in this case, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">ens160</span></strong><span class="koboSpan" id="kobo.213.1"> (Ethernet) interface and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">lo</span></strong><span class="koboSpan" id="kobo.215.1"> (loopback) interface are available for capturing traffic:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer047">
<span class="koboSpan" id="kobo.216.1"><img alt="" src="image/Image_B18571_05_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.217.1">Figure 5.4 – tcpdump capture interfaces</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.218.1">To configure a basic capture on the Ethernet interface located at </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">ens33</span></strong><span class="koboSpan" id="kobo.220.1"> with normal verbosity, type the following command:</span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.221.1">arkime@arkime:~$ sudo tcpdump -i ens160 -v</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.222.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">-i</span></strong><span class="koboSpan" id="kobo.224.1"> switch tells </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">tcpdump</span></strong><span class="koboSpan" id="kobo.226.1"> which interface to perform the packet capture on. </span><span class="koboSpan" id="kobo.226.2">In this case, it is on the following Ethernet interface: </span><strong class="source-inline"><span class="koboSpan" id="kobo.227.1">ens160</span></strong><span class="koboSpan" id="kobo.228.1">. </span><span class="koboSpan" id="kobo.228.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.229.1">-v</span></strong><span class="koboSpan" id="kobo.230.1"> switch sets the verbosity of the packet capture. </span><span class="koboSpan" id="kobo.230.2">In this case, the verbosity is set rather low. </span><span class="koboSpan" id="kobo.230.3">For </span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.231.1">additional data, the switch can </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.232.1">be set to </span><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">-vvv</span></strong><span class="koboSpan" id="kobo.234.1"> for a more detailed look at the packets. </span><span class="koboSpan" id="kobo.234.2">The following screenshot shows what information is displayed by the command:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer048">
<span class="koboSpan" id="kobo.235.1"><img alt="" src="image/Image_B18571_05_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.236.1">Figure 5.5 – The tcpdump command output</span></p>
<p><span class="koboSpan" id="kobo.237.1">While this method determines whether traffic is traversing that interface or not, the individual packet information is useless to an analyst due to the speed with which the individual packets appear on the screen. </span><span class="koboSpan" id="kobo.237.2">For the packet capture to be of any use, it is recommended that you output the file so that a later examination can be performed with a packet analysis tool such as </span><strong class="bold"><span class="koboSpan" id="kobo.238.1">Wireshark</span></strong><span class="koboSpan" id="kobo.239.1">. </span><span class="koboSpan" id="kobo.239.2">Wireshark will be reviewed later in this chapter and in greater detail in </span><a href="B18571_09.xhtml#_idTextAnchor156"><em class="italic"><span class="koboSpan" id="kobo.240.1">Chapter 9</span></em></a><span class="koboSpan" id="kobo.241.1">.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.242.1">To configure </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">tcpdump</span></strong><span class="koboSpan" id="kobo.244.1"> to output the packet capture to a file, the following command is used:</span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.245.1">arkime@arkime:~$ sudo tcpdump -i ens160 -vvv -w ping_capture</span></strong></pre></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.246.1">PING command</span></p>
<p class="callout"><strong class="bold"><span class="koboSpan" id="kobo.247.1">PING</span></strong><span class="koboSpan" id="kobo.248.1"> (short for </span><strong class="bold"><span class="koboSpan" id="kobo.249.1">Packet Internet Groper</span></strong><span class="koboSpan" id="kobo.250.1">) is the utility that uses the ICMP packets being sent in</span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.251.1"> this section. </span><span class="koboSpan" id="kobo.251.2">PING is used to determine whether there is network connectivity to various systems. </span><span class="koboSpan" id="kobo.251.3">In this case, a check of connectivity to the Google DNS at </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">8.8.8.8</span></strong><span class="koboSpan" id="kobo.253.1"> is being performed.</span></p>
<p><span class="koboSpan" id="kobo.254.1">The </span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.255.1">command tells </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">tcpdump</span></strong><span class="koboSpan" id="kobo.257.1"> to capture </span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.258.1">network traffic and write the file out to capture. </span><span class="koboSpan" id="kobo.258.2">Unlike the previous capture, there is no traffic indicated on the screen.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.259.1">To stop the capture, press </span><em class="italic"><span class="koboSpan" id="kobo.260.1">Ctrl</span></em><span class="koboSpan" id="kobo.261.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.262.1">C</span></em><span class="koboSpan" id="kobo.263.1">, which produces the following information:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer049">
<span class="koboSpan" id="kobo.264.1"><img alt="" src="image/Image_B18571_05_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.265.1">Figure 5.6 – The tcpdump output</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.266.1">After navigating to the root directory, the file can then be opened via a network analysis tool such as Wireshark, as shown:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer050">
<span class="koboSpan" id="kobo.267.1"><img alt="" src="image/Image_B18571_05_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.268.1">Figure 5.7 – Wireshark packet capture analysis</span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">tcpdump</span></strong><span class="koboSpan" id="kobo.270.1"> can also </span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.271.1">be configured to focus the </span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.272.1">capture on specific sources or destination IP addresses and ports. </span><span class="koboSpan" id="kobo.272.2">For example, if an incident response analyst needs to collect packets leaving a specific host at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">192.168.10.54</span></strong><span class="koboSpan" id="kobo.274.1"> IP address, the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">tcpdump</span></strong><span class="koboSpan" id="kobo.276.1"> command will produce the desired results:</span></p>
<pre class="console"><span class="koboSpan" id="kobo.277.1">
arkime@arkime:~$ sudo tcpdump -i ens33 src host 192.168.10.54</span></pre>
<p><span class="koboSpan" id="kobo.278.1">Packets going to a destination such as a known C2 server at the IP address can also be separated from the background network traffic with the following command:</span></p>
<pre class="console"><span class="koboSpan" id="kobo.279.1">
arkime@arkime:~$ sudo tcpdump -i ens33 dst host 162.4.5.23</span></pre>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">tcpdump</span></strong><span class="koboSpan" id="kobo.281.1"> is a powerful tool and has plenty of options. </span><span class="koboSpan" id="kobo.281.2">Incident response analysts are advised to examine and incorporate its various features into their toolkit.</span></p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor099"/><span class="koboSpan" id="kobo.282.1">WinPcap and RawCap</span></h2>
<p><span class="koboSpan" id="kobo.283.1">During an </span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.284.1">incident, it may become necessary to obtain a packet capture from a Windows system. </span><span class="koboSpan" id="kobo.284.2">In incidents such as a compromised web server or application server, a Windows system will not have a native application with which to conduct a packet capture. </span><span class="koboSpan" id="kobo.284.3">There are several packet capture tools available on Windows systems. </span><span class="koboSpan" id="kobo.284.4">The first tool that can be utilized is </span><strong class="bold"><span class="koboSpan" id="kobo.285.1">WinPcap</span></strong><span class="koboSpan" id="kobo.286.1">. </span><span class="koboSpan" id="kobo.286.2">This </span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.287.1">tool is generally recognized as the standard for packet capture on Windows systems and is available for free download </span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.288.1">at </span><a href="https://www.winpcap.org/"><span class="koboSpan" id="kobo.289.1">https://www.winpcap.org/</span></a><span class="koboSpan" id="kobo.290.1">. </span><span class="koboSpan" id="kobo.290.2">The drawback to this tool from a forensics perspective is that it must be installed on the system. </span><span class="koboSpan" id="kobo.290.3">This can complicate a forensic analysis, as any changes to the system have to be thoroughly documented. </span><span class="koboSpan" id="kobo.290.4">For this reason, it is a good preparatory step to ensure that high-risk systems such as web servers, file servers, and application servers already have WinPcap installed.</span></p>
<p><span class="koboSpan" id="kobo.291.1">Another option available to incident response analysts is the use of tools such as </span><strong class="bold"><span class="koboSpan" id="kobo.292.1">RawCap</span></strong><span class="koboSpan" id="kobo.293.1">. </span><span class="koboSpan" id="kobo.293.2">RawCap </span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.294.1">has </span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.295.1">the same basic capability as WinPcap without the need to install it on the local system. </span><span class="koboSpan" id="kobo.295.2">RawCap can be easily run from a USB device attached to the system. </span><span class="koboSpan" id="kobo.295.3">To perform a </span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.296.1">packet capture with RawCap, the following process is used:</span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.297.1">Start Windows Command Prompt as an administrator.</span></li>
<li><span class="koboSpan" id="kobo.298.1">In Command Prompt, navigate to the folder containing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">RawCap.exe</span></strong><span class="koboSpan" id="kobo.300.1"> file. </span><span class="koboSpan" id="kobo.300.2">For a list of options, type the following:</span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.301.1">D:\&gt;RawCap.exe -help</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.302.1">The command will produce the following output:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer051">
<span class="koboSpan" id="kobo.303.1"><img alt="" src="image/Image_B18571_05_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.304.1">Figure 5.8 – The Rawcap.exe menu</span></p>
<p><span class="koboSpan" id="kobo.305.1">The </span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.306.1">output produces a list of interfaces. </span><span class="koboSpan" id="kobo.306.2">One of the advantages of RawCap is that, even from a USB device, the incident response analyst can perform a packet capture on each of the interfaces. </span><span class="koboSpan" id="kobo.306.3">In</span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.307.1"> this example, the capture will be performed on the Ethernet interface indicated by the number 0.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.308.1">To start the packet capture, RawCap requires the network interface where the traffic should be captured, and an output file to output the packet capture. </span><span class="koboSpan" id="kobo.308.2">To capture the traffic on the wireless interface and output it to a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.309.1">RawCap.pcap</span></strong><span class="koboSpan" id="kobo.310.1">, the following command is used:</span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.311.1">C:\ProgramData\chocolatey\bin\RawCap.exe 0 RawCap.pcap</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.312.1">The command produces the following output:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer052">
<span class="koboSpan" id="kobo.313.1"><img alt="" src="image/Image_B18571_05_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.314.1">Figure 5.9 – The output of a RawCap packet capture</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.315.1">Pressing </span><em class="italic"><span class="koboSpan" id="kobo.316.1">Ctrl</span></em><span class="koboSpan" id="kobo.317.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.318.1">C</span></em><span class="koboSpan" id="kobo.319.1"> will stop the capture. </span><span class="koboSpan" id="kobo.319.2">The capture file, </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">RawCap.pcap</span></strong><span class="koboSpan" id="kobo.321.1">, is saved </span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.322.1">to the same directory as the </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">RawCap.exe</span></strong><span class="koboSpan" id="kobo.324.1"> file. </span><span class="koboSpan" id="kobo.324.2">This </span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.325.1">file can then be opened with tools such as Wireshark for further analysis:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer053">
<span class="koboSpan" id="kobo.326.1"><img alt="" src="image/Image_B18571_05_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.327.1">Figure 5.10 – Analysis of the RawCap file in Wireshark </span></p>
<p><span class="koboSpan" id="kobo.328.1">Now that we have introduced Wireshark, we will examine how the tool can also be used to capture network traffic.</span></p>
<h1 id="_idParaDest-98"><a id="_idTextAnchor100"/><span class="koboSpan" id="kobo.329.1">Wireshark</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.330.1">Wireshark</span></strong><span class="koboSpan" id="kobo.331.1"> is a </span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.332.1">Unix or Windows packet capture and analysis tool. </span><span class="koboSpan" id="kobo.332.2">Unlike </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">tcpdump</span></strong><span class="koboSpan" id="kobo.334.1"> or tools such as RawCap, Wireshark is a GUI-based tool and includes </span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.335.1">not only packet capture but also analysis features. </span><span class="koboSpan" id="kobo.335.2">As a result, Wireshark may be difficult to deploy rapidly during an</span><a id="_idIndexMarker513"/><span class="koboSpan" id="kobo.336.1"> incident, as the program has to be installed. </span><span class="koboSpan" id="kobo.336.2">Furthermore, the tool is only supported on Windows or macOS. </span><span class="koboSpan" id="kobo.336.3">Installing Wireshark on a Linux system requires a bit more effort. </span><span class="koboSpan" id="kobo.336.4">The one distinct advantage that Wireshark has over command-line options is that incident response analysts can perform a detailed inspection of the traffic as it is being captured. </span><span class="koboSpan" id="kobo.336.5">Wireshark can be run on the system itself or on a USB drive. </span><span class="koboSpan" id="kobo.336.6">Once installed, it must be run as an administrator. </span><span class="koboSpan" id="kobo.336.7">To perform a packet capture with Wireshark, the following process is used:</span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.337.1">The first step is to select an interface where Wireshark will capture traffic:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer054">
<span class="koboSpan" id="kobo.338.1"><img alt="" src="image/Image_B18571_05_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.339.1">Figure 5.11 – Wireshark Capture interfaces</span></p>
<p><span class="koboSpan" id="kobo.340.1">In the screenshot, there is only one interface that appears to be handling traffic. </span><span class="koboSpan" id="kobo.340.2">The capture will be performed on the </span><strong class="bold"><span class="koboSpan" id="kobo.341.1">Ethernet0</span></strong><span class="koboSpan" id="kobo.342.1"> interface.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.343.1">Double-clicking on the interface will start a packet capture. </span><span class="koboSpan" id="kobo.343.2">As was stated before, unlike </span><strong class="bold"><span class="koboSpan" id="kobo.344.1">tcpdump</span></strong><span class="koboSpan" id="kobo.345.1"> or RawCap, the actual capture is outputted to the screen </span><a id="_idIndexMarker514"/><span class="koboSpan" id="kobo.346.1">for </span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.347.1">immediate analysis:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer055">
<span class="koboSpan" id="kobo.348.1"><img alt="" src="image/Image_B18571_05_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.349.1">Figure 5.12 – A Wireshark capture view</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.350.1">To stop the capture, click the red box in the upper-left corner of the pane. </span><span class="koboSpan" id="kobo.350.2">The file can then be saved for further analysis.</span></li>
</ol>
<p><span class="koboSpan" id="kobo.351.1">Another tool that is included with Wireshark and is useful during evidence acquisition is </span><strong class="bold"><span class="koboSpan" id="kobo.352.1">mergecap</span></strong><span class="koboSpan" id="kobo.353.1">. </span><strong class="bold"><span class="koboSpan" id="kobo.354.1">mergecap</span></strong><span class="koboSpan" id="kobo.355.1"> is a command-line tool that allows incident response analysts to combine multiple packet capture files from Wireshark, </span><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">tcpdump</span></strong><span class="koboSpan" id="kobo.357.1">, or RawCap. </span><span class="koboSpan" id="kobo.357.2">This is extremely useful in situations where incident response analysts obtain packet captures from </span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.358.1">several sources but want to check for traffic to </span><a id="_idIndexMarker517"/><span class="koboSpan" id="kobo.359.1">a specific host. </span><span class="koboSpan" id="kobo.359.2">To access the menu for mergecap, type the following into Command Prompt:</span></p>
<pre class="console"><span class="koboSpan" id="kobo.360.1">
arkimie@arkime:~$mergecap -help</span></pre>
<p><span class="koboSpan" id="kobo.361.1">That command produces the following help information:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer056">
<span class="koboSpan" id="kobo.362.1"><img alt="" src="image/Image_B18571_05_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.363.1">Figure 5.13 – The mergecap help menu</span></p>
<p><span class="koboSpan" id="kobo.364.1">To merge several packet capture files, the following command is used:</span></p>
<pre class="console"><span class="koboSpan" id="kobo.365.1">
arkime@arkime:~$mergecap -w switches.pcap switch1.pcap switch2.pcap switch3.pcap</span></pre>
<p><span class="koboSpan" id="kobo.366.1">By combining the output of three packet captures into one file, the incident response analyst can examine a wider range of activities across multiple network paths. </span><span class="koboSpan" id="kobo.366.2">If, for example, the analyst is searching for traffic coming from an unknown host to an external C2 server, they would be able to combine captures over the entire span of the network and then search for that IP, rather than individually picking through each packet capture.</span></p>
<h1 id="_idParaDest-99"><a id="_idTextAnchor101"/><span class="koboSpan" id="kobo.367.1">Evidence collection</span></h1>
<p><span class="koboSpan" id="kobo.368.1">In order to</span><a id="_idIndexMarker518"/><span class="koboSpan" id="kobo.369.1"> conduct a proper examination of log files and other network data such as packet captures, they often have to be moved from the log source and examined offline. </span><span class="koboSpan" id="kobo.369.2">As with any source of evidence, log files or packet captures have to be handled with due care to ensure that they are not corrupted or modified during the transfer. </span><span class="koboSpan" id="kobo.369.3">One simple solution is to transfer the evidence immediately to a USB drive or similar removable medium. </span><span class="koboSpan" id="kobo.369.4">From there, a hash can be created for the evidence prior to any examination.</span></p>
<p><span class="koboSpan" id="kobo.370.1">The acquisition of network evidence such as a packet capture or a log file should be thoroughly documented. </span><span class="koboSpan" id="kobo.370.2">Incident response personnel may be acquiring log files and packet captures from several sources over the entire network. </span><span class="koboSpan" id="kobo.370.3">As a result, they should ensure that they can trace back every separate piece of evidence to its source, as well as the date and time that the evidence was collected. </span><span class="koboSpan" id="kobo.370.4">This can be recorded on a network evidence log sheet and entries can be completed for each piece of evidence. </span><span class="koboSpan" id="kobo.370.5">For example, see the following entry:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer057">
<span class="koboSpan" id="kobo.371.1"><img alt="" src="image/Image_B18571_05_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.372.1">Figure 5.14 – A network evidence collection entry</span></p>
<p><span class="koboSpan" id="kobo.373.1">The log entry captures the following necessary information:</span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.374.1">File Name</span></strong><span class="koboSpan" id="kobo.375.1">: Each log file or packet capture should have its own unique name. </span><span class="koboSpan" id="kobo.375.2">Within the procedures in use by the CSIRT, there should be a naming convention for different types of evidence files.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.376.1">Description</span></strong><span class="koboSpan" id="kobo.377.1">: A brief description of the file. </span><span class="koboSpan" id="kobo.377.2">There does not need to be too much detail unless it is a particularly unique file and a detailed description is called for.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.378.1">Hash</span></strong><span class="koboSpan" id="kobo.379.1">: A comprehensive overview of hashing will be covered in later chapters. </span><span class="koboSpan" id="kobo.379.2">For now, it suffices to say that a hash is a one-way algorithm that is utilized to provide a digital fingerprint for a file. </span><span class="koboSpan" id="kobo.379.3">This hash will be recorded at the collection phase and after analysis to demonstrate that the file was not modified during the analysis</span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.380.1"> phase. </span><span class="koboSpan" id="kobo.380.2">There are several ways to compute the hash. </span><span class="koboSpan" id="kobo.380.3">In this case, the MD5 hash can be computed using the </span><strong class="bold"><span class="koboSpan" id="kobo.381.1">md5sum</span></strong><span class="koboSpan" id="kobo.382.1"> installed hashing program on Ubuntu. </span><strong class="bold"><span class="koboSpan" id="kobo.383.1">md5sum</span></strong><span class="koboSpan" id="kobo.384.1"> has several different options that can be accessed via the command line. </span><span class="koboSpan" id="kobo.384.2">For the help menu, type the following:</span><pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.385.1">arkime@arkime:~$md5sum --help</span></strong></pre></li>
</ul>
<p><span class="koboSpan" id="kobo.386.1">That produces the following help menu:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer058">
<span class="koboSpan" id="kobo.387.1"><img alt="" src="image/Image_B18571_05_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.388.1">Figure 5.15 – The md5sum help menu</span></p>
<p><span class="koboSpan" id="kobo.389.1">The MD5 hash can be calculated for the packet capture from the switch by simply entering the following command:</span></p>
<pre class="console">
<strong class="bold"><span class="koboSpan" id="kobo.390.1">arkime@arkime:~$md5sum ping_capture</span></strong></pre>
<p><span class="koboSpan" id="kobo.391.1">This produces the following output:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.392.1"><img alt="" src="image/Image_B18571_05_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.393.1">Figure 5.16 – A md5sum file calculation</span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.394.1">Source</span></strong><span class="koboSpan" id="kobo.395.1">: The </span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.396.1">source is important. </span><span class="koboSpan" id="kobo.396.2">In this case, the packet capture was obtained from the system located at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">192.168.0.110</span></strong><span class="koboSpan" id="kobo.398.1"> IP address.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.399.1">Date / Time Acquired</span></strong><span class="koboSpan" id="kobo.400.1">: Record the date and time that the file was captured. </span><span class="koboSpan" id="kobo.400.2">Usually, this is the same as the date and time that the capture was stopped. </span><span class="koboSpan" id="kobo.400.3">If it is a long packet capture, the start and stop times of the capture can be noted. </span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.401.1">Setting the time standard</span></p>
<p class="callout"><span class="koboSpan" id="kobo.402.1">Prior to an incident, it is important to identify what time zone will be in use. </span><span class="koboSpan" id="kobo.402.2">From an evidentiary standpoint, the time zone does not really matter as long as it is consistent throughout the entire incident investigation.</span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.403.1">Captured By</span></strong><span class="koboSpan" id="kobo.404.1">: Ensure that the person collecting the file is identified.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.405.1">Method</span></strong><span class="koboSpan" id="kobo.406.1">: Indicate what tool was used to capture the file.</span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.407.1">Storage Drive</span></strong><span class="koboSpan" id="kobo.408.1">: Once the evidence has been captured, transfer it to an evidence storage drive. </span><span class="koboSpan" id="kobo.408.2">This should also be documented.</span></li>
</ul>
<p><span class="koboSpan" id="kobo.409.1">Once the collection is complete, a chain of custody form should also be filled out for the external medium that contains the evidence files. </span><span class="koboSpan" id="kobo.409.2">From here, the files can be analyzed.</span></p>
<h1 id="_idParaDest-100"><a id="_idTextAnchor102"/><span class="koboSpan" id="kobo.410.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.411.1">Evidence that is pertinent to incident responders is not just located on the hard drive of a compromised host. </span><span class="koboSpan" id="kobo.411.2">There is a wealth of information available from network devices spread throughout the environment. </span><span class="koboSpan" id="kobo.411.3">With proper preparation, a CSIRT may be able to leverage the evidence provided by these devices using solutions such as a SIEM. </span><span class="koboSpan" id="kobo.411.4">CSIRT personnel also has the ability to capture network traffic for later analysis through a variety of methods and tools. </span><span class="koboSpan" id="kobo.411.5">However, all these techniques are influenced by the legal and policy implications that CSIRT personnel and the organization at large need to navigate. </span><span class="koboSpan" id="kobo.411.6">By preparing for the legal and technical challenges of network evidence collection, CSIRT members can leverage this evidence and move closer to the goal of determining the root cause of an incident and bringing the organization back to its full operation.</span></p>
<p><span class="koboSpan" id="kobo.412.1">This chapter discussed several sources of evidence available to incident response analysts. </span><span class="koboSpan" id="kobo.412.2">Logs from network devices, whether they report to a SIEM or through other methods, can give you an insight into what has transpired in the network. </span><span class="koboSpan" id="kobo.412.3">Packet captures provide details about the exact nature of network traffic. </span><span class="koboSpan" id="kobo.412.4">Finally, analysts must be prepared to acquire these sources of evidence in a forensically sound manner.</span></p>
<p><span class="koboSpan" id="kobo.413.1">In the next chapter, the focus will shift from network evidence acquisition to acquiring volatile data from host-based systems.</span></p>
<h1 id="_idParaDest-101"><a id="_idTextAnchor103"/><span class="koboSpan" id="kobo.414.1">Questions</span></h1>
<ol>
<li value="1"><span class="koboSpan" id="kobo.415.1">Which of these items are potential sources of network evidence?</span><ol><li><span class="koboSpan" id="kobo.416.1">Switches</span></li><li><span class="koboSpan" id="kobo.417.1">Routers</span></li><li><span class="koboSpan" id="kobo.418.1">Firewalls</span></li><li><span class="koboSpan" id="kobo.419.1">All of the above</span></li></ol></li>
<li><span class="koboSpan" id="kobo.420.1">Network diagrams are important in identifying potential areas where network evidence can be acquired.</span><ol><li><span class="koboSpan" id="kobo.421.1">True</span></li><li><span class="koboSpan" id="kobo.422.1">False</span></li></ol></li>
<li><span class="koboSpan" id="kobo.423.1">Which of the following is not a network forensic evidence capture tool?</span><ol><li><span class="koboSpan" id="kobo.424.1">RawCap</span></li><li><span class="koboSpan" id="kobo.425.1">Wireshark</span></li><li><span class="koboSpan" id="kobo.426.1">WinPcap</span></li><li><span class="koboSpan" id="kobo.427.1">LogBeat</span></li></ol></li>
<li><span class="koboSpan" id="kobo.428.1">When conducting evidence acquisition, it is not important to record the hash value of the file.</span><ol><li><span class="koboSpan" id="kobo.429.1">True</span></li><li><span class="koboSpan" id="kobo.430.1">False</span></li></ol></li>
</ol>
<h1 id="_idParaDest-102"><a id="_idTextAnchor104"/><span class="koboSpan" id="kobo.431.1">Further reading</span></h1>
<ul>
<li><span class="koboSpan" id="kobo.432.1">Wireshark training: </span><a href="https://www.chappell-university.com/"><span class="koboSpan" id="kobo.433.1">https://www.chappell-university.com/</span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.434.1">Introduction to Cisco IOS NetFlow – A Technical Overview</span></em><span class="koboSpan" id="kobo.435.1">: </span><a href="https://www.cisco.com/c/en/us/products/collateral/ios-nx-os-software/ios-netflow/prod_white_paper0900aecd80406232.html"><span class="koboSpan" id="kobo.436.1">https://www.cisco.com/c/en/us/products/collateral/ios-nx-os-software/ios-netflow/prod_white_paper0900aecd80406232.html</span></a></li>
</ul>
</div>
</body></html>