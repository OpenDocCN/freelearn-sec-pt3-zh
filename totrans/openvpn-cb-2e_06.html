<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Troubleshooting OpenVPN - Configurations</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Cipher mismatches</li><li class="listitem">TUN versus TAP mismatches</li><li class="listitem">Compression mismatches</li><li class="listitem">Key mismatches</li><li class="listitem">Troubleshooting MTU and <code class="literal">tun-mtu</code> issues</li><li class="listitem">Troubleshooting network connectivity</li><li class="listitem">Troubleshooting <code class="literal">client-config-dir</code> issues</li><li class="listitem">Troubleshooting multiple <code class="literal">remote</code> issues</li><li class="listitem">Troubleshooting bridging issues</li><li class="listitem">How to read the OpenVPN log files</li></ul></div><div><div><div><div><h1 class="title"><a id="ch06lvl1sec63"/>Introduction</h1></div></div></div><p>The topic of this chapter and the next is troubleshooting OpenVPN. This chapter will focus on troubleshooting OpenVPN misconfigurations, whereas the next chapter will focus on the all-too-common routing issues that occur when setting up a VPN.</p><p>The recipes in these chapters will therefore deal first with breaking things. We will then provide the tools on how to find and solve the configuration errors. Some of the configuration directives used in this chapter have not been demonstrated before, so even if you are not interested in breaking things, this chapter will still be insightful.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec64"/>Cipher mismatches</h1></div></div></div><p>In this recipe, we will change the cryptographic ciphers that OpenVPN uses. Initially, we will change the cipher only on the client side, which will cause the initialization of the VPN connection to fail. The primary purpose of this recipe is to show the error messages that appear, not to explore the different types of ciphers that OpenVPN supports.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec232"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11, and the client was running Windows 7 64 bit and OpenVPN 2.3.10. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file, <code class="literal">basic-udp-client.conf</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec233"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, create the client configuration file by appending a line to the <code class="literal">basic-udp-client.conf</code> file:<pre class="programlisting">        cipher CAST5-CBC &#13;
</pre><p>Save it as <code class="literal">example6-1-client.conf</code>.</p></li><li class="listitem">Start the client, after which the following message will appear in the client log:<pre class="programlisting">
<strong>        [root@client]# openvpn --config example6-1-client.conf</strong> &#13;
        ... WARNING: 'cipher' is used inconsistently, local='cipher &#13;
        CAST5-CBC'', remote='cipher BF-CBC'' &#13;
        ... [openvpnserver] Peer Connection Initiated with server-&#13;
        ip:1194 &#13;
        ... TUN/TAP device tun0 opened &#13;
        ... /sbin/ip link set dev tun0 up mtu 1500 &#13;
        ... /sbin/ip addr add dev tun0 10.200.0.2/24 broadcast &#13;
        10.200.0.255 &#13;
        ... Initialization Sequence Completed &#13;
        ... Authenticate/Decrypt packet error: cipher final failed &#13;
</pre><p>And, similarly, on the server side:</p><pre class="programlisting">        ... client-ip:52461 WARNING: 'cipher' is used inconsistently,         local='cipher BF-CBC'', remote='cipher CAST5-CBC'' &#13;
        ... client-ip:52461 [client1] Peer Connection Initiated with         client1:52461 &#13;
        ... client1/client-ip:52461 Authenticate/Decrypt packet error: &#13;
        cipher final failed &#13;
        ... client1/client-ip:52461 Authenticate/Decrypt packet error: &#13;
        cipher final failed &#13;
</pre><p>The connection will not be successfully established, but it will also not be disconnected immediately.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec234"/>How it works...</h2></div></div></div><p>During the connection phase, the client and the server negotiate several parameters needed to secure the connection. One of the most important parameters in this phase is the encryption cipher, which is used to encrypt and decrypt all the messages. If the client and server are using different ciphers, then they are simply not capable of talking to each other.</p><p>By adding the following configuration directive to the server configuration file, the client and the server can communicate again:</p><pre class="programlisting">cipher CAST5-CBC &#13;
</pre></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec235"/>There's more...</h2></div></div></div><p>OpenVPN supports quite a few ciphers, although support for some of the ciphers is still experimental. To view the list of supported ciphers, type:</p><pre class="programlisting">
<strong>$ openvpn --show-ciphers</strong>
</pre><p>This will list all ciphers with both variables and fixed cipher length. The ciphers with variable cipher length are very well supported by OpenVPN, the others can sometimes lead to unpredictable results.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec64"/>Pushable ciphers</h3></div></div></div><p>Starting with version 2.4, OpenVPN clients support the option to process a cipher pushed from the server to the client. Thus, if all clients are running OpenVPN 2.4 or later it becomes much easier to change the encryption cipher in an existing deployment.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec65"/>TUN versus TAP mismatches</h1></div></div></div><p>A common mistake when setting up a VPN based on OpenVPN is the type of adapter that is used. If the server is configured to use a TUN-style network but a client is configured to use a TAP-style interface, then the VPN connection will fail. In this recipe, we will show what is typically seen when this common configuration error is made.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec236"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec237"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, create the client configuration:<pre class="programlisting">        client &#13;
        proto udp &#13;
        remote openvpnserver.example.com &#13;
        port 1194 &#13;
 &#13;
        dev tap &#13;
        nobind &#13;
 &#13;
        remote-cert-tls server &#13;
        tls-auth /etc/openvpn/cookbook/ta.key 1 &#13;
        ca       /etc/openvpn/cookbook/ca.crt &#13;
        cert     /etc/openvpn/cookbook/client1.crt &#13;
        key      /etc/openvpn/cookbook/client1.key  &#13;
</pre><p>Save it as<code class="literal">example6-2-client.conf</code>.</p></li><li class="listitem">Start the client:<pre class="programlisting">        <strong>[root@client]# openvpn --config example6-2-client.conf</strong>
</pre><p>The client log will show the following:</p><pre class="programlisting">        ... WARNING: 'dev-type' is used inconsistently, local='dev-type &#13;
        tap'', remote='dev-type tun'' &#13;
        ... WARNING: 'link-mtu' is used inconsistently, local='link-mtu &#13;
        1573'', remote='link-mtu 1541'' &#13;
        ... WARNING: 'tun-mtu' is used inconsistently, local='tun-mtu &#13;
        1532'', remote='tun-mtu 1500'' &#13;
        ... [openvpnserver] Peer Connection Initiated with server-&#13;
        ip:1194 &#13;
        ... TUN/TAP device tap0 opened &#13;
        ... /sbin/ip link set dev tap0 up mtu 1500 &#13;
        ... /sbin/ip addr add dev tap0 10.200.0.2/24 broadcast &#13;
        10.200.0.255 &#13;
        ... Initialization Sequence Completed &#13;
</pre><p>At this point, you can try pinging the server, but it will respond with an error:</p><pre class="programlisting">
<strong>        [client]$ ping 10.200.0.1</strong> &#13;
        PING 10.200.0.1 (10.200.0.1) 56(84) bytes of data. &#13;
        From 10.200.0.2 icmp_seq=2 Destination Host Unreachable &#13;
        From 10.200.0.2 icmp_seq=3 Destination Host Unreachable &#13;
        From 10.200.0.2 icmp_seq=4 Destination Host Unreachable &#13;
</pre></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec238"/>How it works...</h2></div></div></div><p>A TUN-style interface offers a point-to-point connection over which only TCP/IP traffic can be tunneled. A TAP-style interface offers the equivalent of an Ethernet interface that includes extra headers. This allows a user to tunnel other types of traffic over the interface. When the client and the server are misconfigured, the expected packet size is different:</p><pre class="programlisting">... WARNING: 'tun-mtu' is used inconsistently, local='tun-mtu 1532'', remote='tun-mtu 1500'' &#13;
</pre><p>This shows that each packet that is sent through a TAP-style interface is 32- bytes larger than the packets sent through a TUN-style interface.</p><p>By correcting the client configuration, this problem is resolved.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec66"/>Compression mismatches</h1></div></div></div><p>OpenVPN supports on-the-fly compression of the traffic that is sent over the VPN tunnel. This can improve the performance over a slow network line, but it does add a little overhead. When transferring uncompressible data (such as ZIP files), the performance actually decreases slightly.</p><p>If the compression is enabled on the server but not on the client, then the VPN connection will fail.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec239"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the <em>Setting up public and private keys</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file, <code class="literal">basic-udp-client.conf</code>, at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec240"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Append a line to the server configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        comp-lzo &#13;
</pre><p>Save it as <code class="literal">example6-3-server.conf</code>.</p></li><li class="listitem">Start the server:<pre class="programlisting">
<strong>[root@server]# openvpn --config example6-3-server.conf</strong>
</pre></li><li class="listitem">Next, start the client:<pre class="programlisting">
<strong>  [root@client]# openvpn --config basic-udp-client.conf</strong>
</pre><p>The connection will initiate, but when data is sent over the VPN connection, the following messages will appear:</p><pre class="programlisting">        Initialization Sequence Completed &#13;
        ... write to TUN/TAP : Invalid argument (code=22) &#13;
        ... write to TUN/TAP : Invalid argument (code=22) &#13;
</pre></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec241"/>How it works...</h2></div></div></div><p>During the connection phase, no compression is used to transfer information between the client and the server. One of the parameters that is negotiated is the use of compression for the actual VPN payload. If there is a configuration mismatch between the client and the server, then both the sides will get confused by the traffic that the other side is sending.</p><p>This error can easily be fixed for all the clients by just adding another line:</p><pre class="programlisting">push "comp-lzo"&#13;
</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec67"/>Key mismatches</h1></div></div></div><p>OpenVPN offers extra protection for its TLS control channel in the form of HMAC keys. These keys are exactly the same as the static "secret" keys used in <a class="link" title="Chapter 1.  Point-to-Point Networks" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Point-to-Point Networks</em>, for point-to-point style networks. For multi-client style networks, this extra protection can be enabled using the <code class="literal">tls-auth</code> directive. If there is a mismatch between the client and the server related to this <code class="literal">tls-auth</code> key, then the VPN connection will fail to get initialized.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec242"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec243"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, create the client configuration:<pre class="programlisting">        client &#13;
        proto udp &#13;
        remote openvpnserver.example.com &#13;
        port 1194 &#13;
 &#13;
        dev tun &#13;
        nobind &#13;
 &#13;
        remote-cert-tls server &#13;
        tls-auth /etc/openvpn/cookbook/ta.key &#13;
        ca       /etc/openvpn/cookbook/ca.crt &#13;
        cert     /etc/openvpn/cookbook/client1.crt &#13;
        key      /etc/openvpn/cookbook/client1.key &#13;
 &#13;
</pre><p>Note the lack of the second parameter for <code class="literal">tls-auth</code>. Save it as <code class="literal">example6-4-client.conf</code> file.</p></li><li class="listitem">Start the client:<pre class="programlisting">
<strong>[root@client]# openvpn --config example6-4-client.conf</strong>
</pre><p>The client log will show no errors, but the connection will not be established either. In the server log we'll find the following:</p><pre class="programlisting">        <strong>... Initialization Sequence Completed</strong>&#13;
        <strong>... Authenticate/Decrypt packet error: packet HMAC &#13;
        authentication failed</strong>&#13;
        <strong>... TLS Error: incoming packet authentication failed from &#13;
        client-ip:54454</strong>
</pre><p>This shows that the client, <code class="literal">client1</code>, is connecting using the wrong <code class="literal">tls-auth</code> parameter and the connection is refused.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec244"/>How it works...</h2></div></div></div><p>At the very first phase of the connection initialization, the client and the server verify each other's HMAC keys. If an HMAC key is not configured correctly, then the initialization is aborted and the connection will fail to establish. As the OpenVPN server is not able to determine whether the client is simply misconfigured or whether a malicious client is trying to overload the server, the connection is simply dropped. This causes the client to keep listening for the traffic from the server until it eventually times out.</p><p>In this recipe, the misconfiguration consisted of the missing parameter <code class="literal">1</code> at the end of the configuration line:</p><pre class="programlisting">tls-auth /etc/openvpn/cookbook/ta.key &#13;
</pre><p>The second parameter to the <code class="literal">tls-auth</code> directive is the direction of the key. Normally, the following convention is used:</p><div><ul class="itemizedlist"><li class="listitem"><code class="literal">0</code>: from server to client</li><li class="listitem"><code class="literal">1</code>: from client to server</li></ul></div><p>This parameter causes OpenVPN to derive its HMAC keys from a different part of the <code class="literal">ta.key</code> file. If the client and server disagree on which parts the HMAC keys are derived from, the connection cannot be established. Similarly, when the client and server are deriving the HMAC keys from different <code class="literal">ta.key</code> files, the connection can also not be established.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec245"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Multiple secret keys</em> recipe from <a class="link" title="Chapter 1.  Point-to-Point Networks" href="part0015.xhtml#aid-E9OE1">Chapter 1</a>, <em>Point-to-Point Networks</em>, in which the format and usage of the OpenVPN secret keys is explained in detail</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec68"/>Troubleshooting MTU and tun-mtu issues</h1></div></div></div><p>One of the more advanced features of OpenVPN is the ability to tune the network parameters of both the TUN (or TAP) adapter and the parameters of the encrypted link itself. This is a frequent cause of configuration mistakes, leading to low performance or even the inability to successfully transfer data across the VPN tunnel.
 This recipe will show what happens if there is an MTU (Maximum Transfer Unit) mismatch between the client and the server and how this mismatch can cause the VPN tunnel to fail only under certain circumstances.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec246"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11, and the client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the client configuration file, <code class="literal">basic-udp-client.conf</code>, handy along with the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe, from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file <code class="literal">basic-udp-client.conf</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec247"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, create the client configuration file by appending a line to the <code class="literal">basic-udp-client.conf</code> file:<pre class="programlisting">        tun-mtu 1400 &#13;
</pre><p>Save it as <code class="literal">example6-5-client.conf</code>.</p></li><li class="listitem">Start the client and look at the client log:<pre class="programlisting">
<strong>        [root@client]# openvpn --config example6-5-client.conf</strong> &#13;
        ... WARNING: 'link-mtu' is used inconsistently, local='link-mtu &#13;
        1441'', remote='link-mtu 1541'' &#13;
        ... WARNING: 'tun-mtu' is used inconsistently, local='tun-mtu &#13;
        1400'', remote='tun-mtu 1500'' &#13;
        ... [openvpnserver] Peer Connection Initiated with server-&#13;
        ip:1194 &#13;
        ... TUN/TAP device tun0 opened &#13;
        ... /sbin/ip link set dev tun0 up mtu 1400 &#13;
        ... /sbin/ip addr add dev tun0 10.200.0.2/24 broadcast &#13;
        10.200.0.255 &#13;
        ... Initialization Sequence Completed &#13;
</pre><p>There are a few warnings when the tunnel comes up, but the connection is initialized.</p></li><li class="listitem">It is possible to send traffic over the link, which we can verify using the <code class="literal">ping</code> command:<pre class="programlisting">
<strong>        [client]$ ping -c 2 10.200.0.1</strong> &#13;
        PING 10.200.0.1 (10.200.0.1) 56(84) bytes of data. &#13;
        64 bytes from 10.200.0.1: icmp_seq=1 ttl=64 time=30.6 ms &#13;
        64 bytes from 10.200.0.1: icmp_seq=2 ttl=64 time=30.7 ms &#13;
</pre></li><li class="listitem">However, consider when sending larger packets, for example:<pre class="programlisting">        <strong>[client]$ ping -s 1450 10.200.0.1</strong>
</pre><p>In such a case, the following messages appear in the client log file:</p><pre class="programlisting">        <strong>... Authenticate/Decrypt packet error: packet HMAC &#13;
        authentication failed</strong>&#13;
        <strong>... Authenticate/Decrypt packet error: packet HMAC &#13;
        authentication failed</strong>
</pre></li></ol><div></div><p>The same thing will happen if the client tries to download a large file.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec248"/>How it works...</h2></div></div></div><p>The MTU determines how large packets can be that are sent over the tunnel without breaking up (fragmenting) the packet into multiple pieces. If the client and the server disagree on this MTU size, then the server will send packets to the client that are simply too large. This causes an HMAC failure (if <code class="literal">tls-auth</code> is used, as in this recipe) or the part of the packet that is too large is thrown away.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec249"/>There's more...</h2></div></div></div><p>On the Windows platform, it is not easy to change the MTU setting for the Tap-Win32 adapter that OpenVPN uses. The <code class="literal">tun-mtu</code> directive can be specified but the Windows version of OpenVPN cannot alter the actual MTU setting, as Windows did not support this until Windows Vista. OpenVPN, however, does not yet have the capability of altering the MTU size on Windows.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec250"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem"><a class="link" title="Chapter 9. OS Integration" href="part0103.xhtml#aid-3279U1">Chapter 9</a>, <em>Performance Tuning</em>, which gives some hints and examples on how to optimize the <code class="literal">tun-mtu</code> directive</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec69"/>Troubleshooting network connectivity</h1></div></div></div><p>This recipe will focus on the type of log messages that are typically seen when the OpenVPN configurations are fine, but the network connectivity is not. In most cases, this is due to a firewall blocking access to either the server or the client. In this recipe, we explicitly block access to the server and then try to connect to it.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec251"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11, and the client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the client configuration file, <code class="literal">basic-udp-client.conf</code>, handy along with the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file, <code class="literal">basic-udp-client.conf</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec252"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        <strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">On the server, explicitly block access to OpenVPN using <code class="literal">iptables</code>:<pre class="programlisting">        <strong>[root@server]# iptables -I INPUT -p udp --dport 1194 -j DROP</strong>
</pre></li><li class="listitem">Next, start the client using the configuration file, <code class="literal">basic-udp-client.conf</code>:<pre class="programlisting">        <strong>[root@client]# openvpn --config basic-udp-client.conf</strong>
</pre><p>The client will try to connect the server using the UDP protocol. After a while, a timeout will occur because no traffic is getting through and the client will restart:</p><pre class="programlisting">        ... TLS Error: TLS key negotiation failed to occur within 60 &#13;
        seconds (check your network connectivity) &#13;
        ... TLS Error: TLS handshake failed &#13;
        ... SIGUSR1[soft,tls-error] received, process restarting &#13;
</pre><p>Abort the client and stop the server.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec253"/>How it works...</h2></div></div></div><p>When OpenVPN is configured to use the default UDP protocol, the client will wait for an answer from the server for 60 seconds. If no answer was received, the connection is restarted. As we are explicitly blocking UDP traffic, the timeout occurs and the client is never able to connect.</p><p>The amount of time for which the client waits for the connection to start is controlled using the following directive:</p><pre class="programlisting">hand-window N &#13;
</pre><p>Here, <code class="literal">N</code> is the number of seconds to wait for the initial handshake to complete. The default value is 60 seconds.</p><p>Of course, the connection can be repaired by removing the firewall rule.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec254"/>There's more...</h2></div></div></div><p>One of the major differences between the UDP protocol and the TCP protocol is the way connections are established: every TCP connection is started using a TCP handshake by both the client and the server. If the handshake fails, then the connection is not established. There is no need to wait for traffic coming back from the server, as the connection itself is dropped:</p><pre class="programlisting">
<strong>... Attempting to establish TCP connection with openvpnserver:1194 [nonblock]</strong>
<strong>... TCP: connect to openvpnserver:1194 failed, will try again in 5 seconds: Connection refused</strong>
</pre></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec70"/>Troubleshooting client-config-dir issues</h1></div></div></div><p>In this recipe, we will demonstrate how to troubleshoot issues related to the use of the <code class="literal">client-config-dir</code> directive. This directive can be used to specify a directory for so-called CCD files. CCD files can contain OpenVPN directives to assign a specific IP address to a client, based on the client's certificate. Experience has shown that it is easy to misconfigure this directive. In this recipe, we will make one of the common misconfigurations and then show how to troubleshoot it.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec255"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11. The client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the client configuration file, <code class="literal">basic-udp-client.conf</code>, handy along with the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file, <code class="literal">basic-udp-client.conf</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec256"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Append the following lines to the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">        client-config-dir /etc/openvpn/cookbook/clients &#13;
        ccd-exclusive &#13;
</pre><p>Save it as <code class="literal">example6-7-server.conf</code>.</p></li><li class="listitem">Make sure that the <code class="literal">/etc/openvpn/cookbook/clients</code> directory is accessible only to the root:<pre class="programlisting">        <strong>[root@server]# chown root /etc/openvpn/cookbook/clients</strong>&#13;
        <strong>[root@server]# chmod 700  /etc/openvpn/cookbook/clients</strong>
</pre></li><li class="listitem">Start the server:<pre class="programlisting">        <strong>[root@server]# openvpn --config example6-7-server.conf</strong>
</pre></li><li class="listitem">Next, start the client using the configuration file, <code class="literal">basic-udp-client.conf</code>:<pre class="programlisting">        <strong>[root@client]# openvpn --config basic-udp-client.conf</strong>
</pre></li></ol><div></div><p>Then, the client will fail to connect with the following message:</p><pre class="programlisting">... [openvpnserver] Peer Connection Initiated with server-ip:1194 &#13;
... AUTH: Received AUTH_FAILED control message &#13;
</pre><p>The server log file is a bit confusing: first; it mentions that there was a problem reading the CCD file, <code class="literal">client1</code>, but then it states that the client is connected:</p><pre class="programlisting">... client-ip:45432 TLS Auth Error: --client-config-dir authentication failed for common name 'client1' file=''/etc/openvpn/cookbook/clients/client1'' &#13;
... client-ip:45432 [client1] Peer Connection Initiated with client-ip:45432 &#13;
</pre><p>However, the VPN connection has not been properly initiated.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec257"/>How it works...</h2></div></div></div><p>The following directives are used by the OpenVPN server to look in the 
<code class="literal">/etc/openvpn/cookbook/clients</code> directory for a CCD file with the name (CN) of the client certificate:</p><pre class="programlisting">client-config-dir /etc/openvpn/cookbook/clients &#13;
ccd-exclusive &#13;
</pre><p>The purpose of the second directive, <code class="literal">ccd-exclusive</code>, is to only allow clients for which a CCD file is present. If a CCD file for a client is not present, the client will be denied access. The name of the client certificate is listed in the server log:</p><pre class="programlisting">... client-ip:45432 TLS Auth Error: --client-config-dir authentication failed for common name 'client1' &#13;
</pre><p>However, it can also be retrieved using the following:</p><pre class="programlisting">openssl x509 -subject -noout -in client1.crt &#13;
</pre><p>Look for the first part starting with <code class="literal">/CN=</code> and convert all spaces to underscores.</p><p>The OpenVPN server process is running as user <code class="literal">nobody</code>. And because we have set very restrictive permissions on the <code class="literal">/etc/openvpn/cookbook/clients</code> directory, this user is not capable of reading any files in that directory. When the client with the <code class="literal">client1</code> certificate connects, the OpenVPN server is not capable of reading the CCD file (even though it might be there). Because of the <code class="literal">ccd-exclusive</code> directive, the client is then denied access.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec258"/>There's more...</h2></div></div></div><p>In this section, we will explain how to increase the logging verbosity and what some of the most common <code class="literal">client-config-dir</code> mistakes are.</p><div><div><div><div><h3 class="title"><a id="ch06lvl3sec65"/>More verbose logging</h3></div></div></div><p>Increasing the verbosity of logging is often helpful when troubleshooting <code class="literal">client-config-dir</code> issues. With <code class="literal">verb 5</code> and the right permissions, you will see the following log file entries in the OpenVPN server log:</p><pre class="programlisting">client1/client-ip:39814 OPTIONS IMPORT: reading client specific options from: /etc/openvpn/cookbook/clients/client1 &#13;
</pre><p>If this message is not present in the server log, then it is safe to assume that the CCD file has not been read.</p></div><div><div><div><div><h3 class="title"><a id="ch06lvl3sec66"/>Other frequent client-config-dir mistakes</h3></div></div></div><p>There are a few frequent <code class="literal">client-config-dir</code> mistakes:</p><div><ul class="itemizedlist"><li class="listitem">A non-absolute path is used to specify the <code class="literal">client-config-dir</code> directive, for example:<pre class="programlisting">        client-config-dir clients&#13;
</pre><p>This might work in some cases, but you have to be very careful when starting the server or when combining this with directives such as <code class="literal">--chroot</code> or <code class="literal">--cd</code>. Especially when the <code class="literal">--chroot</code> directive is used, all paths, including the absolute path, will be relative to the <code class="literal">chroot</code> path.</p></li><li class="listitem">The CCD file itself must be correctly named, without any extension. This typically tends to confuse Windows users. Look in the server log to see what the OpenVPN server thinks; the <code class="literal">/CN= name</code> is of the client certificate. Also, be aware that OpenVPN rewrites some characters of the <code class="literal">/CN= name</code>, such as spaces. For the full list of characters that will be remapped, refer to the manual page in the <em>String types and remapping</em> section.</li><li class="listitem">The CCD file and the full path to it must be readable to the user under which the OpenVPN server process is running (usually <code class="literal">nobody</code>).</li></ul></div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec259"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Using client-config-dir files</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, which explains the basic usage of client configuration files</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec71"/>Troubleshooting multiple remote issues</h1></div></div></div><p>In this recipe, we will demonstrate how to troubleshoot issues related to the use of multiple <code class="literal">remote</code> directives. The ability to use multiple <code class="literal">remote</code> directives is one of the lesser well-known features of OpenVPN that has been available since version 2.2. It allows a user to specify multiple connection profiles to different hosts, different ports, and different protocols (for example, TCP versus UDP).</p><p>When using this directive, there is a pitfall to watch out for when specifying extra directives elsewhere in the configuration files, or on the command line. In this recipe, we will demonstrate what this pitfall is.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec260"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11, and the client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the client configuration file, <code class="literal">basic-udp-client.conf</code>, handy along with the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>, as well as the client configuration file, <code class="literal">basic-udp-client.conf</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec261"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, create the client configuration:<pre class="programlisting">        client &#13;
        remote openvpnserver.example.com 1195 udp &#13;
        remote openvpnserver.example.com 1196 tcp &#13;
        port 1194 &#13;
 &#13;
        dev tun &#13;
        nobind &#13;
 &#13;
        remote-cert-tls server &#13;
        tls-auth /etc/openvpn/cookbook/ta.key 1 &#13;
        ca       /etc/openvpn/cookbook/ca.crt &#13;
        cert     /etc/openvpn/cookbook/client1.crt &#13;
        key      /etc/openvpn/cookbook/\client1.key  &#13;
</pre><p>Note that we are specifying two connection profiles, one to the server using the UDP protocol, <code class="literal">port 1195</code>, and one using the TCP protocol, <code class="literal">port 1196</code>. However, we expect to overrule the port number using the line <code class="literal">port 1194</code>. Save this file as <code class="literal">example6-8-client.conf</code> .</p></li><li class="listitem">Start the client:<pre class="programlisting">        <strong>[root@client]# openvpn --config example6-8-client.conf</strong>
</pre><p>Then, the client will fail to connect with a message:</p><pre class="programlisting">        ... UDPv4 link local: [undef] &#13;
        ... UDPv4 link remote: [AF_INET]server-ip:1195 &#13;
</pre><p>So, even though we explicitly stated <code class="literal">port 1194</code>, the client is still connecting using protocol UDP, port <code class="literal">1195</code>.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec262"/>How it works...</h2></div></div></div><p>When you specify a remote connection entry using:</p><pre class="programlisting"> remote openvpnserver.example.com 1195 udp</pre><p>OpenVPN transforms this internally into a connection profile. In general, connection profiles inherit settings from the global configuration. Anything specified inside a connection profile overrules whatever is specified globally, even if it is specified later in the configuration file, or on the command line. Thus, the line <code class="literal">port 1194</code> does not have any effect and the client attempts to connect using the first (default) <code class="literal">remote</code> connection profile, protocol UDP, and port <code class="literal">1195</code>.</p><p>To solve this issue, the port number needs to be modified in the <code class="literal">remote</code> line in the configuration file.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec263"/>There's more...</h2></div></div></div><p>An alternative way to specify the <code class="literal">remote openvpnserver.example.com 1195 udp</code> is by using a connection block:</p><pre class="programlisting">&lt;connection&gt; &#13;
    remote openvpnserver.example.com &#13;
    port 1195  &#13;
    proto udp &#13;
&lt;/connection&gt; &#13;
</pre><p>However, inside connection blocks, you can specify more directives, as we will see in the <em>Using connection blocks</em> recipe in <a class="link" title="Chapter 10.  Advanced Configuration" href="part0115.xhtml#aid-3DLGM1">Chapter 10</a>, <em>Advanced Configuration</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec264"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Using connection blocks</em> recipe in <a class="link" title="Chapter 10.  Advanced Configuration" href="part0115.xhtml#aid-3DLGM1">Chapter 10</a>, <em>Advanced Configuration</em>, which goes into detail into the usage of connection blocks</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec72"/>Troubleshooting bridging issues</h1></div></div></div><p>In this recipe, we will demonstrate how to troubleshoot a common issue related to bridging. OpenVPN bridging can be tricky to configure, as the warning and error messages can be confusing. In this recipe, we will make one of the common misconfigurations and then show how to troubleshoot it.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec265"/>Getting ready</h2></div></div></div><p>Set up the client and server certificates using the first recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11, and the client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the scripts, <code class="literal">example3-3-bridge-start</code> and <code class="literal">example3-3-bridge-stop</code>, from the <em>Bridging - Linux </em>recipe from <a class="link" title="Chapter 3. Client-server Ethernet-style Networks" href="part0038.xhtml#aid-147LC1">Chapter 3</a>, <em>Client-server Ethernet-style Networks</em>, handy along with the client configuration file, <code class="literal">example-3-2-client2.ovpn</code>, from the <em>Enabling client-to-client traffic</em> recipe, from <a class="link" title="Chapter 3. Client-server Ethernet-style Networks" href="part0038.xhtml#aid-147LC1">Chapter 3</a>, <em>Client-server Ethernet-style Networks</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec266"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Create the server configuration file:<pre class="programlisting">        proto udp &#13;
        port 1194 &#13;
        dev tap &#13;
        server-bridge 192.168.4.65 255.255.255.0 192.168.4.128 &#13;
        192.168.4.200 &#13;
        push "route 192.168.4.0 255.255.255.0" &#13;
 &#13;
        tls-auth /etc/openvpn/cookbook/ta.key 0 &#13;
        ca       /etc/openvpn/cookbook/ca.crt &#13;
        cert     /etc/openvpn/cookbook/server.crt &#13;
        key      /etc/openvpn/cookbook/server.key &#13;
        dh       /etc/openvpn/cookbook/dh2048.pem &#13;
 &#13;
        persist-key &#13;
        persist-tun &#13;
        keepalive 10 60 &#13;
 &#13;
        user  nobody &#13;
        group nobody  # use "group nogroup" on some distros &#13;
 &#13;
        daemon &#13;
        log-append /var/log/openvpn.log &#13;
</pre><p>Note that we did not explicitly specify the adapter name (tap0). Save it as <code class="literal">example-6-9-server.conf</code>.</p></li><li class="listitem">Create the network bridge and verify that it is working:<pre class="programlisting">
<strong>        [root@server]# bash example3-3-bridge-start</strong> &#13;
          TUN/TAP device tap0 opened &#13;
          Persist state set to: ON &#13;
<strong>        [root@server]# brctl show</strong> &#13;
          bridge name bridge id         STP enabled interfaces &#13;
          br0         8000.00219bd2d422 no          eth0 &#13;
                       tap0 &#13;
</pre></li><li class="listitem">Start the OpenVPN server:<pre class="programlisting">
<strong>      [root@server]# openvpn --config example6-9-server.conf</strong>
</pre></li><li class="listitem">Start the client:<div><img src="img/image00379.jpeg" alt="How to do it..."/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Now, try to reach the server:<pre class="programlisting">
<strong>[WinClient]C:&gt; ping 192.168.4.65</strong>
</pre><p>Even though the connection is established, the client will fail to reach the server.</p><p>Remember to shut down the Ethernet bridge after stopping the OpenVPN server process.</p></li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec267"/>How it works...</h2></div></div></div><p>The connection failures in this example are due to the fact that the OpenVPN server opened a new tap adapter at startup instead of connecting to the bridge. A hint is given in the server log file:</p><pre class="programlisting">... TUN/TAP device tap1 opened &#13;
</pre><p>When checking the tap interfaces on the server, we see that there are now two tap interfaces:</p><pre class="programlisting">
<strong>[root@server]# ip addr show</strong>
<strong>...</strong>
<strong>39: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue &#13;
    state UNKNOWN </strong>
<strong>    link/ether 00:25:90:c0:3e:d0 brd ff:ff:ff:ff:ff:ff</strong>
<strong>    inet 192.168.4.65/24 brd 192.168.4.255 scope global br0</strong>
<strong>    inet6 fe80::225:90ff:fec0:3ed0/64 scope link </strong>
<strong>       valid_lft forever preferred_lft forever</strong>
<strong>40: tap1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen &#13;
    100</strong>
<strong>    link/ether ae:9f:3e:ae:93:ba brd ff:ff:ff:ff:ff:ff</strong>
</pre><p>The second tap interface, <code class="literal">tap1</code>, is the one in use by OpenVPN, and it does not have an IP address assigned!</p><p>To solve this issue, the correct tap adapter needs to be specified in the server configuration file.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec268"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem">The <em>Linux - bridging</em> recipe, from <a class="link" title="Chapter 3. Client-server Ethernet-style Networks" href="part0038.xhtml#aid-147LC1">Chapter 3</a>, <em>Client-server Ethernet-style Networks</em>, which explains in detail how to set up bridging on Linux in detail</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec73"/>How to read the OpenVPN log files</h1></div></div></div><p>Troubleshooting an OpenVPN setup often comes down to reading and interpreting the OpenVPN log file correctly. In this recipe, no new features of OpenVPN will be introduced, but a detailed walk-through of an OpenVPN log file will be given. The setup from the <em>Troubleshooting MTU and tun-mtu issues </em>recipe earlier in this chapter will be used as a starting point.</p><div><div><div><div><h2 class="title"><a id="ch06lvl2sec269"/>Getting ready</h2></div></div></div><p>Use the same setup as in the <em>Troubleshooting MTU and tun-mtu issues</em> recipe earlier in this chapter. For this recipe, the server computer was running CentOS 6 Linux and OpenVPN 2.3.11, and the client was running Fedora 22 Linux and OpenVPN 2.3.11. Keep the configuration file, <code class="literal">basic-udp-server.conf</code>, from the <em>Server-side routing</em> recipe from <a class="link" title="Chapter 2.  Client-server IP-only Networks" href="part0025.xhtml#aid-NQU21">Chapter 2</a>, <em>Client-server IP-only Networks</em>. For the client, keep the configuration file, <code class="literal">example6-5-client.conf</code>, from the <em>Troubleshooting MTU and tun-mtu issues</em> recipe at hand.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec270"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Start the server using the configuration file, <code class="literal">basic-udp-server.conf</code>:<pre class="programlisting">
<strong>[root@server]# openvpn --config basic-udp-server.conf</strong>
</pre></li><li class="listitem">Next, start the client with an increased verbosity setting and without timestamps in the log file:<pre class="programlisting">
<strong>[root@client]# openvpn --config example6-5-client.conf \</strong>
<strong>  --verb 7 --suppress-timestamps</strong>
</pre><p>The connection will initiate, but it will not be possible to send large packets.</p></li><li class="listitem">Trigger an error by typing the following:<pre class="programlisting">
<strong>[client]$ ping -c 1 10.200.0.1</strong>
<strong>[client]$ ping -c 1 -s 1450 10.200.0.1</strong>
</pre></li><li class="listitem">Abort the client. The log file will have become large quite quickly.</li><li class="listitem">Open the log file using a text editor and browse through it. An explanation of the general structure of the log file is given in the next section.</li></ol><div></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec271"/>How it works...</h2></div></div></div><p>The first part of the log file contains the configuration as specified in the configuration file and from the command-line parameters. This is the section starting with the following line:</p><pre class="programlisting">Current Parameter Settings: &#13;
  config = 'example6-5-client.conf' &#13;
</pre><p>It ends with the following line:</p><pre class="programlisting">OpenVPN 2.3.11 x86_64-redhat-linux-gnu [SSL (OpenSSL)] [LZO] [EPOLL] [PKCS11] [MH] [IPv6] built on May 10 2016 &#13;
</pre><p>This section is about 275 lines long depending on the configuration and it contains what OpenVPN thinks is the configuration. Check this section carefully to make sure that you agree.</p><p>The next interesting section is as follows:</p><pre class="programlisting">Control Channel Authentication: using '/etc/openvpn/cookbook/ta.key' as a OpenVPN static key file &#13;
Outgoing Control Channel Authentication: Using 160 bit message hash 'SHA1' for HMAC authentication &#13;
Outgoing Control Channel Authentication: HMAC KEY: 51cc24c0 ... &#13;
Outgoing Control Channel Authentication: HMAC size=20 ... Incoming Control Channel Authentication: Using 160 bit ... &#13;
Incoming Control Channel Authentication: HMAC KEY: 1c748f91 ...  &#13;
Incoming Control Channel Authentication: HMAC size=20 ...  &#13;
</pre><p>This part shows that a <code class="literal">tls-auth</code> key is read and used and that the two separate HMAC keys are derived. The keys are actually printed in the log file, so you can reference them with the output from the server log file. The server incoming key should be the same as the client outgoing key and vice versa. The misconfiguration from the <em>Key mismatches</em> recipe earlier in this chapter would have appeared here.</p><p>Right after this section is the warning that is the root cause of the misconfiguration from the <em>Troubleshooting MTU and tun-mtu issues</em> recipe earlier in this chapter:</p><pre class="programlisting">WARNING: normally if you use --mssfix and/or --fragment, you should also set --tun-mtu 1500 (currently it is 1400) &#13;
</pre><p>Log file messages starting with <code class="literal">WARNING</code> should always be given special attention to. In some cases, they can be ignored, but in this case, it was the root cause of the VPN connection not working properly.</p><p>After this warning comes a whole range of messages of the following form:</p><pre class="programlisting">UDPv4 link remote: [AF_INET]server-ip:1194 &#13;
UDPv4 WRITE [42] to [AF_INET]server-ip:1194: P_CONTROL_HARD_RESET_CLIENT_V2 kid=0 pid=[ #1 ] [ ] pid=0 DATA len=0 &#13;
UDPv4 READ [54] from [AF_INET]server-ip:1194: P_CONTROL_HARD_RESET_SERVER_V2 kid=0 pid=[ #1 ] [ 0 ] pid=0 DATA len=0 &#13;
TLS: Initial packet from [AF_INET]server-ip:1194, sid=c483bcc9 a60cc834 &#13;
PID_TEST [0] [TLS_AUTH-0] [] 0:0 1469290891:1 t=1469290891[0] r=[0,64,15,0,1] sl=[0,0,64,528] &#13;
UDPv4 WRITE [50] to [AF_INET]server-ip:1194: P_ACK_V1 kid=0 pid=[ #2 ] [ 0 ] &#13;
UDPv4 WRITE [249] to [AF_INET]server-ip:1194: P_CONTROL_V1 kid=0 pid=[ #3 ] [ ] pid=1 DATA len=207 &#13;
</pre><p>These messages are all part of the initial handshake between the client and the server to exchange configuration information, encryption keys, and other information for setting up the VPN connection. Right after this is another hint about the misconfiguration:</p><pre class="programlisting">WARNING: 'link-mtu' is used inconsistently, local='link-mtu 1441', remote='link-mtu 1541' &#13;
WARNING: 'tun-mtu' is used inconsistently, local='tun-mtu 1400', remote='tun-mtu 1500'  &#13;
</pre><p>We skip forward over a lot of <code class="literal">TLS_prf</code> messages to come to the end of the connection handshake:</p><pre class="programlisting">Control Channel: TLSv1.2, cipher TLSv1/SSLv3 DHE-RSA-AES256-GCM-SHA384, 2048 bit RSA &#13;
[openvpnserver] Peer Connection Initiated with [AF_INET]server-ip:1194 &#13;
</pre><p>At this point, the OpenVPN client has established the initial connection with the server and it is now ready to process the configuration directives pushed by the server, if any:</p><pre class="programlisting">PUSH: Received control message: 'PUSH_REPLY,route-gateway 10.200.0.1,topology subnet,ping 10,ping-restart 60,ifconfig 10.200.0.2 255.255.255.0' &#13;
</pre><p>This is another important line to check for, as it shows what the server has actually pushed to the client. Verify that this actually matches what you thought the server should push.</p><p>After this, the local TUN adapter is opened and initialized and the first packets can begin to flow.</p><p>The first <code class="literal">ping</code> command worked fine, as we can see from this part:</p><pre class="programlisting">TUN READ [84] &#13;
... &#13;
UDPv4 WRITE [125] to server-ip:1194: P_DATA_V1 kid=0 DATA len=124 &#13;
UDPv4 READ [125] from server-ip:1194: P_DATA_V1 kid=0 DATA len=124 &#13;
TLS: tls_pre_decrypt, key_id=0, IP=server-ip:1194 &#13;
TUN WRITE [84] &#13;
</pre><p>The <code class="literal">TUN READ</code> is the ping command being read from the TUN interface, followed by a write over the encrypted channel to the remote server. Notice the difference in packet size: the packet sent over the encrypted tunnel is 125 bytes, which is 41- bytes larger than the original packet read from the TUN interface. This exactly matches the difference between the <code class="literal">link-mtu</code> and <code class="literal">tun-mtu</code> options as shown earlier in the log file.</p><p>Next comes the section where the <code class="literal">ping -s 1450</code> command breaks down. A <code class="literal">ping</code> of 1450 bytes cannot be read in one piece if the MTU of the interface is set to 1400, hence two <code class="literal">TUN READS</code> are necessary to capture all data:</p><pre class="programlisting">TUN READ [1396] &#13;
... &#13;
UDPv4 WRITE [1437] to server-ip:1194: P_DATA_V1 kid=0 DATA len=1436 &#13;
TUN READ [102] &#13;
... &#13;
UDPv4 WRITE [141] to server-ip:1194: P_DATA_V1 kid=0 DATA len=140 &#13;
</pre><p>Notice that the data is actually sent as two separate packets to the server. This is perfectly normal behavior, as the packet needs to be fragmented. Calculation of the packet sizes versus the MTU sizes breaks down in this case, as the second packet is not a complete IP packet.</p><p>The server receives the large <code class="literal">ping</code> command and sends an equally large reply. As the server has an MTU setting of 1500, there is no need to fragment the data, so it arrives at the client as a single packet:</p><pre class="programlisting">UDPv4 READ [1441] from server-ip:1194: P_DATA_V1 kid=0 DATA len=1440 &#13;
TLS: tls_pre_decrypt, key_id=0, IP=server-ip:1194 &#13;
Authenticate/Decrypt packet error: packet HMAC authentication failed &#13;
</pre><p>The client, however, is expecting a packet with a maximum size of 1400 bytes. It is not able to properly decode the larger packet and write out the <code class="literal">packet HMAC authentication failed</code> message.</p><p>Finally, when we abort the client, we see an <code class="literal">interrupted system call</code> message (in this case, <em>
<strong>Ctrl</strong>
</em> + <em>
<strong>C</strong>
</em> was used to abort the client, along with a range of clean-up messages before the client actually stops):</p><pre class="programlisting">event_wait : Interrupted system call (code=4) &#13;
PID packet_id_free &#13;
... &#13;
TCP/UDP: Closing socket &#13;
Closing TUN/TAP interface &#13;
/sbin/ip addr del dev tun0 10.200.0.2/24 &#13;
PID packet_id_free &#13;
SIGINT[hard,] received, process exiting &#13;
</pre><p>Consider that the client configuration had included this:</p><pre class="programlisting">user nobody &#13;
</pre><p>Then, we would also have seen messages of this form:</p><pre class="programlisting">SIOCSIFADDR: Permission denied &#13;
SIOCSIFFLAGS: Permission denied &#13;
Linux ip addr del failed: external program exited with error status: 255 &#13;
</pre><p>In this case, these are harmless.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec272"/>There's more...</h2></div></div></div><p>On UNIX-based operating systems, it is also possible to send the OpenVPN log output via <code class="literal">syslog</code>. This allows a system administrator to effectively manage a large set of computers using a single system logging interface. To send log messages via <code class="literal">syslog</code>, replace the directive <code class="literal">log-append</code> with the following:</p><pre class="programlisting">syslog [name] &#13;
</pre><p>Here, <code class="literal">name</code> is an optional parameter to specify the name of the OpenVPN instance in the syslog log files. This is particularly useful if there are multiple instances of OpenVPN running on a single host, and they are all using <code class="literal">syslog</code> to log their output and error messages.</p></div></div></body></html>